<!doctype html><html lang=zh-cn><head prefix="og: http://ogp.me/ns# article: http://ogp.me/ns/article#"><meta charset=utf-8><meta name=generator content="Hugo 0.93.2"><meta name=theme-color content="#fff"><meta name=color-scheme content="light dark"><meta name=viewport content="width=device-width,initial-scale=1"><meta name=format-detection content="telephone=no, date=no, address=no, email=no"><meta http-equiv=cache-control content="no-transform"><meta http-equiv=cache-control content="no-siteapp"><title>ansible及ansible-playbook的使用 | NEWIUR</title><link rel=stylesheet href=/css/meme.min.css><script src=/js/meme.min.js></script>
<link rel=preconnect href=https://fonts.gstatic.com crossorigin><link rel=stylesheet href="https://fonts.googleapis.com/css2?family=EB+Garamond:ital,wght@0,400;0,500;0,700;1,400;1,700&family=Noto+Serif+SC:wght@400;500;700&family=Source+Code+Pro:ital,wght@0,400;0,700;1,400;1,700&display=swap" media=print onload='this.media="all"'><noscript><link rel=stylesheet href="https://fonts.googleapis.com/css2?family=EB+Garamond:ital,wght@0,400;0,500;0,700;1,400;1,700&family=Noto+Serif+SC:wght@400;500;700&family=Source+Code+Pro:ital,wght@0,400;0,700;1,400;1,700&display=swap"></noscript><meta name=author content="newiur"><meta name=description content="讲解ansible及ansible-playbook的使用"><link rel="shortcut icon" href=/favicon.ico type=image/x-icon><link rel=mask-icon href=/icons/safari-pinned-tab.svg color=#2a6df4><link rel=apple-touch-icon sizes=180x180 href=/icons/apple-touch-icon.png><meta name=apple-mobile-web-app-capable content="yes"><meta name=apple-mobile-web-app-title content="NEWIUR"><meta name=apple-mobile-web-app-status-bar-style content="black"><meta name=mobile-web-app-capable content="yes"><meta name=application-name content="NEWIUR"><meta name=msapplication-starturl content="../../../"><meta name=msapplication-TileColor content="#fff"><meta name=msapplication-TileImage content="../../../icons/mstile-150x150.png"><link rel=manifest href=/manifest.json><link rel=canonical href=https://ruisum.top/tech/ops/ansible%E5%AD%A6%E4%B9%A0/><script type=application/ld+json>{"@context":"https://schema.org","@type":"BlogPosting","datePublished":"2021-07-05T12:07:21+00:00","dateModified":"2022-03-31T23:38:04+08:00","url":"https://ruisum.top/tech/ops/ansible%E5%AD%A6%E4%B9%A0/","headline":"ansible及ansible-playbook的使用","description":"讲解ansible及ansible-playbook的使用","inLanguage":"zh-CN","articleSection":"tech","wordCount":42590,"image":"https://ruisum.top/icons/apple-touch-icon.png","author":{"@type":"Person","description":"just go go","email":"rwen913@gmail.com","image":"https://ruisum.top/icons/apple-touch-icon.png","url":"https://ruisum.top","name":"newiur"},"license":"[CC BY-NC-SA 4.0](https://creativecommons.org/licenses/by-nc-sa/4.0/deed.zh)","publisher":{"@type":"Organization","name":"NEWIUR","logo":{"@type":"ImageObject","url":"https://ruisum.top/icons/apple-touch-icon.png"},"url":"https://ruisum.top/"},"mainEntityOfPage":{"@type":"WebSite","@id":"https://ruisum.top/"}}</script><meta name=twitter:card content="summary"><meta property="og:title" content="ansible及ansible-playbook的使用"><meta property="og:description" content="讲解ansible及ansible-playbook的使用"><meta property="og:url" content="https://ruisum.top/tech/ops/ansible%E5%AD%A6%E4%B9%A0/"><meta property="og:site_name" content="NEWIUR"><meta property="og:locale" content="zh"><meta property="og:image" content="https://ruisum.top/icons/apple-touch-icon.png"><meta property="og:type" content="article"><meta property="article:published_time" content="2021-07-05T12:07:21+00:00"><meta property="article:modified_time" content="2022-03-31T23:38:04+08:00"><meta property="article:section" content="tech"><link rel=stylesheet href="https://fonts.googleapis.com/css2?family=ZCOOL+XiaoWei&text=Newiur%27sBlogNEWIUR&display=swap" media=print onload='this.media="all"'><noscript><link rel=stylesheet href="https://fonts.googleapis.com/css2?family=ZCOOL+XiaoWei&text=Newiur%27sBlogNEWIUR&display=swap"></noscript></head><body><div class=container><header class=header><div class=header-wrapper><div class="header-inner single"><div class=site-brand><a href=/ class=brand>NEWIUR</a></div><nav class=nav><ul class=menu id=menu><li class=menu-item><a href=/tags/><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 640 512" class="icon tags"><path d="M497.941 225.941 286.059 14.059A48 48 0 00252.118.0H48C21.49.0.0 21.49.0 48v204.118a48 48 0 0014.059 33.941l211.882 211.882c18.744 18.745 49.136 18.746 67.882.0l204.118-204.118c18.745-18.745 18.745-49.137.0-67.882zM112 160c-26.51.0-48-21.49-48-48s21.49-48 48-48 48 21.49 48 48-21.49 48-48 48zm513.941 133.823L421.823 497.941c-18.745 18.745-49.137 18.745-67.882.0l-.36-.36L527.64 323.522c16.999-16.999 26.36-39.6 26.36-63.64s-9.362-46.641-26.36-63.64L331.397.0h48.721a48 48 0 0133.941 14.059l211.882 211.882c18.745 18.745 18.745 49.137.0 67.882z"/></svg><span class=menu-item-name>标签</span></a></li><li class=menu-item><a href=/tech/><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512" class="icon tech"><path d="M512 256c0 141.2-114.7 256-256 256C114.8 512 0 397.3.0 256S114.7.0 256 0s256 114.7 256 256zm-32 0c0-123.2-100.3-224-224-224C132.5 32 32 132.5 32 256s100.5 224 224 224 224-100.5 224-224zM160.9 124.6l86.9 37.1-37.1 86.9-86.9-37.1 37.1-86.9zm110 169.1 46.6 94h-14.6l-50-1e2-48.9 1e2h-14l51.1-106.9-22.3-9.4 6-14 68.6 29.1-6 14.3-16.5-7.1zm-11.8-116.3 68.6 29.4-29.4 68.3L230 246l29.1-68.6zm80.3 42.9 54.6 23.1-23.4 54.3-54.3-23.1 23.1-54.3z"/></svg><span class=menu-item-name>技术</span></a></li><li class=menu-item><a href=/life/><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512" class="icon life"><path d="M301.1 212c4.4 4.4 4.4 11.9.0 16.3l-9.7 9.7c-4.4 4.7-11.9 4.7-16.6.0l-10.5-10.5c-4.4-4.7-4.4-11.9.0-16.6l9.7-9.7c4.4-4.4 11.9-4.4 16.6.0l10.5 10.8zm-30.2-19.7c3-3 3-7.8.0-10.5-2.8-3-7.5-3-10.5.0-2.8 2.8-2.8 7.5.0 10.5 3.1 2.8 7.8 2.8 10.5.0zm-26 5.3c-3 2.8-3 7.5.0 10.2 2.8 3 7.5 3 10.5.0 2.8-2.8 2.8-7.5.0-10.2-3-3-7.7-3-10.5.0zm72.5-13.3c-19.9-14.4-33.8-43.2-11.9-68.1 21.6-24.9 40.7-17.2 59.8.8 11.9 11.3 29.3 24.9 17.2 48.2-12.5 23.5-45.1 33.2-65.1 19.1zm47.7-44.5c-8.9-10-23.3 6.9-15.5 16.1 7.4 9 32.1 2.4 15.5-16.1zM504 256c0 137-111 248-248 248S8 393 8 256 119 8 256 8s248 111 248 248zm-66.2 42.6c2.5-16.1-20.2-16.6-25.2-25.7-13.6-24.1-27.7-36.8-54.5-30.4 11.6-8 23.5-6.1 23.5-6.1.3-6.4.0-13-9.4-24.9 3.9-12.5.3-22.4.3-22.4 15.5-8.6 26.8-24.4 29.1-43.2 3.6-31-18.8-59.2-49.8-62.8-22.1-2.5-43.7 7.7-54.3 25.7-23.2 40.1 1.4 70.9 22.4 81.4-14.4-1.4-34.3-11.9-40.1-34.3-6.6-25.7 2.8-49.8 8.9-61.4.0.0-4.4-5.8-8-8.9.0.0-13.8.0-24.6 5.3 11.9-15.2 25.2-14.4 25.2-14.4.0-6.4-.6-14.9-3.6-21.6-5.4-11-23.8-12.9-31.7 2.8.1-.2.3-.4.4-.5-5 11.9-1.1 55.9 16.9 87.2-2.5 1.4-9.1 6.1-13 10-21.6 9.7-56.2 60.3-56.2 60.3-28.2 10.8-77.2 50.9-70.6 79.7.3 3 1.4 5.5 3 7.5-2.8 2.2-5.5 5-8.3 8.3-11.9 13.8-5.3 35.2 17.7 24.4 15.8-7.2 29.6-20.2 36.3-30.4.0.0-5.5-5-16.3-4.4 27.7-6.6 34.3-9.4 46.2-9.1 8 3.9 8-34.3 8-34.3.0-14.7-2.2-31-11.1-41.5 12.5 12.2 29.1 32.7 28 60.6-.8 18.3-15.2 23-15.2 23-9.1 16.6-43.2 65.9-30.4 106 0 0-9.7-14.9-10.2-22.1-17.4 19.4-46.5 52.3-24.6 64.5 26.6 14.7 108.8-88.6 126.2-142.3 34.6-20.8 55.4-47.3 63.9-65 22 43.5 95.3 94.5 101.1 59z"/></svg><span class=menu-item-name>随笔</span></a></li><li class=menu-item><a href=/about/><span class=menu-item-name>关于</span></a></li><li class=menu-item><a id=theme-switcher href=#><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512" class="icon theme-icon-light"><path d="M193.2 104.5 242 7a18 18 0 0128 0l48.8 97.5L422.2 70A18 18 0 01442 89.8l-34.5 103.4L505 242a18 18 0 010 28l-97.5 48.8L442 422.2A18 18 0 01422.2 442l-103.4-34.5L270 505a18 18 0 01-28 0l-48.8-97.5L89.8 442A18 18 0 0170 422.2l34.5-103.4-97.5-48.8a18 18 0 010-28l97.5-48.8L70 89.8A18 18 0 0189.8 70zM256 128a128 128 0 10.01.0M256 160a96 96 0 10.01.0"/></svg><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512" class="icon theme-icon-dark"><path d="M27 412A256 256 0 10181 5a11.5 11.5.0 00-5 20A201.5 201.5.0 0142 399a11.5 11.5.0 00-15 13"/></svg></a></li></ul></nav></div></div><input type=checkbox id=nav-toggle aria-hidden=true>
<label for=nav-toggle class=nav-toggle></label>
<label for=nav-toggle class=nav-curtain></label></header><main class="main single" id=main><div class=main-inner><article class="content post h-entry" data-align=justify data-type=tech data-toc-num=true><h1 class="post-title p-name">ansible及ansible-playbook的使用</h1><div class="post-description p-summary">讲解ansible及ansible-playbook的使用</div><div class=post-meta><time datetime=2022-03-31T23:38:04+08:00 class="post-meta-item modified dt-updated"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512" class="icon post-meta-icon"><path d="M4e2 64h-48V12c0-6.627-5.373-12-12-12h-40c-6.627.0-12 5.373-12 12v52H160V12c0-6.627-5.373-12-12-12h-40c-6.627.0-12 5.373-12 12v52H48C21.49 64 0 85.49.0 112v352c0 26.51 21.49 48 48 48h352c26.51.0 48-21.49 48-48V112c0-26.51-21.49-48-48-48zm-6 4e2H54a6 6 0 01-6-6V160h352v298a6 6 0 01-6 6zm-52.849-200.65L198.842 404.519c-4.705 4.667-12.303 4.637-16.971-.068l-75.091-75.699c-4.667-4.705-4.637-12.303.068-16.971l22.719-22.536c4.705-4.667 12.303-4.637 16.97.069l44.104 44.461 111.072-110.181c4.705-4.667 12.303-4.637 16.971.068l22.536 22.718c4.667 4.705 4.636 12.303-.069 16.97z"/></svg>&nbsp;2022.3.31</time>
<span class="post-meta-item category"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512" class="icon post-meta-icon"><path d="M464 128H272l-54.63-54.63c-6-6-14.14-9.37-22.63-9.37H48C21.49 64 0 85.49.0 112v288c0 26.51 21.49 48 48 48h416c26.51.0 48-21.49 48-48V176c0-26.51-21.49-48-48-48zm0 272H48V112h140.12l54.63 54.63c6 6 14.14 9.37 22.63 9.37H464v224z"/></svg>&nbsp;<a href=/tech/ class="category-link p-category">技术</a>/<a href=/tech/ops/ class="category-link p-category">运维</a></span>
<span class="post-meta-item wordcount"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512" class="icon post-meta-icon"><path d="M497.9 142.1l-46.1 46.1c-4.7 4.7-12.3 4.7-17 0l-111-111c-4.7-4.7-4.7-12.3.0-17l46.1-46.1c18.7-18.7 49.1-18.7 67.9.0l60.1 60.1c18.8 18.7 18.8 49.1.0 67.9zM284.2 99.8 21.6 362.4.4 483.9c-2.9 16.4 11.4 30.6 27.8 27.8l121.5-21.3 262.6-262.6c4.7-4.7 4.7-12.3.0-17l-111-111c-4.8-4.7-12.4-4.7-17.1.0zM124.1 339.9c-5.5-5.5-5.5-14.3.0-19.8l154-154c5.5-5.5 14.3-5.5 19.8.0s5.5 14.3.0 19.8l-154 154c-5.5 5.5-14.3 5.5-19.8.0zM88 424h48v36.3l-64.5 11.3-31.1-31.1L51.7 376H88v48z"/></svg>&nbsp;42590</span>
<span class="post-meta-item reading-time"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512" class="icon post-meta-icon"><path d="M256 8C119 8 8 119 8 256s111 248 248 248 248-111 248-248S393 8 256 8zm0 448c-110.5.0-2e2-89.5-2e2-2e2S145.5 56 256 56s2e2 89.5 2e2 2e2-89.5 2e2-2e2 2e2zm61.8-104.4-84.9-61.7c-3.1-2.3-4.9-5.9-4.9-9.7V116c0-6.6 5.4-12 12-12h32c6.6.0 12 5.4 12 12v141.7l66.8 48.6c5.4 3.9 6.5 11.4 2.6 16.8L334.6 349c-3.9 5.3-11.4 6.5-16.8 2.6z"/></svg>&nbsp;86&nbsp;分钟</span>
<span class="post-meta-item busuanzi-page-pv" id=busuanzi_container_page_pv><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 576 512" class="icon post-meta-icon"><path d="M288 144a110.94 110.94.0 00-31.24 5 55.4 55.4.0 017.24 27 56 56 0 01-56 56 55.4 55.4.0 01-27-7.24A111.71 111.71.0 10288 144zm284.52 97.4C518.29 135.59 410.93 64 288 64S57.68 135.64 3.48 241.41a32.35 32.35.0 000 29.19C57.71 376.41 165.07 448 288 448s230.32-71.64 284.52-177.41a32.35 32.35.0 000-29.19zM288 4e2c-98.65.0-189.09-55-237.93-144C98.91 167 189.34 112 288 112s189.09 55 237.93 144C477.1 345 386.66 4e2 288 4e2z"/></svg>&nbsp;<span id=busuanzi_value_page_pv></span></span></div><nav class=contents><h2 id=contents class=contents-title>目录</h2><ol class=toc><li><a id=contents:配置主机清单 href=#配置主机清单>配置主机清单</a><ol><li><a id=contents:-ini方式 href=#-ini方式># ini方式</a></li><li><a id=contents:--yaml方式 href=#--yaml方式># yaml方式</a></li></ol></li><li><a id=contents:常用模块 href=#常用模块>常用模块</a><ol><li><a id=contents:--文件类操作 href=#--文件类操作># 文件类操作</a></li><li><a id=contents:--命令类操作 href=#--命令类操作># 命令类操作</a></li><li><a id=contents:--系统类操作 href=#--系统类操作># 系统类操作</a></li><li><a id=contents:--包管理类操作 href=#--包管理类操作># 包管理类操作</a></li></ol></li><li><a id=contents:认识ansible-playbook href=#认识ansible-playbook>#认识ansible-playbook</a></li><li><a id=contents:使用handlers href=#使用handlers>#使用handlers</a></li><li><a id=contents:使用tags href=#使用tags>#使用tags</a></li><li><a id=contents:使用变量一 href=#使用变量一>#使用变量(一)</a></li><li><a id=contents:使用变量二 href=#使用变量二>#使用变量(二)</a></li><li><a id=contents:使用变量三 href=#使用变量三>#使用变量(三)</a></li><li><a id=contents:使用变量四registerset_fact href=#使用变量四registerset_fact>#使用变量(四),register,set_fact</a></li><li><a id=contents:使用变量五内置变量host_vars href=#使用变量五内置变量host_vars>#使用变量(五),内置变量,host_vars</a></li><li><a id=contents:使用循环一with_items的使用 href=#使用循环一with_items的使用>#使用循环(一),with_items的使用</a></li><li><a id=contents:使用循环二对列表循环的操作 href=#使用循环二对列表循环的操作>#使用循环(二),对列表循环的操作</a></li><li><a id=contents:使用循环三嵌套循环 href=#使用循环三嵌套循环>#使用循环(三),嵌套循环</a></li><li><a id=contents:使用循环四序列索引循环 href=#使用循环四序列索引循环>#使用循环(四),序列索引循环</a></li><li><a id=contents:使用循环五with_sequencewith_random_choice href=#使用循环五with_sequencewith_random_choice>#使用循环(五),with_sequence,with_random_choice</a></li><li><a id=contents:使用循环六with_dictwith_subelementswith_file href=#使用循环六with_dictwith_subelementswith_file>#使用循环(六),with_dict,with_subelements,with_file</a></li><li><a id=contents:使用循环七-with_file-with_fileglob href=#使用循环七-with_file-with_fileglob>#使用循环(七) with_file, with_fileglob</a></li><li><a id=contents:条件判断六with_dictwith_subelementswith_file href=#条件判断六with_dictwith_subelementswith_file>#条件判断(六),with_dict,with_subelements,with_file</a></li><li><a id=contents:条件判断与tests href=#条件判断与tests>#条件判断与tests</a></li><li><a id=contents:条件判断与block href=#条件判断与block>#条件判断与block</a></li><li><a id=contents:条件判断与错误处理 href=#条件判断与错误处理>#条件判断与错误处理</a></li><li><a id=contents:过滤器 href=#过滤器>#过滤器</a></li><li><a id=contents:变量六include_vars href=#变量六include_vars>#变量(六)include_vars</a></li><li><a id=contents:过滤器二-json_query href=#过滤器二-json_query>#过滤器(二) json_query</a></li><li><a id=contents:过滤器三-其他过滤器 href=#过滤器三-其他过滤器>#过滤器(三) 其他过滤器</a></li><li><a id=contents:lookup插件 href=#lookup插件>#lookup插件</a></li><li><a id=contents:循环八 href=#循环八>#循环(八)</a></li><li><a id=contents:include href=#include>#include</a></li><li><a id=contents:include二 href=#include二>#include(二)</a></li><li><a id=contents:jinja2模板一 href=#jinja2模板一>#jinja2模板(一)</a></li><li><a id=contents:jinja2模板二 href=#jinja2模板二>#jinja2模板(二)</a></li><li><a id=contents:jinja2模板三 href=#jinja2模板三>#jinja2模板(三)</a></li><li><a id=contents:ansible中的role href=#ansible中的role>#ansible中的role</a></li><li><a id=contents:常用技巧一 href=#常用技巧一>#常用技巧(一)</a></li><li><a id=contents:常用技巧二 href=#常用技巧二>#常用技巧(二)</a></li></ol></nav><div class="post-body e-content"><h1 id=learning-ansible><a href=#learning-ansible class=anchor-link><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512" class="icon anchor-icon"><path d="M326.612 185.391c59.747 59.809 58.927 155.698.36 214.59-.11.12-.24.25-.36.37l-67.2 67.2c-59.27 59.27-155.699 59.262-214.96.0-59.27-59.26-59.27-155.7.0-214.96l37.106-37.106c9.84-9.84 26.786-3.3 27.294 10.606.648 17.722 3.826 35.527 9.69 52.721 1.986 5.822.567 12.262-3.783 16.612l-13.087 13.087c-28.026 28.026-28.905 73.66-1.155 101.96 28.024 28.579 74.086 28.749 102.325.51l67.2-67.19c28.191-28.191 28.073-73.757.0-101.83-3.701-3.694-7.429-6.564-10.341-8.569a16.037 16.037.0 01-6.947-12.606c-.396-10.567 3.348-21.456 11.698-29.806l21.054-21.055c5.521-5.521 14.182-6.199 20.584-1.731a152.482 152.482.0 0120.522 17.197zM467.547 44.449c-59.261-59.262-155.69-59.27-214.96.0l-67.2 67.2c-.12.12-.25.25-.36.37-58.566 58.892-59.387 154.781.36 214.59a152.454 152.454.0 0020.521 17.196c6.402 4.468 15.064 3.789 20.584-1.731l21.054-21.055c8.35-8.35 12.094-19.239 11.698-29.806a16.037 16.037.0 00-6.947-12.606c-2.912-2.005-6.64-4.875-10.341-8.569-28.073-28.073-28.191-73.639.0-101.83l67.2-67.19c28.239-28.239 74.3-28.069 102.325.51 27.75 28.3 26.872 73.934-1.155 101.96l-13.087 13.087c-4.35 4.35-5.769 10.79-3.783 16.612 5.864 17.194 9.042 34.999 9.69 52.721.509 13.906 17.454 20.446 27.294 10.606l37.106-37.106c59.271-59.259 59.271-155.699.001-214.959z"/></svg></a><a href=#contents:learning-ansible class=headings>learning ansible</a></h1><p><em>本文内容参考自<a href=https://www.zsythink.net/archives/2481 target=_blank rel=noopener>朱双印ansible笔记</a></em></p><h2 id=配置主机清单><a href=#配置主机清单 class=anchor-link><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512" class="icon anchor-icon"><path d="M326.612 185.391c59.747 59.809 58.927 155.698.36 214.59-.11.12-.24.25-.36.37l-67.2 67.2c-59.27 59.27-155.699 59.262-214.96.0-59.27-59.26-59.27-155.7.0-214.96l37.106-37.106c9.84-9.84 26.786-3.3 27.294 10.606.648 17.722 3.826 35.527 9.69 52.721 1.986 5.822.567 12.262-3.783 16.612l-13.087 13.087c-28.026 28.026-28.905 73.66-1.155 101.96 28.024 28.579 74.086 28.749 102.325.51l67.2-67.19c28.191-28.191 28.073-73.757.0-101.83-3.701-3.694-7.429-6.564-10.341-8.569a16.037 16.037.0 01-6.947-12.606c-.396-10.567 3.348-21.456 11.698-29.806l21.054-21.055c5.521-5.521 14.182-6.199 20.584-1.731a152.482 152.482.0 0120.522 17.197zM467.547 44.449c-59.261-59.262-155.69-59.27-214.96.0l-67.2 67.2c-.12.12-.25.25-.36.37-58.566 58.892-59.387 154.781.36 214.59a152.454 152.454.0 0020.521 17.196c6.402 4.468 15.064 3.789 20.584-1.731l21.054-21.055c8.35-8.35 12.094-19.239 11.698-29.806a16.037 16.037.0 00-6.947-12.606c-2.912-2.005-6.64-4.875-10.341-8.569-28.073-28.073-28.191-73.639.0-101.83l67.2-67.19c28.239-28.239 74.3-28.069 102.325.51 27.75 28.3 26.872 73.934-1.155 101.96l-13.087 13.087c-4.35 4.35-5.769 10.79-3.783 16.612 5.864 17.194 9.042 34.999 9.69 52.721.509 13.906 17.454 20.446 27.294 10.606l37.106-37.106c59.271-59.259 59.271-155.699.001-214.959z"/></svg></a><a href=#contents:配置主机清单 class=headings>配置主机清单</a></h2><p>主机清单配置有两种方式</p><h3 id=-ini方式><a href=#-ini方式 class=anchor-link><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512" class="icon anchor-icon"><path d="M326.612 185.391c59.747 59.809 58.927 155.698.36 214.59-.11.12-.24.25-.36.37l-67.2 67.2c-59.27 59.27-155.699 59.262-214.96.0-59.27-59.26-59.27-155.7.0-214.96l37.106-37.106c9.84-9.84 26.786-3.3 27.294 10.606.648 17.722 3.826 35.527 9.69 52.721 1.986 5.822.567 12.262-3.783 16.612l-13.087 13.087c-28.026 28.026-28.905 73.66-1.155 101.96 28.024 28.579 74.086 28.749 102.325.51l67.2-67.19c28.191-28.191 28.073-73.757.0-101.83-3.701-3.694-7.429-6.564-10.341-8.569a16.037 16.037.0 01-6.947-12.606c-.396-10.567 3.348-21.456 11.698-29.806l21.054-21.055c5.521-5.521 14.182-6.199 20.584-1.731a152.482 152.482.0 0120.522 17.197zM467.547 44.449c-59.261-59.262-155.69-59.27-214.96.0l-67.2 67.2c-.12.12-.25.25-.36.37-58.566 58.892-59.387 154.781.36 214.59a152.454 152.454.0 0020.521 17.196c6.402 4.468 15.064 3.789 20.584-1.731l21.054-21.055c8.35-8.35 12.094-19.239 11.698-29.806a16.037 16.037.0 00-6.947-12.606c-2.912-2.005-6.64-4.875-10.341-8.569-28.073-28.073-28.191-73.639.0-101.83l67.2-67.19c28.239-28.239 74.3-28.069 102.325.51 27.75 28.3 26.872 73.934-1.155 101.96l-13.087 13.087c-4.35 4.35-5.769 10.79-3.783 16.612 5.864 17.194 9.042 34.999 9.69 52.721.509 13.906 17.454 20.446 27.294 10.606l37.106-37.106c59.271-59.259 59.271-155.699.001-214.959z"/></svg></a><a href=#contents:-ini方式 class=headings># ini方式</a></h3><div class=highlight><div class=chroma><div class=table-container><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-ini data-lang=ini><span class=line><span class=cl><span class=c1># 1,如下示例:</span>
</span></span><span class=line><span class=cl><span class=k>[ctl]</span>
</span></span><span class=line><span class=cl><span class=na>10.168.0.2</span>
</span></span><span class=line><span class=cl><span class=na>10.168.0.3</span>
</span></span><span class=line><span class=cl><span class=na>10.168.0.4</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>[nova:children]</span>
</span></span><span class=line><span class=cl><span class=na>ctl</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>[nova-compute:children]</span>
</span></span><span class=line><span class=cl><span class=na>nova</span>
</span></span></code></pre></td></tr></table></div></div></div><h3 id=--yaml方式><a href=#--yaml方式 class=anchor-link><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512" class="icon anchor-icon"><path d="M326.612 185.391c59.747 59.809 58.927 155.698.36 214.59-.11.12-.24.25-.36.37l-67.2 67.2c-59.27 59.27-155.699 59.262-214.96.0-59.27-59.26-59.27-155.7.0-214.96l37.106-37.106c9.84-9.84 26.786-3.3 27.294 10.606.648 17.722 3.826 35.527 9.69 52.721 1.986 5.822.567 12.262-3.783 16.612l-13.087 13.087c-28.026 28.026-28.905 73.66-1.155 101.96 28.024 28.579 74.086 28.749 102.325.51l67.2-67.19c28.191-28.191 28.073-73.757.0-101.83-3.701-3.694-7.429-6.564-10.341-8.569a16.037 16.037.0 01-6.947-12.606c-.396-10.567 3.348-21.456 11.698-29.806l21.054-21.055c5.521-5.521 14.182-6.199 20.584-1.731a152.482 152.482.0 0120.522 17.197zM467.547 44.449c-59.261-59.262-155.69-59.27-214.96.0l-67.2 67.2c-.12.12-.25.25-.36.37-58.566 58.892-59.387 154.781.36 214.59a152.454 152.454.0 0020.521 17.196c6.402 4.468 15.064 3.789 20.584-1.731l21.054-21.055c8.35-8.35 12.094-19.239 11.698-29.806a16.037 16.037.0 00-6.947-12.606c-2.912-2.005-6.64-4.875-10.341-8.569-28.073-28.073-28.191-73.639.0-101.83l67.2-67.19c28.239-28.239 74.3-28.069 102.325.51 27.75 28.3 26.872 73.934-1.155 101.96l-13.087 13.087c-4.35 4.35-5.769 10.79-3.783 16.612 5.864 17.194 9.042 34.999 9.69 52.721.509 13.906 17.454 20.446 27.294 10.606l37.106-37.106c59.271-59.259 59.271-155.699.001-214.959z"/></svg></a><a href=#contents:--yaml方式 class=headings># yaml方式</a></h3><div class=highlight><div class=chroma><div class=table-container><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-yaml data-lang=yaml><span class=line><span class=cl><span class=c># 1,如下示例:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>all</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>children</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>k8s</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>hosts</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nt>master</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>          </span><span class=nt>ansible_host</span><span class=p>:</span><span class=w> </span><span class=m>192.168.110.11</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>          </span><span class=nt>ansible_port</span><span class=p>:</span><span class=w> </span><span class=m>22</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>          </span><span class=nt>ansible_user</span><span class=p>:</span><span class=w> </span><span class=l>root</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>          </span><span class=nt>ansible_pass</span><span class=p>:</span><span class=w> </span><span class=s1>&#39;123.com&#39;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nt>node2</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>          </span><span class=nt>ansible_host</span><span class=p>:</span><span class=w> </span><span class=m>192.168.110.22</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>          </span><span class=nt>ansible_port</span><span class=p>:</span><span class=w> </span><span class=m>22</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>          </span><span class=nt>ansible_user</span><span class=p>:</span><span class=w> </span><span class=l>root</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>          </span><span class=nt>ansible_pass</span><span class=p>:</span><span class=w> </span><span class=s1>&#39;123.com&#39;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nt>node3</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>          </span><span class=nt>ansible_host</span><span class=p>:</span><span class=w> </span><span class=m>192.168.110.33</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>          </span><span class=nt>ansible_port</span><span class=p>:</span><span class=w> </span><span class=m>22</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>          </span><span class=nt>ansible_user</span><span class=p>:</span><span class=w> </span><span class=l>root</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>          </span><span class=nt>ansible_pass</span><span class=p>:</span><span class=w> </span><span class=s1>&#39;123.com&#39;</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div></div><h2 id=常用模块><a href=#常用模块 class=anchor-link><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512" class="icon anchor-icon"><path d="M326.612 185.391c59.747 59.809 58.927 155.698.36 214.59-.11.12-.24.25-.36.37l-67.2 67.2c-59.27 59.27-155.699 59.262-214.96.0-59.27-59.26-59.27-155.7.0-214.96l37.106-37.106c9.84-9.84 26.786-3.3 27.294 10.606.648 17.722 3.826 35.527 9.69 52.721 1.986 5.822.567 12.262-3.783 16.612l-13.087 13.087c-28.026 28.026-28.905 73.66-1.155 101.96 28.024 28.579 74.086 28.749 102.325.51l67.2-67.19c28.191-28.191 28.073-73.757.0-101.83-3.701-3.694-7.429-6.564-10.341-8.569a16.037 16.037.0 01-6.947-12.606c-.396-10.567 3.348-21.456 11.698-29.806l21.054-21.055c5.521-5.521 14.182-6.199 20.584-1.731a152.482 152.482.0 0120.522 17.197zM467.547 44.449c-59.261-59.262-155.69-59.27-214.96.0l-67.2 67.2c-.12.12-.25.25-.36.37-58.566 58.892-59.387 154.781.36 214.59a152.454 152.454.0 0020.521 17.196c6.402 4.468 15.064 3.789 20.584-1.731l21.054-21.055c8.35-8.35 12.094-19.239 11.698-29.806a16.037 16.037.0 00-6.947-12.606c-2.912-2.005-6.64-4.875-10.341-8.569-28.073-28.073-28.191-73.639.0-101.83l67.2-67.19c28.239-28.239 74.3-28.069 102.325.51 27.75 28.3 26.872 73.934-1.155 101.96l-13.087 13.087c-4.35 4.35-5.769 10.79-3.783 16.612 5.864 17.194 9.042 34.999 9.69 52.721.509 13.906 17.454 20.446 27.294 10.606l37.106-37.106c59.271-59.259 59.271-155.699.001-214.959z"/></svg></a><a href=#contents:常用模块 class=headings>常用模块</a></h2><h3 id=--文件类操作><a href=#--文件类操作 class=anchor-link><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512" class="icon anchor-icon"><path d="M326.612 185.391c59.747 59.809 58.927 155.698.36 214.59-.11.12-.24.25-.36.37l-67.2 67.2c-59.27 59.27-155.699 59.262-214.96.0-59.27-59.26-59.27-155.7.0-214.96l37.106-37.106c9.84-9.84 26.786-3.3 27.294 10.606.648 17.722 3.826 35.527 9.69 52.721 1.986 5.822.567 12.262-3.783 16.612l-13.087 13.087c-28.026 28.026-28.905 73.66-1.155 101.96 28.024 28.579 74.086 28.749 102.325.51l67.2-67.19c28.191-28.191 28.073-73.757.0-101.83-3.701-3.694-7.429-6.564-10.341-8.569a16.037 16.037.0 01-6.947-12.606c-.396-10.567 3.348-21.456 11.698-29.806l21.054-21.055c5.521-5.521 14.182-6.199 20.584-1.731a152.482 152.482.0 0120.522 17.197zM467.547 44.449c-59.261-59.262-155.69-59.27-214.96.0l-67.2 67.2c-.12.12-.25.25-.36.37-58.566 58.892-59.387 154.781.36 214.59a152.454 152.454.0 0020.521 17.196c6.402 4.468 15.064 3.789 20.584-1.731l21.054-21.055c8.35-8.35 12.094-19.239 11.698-29.806a16.037 16.037.0 00-6.947-12.606c-2.912-2.005-6.64-4.875-10.341-8.569-28.073-28.073-28.191-73.639.0-101.83l67.2-67.19c28.239-28.239 74.3-28.069 102.325.51 27.75 28.3 26.872 73.934-1.155 101.96l-13.087 13.087c-4.35 4.35-5.769 10.79-3.783 16.612 5.864 17.194 9.042 34.999 9.69 52.721.509 13.906 17.454 20.446 27.294 10.606l37.106-37.106c59.271-59.259 59.271-155.699.001-214.959z"/></svg></a><a href=#contents:--文件类操作 class=headings># 文件类操作</a></h3><p>1,copy: 将ansible主机上的文件拷贝至远端主机</p><ul><li>同fetch类似,不过操作动作相反,fetch是从远端主机拿文件到ansible主机</li><li>可使用content直接代替src</li><li>可备份远端重名文件</li><li>可设定拷贝文件的权限</li></ul><p>2,file: 完成一些对文件的基本操作,包括创建,删除,修改文件和目录的权限等</p><ul><li>path是必须项,需要和state结合使用</li><li>state参数是核心,对不同类型的文件对应的动作不相同,path如果是文件(touch),是目录(directory); absent时不用管path是什么(目录或者文件)</li></ul><p>3,blockinfile: 在文件中插入一段文本,这段文本是被标记过的,方便我们后面对标记内容的操作(删除,修改等)</p><ul><li>对文件中块的操作,文件位置定位使用insertbefore,insertafter</li><li>使用block/content制定块内容</li><li>使用该模块marker会在插入内容前后增加marker内容</li><li>可使用regex,匹配文件中内容进行操作</li><li>包含backup相关内容</li></ul><p>4,lineinfile: 确保某一行文本存在于文件中,或不存在与文本中,可使用regex进行替换</p><ul><li>line指定行内容</li><li>包含regex参数,使用regex来匹配相应的行,当替换文本时，如果有多行文本都能被匹配，则只有最后面被匹配到的那行文本才会被替换，当删除文本时，如果有多行文本都能被匹配，这么这些行都会被删除</li><li>backrefs参数：默认情况下，当根据正则替换文本时，即使regexp参数中的正则存在分组，在line参数中也不能对正则中的分组进行引用，除非将backrefs参数的值设置为yes</li><li>插入内容为insertbefore,insertafter, 包含backup相关内容</li></ul><p>5,find: 类似find命令,可在远端机器中找到相应文件</p><ul><li>使用方式ansible-doc -s find查看</li></ul><p>6,replace: replace模块可以根据我们指定的正则表达式替换文件中的字符串，文件中所有被正则匹配到的字符串都会被替换</p><ul><li>使用方式ansible-doc -s replace查看</li></ul><h3 id=--命令类操作><a href=#--命令类操作 class=anchor-link><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512" class="icon anchor-icon"><path d="M326.612 185.391c59.747 59.809 58.927 155.698.36 214.59-.11.12-.24.25-.36.37l-67.2 67.2c-59.27 59.27-155.699 59.262-214.96.0-59.27-59.26-59.27-155.7.0-214.96l37.106-37.106c9.84-9.84 26.786-3.3 27.294 10.606.648 17.722 3.826 35.527 9.69 52.721 1.986 5.822.567 12.262-3.783 16.612l-13.087 13.087c-28.026 28.026-28.905 73.66-1.155 101.96 28.024 28.579 74.086 28.749 102.325.51l67.2-67.19c28.191-28.191 28.073-73.757.0-101.83-3.701-3.694-7.429-6.564-10.341-8.569a16.037 16.037.0 01-6.947-12.606c-.396-10.567 3.348-21.456 11.698-29.806l21.054-21.055c5.521-5.521 14.182-6.199 20.584-1.731a152.482 152.482.0 0120.522 17.197zM467.547 44.449c-59.261-59.262-155.69-59.27-214.96.0l-67.2 67.2c-.12.12-.25.25-.36.37-58.566 58.892-59.387 154.781.36 214.59a152.454 152.454.0 0020.521 17.196c6.402 4.468 15.064 3.789 20.584-1.731l21.054-21.055c8.35-8.35 12.094-19.239 11.698-29.806a16.037 16.037.0 00-6.947-12.606c-2.912-2.005-6.64-4.875-10.341-8.569-28.073-28.073-28.191-73.639.0-101.83l67.2-67.19c28.239-28.239 74.3-28.069 102.325.51 27.75 28.3 26.872 73.934-1.155 101.96l-13.087 13.087c-4.35 4.35-5.769 10.79-3.783 16.612 5.864 17.194 9.042 34.999 9.69 52.721.509 13.906 17.454 20.446 27.294 10.606l37.106-37.106c59.271-59.259 59.271-155.699.001-214.959z"/></svg></a><a href=#contents:--命令类操作 class=headings># 命令类操作</a></h3><p>1,command: 在远端主机上执行命令</p><ul><li>使用command模块在远程主机中执行命令时，不会经过远程主机的shell处理，在使用command模块时，如果需要执行的命令中含有重定向、管道符等操作时，这些符号也会失效，比如”&lt;“, “>”, “|”, “;” 和 “&” 这些符号，如果你需要这些功能，需要使用shell模块</li><li>具体使用方式,参考ansible-doc -s command</li></ul><p>2,shell: 在远端主机上执行命令,与command不同的是,shell模块在远端执行命令时,会经过远端主机的/bin/sh程序处理</p><ul><li>具体使用方式,参考ansible-doc -s shell</li></ul><p>3,scripts: 在远端主机上执行ansible主机上的脚本,脚本在ansible主机上,不需要拷贝到远端主机</p><ul><li>具体使用方式,参考ansible-doc -s scripts</li></ul><h3 id=--系统类操作><a href=#--系统类操作 class=anchor-link><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512" class="icon anchor-icon"><path d="M326.612 185.391c59.747 59.809 58.927 155.698.36 214.59-.11.12-.24.25-.36.37l-67.2 67.2c-59.27 59.27-155.699 59.262-214.96.0-59.27-59.26-59.27-155.7.0-214.96l37.106-37.106c9.84-9.84 26.786-3.3 27.294 10.606.648 17.722 3.826 35.527 9.69 52.721 1.986 5.822.567 12.262-3.783 16.612l-13.087 13.087c-28.026 28.026-28.905 73.66-1.155 101.96 28.024 28.579 74.086 28.749 102.325.51l67.2-67.19c28.191-28.191 28.073-73.757.0-101.83-3.701-3.694-7.429-6.564-10.341-8.569a16.037 16.037.0 01-6.947-12.606c-.396-10.567 3.348-21.456 11.698-29.806l21.054-21.055c5.521-5.521 14.182-6.199 20.584-1.731a152.482 152.482.0 0120.522 17.197zM467.547 44.449c-59.261-59.262-155.69-59.27-214.96.0l-67.2 67.2c-.12.12-.25.25-.36.37-58.566 58.892-59.387 154.781.36 214.59a152.454 152.454.0 0020.521 17.196c6.402 4.468 15.064 3.789 20.584-1.731l21.054-21.055c8.35-8.35 12.094-19.239 11.698-29.806a16.037 16.037.0 00-6.947-12.606c-2.912-2.005-6.64-4.875-10.341-8.569-28.073-28.073-28.191-73.639.0-101.83l67.2-67.19c28.239-28.239 74.3-28.069 102.325.51 27.75 28.3 26.872 73.934-1.155 101.96l-13.087 13.087c-4.35 4.35-5.769 10.79-3.783 16.612 5.864 17.194 9.042 34.999 9.69 52.721.509 13.906 17.454 20.446 27.294 10.606l37.106-37.106c59.271-59.259 59.271-155.699.001-214.959z"/></svg></a><a href=#contents:--系统类操作 class=headings># 系统类操作</a></h3><p>1,cron: 管理远端主机上的定时任务,功能同crontab</p><ul><li>具体使用方式,参考ansible-doc -s cron</li></ul><p>2,service: 管理远端主机上的服务</p><ul><li>具体使用方式,参考ansible-doc -s service</li></ul><p>3,user: 管理远端主机上的用户,类似命令usermod</p><ul><li>还可以管理用户的ssh密钥</li><li>具体使用方式,参考ansible-doc -s user</li></ul><p>4,groupo: 管理远端主机上的组,类似命令groupmod</p><ul><li>具体使用方式,参考ansible-doc -s group</li></ul><h3 id=--包管理类操作><a href=#--包管理类操作 class=anchor-link><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512" class="icon anchor-icon"><path d="M326.612 185.391c59.747 59.809 58.927 155.698.36 214.59-.11.12-.24.25-.36.37l-67.2 67.2c-59.27 59.27-155.699 59.262-214.96.0-59.27-59.26-59.27-155.7.0-214.96l37.106-37.106c9.84-9.84 26.786-3.3 27.294 10.606.648 17.722 3.826 35.527 9.69 52.721 1.986 5.822.567 12.262-3.783 16.612l-13.087 13.087c-28.026 28.026-28.905 73.66-1.155 101.96 28.024 28.579 74.086 28.749 102.325.51l67.2-67.19c28.191-28.191 28.073-73.757.0-101.83-3.701-3.694-7.429-6.564-10.341-8.569a16.037 16.037.0 01-6.947-12.606c-.396-10.567 3.348-21.456 11.698-29.806l21.054-21.055c5.521-5.521 14.182-6.199 20.584-1.731a152.482 152.482.0 0120.522 17.197zM467.547 44.449c-59.261-59.262-155.69-59.27-214.96.0l-67.2 67.2c-.12.12-.25.25-.36.37-58.566 58.892-59.387 154.781.36 214.59a152.454 152.454.0 0020.521 17.196c6.402 4.468 15.064 3.789 20.584-1.731l21.054-21.055c8.35-8.35 12.094-19.239 11.698-29.806a16.037 16.037.0 00-6.947-12.606c-2.912-2.005-6.64-4.875-10.341-8.569-28.073-28.073-28.191-73.639.0-101.83l67.2-67.19c28.239-28.239 74.3-28.069 102.325.51 27.75 28.3 26.872 73.934-1.155 101.96l-13.087 13.087c-4.35 4.35-5.769 10.79-3.783 16.612 5.864 17.194 9.042 34.999 9.69 52.721.509 13.906 17.454 20.446 27.294 10.606l37.106-37.106c59.271-59.259 59.271-155.699.001-214.959z"/></svg></a><a href=#contents:--包管理类操作 class=headings># 包管理类操作</a></h3><p>1,yum_repository: 管理远端主机上的yum仓库</p><ul><li>具体使用方式,参考ansible-doc -s yum_repository</li></ul><p>1,yum: 通过远端主机上的yum管理软件包</p><ul><li>具体使用方式,参考ansible-doc -s yum</li></ul><h2 id=认识ansible-playbook><a href=#认识ansible-playbook class=anchor-link><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512" class="icon anchor-icon"><path d="M326.612 185.391c59.747 59.809 58.927 155.698.36 214.59-.11.12-.24.25-.36.37l-67.2 67.2c-59.27 59.27-155.699 59.262-214.96.0-59.27-59.26-59.27-155.7.0-214.96l37.106-37.106c9.84-9.84 26.786-3.3 27.294 10.606.648 17.722 3.826 35.527 9.69 52.721 1.986 5.822.567 12.262-3.783 16.612l-13.087 13.087c-28.026 28.026-28.905 73.66-1.155 101.96 28.024 28.579 74.086 28.749 102.325.51l67.2-67.19c28.191-28.191 28.073-73.757.0-101.83-3.701-3.694-7.429-6.564-10.341-8.569a16.037 16.037.0 01-6.947-12.606c-.396-10.567 3.348-21.456 11.698-29.806l21.054-21.055c5.521-5.521 14.182-6.199 20.584-1.731a152.482 152.482.0 0120.522 17.197zM467.547 44.449c-59.261-59.262-155.69-59.27-214.96.0l-67.2 67.2c-.12.12-.25.25-.36.37-58.566 58.892-59.387 154.781.36 214.59a152.454 152.454.0 0020.521 17.196c6.402 4.468 15.064 3.789 20.584-1.731l21.054-21.055c8.35-8.35 12.094-19.239 11.698-29.806a16.037 16.037.0 00-6.947-12.606c-2.912-2.005-6.64-4.875-10.341-8.569-28.073-28.073-28.191-73.639.0-101.83l67.2-67.19c28.239-28.239 74.3-28.069 102.325.51 27.75 28.3 26.872 73.934-1.155 101.96l-13.087 13.087c-4.35 4.35-5.769 10.79-3.783 16.612 5.864 17.194 9.042 34.999 9.69 52.721.509 13.906 17.454 20.446 27.294 10.606l37.106-37.106c59.271-59.259 59.271-155.699.001-214.959z"/></svg></a><a href=#contents:认识ansible-playbook class=headings>#认识ansible-playbook</a></h2><p>1,ansible-playbook的使用,可以理解为ansible -m &lt;module_name> -a 'xxxx'的转换,将命令行使用模块操作的内容写成脚本内容,按照脚本内容完成相关操作</p><p>2,上述脚本在ansible-playbook中称作为'playbook',即剧本</p><ul><li>每个playbook(剧本)又多个play(桥段)组成,每个剧本是由多个桥段组成的,每个桥段包含有人物,场景,故事</li><li>每个play在执行时,都会执行一个默认任务('Gathering Facts),任务会收集当前当前play对应的目标主机的相关信息(IP,hostname,硬件版本,系统版本等),收集完成后才会完成我们定义的相关任务</li></ul><p>3,ansible有个重要特性:幂等性</p><ul><li>在ansible调用模块或者ansible-playbook执行相应play时,输出内容会有颜色区分,黄色表示有修改,绿色表示么有修改;区别是远端的内容是否满足我们的预期</li><li>ansible是”以结果为导向的”，我们指定了一个”目标状态”，ansible会自动判断，”当前状态”是否与”目标状态”一致，如果一致，则不进行任何操作，如果不一致，那么就将”当前状态”变成”目标状态”，这就是”幂等性”，”幂等性”可以保证我们重复的执行同一项操作时，得到的结果是一样的</li></ul><h2 id=使用handlers><a href=#使用handlers class=anchor-link><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512" class="icon anchor-icon"><path d="M326.612 185.391c59.747 59.809 58.927 155.698.36 214.59-.11.12-.24.25-.36.37l-67.2 67.2c-59.27 59.27-155.699 59.262-214.96.0-59.27-59.26-59.27-155.7.0-214.96l37.106-37.106c9.84-9.84 26.786-3.3 27.294 10.606.648 17.722 3.826 35.527 9.69 52.721 1.986 5.822.567 12.262-3.783 16.612l-13.087 13.087c-28.026 28.026-28.905 73.66-1.155 101.96 28.024 28.579 74.086 28.749 102.325.51l67.2-67.19c28.191-28.191 28.073-73.757.0-101.83-3.701-3.694-7.429-6.564-10.341-8.569a16.037 16.037.0 01-6.947-12.606c-.396-10.567 3.348-21.456 11.698-29.806l21.054-21.055c5.521-5.521 14.182-6.199 20.584-1.731a152.482 152.482.0 0120.522 17.197zM467.547 44.449c-59.261-59.262-155.69-59.27-214.96.0l-67.2 67.2c-.12.12-.25.25-.36.37-58.566 58.892-59.387 154.781.36 214.59a152.454 152.454.0 0020.521 17.196c6.402 4.468 15.064 3.789 20.584-1.731l21.054-21.055c8.35-8.35 12.094-19.239 11.698-29.806a16.037 16.037.0 00-6.947-12.606c-2.912-2.005-6.64-4.875-10.341-8.569-28.073-28.073-28.191-73.639.0-101.83l67.2-67.19c28.239-28.239 74.3-28.069 102.325.51 27.75 28.3 26.872 73.934-1.155 101.96l-13.087 13.087c-4.35 4.35-5.769 10.79-3.783 16.612 5.864 17.194 9.042 34.999 9.69 52.721.509 13.906 17.454 20.446 27.294 10.606l37.106-37.106c59.271-59.259 59.271-155.699.001-214.959z"/></svg></a><a href=#contents:使用handlers class=headings>#使用handlers</a></h2><p>1,handlers的使用场景:</p><ul><li>有个任务需要修改nginx的配置文件,将listen端口由8080改为8088,使用handler可以在nginx配置文件有修改的环境上重启nginx,没有修改的不会出发重启nginx</li><li>handlers可以理解为另一种tasks,handlers是另一种'任务列表',handlers中的任务会被tasks中的任务调用;</li><li>handlers被调用并不一定会执行,只有当tasks中的任务真正被执行后(真正的进行了实际操作,造成了实际变化),handlers中的任务才会真正执行</li><li>如果tasks中的任务并没有作出任何实际的操作,那么handlers中的任务即使被调用,也不会执行</li><li>handlers和tasks是平级的,所以缩进相同</li></ul><p>2,handlers的调用:</p><ul><li>handlers需要被关键字notify调用
如下示例:</li></ul><div class=highlight><div class=chroma><div class=table-container><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-yaml data-lang=yaml><span class=line><span class=cl><span class=nn>---</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span>- <span class=nt>hosts</span><span class=p>:</span><span class=w> </span><span class=l>all</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>remote_user</span><span class=p>:</span><span class=w> </span><span class=l>root</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>tasks</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span>- <span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>change nginx configuration</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>lineinfile</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=l>path=/etc/nginx/conf.d/test.conf</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=l>regexp=&#34;listen(.*) 8080(.*)&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=l>line=&#34;listen\1 8088\2&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=l>backrefs=yes</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=l>backup=yes</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>notify</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=l>restart nginx</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>handlers</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span>- <span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>restart nginx</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>service</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=l>name=nginx</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=l>state=restarted </span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div></div><p>3,handlers中可以有多个任务,被tasks中不同的任务调用</p><ul><li>handler执行的顺序与handler在playbook中定义的顺序相同,与handler被notify的顺序无关(下述内容ht1先触发,ht2后触发),如下示例:</li></ul><div class=highlight><div class=chroma><div class=table-container><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-yaml data-lang=yaml><span class=line><span class=cl><span class=nn>---</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span>- <span class=nt>hosts</span><span class=p>:</span><span class=w> </span><span class=l>all</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>remote_user</span><span class=p>:</span><span class=w> </span><span class=l>root</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>tasks</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span>- <span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>make testfile1</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>file</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=l>path=/testdir/testfile1</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=l>state=directory</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>notify</span><span class=p>:</span><span class=w> </span><span class=l>ht2</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span>- <span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>make testfile2</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>file</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=l>path=/testdir/testfile2</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=l>state=directory</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>notify</span><span class=p>:</span><span class=w> </span><span class=l>ht1</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>handlers</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span>- <span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>ht1</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>file</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=l>path=/testdir/ht1</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=l>state=touch</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  
</span></span></span><span class=line><span class=cl><span class=w>  </span>- <span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>ht2</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>file</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=l>path=/testdir/ht2</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=l>state=touch</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div></div><ul><li>默认情况下,所有tasks执行完成后,才会执行各个handlers</li><li>当存在多个同名的handler时,只会执行一个handler</li></ul><p>4,若要在执行完某个task后立即执行其对应的handler,需要使用meta模块</p><ul><li>如下示例:</li></ul><div class=highlight><div class=chroma><div class=table-container><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span><span class=lnt>32
</span><span class=lnt>33
</span><span class=lnt>34
</span><span class=lnt>35
</span><span class=lnt>36
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-yaml data-lang=yaml><span class=line><span class=cl><span class=nn>---</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span>- <span class=nt>hosts</span><span class=p>:</span><span class=w> </span><span class=l>all</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>remote_user</span><span class=p>:</span><span class=w> </span><span class=l>root</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>tasks</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span>- <span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>task1</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>file</span><span class=p>:</span><span class=w> 
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=l>path=/testdir/testfile</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=l>state=touch</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>notify</span><span class=p>:</span><span class=w> </span><span class=l>handler1</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span>- <span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>task2</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>file</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=l>path=/testdir/testfile2</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=l>state=touch</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>notify</span><span class=p>:</span><span class=w> </span><span class=l>handler2</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span>- <span class=nt>meta</span><span class=p>:</span><span class=w> </span><span class=l>flush handlers</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span>- <span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>task3</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>file</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=l>path=/testdir/testfile3</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=l>state=touch</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>notify</span><span class=p>:</span><span class=w> </span><span class=l>handler3</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>handlers</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span>- <span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>handler1</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>file</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=l>path=/testdir/hd1</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=l>state=touch</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span>- <span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>handler2</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>file</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=l>path=/testdir/hd2</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=l>state=touch</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span>- <span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>handler3</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>file</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=l>path=/testdir/hd3</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=l>state=touch</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div></div><ul><li>meta可以理解为tasks下一个特殊任务,使用的是meta模块</li><li>meta: flush_handlers指的是立即执行之前的task对应的handlers,上述例子中flush_handlers之前有两个task,在执行了这两个task之后立即执行他们对应的handler</li><li>使用meta配合task和handler,可以让任务调用更加灵活</li></ul><p>5,如果需要一次性notify多个handler,需要使用到listen</p><ul><li>可以把'listen'理解为'组名',可以把多个handler分成'组',当我们需要一次性notify多个handler时,只要将多个handler分成一组,使用相同的组名即可</li><li>如下示例:</li></ul><div class=highlight><div class=chroma><div class=table-container><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-yaml data-lang=yaml><span class=line><span class=cl><span class=nn>---</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span>- <span class=nt>hosts</span><span class=p>:</span><span class=w> </span><span class=l>all</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>remote_user</span><span class=p>:</span><span class=w> </span><span class=l>root</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>tasks</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span>- <span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>task1</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>file</span><span class=p>:</span><span class=w> 
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=l>path=/testdir/testfile</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=l>state=touch</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>notify</span><span class=p>:</span><span class=w> </span><span class=l>handler group1</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>handlers</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span>- <span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>handler1</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>listen</span><span class=p>:</span><span class=w> </span><span class=s1>&#39;handler group1&#39;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>shell</span><span class=p>:</span><span class=w> </span><span class=s1>&#39;echo handler1&#39;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span>- <span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>handler2</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>listen</span><span class=p>:</span><span class=w> </span><span class=s1>&#39;handler group1&#39;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>shell</span><span class=p>:</span><span class=w> </span><span class=s1>&#39;echo handler2&#39;</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div></div><h2 id=使用tags><a href=#使用tags class=anchor-link><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512" class="icon anchor-icon"><path d="M326.612 185.391c59.747 59.809 58.927 155.698.36 214.59-.11.12-.24.25-.36.37l-67.2 67.2c-59.27 59.27-155.699 59.262-214.96.0-59.27-59.26-59.27-155.7.0-214.96l37.106-37.106c9.84-9.84 26.786-3.3 27.294 10.606.648 17.722 3.826 35.527 9.69 52.721 1.986 5.822.567 12.262-3.783 16.612l-13.087 13.087c-28.026 28.026-28.905 73.66-1.155 101.96 28.024 28.579 74.086 28.749 102.325.51l67.2-67.19c28.191-28.191 28.073-73.757.0-101.83-3.701-3.694-7.429-6.564-10.341-8.569a16.037 16.037.0 01-6.947-12.606c-.396-10.567 3.348-21.456 11.698-29.806l21.054-21.055c5.521-5.521 14.182-6.199 20.584-1.731a152.482 152.482.0 0120.522 17.197zM467.547 44.449c-59.261-59.262-155.69-59.27-214.96.0l-67.2 67.2c-.12.12-.25.25-.36.37-58.566 58.892-59.387 154.781.36 214.59a152.454 152.454.0 0020.521 17.196c6.402 4.468 15.064 3.789 20.584-1.731l21.054-21.055c8.35-8.35 12.094-19.239 11.698-29.806a16.037 16.037.0 00-6.947-12.606c-2.912-2.005-6.64-4.875-10.341-8.569-28.073-28.073-28.191-73.639.0-101.83l67.2-67.19c28.239-28.239 74.3-28.069 102.325.51 27.75 28.3 26.872 73.934-1.155 101.96l-13.087 13.087c-4.35 4.35-5.769 10.79-3.783 16.612 5.864 17.194 9.042 34.999 9.69 52.721.509 13.906 17.454 20.446 27.294 10.606l37.106-37.106c59.271-59.259 59.271-155.699.001-214.959z"/></svg></a><a href=#contents:使用tags class=headings>#使用tags</a></h2><p>1,写了一个很长的playbook,在调试时只想跑其中很少的一部分,tag在这种场景下可以使用,指定执行哪些任务,不执行哪些任务</p><ul><li>如下示例:</li></ul><div class=highlight><div class=chroma><div class=table-container><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-yaml data-lang=yaml><span class=line><span class=cl><span class=nn>---</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span>- <span class=nt>hosts</span><span class=p>:</span><span class=w> </span><span class=l>all</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>remote_user</span><span class=p>:</span><span class=w> </span><span class=l>root</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>tasks</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span>- <span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>test 1</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>file</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=l>path=/testdir/testfile</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=l>state=touch</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>tags</span><span class=p>:</span><span class=w> </span><span class=l>t1</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span>- <span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>test 2</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>file</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=l>path=/testdir/testfile2</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=l>state=touch</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=l>tags:t2</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span>- <span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>test 3</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>file</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=l>path=/testdir/testfile3</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=l>state=touch</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>tags</span><span class=p>:</span><span class=w> </span><span class=l>t3</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=l>$ ansible-playbook --tags=t2 test.yaml</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=l>$ ansible-playbook --skip-tags=t2 test.yaml</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div></div><ul><li>--tags=t2,只执行tag为t2部分的task,--skip-tags=t2,跳过tag=t2的tag</li><li>tag相关使用命令:</li></ul><div class=highlight><div class=chroma><div class=table-container><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl><span class=c1># 指定多个tag时,使用命令为</span>
</span></span><span class=line><span class=cl>$ ansible-playbook -t tag1,tag2,tag3 test.yaml
</span></span><span class=line><span class=cl><span class=c1># 执行play前,查看当前有哪些tag</span>
</span></span><span class=line><span class=cl>$ ansible-playbook --list-tags test.yaml
</span></span></code></pre></td></tr></table></div></div></div><ul><li>ansible预置了几个特殊tag:</li></ul><pre tabindex=0><code># always: 如果任务的tags包含always,则该task一定会被执行,除非指定--skip-tags always(该情况也不合理,可能其他任务也包含always,这样其他task也不会执行)
# never: 永远不执行,与always刚好相反

## 下列只在调用标签时生效
# tagged: ansible-playbook --tags tagged test.yaml --&gt; 只执行有标签的task,没有标签的task不会被执行
# untagged: ansible-playbook --tags untagged test.yaml --&gt; 只执行没有tag的task,有tag的不会被执行
# all: 默认使用,所有都会被执行
</code></pre><ul><li>可以为task指定多个tag,如下:</li></ul><div class=highlight><div class=chroma><div class=table-container><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span><span class=lnt>7
</span><span class=lnt>8
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-yaml data-lang=yaml><span class=line><span class=cl><span class=c># method one</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>tags</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span>- <span class=l>testing</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span>- <span class=l>t1</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=c># method two</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>tags</span><span class=p>:</span><span class=w> </span><span class=l>testing, t1</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=c># method three</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>tags</span><span class=p>:</span><span class=w> </span><span class=p>[</span><span class=s1>&#39;testing&#39;</span><span class=p>,</span><span class=w> </span><span class=s1>&#39;t1&#39;</span><span class=p>]</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div></div><p>2,play也可以指定tags,当一个play之指定了tags,这个play下的所有task都包含该tag,若该play下的task还有自己的tags,则该task的实际tags为'play tags' + 'task tags'</p><div class=highlight><div class=chroma><div class=table-container><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-yaml data-lang=yaml><span class=line><span class=cl><span class=nn>---</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span>- <span class=nt>hosts</span><span class=p>:</span><span class=w> </span><span class=l>test70</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>remote_user</span><span class=p>:</span><span class=w> </span><span class=l>root</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>tags</span><span class=p>:</span><span class=w> </span><span class=l>httpd</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>tasks</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span>- <span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>install httpd package</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>tags</span><span class=p>:</span><span class=w> </span><span class=p>[</span><span class=s1>&#39;package&#39;</span><span class=p>]</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>yum</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=l>name=httpd</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=l>state=latest</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w> 
</span></span></span><span class=line><span class=cl><span class=w>  </span>- <span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>start up httpd service</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>tags</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span>- <span class=l>service</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>service</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>httpd</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>state</span><span class=p>:</span><span class=w> </span><span class=l>started</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div></div><h2 id=使用变量一><a href=#使用变量一 class=anchor-link><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512" class="icon anchor-icon"><path d="M326.612 185.391c59.747 59.809 58.927 155.698.36 214.59-.11.12-.24.25-.36.37l-67.2 67.2c-59.27 59.27-155.699 59.262-214.96.0-59.27-59.26-59.27-155.7.0-214.96l37.106-37.106c9.84-9.84 26.786-3.3 27.294 10.606.648 17.722 3.826 35.527 9.69 52.721 1.986 5.822.567 12.262-3.783 16.612l-13.087 13.087c-28.026 28.026-28.905 73.66-1.155 101.96 28.024 28.579 74.086 28.749 102.325.51l67.2-67.19c28.191-28.191 28.073-73.757.0-101.83-3.701-3.694-7.429-6.564-10.341-8.569a16.037 16.037.0 01-6.947-12.606c-.396-10.567 3.348-21.456 11.698-29.806l21.054-21.055c5.521-5.521 14.182-6.199 20.584-1.731a152.482 152.482.0 0120.522 17.197zM467.547 44.449c-59.261-59.262-155.69-59.27-214.96.0l-67.2 67.2c-.12.12-.25.25-.36.37-58.566 58.892-59.387 154.781.36 214.59a152.454 152.454.0 0020.521 17.196c6.402 4.468 15.064 3.789 20.584-1.731l21.054-21.055c8.35-8.35 12.094-19.239 11.698-29.806a16.037 16.037.0 00-6.947-12.606c-2.912-2.005-6.64-4.875-10.341-8.569-28.073-28.073-28.191-73.639.0-101.83l67.2-67.19c28.239-28.239 74.3-28.069 102.325.51 27.75 28.3 26.872 73.934-1.155 101.96l-13.087 13.087c-4.35 4.35-5.769 10.79-3.783 16.612 5.864 17.194 9.042 34.999 9.69 52.721.509 13.906 17.454 20.446 27.294 10.606l37.106-37.106c59.271-59.259 59.271-155.699.001-214.959z"/></svg></a><a href=#contents:使用变量一 class=headings>#使用变量(一)</a></h2><p>1,怎么定义变量</p><ul><li>变量由数字,字母,下划线组成,要以字母开头</li><li>ansible的关键字不能作为变量名</li></ul><p>2,变量的定义及引用</p><ul><li>变量定义可以使用vars,和tasks同级,如下(普通定义方式):</li></ul><div class=highlight><div class=chroma><div class=table-container><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-yaml data-lang=yaml><span class=line><span class=cl><span class=nn>---</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span>- <span class=nt>hosts</span><span class=p>:</span><span class=w> </span><span class=l>all</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>remote_user</span><span class=p>:</span><span class=w> </span><span class=l>root</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>vars</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>testvar1</span><span class=p>:</span><span class=w> </span><span class=l>testfile</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>testvar2</span><span class=p>:</span><span class=w> </span><span class=l>testfile2</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=c># 或者使用yaml写法</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>vars</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span>- <span class=nt>testvar1</span><span class=p>:</span><span class=w> </span><span class=l>testfile</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span>- <span class=nt>testvar2</span><span class=p>:</span><span class=w> </span><span class=l>testfile2</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>tasks</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span>- <span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>task1</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>file</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>path</span><span class=p>:</span><span class=w> </span><span class=l>/testdir/{{testvar1}}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>state</span><span class=p>:</span><span class=w> </span><span class=l>touch</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div></div><ul><li>使用属性的方式定义</li></ul><div class=highlight><div class=chroma><div class=table-container><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-yaml data-lang=yaml><span class=line><span class=cl>- <span class=nt>hosts</span><span class=p>:</span><span class=w> </span><span class=l>all</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>remote_user</span><span class=p>:</span><span class=w> </span><span class=l>root</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>vars</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>nginx</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>conf80</span><span class=p>:</span><span class=w> </span><span class=l>/etc/nginx/conf.d/80.conf</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>conf8080</span><span class=p>:</span><span class=w> </span><span class=l>/etc/nginx/conf.d/8080.conf</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>tasks</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span>- <span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>task1</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>file</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>path</span><span class=p>:</span><span class=w> </span><span class=s2>&#34;{{nginx.conf80}}&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=c># 或者path: &#34;{{nginx[&#39;conf80&#39;]}}&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>state</span><span class=p>:</span><span class=w> </span><span class=l>touch</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span>- <span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>task2</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>file</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>path</span><span class=p>:</span><span class=w> </span><span class=s2>&#34;{{nginx.conf8080}}&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=c># 或者path: &#34;{{nginx[&#39;conf8080&#39;]}}&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>state</span><span class=p>:</span><span class=w> </span><span class=l>touch</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=c># 使用=给模块参数赋值时,可以不考虑变量是否加引号</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=c>#  - name: task2</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=c>#    file:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=c>#      path={{nginx.conf8080}}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=c>#      # 或者path={{nginx[&#39;conf8080&#39;]}}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=c>#      state=touch</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div></div><blockquote><p>注意: 上面列举的两个例子有些差别,第一个例子中变量没有加引号,第二个有加引号,因为第一个变量不是'开头'位置,第二个是'开头'位置
但实际上也有例外,给模块参数赋值时,可以选择':',也可以选择'=',当使用'='时,可以不用考虑引号的问题</p></blockquote><p>3,在文件中定义变量给playbook使用</p><ul><li>将变量在单独的文件中定义的好处是,可以做到变量文件分离,不给看到变量的值</li><li>在文件中定义变量时,不用使用vars关键字,直接定义变量即可,如下集中语法:</li></ul><div class=highlight><div class=chroma><div class=table-container><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-yaml data-lang=yaml><span class=line><span class=cl><span class=c># method one</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>testvar1</span><span class=p>:</span><span class=w> </span><span class=l>testfile</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>testvar2</span><span class=p>:</span><span class=w> </span><span class=l>testfile2</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=c># method two</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span>- <span class=nt>testvar1</span><span class=p>:</span><span class=w> </span><span class=l>testfile</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span>- <span class=nt>testvar2</span><span class=p>:</span><span class=w> </span><span class=l>testfile2</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=c># method three</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>nginx</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>conf80</span><span class=p>:</span><span class=w> </span><span class=l>/etc/nginx/conf.d/80.conf</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>conf8080</span><span class=p>:</span><span class=w> </span><span class=l>/etc/nginx/conf.d/8080.conf</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div></div><ul><li>在文件中定义完变量,在playbook中使用变量,需要使用vars_files,被导入的文件以'-'开头(可以引入多个变量文件),以yaml中块序列的方式导入</li></ul><div class=highlight><div class=chroma><div class=table-container><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-yaml data-lang=yaml><span class=line><span class=cl><span class=nn>---</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span>- <span class=nt>hosts</span><span class=p>:</span><span class=w> </span><span class=l>all</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>remote_user</span><span class=p>:</span><span class=w> </span><span class=l>root</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>vars_files</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span>- <span class=l>/testdir/ansible/nginx_vars.yml</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>tasks</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span>- <span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>task1</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>file</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>path</span><span class=p>:</span><span class=w> </span><span class=s2>&#34;{{nginx.conf80}}&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>state</span><span class=p>:</span><span class=w> </span><span class=l>touch</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span>- <span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>task2</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>file</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>path</span><span class=p>:</span><span class=w> </span><span class=s2>&#34;{{nginx[&#39;conf8080&#39;]}}&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>state</span><span class=p>:</span><span class=w> </span><span class=l>touch</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div></div><h2 id=使用变量二><a href=#使用变量二 class=anchor-link><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512" class="icon anchor-icon"><path d="M326.612 185.391c59.747 59.809 58.927 155.698.36 214.59-.11.12-.24.25-.36.37l-67.2 67.2c-59.27 59.27-155.699 59.262-214.96.0-59.27-59.26-59.27-155.7.0-214.96l37.106-37.106c9.84-9.84 26.786-3.3 27.294 10.606.648 17.722 3.826 35.527 9.69 52.721 1.986 5.822.567 12.262-3.783 16.612l-13.087 13.087c-28.026 28.026-28.905 73.66-1.155 101.96 28.024 28.579 74.086 28.749 102.325.51l67.2-67.19c28.191-28.191 28.073-73.757.0-101.83-3.701-3.694-7.429-6.564-10.341-8.569a16.037 16.037.0 01-6.947-12.606c-.396-10.567 3.348-21.456 11.698-29.806l21.054-21.055c5.521-5.521 14.182-6.199 20.584-1.731a152.482 152.482.0 0120.522 17.197zM467.547 44.449c-59.261-59.262-155.69-59.27-214.96.0l-67.2 67.2c-.12.12-.25.25-.36.37-58.566 58.892-59.387 154.781.36 214.59a152.454 152.454.0 0020.521 17.196c6.402 4.468 15.064 3.789 20.584-1.731l21.054-21.055c8.35-8.35 12.094-19.239 11.698-29.806a16.037 16.037.0 00-6.947-12.606c-2.912-2.005-6.64-4.875-10.341-8.569-28.073-28.073-28.191-73.639.0-101.83l67.2-67.19c28.239-28.239 74.3-28.069 102.325.51 27.75 28.3 26.872 73.934-1.155 101.96l-13.087 13.087c-4.35 4.35-5.769 10.79-3.783 16.612 5.864 17.194 9.042 34.999 9.69 52.721.509 13.906 17.454 20.446 27.294 10.606l37.106-37.106c59.271-59.259 59.271-155.699.001-214.959z"/></svg></a><a href=#contents:使用变量二 class=headings>#使用变量(二)</a></h2><p>1,在playbook执行前,有一个Gathering Facts的动作,调用的是setup模块; 这些信息会保存在对应的变量中，我们在playbook中可以使用这些变量,我们可以称这些信息为facts信息</p><ul><li>setupa模块的返回值是json格式的,方便返回时内容展示</li><li>setup模块可以获取远端主机很详尽的信息,若需要过滤相关信息,可以使用setup的filter参数(支持通配符)</li></ul><div class=highlight><div class=chroma><div class=table-container><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl><span class=c1># 显示内存相关信息</span>
</span></span><span class=line><span class=cl>ansible all -m setup -a <span class=s1>&#39;filter=ansible_memory_mb&#39;</span>
</span></span><span class=line><span class=cl><span class=c1># 不确定信息相关信息,使用通配符来获取</span>
</span></span><span class=line><span class=cl>ansible all -m setup -a <span class=s1>&#39;filter=*mb*&#39;</span>
</span></span></code></pre></td></tr></table></div></div></div><ul><li>setup模块获取的信息都保存在相应的变量中,我们可以通过引用变量获取到这些值</li></ul><p>2,setup模块支持获取自定义内容</p><ul><li>要求:自定义内容存在于目标主机的/etc/ansible/facts.d/下以.fact结尾的文件; 这些文件需要以json或者ini格式保存变量信息</li></ul><div class=highlight><div class=chroma><div class=table-container><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>$ cat /etc/ansible/facts.d/test.fact
</span></span><span class=line><span class=cl><span class=o>[</span>testmsg<span class=o>]</span>
</span></span><span class=line><span class=cl><span class=nv>msg1</span><span class=o>=</span><span class=s1>&#39;test message 1&#39;</span>
</span></span><span class=line><span class=cl><span class=nv>msg2</span><span class=o>=</span><span class=s1>&#39;test message 2&#39;</span>
</span></span></code></pre></td></tr></table></div></div></div><ul><li>这些自定义的变量称为'local facts',可以在setup获取时通过filter=ansible_local获取</li></ul><p>3,另一个模块debug,可用于playbook的调试使用,把调试信息打印到控制台上,方便我们查看和定位问题</p><ul><li>debug模块常用的两个参数分别是var和msg,var用于测试变量,msg用于打印输出是否符合预期</li></ul><pre tabindex=0><code># 连接到主机,但是并没有做任何事情,debug引用的是testvar,测试testvar是否能用
---yaml
- hosts: all
  remote_user: root
  vars:
    testvar: value of testvar
  tasks:
  - name: test debug
    debug:
      var: testvar
</code></pre><h2 id=使用变量三><a href=#使用变量三 class=anchor-link><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512" class="icon anchor-icon"><path d="M326.612 185.391c59.747 59.809 58.927 155.698.36 214.59-.11.12-.24.25-.36.37l-67.2 67.2c-59.27 59.27-155.699 59.262-214.96.0-59.27-59.26-59.27-155.7.0-214.96l37.106-37.106c9.84-9.84 26.786-3.3 27.294 10.606.648 17.722 3.826 35.527 9.69 52.721 1.986 5.822.567 12.262-3.783 16.612l-13.087 13.087c-28.026 28.026-28.905 73.66-1.155 101.96 28.024 28.579 74.086 28.749 102.325.51l67.2-67.19c28.191-28.191 28.073-73.757.0-101.83-3.701-3.694-7.429-6.564-10.341-8.569a16.037 16.037.0 01-6.947-12.606c-.396-10.567 3.348-21.456 11.698-29.806l21.054-21.055c5.521-5.521 14.182-6.199 20.584-1.731a152.482 152.482.0 0120.522 17.197zM467.547 44.449c-59.261-59.262-155.69-59.27-214.96.0l-67.2 67.2c-.12.12-.25.25-.36.37-58.566 58.892-59.387 154.781.36 214.59a152.454 152.454.0 0020.521 17.196c6.402 4.468 15.064 3.789 20.584-1.731l21.054-21.055c8.35-8.35 12.094-19.239 11.698-29.806a16.037 16.037.0 00-6.947-12.606c-2.912-2.005-6.64-4.875-10.341-8.569-28.073-28.073-28.191-73.639.0-101.83l67.2-67.19c28.239-28.239 74.3-28.069 102.325.51 27.75 28.3 26.872 73.934-1.155 101.96l-13.087 13.087c-4.35 4.35-5.769 10.79-3.783 16.612 5.864 17.194 9.042 34.999 9.69 52.721.509 13.906 17.454 20.446 27.294 10.606l37.106-37.106c59.271-59.259 59.271-155.699.001-214.959z"/></svg></a><a href=#contents:使用变量三 class=headings>#使用变量(三)</a></h2><p>1,变量注册</p><ul><li>ansible模块在执行之后都会有一些返回值,默认情况下,这些返回值不会显示而已;我们可以把这些返回值写入到某个变量中,我们可以通过引用相应的变量获取到这些返回值,将模块的返回值写入到变量中,这种方式称为'注册变量'; 如下为变量注册的的一个范例</li></ul><div class=highlight><div class=chroma><div class=table-container><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-yaml data-lang=yaml><span class=line><span class=cl><span class=nn>---</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span>- <span class=nt>hosts</span><span class=p>:</span><span class=w> </span><span class=l>all</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>remote_user</span><span class=p>:</span><span class=w> </span><span class=l>root</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>tasks</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span>- <span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>test register</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>shell</span><span class=p>:</span><span class=w> </span><span class=s2>&#34;echo test &gt; /tmp/testfile&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>register</span><span class=p>:</span><span class=w> </span><span class=l>testvar</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span>- <span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>shell module return values</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>debug</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>var</span><span class=p>:</span><span class=w> </span><span class=l>testvar</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=c># 执行完成后,在控制台中看到名为”[shell module return values]”的任务中已经显示了第一个任务的返回值的信息，返回信息:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=l>TASK [shell module return values] ************************************</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>ok</span><span class=p>:</span><span class=w> </span><span class=p>[</span><span class=l>master] =&gt; {    </span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>&#34;testvar&#34;: </span>{<span class=w>          
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nt>&#34;changed&#34;: </span><span class=kc>true</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nt>&#34;cmd&#34;: </span><span class=s2>&#34;echo test &gt; /tmp/testfile&#34;</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nt>&#34;delta&#34;: </span><span class=s2>&#34;0:00:00.010963&#34;</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nt>&#34;end&#34;: </span><span class=s2>&#34;2021-03-30 09:26:47.432571&#34;</span><span class=p>,</span><span class=w>                         
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nt>&#34;failed&#34;: </span><span class=kc>false</span><span class=p>,</span><span class=w>                                            
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nt>&#34;rc&#34;: </span><span class=m>0</span><span class=p>,</span><span class=w>                                                   
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nt>&#34;start&#34;: </span><span class=s2>&#34;2021-03-30 09:26:47.421608&#34;</span><span class=p>,</span><span class=w>                    
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nt>&#34;stderr&#34;: </span><span class=s2>&#34;&#34;</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nt>&#34;stderr_lines&#34;: </span><span class=p>[],</span><span class=w>                                      
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nt>&#34;stdout&#34;: </span><span class=s2>&#34;&#34;</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nt>&#34;stdout_lines&#34;: </span><span class=p>[]</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span>}<span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span>}<span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=c># register的变量testvar其实是一个json格式的返回值,可以通过引用testvar的不同属性获取相应的值</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div></div><p>2,变量的传入方式,ansible支持多种变量传入的方式,包括:交互式传入,命令行传入,文件传入</p><ul><li>交互式传入,需要使用到var_prompt关键字,属于vars的一种,当出现该关键字时,会让你在命令行下输入<ul><li>普通使用,以下输入内容不会在控制台显示(默认情况下private: yes)</li></ul></li></ul><div class=highlight><div class=chroma><div class=table-container><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-yaml data-lang=yaml><span class=line><span class=cl><span class=nn>---</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span>- <span class=nt>hosts</span><span class=p>:</span><span class=w> </span><span class=l>all</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>remote_user</span><span class=p>:</span><span class=w> </span><span class=l>root</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>vars_prompt</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span>- <span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=s1>&#39;your_name&#39;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>prompt</span><span class=p>:</span><span class=w> </span><span class=s2>&#34;What is your name?&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=c># private: no</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span>- <span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=s1>&#39;your_age&#39;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>prompt</span><span class=p>:</span><span class=w> </span><span class=s2>&#34;What is your age?&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=c># private: no</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>tasks</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span>- <span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>output vars</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>debug</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>msg</span><span class=p>:</span><span class=w> </span><span class=l>your name is {{your_name}}, your age is {{your_age}}</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div></div><pre><code>- 普通使用,可以做到提供选项供选择
- 特殊使用,例如增加用户,设定密码
</code></pre><div class=highlight><div class=chroma><div class=table-container><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-yaml data-lang=yaml><span class=line><span class=cl><span class=c># 需要使用到vars_prompt下encrypt,指定加密方式,而且该方式需要passlib库,么有的话需要安装</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nn>---</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span>- <span class=nt>hosts</span><span class=p>:</span><span class=w> </span><span class=l>test70</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>remote_user</span><span class=p>:</span><span class=w> </span><span class=l>root</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>vars_prompt</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span>- <span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=s2>&#34;hash_string&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>prompt</span><span class=p>:</span><span class=w> </span><span class=s2>&#34;Enter something&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>private</span><span class=p>:</span><span class=w> </span><span class=kc>no</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>encrypt</span><span class=p>:</span><span class=w> </span><span class=s2>&#34;sha512_crypt&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>tasks</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>   </span>- <span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>Output the string after hash</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>     </span><span class=nt>debug</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>msg</span><span class=p>:</span><span class=w> </span><span class=s2>&#34;{{hash_string}}&#34;</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div></div><ul><li>命令行传入,直接在ansible-playbook执行时增加-e 'key=value'即可,可有多个,变量赋值有多种方式,还可以是json格式</li><li>文件传入,类似命令行-e "@变量文件绝对路径"</li></ul><h2 id=使用变量四registerset_fact><a href=#使用变量四registerset_fact class=anchor-link><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512" class="icon anchor-icon"><path d="M326.612 185.391c59.747 59.809 58.927 155.698.36 214.59-.11.12-.24.25-.36.37l-67.2 67.2c-59.27 59.27-155.699 59.262-214.96.0-59.27-59.26-59.27-155.7.0-214.96l37.106-37.106c9.84-9.84 26.786-3.3 27.294 10.606.648 17.722 3.826 35.527 9.69 52.721 1.986 5.822.567 12.262-3.783 16.612l-13.087 13.087c-28.026 28.026-28.905 73.66-1.155 101.96 28.024 28.579 74.086 28.749 102.325.51l67.2-67.19c28.191-28.191 28.073-73.757.0-101.83-3.701-3.694-7.429-6.564-10.341-8.569a16.037 16.037.0 01-6.947-12.606c-.396-10.567 3.348-21.456 11.698-29.806l21.054-21.055c5.521-5.521 14.182-6.199 20.584-1.731a152.482 152.482.0 0120.522 17.197zM467.547 44.449c-59.261-59.262-155.69-59.27-214.96.0l-67.2 67.2c-.12.12-.25.25-.36.37-58.566 58.892-59.387 154.781.36 214.59a152.454 152.454.0 0020.521 17.196c6.402 4.468 15.064 3.789 20.584-1.731l21.054-21.055c8.35-8.35 12.094-19.239 11.698-29.806a16.037 16.037.0 00-6.947-12.606c-2.912-2.005-6.64-4.875-10.341-8.569-28.073-28.073-28.191-73.639.0-101.83l67.2-67.19c28.239-28.239 74.3-28.069 102.325.51 27.75 28.3 26.872 73.934-1.155 101.96l-13.087 13.087c-4.35 4.35-5.769 10.79-3.783 16.612 5.864 17.194 9.042 34.999 9.69 52.721.509 13.906 17.454 20.446 27.294 10.606l37.106-37.106c59.271-59.259 59.271-155.699.001-214.959z"/></svg></a><a href=#contents:使用变量四registerset_fact class=headings>#使用变量(四),register,set_fact</a></h2><p>1,配置主机清单时,可以配置主机或主机组变量,但只对配置的主机或主机组生效</p><div class=highlight><div class=chroma><div class=table-container><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span><span class=lnt>32
</span><span class=lnt>33
</span><span class=lnt>34
</span><span class=lnt>35
</span><span class=lnt>36
</span><span class=lnt>37
</span><span class=lnt>38
</span><span class=lnt>39
</span><span class=lnt>40
</span><span class=lnt>41
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-yaml data-lang=yaml><span class=line><span class=cl><span class=c>## 主机配置,配置/etc/ansible/hosts如下</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=c># method one</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=l>node2 ansible_host=192.168.110.22 testhostvar=node2_host_var</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=c># method two</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>all</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>hosts</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>node2</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>ansible_host</span><span class=p>:</span><span class=w> </span><span class=m>192.168.110.22</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>ansible_port</span><span class=p>:</span><span class=w> </span><span class=m>22</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>testhostvar</span><span class=p>:</span><span class=w> </span><span class=l>node2_host_var</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>testhostvar2</span><span class=p>:</span><span class=w> </span><span class=l>node2_host_var2</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>testhostvar3</span><span class=p>:</span><span class=w> 
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nt>thv31</span><span class=p>:</span><span class=w> </span><span class=m>3.1</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nt>thv32</span><span class=p>:</span><span class=w> </span><span class=m>3.2</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=l>$ ansible node2 -m shell -a &#39;echo {{testhostvar}}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=l>$ ansible node2 -m shell -a &#39;echo {{testhostvar3.thv31}}&#39; or &#39;{{testhostvar3[&#39;thv32&#39;]}}&#39;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=c>## 主机组配置,配置/etc/ansible/hosts如下</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=c># method one</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>[</span><span class=l>testB]</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=l>node2 ansible_host=192.168.110.22</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=l>node3 anisble_host=192.168.110.33</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w> 
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>[</span><span class=l>testB:vars]</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=l>test_group_var1=&#39;group var test&#39;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=l>test_group_var2=&#39;group var test2&#39;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=c># method two</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>all</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w> </span><span class=nt>children</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>   </span><span class=nt>testB</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>     </span><span class=nt>hosts</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>       </span><span class=nt>node2</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>         </span><span class=nt>ansible_host</span><span class=p>:</span><span class=w> </span><span class=m>192.168.110.22</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>         </span><span class=nt>ansible_port</span><span class=p>:</span><span class=w> </span><span class=m>22</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>       </span><span class=nt>node3</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>         </span><span class=nt>ansible_host</span><span class=p>:</span><span class=w> </span><span class=m>192.168.110.33</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>         </span><span class=nt>ansible_port</span><span class=p>:</span><span class=w> </span><span class=m>22</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>     </span><span class=nt>vars</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>       </span><span class=nt>test_group_var1</span><span class=p>:</span><span class=w> </span><span class=s1>&#39;group var test1&#39;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>       </span><span class=nt>test_group_var2</span><span class=p>:</span><span class=w> </span><span class=s1>&#39;group var test2&#39;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=l>$ ansible testB -m shell -a &#39;echo {{test_group_var1}}&#39;</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div></div><p>2,通过set_fact定义变量,set_fact是一个模块,可以通过set_fact模块在task中定义变量</p><ul><li>普通使用,直接与task同级定义一个变量</li></ul><div class=highlight><div class=chroma><div class=table-container><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span><span class=lnt>7
</span><span class=lnt>8
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-yaml data-lang=yaml><span class=line><span class=cl><span class=nn>---</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span>- <span class=nt>hosts</span><span class=p>:</span><span class=w> </span><span class=l>node2</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>remote_user</span><span class=p>:</span><span class=w> </span><span class=l>root</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>tasks</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span>- <span class=nt>set_fact</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>testvar</span><span class=p>:</span><span class=w> </span><span class=s2>&#34;testtest&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span>- <span class=nt>debug</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>msg</span><span class=p>:</span><span class=w> </span><span class=s2>&#34;{{testvar}}&#34;</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div></div><ul><li>普通使用,将一个变量的值赋给另一个变量</li></ul><div class=highlight><div class=chroma><div class=table-container><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-yaml data-lang=yaml><span class=line><span class=cl><span class=nn>---</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span>- <span class=nt>hosts</span><span class=p>:</span><span class=w> </span><span class=l>node2</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>remote_user</span><span class=p>:</span><span class=w> </span><span class=l>root</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>vars</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>testvar1</span><span class=p>:</span><span class=w> </span><span class=l>test1_string</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>tasks</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span>- <span class=nt>shell</span><span class=p>:</span><span class=w> </span><span class=s2>&#34;echo test2_string&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>register</span><span class=p>:</span><span class=w> </span><span class=l>shellreturn</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span>- <span class=nt>set_fact</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>testsf1</span><span class=p>:</span><span class=w> </span><span class=s2>&#34;{{testvar1}}&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>testsf2</span><span class=p>:</span><span class=w> </span><span class=s2>&#34;{{shellreturn.stdout}}&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span>- <span class=nt>debug</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>msg</span><span class=p>:</span><span class=w> </span><span class=s2>&#34;{{testsf1}} {{testsf2}}&#34;</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div></div><ul><li>通过set_fact模块创建的变量还有一个特殊性，通过set_fact创建的变量就像主机上的facts信息一样，可以在之后的play中被引用</li></ul><div class=highlight><div class=chroma><div class=table-container><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-yaml data-lang=yaml><span class=line><span class=cl><span class=nn>---</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span>- <span class=nt>hosts</span><span class=p>:</span><span class=w> </span><span class=l>node2</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>remote_user</span><span class=p>:</span><span class=w> </span><span class=l>root</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>vars</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>testvar1</span><span class=p>:</span><span class=w> </span><span class=l>tv1</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>tasks</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span>- <span class=nt>set_fact</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>testvar2</span><span class=p>:</span><span class=w> </span><span class=l>tv2</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span>- <span class=nt>debug</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>msg</span><span class=p>:</span><span class=w> </span><span class=s2>&#34;{{testvar1}} ----- {{testvar2}}&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w> 
</span></span></span><span class=line><span class=cl><span class=w></span>- <span class=nt>hosts</span><span class=p>:</span><span class=w> </span><span class=l>node2</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>remote_user</span><span class=p>:</span><span class=w> </span><span class=l>root</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>tasks</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span>- <span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>other play get testvar2</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>debug</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>msg</span><span class=p>:</span><span class=w> </span><span class=s2>&#34;{{testvar2}}&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span>- <span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>other play get testvar1</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>debug</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>msg</span><span class=p>:</span><span class=w> </span><span class=s2>&#34;{{testvar1}}&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=c># 这两个变量在第一个play中都可以正常的输出.但是在第二个play中，testvar2可以被正常输出了，testvar1却不能被正常输出，会出现未定义testvar1的错误</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div></div><ul><li>如果想要在tasks中给变量自定义信息，并且在之后的play操作同一个主机时能够使用到之前在tasks中定义的变量时，则可以使用set_facts定义对应的变量</li></ul><h2 id=使用变量五内置变量host_vars><a href=#使用变量五内置变量host_vars class=anchor-link><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512" class="icon anchor-icon"><path d="M326.612 185.391c59.747 59.809 58.927 155.698.36 214.59-.11.12-.24.25-.36.37l-67.2 67.2c-59.27 59.27-155.699 59.262-214.96.0-59.27-59.26-59.27-155.7.0-214.96l37.106-37.106c9.84-9.84 26.786-3.3 27.294 10.606.648 17.722 3.826 35.527 9.69 52.721 1.986 5.822.567 12.262-3.783 16.612l-13.087 13.087c-28.026 28.026-28.905 73.66-1.155 101.96 28.024 28.579 74.086 28.749 102.325.51l67.2-67.19c28.191-28.191 28.073-73.757.0-101.83-3.701-3.694-7.429-6.564-10.341-8.569a16.037 16.037.0 01-6.947-12.606c-.396-10.567 3.348-21.456 11.698-29.806l21.054-21.055c5.521-5.521 14.182-6.199 20.584-1.731a152.482 152.482.0 0120.522 17.197zM467.547 44.449c-59.261-59.262-155.69-59.27-214.96.0l-67.2 67.2c-.12.12-.25.25-.36.37-58.566 58.892-59.387 154.781.36 214.59a152.454 152.454.0 0020.521 17.196c6.402 4.468 15.064 3.789 20.584-1.731l21.054-21.055c8.35-8.35 12.094-19.239 11.698-29.806a16.037 16.037.0 00-6.947-12.606c-2.912-2.005-6.64-4.875-10.341-8.569-28.073-28.073-28.191-73.639.0-101.83l67.2-67.19c28.239-28.239 74.3-28.069 102.325.51 27.75 28.3 26.872 73.934-1.155 101.96l-13.087 13.087c-4.35 4.35-5.769 10.79-3.783 16.612 5.864 17.194 9.042 34.999 9.69 52.721.509 13.906 17.454 20.446 27.294 10.606l37.106-37.106c59.271-59.259 59.271-155.699.001-214.959z"/></svg></a><a href=#contents:使用变量五内置变量host_vars class=headings>#使用变量(五),内置变量,host_vars</a></h2><p>1,ansible有一些内置变量可供使用,这些变量被ansible保留,我们定义变量时不能使用</p><ul><li>ansible_version</li></ul><div class=highlight><div class=chroma><div class=table-container><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>$ ansible node2 -m debug -a <span class=s1>&#39;msg={{ansible_version}}&#39;</span>
</span></span></code></pre></td></tr></table></div></div></div><p>2,hostvars可以在我们操作当前主机时获取到其他主机中的信息</p><ul><li>如下示例</li></ul><div class=highlight><div class=chroma><div class=table-container><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-yaml data-lang=yaml><span class=line><span class=cl><span class=nn>---</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=c># 第一个什么也没做,只是获取node3的facts内容,这一步是需要的,只有收集过的facts才能被后面的play使用</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=c># 如果没有收到对应主机的facts信息,即使使用hostvars内置变量,也无法获取到对应主机的facts内容</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span>- <span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=s2>&#34;play 1: gather facts of node3&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>hosts</span><span class=p>:</span><span class=w> </span><span class=l>node3</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>remote_user</span><span class=p>:</span><span class=w> </span><span class=l>root</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=c># 下面的gather_facts默认是yes</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=c># gater_facts: yes</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span>- <span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=s2>&#34;play 2: gathter facts of node3 when operating on node2&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>hosts</span><span class=p>:</span><span class=w> </span><span class=l>node2</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>remote_user</span><span class=p>:</span><span class=w> </span><span class=l>root</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>tasks</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span>- <span class=nt>debug</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>msg</span><span class=p>:</span><span class=w> </span><span class=s2>&#34;{{hostvars[&#39;node3&#39;].ansible_enp0s3.ipv4}}&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=c># 下面两种也可以</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=c>#msg: &#34;{{hostvars.node3.ansible_enp0s3.ipv4}}&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=c>#msg: &#34;{{hostvars[&#39;node3&#39;][&#39;ansible_enp0s3&#39;][&#39;ipv4&#39;]}}&#34;</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div></div><ul><li>hostvars除了获取到其他主机的facts内容,还可以获取到其他类型的一些变量信息,如其他主机的注册变量,主机变量,组变量等;如下示例</li></ul><div class=highlight><div class=chroma><div class=table-container><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-yaml data-lang=yaml><span class=line><span class=cl><span class=nn>---</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=c># 1,通过hostvars内置变量可以直接获取到其他主机中的注册变量</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=c># 2,注册变量并不用像facts信息那样需要事先收集，即可直接通过hostvars跨主机被引用到</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=c># 3,如果你在清单中为node3主机配置了主机变量，或者为node3主机所在的组配置了组变量，也是可以通过hostvars直接跨主机引用</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span>- <span class=nt>hosts</span><span class=p>:</span><span class=w> </span><span class=l>node3</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>remote_user</span><span class=p>:</span><span class=w> </span><span class=l>root</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>gather_facts</span><span class=p>:</span><span class=w> </span><span class=kc>no</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>tasks</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span>- <span class=nt>shell</span><span class=p>:</span><span class=w> </span><span class=s2>&#34;echo register_var_in_play1&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>register</span><span class=p>:</span><span class=w> </span><span class=l>shellreturn</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w> 
</span></span></span><span class=line><span class=cl><span class=w></span>- <span class=nt>hosts</span><span class=p>:</span><span class=w> </span><span class=l>node2</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>remote_user</span><span class=p>:</span><span class=w> </span><span class=l>root</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>gather_facts</span><span class=p>:</span><span class=w> </span><span class=kc>no</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>tasks</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span>- <span class=nt>debug</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>msg</span><span class=p>:</span><span class=w> </span><span class=s2>&#34;{{hostvars.node3.shellreturn.stdout}}&#34;</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div></div><ul><li>通过vars关键字定义的变量使用上例中的hostvars方法是无法被跨主机引用</li></ul><div class=highlight><div class=chroma><div class=table-container><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span><span class=lnt>32
</span><span class=lnt>33
</span><span class=lnt>34
</span><span class=lnt>35
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-yaml data-lang=yaml><span class=line><span class=cl><span class=c># 下列内容会报错,变量需要注册才行,直接使用vars定义的变量无法传递</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nn>---</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span>- <span class=nt>hosts</span><span class=p>:</span><span class=w> </span><span class=l>node3</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>remote_user</span><span class=p>:</span><span class=w> </span><span class=l>root</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>gather_facts</span><span class=p>:</span><span class=w> </span><span class=kc>no</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>vars</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>testvar</span><span class=p>:</span><span class=w> </span><span class=l>testvar_in_3</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>tasks</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span>- <span class=nt>debug</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>msg</span><span class=p>:</span><span class=w> </span><span class=s2>&#34;{{testvar}}&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w> 
</span></span></span><span class=line><span class=cl><span class=w></span>- <span class=nt>hosts</span><span class=p>:</span><span class=w> </span><span class=l>node2</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>remote_user</span><span class=p>:</span><span class=w> </span><span class=l>root</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>gather_facts</span><span class=p>:</span><span class=w> </span><span class=kc>no</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>tasks</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span>- <span class=nt>debug</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>msg</span><span class=p>:</span><span class=w> </span><span class=s2>&#34;{{hostvars.node3.testvar}}&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=c># 通过set_fact将vars定义的内容注册,则可以</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nn>---</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span>- <span class=nt>hosts</span><span class=p>:</span><span class=w> </span><span class=l>node3</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>remote_user</span><span class=p>:</span><span class=w> </span><span class=l>root</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>gather_facts</span><span class=p>:</span><span class=w> </span><span class=kc>no</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>tasks</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span>- <span class=nt>set_fact</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>testvar</span><span class=p>:</span><span class=w> </span><span class=l>testvar_in_3</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span>- <span class=nt>debug</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>msg</span><span class=p>:</span><span class=w> </span><span class=s2>&#34;{{testvar}}&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w> 
</span></span></span><span class=line><span class=cl><span class=w></span>- <span class=nt>hosts</span><span class=p>:</span><span class=w> </span><span class=l>node2</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>remote_user</span><span class=p>:</span><span class=w> </span><span class=l>root</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>gather_facts</span><span class=p>:</span><span class=w> </span><span class=kc>no</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>tasks</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span>- <span class=nt>debug</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>msg</span><span class=p>:</span><span class=w> </span><span class=s2>&#34;{{hostvars.node3.testvar}}&#34;</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div></div><ul><li>通过”set_fact”结合”hostvars”的方式，可以实现跨play获取其他主机中的变量信息</li></ul><p>3,内置变量inventory_hostname,获取到被操作的当前主机的主机名称</p><ul><li>主机名称并不是linux系统的主机名，而是对应主机在清单中配置的名称,清单中配置的名称即是</li></ul><p>4,内置变量inventory_hostname_short,获取到被操作的当前主机的主机名称,简版</p><ul><li>无论是IP还是别名，如果清单的主机名称中包含”.”，inventory_hostname_short都会取得主机名中第一个”.”之前的字符作为主机的简短名称</li></ul><p>5,内置变量play_hosts,获取到当前play所操作的所有主机的主机名列表</p><ul><li>如下示例</li></ul><div class=highlight><div class=chroma><div class=table-container><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-yaml data-lang=yaml><span class=line><span class=cl><span class=nn>---</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span>- <span class=nt>hosts</span><span class=p>:</span><span class=w> </span><span class=l>node2,node3</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>remote_user</span><span class=p>:</span><span class=w> </span><span class=l>root</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>gather_facts</span><span class=p>:</span><span class=w> </span><span class=kc>no</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>tasks</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span>- <span class=nt>debug</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>msg</span><span class=p>:</span><span class=w> </span><span class=s2>&#34;{{play_hosts}}&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=c># 输出如下:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=l>TASK [debug] xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>ok</span><span class=p>:</span><span class=w> </span><span class=p>[</span><span class=l>node2] =&gt; {</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>&#34;msg&#34;: </span><span class=p>[</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=s2>&#34;node2&#34;</span><span class=p>,</span><span class=w> 
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=s2>&#34;node3&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>]</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span>}<span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>ok</span><span class=p>:</span><span class=w> </span><span class=p>[</span><span class=l>node3] =&gt; {</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>&#34;msg&#34;: </span><span class=p>[</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=s2>&#34;node2&#34;</span><span class=p>,</span><span class=w> 
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=s2>&#34;node3&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>]</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span>}<span class=w>
</span></span></span></code></pre></td></tr></table></div></div></div><p>6,内置变量groups,可以获取到清单中”所有分组”的”分组信息”</p><ul><li>同inventory_hostname,但能获取到分组的信息</li></ul><div class=highlight><div class=chroma><div class=table-container><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>$ ansible all -m debug -a <span class=s1>&#39;msg={{groups}}&#39;</span>
</span></span><span class=line><span class=cl>$ ansible all -m debug -a <span class=s1>&#39;msg={{groups.k8s}}&#39;</span>
</span></span></code></pre></td></tr></table></div></div></div><p>7,内置变量group_names,获取到当前主机所在分组的组名</p><ul><li>如下示例:</li></ul><div class=highlight><div class=chroma><div class=table-container><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span><span class=lnt>7
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl><span class=c1># ansible node2 -m debug -a &#34;msg={{group_names}}&#34;</span>
</span></span><span class=line><span class=cl>node2 <span class=p>|</span> <span class=nv>SUCCESS</span> <span class=o>=</span>&gt; <span class=o>{</span>
</span></span><span class=line><span class=cl>    <span class=s2>&#34;changed&#34;</span>: false, 
</span></span><span class=line><span class=cl>    <span class=s2>&#34;msg&#34;</span>: <span class=o>[</span>
</span></span><span class=line><span class=cl>        <span class=s2>&#34;k8s&#34;</span>
</span></span><span class=line><span class=cl>    <span class=o>]</span>
</span></span><span class=line><span class=cl><span class=o>}</span>
</span></span></code></pre></td></tr></table></div></div></div><p>8,内置变量inventory_dir,获取到ansible主机中清单文件的存放路径,默认是/etc/ansible,但也可以自定义</p><ul><li>如下示例:</li></ul><div class=highlight><div class=chroma><div class=table-container><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl><span class=c1># ansible node2 -m debug -a &#34;msg={{inventory_dir}}&#34;</span>
</span></span><span class=line><span class=cl>node2 <span class=p>|</span> <span class=nv>SUCCESS</span> <span class=o>=</span>&gt; <span class=o>{</span>
</span></span><span class=line><span class=cl>    <span class=s2>&#34;changed&#34;</span>: false, 
</span></span><span class=line><span class=cl>    <span class=s2>&#34;msg&#34;</span>: <span class=s2>&#34;/etc/ansible&#34;</span>
</span></span><span class=line><span class=cl><span class=o>}</span>
</span></span></code></pre></td></tr></table></div></div></div><p>9,除了直接在hosts文件中定义主机变量和组变量，还有另外一种方法也可以定义主机变量和组变量，我们可以在清单文件的同级目录中创建两个目录，这两个目录的名字分别为”group_vars”和”host_vars”，我们可以将组变量文件放在”group_vars”目录中，将主机变量文件放在”host_vars”目录中，这样ansible就能获取到对应组变量和主机变量</p><h2 id=使用循环一with_items的使用><a href=#使用循环一with_items的使用 class=anchor-link><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512" class="icon anchor-icon"><path d="M326.612 185.391c59.747 59.809 58.927 155.698.36 214.59-.11.12-.24.25-.36.37l-67.2 67.2c-59.27 59.27-155.699 59.262-214.96.0-59.27-59.26-59.27-155.7.0-214.96l37.106-37.106c9.84-9.84 26.786-3.3 27.294 10.606.648 17.722 3.826 35.527 9.69 52.721 1.986 5.822.567 12.262-3.783 16.612l-13.087 13.087c-28.026 28.026-28.905 73.66-1.155 101.96 28.024 28.579 74.086 28.749 102.325.51l67.2-67.19c28.191-28.191 28.073-73.757.0-101.83-3.701-3.694-7.429-6.564-10.341-8.569a16.037 16.037.0 01-6.947-12.606c-.396-10.567 3.348-21.456 11.698-29.806l21.054-21.055c5.521-5.521 14.182-6.199 20.584-1.731a152.482 152.482.0 0120.522 17.197zM467.547 44.449c-59.261-59.262-155.69-59.27-214.96.0l-67.2 67.2c-.12.12-.25.25-.36.37-58.566 58.892-59.387 154.781.36 214.59a152.454 152.454.0 0020.521 17.196c6.402 4.468 15.064 3.789 20.584-1.731l21.054-21.055c8.35-8.35 12.094-19.239 11.698-29.806a16.037 16.037.0 00-6.947-12.606c-2.912-2.005-6.64-4.875-10.341-8.569-28.073-28.073-28.191-73.639.0-101.83l67.2-67.19c28.239-28.239 74.3-28.069 102.325.51 27.75 28.3 26.872 73.934-1.155 101.96l-13.087 13.087c-4.35 4.35-5.769 10.79-3.783 16.612 5.864 17.194 9.042 34.999 9.69 52.721.509 13.906 17.454 20.446 27.294 10.606l37.106-37.106c59.271-59.259 59.271-155.699.001-214.959z"/></svg></a><a href=#contents:使用循环一with_items的使用 class=headings>#使用循环(一),with_items的使用</a></h2><p>1,使用with_items处理循环的内容</p><ul><li>普通示例:</li></ul><div class=highlight><div class=chroma><div class=table-container><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-yaml data-lang=yaml><span class=line><span class=cl><span class=c># &#34;with_items&#34;关键字会把返回的列表信息自动处理，将每一条信息单独放在一个名为&#34;item&#34;的变量中，只要获取到名为&#34;item&#34;变量的变量值，即可循环的获取到列表中的每一条信息</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=c># 下列debug被循环3次,每次单独输出相应循环的debug输出内容</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nn>---</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span>- <span class=nt>hosts</span><span class=p>:</span><span class=w> </span><span class=l>node2</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>remote_user</span><span class=p>:</span><span class=w> </span><span class=l>root</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>gather_facts</span><span class=p>:</span><span class=w> </span><span class=kc>no</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>tasks</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span>- <span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>test with_items</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>debug</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>msg</span><span class=p>:</span><span class=w> </span><span class=s2>&#34;{{item}}&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>with_items</span><span class=p>:</span><span class=w> </span><span class=s2>&#34;{{groups.k8s}}&#34;</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div></div><p>2,with_items可以自定义</p><ul><li>列表</li></ul><div class=highlight><div class=chroma><div class=table-container><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span><span class=lnt>7
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-yaml data-lang=yaml><span class=line><span class=cl><span class=c># method one</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>with_items</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span>- <span class=m>1</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span>- <span class=m>2</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span>- <span class=m>3</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=c># method two</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>with_items</span><span class=p>:</span><span class=w> </span><span class=p>[</span><span class=m>1</span><span class=p>,</span><span class=w> </span><span class=m>2</span><span class=p>,</span><span class=w> </span><span class=m>3</span><span class=p>]</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div></div><ul><li>相对复杂的列表</li></ul><div class=highlight><div class=chroma><div class=table-container><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-yaml data-lang=yaml><span class=line><span class=cl><span class=nn>---</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span>- <span class=nt>hosts</span><span class=p>:</span><span class=w> </span><span class=l>node2</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>remote_user</span><span class=p>:</span><span class=w> </span><span class=l>root</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>gather_facts</span><span class=p>:</span><span class=w> </span><span class=kc>no</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>tasks</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span>- <span class=nt>debug</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>msg</span><span class=p>:</span><span class=w> </span><span class=s2>&#34;{{item.test1}}&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>with_items</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span>- {<span class=w> </span><span class=nt>test1: a, test2</span><span class=p>:</span><span class=w> </span><span class=l>b}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span>- {<span class=w> </span><span class=nt>test1: c, test2</span><span class=p>:</span><span class=w> </span><span class=l>d}</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div></div><p>3,result的使用</p><ul><li>当使用了循环以后，每次shell模块执行的返回值放入名为”results”的序列中，”results”也是一个返回值，当模块中使用循环时，模块每次执行的返回值都会追加存放到”results”这个返回值中,如下示例:</li></ul><div class=highlight><div class=chroma><div class=table-container><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-yaml data-lang=yaml><span class=line><span class=cl><span class=c># 两次debug循环,输出的内容都保存在results序列中,属于results</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nn>---</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span>- <span class=nt>hosts</span><span class=p>:</span><span class=w> </span><span class=l>node2</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>gather_facts</span><span class=p>:</span><span class=w> </span><span class=kc>no</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>tasks</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span>- <span class=nt>shell</span><span class=p>:</span><span class=w> </span><span class=s2>&#34;{{item}}&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>with_items</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span>- <span class=s2>&#34;ls /opt&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span>- <span class=s2>&#34;ls /home&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>register</span><span class=p>:</span><span class=w> </span><span class=l>returnvalue</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span>- <span class=nt>debug</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>var</span><span class=p>:</span><span class=w> </span><span class=l>returnvalue</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=c># 可以使用如下方式,避免所有结果在最后的results中去获取</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nn>---</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span>- <span class=nt>hosts</span><span class=p>:</span><span class=w> </span><span class=l>node2</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>gather_facts</span><span class=p>:</span><span class=w> </span><span class=kc>no</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>tasks</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span>- <span class=nt>shell</span><span class=p>:</span><span class=w> </span><span class=s2>&#34;{{item}}&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>with_items</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span>- <span class=s2>&#34;ls /opt&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span>- <span class=s2>&#34;ls /home&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>register</span><span class=p>:</span><span class=w> </span><span class=l>returnvalue</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span>- <span class=nt>debug</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>msg</span><span class=p>:</span><span class=w> </span><span class=s2>&#34;{{item.stdout}}&#39;
</span></span></span><span class=line><span class=cl><span class=s2>    with_items: &#34;</span>{{<span class=l>returnvalue.results}}&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=c># 先使用循环重复的调用了shell模块，然后将shell模块每次执行后的返回值注册到了变量”returnvalue”中，之后，在使用debug模块时，通过返回值”results”获取到了之前每次执行shell模块的返回值（shell每次执行后的返回值已经被放入到item变量中），最后又通过返回值”stdout”获取到了每次shell模块执行后的标准输出</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div></div><h2 id=使用循环二对列表循环的操作><a href=#使用循环二对列表循环的操作 class=anchor-link><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512" class="icon anchor-icon"><path d="M326.612 185.391c59.747 59.809 58.927 155.698.36 214.59-.11.12-.24.25-.36.37l-67.2 67.2c-59.27 59.27-155.699 59.262-214.96.0-59.27-59.26-59.27-155.7.0-214.96l37.106-37.106c9.84-9.84 26.786-3.3 27.294 10.606.648 17.722 3.826 35.527 9.69 52.721 1.986 5.822.567 12.262-3.783 16.612l-13.087 13.087c-28.026 28.026-28.905 73.66-1.155 101.96 28.024 28.579 74.086 28.749 102.325.51l67.2-67.19c28.191-28.191 28.073-73.757.0-101.83-3.701-3.694-7.429-6.564-10.341-8.569a16.037 16.037.0 01-6.947-12.606c-.396-10.567 3.348-21.456 11.698-29.806l21.054-21.055c5.521-5.521 14.182-6.199 20.584-1.731a152.482 152.482.0 0120.522 17.197zM467.547 44.449c-59.261-59.262-155.69-59.27-214.96.0l-67.2 67.2c-.12.12-.25.25-.36.37-58.566 58.892-59.387 154.781.36 214.59a152.454 152.454.0 0020.521 17.196c6.402 4.468 15.064 3.789 20.584-1.731l21.054-21.055c8.35-8.35 12.094-19.239 11.698-29.806a16.037 16.037.0 00-6.947-12.606c-2.912-2.005-6.64-4.875-10.341-8.569-28.073-28.073-28.191-73.639.0-101.83l67.2-67.19c28.239-28.239 74.3-28.069 102.325.51 27.75 28.3 26.872 73.934-1.155 101.96l-13.087 13.087c-4.35 4.35-5.769 10.79-3.783 16.612 5.864 17.194 9.042 34.999 9.69 52.721.509 13.906 17.454 20.446 27.294 10.606l37.106-37.106c59.271-59.259 59.271-155.699.001-214.959z"/></svg></a><a href=#contents:使用循环二对列表循环的操作 class=headings>#使用循环(二),对列表循环的操作</a></h2><p>1,对序列循环有几个关键字</p><ul><li>with_items: 当循环的序列元素也是列表时,展开与预期的有差异,会将所有的列表展开</li><li>with_list: 其他动作与with_items相同,只有在嵌套列表循环时有差异,子列表将会作为元素使用</li><li>with_flattened: 与with_items相同</li><li>with_together: 列对齐,”对齐合并”功能</li></ul><div class=highlight><div class=chroma><div class=table-container><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span><span class=lnt>32
</span><span class=lnt>33
</span><span class=lnt>34
</span><span class=lnt>35
</span><span class=lnt>36
</span><span class=lnt>37
</span><span class=lnt>38
</span><span class=lnt>39
</span><span class=lnt>40
</span><span class=lnt>41
</span><span class=lnt>42
</span><span class=lnt>43
</span><span class=lnt>44
</span><span class=lnt>45
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-yaml data-lang=yaml><span class=line><span class=cl><span class=nn>---</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span>- <span class=nt>hosts</span><span class=p>:</span><span class=w> </span><span class=l>node2</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>remote_user</span><span class=p>:</span><span class=w> </span><span class=l>root</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>gather_facts</span><span class=p>:</span><span class=w> </span><span class=kc>no</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>tasks</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span>- <span class=nt>debug</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>msg</span><span class=p>:</span><span class=w> </span><span class=s2>&#34;{{ item }}&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>with_together</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span>- <span class=p>[</span><span class=w> </span><span class=m>1</span><span class=p>,</span><span class=w> </span><span class=m>2</span><span class=p>,</span><span class=w> </span><span class=m>3</span><span class=w> </span><span class=p>]</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span>- <span class=p>[</span><span class=w> </span><span class=l>a, b, c ]</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=c># 输出如下:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=l>TASK [debug] xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>ok</span><span class=p>:</span><span class=w> </span><span class=p>[</span><span class=l>node2] =&gt; (item=[1, u&#39;a&#39;]) =&gt; {</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>&#34;changed&#34;: </span><span class=kc>false</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>&#34;item&#34;: </span><span class=p>[</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=m>1</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=s2>&#34;a&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>],</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>&#34;msg&#34;: </span><span class=p>[</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=m>1</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=s2>&#34;a&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>]</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span>}<span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>ok</span><span class=p>:</span><span class=w> </span><span class=p>[</span><span class=l>node2] =&gt; (item=[2, u&#39;b&#39;]) =&gt; {</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>&#34;changed&#34;: </span><span class=kc>false</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>&#34;item&#34;: </span><span class=p>[</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=m>2</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=s2>&#34;b&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>],</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>&#34;msg&#34;: </span><span class=p>[</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=m>2</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=s2>&#34;b&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>]</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span>}<span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>ok</span><span class=p>:</span><span class=w> </span><span class=p>[</span><span class=l>node2] =&gt; (item=[3, u&#39;c&#39;]) =&gt; {</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>&#34;changed&#34;: </span><span class=kc>false</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>&#34;item&#34;: </span><span class=p>[</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=m>3</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=s2>&#34;c&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>],</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>&#34;msg&#34;: </span><span class=p>[</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=m>3</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=s2>&#34;c&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>]</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span>}<span class=w>
</span></span></span></code></pre></td></tr></table></div></div></div><h2 id=使用循环三嵌套循环><a href=#使用循环三嵌套循环 class=anchor-link><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512" class="icon anchor-icon"><path d="M326.612 185.391c59.747 59.809 58.927 155.698.36 214.59-.11.12-.24.25-.36.37l-67.2 67.2c-59.27 59.27-155.699 59.262-214.96.0-59.27-59.26-59.27-155.7.0-214.96l37.106-37.106c9.84-9.84 26.786-3.3 27.294 10.606.648 17.722 3.826 35.527 9.69 52.721 1.986 5.822.567 12.262-3.783 16.612l-13.087 13.087c-28.026 28.026-28.905 73.66-1.155 101.96 28.024 28.579 74.086 28.749 102.325.51l67.2-67.19c28.191-28.191 28.073-73.757.0-101.83-3.701-3.694-7.429-6.564-10.341-8.569a16.037 16.037.0 01-6.947-12.606c-.396-10.567 3.348-21.456 11.698-29.806l21.054-21.055c5.521-5.521 14.182-6.199 20.584-1.731a152.482 152.482.0 0120.522 17.197zM467.547 44.449c-59.261-59.262-155.69-59.27-214.96.0l-67.2 67.2c-.12.12-.25.25-.36.37-58.566 58.892-59.387 154.781.36 214.59a152.454 152.454.0 0020.521 17.196c6.402 4.468 15.064 3.789 20.584-1.731l21.054-21.055c8.35-8.35 12.094-19.239 11.698-29.806a16.037 16.037.0 00-6.947-12.606c-2.912-2.005-6.64-4.875-10.341-8.569-28.073-28.073-28.191-73.639.0-101.83l67.2-67.19c28.239-28.239 74.3-28.069 102.325.51 27.75 28.3 26.872 73.934-1.155 101.96l-13.087 13.087c-4.35 4.35-5.769 10.79-3.783 16.612 5.864 17.194 9.042 34.999 9.69 52.721.509 13.906 17.454 20.446 27.294 10.606l37.106-37.106c59.271-59.259 59.271-155.699.001-214.959z"/></svg></a><a href=#contents:使用循环三嵌套循环 class=headings>#使用循环(三),嵌套循环</a></h2><p>1,with_cartesian和with_nested</p><ul><li>当我们需要两个列表嵌套循环时,可以使用with_cartesian或者with_nested,将每个小列表中的元素按照”笛卡尔的方式”组合后，循环的处理每个组合,如下示例</li></ul><div class=highlight><div class=chroma><div class=table-container><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-yaml data-lang=yaml><span class=line><span class=cl><span class=c># 下面的例子会在node2下创建6个目录</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nn>---</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span>- <span class=nt>hosts</span><span class=p>:</span><span class=w> </span><span class=l>node2</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>remote_user</span><span class=p>:</span><span class=w> </span><span class=l>root</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>gather_facts</span><span class=p>:</span><span class=w> </span><span class=kc>no</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>tasks</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span>- <span class=nt>file</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>state</span><span class=p>:</span><span class=w> </span><span class=l>directory</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>path</span><span class=p>:</span><span class=w> </span><span class=s2>&#34;/testdir/testdir/{{ item.0 }}/{{ item.1 }}&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>with_cartesian</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span>- <span class=p>[</span><span class=w> </span><span class=l>a, b, c ]</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span>- <span class=p>[</span><span class=w> </span><span class=l>test1, test2 ]</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div></div><h2 id=使用循环四序列索引循环><a href=#使用循环四序列索引循环 class=anchor-link><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512" class="icon anchor-icon"><path d="M326.612 185.391c59.747 59.809 58.927 155.698.36 214.59-.11.12-.24.25-.36.37l-67.2 67.2c-59.27 59.27-155.699 59.262-214.96.0-59.27-59.26-59.27-155.7.0-214.96l37.106-37.106c9.84-9.84 26.786-3.3 27.294 10.606.648 17.722 3.826 35.527 9.69 52.721 1.986 5.822.567 12.262-3.783 16.612l-13.087 13.087c-28.026 28.026-28.905 73.66-1.155 101.96 28.024 28.579 74.086 28.749 102.325.51l67.2-67.19c28.191-28.191 28.073-73.757.0-101.83-3.701-3.694-7.429-6.564-10.341-8.569a16.037 16.037.0 01-6.947-12.606c-.396-10.567 3.348-21.456 11.698-29.806l21.054-21.055c5.521-5.521 14.182-6.199 20.584-1.731a152.482 152.482.0 0120.522 17.197zM467.547 44.449c-59.261-59.262-155.69-59.27-214.96.0l-67.2 67.2c-.12.12-.25.25-.36.37-58.566 58.892-59.387 154.781.36 214.59a152.454 152.454.0 0020.521 17.196c6.402 4.468 15.064 3.789 20.584-1.731l21.054-21.055c8.35-8.35 12.094-19.239 11.698-29.806a16.037 16.037.0 00-6.947-12.606c-2.912-2.005-6.64-4.875-10.341-8.569-28.073-28.073-28.191-73.639.0-101.83l67.2-67.19c28.239-28.239 74.3-28.069 102.325.51 27.75 28.3 26.872 73.934-1.155 101.96l-13.087 13.087c-4.35 4.35-5.769 10.79-3.783 16.612 5.864 17.194 9.042 34.999 9.69 52.721.509 13.906 17.454 20.446 27.294 10.606l37.106-37.106c59.271-59.259 59.271-155.699.001-214.959z"/></svg></a><a href=#contents:使用循环四序列索引循环 class=headings>#使用循环(四),序列索引循环</a></h2><p>1,使用到with_indexed_items,在处理列表中的每一项时，按照顺序为每一项添加了编号,如下示例:</p><div class=highlight><div class=chroma><div class=table-container><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span><span class=lnt>32
</span><span class=lnt>33
</span><span class=lnt>34
</span><span class=lnt>35
</span><span class=lnt>36
</span><span class=lnt>37
</span><span class=lnt>38
</span><span class=lnt>39
</span><span class=lnt>40
</span><span class=lnt>41
</span><span class=lnt>42
</span><span class=lnt>43
</span><span class=lnt>44
</span><span class=lnt>45
</span><span class=lnt>46
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-yaml data-lang=yaml><span class=line><span class=cl><span class=nn>---</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span>- <span class=nt>hosts</span><span class=p>:</span><span class=w> </span><span class=l>node2</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>remote_user</span><span class=p>:</span><span class=w> </span><span class=l>root</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>gather_facts</span><span class=p>:</span><span class=w> </span><span class=kc>no</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>tasks</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span>- <span class=nt>debug</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>msg</span><span class=p>:</span><span class=w> </span><span class=s2>&#34;{{ item }}&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>with_indexed_items</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span>- <span class=l>test1</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span>- <span class=l>test2</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span>- <span class=l>test3</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=c># 输出如下:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=l>TASK [debug] xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>ok</span><span class=p>:</span><span class=w> </span><span class=p>[</span><span class=l>node2] =&gt; (item=(0, u&#39;test1&#39;)) =&gt; {</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>&#34;changed&#34;: </span><span class=kc>false</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>&#34;item&#34;: </span><span class=p>[</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=m>0</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=s2>&#34;test1&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>],</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>&#34;msg&#34;: </span><span class=p>[</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=m>0</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=s2>&#34;test1&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>]</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span>}<span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>ok</span><span class=p>:</span><span class=w> </span><span class=p>[</span><span class=l>node2] =&gt; (item=(1, u&#39;test2&#39;)) =&gt; {</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>&#34;changed&#34;: </span><span class=kc>false</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>&#34;item&#34;: </span><span class=p>[</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=m>1</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=s2>&#34;test2&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>],</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>&#34;msg&#34;: </span><span class=p>[</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=m>1</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=s2>&#34;test2&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>]</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span>}<span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>ok</span><span class=p>:</span><span class=w> </span><span class=p>[</span><span class=l>node2] =&gt; (item=(2, u&#39;test3&#39;)) =&gt; {</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>&#34;changed&#34;: </span><span class=kc>false</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>&#34;item&#34;: </span><span class=p>[</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=m>2</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=s2>&#34;test3&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>],</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>&#34;msg&#34;: </span><span class=p>[</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=m>2</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=s2>&#34;test3&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>]</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span>}<span class=w>
</span></span></span></code></pre></td></tr></table></div></div></div><ul><li>”with_indexed_items”会将嵌套的两层列表”拉平”，”拉平”后按照顺序为每一项编号</li><li>当多加了一层嵌套以后，”with_indexed_items”并不能像”with_flattened”一样将嵌套的列表”完全拉平”，第二层列表中的项如果仍然是一个列表，”with_indexed_items”则不会拉平这个列表，而是将其当做一个整体进行编号</li></ul><h2 id=使用循环五with_sequencewith_random_choice><a href=#使用循环五with_sequencewith_random_choice class=anchor-link><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512" class="icon anchor-icon"><path d="M326.612 185.391c59.747 59.809 58.927 155.698.36 214.59-.11.12-.24.25-.36.37l-67.2 67.2c-59.27 59.27-155.699 59.262-214.96.0-59.27-59.26-59.27-155.7.0-214.96l37.106-37.106c9.84-9.84 26.786-3.3 27.294 10.606.648 17.722 3.826 35.527 9.69 52.721 1.986 5.822.567 12.262-3.783 16.612l-13.087 13.087c-28.026 28.026-28.905 73.66-1.155 101.96 28.024 28.579 74.086 28.749 102.325.51l67.2-67.19c28.191-28.191 28.073-73.757.0-101.83-3.701-3.694-7.429-6.564-10.341-8.569a16.037 16.037.0 01-6.947-12.606c-.396-10.567 3.348-21.456 11.698-29.806l21.054-21.055c5.521-5.521 14.182-6.199 20.584-1.731a152.482 152.482.0 0120.522 17.197zM467.547 44.449c-59.261-59.262-155.69-59.27-214.96.0l-67.2 67.2c-.12.12-.25.25-.36.37-58.566 58.892-59.387 154.781.36 214.59a152.454 152.454.0 0020.521 17.196c6.402 4.468 15.064 3.789 20.584-1.731l21.054-21.055c8.35-8.35 12.094-19.239 11.698-29.806a16.037 16.037.0 00-6.947-12.606c-2.912-2.005-6.64-4.875-10.341-8.569-28.073-28.073-28.191-73.639.0-101.83l67.2-67.19c28.239-28.239 74.3-28.069 102.325.51 27.75 28.3 26.872 73.934-1.155 101.96l-13.087 13.087c-4.35 4.35-5.769 10.79-3.783 16.612 5.864 17.194 9.042 34.999 9.69 52.721.509 13.906 17.454 20.446 27.294 10.606l37.106-37.106c59.271-59.259 59.271-155.699.001-214.959z"/></svg></a><a href=#contents:使用循环五with_sequencewith_random_choice class=headings>#使用循环(五),with_sequence,with_random_choice</a></h2><p>1,with_sequence</p><ul><li>使用with_sequence生成序列,with_sequence可以按照顺序生成数字序列,如下示例:</li></ul><div class=highlight><div class=chroma><div class=table-container><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-yaml data-lang=yaml><span class=line><span class=cl><span class=c># debug模块被循环调用了5次，msg的值从1一直输出到了5，值的大小每次增加1</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nn>---</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span>- <span class=nt>hosts</span><span class=p>:</span><span class=w> </span><span class=l>node2</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>remote_user</span><span class=p>:</span><span class=w> </span><span class=l>root</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>gather_facts</span><span class=p>:</span><span class=w> </span><span class=kc>no</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>tasks</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span>- <span class=nt>debug</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>msg</span><span class=p>:</span><span class=w> </span><span class=s2>&#34;{{ item }}&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>with_sequence</span><span class=p>:</span><span class=w> </span><span class=l>start=1 end=5 stride=1</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=c># 下列写法结果一致</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=c># with_sequence: count=5</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div></div><ul><li>使用with_sequence还可以格式化输出</li></ul><div class=highlight><div class=chroma><div class=table-container><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span><span class=lnt>7
</span><span class=lnt>8
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-yaml data-lang=yaml><span class=line><span class=cl><span class=nn>---</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span>- <span class=nt>hosts</span><span class=p>:</span><span class=w> </span><span class=l>node2</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>remote_user</span><span class=p>:</span><span class=w> </span><span class=l>root</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>gather_facts</span><span class=p>:</span><span class=w> </span><span class=kc>no</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>tasks</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span>- <span class=nt>debug</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>msg</span><span class=p>:</span><span class=w> </span><span class=s2>&#34;{{item}}&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>with_sequence</span><span class=p>:</span><span class=w> </span><span class=l>start=2 end=6 stride=2 format=&#34;number is %0.2f&#34;</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div></div><p>2,with_random_choice,使用with_random_choice可以从列表的多个值中随机返回一个值</p><ul><li>如下示例:</li></ul><div class=highlight><div class=chroma><div class=table-container><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-yaml data-lang=yaml><span class=line><span class=cl><span class=nn>---</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span>- <span class=nt>hosts</span><span class=p>:</span><span class=w> </span><span class=l>node2</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>remote_user</span><span class=p>:</span><span class=w> </span><span class=l>root</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>gather_facts</span><span class=p>:</span><span class=w> </span><span class=kc>no</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>tasks</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span>- <span class=nt>debug</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>msg</span><span class=p>:</span><span class=w> </span><span class=s2>&#34;{{item}}&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>with_random_choice</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span>- <span class=m>1</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span>- <span class=m>2</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span>- <span class=m>3</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span>- <span class=m>4</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span>- <span class=m>5</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div></div><h2 id=使用循环六with_dictwith_subelementswith_file><a href=#使用循环六with_dictwith_subelementswith_file class=anchor-link><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512" class="icon anchor-icon"><path d="M326.612 185.391c59.747 59.809 58.927 155.698.36 214.59-.11.12-.24.25-.36.37l-67.2 67.2c-59.27 59.27-155.699 59.262-214.96.0-59.27-59.26-59.27-155.7.0-214.96l37.106-37.106c9.84-9.84 26.786-3.3 27.294 10.606.648 17.722 3.826 35.527 9.69 52.721 1.986 5.822.567 12.262-3.783 16.612l-13.087 13.087c-28.026 28.026-28.905 73.66-1.155 101.96 28.024 28.579 74.086 28.749 102.325.51l67.2-67.19c28.191-28.191 28.073-73.757.0-101.83-3.701-3.694-7.429-6.564-10.341-8.569a16.037 16.037.0 01-6.947-12.606c-.396-10.567 3.348-21.456 11.698-29.806l21.054-21.055c5.521-5.521 14.182-6.199 20.584-1.731a152.482 152.482.0 0120.522 17.197zM467.547 44.449c-59.261-59.262-155.69-59.27-214.96.0l-67.2 67.2c-.12.12-.25.25-.36.37-58.566 58.892-59.387 154.781.36 214.59a152.454 152.454.0 0020.521 17.196c6.402 4.468 15.064 3.789 20.584-1.731l21.054-21.055c8.35-8.35 12.094-19.239 11.698-29.806a16.037 16.037.0 00-6.947-12.606c-2.912-2.005-6.64-4.875-10.341-8.569-28.073-28.073-28.191-73.639.0-101.83l67.2-67.19c28.239-28.239 74.3-28.069 102.325.51 27.75 28.3 26.872 73.934-1.155 101.96l-13.087 13.087c-4.35 4.35-5.769 10.79-3.783 16.612 5.864 17.194 9.042 34.999 9.69 52.721.509 13.906 17.454 20.446 27.294 10.606l37.106-37.106c59.271-59.259 59.271-155.699.001-214.959z"/></svg></a><a href=#contents:使用循环六with_dictwith_subelementswith_file class=headings>#使用循环(六),with_dict,with_subelements,with_file</a></h2><p>1,with_dict,循环遍历字典元素,如下示例:</p><div class=highlight><div class=chroma><div class=table-container><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span><span class=lnt>32
</span><span class=lnt>33
</span><span class=lnt>34
</span><span class=lnt>35
</span><span class=lnt>36
</span><span class=lnt>37
</span><span class=lnt>38
</span><span class=lnt>39
</span><span class=lnt>40
</span><span class=lnt>41
</span><span class=lnt>42
</span><span class=lnt>43
</span><span class=lnt>44
</span><span class=lnt>45
</span><span class=lnt>46
</span><span class=lnt>47
</span><span class=lnt>48
</span><span class=lnt>49
</span><span class=lnt>50
</span><span class=lnt>51
</span><span class=lnt>52
</span><span class=lnt>53
</span><span class=lnt>54
</span><span class=lnt>55
</span><span class=lnt>56
</span><span class=lnt>57
</span><span class=lnt>58
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-yaml data-lang=yaml><span class=line><span class=cl><span class=nn>---</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span>- <span class=nt>hosts</span><span class=p>:</span><span class=w> </span><span class=l>node2</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>remote_user</span><span class=p>:</span><span class=w> </span><span class=l>root</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>gather_facts</span><span class=p>:</span><span class=w> </span><span class=kc>no</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>vars</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>users</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>alice</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>Alice Appleworth</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nt>gender</span><span class=p>:</span><span class=w> </span><span class=l>female</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nt>telephone</span><span class=p>:</span><span class=w> </span><span class=m>123-456-7890</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>bob</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>Bob Bananarama</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nt>gender</span><span class=p>:</span><span class=w> </span><span class=l>male</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nt>telephone</span><span class=p>:</span><span class=w> </span><span class=m>987-654-3210</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>tasks</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span>- <span class=nt>debug</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>msg</span><span class=p>:</span><span class=w> </span><span class=s2>&#34;{{item}}&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>with_dict</span><span class=p>:</span><span class=w> </span><span class=s2>&#34;{{users}}&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=c># 输出如下:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=l>TASK [debug] xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>ok</span><span class=p>:</span><span class=w> </span><span class=p>[</span><span class=l>node2] =&gt; (item={&#39;value&#39;: {u&#39;gender&#39;: u&#39;male&#39;, u&#39;name&#39;: u&#39;Bob Bananarama&#39;, u&#39;telephone&#39;: u&#39;987-654-3210&#39;}, &#39;key&#39;: u&#39;bob&#39;}) =&gt; {</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>&#34;changed&#34;: </span><span class=kc>false</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>&#34;item&#34;: </span>{<span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nt>&#34;key&#34;: </span><span class=s2>&#34;bob&#34;</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nt>&#34;value&#34;: </span>{<span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=nt>&#34;gender&#34;: </span><span class=s2>&#34;male&#34;</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=nt>&#34;name&#34;: </span><span class=s2>&#34;Bob Bananarama&#34;</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=nt>&#34;telephone&#34;: </span><span class=s2>&#34;987-654-3210&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span>}<span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span>}<span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>&#34;msg&#34;: </span>{<span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nt>&#34;key&#34;: </span><span class=s2>&#34;bob&#34;</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nt>&#34;value&#34;: </span>{<span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=nt>&#34;gender&#34;: </span><span class=s2>&#34;male&#34;</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=nt>&#34;name&#34;: </span><span class=s2>&#34;Bob Bananarama&#34;</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=nt>&#34;telephone&#34;: </span><span class=s2>&#34;987-654-3210&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span>}<span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span>}<span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span>}<span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>ok</span><span class=p>:</span><span class=w> </span><span class=p>[</span><span class=l>node2] =&gt; (item={&#39;value&#39;: {u&#39;gender&#39;: u&#39;female&#39;, u&#39;name&#39;: u&#39;Alice Appleworth&#39;, u&#39;telephone&#39;: u&#39;123-456-7890&#39;}, &#39;key&#39;: u&#39;alice&#39;}) =&gt; {</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>&#34;changed&#34;: </span><span class=kc>false</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>&#34;item&#34;: </span>{<span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nt>&#34;key&#34;: </span><span class=s2>&#34;alice&#34;</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nt>&#34;value&#34;: </span>{<span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=nt>&#34;gender&#34;: </span><span class=s2>&#34;female&#34;</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=nt>&#34;name&#34;: </span><span class=s2>&#34;Alice Appleworth&#34;</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=nt>&#34;telephone&#34;: </span><span class=s2>&#34;123-456-7890&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span>}<span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span>}<span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>&#34;msg&#34;: </span>{<span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nt>&#34;key&#34;: </span><span class=s2>&#34;alice&#34;</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nt>&#34;value&#34;: </span>{<span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=nt>&#34;gender&#34;: </span><span class=s2>&#34;female&#34;</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=nt>&#34;name&#34;: </span><span class=s2>&#34;Alice Appleworth&#34;</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=nt>&#34;telephone&#34;: </span><span class=s2>&#34;123-456-7890&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span>}<span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span>}<span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span>}<span class=w>
</span></span></span></code></pre></td></tr></table></div></div></div><p>2,with_subelements:</p><ul><li>with_subelements会将hobby子元素列表中的每一项作为一个整体，将其他子元素作为一个整体，然后组合在一起</li></ul><div class=highlight><div class=chroma><div class=table-container><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span><span class=lnt>32
</span><span class=lnt>33
</span><span class=lnt>34
</span><span class=lnt>35
</span><span class=lnt>36
</span><span class=lnt>37
</span><span class=lnt>38
</span><span class=lnt>39
</span><span class=lnt>40
</span><span class=lnt>41
</span><span class=lnt>42
</span><span class=lnt>43
</span><span class=lnt>44
</span><span class=lnt>45
</span><span class=lnt>46
</span><span class=lnt>47
</span><span class=lnt>48
</span><span class=lnt>49
</span><span class=lnt>50
</span><span class=lnt>51
</span><span class=lnt>52
</span><span class=lnt>53
</span><span class=lnt>54
</span><span class=lnt>55
</span><span class=lnt>56
</span><span class=lnt>57
</span><span class=lnt>58
</span><span class=lnt>59
</span><span class=lnt>60
</span><span class=lnt>61
</span><span class=lnt>62
</span><span class=lnt>63
</span><span class=lnt>64
</span><span class=lnt>65
</span><span class=lnt>66
</span><span class=lnt>67
</span><span class=lnt>68
</span><span class=lnt>69
</span><span class=lnt>70
</span><span class=lnt>71
</span><span class=lnt>72
</span><span class=lnt>73
</span><span class=lnt>74
</span><span class=lnt>75
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-yaml data-lang=yaml><span class=line><span class=cl><span class=c># 如下示例:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nn>---</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span>- <span class=nt>hosts</span><span class=p>:</span><span class=w> </span><span class=l>node2</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>remote_user</span><span class=p>:</span><span class=w> </span><span class=l>root</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>gather_facts</span><span class=p>:</span><span class=w> </span><span class=kc>no</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>vars</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>users</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span>- <span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>bob</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>gender</span><span class=p>:</span><span class=w> </span><span class=l>male</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>hobby</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span>- <span class=l>Skateboard</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span>- <span class=l>VideoGame</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span>- <span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>alice</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>gender</span><span class=p>:</span><span class=w> </span><span class=l>female</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>hobby</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span>- <span class=l>Music</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>tasks</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span>- <span class=nt>debug</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>msg</span><span class=p>:</span><span class=w> </span><span class=s2>&#34;{{ item }}&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>with_subelements</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span>- <span class=s2>&#34;{{users}}&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span>- <span class=l>hobby</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=c># 输出如下:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=l>TASK [debug] xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>ok</span><span class=p>:</span><span class=w> </span><span class=p>[</span><span class=l>node2] =&gt; (item=({u&#39;gender&#39;: u&#39;male&#39;, u&#39;name&#39;: u&#39;bob&#39;}, u&#39;Skateboard&#39;)) =&gt; {</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>&#34;changed&#34;: </span><span class=kc>false</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>&#34;item&#34;: </span><span class=p>[</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span>{<span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=nt>&#34;gender&#34;: </span><span class=s2>&#34;male&#34;</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=nt>&#34;name&#34;: </span><span class=s2>&#34;bob&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span>}<span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=s2>&#34;Skateboard&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>],</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>&#34;msg&#34;: </span><span class=p>[</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span>{<span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=nt>&#34;gender&#34;: </span><span class=s2>&#34;male&#34;</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=nt>&#34;name&#34;: </span><span class=s2>&#34;bob&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span>}<span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=s2>&#34;Skateboard&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>]</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span>}<span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>ok</span><span class=p>:</span><span class=w> </span><span class=p>[</span><span class=l>node2] =&gt; (item=({u&#39;gender&#39;: u&#39;male&#39;, u&#39;name&#39;: u&#39;bob&#39;}, u&#39;VideoGame&#39;)) =&gt; {</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>&#34;changed&#34;: </span><span class=kc>false</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>&#34;item&#34;: </span><span class=p>[</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span>{<span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=nt>&#34;gender&#34;: </span><span class=s2>&#34;male&#34;</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=nt>&#34;name&#34;: </span><span class=s2>&#34;bob&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span>}<span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=s2>&#34;VideoGame&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>],</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>&#34;msg&#34;: </span><span class=p>[</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span>{<span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=nt>&#34;gender&#34;: </span><span class=s2>&#34;male&#34;</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=nt>&#34;name&#34;: </span><span class=s2>&#34;bob&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span>}<span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=s2>&#34;VideoGame&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>]</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span>}<span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>ok</span><span class=p>:</span><span class=w> </span><span class=p>[</span><span class=l>node2] =&gt; (item=({u&#39;gender&#39;: u&#39;female&#39;, u&#39;name&#39;: u&#39;alice&#39;}, u&#39;Music&#39;)) =&gt; {</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>&#34;changed&#34;: </span><span class=kc>false</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>&#34;item&#34;: </span><span class=p>[</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span>{<span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=nt>&#34;gender&#34;: </span><span class=s2>&#34;female&#34;</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=nt>&#34;name&#34;: </span><span class=s2>&#34;alice&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span>}<span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=s2>&#34;Music&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>],</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>&#34;msg&#34;: </span><span class=p>[</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span>{<span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=nt>&#34;gender&#34;: </span><span class=s2>&#34;female&#34;</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=nt>&#34;name&#34;: </span><span class=s2>&#34;alice&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span>}<span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=s2>&#34;Music&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>]</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span>}<span class=w>
</span></span></span></code></pre></td></tr></table></div></div></div><ul><li>由于item由两个整体组成，所以，我们通过item.0获取到第一个小整体，即gender和name属性，然后通过item.1获取到第二个小整体，即hobby列表中的每一项</li></ul><div class=highlight><div class=chroma><div class=table-container><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-yaml data-lang=yaml><span class=line><span class=cl><span class=nn>---</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span>- <span class=nt>hosts</span><span class=p>:</span><span class=w> </span><span class=l>node2</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>remote_user</span><span class=p>:</span><span class=w> </span><span class=l>root</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>gather_facts</span><span class=p>:</span><span class=w> </span><span class=kc>no</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>vars</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>users</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span>- <span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>bob</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>gender</span><span class=p>:</span><span class=w> </span><span class=l>male</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>hobby</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span>- <span class=l>Skateboard</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span>- <span class=l>VideoGame</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span>- <span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>alice</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>gender</span><span class=p>:</span><span class=w> </span><span class=l>female</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>hobby</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span>- <span class=l>Music</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>tasks</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span>- <span class=nt>debug</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>msg</span><span class=p>:</span><span class=w> </span><span class=s2>&#34;{{ item.0.name }} &#39;s hobby is {{ item.1 }}&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>with_subelements</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span>- <span class=s2>&#34;{{users}}&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span>- <span class=l>hobby</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=c># msg内容如下:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>&#34;msg&#34;: </span><span class=s2>&#34;bob &#39;s hobby is Skateboard&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>&#34;msg&#34;: </span><span class=s2>&#34;bob &#39;s hobby is VideoGame&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>&#34;msg&#34;: </span><span class=s2>&#34;alice &#39;s hobby is Music&#34;</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div></div><h2 id=使用循环七-with_file-with_fileglob><a href=#使用循环七-with_file-with_fileglob class=anchor-link><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512" class="icon anchor-icon"><path d="M326.612 185.391c59.747 59.809 58.927 155.698.36 214.59-.11.12-.24.25-.36.37l-67.2 67.2c-59.27 59.27-155.699 59.262-214.96.0-59.27-59.26-59.27-155.7.0-214.96l37.106-37.106c9.84-9.84 26.786-3.3 27.294 10.606.648 17.722 3.826 35.527 9.69 52.721 1.986 5.822.567 12.262-3.783 16.612l-13.087 13.087c-28.026 28.026-28.905 73.66-1.155 101.96 28.024 28.579 74.086 28.749 102.325.51l67.2-67.19c28.191-28.191 28.073-73.757.0-101.83-3.701-3.694-7.429-6.564-10.341-8.569a16.037 16.037.0 01-6.947-12.606c-.396-10.567 3.348-21.456 11.698-29.806l21.054-21.055c5.521-5.521 14.182-6.199 20.584-1.731a152.482 152.482.0 0120.522 17.197zM467.547 44.449c-59.261-59.262-155.69-59.27-214.96.0l-67.2 67.2c-.12.12-.25.25-.36.37-58.566 58.892-59.387 154.781.36 214.59a152.454 152.454.0 0020.521 17.196c6.402 4.468 15.064 3.789 20.584-1.731l21.054-21.055c8.35-8.35 12.094-19.239 11.698-29.806a16.037 16.037.0 00-6.947-12.606c-2.912-2.005-6.64-4.875-10.341-8.569-28.073-28.073-28.191-73.639.0-101.83l67.2-67.19c28.239-28.239 74.3-28.069 102.325.51 27.75 28.3 26.872 73.934-1.155 101.96l-13.087 13.087c-4.35 4.35-5.769 10.79-3.783 16.612 5.864 17.194 9.042 34.999 9.69 52.721.509 13.906 17.454 20.446 27.294 10.606l37.106-37.106c59.271-59.259 59.271-155.699.001-214.959z"/></svg></a><a href=#contents:使用循环七-with_file-with_fileglob class=headings>#使用循环(七) with_file, with_fileglob</a></h2><p>1, ansible主机中有几个文件,若需要获取到这些文件的内容，可以使用with_file关键字，循环的获取到这些文件的内容</p><ul><li>如下示例:</li></ul><div class=highlight><div class=chroma><div class=table-container><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-yaml data-lang=yaml><span class=line><span class=cl><span class=c># 无论目标主机是谁，都可以通过with_file关键字获取到ansible主机中的文件内容</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nn>---</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span>- <span class=nt>hosts</span><span class=p>:</span><span class=w> </span><span class=l>node2</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>remote_user</span><span class=p>:</span><span class=w> </span><span class=l>root</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>gather_facts</span><span class=p>:</span><span class=w> </span><span class=kc>no</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>tasks</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span>- <span class=nt>debug</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>msg</span><span class=p>:</span><span class=w> </span><span class=s2>&#34;{{ item }}&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>with_file</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span>- <span class=l>/testdir/testdir/a.log</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span>- <span class=l>/opt/testfile</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div></div><p>2,可以通过with_fileglob关键字，在指定的目录中匹配符合模式的文件名，with_file与with_fileglob相同的地方，它们都是针对ansible主机的文件进行操作，而不是目标主机</p><ul><li>如下示例:</li></ul><div class=highlight><div class=chroma><div class=table-container><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-yaml data-lang=yaml><span class=line><span class=cl><span class=nn>---</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span>- <span class=nt>hosts</span><span class=p>:</span><span class=w> </span><span class=l>node2</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>remote_user</span><span class=p>:</span><span class=w> </span><span class=l>root</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>gather_facts</span><span class=p>:</span><span class=w> </span><span class=kc>no</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>tasks</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span>- <span class=nt>debug</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>msg</span><span class=p>:</span><span class=w> </span><span class=s2>&#34;{{ item }}&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>with_fileglob</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span>- <span class=l>/testdir/(此处为星号,删除防止下面格式错乱)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=c># 输出如下:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=l>TASK [debug] xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>ok</span><span class=p>:</span><span class=w> </span><span class=p>[</span><span class=l>node2] =&gt; (item=/testdir/testfile) =&gt; {</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>&#34;changed&#34;: </span><span class=kc>false</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>&#34;item&#34;: </span><span class=s2>&#34;/testdir/testfile&#34;</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>&#34;msg&#34;: </span><span class=s2>&#34;/testdir/testfile&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span>}<span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>ok</span><span class=p>:</span><span class=w> </span><span class=p>[</span><span class=l>node2] =&gt; (item=/testdir/test.sh) =&gt; {</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>&#34;changed&#34;: </span><span class=kc>false</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>&#34;item&#34;: </span><span class=s2>&#34;/testdir/test.sh&#34;</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>&#34;msg&#34;: </span><span class=s2>&#34;/testdir/test.sh&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span>}<span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=c># 需要注意的是，with_fileglob只会匹配指定目录中的文件，而不会匹配指定目录中的目录</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div></div><h2 id=条件判断六with_dictwith_subelementswith_file><a href=#条件判断六with_dictwith_subelementswith_file class=anchor-link><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512" class="icon anchor-icon"><path d="M326.612 185.391c59.747 59.809 58.927 155.698.36 214.59-.11.12-.24.25-.36.37l-67.2 67.2c-59.27 59.27-155.699 59.262-214.96.0-59.27-59.26-59.27-155.7.0-214.96l37.106-37.106c9.84-9.84 26.786-3.3 27.294 10.606.648 17.722 3.826 35.527 9.69 52.721 1.986 5.822.567 12.262-3.783 16.612l-13.087 13.087c-28.026 28.026-28.905 73.66-1.155 101.96 28.024 28.579 74.086 28.749 102.325.51l67.2-67.19c28.191-28.191 28.073-73.757.0-101.83-3.701-3.694-7.429-6.564-10.341-8.569a16.037 16.037.0 01-6.947-12.606c-.396-10.567 3.348-21.456 11.698-29.806l21.054-21.055c5.521-5.521 14.182-6.199 20.584-1.731a152.482 152.482.0 0120.522 17.197zM467.547 44.449c-59.261-59.262-155.69-59.27-214.96.0l-67.2 67.2c-.12.12-.25.25-.36.37-58.566 58.892-59.387 154.781.36 214.59a152.454 152.454.0 0020.521 17.196c6.402 4.468 15.064 3.789 20.584-1.731l21.054-21.055c8.35-8.35 12.094-19.239 11.698-29.806a16.037 16.037.0 00-6.947-12.606c-2.912-2.005-6.64-4.875-10.341-8.569-28.073-28.073-28.191-73.639.0-101.83l67.2-67.19c28.239-28.239 74.3-28.069 102.325.51 27.75 28.3 26.872 73.934-1.155 101.96l-13.087 13.087c-4.35 4.35-5.769 10.79-3.783 16.612 5.864 17.194 9.042 34.999 9.69 52.721.509 13.906 17.454 20.446 27.294 10.606l37.106-37.106c59.271-59.259 59.271-155.699.001-214.959z"/></svg></a><a href=#contents:条件判断六with_dictwith_subelementswith_file class=headings>#条件判断(六),with_dict,with_subelements,with_file</a></h2><p>1,绝大多数语言中，都使用if作为条件判断的关键字，而在ansible中，条件判断的关键字是when</p><ul><li>如下示例:</li></ul><div class=highlight><div class=chroma><div class=table-container><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-yaml data-lang=yaml><span class=line><span class=cl><span class=nn>---</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span>- <span class=nt>hosts</span><span class=p>:</span><span class=w> </span><span class=l>node2</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>remote_user</span><span class=p>:</span><span class=w> </span><span class=l>root</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>tasks</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span>- <span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>test when</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>debug</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>msg</span><span class=p>:</span><span class=w> </span><span class=s2>&#34;System is centos&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=c># 如果需要获取到facts中的key的值，都是通过引用变量的方式获取的，即&#34;{{ key }}&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=c># 在when关键字中引用变量时，变量名不需要加&#34;{{  }}&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>when</span><span class=p>:</span><span class=w> </span><span class=l>ansible_distribution == &#34;CentOS&#34;</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div></div><p>2,使用when关键字为任务指定条件，条件成立，则执行任务，条件不成立，则不执行任务</p><ul><li>如下示例:</li></ul><div class=highlight><div class=chroma><div class=table-container><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-yaml data-lang=yaml><span class=line><span class=cl><span class=nn>---</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span>- <span class=nt>hosts</span><span class=p>:</span><span class=w> </span><span class=l>node2</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>remote_user</span><span class=p>:</span><span class=w> </span><span class=l>root</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>gather_facts</span><span class=p>:</span><span class=w> </span><span class=kc>no</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>tasks</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span>- <span class=nt>debug</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>msg</span><span class=p>:</span><span class=w> </span><span class=s2>&#34;{{item}}&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>with_items</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span>- <span class=m>1</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span>- <span class=m>2</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span>- <span class=m>3</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>when</span><span class=p>:</span><span class=w> </span><span class=l>item &gt; 1</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div></div><p>3,在ansible中，使用如下比较运算符.</p><ul><li>如下所示:</li></ul><pre tabindex=0><code>==  :比较两个对象是否相等，相等为真
!=  :比较两个对象是否不等，不等为真
&gt;   :比较两个值的大小，如果左边的值大于右边的值，则为真
&lt;   :比较两个值的大小，如果左边的值小于右边的值，则为真
&gt;=  :比较两个值的大小，如果左边的值大于右边的值或左右相等，则为真
&lt;=  :比较两个值的大小，如果左边的值小于右边的值或左右相等，则为真
上述总结的这些运算符其实都是jinja2的运算符，ansible使用jinja2模板引擎，在ansible中也可以直接使用jinja2的这些运算符

上述为比较运算符，再来说说逻辑运算符，可用的逻辑运算符如下:
and  :逻辑与，当左边与右边同时为真，则返回真
or   :逻辑或，当左边与右边有任意一个为真，则返回真
not  :取反，对一个操作体取反
( )  :组合，将一组操作体包装在一起，形成一个较大的操作体
</code></pre><ul><li>如下示例:</li></ul><div class=highlight><div class=chroma><div class=table-container><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span><span class=lnt>32
</span><span class=lnt>33
</span><span class=lnt>34
</span><span class=lnt>35
</span><span class=lnt>36
</span><span class=lnt>37
</span><span class=lnt>38
</span><span class=lnt>39
</span><span class=lnt>40
</span><span class=lnt>41
</span><span class=lnt>42
</span><span class=lnt>43
</span><span class=lnt>44
</span><span class=lnt>45
</span><span class=lnt>46
</span><span class=lnt>47
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-yaml data-lang=yaml><span class=line><span class=cl><span class=c># 示例1:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nn>---</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span>- <span class=nt>hosts</span><span class=p>:</span><span class=w> </span><span class=l>node2</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>remote_user</span><span class=p>:</span><span class=w> </span><span class=l>root</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>tasks</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span>- <span class=nt>debug</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>msg</span><span class=p>:</span><span class=w> </span><span class=s2>&#34;System release is centos7&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>when</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=c># 使用列表,列表中的每一项都是一个条件，列表中的所有条件同时成立时，对应的任务才会执行</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span>- <span class=l>ansible_distribution == &#34;CentOS&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span>- <span class=l>ansible_distribution_major_version == &#34;7&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=c># 示例2:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nn>---</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span>- <span class=nt>hosts</span><span class=p>:</span><span class=w> </span><span class=l>node2</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>remote_user</span><span class=p>:</span><span class=w> </span><span class=l>root</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>tasks</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span>- <span class=nt>debug</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>msg</span><span class=p>:</span><span class=w> </span><span class=s2>&#34;System release is centos6 or centos7&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=c># 比较运算符和逻辑运算符结合使用作为条件判断</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>when</span><span class=p>:</span><span class=w> </span><span class=l>ansible_distribution == &#34;CentOS&#34; and</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>          </span><span class=l>(ansible_distribution_major_version == &#34;6&#34; or ansible_distribution_major_version == &#34;7&#34;)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=c># 示例3:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nn>---</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span>- <span class=nt>hosts</span><span class=p>:</span><span class=w> </span><span class=l>node2</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>remote_user</span><span class=p>:</span><span class=w> </span><span class=l>root</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>tasks</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span>- <span class=nt>debug</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>msg</span><span class=p>:</span><span class=w> </span><span class=s2>&#34;System release is not centos&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=c># 逻辑取反</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>when</span><span class=p>:</span><span class=w> </span><span class=l>not ansible_distribution == &#34;CentOS&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=c># 示例4:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nn>---</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span>- <span class=nt>hosts</span><span class=p>:</span><span class=w> </span><span class=l>node2</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>remote_user</span><span class=p>:</span><span class=w> </span><span class=l>root</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>tasks</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span>- <span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>task1</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>shell</span><span class=p>:</span><span class=w> </span><span class=s2>&#34;ls /testabc&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>register</span><span class=p>:</span><span class=w> </span><span class=l>returnmsg</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span>- <span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>task2</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>debug</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>msg</span><span class=p>:</span><span class=w> </span><span class=s2>&#34;Command execution successful&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=c># 通过shell指令的返回值判断是否执行</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>when</span><span class=p>:</span><span class=w> </span><span class=l>returnmsg.rc == 0</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span>- <span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>task3</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>debug</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>msg</span><span class=p>:</span><span class=w> </span><span class=s2>&#34;Command execution failed&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>when</span><span class=p>:</span><span class=w> </span><span class=l>returnmsg.rc != 0</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div></div><p>3,结合ignore_errors和when来限定playbook的执行</p><ul><li>如下示例:</li></ul><div class=highlight><div class=chroma><div class=table-container><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-yaml data-lang=yaml><span class=line><span class=cl><span class=nn>---</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span>- <span class=nt>hosts</span><span class=p>:</span><span class=w> </span><span class=l>node2</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>remote_user</span><span class=p>:</span><span class=w> </span><span class=l>root</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>tasks</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span>- <span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>task1</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>shell</span><span class=p>:</span><span class=w> </span><span class=s2>&#34;ls /testabc&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>register</span><span class=p>:</span><span class=w> </span><span class=l>returnmsg</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=c># 此处增加了ignore_errors,在不存在/testabc目录的节点就不会报错,playbook不会退出,task2,task3通过rc值来确定是否要执行</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>ignore_errors</span><span class=p>:</span><span class=w> </span><span class=kc>true</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span>- <span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>task2</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>debug</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>msg</span><span class=p>:</span><span class=w> </span><span class=s2>&#34;Command execution successful&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>when</span><span class=p>:</span><span class=w> </span><span class=l>returnmsg.rc == 0</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span>- <span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>task3</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>debug</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>msg</span><span class=p>:</span><span class=w> </span><span class=s2>&#34;Command execution failed&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>when</span><span class=p>:</span><span class=w> </span><span class=l>returnmsg.rc != 0</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div></div><h2 id=条件判断与tests><a href=#条件判断与tests class=anchor-link><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512" class="icon anchor-icon"><path d="M326.612 185.391c59.747 59.809 58.927 155.698.36 214.59-.11.12-.24.25-.36.37l-67.2 67.2c-59.27 59.27-155.699 59.262-214.96.0-59.27-59.26-59.27-155.7.0-214.96l37.106-37.106c9.84-9.84 26.786-3.3 27.294 10.606.648 17.722 3.826 35.527 9.69 52.721 1.986 5.822.567 12.262-3.783 16.612l-13.087 13.087c-28.026 28.026-28.905 73.66-1.155 101.96 28.024 28.579 74.086 28.749 102.325.51l67.2-67.19c28.191-28.191 28.073-73.757.0-101.83-3.701-3.694-7.429-6.564-10.341-8.569a16.037 16.037.0 01-6.947-12.606c-.396-10.567 3.348-21.456 11.698-29.806l21.054-21.055c5.521-5.521 14.182-6.199 20.584-1.731a152.482 152.482.0 0120.522 17.197zM467.547 44.449c-59.261-59.262-155.69-59.27-214.96.0l-67.2 67.2c-.12.12-.25.25-.36.37-58.566 58.892-59.387 154.781.36 214.59a152.454 152.454.0 0020.521 17.196c6.402 4.468 15.064 3.789 20.584-1.731l21.054-21.055c8.35-8.35 12.094-19.239 11.698-29.806a16.037 16.037.0 00-6.947-12.606c-2.912-2.005-6.64-4.875-10.341-8.569-28.073-28.073-28.191-73.639.0-101.83l67.2-67.19c28.239-28.239 74.3-28.069 102.325.51 27.75 28.3 26.872 73.934-1.155 101.96l-13.087 13.087c-4.35 4.35-5.769 10.79-3.783 16.612 5.864 17.194 9.042 34.999 9.69 52.721.509 13.906 17.454 20.446 27.294 10.606l37.106-37.106c59.271-59.259 59.271-155.699.001-214.959z"/></svg></a><a href=#contents:条件判断与tests class=headings>#条件判断与tests</a></h2><p>1,在ansible中也有类似bash中test的用法,不过是借助jinja2的tests，借助tests，可以进行一些判断操作，tests会将判断后的布尔值返回，如果条件成立，返回true，否则返回false，通常在条件判断时使用到tests</p><ul><li>如下示例:</li></ul><div class=highlight><div class=chroma><div class=table-container><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-yaml data-lang=yaml><span class=line><span class=cl><span class=nn>---</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span>- <span class=nt>hosts</span><span class=p>:</span><span class=w> </span><span class=l>me</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>gather_facts</span><span class=p>:</span><span class=w> </span><span class=kc>no</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>remote_user</span><span class=p>:</span><span class=w> </span><span class=l>root</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>vars</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>testpath</span><span class=p>:</span><span class=w> </span><span class=l>/testdir</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>tasks</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span>- <span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>test tests</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>debug</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>msg</span><span class=p>:</span><span class=w> </span><span class=s2>&#34;test dir exist&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=c># &#34;is exists&#34;中的&#34;exists&#34;就是tests的一种，它与&#34;test -e&#34;命令的作用是相同的，通过&#34;exists&#34;可以判断ansible主机中的对应路径是否存在</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=c># &#34;is not exists&#34;表示对应路径不存在时返回真</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=c># 上述内容都是在ansible主机中判断的,和远端目标主机无关</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>when</span><span class=p>:</span><span class=w> </span><span class=l>testpath is exists</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div></div><p>2,判断变量的一些tests</p><ul><li>defined: 判断变量是否已经定义，已经定义则返回真</li><li>undefined: 判断变量是否已经定义，未定义则返回真</li><li>none: 判断变量值是否为空，如果变量已经定义，但是变量值为空，则返回真</li><li>上述内容,如下示例:</li></ul><div class=highlight><div class=chroma><div class=table-container><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-yaml data-lang=yaml><span class=line><span class=cl><span class=nn>---</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span>- <span class=nt>hosts</span><span class=p>:</span><span class=w> </span><span class=l>me</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>remote_user</span><span class=p>:</span><span class=w> </span><span class=l>root</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>gather_facts</span><span class=p>:</span><span class=w> </span><span class=kc>no</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>vars</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>testvar</span><span class=p>:</span><span class=w> </span><span class=s2>&#34;test&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>testvar1</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>tasks</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span>- <span class=nt>debug</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>msg</span><span class=p>:</span><span class=w> </span><span class=s2>&#34;Variable is defined&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>when</span><span class=p>:</span><span class=w> </span><span class=l>testvar is defined</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span>- <span class=nt>debug</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>msg</span><span class=p>:</span><span class=w> </span><span class=s2>&#34;Variable is undefined&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>when</span><span class=p>:</span><span class=w> </span><span class=l>testvar2 is undefined</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span>- <span class=nt>debug</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>msg</span><span class=p>:</span><span class=w> </span><span class=s2>&#34;The variable is defined, but there is no value&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>when</span><span class=p>:</span><span class=w> </span><span class=l>testvar1 is none</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div></div><p>3,判断执行结果的一些tests</p><ul><li>success或者succeeded: 通过任务的返回信息判断任务的返回状态,任务执行成功则返回真</li><li>failure或者failed: 通过任务的返回信息判断任务的返回状态,任务执行失败则返回真</li><li>change后者changed: 通过任务的返回信息判断任务的返回状态,任务执行状态为changed则返回真</li><li>skip或者skipped: 通过任务的返回信息判断任务的返回状态,当任务没有满足执行条件,而被跳过执行时,则返回真</li><li>如下示例:</li></ul><div class=highlight><div class=chroma><div class=table-container><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-yaml data-lang=yaml><span class=line><span class=cl><span class=nn>---</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span>- <span class=nt>hosts</span><span class=p>:</span><span class=w> </span><span class=l>me</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>remote_user</span><span class=p>:</span><span class=w> </span><span class=l>liawne</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>gather_facts</span><span class=p>:</span><span class=w> </span><span class=kc>no</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>vars</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>doshell</span><span class=p>:</span><span class=w> </span><span class=s2>&#34;yes&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>tasks</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span>- <span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>execute</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>shell</span><span class=p>:</span><span class=w> </span><span class=l>cat /testdir/test</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>when</span><span class=p>:</span><span class=w> </span><span class=l>doshell == &#34;yes&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>register</span><span class=p>:</span><span class=w> </span><span class=l>retmsg</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>ignore_errors</span><span class=p>:</span><span class=w> </span><span class=kc>true</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span>- <span class=nt>debug</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>msg</span><span class=p>:</span><span class=w> </span><span class=s2>&#34;task success&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>when</span><span class=p>:</span><span class=w> </span><span class=l>retmsg is success</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span>- <span class=nt>debug</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>msg</span><span class=p>:</span><span class=w> </span><span class=s2>&#34;task failed&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>when</span><span class=p>:</span><span class=w> </span><span class=l>retmsg is failed</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span>- <span class=nt>debug</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>msg</span><span class=p>:</span><span class=w> </span><span class=s2>&#34;task skipped&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>when</span><span class=p>:</span><span class=w> </span><span class=l>retmsg is skip</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span>- <span class=nt>debug</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>msg</span><span class=p>:</span><span class=w> </span><span class=s2>&#34;task changed&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>when</span><span class=p>:</span><span class=w> </span><span class=l>retmsg is changed</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div></div><p>4,判断路径的一些tests</p><ul><li>注:如下tests的判断均针对于ansible主机中的路径,与目标主机无关</li><li>file : 判断路径是否是一个文件,如果路径是一个文件则返回真</li><li>directory :判断路径是否是一个目录,如果路径是一个目录则返回真</li><li>link :判断路径是否是一个软链接,如果路径是一个软链接则返回真</li><li>mount:判断路径是否是一个挂载点,如果路径是一个挂载点则返回真</li><li>exists:判断路径是否存在,如果路径存在则返回真</li><li>如下示例:</li></ul><div class=highlight><div class=chroma><div class=table-container><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-yaml data-lang=yaml><span class=line><span class=cl><span class=nn>---</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span>- <span class=nt>hosts</span><span class=p>:</span><span class=w> </span><span class=l>me</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>remote_user</span><span class=p>:</span><span class=w> </span><span class=l>liawne</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>gather_facts</span><span class=p>:</span><span class=w> </span><span class=kc>no</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>vars</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>testpath1</span><span class=p>:</span><span class=w> </span><span class=s2>&#34;/testdir/test&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>testpath2</span><span class=p>:</span><span class=w> </span><span class=s2>&#34;/testdir/&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>testpath3</span><span class=p>:</span><span class=w> </span><span class=s2>&#34;/testdir/testsoftlink&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>testpath4</span><span class=p>:</span><span class=w> </span><span class=s2>&#34;/testdir/testhardlink&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>testpath5</span><span class=p>:</span><span class=w> </span><span class=s2>&#34;/boot&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>tasks</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span>- <span class=nt>debug</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>msg</span><span class=p>:</span><span class=w> </span><span class=s2>&#34;file&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>when</span><span class=p>:</span><span class=w> </span><span class=l>testpath1 is file</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span>- <span class=nt>debug</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>msg</span><span class=p>:</span><span class=w> </span><span class=s2>&#34;directory&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>when</span><span class=p>:</span><span class=w> </span><span class=l>testpath2 is directory</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span>- <span class=nt>debug</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>msg</span><span class=p>:</span><span class=w> </span><span class=s2>&#34;link&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>when</span><span class=p>:</span><span class=w> </span><span class=l>testpath3 is link</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span>- <span class=nt>debug</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>msg</span><span class=p>:</span><span class=w> </span><span class=s2>&#34;link&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>when</span><span class=p>:</span><span class=w> </span><span class=l>testpath4 is link</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span>- <span class=nt>debug</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>msg</span><span class=p>:</span><span class=w> </span><span class=s2>&#34;mount&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>when</span><span class=p>:</span><span class=w> </span><span class=l>testpath5 is mount</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span>- <span class=nt>debug</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>msg</span><span class=p>:</span><span class=w> </span><span class=s2>&#34;exists&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>when</span><span class=p>:</span><span class=w> </span><span class=l>testpath1 is exists</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div></div><p>5,判断字符串的一些tests</p><ul><li>lower:判断包含字母的字符串中的字母是否是纯小写,字符串中的字母全部为小写则返回真</li><li>upper:判断包含字母的字符串中的字母是否是纯大写,字符串中的字母全部为大写则返回真</li><li>如下示例:</li></ul><div class=highlight><div class=chroma><div class=table-container><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-yaml data-lang=yaml><span class=line><span class=cl><span class=nn>---</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span>- <span class=nt>hosts</span><span class=p>:</span><span class=w> </span><span class=l>me</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>remote_user</span><span class=p>:</span><span class=w> </span><span class=l>liawne</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>gather_facts</span><span class=p>:</span><span class=w> </span><span class=kc>no</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>vars</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>str1</span><span class=p>:</span><span class=w> </span><span class=s2>&#34;abc&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>str2</span><span class=p>:</span><span class=w> </span><span class=s2>&#34;ABC&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>tasks</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span>- <span class=nt>debug</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>msg</span><span class=p>:</span><span class=w> </span><span class=s2>&#34;This string is all lowercase&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>when</span><span class=p>:</span><span class=w> </span><span class=l>str1 is lower</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span>- <span class=nt>debug</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>msg</span><span class=p>:</span><span class=w> </span><span class=s2>&#34;This string is all uppercase&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>when</span><span class=p>:</span><span class=w> </span><span class=l>str2 is upper</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div></div><p>6,判断整除的一些tests</p><ul><li>even :判断数值是否是偶数,是偶数则返回真</li><li>odd :判断数值是否是奇数,是奇数则返回真</li><li>divisibleby(num) :判断是否可以整除指定的数值,如果除以指定的值以后余数为0，则返回真</li><li>如下示例:</li></ul><div class=highlight><div class=chroma><div class=table-container><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-yaml data-lang=yaml><span class=line><span class=cl><span class=nn>---</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span>- <span class=nt>hosts</span><span class=p>:</span><span class=w> </span><span class=l>me</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>remote_user</span><span class=p>:</span><span class=w> </span><span class=l>liawne</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>gather_facts</span><span class=p>:</span><span class=w> </span><span class=kc>no</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>vars</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>num1</span><span class=p>:</span><span class=w> </span><span class=m>4</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>num2</span><span class=p>:</span><span class=w> </span><span class=m>7</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>num3</span><span class=p>:</span><span class=w> </span><span class=m>64</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>tasks</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span>- <span class=nt>debug</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>msg</span><span class=p>:</span><span class=w> </span><span class=s2>&#34;An even number&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>when</span><span class=p>:</span><span class=w> </span><span class=l>num1 is even</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span>- <span class=nt>debug</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>msg</span><span class=p>:</span><span class=w> </span><span class=s2>&#34;An odd number&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>when</span><span class=p>:</span><span class=w> </span><span class=l>num2 is odd</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span>- <span class=nt>debug</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>msg</span><span class=p>:</span><span class=w> </span><span class=s2>&#34;Can be divided exactly by&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>when</span><span class=p>:</span><span class=w> </span><span class=l>num3 is divisibleby(8)</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div></div><p>7,其他一些tests</p><ul><li>version:可以用于对比两个版本号的大小,或者与指定的版本号进行对比，使用语法为 version(‘版本号', ‘比较操作符')</li></ul><div class=highlight><div class=chroma><div class=table-container><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-yaml data-lang=yaml><span class=line><span class=cl><span class=nn>---</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span>- <span class=nt>hosts</span><span class=p>:</span><span class=w> </span><span class=l>me</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>remote_user</span><span class=p>:</span><span class=w> </span><span class=l>liawne</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>vars</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>ver</span><span class=p>:</span><span class=w> </span><span class=m>7.4.1708</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>ver1</span><span class=p>:</span><span class=w> </span><span class=m>7.4.1707</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>tasks</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span>- <span class=nt>debug</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>msg</span><span class=p>:</span><span class=w> </span><span class=s2>&#34;This message can be displayed when the ver is greater than ver1&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>when</span><span class=p>:</span><span class=w> </span><span class=l>ver is version(ver1,&#34;&gt;&#34;)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span>- <span class=nt>debug</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>msg</span><span class=p>:</span><span class=w> </span><span class=s2>&#34;system version {{ansible_distribution_version}} greater than 7.3&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>when</span><span class=p>:</span><span class=w> </span><span class=l>ansible_distribution_version is version(&#34;7.3&#34;,&#34;gt&#34;)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=c># ”&gt;”与”gt”都表示”大于”,当使用version时，支持多种风格的比较操作符，你可以根据自己的使用习惯进行选择，version支持的比较操作符如下</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=c># 大于:&gt;, gt</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=c># 大于等于:&gt;=, ge</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=c># 小于:&lt;, lt</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=c># 小于等于:&lt;=, le</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=c># 等于: ==, =, eq</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=c># 不等于:!=, &lt;&gt;, ne</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div></div><ul><li>subset:判断一个list是不是另一个list的子集,是另一个list的子集时返回真</li><li>superset : 判断一个list是不是另一个list的父集,是另一个list的父集时返回真</li></ul><div class=highlight><div class=chroma><div class=table-container><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-yaml data-lang=yaml><span class=line><span class=cl><span class=nn>---</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span>- <span class=nt>hosts</span><span class=p>:</span><span class=w> </span><span class=l>me</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>remote_user</span><span class=p>:</span><span class=w> </span><span class=l>liawne</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>gather_facts</span><span class=p>:</span><span class=w> </span><span class=kc>no</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>vars</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>a</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span>- <span class=m>2</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span>- <span class=m>5</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>b</span><span class=p>:</span><span class=w> </span><span class=p>[</span><span class=m>1</span><span class=p>,</span><span class=m>2</span><span class=p>,</span><span class=m>3</span><span class=p>,</span><span class=m>4</span><span class=p>,</span><span class=m>5</span><span class=p>]</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>tasks</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span>- <span class=nt>debug</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>msg</span><span class=p>:</span><span class=w> </span><span class=s2>&#34;A is a subset of B&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>when</span><span class=p>:</span><span class=w> </span><span class=l>a is subset(b)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span>- <span class=nt>debug</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>msg</span><span class=p>:</span><span class=w> </span><span class=s2>&#34;B is the parent set of A&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>when</span><span class=p>:</span><span class=w> </span><span class=l>b is superset(a)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=c># 注:2.5版本中上述两个tests从issubset和issuperset更名为subset和superset</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div></div><ul><li>string:判断对象是否是一个字符串,是字符串则返回真</li></ul><div class=highlight><div class=chroma><div class=table-container><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-yaml data-lang=yaml><span class=line><span class=cl><span class=nn>---</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span>- <span class=nt>hosts</span><span class=p>:</span><span class=w> </span><span class=l>me</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>remote_user</span><span class=p>:</span><span class=w> </span><span class=l>liawne</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>gather_facts</span><span class=p>:</span><span class=w> </span><span class=kc>no</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>vars</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>testvar1</span><span class=p>:</span><span class=w> </span><span class=m>1</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>testvar2</span><span class=p>:</span><span class=w> </span><span class=s2>&#34;1&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>testvar3</span><span class=p>:</span><span class=w> </span><span class=l>a</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>tasks</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span>- <span class=nt>debug</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>msg</span><span class=p>:</span><span class=w> </span><span class=s2>&#34;This variable is a string&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>when</span><span class=p>:</span><span class=w> </span><span class=l>testvar1 is string</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span>- <span class=nt>debug</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>msg</span><span class=p>:</span><span class=w> </span><span class=s2>&#34;This variable is a string&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>when</span><span class=p>:</span><span class=w> </span><span class=l>testvar2 is string</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span>- <span class=nt>debug</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>msg</span><span class=p>:</span><span class=w> </span><span class=s2>&#34;This variable is a string&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>when</span><span class=p>:</span><span class=w> </span><span class=l>testvar3 is string</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=c># 上例playbook中只有testvar2和testvar3会被判断成字符串,testvar1不会</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div></div><ul><li>number:判断对象是否是一个数字,是数字则返回真</li></ul><div class=highlight><div class=chroma><div class=table-container><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-yaml data-lang=yaml><span class=line><span class=cl><span class=nn>---</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span>- <span class=nt>hosts</span><span class=p>:</span><span class=w> </span><span class=l>me</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>remote_user</span><span class=p>:</span><span class=w> </span><span class=l>liawne</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>gather_facts</span><span class=p>:</span><span class=w> </span><span class=kc>no</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>vars</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>testvar1</span><span class=p>:</span><span class=w> </span><span class=m>1</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>testvar2</span><span class=p>:</span><span class=w> </span><span class=s2>&#34;1&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>testvar3</span><span class=p>:</span><span class=w> </span><span class=m>00.20</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>tasks</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span>- <span class=nt>debug</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>msg</span><span class=p>:</span><span class=w> </span><span class=s2>&#34;This variable is number&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>when</span><span class=p>:</span><span class=w> </span><span class=l>testvar1 is number</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span>- <span class=nt>debug</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>msg</span><span class=p>:</span><span class=w> </span><span class=s2>&#34;This variable is a number&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>when</span><span class=p>:</span><span class=w> </span><span class=l>testvar2 is number</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span>- <span class=nt>debug</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>msg</span><span class=p>:</span><span class=w> </span><span class=s2>&#34;This variable is a number&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>when</span><span class=p>:</span><span class=w> </span><span class=l>testvar3 is number</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w> </span><span class=c># 上例playbook中只有testvar1和testvar3会被判断成数字,testvar2不会</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div></div><h2 id=条件判断与block><a href=#条件判断与block class=anchor-link><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512" class="icon anchor-icon"><path d="M326.612 185.391c59.747 59.809 58.927 155.698.36 214.59-.11.12-.24.25-.36.37l-67.2 67.2c-59.27 59.27-155.699 59.262-214.96.0-59.27-59.26-59.27-155.7.0-214.96l37.106-37.106c9.84-9.84 26.786-3.3 27.294 10.606.648 17.722 3.826 35.527 9.69 52.721 1.986 5.822.567 12.262-3.783 16.612l-13.087 13.087c-28.026 28.026-28.905 73.66-1.155 101.96 28.024 28.579 74.086 28.749 102.325.51l67.2-67.19c28.191-28.191 28.073-73.757.0-101.83-3.701-3.694-7.429-6.564-10.341-8.569a16.037 16.037.0 01-6.947-12.606c-.396-10.567 3.348-21.456 11.698-29.806l21.054-21.055c5.521-5.521 14.182-6.199 20.584-1.731a152.482 152.482.0 0120.522 17.197zM467.547 44.449c-59.261-59.262-155.69-59.27-214.96.0l-67.2 67.2c-.12.12-.25.25-.36.37-58.566 58.892-59.387 154.781.36 214.59a152.454 152.454.0 0020.521 17.196c6.402 4.468 15.064 3.789 20.584-1.731l21.054-21.055c8.35-8.35 12.094-19.239 11.698-29.806a16.037 16.037.0 00-6.947-12.606c-2.912-2.005-6.64-4.875-10.341-8.569-28.073-28.073-28.191-73.639.0-101.83l67.2-67.19c28.239-28.239 74.3-28.069 102.325.51 27.75 28.3 26.872 73.934-1.155 101.96l-13.087 13.087c-4.35 4.35-5.769 10.79-3.783 16.612 5.864 17.194 9.042 34.999 9.69 52.721.509 13.906 17.454 20.446 27.294 10.606l37.106-37.106c59.271-59.259 59.271-155.699.001-214.959z"/></svg></a><a href=#contents:条件判断与block class=headings>#条件判断与block</a></h2><p>1,在ansible中,可以使用"block"关键字将多个任务整合成一个"块",这个"块"将被当做一个整体,我们可以对这个"块"添加判断条件,当条件成立时,则执行这个块中的所有任务</p><ul><li>如下示例:</li></ul><div class=highlight><div class=chroma><div class=table-container><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-yaml data-lang=yaml><span class=line><span class=cl><span class=nn>---</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span>- <span class=nt>hosts</span><span class=p>:</span><span class=w> </span><span class=l>me</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>remote_user</span><span class=p>:</span><span class=w> </span><span class=l>root</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>tasks</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span>- <span class=nt>debug</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>msg</span><span class=p>:</span><span class=w> </span><span class=s2>&#34;task1 not in block&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span>- <span class=nt>block</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span>- <span class=nt>debug</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>          </span><span class=nt>msg</span><span class=p>:</span><span class=w> </span><span class=s2>&#34;task2 in block1&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span>- <span class=nt>debug</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>          </span><span class=nt>msg</span><span class=p>:</span><span class=w> </span><span class=s2>&#34;task3 in block1&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>when</span><span class=p>:</span><span class=w> </span><span class=m>2</span><span class=w> </span><span class=l>&gt; 1</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div></div><p>2,block用在错误处理的场景下</p><ul><li>之前的方式如下:</li></ul><div class=highlight><div class=chroma><div class=table-container><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-yaml data-lang=yaml><span class=line><span class=cl><span class=nn>---</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span>- <span class=nt>hosts</span><span class=p>:</span><span class=w> </span><span class=l>me</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>remote_user</span><span class=p>:</span><span class=w> </span><span class=l>root</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>tasks</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span>- <span class=nt>shell</span><span class=p>:</span><span class=w> </span><span class=s1>&#39;ls /ooo&#39;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>register</span><span class=p>:</span><span class=w> </span><span class=l>return_value</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>ignore_errors</span><span class=p>:</span><span class=w> </span><span class=kc>true</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=c># 通过注册变量,且忽略错误(ignore_errors)来做分支判断</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span>- <span class=nt>debug</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>msg</span><span class=p>:</span><span class=w> </span><span class=s2>&#34;I cought an error&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>when</span><span class=p>:</span><span class=w> </span><span class=l>return_value is failed</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div></div><ul><li>使用block+rescue的方式</li></ul><div class=highlight><div class=chroma><div class=table-container><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-yaml data-lang=yaml><span class=line><span class=cl><span class=nn>---</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span>- <span class=nt>hosts</span><span class=p>:</span><span class=w> </span><span class=l>me</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>remote_user</span><span class=p>:</span><span class=w> </span><span class=l>root</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>tasks</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span>- <span class=nt>block</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span>- <span class=nt>shell</span><span class=p>:</span><span class=w> </span><span class=s1>&#39;ls /ooo&#39;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=c># rescue直接承接上面的block,当block中的内容出现错误时,执行rescue中的内容</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=c># rescue关键字与block关键字对齐,rescue的字面意思为&#34;救援&#34;,表示当block中的任务执行失败时,会执行rescue中的任务进行补救</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=c># rescue中的内容由自己定义</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>rescue</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span>- <span class=nt>debug</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>          </span><span class=nt>msg</span><span class=p>:</span><span class=w> </span><span class=s1>&#39;I caught an error&#39;</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div></div><ul><li>block的优势,如下示例:</li></ul><div class=highlight><div class=chroma><div class=table-container><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-yaml data-lang=yaml><span class=line><span class=cl><span class=nn>---</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span>- <span class=nt>hosts</span><span class=p>:</span><span class=w> </span><span class=l>me</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>remote_user</span><span class=p>:</span><span class=w> </span><span class=l>root</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>tasks</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span>- <span class=nt>block</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=c># block可以接多个任务,任何一个任务出错,都会执行rescue中的任务,所以通常使用block和rescue结合,完成&#34;错误捕捉,报出异常&#34;的功能</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=c># 不仅block中可以有多个任务,rescue中也可以定义多个任务,当block中的任何一个任务出错时,会按照顺序执行rescue中的任务.</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span>- <span class=nt>shell</span><span class=p>:</span><span class=w> </span><span class=s1>&#39;ls /opt&#39;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span>- <span class=nt>shell</span><span class=p>:</span><span class=w> </span><span class=s1>&#39;ls /testdir&#39;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span>- <span class=nt>shell</span><span class=p>:</span><span class=w> </span><span class=s1>&#39;ls /c&#39;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>rescue</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span>- <span class=nt>debug</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>          </span><span class=nt>msg</span><span class=p>:</span><span class=w> </span><span class=s1>&#39;I caught an error&#39;</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div></div><ul><li>block+rescue+always的使用示例:</li></ul><div class=highlight><div class=chroma><div class=table-container><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-yaml data-lang=yaml><span class=line><span class=cl><span class=c># 还能再加入always关键字,加入always关键字以后,无论block中的任务执行成功还是失败,always中的任务都会被执行</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nn>---</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span>- <span class=nt>hosts</span><span class=p>:</span><span class=w> </span><span class=l>me</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>remote_user</span><span class=p>:</span><span class=w> </span><span class=l>root</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>tasks</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span>- <span class=nt>block</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span>- <span class=nt>debug</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>          </span><span class=nt>msg</span><span class=p>:</span><span class=w> </span><span class=s1>&#39;I execute normally&#39;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span>- <span class=nt>command</span><span class=p>:</span><span class=w> </span><span class=l>/bin/false</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span>- <span class=nt>debug</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>          </span><span class=nt>msg</span><span class=p>:</span><span class=w> </span><span class=s1>&#39;I never execute, due to the above task failing&#39;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>rescue</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span>- <span class=nt>debug</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>          </span><span class=nt>msg</span><span class=p>:</span><span class=w> </span><span class=s1>&#39;I caught an error&#39;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span>- <span class=nt>command</span><span class=p>:</span><span class=w> </span><span class=l>/bin/false</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span>- <span class=nt>debug</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>          </span><span class=nt>msg</span><span class=p>:</span><span class=w> </span><span class=s1>&#39;I also never execute&#39;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>always</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span>- <span class=nt>debug</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>          </span><span class=nt>msg</span><span class=p>:</span><span class=w> </span><span class=s2>&#34;This always executes&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=c># 如上例所示,block中有多个任务,rescue中也有多个任务,上例中故意执行&#34;/bin/false&#34;命令,模拟任务出错的情况,当block中的&#39;/bin/false&#39;执行后,其后的debug任务将不会被执行,因为&#39;/bin/false&#39;模拟出错,出错后直接执行rescue中的任务,在执行rescue中的任务时,会先输出 ‘I caught an error&#39;,然后又在rescue中使用&#39;/bin/false&#39;模拟出错的情况,出错后之后的debug任务不会被执行,直接执行always中的任务,always中的任务一定会被执行,无论block中的任务是否出错</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div></div><h2 id=条件判断与错误处理><a href=#条件判断与错误处理 class=anchor-link><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512" class="icon anchor-icon"><path d="M326.612 185.391c59.747 59.809 58.927 155.698.36 214.59-.11.12-.24.25-.36.37l-67.2 67.2c-59.27 59.27-155.699 59.262-214.96.0-59.27-59.26-59.27-155.7.0-214.96l37.106-37.106c9.84-9.84 26.786-3.3 27.294 10.606.648 17.722 3.826 35.527 9.69 52.721 1.986 5.822.567 12.262-3.783 16.612l-13.087 13.087c-28.026 28.026-28.905 73.66-1.155 101.96 28.024 28.579 74.086 28.749 102.325.51l67.2-67.19c28.191-28.191 28.073-73.757.0-101.83-3.701-3.694-7.429-6.564-10.341-8.569a16.037 16.037.0 01-6.947-12.606c-.396-10.567 3.348-21.456 11.698-29.806l21.054-21.055c5.521-5.521 14.182-6.199 20.584-1.731a152.482 152.482.0 0120.522 17.197zM467.547 44.449c-59.261-59.262-155.69-59.27-214.96.0l-67.2 67.2c-.12.12-.25.25-.36.37-58.566 58.892-59.387 154.781.36 214.59a152.454 152.454.0 0020.521 17.196c6.402 4.468 15.064 3.789 20.584-1.731l21.054-21.055c8.35-8.35 12.094-19.239 11.698-29.806a16.037 16.037.0 00-6.947-12.606c-2.912-2.005-6.64-4.875-10.341-8.569-28.073-28.073-28.191-73.639.0-101.83l67.2-67.19c28.239-28.239 74.3-28.069 102.325.51 27.75 28.3 26.872 73.934-1.155 101.96l-13.087 13.087c-4.35 4.35-5.769 10.79-3.783 16.612 5.864 17.194 9.042 34.999 9.69 52.721.509 13.906 17.454 20.446 27.294 10.606l37.106-37.106c59.271-59.259 59.271-155.699.001-214.959z"/></svg></a><a href=#contents:条件判断与错误处理 class=headings>#条件判断与错误处理</a></h2><p>1,使用fail模块来处理出错</p><ul><li>如下示例:</li></ul><div class=highlight><div class=chroma><div class=table-container><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-yaml data-lang=yaml><span class=line><span class=cl><span class=nn>---</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span>- <span class=nt>hosts</span><span class=p>:</span><span class=w> </span><span class=l>me</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>remote_user</span><span class=p>:</span><span class=w> </span><span class=l>root</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>tasks</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span>- <span class=nt>shell</span><span class=p>:</span><span class=w> </span><span class=s2>&#34;echo &#39;This is a string for testing--error&#39;&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>register</span><span class=p>:</span><span class=w> </span><span class=l>return_value</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span>- <span class=nt>fail</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>msg</span><span class=p>:</span><span class=w> </span><span class=s2>&#34;Conditions established,Interrupt running playbook&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>when</span><span class=p>:</span><span class=w> </span><span class=s2>&#34;&#39;error&#39; in return_value.stdout&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span>- <span class=nt>debug</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>msg</span><span class=p>:</span><span class=w> </span><span class=s2>&#34;I never execute,Because the playbook has stopped&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=c># a, 当使用&#34;in&#34;或者&#34;not in&#34;进行条件判断时,整个条件需要用引号引起,并且,需要判断的字符串也需要使用引号引起,所以,使用&#39;in&#39;或者&#39;not in&#39;进行条件判断时,如下两种语法是正确的:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=c># when: &#39; &#34;successful&#34; not in return_value.stdout &#39;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=c># when: &#34; &#39;successful&#39; not in return_value.stdout &#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=c># b,fail可以单独使用,不加msg和when,效果是直接报错</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div></div><p>2,使用failed_when</p><ul><li>'failed_when'的作用就是,当对应的条件成立时,将对应任务的执行状态设置为失败</li></ul><div class=highlight><div class=chroma><div class=table-container><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-yaml data-lang=yaml><span class=line><span class=cl><span class=nn>---</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span>- <span class=nt>hosts</span><span class=p>:</span><span class=w> </span><span class=l>me</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>remote_user</span><span class=p>:</span><span class=w> </span><span class=l>root</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>tasks</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span>- <span class=nt>debug</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>msg</span><span class=p>:</span><span class=w> </span><span class=s2>&#34;I execute normally&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span>- <span class=nt>shell</span><span class=p>:</span><span class=w> </span><span class=s2>&#34;echo &#39;This is a string for testing error&#39;&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>register</span><span class=p>:</span><span class=w> </span><span class=l>return_value</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>failed_when</span><span class=p>:</span><span class=w> </span><span class=s1>&#39; &#34;error&#34; in return_value.stdout&#39;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span>- <span class=nt>debug</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>msg</span><span class=p>:</span><span class=w> </span><span class=s2>&#34;I never execute,Because the playbook has stopped&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=c># &#39;failed_when&#39;关键字与shell关键字对齐,表示其对应的条件是针对shell模块的,&#39;failed_when&#39;对应的条件是 ‘ “error&#34; in return_value.stdout&#39;,表示&#34;error&#34;字符串如果存在于shell模块执行后的标准输出中,则条件成立,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=c># 当条件成立后,shell模块的执行状态将会被设置为失败,由于shell模块的执行状态被设置为失败,所以playbook会终止运行,于是,最后的debug模块并不会被执行</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=c># &#39;failed_when&#39;虽然会将任务的执行状态设置为失败,但并不代表任务真的失败了,以上例来说,shell模块的确是完全正常的执行了,只不过在执行之后,&#39; failed_when&#39;对应的条件成立了,&#39; failed_when&#39;将shell模块的执行状态设置为失败而已</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div></div><p>3,使用changed_when</p><ul><li>‘changed_when'关键字的作用是在条件成立时,将对应任务的执行状态设置为changed</li></ul><div class=highlight><div class=chroma><div class=table-container><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span><span class=lnt>7
</span><span class=lnt>8
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-yaml data-lang=yaml><span class=line><span class=cl><span class=nn>---</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span>- <span class=nt>hosts</span><span class=p>:</span><span class=w> </span><span class=l>me</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>remote_user</span><span class=p>:</span><span class=w> </span><span class=l>root</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>tasks</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span>- <span class=nt>debug</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>msg</span><span class=p>:</span><span class=w> </span><span class=s2>&#34;test message&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>changed_when</span><span class=p>:</span><span class=w> </span><span class=m>2</span><span class=w> </span><span class=l>&gt; 1</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=c># debug模块在正常执行的情况下只能是&#34;ok&#34;状态,上例中,我们使用&#39;changed_when&#39;关键字将debug模块的执行后的状态定义为了&#34;changed&#34;</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div></div><ul><li>与handler结合使用</li></ul><div class=highlight><div class=chroma><div class=table-container><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-yaml data-lang=yaml><span class=line><span class=cl><span class=c># 只有任务作出了实际的操作时（执行后状态为changed）,才会真正的执行对应的handlers</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=c># 而在某些时候,如果想要通过任务执行后的返回值将任务的最终执行状态判定为changed,则可以使用&#39;changed_when&#39;关键字,以便条件成立时,可以执行对应的handlers,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=c># &#39;changed_when&#39;除了能够在条件成立时将任务的执行状态设置为&#34;changed&#34;,还能让对应的任务永远不能是changed状态,示例如下:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nn>---</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span>- <span class=nt>hosts</span><span class=p>:</span><span class=w> </span><span class=l>me</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>remote_user</span><span class=p>:</span><span class=w> </span><span class=l>root</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>tasks</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span>- <span class=nt>shell</span><span class=p>:</span><span class=w> </span><span class=s2>&#34;ls /opt&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>changed_when</span><span class=p>:</span><span class=w> </span><span class=kc>false</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=c># 当将&#39;changed_when&#39;直接设置为false时,对应任务的状态将不会被设置为&#39;changed&#39;,如果任务原本的执行状态为&#39;changed&#39;,最终则会被设置为&#39;ok&#39;,所以,上例playbook执行后,shell模块的执行状态最终为&#39;ok&#39;</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div></div><h2 id=过滤器><a href=#过滤器 class=anchor-link><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512" class="icon anchor-icon"><path d="M326.612 185.391c59.747 59.809 58.927 155.698.36 214.59-.11.12-.24.25-.36.37l-67.2 67.2c-59.27 59.27-155.699 59.262-214.96.0-59.27-59.26-59.27-155.7.0-214.96l37.106-37.106c9.84-9.84 26.786-3.3 27.294 10.606.648 17.722 3.826 35.527 9.69 52.721 1.986 5.822.567 12.262-3.783 16.612l-13.087 13.087c-28.026 28.026-28.905 73.66-1.155 101.96 28.024 28.579 74.086 28.749 102.325.51l67.2-67.19c28.191-28.191 28.073-73.757.0-101.83-3.701-3.694-7.429-6.564-10.341-8.569a16.037 16.037.0 01-6.947-12.606c-.396-10.567 3.348-21.456 11.698-29.806l21.054-21.055c5.521-5.521 14.182-6.199 20.584-1.731a152.482 152.482.0 0120.522 17.197zM467.547 44.449c-59.261-59.262-155.69-59.27-214.96.0l-67.2 67.2c-.12.12-.25.25-.36.37-58.566 58.892-59.387 154.781.36 214.59a152.454 152.454.0 0020.521 17.196c6.402 4.468 15.064 3.789 20.584-1.731l21.054-21.055c8.35-8.35 12.094-19.239 11.698-29.806a16.037 16.037.0 00-6.947-12.606c-2.912-2.005-6.64-4.875-10.341-8.569-28.073-28.073-28.191-73.639.0-101.83l67.2-67.19c28.239-28.239 74.3-28.069 102.325.51 27.75 28.3 26.872 73.934-1.155 101.96l-13.087 13.087c-4.35 4.35-5.769 10.79-3.783 16.612 5.864 17.194 9.042 34.999 9.69 52.721.509 13.906 17.454 20.446 27.294 10.606l37.106-37.106c59.271-59.259 59.271-155.699.001-214.959z"/></svg></a><a href=#contents:过滤器 class=headings>#过滤器</a></h2><p>1,过滤器是一种能够帮助我们处理数据的工具,其实,ansible中的过滤器功能来自于jinja2模板引擎</p><p>2,过滤器有些是jinja2内置的,有些是ansible特有的,如果这些过滤器都不能满足你的需求,jinja2也支持自定义过滤器</p><p>3,一些常见的过滤器</p><ul><li>字符串相关</li></ul><div class=highlight><div class=chroma><div class=table-container><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span><span class=lnt>32
</span><span class=lnt>33
</span><span class=lnt>34
</span><span class=lnt>35
</span><span class=lnt>36
</span><span class=lnt>37
</span><span class=lnt>38
</span><span class=lnt>39
</span><span class=lnt>40
</span><span class=lnt>41
</span><span class=lnt>42
</span><span class=lnt>43
</span><span class=lnt>44
</span><span class=lnt>45
</span><span class=lnt>46
</span><span class=lnt>47
</span><span class=lnt>48
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-yaml data-lang=yaml><span class=line><span class=cl><span class=nn>---</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span>- <span class=nt>hosts</span><span class=p>:</span><span class=w> </span><span class=l>me</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>remote_user</span><span class=p>:</span><span class=w> </span><span class=l>root</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>vars</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>testvar</span><span class=p>:</span><span class=w> </span><span class=s2>&#34;abc123ABC 666&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>testvar1</span><span class=p>:</span><span class=w> </span><span class=s2>&#34;  abc  &#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>testvar2</span><span class=p>:</span><span class=w> </span><span class=s1>&#39;123456789&#39;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>testvar3</span><span class=p>:</span><span class=w> </span><span class=s2>&#34;1a2b,@#$%^&amp;&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>tasks</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span>- <span class=nt>debug</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=c>#将字符串转换成纯大写</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>msg</span><span class=p>:</span><span class=w> </span><span class=s2>&#34;{{ testvar | upper }}&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span>- <span class=nt>debug</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=c>#将字符串转换成纯小写</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>msg</span><span class=p>:</span><span class=w> </span><span class=s2>&#34;{{ testvar | lower }}&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span>- <span class=nt>debug</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=c>#将字符串变成首字母大写,之后所有字母纯小写</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>msg</span><span class=p>:</span><span class=w> </span><span class=s2>&#34;{{ testvar | capitalize }}&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span>- <span class=nt>debug</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=c>#将字符串反转</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>msg</span><span class=p>:</span><span class=w> </span><span class=s2>&#34;{{ testvar | reverse }}&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span>- <span class=nt>debug</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=c>#返回字符串的第一个字符</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>msg</span><span class=p>:</span><span class=w> </span><span class=s2>&#34;{{ testvar | first }}&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span>- <span class=nt>debug</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=c>#返回字符串的最后一个字符</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>msg</span><span class=p>:</span><span class=w> </span><span class=s2>&#34;{{ testvar | last }}&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span>- <span class=nt>debug</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=c>#将字符串开头和结尾的空格去除</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>msg</span><span class=p>:</span><span class=w> </span><span class=s2>&#34;{{ testvar1 | trim }}&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span>- <span class=nt>debug</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=c>#将字符串放在中间,并且设置字符串的长度为30,字符串两边用空格补齐30位长</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>msg</span><span class=p>:</span><span class=w> </span><span class=s2>&#34;{{ testvar1 | center(width=30) }}&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span>- <span class=nt>debug</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=c>#返回字符串长度,length与count等效,可以写为count</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>msg</span><span class=p>:</span><span class=w> </span><span class=s2>&#34;{{ testvar2 | length }}&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span>- <span class=nt>debug</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=c>#将字符串转换成列表,每个字符作为一个元素</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>msg</span><span class=p>:</span><span class=w> </span><span class=s2>&#34;{{ testvar3 | list }}&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span>- <span class=nt>debug</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=c>#将字符串转换成列表,每个字符作为一个元素,并且随机打乱顺序</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=c>#shuffle的字面意思为洗牌</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>msg</span><span class=p>:</span><span class=w> </span><span class=s2>&#34;{{ testvar3 | shuffle }}&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span>- <span class=nt>debug</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=c>#将字符串转换成列表,每个字符作为一个元素,并且随机打乱顺序</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=c>#在随机打乱顺序时,将ansible_date_time.epoch的值设置为随机种子</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=c>#也可以使用其他值作为随机种子,ansible_date_time.epoch是facts信息</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>msg</span><span class=p>:</span><span class=w> </span><span class=s2>&#34;{{ testvar3 | shuffle(seed=(ansible_date_time.epoch)) }}&#34;</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div></div><ul><li>数字相关</li></ul><div class=highlight><div class=chroma><div class=table-container><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span><span class=lnt>32
</span><span class=lnt>33
</span><span class=lnt>34
</span><span class=lnt>35
</span><span class=lnt>36
</span><span class=lnt>37
</span><span class=lnt>38
</span><span class=lnt>39
</span><span class=lnt>40
</span><span class=lnt>41
</span><span class=lnt>42
</span><span class=lnt>43
</span><span class=lnt>44
</span><span class=lnt>45
</span><span class=lnt>46
</span><span class=lnt>47
</span><span class=lnt>48
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-yaml data-lang=yaml><span class=line><span class=cl><span class=nn>---</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span>- <span class=nt>hosts</span><span class=p>:</span><span class=w> </span><span class=l>me</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>remote_user</span><span class=p>:</span><span class=w> </span><span class=l>root</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>vars</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>testvar4</span><span class=p>:</span><span class=w> </span>-<span class=m>1</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>tasks</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span>- <span class=nt>debug</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=c>#将对应的值转换成int类型</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=c>#ansible中,字符串和整形不能直接计算,比如{{ 8+&#39;8&#39; }}会报错</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=c>#所以,我们可以把一个值为数字的字符串转换成整形后再做计算</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>msg</span><span class=p>:</span><span class=w> </span><span class=s2>&#34;{{ 8+(&#39;8&#39; | int) }}&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span>- <span class=nt>debug</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=c>#将对应的值转换成int类型,如果无法转换,默认返回0</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=c>#使用int(default=6)或者int(6)时,如果无法转换则返回指定值6</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>msg</span><span class=p>:</span><span class=w> </span><span class=s2>&#34;{{ &#39;a&#39; | int(default=6) }}&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span>- <span class=nt>debug</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=c>#将对应的值转换成浮点型,如果无法转换,默认返回&#39;0.0&#39;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>msg</span><span class=p>:</span><span class=w> </span><span class=s2>&#34;{{ &#39;8&#39; | float }}&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span>- <span class=nt>debug</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=c>#当对应的值无法被转换成浮点型时,则返回指定值&#39;8.8‘</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>msg</span><span class=p>:</span><span class=w> </span><span class=s2>&#34;{{ &#39;a&#39; | float(8.88) }}&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span>- <span class=nt>debug</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=c>#获取对应数值的绝对值</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>msg</span><span class=p>:</span><span class=w> </span><span class=s2>&#34;{{ testvar4 | abs }}&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span>- <span class=nt>debug</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=c>#四舍五入</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>msg</span><span class=p>:</span><span class=w> </span><span class=s2>&#34;{{ 12.5 | round }}&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span>- <span class=nt>debug</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=c>#取小数点后五位</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>msg</span><span class=p>:</span><span class=w> </span><span class=s2>&#34;{{ 3.1415926 | round(5) }}&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span>- <span class=nt>debug</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=c>#从0到100中随机返回一个随机数</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>msg</span><span class=p>:</span><span class=w> </span><span class=s2>&#34;{{ 100 | random }}&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span>- <span class=nt>debug</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=c>#从5到10中随机返回一个随机数</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>msg</span><span class=p>:</span><span class=w> </span><span class=s2>&#34;{{ 10 | random(start=5) }}&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span>- <span class=nt>debug</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=c>#从5到15中随机返回一个随机数,步长为3</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=c>#步长为3的意思是返回的随机数只有可能是5、8、11、14中的一个</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>msg</span><span class=p>:</span><span class=w> </span><span class=s2>&#34;{{ 15 | random(start=5,step=3) }}&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span>- <span class=nt>debug</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=c>#从0到15中随机返回一个随机数,这个随机数是5的倍数</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>msg</span><span class=p>:</span><span class=w> </span><span class=s2>&#34;{{ 15 | random(step=5) }}&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span>- <span class=nt>debug</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=c>#从0到15中随机返回一个随机数,并将ansible_date_time.epoch的值设置为随机种子</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=c>#也可以使用其他值作为随机种子,ansible_date_time.epoch是facts信息</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=c>#seed参数从ansible2.3版本开始可用</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>msg</span><span class=p>:</span><span class=w> </span><span class=s2>&#34;{{ 15 | random(seed=(ansible_date_time.epoch)) }}&#34;</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div></div><ul><li>列表相关</li></ul><div class=highlight><div class=chroma><div class=table-container><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span><span class=lnt>32
</span><span class=lnt>33
</span><span class=lnt>34
</span><span class=lnt>35
</span><span class=lnt>36
</span><span class=lnt>37
</span><span class=lnt>38
</span><span class=lnt>39
</span><span class=lnt>40
</span><span class=lnt>41
</span><span class=lnt>42
</span><span class=lnt>43
</span><span class=lnt>44
</span><span class=lnt>45
</span><span class=lnt>46
</span><span class=lnt>47
</span><span class=lnt>48
</span><span class=lnt>49
</span><span class=lnt>50
</span><span class=lnt>51
</span><span class=lnt>52
</span><span class=lnt>53
</span><span class=lnt>54
</span><span class=lnt>55
</span><span class=lnt>56
</span><span class=lnt>57
</span><span class=lnt>58
</span><span class=lnt>59
</span><span class=lnt>60
</span><span class=lnt>61
</span><span class=lnt>62
</span><span class=lnt>63
</span><span class=lnt>64
</span><span class=lnt>65
</span><span class=lnt>66
</span><span class=lnt>67
</span><span class=lnt>68
</span><span class=lnt>69
</span><span class=lnt>70
</span><span class=lnt>71
</span><span class=lnt>72
</span><span class=lnt>73
</span><span class=lnt>74
</span><span class=lnt>75
</span><span class=lnt>76
</span><span class=lnt>77
</span><span class=lnt>78
</span><span class=lnt>79
</span><span class=lnt>80
</span><span class=lnt>81
</span><span class=lnt>82
</span><span class=lnt>83
</span><span class=lnt>84
</span><span class=lnt>85
</span><span class=lnt>86
</span><span class=lnt>87
</span><span class=lnt>88
</span><span class=lnt>89
</span><span class=lnt>90
</span><span class=lnt>91
</span><span class=lnt>92
</span><span class=lnt>93
</span><span class=lnt>94
</span><span class=lnt>95
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-yaml data-lang=yaml><span class=line><span class=cl><span class=nn>---</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span>- <span class=nt>hosts</span><span class=p>:</span><span class=w> </span><span class=l>me</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>remote_user</span><span class=p>:</span><span class=w> </span><span class=l>root</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>vars</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>testvar7</span><span class=p>:</span><span class=w> </span><span class=p>[</span><span class=m>22</span><span class=p>,</span><span class=m>18</span><span class=p>,</span><span class=m>5</span><span class=p>,</span><span class=m>33</span><span class=p>,</span><span class=m>27</span><span class=p>,</span><span class=m>30</span><span class=p>]</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>testvar8</span><span class=p>:</span><span class=w> </span><span class=p>[</span><span class=m>1</span><span class=p>,[</span><span class=m>7</span><span class=p>,</span><span class=m>2</span><span class=p>,[</span><span class=m>15</span><span class=p>,</span><span class=m>9</span><span class=p>]],</span><span class=m>3</span><span class=p>,</span><span class=m>5</span><span class=p>]</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>testvar9</span><span class=p>:</span><span class=w> </span><span class=p>[</span><span class=m>1</span><span class=p>,</span><span class=s1>&#39;b&#39;</span><span class=p>,</span><span class=m>5</span><span class=p>]</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>testvar10</span><span class=p>:</span><span class=w> </span><span class=p>[</span><span class=m>1</span><span class=p>,</span><span class=s1>&#39;A&#39;</span><span class=p>,</span><span class=s1>&#39;b&#39;</span><span class=p>,[</span><span class=s1>&#39;QQ&#39;</span><span class=p>,</span><span class=s1>&#39;wechat&#39;</span><span class=p>],</span><span class=s1>&#39;CdEf&#39;</span><span class=p>]</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>testvar11</span><span class=p>:</span><span class=w> </span><span class=p>[</span><span class=s1>&#39;abc&#39;</span><span class=p>,</span><span class=m>1</span><span class=p>,</span><span class=m>3</span><span class=p>,</span><span class=s1>&#39;a&#39;</span><span class=p>,</span><span class=m>3</span><span class=p>,</span><span class=s1>&#39;1&#39;</span><span class=p>,</span><span class=s1>&#39;abc&#39;</span><span class=p>]</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>testvar12</span><span class=p>:</span><span class=w> </span><span class=p>[</span><span class=s1>&#39;abc&#39;</span><span class=p>,</span><span class=m>2</span><span class=p>,</span><span class=s1>&#39;a&#39;</span><span class=p>,</span><span class=s1>&#39;b&#39;</span><span class=p>,</span><span class=s1>&#39;a&#39;</span><span class=p>]</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>tasks</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span>- <span class=nt>debug</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=c>#返回列表长度,length与count等效,可以写为count</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>msg</span><span class=p>:</span><span class=w> </span><span class=s2>&#34;{{ testvar7 | length }}&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span>- <span class=nt>debug</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=c>#返回列表中的第一个值</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>msg</span><span class=p>:</span><span class=w> </span><span class=s2>&#34;{{ testvar7 | first }}&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span>- <span class=nt>debug</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=c>#返回列表中的最后一个值</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>msg</span><span class=p>:</span><span class=w> </span><span class=s2>&#34;{{ testvar7 | last }}&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span>- <span class=nt>debug</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=c>#返回列表中最小的值</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>msg</span><span class=p>:</span><span class=w> </span><span class=s2>&#34;{{ testvar7 | min }}&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span>- <span class=nt>debug</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=c>#返回列表中最大的值</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>msg</span><span class=p>:</span><span class=w> </span><span class=s2>&#34;{{ testvar7 | max }}&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span>- <span class=nt>debug</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=c>#将列表升序排序输出</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>msg</span><span class=p>:</span><span class=w> </span><span class=s2>&#34;{{ testvar7 | sort }}&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span>- <span class=nt>debug</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=c>#将列表降序排序输出</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>msg</span><span class=p>:</span><span class=w> </span><span class=s2>&#34;{{ testvar7 | sort(reverse=true) }}&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span>- <span class=nt>debug</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=c>#返回纯数字非嵌套列表中所有数字的和</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>msg</span><span class=p>:</span><span class=w> </span><span class=s2>&#34;{{ testvar7 | sum }}&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span>- <span class=nt>debug</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=c>#如果列表中包含列表,那么使用flatten可以&#39;拉平&#39;嵌套的列表</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=c>#2.5版本中可用,执行如下示例后查看效果</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>msg</span><span class=p>:</span><span class=w> </span><span class=s2>&#34;{{ testvar8 | flatten }}&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span>- <span class=nt>debug</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=c>#如果列表中嵌套了列表,那么将第1层的嵌套列表‘拉平&#39;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=c>#2.5版本中可用,执行如下示例后查看效果</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>msg</span><span class=p>:</span><span class=w> </span><span class=s2>&#34;{{ testvar8 | flatten(levels=1) }}&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span>- <span class=nt>debug</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=c>#过滤器都是可以自由结合使用的,就好像linux命令中的管道符一样</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=c>#如下,取出嵌套列表中的最大值</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>msg</span><span class=p>:</span><span class=w> </span><span class=s2>&#34;{{ testvar8 | flatten | max }}&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span>- <span class=nt>debug</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=c>#将列表中的元素合并成一个字符串</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>msg</span><span class=p>:</span><span class=w> </span><span class=s2>&#34;{{ testvar9 | join }}&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span>- <span class=nt>debug</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=c>#将列表中的元素合并成一个字符串,每个元素之间用指定的字符隔开</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>msg</span><span class=p>:</span><span class=w> </span><span class=s2>&#34;{{ testvar9 | join(&#39; , &#39;) }}&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span>- <span class=nt>debug</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=c>#从列表中随机返回一个元素</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=c>#对列表使用random过滤器时,不能使用start和step参数</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>msg</span><span class=p>:</span><span class=w> </span><span class=s2>&#34;{{ testvar9 | random }}&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span>- <span class=nt>debug</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=c>#从列表中随机返回一个元素,并将ansible_date_time.epoch的值设置为随机种子</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=c>#seed参数从ansible2.3版本开始可用</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>msg</span><span class=p>:</span><span class=w> </span><span class=s2>&#34;{{ testvar9 | random(seed=(ansible_date_time.epoch)) }}&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span>- <span class=nt>debug</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=c>#随机打乱顺序列表中元素的顺序</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=c>#shuffle的字面意思为洗牌</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>msg</span><span class=p>:</span><span class=w> </span><span class=s2>&#34;{{ testvar9 | shuffle }}&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span>- <span class=nt>debug</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=c>#随机打乱顺序列表中元素的顺序</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=c>#在随机打乱顺序时,将ansible_date_time.epoch的值设置为随机种子</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=c>#seed参数从ansible2.3版本开始可用</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>msg</span><span class=p>:</span><span class=w> </span><span class=s2>&#34;{{ testvar9 | shuffle(seed=(ansible_date_time.epoch)) }}&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span>- <span class=nt>debug</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=c>#将列表中的每个元素变成纯大写</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>msg</span><span class=p>:</span><span class=w> </span><span class=s2>&#34;{{ testvar10 | upper }}&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span>- <span class=nt>debug</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=c>#将列表中的每个元素变成纯小写</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>msg</span><span class=p>:</span><span class=w> </span><span class=s2>&#34;{{ testvar10 | lower }}&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span>- <span class=nt>debug</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=c>#去掉列表中重复的元素,重复的元素只留下一个</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>msg</span><span class=p>:</span><span class=w> </span><span class=s2>&#34;{{ testvar11 | unique }}&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span>- <span class=nt>debug</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=c>#将两个列表合并,重复的元素只留下一个</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=c>#也就是求两个列表的并集</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>msg</span><span class=p>:</span><span class=w> </span><span class=s2>&#34;{{ testvar11 | union(testvar12) }}&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span>- <span class=nt>debug</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=c>#取出两个列表的交集,重复的元素只留下一个</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>msg</span><span class=p>:</span><span class=w> </span><span class=s2>&#34;{{ testvar11 | intersect(testvar12) }}&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span>- <span class=nt>debug</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=c>#取出存在于testvar11列表中,但是不存在于testvar12列表中的元素</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=c>#去重后重复的元素只留下一个</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=c>#换句话说就是:两个列表的交集在列表1中的补集</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>msg</span><span class=p>:</span><span class=w> </span><span class=s2>&#34;{{ testvar11 | difference(testvar12) }}&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span>- <span class=nt>debug</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=c>#取出两个列表中各自独有的元素,重复的元素只留下一个</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=c>#即去除两个列表的交集,剩余的元素</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>msg</span><span class=p>:</span><span class=w> </span><span class=s2>&#34;{{ testvar11 | symmetric_difference(testvar12) }}&#34;</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div></div><ul><li>变量未定义时相关操作的过滤器</li></ul><div class=highlight><div class=chroma><div class=table-container><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-yaml data-lang=yaml><span class=line><span class=cl><span class=nn>---</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span>- <span class=nt>hosts</span><span class=p>:</span><span class=w> </span><span class=l>me</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>remote_user</span><span class=p>:</span><span class=w> </span><span class=l>root</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>gather_facts</span><span class=p>:</span><span class=w> </span><span class=kc>no</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>vars</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>testvar6</span><span class=p>:</span><span class=w> </span><span class=s1>&#39;&#39;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>tasks</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span>- <span class=nt>debug</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=c>#如果变量没有定义,则临时返回一个指定的默认值</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=c>#注:如果定义了变量,变量值为空字符串,则会输出空字符</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=c>#default过滤器的别名是d</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>msg</span><span class=p>:</span><span class=w> </span><span class=s2>&#34;{{ testvar5 | default(&#39;zsythink&#39;) }}&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span>- <span class=nt>debug</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=c>#如果变量的值是一个空字符串或者变量没有定义,则临时返回一个指定的默认值</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>msg</span><span class=p>:</span><span class=w> </span><span class=s2>&#34;{{ testvar6 | default(&#39;zsythink&#39;,boolean=true) }}&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span>- <span class=nt>debug</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=c>#如果对应的变量未定义,则报出“Mandatory variable not defined.&#34;错误,而不是报出默认错误</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>msg</span><span class=p>:</span><span class=w> </span><span class=s2>&#34;{{ testvar5 | mandatory }}&#34;</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div></div><p>4,上述使用到的default参数,default过滤器,还有一个很方便的用法,default过滤器不仅能在变量未定义时返回指定的值,还能够让模块的参数变得"可有可无"</p><ul><li>如下示例:</li></ul><div class=highlight><div class=chroma><div class=table-container><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span><span class=lnt>32
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-yaml data-lang=yaml><span class=line><span class=cl><span class=c># method one,循环了两次</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span>- <span class=nt>hosts</span><span class=p>:</span><span class=w> </span><span class=l>me</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>remote_user</span><span class=p>:</span><span class=w> </span><span class=l>root</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>gather_facts</span><span class=p>:</span><span class=w> </span><span class=kc>no</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>vars</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>paths</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span>- <span class=nt>path</span><span class=p>:</span><span class=w> </span><span class=l>/tmp/test</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nt>mode</span><span class=p>:</span><span class=w> </span><span class=s1>&#39;0444&#39;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span>- <span class=nt>path</span><span class=p>:</span><span class=w> </span><span class=l>/tmp/foo</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span>- <span class=nt>path</span><span class=p>:</span><span class=w> </span><span class=l>/tmp/bar</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>tasks</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span>- <span class=nt>file</span><span class=p>:</span><span class=w> </span><span class=l>dest={{item.path}} state=touch mode={{item.mode}}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>with_items</span><span class=p>:</span><span class=w> </span><span class=s2>&#34;{{ paths }}&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>when</span><span class=p>:</span><span class=w> </span><span class=l>item.mode is defined</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span>- <span class=nt>file</span><span class=p>:</span><span class=w> </span><span class=l>dest={{item.path}} state=touch</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>with_items</span><span class=p>:</span><span class=w> </span><span class=s2>&#34;{{ paths }}&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>when</span><span class=p>:</span><span class=w> </span><span class=l>item.mode is undefined</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=c># method two</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span>- <span class=nt>hosts</span><span class=p>:</span><span class=w> </span><span class=l>me</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>remote_user</span><span class=p>:</span><span class=w> </span><span class=l>root</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>gather_facts</span><span class=p>:</span><span class=w> </span><span class=kc>no</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>vars</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>paths</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span>- <span class=nt>path</span><span class=p>:</span><span class=w> </span><span class=l>/tmp/test</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nt>mode</span><span class=p>:</span><span class=w> </span><span class=s1>&#39;0444&#39;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span>- <span class=nt>path</span><span class=p>:</span><span class=w> </span><span class=l>/tmp/foo</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span>- <span class=nt>path</span><span class=p>:</span><span class=w> </span><span class=l>/tmp/bar</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>tasks</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span>- <span class=nt>file</span><span class=p>:</span><span class=w> </span><span class=l>dest={{item.path}} state=touch mode={{item.mode | default(omit)}}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>with_items</span><span class=p>:</span><span class=w> </span><span class=s2>&#34;{{ paths }}&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=c># 没有对文件是否有mode属性进行判断,而是直接调用了file模块的mode参数,将mode参数的值设定为了&#34;{{item.mode | default(omit)}}&#34;,这是什么意思呢？它的意思是,如果item有mode属性,就把file模块的mode参数的值设置为item的mode属性的值,如果item没有mode属性,file模块就直接省略mode参数,&#39;omit&#39;的字面意思就是&#34;省略&#34;,换成大白话说就是:[有就用,没有就不用,可以有,也可以没有]</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div></div><h2 id=变量六include_vars><a href=#变量六include_vars class=anchor-link><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512" class="icon anchor-icon"><path d="M326.612 185.391c59.747 59.809 58.927 155.698.36 214.59-.11.12-.24.25-.36.37l-67.2 67.2c-59.27 59.27-155.699 59.262-214.96.0-59.27-59.26-59.27-155.7.0-214.96l37.106-37.106c9.84-9.84 26.786-3.3 27.294 10.606.648 17.722 3.826 35.527 9.69 52.721 1.986 5.822.567 12.262-3.783 16.612l-13.087 13.087c-28.026 28.026-28.905 73.66-1.155 101.96 28.024 28.579 74.086 28.749 102.325.51l67.2-67.19c28.191-28.191 28.073-73.757.0-101.83-3.701-3.694-7.429-6.564-10.341-8.569a16.037 16.037.0 01-6.947-12.606c-.396-10.567 3.348-21.456 11.698-29.806l21.054-21.055c5.521-5.521 14.182-6.199 20.584-1.731a152.482 152.482.0 0120.522 17.197zM467.547 44.449c-59.261-59.262-155.69-59.27-214.96.0l-67.2 67.2c-.12.12-.25.25-.36.37-58.566 58.892-59.387 154.781.36 214.59a152.454 152.454.0 0020.521 17.196c6.402 4.468 15.064 3.789 20.584-1.731l21.054-21.055c8.35-8.35 12.094-19.239 11.698-29.806a16.037 16.037.0 00-6.947-12.606c-2.912-2.005-6.64-4.875-10.341-8.569-28.073-28.073-28.191-73.639.0-101.83l67.2-67.19c28.239-28.239 74.3-28.069 102.325.51 27.75 28.3 26.872 73.934-1.155 101.96l-13.087 13.087c-4.35 4.35-5.769 10.79-3.783 16.612 5.864 17.194 9.042 34.999 9.69 52.721.509 13.906 17.454 20.446 27.294 10.606l37.106-37.106c59.271-59.259 59.271-155.699.001-214.959z"/></svg></a><a href=#contents:变量六include_vars class=headings>#变量(六)include_vars</a></h2><p>1,通过'vars_files'可以将文件中的变量引入playbook,以便在task中使用,但是vars_files加载时是静态的引入变量,即后续在vars_files中新增的变量,无法被引用</p><ul><li>vars_files变量文件在ansible控制节点中,与目标主机无关</li><li>示例如下:</li></ul><div class=highlight><div class=chroma><div class=table-container><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-yaml data-lang=yaml><span class=line><span class=cl><span class=nn>---</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=c># 为了更加方便的操作变量文件进行测试,此处将目标主机设置为me,主机me为ansible控制主机</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span>- <span class=nt>hosts</span><span class=p>:</span><span class=w> </span><span class=l>me</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>remote_user</span><span class=p>:</span><span class=w> </span><span class=l>root</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>gather_facts</span><span class=p>:</span><span class=w> </span><span class=kc>no</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>vars_files</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span>- <span class=l>/testdir/ansible/testfile</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=c># /testdir/ansible/testfile内容为:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=c># testvar1: aaa</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=c># testvar2: bbb</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>tasks</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span>- <span class=nt>debug</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>msg</span><span class=p>:</span><span class=w> </span><span class=s2>&#34;{{testvar1}},{{testvar2}}&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span>- <span class=nt>lineinfile</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>path</span><span class=p>:</span><span class=w> </span><span class=s2>&#34;/testdir/ansible/testfile&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>line</span><span class=p>:</span><span class=w> </span><span class=s2>&#34;testvar3: ccc&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span>- <span class=nt>debug</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>msg</span><span class=p>:</span><span class=w> </span><span class=s2>&#34;{{testvar1}},{{testvar2}},{{testvar3}}&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=c># 上述执行出错,因为在playbook载入vars_files对应的变量文件时,文件中只有两个变量,在执行第三个任务执行,并没有重新载入对应的变量文件</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div></div><p>2,include_vars可以在任务执行过程中,随时的引入变量文件,以便动态的获取到最新的变量文件内容</p><ul><li>接上例,调整内容如下:</li></ul><div class=highlight><div class=chroma><div class=table-container><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-yaml data-lang=yaml><span class=line><span class=cl><span class=nn>---</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=c># 为了更加方便的操作变量文件进行测试,此处将目标主机设置为me,主机me为ansible控制主机</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span>- <span class=nt>hosts</span><span class=p>:</span><span class=w> </span><span class=l>me</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>remote_user</span><span class=p>:</span><span class=w> </span><span class=l>root</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>gather_facts</span><span class=p>:</span><span class=w> </span><span class=kc>no</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>vars_files</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span>- <span class=l>/testdir/ansible/testfile</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>tasks</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span>- <span class=nt>debug</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>msg</span><span class=p>:</span><span class=w> </span><span class=s2>&#34;{{testvar3}}&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span>- <span class=nt>lineinfile</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>path</span><span class=p>:</span><span class=w> </span><span class=s2>&#34;/testdir/ansible/testfile&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>line</span><span class=p>:</span><span class=w> </span><span class=s2>&#34;testvar4: ddd&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span>- <span class=nt>include_vars</span><span class=p>:</span><span class=w> </span><span class=s2>&#34;/testdir/ansible/testfile&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span>- <span class=nt>debug</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>msg</span><span class=p>:</span><span class=w> </span><span class=s2>&#34;{{testvar4}}&#34;</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div></div><ul><li>include_vars还有一种使用场景,有些时候,变量文件可能并没有位于ansible主机中,而是位于远程主机中,所以需要先把变量文件从远程主机中拉取到ansible主机中,当通过前面的task拉取到变量文件以后,也可以使用'include_vars'模块加载刚才拉取到的变量文件,以便后面的task可以使用变量文件中的变量.</li></ul><p>3,include_vars的一些常用参数</p><ul><li>file,如下示例:</li></ul><div class=highlight><div class=chroma><div class=table-container><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-yaml data-lang=yaml><span class=line><span class=cl><span class=nn>---</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span>- <span class=nt>hosts</span><span class=p>:</span><span class=w> </span><span class=l>node2</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>remote_user</span><span class=p>:</span><span class=w> </span><span class=l>root</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>gather_facts</span><span class=p>:</span><span class=w> </span><span class=kc>no</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>tasks</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span>- <span class=nt>include_vars</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>file</span><span class=p>:</span><span class=w> </span><span class=l>/testdir/ansible/testfile</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=c># 等效于:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=c># - include_vars: &#34;/testdir/ansible/testfile&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span>- <span class=nt>debug</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>msg</span><span class=p>:</span><span class=w> </span><span class=s2>&#34;{{testvar4}}&#34;</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div></div><ul><li>'include_vars'可以把变量文件中的变量全部赋值给另外一个变量,如下示例:</li></ul><div class=highlight><div class=chroma><div class=table-container><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-yaml data-lang=yaml><span class=line><span class=cl><span class=nn>---</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span>- <span class=nt>hosts</span><span class=p>:</span><span class=w> </span><span class=l>node2</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>remote_user</span><span class=p>:</span><span class=w> </span><span class=l>root</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>gather_facts</span><span class=p>:</span><span class=w> </span><span class=kc>no</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>tasks</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span>- <span class=nt>include_vars</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>file</span><span class=p>:</span><span class=w> </span><span class=l>/testdir/ansible/testfile</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>trans_var</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span>- <span class=nt>debug</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>msg</span><span class=p>:</span><span class=w> </span><span class=s2>&#34;{{trans_var}}&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=c># 输出如下:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=l>TASK [debug] xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>ok</span><span class=p>:</span><span class=w> </span><span class=p>[</span><span class=l>test70] =&gt; {</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>&#34;msg&#34;: </span>{<span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nt>&#34;testvar1&#34;: </span><span class=s2>&#34;aaa&#34;</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nt>&#34;testvar2&#34;: </span><span class=s2>&#34;bbb&#34;</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nt>&#34;testvar3&#34;: </span><span class=s2>&#34;ccc&#34;</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nt>&#34;testvar4&#34;: </span><span class=s2>&#34;ddd&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span>}<span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span>}<span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=c># &#39;trans_var&#39;变量的值就是变量文件中的所有变量,可以使用name参数指定一个变量,然后将文件中的所有变量都赋值给这个指定的变量</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=c># 当使用name参数时,要获取到文件中的某一个变量的值,可以使用如下方法</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>tasks</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span>- <span class=nt>include_vars</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>file</span><span class=p>:</span><span class=w> </span><span class=l>/testdir/ansible/testfile</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>trans_var</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span>- <span class=nt>debug</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>msg</span><span class=p>:</span><span class=w> </span><span class=s2>&#34;{{trans_var.testvar4}}&#34;</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div></div><ul><li>‘include_vars'不仅能够加载指定的变量文件,还能够一次性将指定目录下的所有变量文件中的变量加载,使用dir参数即可指定对应的目录</li></ul><div class=highlight><div class=chroma><div class=table-container><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span><span class=lnt>32
</span><span class=lnt>33
</span><span class=lnt>34
</span><span class=lnt>35
</span><span class=lnt>36
</span><span class=lnt>37
</span><span class=lnt>38
</span><span class=lnt>39
</span><span class=lnt>40
</span><span class=lnt>41
</span><span class=lnt>42
</span><span class=lnt>43
</span><span class=lnt>44
</span><span class=lnt>45
</span><span class=lnt>46
</span><span class=lnt>47
</span><span class=lnt>48
</span><span class=lnt>49
</span><span class=lnt>50
</span><span class=lnt>51
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-yaml data-lang=yaml><span class=line><span class=cl><span class=nn>---</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span>- <span class=nt>hosts</span><span class=p>:</span><span class=w> </span><span class=l>node2</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>gather_facts</span><span class=p>:</span><span class=w> </span><span class=kc>no</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>remote_user</span><span class=p>:</span><span class=w> </span><span class=l>root</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>tasks</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span>- <span class=nt>include_vars</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>dir</span><span class=p>:</span><span class=w> </span><span class=l>/testdir/ansible/test/</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>trans_var</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span>- <span class=nt>debug</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>msg</span><span class=p>:</span><span class=w> </span><span class=s2>&#34;{{trans_var}}&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=c># 上例中,使用dir参数指定了&#34;/testdir/ansible/test/&#34;目录,此目录中的所有变量文件都会被加载,但是在使用dir参数时,需要注意如下三点</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=c># 第一:指定目录中的所有文件的文件后缀必须是 ‘.yaml&#39; 、&#39;.yml&#39; 、&#39;.json&#39;中的一种,默认只有这三种后缀是合法后缀,如果目录中存在非合法后缀的文件,执行playbook时则会报错.</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=c># 第二:如果此目录中的子目录中包含变量文件,子目录中的变量文件也会被递归的加载,而且子目录中的文件也必须遵守上述第一条规则.</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=c># 第三:dir参数与file参数不能同时使用.</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=c># 第一点与第二点都是默认设置,可以通过其他选项修改</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=c># 当使用dir参数时,指定目录中的所有文件必须以 ‘.yaml&#39; 、&#39;.yml&#39; 、&#39;.json&#39; 作为文件的后缀,如果想要手动指定合法的文件后缀名,则可以使用extensions参数指定哪些后缀是合法的文件后缀,extensions参数的值需要是一个列表</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>tasks</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span>- <span class=nt>include_vars</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>dir</span><span class=p>:</span><span class=w> </span><span class=l>/testdir/ansible/test/</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>extensions</span><span class=p>:</span><span class=w> </span><span class=p>[</span><span class=l>yaml,yml,json,varfile]</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>trans_var</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span>- <span class=nt>debug</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>msg</span><span class=p>:</span><span class=w> </span><span class=s2>&#34;{{trans_var}}&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=c># 上例中extensions参数的值为 “[yaml,yml,json,varfile]&#34;,这表示指定目录中的合法文件后缀名为yaml、yml、json和varfile.</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=c># 当使用dir参数时,默认情况下会递归的加载指定目录及其子目录中的所有变量文件,如果想要控制递归的深度,则可以借助depth参数,示例如下</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>tasks</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span>- <span class=nt>include_vars</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>dir</span><span class=p>:</span><span class=w> </span><span class=l>/testdir/ansible/test/</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>depth</span><span class=p>:</span><span class=w> </span><span class=m>1</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>trans_var</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span>- <span class=nt>debug</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>msg</span><span class=p>:</span><span class=w> </span><span class=s2>&#34;{{trans_var}}&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=c># 上例表示,加载&#34;/testdir/ansible/test/&#34;目录中的变量文件,但是其子目录中的变量文件将不会被加载,depth的值为1表示递归深度为1,默认值为0,表示递归到最底层的子目录.</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=c># 在使用dir参数时,我们还可以借助正则表达式,匹配那些我们想要加载的变量文件,比如,我们只想加载指定目录中以&#34;var_&#34;开头的变量文件,则可以使用如下方法</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>tasks</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span>- <span class=nt>include_vars</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>dir</span><span class=p>:</span><span class=w> </span><span class=l>/testdir/ansible/test/</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>files_matching</span><span class=p>:</span><span class=w> </span><span class=s2>&#34;^var_.*&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>trans_var</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span>- <span class=nt>debug</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>msg</span><span class=p>:</span><span class=w> </span><span class=s2>&#34;{{trans_var}}&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=c># 如上例所示,使用&#39;files_matching&#39;参数可以指定正则表达式,当指定目录中的文件名称符合正则时,则可以被加载</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=c># 还可以明确指定,哪些变量文件不能被加载,使用&#39;ignore_files&#39;参数可以明确指定需要忽略的变量文件名称,&#39;ignore_files&#39;参数的值是需要是一个列表</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>tasks</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span>- <span class=nt>include_vars</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>dir</span><span class=p>:</span><span class=w> </span><span class=l>/testdir/ansible/test/</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>ignore_files</span><span class=p>:</span><span class=w> </span><span class=p>[</span><span class=s2>&#34;^var_.*&#34;</span><span class=p>,</span><span class=l>varintest.yaml]</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>trans_var</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span>- <span class=nt>debug</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>msg</span><span class=p>:</span><span class=w> </span><span class=s2>&#34;{{trans_var}}&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=c># 加载 /testdir/ansible/test/目录中的变量文件,但是所有以&#34;var_&#34;开头的变量文件和varintest.yaml变量文件将不会被加载, ‘files_matching&#39;参数和&#39;ignore_files&#39;参数能够同时使用,当它们同时出现时,会先找出正则匹配到的文件,然后从中排除那些需要忽略的文件</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div></div><p>3, 在2.4版本以后的ansible中,当执行了include_vars模块以后,include_vars模块会将载入的变量文件列表写入到自己的返回值中,这个返回值的关键字为'ansible_included_var_files',所以,如果我们想要知道本次任务引入了哪些变量文件,则可以使用如下方法</p><ul><li>如下示例:</li></ul><div class=highlight><div class=chroma><div class=table-container><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-yaml data-lang=yaml><span class=line><span class=cl><span class=nt>tasks</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span>- <span class=nt>include_vars</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>dir</span><span class=p>:</span><span class=w> </span><span class=l>/testdir/ansible/test/</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>register</span><span class=p>:</span><span class=w> </span><span class=l>return_val</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span>- <span class=nt>debug</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>msg</span><span class=p>:</span><span class=w> </span><span class=s2>&#34;{{return_val.ansible_included_var_files}}&#34;</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div></div><h2 id=过滤器二-json_query><a href=#过滤器二-json_query class=anchor-link><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512" class="icon anchor-icon"><path d="M326.612 185.391c59.747 59.809 58.927 155.698.36 214.59-.11.12-.24.25-.36.37l-67.2 67.2c-59.27 59.27-155.699 59.262-214.96.0-59.27-59.26-59.27-155.7.0-214.96l37.106-37.106c9.84-9.84 26.786-3.3 27.294 10.606.648 17.722 3.826 35.527 9.69 52.721 1.986 5.822.567 12.262-3.783 16.612l-13.087 13.087c-28.026 28.026-28.905 73.66-1.155 101.96 28.024 28.579 74.086 28.749 102.325.51l67.2-67.19c28.191-28.191 28.073-73.757.0-101.83-3.701-3.694-7.429-6.564-10.341-8.569a16.037 16.037.0 01-6.947-12.606c-.396-10.567 3.348-21.456 11.698-29.806l21.054-21.055c5.521-5.521 14.182-6.199 20.584-1.731a152.482 152.482.0 0120.522 17.197zM467.547 44.449c-59.261-59.262-155.69-59.27-214.96.0l-67.2 67.2c-.12.12-.25.25-.36.37-58.566 58.892-59.387 154.781.36 214.59a152.454 152.454.0 0020.521 17.196c6.402 4.468 15.064 3.789 20.584-1.731l21.054-21.055c8.35-8.35 12.094-19.239 11.698-29.806a16.037 16.037.0 00-6.947-12.606c-2.912-2.005-6.64-4.875-10.341-8.569-28.073-28.073-28.191-73.639.0-101.83l67.2-67.19c28.239-28.239 74.3-28.069 102.325.51 27.75 28.3 26.872 73.934-1.155 101.96l-13.087 13.087c-4.35 4.35-5.769 10.79-3.783 16.612 5.864 17.194 9.042 34.999 9.69 52.721.509 13.906 17.454 20.446 27.294 10.606l37.106-37.106c59.271-59.259 59.271-155.699.001-214.959z"/></svg></a><a href=#contents:过滤器二-json_query class=headings>#过滤器(二) json_query</a></h2><p>1,ansible可以通过include_vars加载日志文件,debug格式化输出json/yaml内容,方便查看</p><ul><li>json是yaml的子集,yaml是json的超集,yaml格式的数据和json格式的数据是可以互相转换的</li><li>如下示例:</li></ul><div class=highlight><div class=chroma><div class=table-container><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span><span class=lnt>32
</span><span class=lnt>33
</span><span class=lnt>34
</span><span class=lnt>35
</span><span class=lnt>36
</span><span class=lnt>37
</span><span class=lnt>38
</span><span class=lnt>39
</span><span class=lnt>40
</span><span class=lnt>41
</span><span class=lnt>42
</span><span class=lnt>43
</span><span class=lnt>44
</span><span class=lnt>45
</span><span class=lnt>46
</span><span class=lnt>47
</span><span class=lnt>48
</span><span class=lnt>49
</span><span class=lnt>50
</span><span class=lnt>51
</span><span class=lnt>52
</span><span class=lnt>53
</span><span class=lnt>54
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-yaml data-lang=yaml><span class=line><span class=cl><span class=nn>---</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span>- <span class=nt>hosts</span><span class=p>:</span><span class=w> </span><span class=l>me</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>remote_user</span><span class=p>:</span><span class=w> </span><span class=l>liawne</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>gather_facts</span><span class=p>:</span><span class=w> </span><span class=kc>no</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>tasks</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span>- <span class=nt>include_vars</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>file</span><span class=p>:</span><span class=w> </span><span class=s2>&#34;/testdir/ansible/wsCdnLogList&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>testvar</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span>- <span class=nt>debug</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>msg</span><span class=p>:</span><span class=w> </span><span class=s2>&#34;{{ testvar }}&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=c># 输出如下:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=l>TASK [debug] xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>ok</span><span class=p>:</span><span class=w> </span><span class=p>[</span><span class=l>node2] =&gt; {</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>&#34;msg&#34;: </span>{<span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nt>&#34;logs&#34;: </span><span class=p>[</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span>{<span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=nt>&#34;domainName&#34;: </span><span class=s2>&#34;asia1.cdn.test.com&#34;</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=nt>&#34;files&#34;: </span><span class=p>[</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span>{<span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                        </span><span class=nt>&#34;dateFrom&#34;: </span><span class=s2>&#34;2018-09-05-0000&#34;</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                        </span><span class=nt>&#34;dateTo&#34;: </span><span class=s2>&#34;2018-09-05-2359&#34;</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                        </span><span class=nt>&#34;fileMd5&#34;: </span><span class=s2>&#34;error&#34;</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                        </span><span class=nt>&#34;fileName&#34;: </span><span class=s2>&#34;2018-09-05-0000-2330_asia1.cdn.test.com.all.log.gz&#34;</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                        </span><span class=nt>&#34;fileSize&#34;: </span><span class=m>254</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                        </span><span class=nt>&#34;logUrl&#34;: </span><span class=s2>&#34;http://log.testcd.com/log/zsy/asia1.cdn.test.com/2018-09-05-0000-2330_asia1.cdn.test.com.all.log.gz?wskey=XXXXX5a&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span>}<span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=p>]</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span>}<span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span>{<span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=nt>&#34;domainName&#34;: </span><span class=s2>&#34;image1.cdn.test.com&#34;</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=nt>&#34;files&#34;: </span><span class=p>[</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span>{<span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                        </span><span class=nt>&#34;dateFrom&#34;: </span><span class=s2>&#34;2018-09-05-2200&#34;</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                        </span><span class=nt>&#34;dateTo&#34;: </span><span class=s2>&#34;2018-09-05-2259&#34;</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                        </span><span class=nt>&#34;fileMd5&#34;: </span><span class=s2>&#34;error&#34;</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                        </span><span class=nt>&#34;fileName&#34;: </span><span class=s2>&#34;2018-09-05-2200-2230_image1.cdn.test.com.cn.log.gz&#34;</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                        </span><span class=nt>&#34;fileSize&#34;: </span><span class=m>10509</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                        </span><span class=nt>&#34;logUrl&#34;: </span><span class=s2>&#34;http://log.testcd.com/log/zsy/image1.cdn.test.com/2018-09-05-2200-2230_image1.cdn.test.com.cn.log.gz?wskey=XXXXX1c&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span>}<span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span>{<span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                        </span><span class=nt>&#34;dateFrom&#34;: </span><span class=s2>&#34;2018-09-05-2300&#34;</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                        </span><span class=nt>&#34;dateTo&#34;: </span><span class=s2>&#34;2018-09-05-2359&#34;</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                        </span><span class=nt>&#34;fileMd5&#34;: </span><span class=s2>&#34;error&#34;</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                        </span><span class=nt>&#34;fileName&#34;: </span><span class=s2>&#34;2018-09-05-2300-2330_image1.cdn.test.com.cn.log.gz&#34;</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                        </span><span class=nt>&#34;fileSize&#34;: </span><span class=m>5637</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                        </span><span class=nt>&#34;logUrl&#34;: </span><span class=s2>&#34;http://log.testcd.com/log/zsy/image1.cdn.test.com/2018-09-05-2300-2330_image1.cdn.test.com.cn.log.gz?wskey=XXXXXfe&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span>}<span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=p>]</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span>}<span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>]</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span>}<span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span>}<span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=c># 变量文件的格式可以是yaml格式的,也可以是json格式的,上例就是将json格式的数据文件当做变量文件使用的</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=c># 对于ansible来说,当我们把上例中的json数据文件当做变量文件引入时,就好像引入了一个我们定义好的yaml格式的变量文件一样,对于ansible来说是没有区别的</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div></div><ul><li>当需要从上例中获取到logUrl时,可以使用如下方式获取:</li></ul><div class=highlight><div class=chroma><div class=table-container><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span><span class=lnt>7
</span><span class=lnt>8
</span><span class=lnt>9
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-yaml data-lang=yaml><span class=line><span class=cl><span class=w>  </span><span class=nt>tasks</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span>- <span class=nt>include_vars</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>file</span><span class=p>:</span><span class=w> </span><span class=s2>&#34;/testdir/ansible/wsCdnLogList&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>testvar</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span>- <span class=nt>debug</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>msg</span><span class=p>:</span><span class=w> </span><span class=s2>&#34;{{ item.1.logUrl }}&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>with_subelements</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span>- <span class=s2>&#34;{{testvar.logs}}&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span>- <span class=l>files</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div></div><p>2,上述例子中除with_subelements外,还可以使用json_query来获取</p><ul><li>json_query的使用方式:</li></ul><div class=highlight><div class=chroma><div class=table-container><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span><span class=lnt>32
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-yaml data-lang=yaml><span class=line><span class=cl><span class=c># 假设testvarfile中内容如下</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span>{<span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>&#34;users&#34;: </span><span class=p>[</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span>{<span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>&#34;name&#34;: </span><span class=s2>&#34;tom&#34;</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>&#34;age&#34;: </span><span class=m>18</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span>}<span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span>{<span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>&#34;name&#34;: </span><span class=s2>&#34;jerry&#34;</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>&#34;age&#34;: </span><span class=m>20</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span>}<span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=p>]</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span>}<span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=c># 如果要获取到所有user的name</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nn>---</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span>- <span class=nt>hosts</span><span class=p>:</span><span class=w> </span><span class=l>me</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>remote_user</span><span class=p>:</span><span class=w> </span><span class=l>liawne</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>gather_facts</span><span class=p>:</span><span class=w> </span><span class=kc>no</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>tasks</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span>- <span class=nt>include_vars</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>file</span><span class=p>:</span><span class=w> </span><span class=s2>&#34;/testdir/ansible/testvarfile&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>testvar</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span>- <span class=nt>debug</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>msg</span><span class=p>:</span><span class=w> </span><span class=s2>&#34;{{ testvar | json_query(&#39;users[*].name&#39;) }}&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=c># 这段数据当做变量赋值给了testvar变量,使用json_query过滤器对这个变量进行了处理,json_query(&#39;users[*].name&#39;)表示找到users列表中所有元素的name属性,输出如下:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=l>TASK [debug] xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>ok</span><span class=p>:</span><span class=w> </span><span class=p>[</span><span class=l>test70] =&gt; {</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>&#34;msg&#34;: </span><span class=p>[</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=s2>&#34;tom&#34;</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=s2>&#34;jerry&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>]</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span>}<span class=w>
</span></span></span></code></pre></td></tr></table></div></div></div><ul><li>更进一步</li></ul><div class=highlight><div class=chroma><div class=table-container><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span><span class=lnt>32
</span><span class=lnt>33
</span><span class=lnt>34
</span><span class=lnt>35
</span><span class=lnt>36
</span><span class=lnt>37
</span><span class=lnt>38
</span><span class=lnt>39
</span><span class=lnt>40
</span><span class=lnt>41
</span><span class=lnt>42
</span><span class=lnt>43
</span><span class=lnt>44
</span><span class=lnt>45
</span><span class=lnt>46
</span><span class=lnt>47
</span><span class=lnt>48
</span><span class=lnt>49
</span><span class=lnt>50
</span><span class=lnt>51
</span><span class=lnt>52
</span><span class=lnt>53
</span><span class=lnt>54
</span><span class=lnt>55
</span><span class=lnt>56
</span><span class=lnt>57
</span><span class=lnt>58
</span><span class=lnt>59
</span><span class=lnt>60
</span><span class=lnt>61
</span><span class=lnt>62
</span><span class=lnt>63
</span><span class=lnt>64
</span><span class=lnt>65
</span><span class=lnt>66
</span><span class=lnt>67
</span><span class=lnt>68
</span><span class=lnt>69
</span><span class=lnt>70
</span><span class=lnt>71
</span><span class=lnt>72
</span><span class=lnt>73
</span><span class=lnt>74
</span><span class=lnt>75
</span><span class=lnt>76
</span><span class=lnt>77
</span><span class=lnt>78
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-yaml data-lang=yaml><span class=line><span class=cl><span class=c># 假设testvarfile中内容如下</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nn>---</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>test</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>users</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span>- <span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>tom</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>age</span><span class=p>:</span><span class=w> </span><span class=m>18</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>hobby</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span>- <span class=l>Skateboard</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span>- <span class=l>VideoGame</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span>- <span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>jerry</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>age</span><span class=p>:</span><span class=w> </span><span class=m>20</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>hobby</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span>- <span class=l>Music</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=c># 要获取到所有的爱好</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nn>---</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span>- <span class=nt>hosts</span><span class=p>:</span><span class=w> </span><span class=l>me</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>remote_user</span><span class=p>:</span><span class=w> </span><span class=l>liawne</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>gather_facts</span><span class=p>:</span><span class=w> </span><span class=kc>no</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>tasks</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span>- <span class=nt>include_vars</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>file</span><span class=p>:</span><span class=w> </span><span class=s2>&#34;/testdir/ansible/testvarfile1&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>testvar</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span>- <span class=nt>debug</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>msg</span><span class=p>:</span><span class=w> </span><span class=s2>&#34;{{ testvar | json_query(&#39;test.users[*].hobby[*]&#39;) }}&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=c># 当数据结构中存在列表时,我们可以使用”列表名[*]”获取到列表下面的所有项,输出结果如下:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=l>TASK [debug] xxxxxxxxxxxxxxxxxxxxxxxxxxxxx</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>ok</span><span class=p>:</span><span class=w> </span><span class=p>[</span><span class=l>me] =&gt; {</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>&#34;msg&#34;: </span><span class=p>[</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>[</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=s2>&#34;Skateboard&#34;</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=s2>&#34;VideoGame&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>],</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>[</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=s2>&#34;Music&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>]</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>]</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span>}<span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=c># 想要根据条件获取到某个用户的某些信息</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=c># method one</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>tasks</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span>- <span class=nt>include_vars</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>file</span><span class=p>:</span><span class=w> </span><span class=s2>&#34;/testdir/ansible/testvarfile1&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>testvar</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span>- <span class=nt>debug</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=c># 此处使用了反引号,因为已经使用了&#39;和&#34;,使用`用作区分</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>msg</span><span class=p>:</span><span class=w> </span><span class=s2>&#34;{{ testvar | json_query(&#39;test.users[?name==`tom`].hobby[*]&#39;) }}&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=c># method two</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>tasks</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span>- <span class=nt>include_vars</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>file</span><span class=p>:</span><span class=w> </span><span class=s2>&#34;/testdir/ansible/testvarfile1&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>testvar</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span>- <span class=nt>debug</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>msg</span><span class=p>:</span><span class=w> </span><span class=s2>&#34;{{ testvar | json_query(querystring) }}&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>vars</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>querystring</span><span class=p>:</span><span class=w> </span><span class=s2>&#34;test.users[?name==&#39;tom&#39;].age&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=c># 在debug任务中使用vars关键字定义了一个只有当前debug任务能够使用的变量,从而避免了多层引号嵌套时所产生的冲突问题.</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=c># 同时获取到用户的姓名、年龄两个属性的值,当需要同时获取多个属性值时,需要通过键值对的方式调用属性</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>tasks</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span>- <span class=nt>include_vars</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>file</span><span class=p>:</span><span class=w> </span><span class=s2>&#34;/testdir/ansible/testvarfile1&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>testvar</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span>- <span class=nt>debug</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>msg</span><span class=p>:</span><span class=w> </span><span class=s2>&#34;{{ testvar | json_query(&#39;test.users[*].{uname:name,uage:age}&#39;) }}&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=c># 输出内容如下:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=l>TASK [debug] xxxxxxxxxxxxxxxxxxxxxxxxxxxxx</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>ok</span><span class=p>:</span><span class=w> </span><span class=p>[</span><span class=l>me] =&gt; {</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>&#34;msg&#34;: </span><span class=p>[</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span>{<span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=nt>&#34;uage&#34;: </span><span class=m>18</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=nt>&#34;uname&#34;: </span><span class=s2>&#34;tom&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span>}<span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span>{<span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=nt>&#34;uage&#34;: </span><span class=m>20</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=nt>&#34;uname&#34;: </span><span class=s2>&#34;jerry&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span>}<span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>]</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span>}<span class=w>
</span></span></span></code></pre></td></tr></table></div></div></div><ul><li>回到第一个示例,获取logUrl的方式如下:</li></ul><div class=highlight><div class=chroma><div class=table-container><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-yaml data-lang=yaml><span class=line><span class=cl><span class=nn>---</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span>- <span class=nt>hosts</span><span class=p>:</span><span class=w> </span><span class=l>me</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>remote_user</span><span class=p>:</span><span class=w> </span><span class=l>liawne</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>gather_facts</span><span class=p>:</span><span class=w> </span><span class=kc>no</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>vars_files</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span>- <span class=l>/testdir/ansible/wsCdnLogList</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>tasks</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span>- <span class=nt>debug</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>msg</span><span class=p>:</span><span class=w> </span><span class=s2>&#34;{{item}}&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>with_items</span><span class=p>:</span><span class=w> </span><span class=s2>&#34;{{ logs | json_query(&#39;[*].files[*].logUrl&#39;) }}&#34;</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div></div><h2 id=过滤器三-其他过滤器><a href=#过滤器三-其他过滤器 class=anchor-link><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512" class="icon anchor-icon"><path d="M326.612 185.391c59.747 59.809 58.927 155.698.36 214.59-.11.12-.24.25-.36.37l-67.2 67.2c-59.27 59.27-155.699 59.262-214.96.0-59.27-59.26-59.27-155.7.0-214.96l37.106-37.106c9.84-9.84 26.786-3.3 27.294 10.606.648 17.722 3.826 35.527 9.69 52.721 1.986 5.822.567 12.262-3.783 16.612l-13.087 13.087c-28.026 28.026-28.905 73.66-1.155 101.96 28.024 28.579 74.086 28.749 102.325.51l67.2-67.19c28.191-28.191 28.073-73.757.0-101.83-3.701-3.694-7.429-6.564-10.341-8.569a16.037 16.037.0 01-6.947-12.606c-.396-10.567 3.348-21.456 11.698-29.806l21.054-21.055c5.521-5.521 14.182-6.199 20.584-1.731a152.482 152.482.0 0120.522 17.197zM467.547 44.449c-59.261-59.262-155.69-59.27-214.96.0l-67.2 67.2c-.12.12-.25.25-.36.37-58.566 58.892-59.387 154.781.36 214.59a152.454 152.454.0 0020.521 17.196c6.402 4.468 15.064 3.789 20.584-1.731l21.054-21.055c8.35-8.35 12.094-19.239 11.698-29.806a16.037 16.037.0 00-6.947-12.606c-2.912-2.005-6.64-4.875-10.341-8.569-28.073-28.073-28.191-73.639.0-101.83l67.2-67.19c28.239-28.239 74.3-28.069 102.325.51 27.75 28.3 26.872 73.934-1.155 101.96l-13.087 13.087c-4.35 4.35-5.769 10.79-3.783 16.612 5.864 17.194 9.042 34.999 9.69 52.721.509 13.906 17.454 20.446 27.294 10.606l37.106-37.106c59.271-59.259 59.271-155.699.001-214.959z"/></svg></a><a href=#contents:过滤器三-其他过滤器 class=headings>#过滤器(三) 其他过滤器</a></h2><p>1,其他一些常用的过滤器</p><div class=highlight><div class=chroma><div class=table-container><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>  1
</span><span class=lnt>  2
</span><span class=lnt>  3
</span><span class=lnt>  4
</span><span class=lnt>  5
</span><span class=lnt>  6
</span><span class=lnt>  7
</span><span class=lnt>  8
</span><span class=lnt>  9
</span><span class=lnt> 10
</span><span class=lnt> 11
</span><span class=lnt> 12
</span><span class=lnt> 13
</span><span class=lnt> 14
</span><span class=lnt> 15
</span><span class=lnt> 16
</span><span class=lnt> 17
</span><span class=lnt> 18
</span><span class=lnt> 19
</span><span class=lnt> 20
</span><span class=lnt> 21
</span><span class=lnt> 22
</span><span class=lnt> 23
</span><span class=lnt> 24
</span><span class=lnt> 25
</span><span class=lnt> 26
</span><span class=lnt> 27
</span><span class=lnt> 28
</span><span class=lnt> 29
</span><span class=lnt> 30
</span><span class=lnt> 31
</span><span class=lnt> 32
</span><span class=lnt> 33
</span><span class=lnt> 34
</span><span class=lnt> 35
</span><span class=lnt> 36
</span><span class=lnt> 37
</span><span class=lnt> 38
</span><span class=lnt> 39
</span><span class=lnt> 40
</span><span class=lnt> 41
</span><span class=lnt> 42
</span><span class=lnt> 43
</span><span class=lnt> 44
</span><span class=lnt> 45
</span><span class=lnt> 46
</span><span class=lnt> 47
</span><span class=lnt> 48
</span><span class=lnt> 49
</span><span class=lnt> 50
</span><span class=lnt> 51
</span><span class=lnt> 52
</span><span class=lnt> 53
</span><span class=lnt> 54
</span><span class=lnt> 55
</span><span class=lnt> 56
</span><span class=lnt> 57
</span><span class=lnt> 58
</span><span class=lnt> 59
</span><span class=lnt> 60
</span><span class=lnt> 61
</span><span class=lnt> 62
</span><span class=lnt> 63
</span><span class=lnt> 64
</span><span class=lnt> 65
</span><span class=lnt> 66
</span><span class=lnt> 67
</span><span class=lnt> 68
</span><span class=lnt> 69
</span><span class=lnt> 70
</span><span class=lnt> 71
</span><span class=lnt> 72
</span><span class=lnt> 73
</span><span class=lnt> 74
</span><span class=lnt> 75
</span><span class=lnt> 76
</span><span class=lnt> 77
</span><span class=lnt> 78
</span><span class=lnt> 79
</span><span class=lnt> 80
</span><span class=lnt> 81
</span><span class=lnt> 82
</span><span class=lnt> 83
</span><span class=lnt> 84
</span><span class=lnt> 85
</span><span class=lnt> 86
</span><span class=lnt> 87
</span><span class=lnt> 88
</span><span class=lnt> 89
</span><span class=lnt> 90
</span><span class=lnt> 91
</span><span class=lnt> 92
</span><span class=lnt> 93
</span><span class=lnt> 94
</span><span class=lnt> 95
</span><span class=lnt> 96
</span><span class=lnt> 97
</span><span class=lnt> 98
</span><span class=lnt> 99
</span><span class=lnt>100
</span><span class=lnt>101
</span><span class=lnt>102
</span><span class=lnt>103
</span><span class=lnt>104
</span><span class=lnt>105
</span><span class=lnt>106
</span><span class=lnt>107
</span><span class=lnt>108
</span><span class=lnt>109
</span><span class=lnt>110
</span><span class=lnt>111
</span><span class=lnt>112
</span><span class=lnt>113
</span><span class=lnt>114
</span><span class=lnt>115
</span><span class=lnt>116
</span><span class=lnt>117
</span><span class=lnt>118
</span><span class=lnt>119
</span><span class=lnt>120
</span><span class=lnt>121
</span><span class=lnt>122
</span><span class=lnt>123
</span><span class=lnt>124
</span><span class=lnt>125
</span><span class=lnt>126
</span><span class=lnt>127
</span><span class=lnt>128
</span><span class=lnt>129
</span><span class=lnt>130
</span><span class=lnt>131
</span><span class=lnt>132
</span><span class=lnt>133
</span><span class=lnt>134
</span><span class=lnt>135
</span><span class=lnt>136
</span><span class=lnt>137
</span><span class=lnt>138
</span><span class=lnt>139
</span><span class=lnt>140
</span><span class=lnt>141
</span><span class=lnt>142
</span><span class=lnt>143
</span><span class=lnt>144
</span><span class=lnt>145
</span><span class=lnt>146
</span><span class=lnt>147
</span><span class=lnt>148
</span><span class=lnt>149
</span><span class=lnt>150
</span><span class=lnt>151
</span><span class=lnt>152
</span><span class=lnt>153
</span><span class=lnt>154
</span><span class=lnt>155
</span><span class=lnt>156
</span><span class=lnt>157
</span><span class=lnt>158
</span><span class=lnt>159
</span><span class=lnt>160
</span><span class=lnt>161
</span><span class=lnt>162
</span><span class=lnt>163
</span><span class=lnt>164
</span><span class=lnt>165
</span><span class=lnt>166
</span><span class=lnt>167
</span><span class=lnt>168
</span><span class=lnt>169
</span><span class=lnt>170
</span><span class=lnt>171
</span><span class=lnt>172
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-yaml data-lang=yaml><span class=line><span class=cl><span class=nn>---</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span>- <span class=nt>hosts</span><span class=p>:</span><span class=w> </span><span class=l>me</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>remote_user</span><span class=p>:</span><span class=w> </span><span class=l>liawne</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>gather_facts</span><span class=p>:</span><span class=w> </span><span class=kc>no</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>tasks</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=c>######################################################################</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=c>#在调用shell模块时,如果引用某些变量时需要添加引号,则可以使用quote过滤器代替引号</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=c>#示例如下,先看示例,后面会有注解</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span>- <span class=nt>shell</span><span class=p>:</span><span class=w> </span><span class=s2>&#34;echo {{teststr | quote}} &gt; /testdir/testfile&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>vars</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>teststr</span><span class=p>:</span><span class=w> </span><span class=s2>&#34;a\nb\nc&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=c>#上例中shell模块的写法与如下写法完全等效</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=c>#shell: &#34;echo &#39;{{teststr}}&#39; &gt; /testdir/testfile&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=c>#没错,如你所见,quote过滤器能够代替引号</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=c>#上例中,如果不对{{teststr}}添加引号,则会报错,因为teststr变量中包含&#34;\n&#34;转义符</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=c>######################################################################</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=c>#ternary过滤器可以实现三元运算的效果 示例如下</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=c>#如下示例表示如果name变量的值是John,那么对应的值则为Mr,否则则为Ms</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=c>#简便的实现类似if else对变量赋值的效果</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span>- <span class=nt>debug</span><span class=p>:</span><span class=w> 
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>msg</span><span class=p>:</span><span class=w> </span><span class=s2>&#34;{{ (name == &#39;John&#39;) | ternary(&#39;Mr&#39;,&#39;Ms&#39;) }}&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>vars</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=s2>&#34;John&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=c>######################################################################</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=c>#basename过滤器可以获取到一个路径字符串中的文件名</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span>- <span class=nt>debug</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>msg</span><span class=p>:</span><span class=w> </span><span class=s2>&#34;{{teststr | basename}}&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>vars</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>teststr</span><span class=p>:</span><span class=w> </span><span class=s2>&#34;/testdir/ansible/testfile&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=c>######################################################################</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=c>#获取到一个windows路径字符串中的文件名,2.0版本以后的ansible可用</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span>- <span class=nt>debug</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>msg</span><span class=p>:</span><span class=w> </span><span class=s2>&#34;{{teststr | win_basename}}&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>vars</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>teststr</span><span class=p>:</span><span class=w> </span><span class=s1>&#39;D:\study\zsythink&#39;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=c>######################################################################</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=c>#dirname过滤器可以获取到一个路径字符串中的路径名</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span>- <span class=nt>debug</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>msg</span><span class=p>:</span><span class=w> </span><span class=s2>&#34;{{teststr | dirname}}&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>vars</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>teststr</span><span class=p>:</span><span class=w> </span><span class=s2>&#34;/testdir/ansible/testfile&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=c>######################################################################</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=c>#获取到一个windows路径字符串中的文件名,2.0版本以后的ansible可用</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span>- <span class=nt>debug</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>msg</span><span class=p>:</span><span class=w> </span><span class=s2>&#34;{{teststr | win_dirname}}&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>vars</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>teststr</span><span class=p>:</span><span class=w> </span><span class=s1>&#39;D:\study\zsythink&#39;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=c>######################################################################</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=c>#将一个windows路径字符串中的盘符和路径分开,2.0版本以后的ansible可用</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span>- <span class=nt>debug</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>msg</span><span class=p>:</span><span class=w> </span><span class=s2>&#34;{{teststr | win_splitdrive}}&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>vars</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>teststr</span><span class=p>:</span><span class=w> </span><span class=s1>&#39;D:\study\zsythink&#39;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=c>#可以配合之前总结的过滤器一起使用,比如只获取到盘符,示例如下</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=c>#msg: &#34;{{teststr | win_splitdrive | first}}&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=c>#可以配合之前总结的过滤器一起使用,比如只获取到路径,示例如下</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=c>#msg: &#34;{{teststr | win_splitdrive | last}}&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=c>######################################################################</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=c>#realpath过滤器可以获取软链接文件所指向的真正文件</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span>- <span class=nt>debug</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>msg</span><span class=p>:</span><span class=w> </span><span class=s2>&#34;{{ path | realpath }}&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>vars</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>path</span><span class=p>:</span><span class=w> </span><span class=s2>&#34;/testdir/ansible/testsoft&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=c>######################################################################</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=c>#relpath过滤器可以获取到path对于“指定路径”来说的“相对路径”</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span>- <span class=nt>debug</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>msg</span><span class=p>:</span><span class=w> </span><span class=s2>&#34;{{ path | relpath(&#39;/testdir/testdir&#39;) }}&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>vars</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>path</span><span class=p>:</span><span class=w> </span><span class=s2>&#34;/testdir/ansible&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=c>######################################################################</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=c>#splitext过滤器可以将带有文件名后缀的路径从“.后缀”部分分开</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span>- <span class=nt>debug</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>msg</span><span class=p>:</span><span class=w> </span><span class=s2>&#34;{{ path | splitext }}&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>vars</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>path</span><span class=p>:</span><span class=w> </span><span class=s2>&#34;/etc/nginx/conf.d/test.conf&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=c>#可以配置之前总结的过滤器,获取到文件后缀</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=c>#msg: &#34;{{ path | splitext | last}}&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=c>#可以配置之前总结的过滤器,获取到文件前缀名</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=c>#msg: &#34;{{ path | splitext | first | basename}}&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=c>######################################################################</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=c>#to_uuid过滤器能够为对应的字符串生成uuid</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span>- <span class=nt>debug</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>msg</span><span class=p>:</span><span class=w> </span><span class=s2>&#34;{{ teststr | to_uuid }}&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>vars</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>teststr</span><span class=p>:</span><span class=w> </span><span class=s2>&#34;This is a test statement&#34;</span><span class=w> 
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=c>######################################################################</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=c>#bool过滤器可以根据字符串的内容返回bool值true或者false</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=c>#字符串的内容为yes、1、True、true则返回布尔值true,字符串内容为其他内容则返回false</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span>- <span class=nt>debug</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>msg</span><span class=p>:</span><span class=w> </span><span class=s2>&#34;{{ teststr | bool }}&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>vars</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>teststr</span><span class=p>:</span><span class=w> </span><span class=s2>&#34;1&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=c>#当和用户交互时,有可能需要用户从两个选项中选择一个,比如是否继续,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=c>#这时,将用户输入的字符串通过bool过滤器处理后得出布尔值,从而进行判断,比如如下用法</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=c>#- debug:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=c>#    msg: &#34;output when bool is true&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=c>#  when: some_string_user_input | bool</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=c>######################################################################</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=c>#map过滤器可以从列表中获取到每个元素所共有的某个属性的值,并将这些值组成一个列表</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=c>#当列表中嵌套了列表,不能越级获取属性的值,也就是说只能获取直接子元素的共有属性值.</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span>- <span class=nt>vars</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>users</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span>- <span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>tom</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nt>age</span><span class=p>:</span><span class=w> </span><span class=m>18</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nt>hobby</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span>- <span class=l>Skateboard</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span>- <span class=l>VideoGame</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span>- <span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>jerry</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nt>age</span><span class=p>:</span><span class=w> </span><span class=m>20</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nt>hobby</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span>- <span class=l>Music</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>debug</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>msg</span><span class=p>:</span><span class=w> </span><span class=s2>&#34;{{ users | map(attribute=&#39;name&#39;) | list }}&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=c>#也可以组成一个字符串,用指定的字符隔开,比如分号</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=c>#msg: &#34;{{ users | map(attribute=&#39;name&#39;) | join(&#39;;&#39;) }}&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=c>######################################################################</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=c>#与python中的用法相同,两个日期类型相减能够算出两个日期间的时间差</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=c>#下例中,我们使用to_datatime过滤器将字符串类型转换成了日期了类型,并且算出了时间差</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span>- <span class=nt>debug</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>msg</span><span class=p>:</span><span class=w> </span><span class=s1>&#39;{{ (&#34;2016-08-14 20:00:12&#34;| to_datetime) - (&#34;2012-12-25 19:00:00&#34; | to_datetime) }}&#39;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=c>#默认情况下,to_datatime转换的字符串的格式必须是“%Y-%m-%d %H:%M:%S”</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=c>#如果对应的字符串不是这种格式,则需要在to_datetime中指定与字符串相同的时间格式,才能正确的转换为时间类型</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span>- <span class=nt>debug</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>msg</span><span class=p>:</span><span class=w> </span><span class=s1>&#39;{{ (&#34;20160814&#34;| to_datetime(&#34;%Y%m%d&#34;)) - (&#34;2012-12-25 19:00:00&#34; | to_datetime) }}&#39;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=c>#如下方法可以获取到两个日期之间一共相差多少秒</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span>- <span class=nt>debug</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>msg</span><span class=p>:</span><span class=w> </span><span class=s1>&#39;{{ ( (&#34;20160814&#34;| to_datetime(&#34;%Y%m%d&#34;)) - (&#34;20121225&#34; | to_datetime(&#34;%Y%m%d&#34;)) ).total_seconds() }}&#39;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=c>#如下方法可以获取到两个日期“时间位”相差多少秒,注意:日期位不会纳入对比计算范围</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=c>#也就是说,下例中的2016-08-14和2012-12-25不会纳入计算范围</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=c>#只是计算20:00:12与08:30:00相差多少秒</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=c>#如果想要算出连带日期的秒数差则使用total_seconds()</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span>- <span class=nt>debug</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>msg</span><span class=p>:</span><span class=w> </span><span class=s1>&#39;{{ ( (&#34;2016-08-14 20:00:12&#34;| to_datetime) - (&#34;2012-12-25 08:30:00&#34; | to_datetime) ).seconds }}&#39;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=c>#如下方法可以获取到两个日期“日期位”相差多少天,注意:时间位不会纳入对比计算范围</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span>- <span class=nt>debug</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>msg</span><span class=p>:</span><span class=w> </span><span class=s1>&#39;{{ ( (&#34;2016-08-14 20:00:12&#34;| to_datetime) - (&#34;2012-12-25 08:30:00&#34; | to_datetime) ).days }}&#39;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=c>######################################################################</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=c>#使用base64编码方式对字符串进行编码</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span>- <span class=nt>debug</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>msg</span><span class=p>:</span><span class=w> </span><span class=s2>&#34;{{ &#39;hello&#39; | b64encode }}&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=c>#使用base64编码方式对字符串进行解码</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span>- <span class=nt>debug</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>msg</span><span class=p>:</span><span class=w> </span><span class=s2>&#34;{{ &#39;aGVsbG8=&#39; | b64decode }}&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=c>#######################################################################</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=c>#使用sha1算法对字符串进行哈希</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span>- <span class=nt>debug</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>msg</span><span class=p>:</span><span class=w> </span><span class=s2>&#34;{{ &#39;123456&#39; | hash(&#39;sha1&#39;) }}&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=c>#使用md5算法对字符串进行哈希</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span>- <span class=nt>debug</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>msg</span><span class=p>:</span><span class=w> </span><span class=s2>&#34;{{ &#39;123456&#39; | hash(&#39;md5&#39;) }}&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=c>#获取到字符串的校验和,与md5哈希值一致</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span>- <span class=nt>debug</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>msg</span><span class=p>:</span><span class=w> </span><span class=s2>&#34;{{ &#39;123456&#39; | checksum }}&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=c>#使用blowfish算法对字符串进行哈希,注:部分系统支持</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span>- <span class=nt>debug</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>msg</span><span class=p>:</span><span class=w> </span><span class=s2>&#34;{{ &#39;123456&#39; | hash(&#39;blowfish&#39;) }}&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=c>#使用sha256算法对字符串进行哈希,哈希过程中会生成随机&#34;盐&#34;,以便无法直接对比出原值</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span>- <span class=nt>debug</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>msg</span><span class=p>:</span><span class=w> </span><span class=s2>&#34;{{ &#39;123456&#39; | password_hash(&#39;sha256&#39;) }}&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=c>#使用sha256算法对字符串进行哈希,并使用指定的字符串作为&#34;盐&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span>- <span class=nt>debug</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>msg</span><span class=p>:</span><span class=w> </span><span class=s2>&#34;{{ &#39;123456&#39; | password_hash(&#39;sha256&#39;,&#39;mysalt&#39;) }}&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=c>#使用sha512算法对字符串进行哈希,哈希过程中会生成随机&#34;盐&#34;,以便无法直接对比出原值</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span>- <span class=nt>debug</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>msg</span><span class=p>:</span><span class=w> </span><span class=s2>&#34;{{ &#39;123123&#39; | password_hash(&#39;sha512&#39;) }}&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=c>#使用sha512算法对字符串进行哈希,并使用指定的字符串作为&#34;盐&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span>- <span class=nt>debug</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>msg</span><span class=p>:</span><span class=w> </span><span class=s2>&#34;{{ &#39;123123&#39; | password_hash(&#39;sha512&#39;,&#39;ebzL.U5cjaHe55KK&#39;) }}&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=c>#如下方法可以幂等的为每个主机的密码生成对应哈希串</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=c>#有了之前总结的过滤器用法作为基础,你一定已经看懂了</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span>- <span class=nt>debug</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>msg</span><span class=p>:</span><span class=w> </span><span class=s2>&#34;{{ &#39;123123&#39; | password_hash(&#39;sha512&#39;, 65534|random(seed=inventory_hostname)|string) }}&#34;</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div></div><h2 id=lookup插件><a href=#lookup插件 class=anchor-link><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512" class="icon anchor-icon"><path d="M326.612 185.391c59.747 59.809 58.927 155.698.36 214.59-.11.12-.24.25-.36.37l-67.2 67.2c-59.27 59.27-155.699 59.262-214.96.0-59.27-59.26-59.27-155.7.0-214.96l37.106-37.106c9.84-9.84 26.786-3.3 27.294 10.606.648 17.722 3.826 35.527 9.69 52.721 1.986 5.822.567 12.262-3.783 16.612l-13.087 13.087c-28.026 28.026-28.905 73.66-1.155 101.96 28.024 28.579 74.086 28.749 102.325.51l67.2-67.19c28.191-28.191 28.073-73.757.0-101.83-3.701-3.694-7.429-6.564-10.341-8.569a16.037 16.037.0 01-6.947-12.606c-.396-10.567 3.348-21.456 11.698-29.806l21.054-21.055c5.521-5.521 14.182-6.199 20.584-1.731a152.482 152.482.0 0120.522 17.197zM467.547 44.449c-59.261-59.262-155.69-59.27-214.96.0l-67.2 67.2c-.12.12-.25.25-.36.37-58.566 58.892-59.387 154.781.36 214.59a152.454 152.454.0 0020.521 17.196c6.402 4.468 15.064 3.789 20.584-1.731l21.054-21.055c8.35-8.35 12.094-19.239 11.698-29.806a16.037 16.037.0 00-6.947-12.606c-2.912-2.005-6.64-4.875-10.341-8.569-28.073-28.073-28.191-73.639.0-101.83l67.2-67.19c28.239-28.239 74.3-28.069 102.325.51 27.75 28.3 26.872 73.934-1.155 101.96l-13.087 13.087c-4.35 4.35-5.769 10.79-3.783 16.612 5.864 17.194 9.042 34.999 9.69 52.721.509 13.906 17.454 20.446 27.294 10.606l37.106-37.106c59.271-59.259 59.271-155.699.001-214.959z"/></svg></a><a href=#contents:lookup插件 class=headings>#lookup插件</a></h2><p>1,ansible中有很多种类的插件,比如之前总结的”tests”,也是插件的一种,ansible官网总结了各个插件的作用,并且将这些插件按照功能进行了分类</p><ul><li><a href=https://docs.ansible.com/ansible/latest/plugins/plugins.html target=_blank rel=noopener>https://docs.ansible.com/ansible/latest/plugins/plugins.html</a></li></ul><p>2,前文总结的”循环”在本质上也是一种插件,这种插件叫做”lookup插件”,先回忆一些”循环”的使用方法,以便能够更好的描述”循环”和”lookup插件”之间的关系</p><ul><li>列表示例如下:</li></ul><div class=highlight><div class=chroma><div class=table-container><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-yaml data-lang=yaml><span class=line><span class=cl><span class=nn>---</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span>- <span class=nt>hosts</span><span class=p>:</span><span class=w> </span><span class=l>node2</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>remote_user</span><span class=p>:</span><span class=w> </span><span class=l>root</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>gather_facts</span><span class=p>:</span><span class=w> </span><span class=kc>no</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>tasks</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span>- <span class=nt>debug</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>msg</span><span class=p>:</span><span class=w> </span><span class=s2>&#34;index is {{item.0}} , value is {{item.1}}&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>with_indexed_items</span><span class=p>:</span><span class=w> </span><span class=p>[</span><span class=s1>&#39;a&#39;</span><span class=p>,</span><span class=s1>&#39;b&#39;</span><span class=p>,</span><span class=s1>&#39;c&#39;</span><span class=p>]</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=c># 等价于</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nn>---</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span>- <span class=nt>hosts</span><span class=p>:</span><span class=w> </span><span class=l>node2</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>remote_user</span><span class=p>:</span><span class=w> </span><span class=l>root</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>gather_facts</span><span class=p>:</span><span class=w> </span><span class=kc>no</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>tasks</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span>- <span class=nt>debug</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>msg</span><span class=p>:</span><span class=w> </span><span class=s2>&#34;index is {{item.0}} , value is {{item.1}}&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>loop</span><span class=p>:</span><span class=w> </span><span class=s2>&#34;{{ lookup(&#39;indexed_items&#39;,[&#39;a&#39;,&#39;b&#39;,&#39;c&#39;]) }}&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=c># 第一个示例使用”with_indexed_items关键字”处理列表</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=c># 第二个示例使用”loop关键字”配合”lookup插件”处理列表</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=c># 上例中,”lookup(‘indexed_items&#39;,[‘a&#39;,&#39;b&#39;,&#39;c&#39;])” 这段代码就是在使用lookup插件,含义是,使用名为&#39;indexed_items&#39;的lookup插件处理[‘a&#39;,&#39;b&#39;,&#39;c&#39;]这个列表,&#39;indexed_items&#39;就是一个lookup插件</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div></div><ul><li>字典示例如下:</li></ul><div class=highlight><div class=chroma><div class=table-container><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-yaml data-lang=yaml><span class=line><span class=cl><span class=nn>---</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span>- <span class=nt>hosts</span><span class=p>:</span><span class=w> </span><span class=l>node2</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>remote_user</span><span class=p>:</span><span class=w> </span><span class=l>root</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>gather_facts</span><span class=p>:</span><span class=w> </span><span class=kc>no</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>vars</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>users</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>alice</span><span class=p>:</span><span class=w> </span><span class=l>female</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>bob</span><span class=p>:</span><span class=w> </span><span class=l>male</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>tasks</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span>- <span class=nt>debug</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>msg</span><span class=p>:</span><span class=w> </span><span class=s2>&#34;{{item.key}} is {{item.value}}&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>with_dict</span><span class=p>:</span><span class=w> </span><span class=s2>&#34;{{ users }}&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=c># 等价于</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nn>---</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span>- <span class=nt>hosts</span><span class=p>:</span><span class=w> </span><span class=l>node2</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>remote_user</span><span class=p>:</span><span class=w> </span><span class=l>root</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>gather_facts</span><span class=p>:</span><span class=w> </span><span class=kc>no</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>vars</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>users</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>alice</span><span class=p>:</span><span class=w> </span><span class=l>female</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>bob</span><span class=p>:</span><span class=w> </span><span class=l>male</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>tasks</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span>- <span class=nt>debug</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>msg</span><span class=p>:</span><span class=w> </span><span class=s2>&#34;{{item.key}} is {{item.value}}&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>loop</span><span class=p>:</span><span class=w> </span><span class=s2>&#34;{{ lookup(&#39;dict&#39;,users) }}&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=c># 第一个示例使用”with_dict关键字”处理users字典变量</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=c># 第二个示例使用”loop关键字”配合”lookup插件”处理users字典变量</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=c># 上例中,”lookup(‘dict&#39;,users)”表示使用名为&#39;dict&#39;的lookup插件处理users字典变量,&#39;dict&#39;也是一个lookup插件</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div></div><p>3,lookup插件的用法</p><ul><li>lookup(‘插件名',被处理数据或参数)</li><li>以”with_”开头的循环实际上就是”with_”和”lookup()”的组合,lookup插件可以作为循环的数据源</li></ul><p>4,查看插件的帮助命令</p><ul><li>查看有哪些lookup插件可以使用: ansible-doc -t lookup -l(”-t”选项用于指定插件类型,”-l”选项表示列出列表)</li><li>单独查看某个插件的使用方法,比如dict插件的使用方法: ansible-doc -t lookup dict</li><li>file插件可以获取到指定文件的文件内容（注:文件位于ansible主机中）,示例如下</li></ul><div class=highlight><div class=chroma><div class=table-container><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-yaml data-lang=yaml><span class=line><span class=cl><span class=nn>---</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span>- <span class=nt>hosts</span><span class=p>:</span><span class=w> </span><span class=l>node2</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>remote_user</span><span class=p>:</span><span class=w> </span><span class=l>root</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>gather_facts</span><span class=p>:</span><span class=w> </span><span class=kc>no</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>tasks</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span>- <span class=nt>debug</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>msg</span><span class=p>:</span><span class=w> </span><span class=s2>&#34;{{ lookup(&#39;file&#39;,&#39;/testdir/testfile&#39;) }}&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=c># 如果想要获取多个文件中的内容,则可以传入多个文件路径,示例如下</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>msg</span><span class=p>:</span><span class=w> </span><span class=s2>&#34;{{ lookup(&#39;file&#39;,&#39;/testdir/testfile&#39;,&#39;/testdir/testfile1&#39;) }}&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=c># file插件获得多个文件中的内容时,会将多个文件中的内容放置在一个字符串中,并用”逗号”隔开每个文件中的内容</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=c># 想要获得一个字符串列表,将每个文件的内容当做列表中的一个独立的字符串</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>msg</span><span class=p>:</span><span class=w> </span><span class=s2>&#34;{{ lookup(&#39;file&#39;,&#39;/testdir/testfile&#39;,&#39;/testdir/testfile1&#39;,wantlist=true) }}&#34;</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div></div><p>5,其他lookup插件用法示例</p><ul><li>示例如下:</li></ul><div class=highlight><div class=chroma><div class=table-container><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span><span class=lnt>32
</span><span class=lnt>33
</span><span class=lnt>34
</span><span class=lnt>35
</span><span class=lnt>36
</span><span class=lnt>37
</span><span class=lnt>38
</span><span class=lnt>39
</span><span class=lnt>40
</span><span class=lnt>41
</span><span class=lnt>42
</span><span class=lnt>43
</span><span class=lnt>44
</span><span class=lnt>45
</span><span class=lnt>46
</span><span class=lnt>47
</span><span class=lnt>48
</span><span class=lnt>49
</span><span class=lnt>50
</span><span class=lnt>51
</span><span class=lnt>52
</span><span class=lnt>53
</span><span class=lnt>54
</span><span class=lnt>55
</span><span class=lnt>56
</span><span class=lnt>57
</span><span class=lnt>58
</span><span class=lnt>59
</span><span class=lnt>60
</span><span class=lnt>61
</span><span class=lnt>62
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-yaml data-lang=yaml><span class=line><span class=cl><span class=nn>---</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span>- <span class=nt>hosts</span><span class=p>:</span><span class=w> </span><span class=l>node2</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>remote_user</span><span class=p>:</span><span class=w> </span><span class=l>root</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>gather_facts</span><span class=p>:</span><span class=w> </span><span class=kc>no</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>tasks</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=c>#file插件可以获取ansible主机中指定文件的内容</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span>- <span class=nt>debug</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>msg</span><span class=p>:</span><span class=w> </span><span class=s2>&#34;{{ lookup(&#39;file&#39;,&#39;/testdir/testfile&#39;) }}&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=c>#env插件可以获取ansible主机中指定变量的值</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span>- <span class=nt>debug</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>msg</span><span class=p>:</span><span class=w> </span><span class=s2>&#34;{{ lookup(&#39;env&#39;,&#39;PATH&#39;) }}&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=c>#first_found插件可以获取列表中第一个找到的文件</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=c>#按照列表顺序在ansible主机中查找</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span>- <span class=nt>debug</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>msg</span><span class=p>:</span><span class=w> </span><span class=s2>&#34;{{ lookup(&#39;first_found&#39;,looklist) }}&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>vars</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>looklist</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span>- <span class=l>/testdir</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span>- <span class=l>/tmp/staging</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=c>#当使用with_first_found时,可以在列表的最后添加- skip: true</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=c>#表示如果列表中的所有文件都没有找到,则跳过当前任务,不会报错</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=c>#当不确定有文件能够被匹配到时,推荐这种方式</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span>- <span class=nt>debug</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>msg</span><span class=p>:</span><span class=w> </span><span class=s2>&#34;{{item}}&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>with_first_found</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span>- <span class=l>/testdir1</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span>- <span class=l>/tmp/staging</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span>- <span class=nt>skip</span><span class=p>:</span><span class=w> </span><span class=kc>true</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=c>#ini插件可以在ansible主机中的ini文件中查找对应key的值</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=c>#如下示例表示从test.ini文件中的testA段落中查找testa1对应的值</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=c>#测试文件/testdir/test.ini的内容如下(不包含注释符#号)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=c>#[testA]</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=c>#testa1=Andy</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=c>#testa2=Armand</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=c>#</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=c>#[testB]</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=c>#testb1=Ben</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span>- <span class=nt>debug</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>msg</span><span class=p>:</span><span class=w> </span><span class=s2>&#34;{{ lookup(&#39;ini&#39;,&#39;testa1 section=testA file=/testdir/test.ini&#39;) }}&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=c>#当未找到对应key时,默认返回空字符串,如果想要指定返回值,可以使用default选项,如下</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=c>#msg: &#34;{{ lookup(&#39;ini&#39;,&#39;test666 section=testA file=/testdir/test.ini default=notfound&#39;) }}&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=c>#可以使用正则表达式匹配对应的键名,需要设置re=true,表示开启正则支持,如下</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=c>#msg: &#34;{{ lookup(&#39;ini&#39;,&#39;testa[12] section=testA file=/testdir/test.ini re=true&#39;) }}&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=c>#ini插件除了可以从ini类型的文件中查找对应key,也可以从properties类型的文件中查找key</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=c>#默认在操作的文件类型为ini,可以使用type指定properties类型,如下例所示</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=c>#如下示例中,application.properties文件内容如下(不包含注释符#号)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=c>#http.port=8080</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=c>#redis.no=0</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=c>#imageCode = 1,2,3</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span>- <span class=nt>debug</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>msg</span><span class=p>:</span><span class=w> </span><span class=s2>&#34;{{ lookup(&#39;ini&#39;,&#39;http.port type=properties file=/testdir/application.properties&#39;) }}&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=c>#dig插件可以获取指定域名的IP地址</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=c>#此插件依赖dnspython库,可使用pip安装pip install dnspython</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=c>#如果域名使用了CDN,可能返回多个地址</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span>- <span class=nt>debug</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>msg</span><span class=p>:</span><span class=w> </span><span class=s2>&#34;{{ lookup(&#39;dig&#39;,&#39;www.baidu.com&#39;,wantlist=true) }}&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=c>#password插件可以生成随机的密码并保存在指定文件中</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span>- <span class=nt>debug</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>msg</span><span class=p>:</span><span class=w> </span><span class=s2>&#34;{{ lookup(&#39;password&#39;,&#39;/tmp/testpasswdfile&#39;) }}&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=c>#以上插件还有一些参数我们没有涉及到,而且也还有很多插件没有总结,等到用到对应的插件时,再行介绍吧</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=c>#你也可以访问官网的lookup插件列表页面,查看各个插件的用法</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=c>#https://docs.ansible.com/ansible/latest/plugins/lookup.html</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div></div><h2 id=循环八><a href=#循环八 class=anchor-link><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512" class="icon anchor-icon"><path d="M326.612 185.391c59.747 59.809 58.927 155.698.36 214.59-.11.12-.24.25-.36.37l-67.2 67.2c-59.27 59.27-155.699 59.262-214.96.0-59.27-59.26-59.27-155.7.0-214.96l37.106-37.106c9.84-9.84 26.786-3.3 27.294 10.606.648 17.722 3.826 35.527 9.69 52.721 1.986 5.822.567 12.262-3.783 16.612l-13.087 13.087c-28.026 28.026-28.905 73.66-1.155 101.96 28.024 28.579 74.086 28.749 102.325.51l67.2-67.19c28.191-28.191 28.073-73.757.0-101.83-3.701-3.694-7.429-6.564-10.341-8.569a16.037 16.037.0 01-6.947-12.606c-.396-10.567 3.348-21.456 11.698-29.806l21.054-21.055c5.521-5.521 14.182-6.199 20.584-1.731a152.482 152.482.0 0120.522 17.197zM467.547 44.449c-59.261-59.262-155.69-59.27-214.96.0l-67.2 67.2c-.12.12-.25.25-.36.37-58.566 58.892-59.387 154.781.36 214.59a152.454 152.454.0 0020.521 17.196c6.402 4.468 15.064 3.789 20.584-1.731l21.054-21.055c8.35-8.35 12.094-19.239 11.698-29.806a16.037 16.037.0 00-6.947-12.606c-2.912-2.005-6.64-4.875-10.341-8.569-28.073-28.073-28.191-73.639.0-101.83l67.2-67.19c28.239-28.239 74.3-28.069 102.325.51 27.75 28.3 26.872 73.934-1.155 101.96l-13.087 13.087c-4.35 4.35-5.769 10.79-3.783 16.612 5.864 17.194 9.042 34.999 9.69 52.721.509 13.906 17.454 20.446 27.294 10.606l37.106-37.106c59.271-59.259 59.271-155.699.001-214.959z"/></svg></a><a href=#contents:循环八 class=headings>#循环(八)</a></h2><p>1,在新版本的ansible中,官方推荐的循环的使用方式不同,在2.6推荐的方式为loop加lookup和loop加filter</p><ul><li>loop的简单使用方式:</li></ul><div class=highlight><div class=chroma><div class=table-container><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-yaml data-lang=yaml><span class=line><span class=cl><span class=nn>---</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span>- <span class=nt>hosts</span><span class=p>:</span><span class=w> </span><span class=l>node2</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>remote_user</span><span class=p>:</span><span class=w> </span><span class=l>root</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>gather_facts</span><span class=p>:</span><span class=w> </span><span class=kc>no</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>tasks</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span>- <span class=nt>debug</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>msg</span><span class=p>:</span><span class=w> </span><span class=s2>&#34;{{ item }}&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>loop</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span>- <span class=l>teststr1</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span>- <span class=l>teststr2</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div></div><ul><li>loop加lookup插件替换with_X</li></ul><div class=highlight><div class=chroma><div class=table-container><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-yaml data-lang=yaml><span class=line><span class=cl><span class=nn>---</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span>- <span class=nt>hosts</span><span class=p>:</span><span class=w> </span><span class=l>node2</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>remote_user</span><span class=p>:</span><span class=w> </span><span class=l>root</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>gather_facts</span><span class=p>:</span><span class=w> </span><span class=kc>no</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>vars</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>users</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>alice</span><span class=p>:</span><span class=w> </span><span class=l>female</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>bob</span><span class=p>:</span><span class=w> </span><span class=l>male</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>tasks</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span>- <span class=nt>debug</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>msg</span><span class=p>:</span><span class=w> </span><span class=s2>&#34;{{item.key}} is {{item.value}}&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>loop</span><span class=p>:</span><span class=w> </span><span class=s2>&#34;{{ lookup(&#39;dict&#39;,users) }}&#34;</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div></div><p>2,在2.6版本开始,官方开始推荐使用"loop加filter"的方式来替代"loop加lookup"的方式</p><ul><li>示例如下:</li></ul><div class=highlight><div class=chroma><div class=table-container><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-yaml data-lang=yaml><span class=line><span class=cl><span class=nn>---</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span>- <span class=nt>hosts</span><span class=p>:</span><span class=w> </span><span class=l>node2</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>remote_user</span><span class=p>:</span><span class=w> </span><span class=l>root</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>gather_facts</span><span class=p>:</span><span class=w> </span><span class=kc>no</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>vars</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>users</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>alice</span><span class=p>:</span><span class=w> </span><span class=l>female</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>bob</span><span class=p>:</span><span class=w> </span><span class=l>male</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>tasks</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span>- <span class=nt>debug</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>msg</span><span class=p>:</span><span class=w> </span><span class=s2>&#34;{{item.key}} is {{item.value}}&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>loop</span><span class=p>:</span><span class=w> </span><span class=s2>&#34;{{ users | dict2items }}&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=c># users是一个字典格式的变量,它的结构是这样的</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=c>#     users:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=c>#       alice: female</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=c>#       bob: male</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=c># 当users字典被dict2items转换处理以后,会变成如下模样</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=c>#     users:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=c>#     - key: alice</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=c>#       value: female</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=c>#     - key: bob</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=c>#       value: male</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div></div><p>3,无论是"with_X"、"loop加lookup"还是"loop加filter",都是使用不同的方式,实现相同的功能而已</p><p>4,替换方式</p><ul><li>with_list</li></ul><div class=highlight><div class=chroma><div class=table-container><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-yaml data-lang=yaml><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=c>#loop可以替代with_list,当处理嵌套的列表时,列表不会被拉平</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nn>---</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span>- <span class=nt>hosts</span><span class=p>:</span><span class=w> </span><span class=l>node2</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>remote_user</span><span class=p>:</span><span class=w> </span><span class=l>root</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>gather_facts</span><span class=p>:</span><span class=w> </span><span class=kc>no</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>vars</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>testlist</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span>- <span class=l>a</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span>- <span class=p>[</span><span class=l>b,c]</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span>- <span class=l>d</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>tasks</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span>- <span class=nt>debug</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>msg</span><span class=p>:</span><span class=w> </span><span class=s2>&#34;{{item}}&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>loop</span><span class=p>:</span><span class=w> </span><span class=s2>&#34;{{testlist}}&#34;</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div></div><ul><li>with_flattened</li></ul><div class=highlight><div class=chroma><div class=table-container><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-yaml data-lang=yaml><span class=line><span class=cl><span class=c>#flatten过滤器可以替代with_flattened,当处理多层嵌套的列表时,列表中所有的嵌套层级都会被拉平</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=c>#示例如下,flatten过滤器的用法在前文中已经总结过,此处不再赘述</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nn>---</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span>- <span class=nt>hosts</span><span class=p>:</span><span class=w> </span><span class=l>node2</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>remote_user</span><span class=p>:</span><span class=w> </span><span class=l>root</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>gather_facts</span><span class=p>:</span><span class=w> </span><span class=kc>no</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>vars</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>testlist</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span>- <span class=l>a</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span>- <span class=p>[</span><span class=l>b,c]</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span>- <span class=l>d</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>tasks</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span>- <span class=nt>debug</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>msg</span><span class=p>:</span><span class=w> </span><span class=s2>&#34;{{item}}&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>loop</span><span class=p>:</span><span class=w> </span><span class=s2>&#34;{{testlist | flatten}}&#34;</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div></div><ul><li>with_items</li></ul><div class=highlight><div class=chroma><div class=table-container><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-yaml data-lang=yaml><span class=line><span class=cl><span class=c>#flatten过滤器（加参数）可以替代with_items,当处理多层嵌套的列表时,只有列表中的第一层会被拉平</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nn>---</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span>- <span class=nt>hosts</span><span class=p>:</span><span class=w> </span><span class=l>node2</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>remote_user</span><span class=p>:</span><span class=w> </span><span class=l>root</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>gather_facts</span><span class=p>:</span><span class=w> </span><span class=kc>no</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>vars</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>testlist</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span>- <span class=l>a</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span>- <span class=p>[</span><span class=l>b,c]</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span>- <span class=l>d</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>tasks</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span>- <span class=nt>debug</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>msg</span><span class=p>:</span><span class=w> </span><span class=s2>&#34;{{item}}&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>loop</span><span class=p>:</span><span class=w> </span><span class=s2>&#34;{{testlist | flatten(levels=1)}}&#34;</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div></div><ul><li>with_indexed_items</li></ul><div class=highlight><div class=chroma><div class=table-container><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-yaml data-lang=yaml><span class=line><span class=cl><span class=c>#flatten过滤器（加参数）,再配合loop_control关键字,可以替代with_indexed_items</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=c>#当处理多层嵌套的列表时,只有列表中的第一层会被拉平,flatten过滤器的bug暂且忽略</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=c>#示例如下,之后会对示例进行解释</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nn>---</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span>- <span class=nt>hosts</span><span class=p>:</span><span class=w> </span><span class=l>node2</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>remote_user</span><span class=p>:</span><span class=w> </span><span class=l>root</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>gather_facts</span><span class=p>:</span><span class=w> </span><span class=kc>no</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>vars</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>testlist</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span>- <span class=l>a</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span>- <span class=p>[</span><span class=l>b,c]</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span>- <span class=l>d</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>tasks</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span>- <span class=nt>debug</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>msg</span><span class=p>:</span><span class=w> </span><span class=s2>&#34;{{index}}--{{item}}&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>loop</span><span class=p>:</span><span class=w> </span><span class=s2>&#34;{{testlist | flatten(levels=1)}}&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>loop_control</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>index_var</span><span class=p>:</span><span class=w> </span><span class=l>index</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=c># &#34;loop_control&#34;关键字可以用于控制循环的行为,比如在循环时获取到元素的索引.</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=c># &#34;index_var&#34;是&#34;loop_control&#34;的一个设置选项,&#34;index_var&#34;的作用是让我们指定一个变量,&#34;loop_control&#34;会将列表元素的索引值存放到这个指定的变量中,比如如下配置</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>loop_control</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>index_var</span><span class=p>:</span><span class=w> </span><span class=l>my_idx</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=c># 上述设置表示,在遍历列表时,当前被遍历元素的索引会被放置到&#34;my_idx&#34;变量中,也就是说,当进行循环操作时,只要获取到&#34;my_idx&#34;变量的值,就能获取到当前元素的索引值</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=c># loop_control还有其他的选项可以使用,当前暂时不列举</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div></div><ul><li>with_together</li></ul><div class=highlight><div class=chroma><div class=table-container><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-yaml data-lang=yaml><span class=line><span class=cl><span class=c>#zip_longest过滤器配合list过滤器,可以替代with_together</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nn>---</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span>- <span class=nt>hosts</span><span class=p>:</span><span class=w> </span><span class=l>node2</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>remote_user</span><span class=p>:</span><span class=w> </span><span class=l>root</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>gather_facts</span><span class=p>:</span><span class=w> </span><span class=kc>no</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>vars</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>testlist1</span><span class=p>:</span><span class=w> </span><span class=p>[</span><span class=w> </span><span class=l>a, b ]</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>testlist2</span><span class=p>:</span><span class=w> </span><span class=p>[</span><span class=w> </span><span class=m>1</span><span class=p>,</span><span class=w> </span><span class=m>2</span><span class=p>,</span><span class=w> </span><span class=m>3</span><span class=w> </span><span class=p>]</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>testlist3</span><span class=p>:</span><span class=w> </span><span class=p>[</span><span class=w> </span><span class=l>A, B, C, D ]</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>tasks</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span>- <span class=nt>debug</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>msg</span><span class=p>:</span><span class=w> </span><span class=s2>&#34;{{ item.0 }} - {{ item.1 }} - {{item.2}}&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>with_together</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span>- <span class=s2>&#34;{{testlist1}}&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span>- <span class=s2>&#34;{{testlist2}}&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span>- <span class=s2>&#34;{{testlist3}}&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span>- <span class=nt>debug</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>msg</span><span class=p>:</span><span class=w> </span><span class=s2>&#34;{{ item.0 }} - {{ item.1 }} - {{item.2}}&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>loop</span><span class=p>:</span><span class=w> </span><span class=s2>&#34;{{ testlist1 | zip_longest(testlist2,testlist3) | list }}&#34;</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div></div><ul><li>with_nested/with_cartesian</li></ul><div class=highlight><div class=chroma><div class=table-container><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-yaml data-lang=yaml><span class=line><span class=cl><span class=c>#product过滤器配合list过滤器,可以替代with_nested和with_cartesian</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=c>#如果你忘了with_nested和with_cartesian的用法,可以回顾前文</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nn>---</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span>- <span class=nt>hosts</span><span class=p>:</span><span class=w> </span><span class=l>node2</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>remote_user</span><span class=p>:</span><span class=w> </span><span class=l>root</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>gather_facts</span><span class=p>:</span><span class=w> </span><span class=kc>no</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>vars</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>testlist1</span><span class=p>:</span><span class=w> </span><span class=p>[</span><span class=w> </span><span class=l>a, b, c ]</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>testlist2</span><span class=p>:</span><span class=w> </span><span class=p>[</span><span class=w> </span><span class=m>1</span><span class=p>,</span><span class=w> </span><span class=m>2</span><span class=p>,</span><span class=w> </span><span class=m>3</span><span class=p>,</span><span class=w> </span><span class=m>4</span><span class=w> </span><span class=p>]</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>tasks</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span>- <span class=nt>debug</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>msg</span><span class=p>:</span><span class=w> </span><span class=s2>&#34;{{ item.0 }}--{{ item.1 }}&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>loop</span><span class=p>:</span><span class=w> </span><span class=s2>&#34;{{ testlist1 | product(testlist2) | list }}&#34;</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div></div><ul><li>with_sequence</li></ul><div class=highlight><div class=chroma><div class=table-container><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-yaml data-lang=yaml><span class=line><span class=cl><span class=c>#range过滤器配合list过滤器可以代替with_sequence</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=c>#你可以先回顾一下with_sequence的用法,然后再测试如下示例</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nn>---</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span>- <span class=nt>hosts</span><span class=p>:</span><span class=w> </span><span class=l>node2</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>remote_user</span><span class=p>:</span><span class=w> </span><span class=l>root</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>gather_facts</span><span class=p>:</span><span class=w> </span><span class=kc>no</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>tasks</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span>- <span class=nt>debug</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>msg</span><span class=p>:</span><span class=w> </span><span class=s2>&#34;{{item}}&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>loop</span><span class=p>:</span><span class=w> </span><span class=s2>&#34;{{ range(0, 6, 2) | list }}&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=c># 需要格式化功能时:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span>- <span class=nt>debug</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>msg</span><span class=p>:</span><span class=w> </span><span class=s2>&#34;{{ &#39;number is %0.2f&#39; | format(item) }}&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>loop</span><span class=p>:</span><span class=w> </span><span class=s2>&#34;{{ range(2, 7, 2) | list }}&#34;</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div></div><ul><li>with_random_choice</li></ul><div class=highlight><div class=chroma><div class=table-container><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-yaml data-lang=yaml><span class=line><span class=cl><span class=c>#使用random函数可以替代with_random_choice,由于random函数是随机取出列表中的一个值,并不涉及循环操作,所以并不用使用loop关键字.</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nn>---</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span>- <span class=nt>hosts</span><span class=p>:</span><span class=w> </span><span class=l>node2</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>remote_user</span><span class=p>:</span><span class=w> </span><span class=l>root</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>gather_facts</span><span class=p>:</span><span class=w> </span><span class=kc>no</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>vars</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>testlist</span><span class=p>:</span><span class=w> </span><span class=p>[</span><span class=w> </span><span class=l>a, b, c ]</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>tasks</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span>- <span class=nt>debug</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>msg</span><span class=p>:</span><span class=w> </span><span class=s2>&#34;{{ testlist | random }}&#34;</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div></div><ul><li>with_dict</li></ul><div class=highlight><div class=chroma><div class=table-container><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-yaml data-lang=yaml><span class=line><span class=cl><span class=c>#除了上文总结的dict2items过滤器,dictsort过滤器也可以替代with_dict</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nn>---</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span>- <span class=nt>hosts</span><span class=p>:</span><span class=w> </span><span class=l>node2</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>remote_user</span><span class=p>:</span><span class=w> </span><span class=l>root</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>gather_facts</span><span class=p>:</span><span class=w> </span><span class=kc>no</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>vars</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>users</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>d</span><span class=p>:</span><span class=w> </span><span class=l>daisy</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>c</span><span class=p>:</span><span class=w> </span><span class=l>carol</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>a</span><span class=p>:</span><span class=w> </span><span class=l>alice</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>b</span><span class=p>:</span><span class=w> </span><span class=l>bob</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>e</span><span class=p>:</span><span class=w> </span><span class=l>ella</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>tasks</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span>- <span class=nt>debug</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>msg</span><span class=p>:</span><span class=w> </span><span class=s2>&#34;{{item.key}} -- {{item.value}}&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>loop</span><span class=p>:</span><span class=w> </span><span class=s2>&#34;{{ users | dict2items }}&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span>- <span class=nt>debug</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>msg</span><span class=p>:</span><span class=w> </span><span class=s2>&#34;{{item.0}} -- {{item.1}}&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>loop</span><span class=p>:</span><span class=w> </span><span class=s2>&#34;{{ users | dictsort }}&#34;</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div></div><ul><li>with_subelements</li></ul><div class=highlight><div class=chroma><div class=table-container><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-yaml data-lang=yaml><span class=line><span class=cl><span class=c>#subelements过滤器可以替代with_subelements</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nn>---</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span>- <span class=nt>hosts</span><span class=p>:</span><span class=w> </span><span class=l>node2</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>remote_user</span><span class=p>:</span><span class=w> </span><span class=l>root</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>gather_facts</span><span class=p>:</span><span class=w> </span><span class=kc>no</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>vars</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>users</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span>- <span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>bob</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>gender</span><span class=p>:</span><span class=w> </span><span class=l>male</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>hobby</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span>- <span class=l>Skateboard</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span>- <span class=l>VideoGame</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span>- <span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>alice</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>gender</span><span class=p>:</span><span class=w> </span><span class=l>female</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>hobby</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span>- <span class=l>Music</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>tasks</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span>- <span class=nt>debug</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>msg</span><span class=p>:</span><span class=w> </span><span class=s2>&#34;{{item.0.name}}&#39;s hobby is {{item.1}}&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>with_subelements</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span>- <span class=s2>&#34;{{users}}&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span>- <span class=l>hobby</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span>- <span class=nt>debug</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>msg</span><span class=p>:</span><span class=w> </span><span class=s2>&#34;{{item.0.name}}&#39;s hobby is {{item.1}}&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>loop</span><span class=p>:</span><span class=w> </span><span class=s2>&#34;{{users | subelements(&#39;hobby&#39;)}}&#34;</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div></div><p>5,loop_control的其他参数使用</p><ul><li>pause选项</li></ul><div class=highlight><div class=chroma><div class=table-container><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-yaml data-lang=yaml><span class=line><span class=cl><span class=nn>---</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span>- <span class=nt>hosts</span><span class=p>:</span><span class=w> </span><span class=l>node2</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>remote_user</span><span class=p>:</span><span class=w> </span><span class=l>root</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>gather_facts</span><span class=p>:</span><span class=w> </span><span class=kc>no</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>tasks</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span>- <span class=nt>debug</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>msg</span><span class=p>:</span><span class=w> </span><span class=s2>&#34;{{item}}&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>loop</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span>- <span class=m>1</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span>- <span class=m>2</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span>- <span class=m>3</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>loop_control</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>pause</span><span class=p>:</span><span class=w> </span><span class=m>10</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=c># 上例表示每次循环之间间隔10秒</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div></div><ul><li>label</li></ul><div class=highlight><div class=chroma><div class=table-container><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span><span class=lnt>32
</span><span class=lnt>33
</span><span class=lnt>34
</span><span class=lnt>35
</span><span class=lnt>36
</span><span class=lnt>37
</span><span class=lnt>38
</span><span class=lnt>39
</span><span class=lnt>40
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-yaml data-lang=yaml><span class=line><span class=cl><span class=nn>---</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span>- <span class=nt>hosts</span><span class=p>:</span><span class=w> </span><span class=l>node2</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>remote_user</span><span class=p>:</span><span class=w> </span><span class=l>root</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>gather_facts</span><span class=p>:</span><span class=w> </span><span class=kc>no</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>vars</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>users</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>alice</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>Alice Appleworth</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nt>gender</span><span class=p>:</span><span class=w> </span><span class=l>female</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nt>telephone</span><span class=p>:</span><span class=w> </span><span class=m>123-456-7890</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>bob</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>Bob Bananarama</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nt>gender</span><span class=p>:</span><span class=w> </span><span class=l>male</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nt>telephone</span><span class=p>:</span><span class=w> </span><span class=m>987-654-3210</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>tasks</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span>- <span class=nt>debug</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>msg</span><span class=p>:</span><span class=w> </span><span class=s2>&#34;{{item.key}}&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>loop</span><span class=p>:</span><span class=w> </span><span class=s2>&#34;{{users | dict2items}}&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=c># 此处输出内容太多,对于需要查找的内容较难找到</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=c># label选项的作用,它可以在循环输出信息时,简化输出item的信息</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nn>---</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span>- <span class=nt>hosts</span><span class=p>:</span><span class=w> </span><span class=l>node2</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>remote_user</span><span class=p>:</span><span class=w> </span><span class=l>root</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>gather_facts</span><span class=p>:</span><span class=w> </span><span class=kc>no</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>vars</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>users</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>alice</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>Alice Appleworth</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nt>gender</span><span class=p>:</span><span class=w> </span><span class=l>female</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nt>telephone</span><span class=p>:</span><span class=w> </span><span class=m>123-456-7890</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>bob</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>Bob Bananarama</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nt>gender</span><span class=p>:</span><span class=w> </span><span class=l>male</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nt>telephone</span><span class=p>:</span><span class=w> </span><span class=m>987-654-3210</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>tasks</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span>- <span class=nt>debug</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>msg</span><span class=p>:</span><span class=w> </span><span class=s2>&#34;{{item.key}}&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>loop</span><span class=p>:</span><span class=w> </span><span class=s2>&#34;{{users | dict2items}}&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>loop_control</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>label</span><span class=p>:</span><span class=w> </span><span class=s2>&#34;{{item.key}}&#34;</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div></div><h2 id=include><a href=#include class=anchor-link><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512" class="icon anchor-icon"><path d="M326.612 185.391c59.747 59.809 58.927 155.698.36 214.59-.11.12-.24.25-.36.37l-67.2 67.2c-59.27 59.27-155.699 59.262-214.96.0-59.27-59.26-59.27-155.7.0-214.96l37.106-37.106c9.84-9.84 26.786-3.3 27.294 10.606.648 17.722 3.826 35.527 9.69 52.721 1.986 5.822.567 12.262-3.783 16.612l-13.087 13.087c-28.026 28.026-28.905 73.66-1.155 101.96 28.024 28.579 74.086 28.749 102.325.51l67.2-67.19c28.191-28.191 28.073-73.757.0-101.83-3.701-3.694-7.429-6.564-10.341-8.569a16.037 16.037.0 01-6.947-12.606c-.396-10.567 3.348-21.456 11.698-29.806l21.054-21.055c5.521-5.521 14.182-6.199 20.584-1.731a152.482 152.482.0 0120.522 17.197zM467.547 44.449c-59.261-59.262-155.69-59.27-214.96.0l-67.2 67.2c-.12.12-.25.25-.36.37-58.566 58.892-59.387 154.781.36 214.59a152.454 152.454.0 0020.521 17.196c6.402 4.468 15.064 3.789 20.584-1.731l21.054-21.055c8.35-8.35 12.094-19.239 11.698-29.806a16.037 16.037.0 00-6.947-12.606c-2.912-2.005-6.64-4.875-10.341-8.569-28.073-28.073-28.191-73.639.0-101.83l67.2-67.19c28.239-28.239 74.3-28.069 102.325.51 27.75 28.3 26.872 73.934-1.155 101.96l-13.087 13.087c-4.35 4.35-5.769 10.79-3.783 16.612 5.864 17.194 9.042 34.999 9.69 52.721.509 13.906 17.454 20.446 27.294 10.606l37.106-37.106c59.271-59.259 59.271-155.699.001-214.959z"/></svg></a><a href=#contents:include class=headings>#include</a></h2><p>1,ansible中有类似编程语言中类似函数调用的功能,就是include,通过include,可以在一个playbook中包含另一个文件</p><ul><li>include模块可以指定一个文件,这个文件中的内容是一个任务列表（一个或多个任务）,使用include模块引用对应的文件时,文件中的任务会在被引用处执行,就像写在被引用处一样</li></ul><div class=highlight><div class=chroma><div class=table-container><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-yaml data-lang=yaml><span class=line><span class=cl><span class=c># cat lamp.yml</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nn>---</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span>- <span class=nt>hosts</span><span class=p>:</span><span class=w> </span><span class=l>node2</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>remote_user</span><span class=p>:</span><span class=w> </span><span class=l>root</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>gather_facts</span><span class=p>:</span><span class=w> </span><span class=kc>no</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>tasks</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span>- <span class=nt>include</span><span class=p>:</span><span class=w> </span><span class=l>install_MysqlAndPhp.yml</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span>- <span class=nt>yum</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>httpd</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>state</span><span class=p>:</span><span class=w> </span><span class=l>present</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w> 
</span></span></span><span class=line><span class=cl><span class=w></span><span class=c># cat lnmp.yml</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nn>---</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span>- <span class=nt>hosts</span><span class=p>:</span><span class=w> </span><span class=l>node2</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>remote_user</span><span class=p>:</span><span class=w> </span><span class=l>root</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>gather_facts</span><span class=p>:</span><span class=w> </span><span class=kc>no</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>tasks</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span>- <span class=nt>include</span><span class=p>:</span><span class=w> </span><span class=l>install_MysqlAndPhp.yml</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span>- <span class=nt>yum</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>nginx</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>state</span><span class=p>:</span><span class=w> </span><span class=l>present</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=c># cat install_MysqlAndPhp.yml</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span>- <span class=nt>yum</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>mysql</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>state</span><span class=p>:</span><span class=w> </span><span class=l>present</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span>- <span class=nt>yum</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>php-fpm</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>state</span><span class=p>:</span><span class=w> </span><span class=l>present</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div></div><p>2,在handlers关键字中,也可以使用include,handlers也是一种任务,只是这种任务有相应的触发条件而已</p><ul><li>如下示例:</li></ul><div class=highlight><div class=chroma><div class=table-container><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-yaml data-lang=yaml><span class=line><span class=cl><span class=c># cat test_include.yml</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nn>---</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span>- <span class=nt>hosts</span><span class=p>:</span><span class=w> </span><span class=l>node2</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>remote_user</span><span class=p>:</span><span class=w> </span><span class=l>root</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>gather_facts</span><span class=p>:</span><span class=w> </span><span class=kc>no</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>tasks</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span>- <span class=nt>file</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>     </span><span class=nt>path</span><span class=p>:</span><span class=w> </span><span class=l>/opt/ttt</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>     </span><span class=nt>state</span><span class=p>:</span><span class=w> </span><span class=l>touch</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>notify</span><span class=p>:</span><span class=w> </span><span class=l>test include handlers</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w> 
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>handlers</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span>- <span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>test include handlers</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>include</span><span class=p>:</span><span class=w> </span><span class=l>include_handler.yml</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w> 
</span></span></span><span class=line><span class=cl><span class=w></span><span class=c># cat include_handler.yml</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span>- <span class=nt>debug</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>msg</span><span class=p>:</span><span class=w> </span><span class=s2>&#34;task1 of handlers&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span>- <span class=nt>debug</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>msg</span><span class=p>:</span><span class=w> </span><span class=s2>&#34;task2 of handlers&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span>- <span class=nt>debug</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>msg</span><span class=p>:</span><span class=w> </span><span class=s2>&#34;task3 of handlers&#34;</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div></div><p>3,"include"不仅能够引用任务列表,还能够引用playbook,比如,在一个playbook中引用另一个playbook</p><ul><li>示例如下:</li></ul><div class=highlight><div class=chroma><div class=table-container><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-yaml data-lang=yaml><span class=line><span class=cl><span class=c># cat lamp.yml</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nn>---</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span>- <span class=nt>hosts</span><span class=p>:</span><span class=w> </span><span class=l>node2</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>remote_user</span><span class=p>:</span><span class=w> </span><span class=l>root</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>gather_facts</span><span class=p>:</span><span class=w> </span><span class=kc>no</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>tasks</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span>- <span class=nt>include</span><span class=p>:</span><span class=w> </span><span class=l>install_MysqlAndPhp.yml</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span>- <span class=nt>yum</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>httpd</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>state</span><span class=p>:</span><span class=w> </span><span class=l>present</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w> 
</span></span></span><span class=line><span class=cl><span class=w></span>- <span class=nt>include</span><span class=p>:</span><span class=w> </span><span class=l>lnmp.yml</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=c># 在lamp.yml的结尾引入了lnmp.yml,当我们在执行lamp.yml时,会先执行lamp相关的任务,然后再执行lnmp.yml中的任务.</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div></div><p>4,include还可以接受一些参数</p><ul><li>如下所示</li></ul><div class=highlight><div class=chroma><div class=table-container><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-yaml data-lang=yaml><span class=line><span class=cl><span class=c># cat test_include1.yml</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nn>---</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span>- <span class=nt>hosts</span><span class=p>:</span><span class=w> </span><span class=l>node2</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>remote_user</span><span class=p>:</span><span class=w> </span><span class=l>root</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>gather_facts</span><span class=p>:</span><span class=w> </span><span class=kc>no</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>tasks</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span>- <span class=nt>include</span><span class=p>:</span><span class=w> </span><span class=l>in.yml</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>     </span><span class=l>test_var1=hello</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>     </span><span class=l>test_var2=test</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w> 
</span></span></span><span class=line><span class=cl><span class=w></span><span class=c># cat in.yml</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span>- <span class=nt>debug</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>msg</span><span class=p>:</span><span class=w> </span><span class=s2>&#34;{{ test_var1 }}&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span>- <span class=nt>debug</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>msg</span><span class=p>:</span><span class=w> </span><span class=s2>&#34;{{ test_var2 }}&#34;</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div></div><ul><li>还能够使用vars关键字,以key: value变量的方式传入参数变量</li></ul><div class=highlight><div class=chroma><div class=table-container><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-yaml data-lang=yaml><span class=line><span class=cl><span class=w>  </span><span class=nt>tasks</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span>- <span class=nt>include</span><span class=p>:</span><span class=w> </span><span class=l>in.yml</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>vars</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>     </span><span class=nt>test_var1</span><span class=p>:</span><span class=w> </span><span class=l>hello</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>     </span><span class=nt>test_var2</span><span class=p>:</span><span class=w> </span><span class=l>test</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div></div><ul><li>通过vars关键字也能够传入结构稍微复杂的变量数据,以便在包含的文件中使用,示例如下:</li></ul><div class=highlight><div class=chroma><div class=table-container><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-yaml data-lang=yaml><span class=line><span class=cl><span class=c># cat test_include1.yml</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nn>---</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span>- <span class=nt>hosts</span><span class=p>:</span><span class=w> </span><span class=l>node2</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>remote_user</span><span class=p>:</span><span class=w> </span><span class=l>root</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>gather_facts</span><span class=p>:</span><span class=w> </span><span class=kc>no</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>tasks</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span>- <span class=nt>include</span><span class=p>:</span><span class=w> </span><span class=l>in.yml</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>vars</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>     </span><span class=nt>users</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>bob</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nt>gender</span><span class=p>:</span><span class=w> </span><span class=l>male</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>lucy</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nt>gender</span><span class=p>:</span><span class=w> </span><span class=l>female</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>         
</span></span></span><span class=line><span class=cl><span class=w></span><span class=c># cat in.yml</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span>- <span class=nt>debug</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>msg</span><span class=p>:</span><span class=w> </span><span class=s2>&#34;{{ item.key}} is {{ item.value.gender }}&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>loop</span><span class=p>:</span><span class=w> </span><span class=s2>&#34;{{ users | dict2items }}&#34;</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div></div><p>5,可以针对某个include去打标签</p><ul><li>如下示例:</li></ul><div class=highlight><div class=chroma><div class=table-container><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-yaml data-lang=yaml><span class=line><span class=cl><span class=c># cat test_include1.yml</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nn>---</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span>- <span class=nt>hosts</span><span class=p>:</span><span class=w> </span><span class=l>node2</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>remote_user</span><span class=p>:</span><span class=w> </span><span class=l>root</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>gather_facts</span><span class=p>:</span><span class=w> </span><span class=kc>no</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>tasks</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span>- <span class=nt>include</span><span class=p>:</span><span class=w> </span><span class=l>in1.yml</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>tags</span><span class=p>:</span><span class=w> </span><span class=l>t1</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span>- <span class=nt>include</span><span class=p>:</span><span class=w> </span><span class=l>in2.yml</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>tags</span><span class=p>:</span><span class=w> </span><span class=l>t2</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w> 
</span></span></span><span class=line><span class=cl><span class=w></span><span class=c># cat in1.yml</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span>- <span class=nt>debug</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>msg</span><span class=p>:</span><span class=w> </span><span class=s2>&#34;task1 in in1.yml&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span>- <span class=nt>debug</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>msg</span><span class=p>:</span><span class=w> </span><span class=s2>&#34;task2 in in1.yml&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w> 
</span></span></span><span class=line><span class=cl><span class=w></span><span class=c># cat in2.yml</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span>- <span class=nt>debug</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>msg</span><span class=p>:</span><span class=w> </span><span class=s2>&#34;task1 in in2.yml&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span>- <span class=nt>debug</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>msg</span><span class=p>:</span><span class=w> </span><span class=s2>&#34;task2 in in2.yml&#34;</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div></div><ul><li>可以对include添加条件判断,还可以对include进行循环操作</li></ul><div class=highlight><div class=chroma><div class=table-container><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-yaml data-lang=yaml><span class=line><span class=cl><span class=c># cat test_include1.yml</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nn>---</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span>- <span class=nt>hosts</span><span class=p>:</span><span class=w> </span><span class=l>node2</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>remote_user</span><span class=p>:</span><span class=w> </span><span class=l>root</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>gather_facts</span><span class=p>:</span><span class=w> </span><span class=kc>no</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>tasks</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span>- <span class=nt>include</span><span class=p>:</span><span class=w> </span><span class=l>in3.yml</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>when</span><span class=p>:</span><span class=w> </span><span class=m>2</span><span class=w> </span><span class=l>&gt; 1</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span>- <span class=nt>include</span><span class=p>:</span><span class=w> </span><span class=l>in3.yml</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>loop</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span>- <span class=m>1</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span>- <span class=m>2</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span>- <span class=m>3</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w> 
</span></span></span><span class=line><span class=cl><span class=w></span><span class=c># cat in3.yml</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span>- <span class=nt>debug</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>msg</span><span class=p>:</span><span class=w> </span><span class=s2>&#34;task1 in in3.yml&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span>- <span class=nt>debug</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>msg</span><span class=p>:</span><span class=w> </span><span class=s2>&#34;task2 in in3.yml&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=c># 循环的调用多个任务,可以使用上例中的方法,将需要循环调用的多个任务写入到一个yml文件中,然后使用include调用这个yml文件,再配合loop进行循环即可</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div></div><p>6,loop_control中loop_var的使用</p><ul><li>如下示例:</li></ul><div class=highlight><div class=chroma><div class=table-container><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-yaml data-lang=yaml><span class=line><span class=cl><span class=c># cat A.yml</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nn>---</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span>- <span class=nt>hosts</span><span class=p>:</span><span class=w> </span><span class=l>node2</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>remote_user</span><span class=p>:</span><span class=w> </span><span class=l>root</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>gather_facts</span><span class=p>:</span><span class=w> </span><span class=kc>no</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>tasks</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span>- <span class=nt>include</span><span class=p>:</span><span class=w> </span><span class=l>B.yml</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>loop</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span>- <span class=m>1</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span>- <span class=m>2</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w> 
</span></span></span><span class=line><span class=cl><span class=w></span><span class=c># cat B.yml</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span>- <span class=nt>debug</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>msg</span><span class=p>:</span><span class=w> </span><span class=s2>&#34;{{item}}--task in B.yml&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>loop</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span>- <span class=l>a</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span>- <span class=l>b</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span>- <span class=l>c</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=c># B.yml中循环调用了debug模块,而在A.yml中,又循环的调用了B.yml,当出现这种&#34;双层循环&#34;的情况时,B文件中的item信息只打印B中的列表内容</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div></div><ul><li>若要获取上例中外层item的值,可以使用loop_control中loop_var选项</li></ul><div class=highlight><div class=chroma><div class=table-container><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-yaml data-lang=yaml><span class=line><span class=cl><span class=c># cat A.yml</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nn>---</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span>- <span class=nt>hosts</span><span class=p>:</span><span class=w> </span><span class=l>node2</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>remote_user</span><span class=p>:</span><span class=w> </span><span class=l>root</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>gather_facts</span><span class=p>:</span><span class=w> </span><span class=kc>no</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>tasks</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span>- <span class=nt>include</span><span class=p>:</span><span class=w> </span><span class=l>B.yml</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>loop</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span>- <span class=m>1</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span>- <span class=m>2</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>loop_control</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>loop_var</span><span class=p>:</span><span class=w> </span><span class=l>outer_item</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w> 
</span></span></span><span class=line><span class=cl><span class=w></span><span class=c># cat B.yml</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span>- <span class=nt>debug</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>msg</span><span class=p>:</span><span class=w> </span><span class=s2>&#34;{{outer_item}}--{{item}}--task in B.yml&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>loop</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span>- <span class=l>a</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span>- <span class=l>b</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span>- <span class=l>c</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=c># 将loop_var选项的值设置为&#34;outer_item&#34;,这表示,我们将外层循环的item值存放在了&#34;outer_item&#34;变量中,在B文件中的debug任务中,同时输出了&#34;outer_item&#34;变量和&#34;item&#34;变量的值</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div></div><h2 id=include二><a href=#include二 class=anchor-link><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512" class="icon anchor-icon"><path d="M326.612 185.391c59.747 59.809 58.927 155.698.36 214.59-.11.12-.24.25-.36.37l-67.2 67.2c-59.27 59.27-155.699 59.262-214.96.0-59.27-59.26-59.27-155.7.0-214.96l37.106-37.106c9.84-9.84 26.786-3.3 27.294 10.606.648 17.722 3.826 35.527 9.69 52.721 1.986 5.822.567 12.262-3.783 16.612l-13.087 13.087c-28.026 28.026-28.905 73.66-1.155 101.96 28.024 28.579 74.086 28.749 102.325.51l67.2-67.19c28.191-28.191 28.073-73.757.0-101.83-3.701-3.694-7.429-6.564-10.341-8.569a16.037 16.037.0 01-6.947-12.606c-.396-10.567 3.348-21.456 11.698-29.806l21.054-21.055c5.521-5.521 14.182-6.199 20.584-1.731a152.482 152.482.0 0120.522 17.197zM467.547 44.449c-59.261-59.262-155.69-59.27-214.96.0l-67.2 67.2c-.12.12-.25.25-.36.37-58.566 58.892-59.387 154.781.36 214.59a152.454 152.454.0 0020.521 17.196c6.402 4.468 15.064 3.789 20.584-1.731l21.054-21.055c8.35-8.35 12.094-19.239 11.698-29.806a16.037 16.037.0 00-6.947-12.606c-2.912-2.005-6.64-4.875-10.341-8.569-28.073-28.073-28.191-73.639.0-101.83l67.2-67.19c28.239-28.239 74.3-28.069 102.325.51 27.75 28.3 26.872 73.934-1.155 101.96l-13.087 13.087c-4.35 4.35-5.769 10.79-3.783 16.612 5.864 17.194 9.042 34.999 9.69 52.721.509 13.906 17.454 20.446 27.294 10.606l37.106-37.106c59.271-59.259 59.271-155.699.001-214.959z"/></svg></a><a href=#contents:include二 class=headings>#include(二)</a></h2><p>1,"include"的某些原始用法在之后的版本中可能会被弃用,在之后的版本中,会使用一些新的关键字代替这些原始用法</p><p>2,include_task模块</p><ul><li>include模块可以用来包含一个任务列表,include_tasks模块的作用也是用来包含一个任务列表,在之后的版本中,如果我们想要包含一个任务列表,那么就可以使用"include_tasks"关键字代替"include"关键字,示例如下:</li></ul><div class=highlight><div class=chroma><div class=table-container><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-yaml data-lang=yaml><span class=line><span class=cl><span class=c># cat intest.yml</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nn>---</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span>- <span class=nt>hosts</span><span class=p>:</span><span class=w> </span><span class=l>node2</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>remote_user</span><span class=p>:</span><span class=w> </span><span class=l>root</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>gather_facts</span><span class=p>:</span><span class=w> </span><span class=kc>no</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>tasks</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span>- <span class=nt>debug</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>msg</span><span class=p>:</span><span class=w> </span><span class=s2>&#34;test task1&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span>- <span class=nt>include_tasks</span><span class=p>:</span><span class=w> </span><span class=l>in.yml</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span>- <span class=nt>debug</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>msg</span><span class=p>:</span><span class=w> </span><span class=s2>&#34;test task2&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w> 
</span></span></span><span class=line><span class=cl><span class=w></span><span class=c># cat in.yml</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span>- <span class=nt>debug</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>msg</span><span class=p>:</span><span class=w> </span><span class=s2>&#34;task1 in in.yml&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span>- <span class=nt>debug</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>msg</span><span class=p>:</span><span class=w> </span><span class=s2>&#34;task2 in in.yml&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=c># 当我们使用&#34;include_tasks&#34;时,&#34;include_tasks&#34;本身会被当做一个&#34;task&#34;,这个&#34;task&#34;会把被include的文件的路径输出在控制台中</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=c># &#34;include&#34;是透明的,&#34;include_tasks&#34;是可见的,&#34;include_tasks&#34;更像是一个任务,这个任务包含了其他的一些任务</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div></div><p>3,在2.7版本之后,include_tasks模块加入了file和apply参数</p><ul><li>file参数</li></ul><div class=highlight><div class=chroma><div class=table-container><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-yaml data-lang=yaml><span class=line><span class=cl><span class=w>  </span>- <span class=nt>include_tasks</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>file</span><span class=p>:</span><span class=w> </span><span class=l>in.yml</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span>- <span class=nt>include_tasks</span><span class=p>:</span><span class=w> </span><span class=l>in.yml</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=c># 两种方式其实完全相同,只不过一个使用了&#34;file&#34;参数的方式,另一个使用了&#34;free_form&#34;的方式,虽然语法上不同,但是本质上没有区别</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div></div><ul><li>apply参数</li></ul><div class=highlight><div class=chroma><div class=table-container><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span><span class=lnt>32
</span><span class=lnt>33
</span><span class=lnt>34
</span><span class=lnt>35
</span><span class=lnt>36
</span><span class=lnt>37
</span><span class=lnt>38
</span><span class=lnt>39
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-yaml data-lang=yaml><span class=line><span class=cl><span class=c># cat intest.yml</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nn>---</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span>- <span class=nt>hosts</span><span class=p>:</span><span class=w> </span><span class=l>node2</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>remote_user</span><span class=p>:</span><span class=w> </span><span class=l>root</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>gather_facts</span><span class=p>:</span><span class=w> </span><span class=kc>no</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>tasks</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span>- <span class=nt>debug</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>msg</span><span class=p>:</span><span class=w> </span><span class=s2>&#34;test task1&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span>- <span class=nt>include_tasks</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>file</span><span class=p>:</span><span class=w> </span><span class=l>in.yml</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>tags</span><span class=p>:</span><span class=w> </span><span class=l>t1</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span>- <span class=nt>debug</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>msg</span><span class=p>:</span><span class=w> </span><span class=s2>&#34;test task2&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=c># &#34;include_tasks&#34;这个任务本身被调用了,而&#34;include_tasks&#34;对应文件中的任务却没有被调用</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=c># &#34;include_tasks&#34;与&#34;include&#34;并不相同,标签只会对&#34;include_tasks&#34;任务本身生效,而不会对其中包含的任务生效</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=c># 如果想要tags对&#34;include_tasks&#34;中包含的所有任务都生效,需要使用到&#34;include_tasks&#34;模块的apply参数</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nn>---</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span>- <span class=nt>hosts</span><span class=p>:</span><span class=w> </span><span class=l>node2</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>remote_user</span><span class=p>:</span><span class=w> </span><span class=l>root</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>gather_facts</span><span class=p>:</span><span class=w> </span><span class=kc>no</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>tasks</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span>- <span class=nt>include_tasks</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>file</span><span class=p>:</span><span class=w> </span><span class=l>in.yml</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>apply</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nt>tags</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span>- <span class=l>t1</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=c># 但如上写法并未按预期执行,连include_tasks都没有执行,需要完成预期内容,需要如下配置</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nn>---</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span>- <span class=nt>hosts</span><span class=p>:</span><span class=w> </span><span class=l>node2</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>remote_user</span><span class=p>:</span><span class=w> </span><span class=l>root</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>gather_facts</span><span class=p>:</span><span class=w> </span><span class=kc>no</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>tasks</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span>- <span class=nt>include_tasks</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>file</span><span class=p>:</span><span class=w> </span><span class=l>in.yml</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>apply</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nt>tags</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span>- <span class=l>t1</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>tags</span><span class=p>:</span><span class=w> </span><span class=l>always</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=c># 在使用&#34;include_tasks&#34;时,不仅使用apply参数指定了tags,同时还使用tags关键字,对&#34;include_tasks&#34;本身添加了always标签</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div></div><p>4,import_tasks</p><ul><li>如果想要包含引用一个任务列表,也可以使用"import_tasks"关键字</li></ul><div class=highlight><div class=chroma><div class=table-container><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-yaml data-lang=yaml><span class=line><span class=cl><span class=c># cat intest1.yml</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nn>---</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span>- <span class=nt>hosts</span><span class=p>:</span><span class=w> </span><span class=l>node2</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>remote_user</span><span class=p>:</span><span class=w> </span><span class=l>root</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>gather_facts</span><span class=p>:</span><span class=w> </span><span class=kc>no</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>tasks</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span>- <span class=nt>debug</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>msg</span><span class=p>:</span><span class=w> </span><span class=s2>&#34;test task&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span>- <span class=nt>import_tasks</span><span class=p>:</span><span class=w> </span><span class=l>in.yml</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w> 
</span></span></span><span class=line><span class=cl><span class=w></span><span class=c># cat in.yml</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span>- <span class=nt>debug</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>msg</span><span class=p>:</span><span class=w> </span><span class=s2>&#34;task1 in in.yml&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span>- <span class=nt>debug</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>msg</span><span class=p>:</span><span class=w> </span><span class=s2>&#34;task2 in in.yml&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=c># &#34;import_tasks&#34;模块并不会像&#34;include_tasks&#34;模块那样,在控制台中输出相关的任务信息,&#34;import_tasks&#34;是相对透明的</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div></div><ul><li>"import_tasks"是静态的,"include_tasks"是动态的</li></ul><div class=highlight><div class=chroma><div class=table-container><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-yaml data-lang=yaml><span class=line><span class=cl><span class=c># &#34;静态&#34;的意思就是被include的文件在playbook被加载时就展开了（是预处理的）.</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=c># &#34;动态&#34;的意思就是被include的文件在playbook运行时才会被展开（是实时处理的）.</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=c># 由于&#34;include_tasks&#34;是动态的,所以,被include的文件的文件名可以使用任何变量替换.</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=c># 由于&#34;import_tasks&#34;是静态的,所以,被include的文件的文件名不能使用动态的变量替换.</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=c># cat intest3.yml</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nn>---</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span>- <span class=nt>hosts</span><span class=p>:</span><span class=w> </span><span class=l>node2</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>remote_user</span><span class=p>:</span><span class=w> </span><span class=l>root</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>gather_facts</span><span class=p>:</span><span class=w> </span><span class=kc>no</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>vars</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>file_name</span><span class=p>:</span><span class=w> </span><span class=l>in.yml</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>tasks</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span>- <span class=nt>import_tasks</span><span class=p>:</span><span class=w> </span><span class=s2>&#34;{{file_name}}&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span>- <span class=nt>include_tasks</span><span class=p>:</span><span class=w> </span><span class=s2>&#34;{{file_name}}&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=c># 上述内容可以正常执行</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=c># cat intest3.yml</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nn>---</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span>- <span class=nt>hosts</span><span class=p>:</span><span class=w> </span><span class=l>node2</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>remote_user</span><span class=p>:</span><span class=w> </span><span class=l>root</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>gather_facts</span><span class=p>:</span><span class=w> </span><span class=kc>no</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>tasks</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span>- <span class=nt>set_fact</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>file_name</span><span class=p>:</span><span class=w> </span><span class=l>in.yml</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span>- <span class=nt>import_tasks</span><span class=p>:</span><span class=w> </span><span class=s2>&#34;{{file_name}}&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span>- <span class=nt>include_tasks</span><span class=p>:</span><span class=w> </span><span class=s2>&#34;{{file_name}}&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=c># 上述内容执行报错</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=c># 当使用静态的import时,请确保文件名中使用到的变量被定义在vars中、vars_files中、或者extra-vars中,静态的import不支持其他方式传入的变量</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div></div><ul><li>如果想要对包含的任务列表进行循环操作,则只能使用"include_tasks"关键字,不能使用"import_tasks"关键字,"import_tasks"并不支持循环操作,使用"loop"关键字或"with_items"关键字对include文件进行循环操作时,只能配合"include_tasks"才能正常运行</li><li>使用when做条件判断执行include_tasks和import_tasks时,区别很大</li></ul><div class=highlight><div class=chroma><div class=table-container><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span><span class=lnt>32
</span><span class=lnt>33
</span><span class=lnt>34
</span><span class=lnt>35
</span><span class=lnt>36
</span><span class=lnt>37
</span><span class=lnt>38
</span><span class=lnt>39
</span><span class=lnt>40
</span><span class=lnt>41
</span><span class=lnt>42
</span><span class=lnt>43
</span><span class=lnt>44
</span><span class=lnt>45
</span><span class=lnt>46
</span><span class=lnt>47
</span><span class=lnt>48
</span><span class=lnt>49
</span><span class=lnt>50
</span><span class=lnt>51
</span><span class=lnt>52
</span><span class=lnt>53
</span><span class=lnt>54
</span><span class=lnt>55
</span><span class=lnt>56
</span><span class=lnt>57
</span><span class=lnt>58
</span><span class=lnt>59
</span><span class=lnt>60
</span><span class=lnt>61
</span><span class=lnt>62
</span><span class=lnt>63
</span><span class=lnt>64
</span><span class=lnt>65
</span><span class=lnt>66
</span><span class=lnt>67
</span><span class=lnt>68
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-yaml data-lang=yaml><span class=line><span class=cl><span class=c># 当对&#34;include_tasks&#34;使用when进行条件判断时,when对应的条件只会应用于&#34;include_tasks&#34;任务本身,当执行被包含的任务时,不会对这些被包含的任务重新进行条件判断.</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=c># 当对&#34;import_tasks&#34;使用when进行条件判断时,when对应的条件会应用于被include的文件中的每一个任务,当执行被包含的任务时,会对每一个被包含的任务进行同样的条件判断.</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=c># cat intest4.yml</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nn>---</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span>- <span class=nt>hosts</span><span class=p>:</span><span class=w> </span><span class=l>node2</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>remote_user</span><span class=p>:</span><span class=w> </span><span class=l>root</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>gather_facts</span><span class=p>:</span><span class=w> </span><span class=kc>no</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>tasks</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span>- <span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=s1>&#39;----------set testvar to 0&#39;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>set_fact</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>testnum</span><span class=p>:</span><span class=w> </span><span class=m>0</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span>- <span class=nt>debug</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>msg</span><span class=p>:</span><span class=w> </span><span class=s1>&#39;-----include_tasks-----enter the in1.yml-----&#39;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span>- <span class=nt>include_tasks</span><span class=p>:</span><span class=w> </span><span class=l>in1.yml</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>when</span><span class=p>:</span><span class=w> </span><span class=l>testnum == 0</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w> 
</span></span></span><span class=line><span class=cl><span class=w>  </span>- <span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=s1>&#39;----------set testvar to 0&#39;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>set_fact</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>testnum</span><span class=p>:</span><span class=w> </span><span class=m>0</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span>- <span class=nt>debug</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>msg</span><span class=p>:</span><span class=w> </span><span class=s1>&#39;-----import_tasks-----enter the in1.yml-----&#39;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span>- <span class=nt>import_tasks</span><span class=p>:</span><span class=w> </span><span class=l>in1.yml</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>when</span><span class=p>:</span><span class=w> </span><span class=l>testnum == 0</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w> 
</span></span></span><span class=line><span class=cl><span class=w></span><span class=c># cat in1.yml</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span>- <span class=nt>set_fact</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>testnum</span><span class=p>:</span><span class=w> </span><span class=m>1</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w> 
</span></span></span><span class=line><span class=cl><span class=w></span>- <span class=nt>debug</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>msg</span><span class=p>:</span><span class=w> </span><span class=s2>&#34;task1 in in1.yml&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=c># 输出内容如下:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=l>PLAY [node2] xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w> 
</span></span></span><span class=line><span class=cl><span class=w></span><span class=l>TASK [----------set testvar to 0] xxxxxxxxxxxxxxxxxxxxxxxxxxxxxx</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>ok</span><span class=p>:</span><span class=w> </span><span class=p>[</span><span class=l>node2]</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w> 
</span></span></span><span class=line><span class=cl><span class=w></span><span class=l>TASK [debug] xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>ok</span><span class=p>:</span><span class=w> </span><span class=p>[</span><span class=l>node2] =&gt; {</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>&#34;msg&#34;: </span><span class=s2>&#34;-----include_tasks-----enter the in1.yml-----&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span>}<span class=w>
</span></span></span><span class=line><span class=cl><span class=w> 
</span></span></span><span class=line><span class=cl><span class=w></span><span class=l>TASK [include_tasks] xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>included</span><span class=p>:</span><span class=w> </span><span class=l>/testdir/ansible/in1.yml for node2</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w> 
</span></span></span><span class=line><span class=cl><span class=w></span><span class=l>TASK [set_fact] xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>ok</span><span class=p>:</span><span class=w> </span><span class=p>[</span><span class=l>node2]</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w> 
</span></span></span><span class=line><span class=cl><span class=w></span><span class=l>TASK [debug] xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>ok</span><span class=p>:</span><span class=w> </span><span class=p>[</span><span class=l>node2] =&gt; {</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>&#34;msg&#34;: </span><span class=s2>&#34;task1 in in1.yml&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span>}<span class=w>
</span></span></span><span class=line><span class=cl><span class=w> 
</span></span></span><span class=line><span class=cl><span class=w></span><span class=l>TASK [----------set testvar to 0] xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>ok</span><span class=p>:</span><span class=w> </span><span class=p>[</span><span class=l>node2]</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w> 
</span></span></span><span class=line><span class=cl><span class=w></span><span class=l>TASK [debug] xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>ok</span><span class=p>:</span><span class=w> </span><span class=p>[</span><span class=l>node2] =&gt; {</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>&#34;msg&#34;: </span><span class=s2>&#34;-----import_tasks-----enter the in1.yml-----&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span>}<span class=w>
</span></span></span><span class=line><span class=cl><span class=w> 
</span></span></span><span class=line><span class=cl><span class=w></span><span class=l>TASK [set_fact] xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>ok</span><span class=p>:</span><span class=w> </span><span class=p>[</span><span class=l>node2]</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w> 
</span></span></span><span class=line><span class=cl><span class=w></span><span class=l>TASK [debug] xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>skipping</span><span class=p>:</span><span class=w> </span><span class=p>[</span><span class=l>node2]</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w> 
</span></span></span><span class=line><span class=cl><span class=w></span><span class=l>PLAY RECAP xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>node2                     </span><span class=p>:</span><span class=w> </span><span class=l>ok=8    changed=0    unreachable=0    failed=0</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div></div><ul><li>tags的使用,与"include_tasks"不同,当为"import_tasks"添加标签时,tags是针对被包含文件中的所有任务生效的,与"include"关键字的效果相同.</li><li>"include_tasks"与"import_tasks"都可以在handlers中使用,并没有什么不同
5,import_playbook<ul><li>使用"include"关键字除了能够引用任务列表,还能够引用整个playbook,在之后的版本中,如果想要引入整个playbook,则需要使用"import_playbook"模块代替"include"模块,因为在2.8版本以后,使用"include"关键字引用整个playbook的特性将会被弃用</li><li>示例如下:</li></ul></li></ul><div class=highlight><div class=chroma><div class=table-container><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-yaml data-lang=yaml><span class=line><span class=cl><span class=c># cat intest6.yml</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nn>---</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span>- <span class=nt>hosts</span><span class=p>:</span><span class=w> </span><span class=l>node2</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>remote_user</span><span class=p>:</span><span class=w> </span><span class=l>root</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>gather_facts</span><span class=p>:</span><span class=w> </span><span class=kc>no</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>tasks</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span>- <span class=nt>debug</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>msg</span><span class=p>:</span><span class=w> </span><span class=s2>&#34;test task in intest6.yml&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w> 
</span></span></span><span class=line><span class=cl><span class=w></span>- <span class=nt>import_playbook</span><span class=p>:</span><span class=w> </span><span class=l>intest7.yml</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w> 
</span></span></span><span class=line><span class=cl><span class=w></span><span class=c># cat intest7.yml</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nn>---</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span>- <span class=nt>hosts</span><span class=p>:</span><span class=w> </span><span class=l>node2</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>remote_user</span><span class=p>:</span><span class=w> </span><span class=l>root</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>gather_facts</span><span class=p>:</span><span class=w> </span><span class=kc>no</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>tasks</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span>- <span class=nt>debug</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>msg</span><span class=p>:</span><span class=w> </span><span class=s2>&#34;test task in intest7.yml&#34;</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div></div><h2 id=jinja2模板一><a href=#jinja2模板一 class=anchor-link><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512" class="icon anchor-icon"><path d="M326.612 185.391c59.747 59.809 58.927 155.698.36 214.59-.11.12-.24.25-.36.37l-67.2 67.2c-59.27 59.27-155.699 59.262-214.96.0-59.27-59.26-59.27-155.7.0-214.96l37.106-37.106c9.84-9.84 26.786-3.3 27.294 10.606.648 17.722 3.826 35.527 9.69 52.721 1.986 5.822.567 12.262-3.783 16.612l-13.087 13.087c-28.026 28.026-28.905 73.66-1.155 101.96 28.024 28.579 74.086 28.749 102.325.51l67.2-67.19c28.191-28.191 28.073-73.757.0-101.83-3.701-3.694-7.429-6.564-10.341-8.569a16.037 16.037.0 01-6.947-12.606c-.396-10.567 3.348-21.456 11.698-29.806l21.054-21.055c5.521-5.521 14.182-6.199 20.584-1.731a152.482 152.482.0 0120.522 17.197zM467.547 44.449c-59.261-59.262-155.69-59.27-214.96.0l-67.2 67.2c-.12.12-.25.25-.36.37-58.566 58.892-59.387 154.781.36 214.59a152.454 152.454.0 0020.521 17.196c6.402 4.468 15.064 3.789 20.584-1.731l21.054-21.055c8.35-8.35 12.094-19.239 11.698-29.806a16.037 16.037.0 00-6.947-12.606c-2.912-2.005-6.64-4.875-10.341-8.569-28.073-28.073-28.191-73.639.0-101.83l67.2-67.19c28.239-28.239 74.3-28.069 102.325.51 27.75 28.3 26.872 73.934-1.155 101.96l-13.087 13.087c-4.35 4.35-5.769 10.79-3.783 16.612 5.864 17.194 9.042 34.999 9.69 52.721.509 13.906 17.454 20.446 27.294 10.606l37.106-37.106c59.271-59.259 59.271-155.699.001-214.959z"/></svg></a><a href=#contents:jinja2模板一 class=headings>#jinja2模板(一)</a></h2><p>1,对远端机器进行操作时,很多场景下都需要根据主机信息进行配置,这个时候可以使用template模块来完成相应的目的</p><ul><li>示例如下:</li></ul><div class=highlight><div class=chroma><div class=table-container><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-yaml data-lang=yaml><span class=line><span class=cl><span class=c># cat temptest.yml</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nn>---</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span>- <span class=nt>hosts</span><span class=p>:</span><span class=w> </span><span class=l>node2</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w> </span><span class=nt>remote_user</span><span class=p>:</span><span class=w> </span><span class=l>root</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w> </span><span class=nt>gather_facts</span><span class=p>:</span><span class=w> </span><span class=kc>no</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w> </span><span class=nt>tasks</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w> </span>- <span class=nt>yum</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>     </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>redis</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>     </span><span class=nt>state</span><span class=p>:</span><span class=w> </span><span class=l>present</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w> </span>- <span class=nt>template</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>     </span><span class=nt>src</span><span class=p>:</span><span class=w> </span><span class=l>/testdir/ansible/redis.conf</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>     </span><span class=nt>dest</span><span class=p>:</span><span class=w> </span><span class=l>/etc/redis.conf</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=c># cat /testdir/ansible/redis.conf,下列的ansible_host是host alias,需要注意</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nn>...</span><span class=l>...</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=l>bind {{ansible_host}}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nn>...</span><span class=l>...</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div></div><ul><li>template还有其他的选项</li></ul><pre tabindex=0><code># owner,group,mode(mode=0644,mode=u+x)
# force参数: 当远程主机的目标路径中已经存在同名文件,并且与最终生成的文件内容不同时,是否强制覆盖,可选值有yes和no,默认值为yes,表示覆盖,如果设置为no,则不会执行覆盖拷贝操作,远程主机中的文件保持不变
# backup参数: 当远程主机的目标路径中已经存在同名文件,并且与最终生成的文件内容不同时,是否对远程主机的文件进行备份,可选值有yes和no,当设置为yes时,会先备份远程主机中的文件,然后再将最终生成的文件拷贝到远程主机
</code></pre><p>2,上述例子中使用的template模块渲染,使用的都是jinja2模板引擎</p><pre tabindex=0><code>  - \{\{      \}\}     :用来装载表达式,比如变量、运算表达式、比较表达式等.
  - \{\%      \%\}     :用来装载控制语句,比如 if 控制结构,for循环控制结构.
  - \{\#      \#\}     :用来装载注释,模板文件被渲染后,注释不会包含在最终生成的文件中.
</code></pre><p>3,双花括号的使用</p><ul><li>变量的引用,如下示例:</li></ul><div class=highlight><div class=chroma><div class=table-container><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl><span class=c1># ansible node2 -m template -e &#34;testvar1=teststr&#34; -a &#34;src=test.j2 dest=/opt/test&#34;</span>
</span></span><span class=line><span class=cl><span class=c1># cat test.j2</span>
</span></span><span class=line><span class=cl><span class=nb>test</span> jinja2 variable
</span></span><span class=line><span class=cl><span class=nb>test</span> <span class=o>{{</span> testvar1 <span class=o>}}</span> <span class=nb>test</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 输出内容如下:</span>
</span></span><span class=line><span class=cl><span class=c1># cat test</span>
</span></span><span class=line><span class=cl><span class=nb>test</span> jinja2 variable
</span></span><span class=line><span class=cl><span class=nb>test</span> teststr tesT
</span></span><span class=line><span class=cl><span class=c1># &#34;{{  }}&#34;中包含的就是一个变量,当模板被渲染后,变量的值被替换到了最终的配置文件中</span>
</span></span></code></pre></td></tr></table></div></div></div><ul><li>包含表达式,示例如下:</li></ul><div class=highlight><div class=chroma><div class=table-container><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>  1
</span><span class=lnt>  2
</span><span class=lnt>  3
</span><span class=lnt>  4
</span><span class=lnt>  5
</span><span class=lnt>  6
</span><span class=lnt>  7
</span><span class=lnt>  8
</span><span class=lnt>  9
</span><span class=lnt> 10
</span><span class=lnt> 11
</span><span class=lnt> 12
</span><span class=lnt> 13
</span><span class=lnt> 14
</span><span class=lnt> 15
</span><span class=lnt> 16
</span><span class=lnt> 17
</span><span class=lnt> 18
</span><span class=lnt> 19
</span><span class=lnt> 20
</span><span class=lnt> 21
</span><span class=lnt> 22
</span><span class=lnt> 23
</span><span class=lnt> 24
</span><span class=lnt> 25
</span><span class=lnt> 26
</span><span class=lnt> 27
</span><span class=lnt> 28
</span><span class=lnt> 29
</span><span class=lnt> 30
</span><span class=lnt> 31
</span><span class=lnt> 32
</span><span class=lnt> 33
</span><span class=lnt> 34
</span><span class=lnt> 35
</span><span class=lnt> 36
</span><span class=lnt> 37
</span><span class=lnt> 38
</span><span class=lnt> 39
</span><span class=lnt> 40
</span><span class=lnt> 41
</span><span class=lnt> 42
</span><span class=lnt> 43
</span><span class=lnt> 44
</span><span class=lnt> 45
</span><span class=lnt> 46
</span><span class=lnt> 47
</span><span class=lnt> 48
</span><span class=lnt> 49
</span><span class=lnt> 50
</span><span class=lnt> 51
</span><span class=lnt> 52
</span><span class=lnt> 53
</span><span class=lnt> 54
</span><span class=lnt> 55
</span><span class=lnt> 56
</span><span class=lnt> 57
</span><span class=lnt> 58
</span><span class=lnt> 59
</span><span class=lnt> 60
</span><span class=lnt> 61
</span><span class=lnt> 62
</span><span class=lnt> 63
</span><span class=lnt> 64
</span><span class=lnt> 65
</span><span class=lnt> 66
</span><span class=lnt> 67
</span><span class=lnt> 68
</span><span class=lnt> 69
</span><span class=lnt> 70
</span><span class=lnt> 71
</span><span class=lnt> 72
</span><span class=lnt> 73
</span><span class=lnt> 74
</span><span class=lnt> 75
</span><span class=lnt> 76
</span><span class=lnt> 77
</span><span class=lnt> 78
</span><span class=lnt> 79
</span><span class=lnt> 80
</span><span class=lnt> 81
</span><span class=lnt> 82
</span><span class=lnt> 83
</span><span class=lnt> 84
</span><span class=lnt> 85
</span><span class=lnt> 86
</span><span class=lnt> 87
</span><span class=lnt> 88
</span><span class=lnt> 89
</span><span class=lnt> 90
</span><span class=lnt> 91
</span><span class=lnt> 92
</span><span class=lnt> 93
</span><span class=lnt> 94
</span><span class=lnt> 95
</span><span class=lnt> 96
</span><span class=lnt> 97
</span><span class=lnt> 98
</span><span class=lnt> 99
</span><span class=lnt>100
</span><span class=lnt>101
</span><span class=lnt>102
</span><span class=lnt>103
</span><span class=lnt>104
</span><span class=lnt>105
</span><span class=lnt>106
</span><span class=lnt>107
</span><span class=lnt>108
</span><span class=lnt>109
</span><span class=lnt>110
</span><span class=lnt>111
</span><span class=lnt>112
</span><span class=lnt>113
</span><span class=lnt>114
</span><span class=lnt>115
</span><span class=lnt>116
</span><span class=lnt>117
</span><span class=lnt>118
</span><span class=lnt>119
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl><span class=c1>## 比较表达式:</span>
</span></span><span class=line><span class=cl><span class=c1># cat test.j2</span>
</span></span><span class=line><span class=cl>jinja2 <span class=nb>test</span>
</span></span><span class=line><span class=cl><span class=o>{{</span> <span class=nv>1</span> <span class=o>==</span> <span class=m>1</span> <span class=o>}}</span>
</span></span><span class=line><span class=cl><span class=o>{{</span> <span class=m>2</span> !<span class=o>=</span> <span class=m>2</span> <span class=o>}}</span>
</span></span><span class=line><span class=cl><span class=o>{{</span> <span class=m>2</span> &gt; <span class=m>1</span> <span class=o>}}</span>
</span></span><span class=line><span class=cl><span class=o>{{</span> <span class=m>2</span> &gt;<span class=o>=</span> <span class=m>1</span> <span class=o>}}</span>
</span></span><span class=line><span class=cl> 
</span></span><span class=line><span class=cl>生成文件内容如下:
</span></span><span class=line><span class=cl><span class=c1># cat test</span>
</span></span><span class=line><span class=cl>jinja2 <span class=nb>test</span>
</span></span><span class=line><span class=cl>True
</span></span><span class=line><span class=cl>False
</span></span><span class=line><span class=cl>True
</span></span><span class=line><span class=cl>True
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>## 逻辑运算:</span>
</span></span><span class=line><span class=cl><span class=c1># cat test.j2</span>
</span></span><span class=line><span class=cl>jinja2 <span class=nb>test</span>
</span></span><span class=line><span class=cl><span class=o>{{</span> <span class=o>(</span><span class=m>2</span> &gt; 1<span class=o>)</span> or <span class=o>(</span><span class=m>1</span> &gt; 2<span class=o>)</span> <span class=o>}}</span>
</span></span><span class=line><span class=cl><span class=o>{{</span> <span class=o>(</span><span class=m>2</span> &gt; 1<span class=o>)</span> and <span class=o>(</span><span class=m>1</span> &gt; 2<span class=o>)</span> <span class=o>}}</span>
</span></span><span class=line><span class=cl> 
</span></span><span class=line><span class=cl><span class=o>{{</span> not <span class=nb>true</span> <span class=o>}}</span>
</span></span><span class=line><span class=cl><span class=o>{{</span> not True <span class=o>}}</span>
</span></span><span class=line><span class=cl> 
</span></span><span class=line><span class=cl><span class=c1># cat test</span>
</span></span><span class=line><span class=cl>jinja2 <span class=nb>test</span>
</span></span><span class=line><span class=cl>True
</span></span><span class=line><span class=cl>False
</span></span><span class=line><span class=cl> 
</span></span><span class=line><span class=cl>False
</span></span><span class=line><span class=cl>False
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>## 算数运算:</span>
</span></span><span class=line><span class=cl><span class=c1># cat test.j2</span>
</span></span><span class=line><span class=cl>jinja2 <span class=nb>test</span>
</span></span><span class=line><span class=cl><span class=o>{{</span> <span class=m>3</span> + <span class=m>2</span> <span class=o>}}</span>
</span></span><span class=line><span class=cl><span class=o>{{</span> <span class=m>3</span> - <span class=m>4</span> <span class=o>}}</span>
</span></span><span class=line><span class=cl><span class=o>{{</span> <span class=m>3</span> * <span class=m>5</span> <span class=o>}}</span>
</span></span><span class=line><span class=cl><span class=o>{{</span> <span class=m>2</span> ** <span class=m>3</span> <span class=o>}}</span>
</span></span><span class=line><span class=cl><span class=o>{{</span> <span class=m>7</span> / <span class=m>5</span> <span class=o>}}</span>
</span></span><span class=line><span class=cl><span class=o>{{</span> <span class=m>7</span> // <span class=m>5</span> <span class=o>}}</span>
</span></span><span class=line><span class=cl><span class=o>{{</span> <span class=m>17</span> % <span class=m>5</span> <span class=o>}}</span>
</span></span><span class=line><span class=cl> 
</span></span><span class=line><span class=cl><span class=c1># cat test</span>
</span></span><span class=line><span class=cl>jinja2 <span class=nb>test</span>
</span></span><span class=line><span class=cl><span class=m>5</span>
</span></span><span class=line><span class=cl>-1
</span></span><span class=line><span class=cl><span class=m>15</span>
</span></span><span class=line><span class=cl><span class=m>8</span>
</span></span><span class=line><span class=cl>1.4
</span></span><span class=line><span class=cl><span class=m>1</span>
</span></span><span class=line><span class=cl><span class=m>2</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>## 成员运算:</span>
</span></span><span class=line><span class=cl><span class=c1># cat test.j2</span>
</span></span><span class=line><span class=cl>jinja2 <span class=nb>test</span>
</span></span><span class=line><span class=cl><span class=o>{{</span> <span class=m>1</span> in <span class=o>[</span>1,2,3,4<span class=o>]</span> <span class=o>}}</span>
</span></span><span class=line><span class=cl><span class=o>{{</span> <span class=m>1</span> not in <span class=o>[</span>1,2,3,4<span class=o>]</span> <span class=o>}}</span>
</span></span><span class=line><span class=cl> 
</span></span><span class=line><span class=cl><span class=c1># cat test</span>
</span></span><span class=line><span class=cl>jinja2 <span class=nb>test</span>
</span></span><span class=line><span class=cl>True
</span></span><span class=line><span class=cl>False
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>## 一些基础的数据类型,都可以包含在&#34;{{  }}&#34;中,jinja2本身就是基于python的模板引擎,所以,python的基础数据类型都可以包含在&#34;{{  }}&#34;中</span>
</span></span><span class=line><span class=cl><span class=c1># cat test.j2</span>
</span></span><span class=line><span class=cl>jinja2 <span class=nb>test</span>
</span></span><span class=line><span class=cl><span class=c1>## \#str</span>
</span></span><span class=line><span class=cl><span class=o>{{</span> <span class=s1>&#39;testString&#39;</span> <span class=o>}}</span>
</span></span><span class=line><span class=cl><span class=o>{{</span> <span class=s2>&#34;testString&#34;</span> <span class=o>}}</span>
</span></span><span class=line><span class=cl><span class=c1>## \#num</span>
</span></span><span class=line><span class=cl><span class=o>{{</span> <span class=m>15</span> <span class=o>}}</span>
</span></span><span class=line><span class=cl><span class=o>{{</span> 18.8 <span class=o>}}</span>
</span></span><span class=line><span class=cl><span class=c1>## \#list</span>
</span></span><span class=line><span class=cl><span class=o>{{</span> <span class=o>[</span><span class=s1>&#39;Aa&#39;</span>,<span class=s1>&#39;Bb&#39;</span>,<span class=s1>&#39;Cc&#39;</span>,<span class=s1>&#39;Dd&#39;</span><span class=o>]</span> <span class=o>}}</span>
</span></span><span class=line><span class=cl><span class=o>{{</span> <span class=o>[</span><span class=s1>&#39;Aa&#39;</span>,<span class=s1>&#39;Bb&#39;</span>,<span class=s1>&#39;Cc&#39;</span>,<span class=s1>&#39;Dd&#39;</span><span class=o>]</span>.1 <span class=o>}}</span>
</span></span><span class=line><span class=cl><span class=o>{{</span> <span class=o>[</span><span class=s1>&#39;Aa&#39;</span>,<span class=s1>&#39;Bb&#39;</span>,<span class=s1>&#39;Cc&#39;</span>,<span class=s1>&#39;Dd&#39;</span><span class=o>][</span>1<span class=o>]</span> <span class=o>}}</span>
</span></span><span class=line><span class=cl><span class=c1>## \#tuple</span>
</span></span><span class=line><span class=cl><span class=o>{{</span> <span class=o>(</span><span class=s1>&#39;Aa&#39;</span>,<span class=s1>&#39;Bb&#39;</span>,<span class=s1>&#39;Cc&#39;</span>,<span class=s1>&#39;Dd&#39;</span><span class=o>)</span> <span class=o>}}</span>
</span></span><span class=line><span class=cl><span class=o>{{</span> <span class=o>(</span><span class=s1>&#39;Aa&#39;</span>,<span class=s1>&#39;Bb&#39;</span>,<span class=s1>&#39;Cc&#39;</span>,<span class=s1>&#39;Dd&#39;</span><span class=o>)</span>.0 <span class=o>}}</span>
</span></span><span class=line><span class=cl><span class=o>{{</span> <span class=o>(</span><span class=s1>&#39;Aa&#39;</span>,<span class=s1>&#39;Bb&#39;</span>,<span class=s1>&#39;Cc&#39;</span>,<span class=s1>&#39;Dd&#39;</span><span class=o>)[</span>0<span class=o>]</span> <span class=o>}}</span>
</span></span><span class=line><span class=cl><span class=c1>## \#dic</span>
</span></span><span class=line><span class=cl><span class=o>{{</span> <span class=o>{</span><span class=s1>&#39;name&#39;</span>:<span class=s1>&#39;bob&#39;</span>,<span class=s1>&#39;age&#39;</span>:18<span class=o>}</span> <span class=o>}}</span>
</span></span><span class=line><span class=cl><span class=o>{{</span> <span class=o>{</span><span class=s1>&#39;name&#39;</span>:<span class=s1>&#39;bob&#39;</span>,<span class=s1>&#39;age&#39;</span>:18<span class=o>}</span>.name <span class=o>}}</span>
</span></span><span class=line><span class=cl><span class=o>{{</span> <span class=o>{</span><span class=s1>&#39;name&#39;</span>:<span class=s1>&#39;bob&#39;</span>,<span class=s1>&#39;age&#39;</span>:18<span class=o>}[</span><span class=s1>&#39;name&#39;</span><span class=o>]</span> <span class=o>}}</span>
</span></span><span class=line><span class=cl><span class=c1>## \#Boolean</span>
</span></span><span class=line><span class=cl><span class=o>{{</span> True <span class=o>}}</span>
</span></span><span class=line><span class=cl><span class=o>{{</span> <span class=nb>true</span> <span class=o>}}</span>
</span></span><span class=line><span class=cl><span class=o>{{</span> False <span class=o>}}</span>
</span></span><span class=line><span class=cl><span class=o>{{</span> <span class=nb>false</span> <span class=o>}}</span>
</span></span><span class=line><span class=cl> 
</span></span><span class=line><span class=cl> 
</span></span><span class=line><span class=cl>生成文件内容如下:
</span></span><span class=line><span class=cl><span class=c1># cat test</span>
</span></span><span class=line><span class=cl>jinja2 <span class=nb>test</span>
</span></span><span class=line><span class=cl><span class=c1>## \#str</span>
</span></span><span class=line><span class=cl>testString
</span></span><span class=line><span class=cl>testString
</span></span><span class=line><span class=cl><span class=c1>## \#num</span>
</span></span><span class=line><span class=cl><span class=m>15</span>
</span></span><span class=line><span class=cl>18.8
</span></span><span class=line><span class=cl><span class=c1>## \#list</span>
</span></span><span class=line><span class=cl><span class=o>[</span><span class=s1>&#39;Aa&#39;</span>, <span class=s1>&#39;Bb&#39;</span>, <span class=s1>&#39;Cc&#39;</span>, <span class=s1>&#39;Dd&#39;</span><span class=o>]</span>
</span></span><span class=line><span class=cl>Bb
</span></span><span class=line><span class=cl>Bb
</span></span><span class=line><span class=cl><span class=c1>## \#tuple</span>
</span></span><span class=line><span class=cl><span class=o>(</span><span class=s1>&#39;Aa&#39;</span>, <span class=s1>&#39;Bb&#39;</span>, <span class=s1>&#39;Cc&#39;</span>, <span class=s1>&#39;Dd&#39;</span><span class=o>)</span>
</span></span><span class=line><span class=cl>Aa
</span></span><span class=line><span class=cl>Aa
</span></span><span class=line><span class=cl><span class=c1>## \#dic</span>
</span></span><span class=line><span class=cl><span class=o>{</span><span class=s1>&#39;age&#39;</span>: 18, <span class=s1>&#39;name&#39;</span>: <span class=s1>&#39;bob&#39;</span><span class=o>}</span>
</span></span><span class=line><span class=cl>bob
</span></span><span class=line><span class=cl>bob
</span></span><span class=line><span class=cl><span class=c1>## \#Boolean</span>
</span></span><span class=line><span class=cl>True
</span></span><span class=line><span class=cl>True
</span></span><span class=line><span class=cl>False
</span></span><span class=line><span class=cl>False
</span></span></code></pre></td></tr></table></div></div></div><ul><li>过滤器也可以在双花括号中使用</li></ul><div class=highlight><div class=chroma><div class=table-container><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span><span class=lnt>7
</span><span class=lnt>8
</span><span class=lnt>9
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl><span class=c1># cat test.j2</span>
</span></span><span class=line><span class=cl>jinja2 <span class=nb>test</span>
</span></span><span class=line><span class=cl><span class=o>{{</span> <span class=s1>&#39;abc&#39;</span> <span class=p>|</span> upper <span class=o>}}</span>
</span></span><span class=line><span class=cl> 
</span></span><span class=line><span class=cl> 
</span></span><span class=line><span class=cl>生成文件内容
</span></span><span class=line><span class=cl><span class=c1># cat test</span>
</span></span><span class=line><span class=cl>jinja2 <span class=nb>test</span>
</span></span><span class=line><span class=cl>ABC
</span></span></code></pre></td></tr></table></div></div></div><ul><li>jinja2的tests自然也能够在"双花括号"中使用</li></ul><div class=highlight><div class=chroma><div class=table-container><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl><span class=c1># cat test.j2</span>
</span></span><span class=line><span class=cl>jinja2 <span class=nb>test</span>
</span></span><span class=line><span class=cl><span class=o>{{</span> testvar1 is defined <span class=o>}}</span>
</span></span><span class=line><span class=cl><span class=o>{{</span> testvar1 is undefined <span class=o>}}</span>
</span></span><span class=line><span class=cl><span class=o>{{</span> <span class=s1>&#39;/opt&#39;</span> is exists <span class=o>}}</span>
</span></span><span class=line><span class=cl><span class=o>{{</span> <span class=s1>&#39;/opt&#39;</span> is file <span class=o>}}</span>
</span></span><span class=line><span class=cl><span class=o>{{</span> <span class=s1>&#39;/opt&#39;</span> is directory <span class=o>}}</span>
</span></span><span class=line><span class=cl> 
</span></span><span class=line><span class=cl><span class=c1># ansible node2 -m template -e &#34;testvar1=1 testvar2=2&#34; -a &#34;src=test.j2 dest=/opt/test&#34;</span>
</span></span><span class=line><span class=cl> 
</span></span><span class=line><span class=cl>生成文件内容
</span></span><span class=line><span class=cl><span class=c1># cat test</span>
</span></span><span class=line><span class=cl>jinja2 <span class=nb>test</span>
</span></span><span class=line><span class=cl>True
</span></span><span class=line><span class=cl>False
</span></span><span class=line><span class=cl>True
</span></span><span class=line><span class=cl>False
</span></span><span class=line><span class=cl>True
</span></span></code></pre></td></tr></table></div></div></div><ul><li>lookup插件在双花括号中的使用</li></ul><div class=highlight><div class=chroma><div class=table-container><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl><span class=c1># cat /testdir/ansible/test.j2</span>
</span></span><span class=line><span class=cl>jinja2 <span class=nb>test</span>
</span></span><span class=line><span class=cl> 
</span></span><span class=line><span class=cl><span class=o>{{</span> lookup<span class=o>(</span><span class=s1>&#39;file&#39;</span>,<span class=s1>&#39;/testdir/testfile&#39;</span><span class=o>)</span> <span class=o>}}</span>
</span></span><span class=line><span class=cl> 
</span></span><span class=line><span class=cl><span class=o>{{</span> lookup<span class=o>(</span><span class=s1>&#39;env&#39;</span>,<span class=s1>&#39;PATH&#39;</span><span class=o>)</span> <span class=o>}}</span>
</span></span><span class=line><span class=cl> 
</span></span><span class=line><span class=cl><span class=nb>test</span> jinja2
</span></span><span class=line><span class=cl> 
</span></span><span class=line><span class=cl> 
</span></span><span class=line><span class=cl><span class=c1># ansible主机中的testfile内容如下</span>
</span></span><span class=line><span class=cl><span class=c1># cat /testdir/testfile</span>
</span></span><span class=line><span class=cl>testfile in ansible
</span></span><span class=line><span class=cl>These are <span class=k>for</span> testing purposes only
</span></span><span class=line><span class=cl> 
</span></span><span class=line><span class=cl><span class=c1># 生成文件内容如下</span>
</span></span><span class=line><span class=cl><span class=c1># cat test</span>
</span></span><span class=line><span class=cl>jinja2 <span class=nb>test</span>
</span></span><span class=line><span class=cl> 
</span></span><span class=line><span class=cl>testfile in ansible
</span></span><span class=line><span class=cl>These are <span class=k>for</span> testing purposes only
</span></span><span class=line><span class=cl> 
</span></span><span class=line><span class=cl>/usr/local/sbin:/usr/local/bin:/usr/sbin:/usr/bin:/root/bin
</span></span><span class=line><span class=cl> 
</span></span><span class=line><span class=cl><span class=nb>test</span> jinja2
</span></span></code></pre></td></tr></table></div></div></div><p>3,{# #}的使用</p><ul><li>同编程语言中注释方式的使用</li></ul><div class=highlight><div class=chroma><div class=table-container><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl><span class=c1># cat test.j2</span>
</span></span><span class=line><span class=cl>jinja2 <span class=nb>test</span>
</span></span><span class=line><span class=cl><span class=o>{</span><span class=c1>#这是一行注释信息#}</span>
</span></span><span class=line><span class=cl>jinja2 <span class=nb>test</span>
</span></span><span class=line><span class=cl><span class=o>{</span><span class=c1>#</span>
</span></span><span class=line><span class=cl>这是多行注释信息,
</span></span><span class=line><span class=cl>模板被渲染以后,
</span></span><span class=line><span class=cl>最终的文件中不会包含这些信息
</span></span><span class=line><span class=cl><span class=c1>#}</span>
</span></span><span class=line><span class=cl>jinja2 <span class=nb>test</span>
</span></span><span class=line><span class=cl> 
</span></span><span class=line><span class=cl> 
</span></span><span class=line><span class=cl>生成文件内容如下:
</span></span><span class=line><span class=cl><span class=c1># cat test</span>
</span></span><span class=line><span class=cl>jinja2 <span class=nb>test</span>
</span></span><span class=line><span class=cl>jinja2 <span class=nb>test</span>
</span></span><span class=line><span class=cl>jinja2 <span class=nb>test</span>
</span></span></code></pre></td></tr></table></div></div></div><h2 id=jinja2模板二><a href=#jinja2模板二 class=anchor-link><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512" class="icon anchor-icon"><path d="M326.612 185.391c59.747 59.809 58.927 155.698.36 214.59-.11.12-.24.25-.36.37l-67.2 67.2c-59.27 59.27-155.699 59.262-214.96.0-59.27-59.26-59.27-155.7.0-214.96l37.106-37.106c9.84-9.84 26.786-3.3 27.294 10.606.648 17.722 3.826 35.527 9.69 52.721 1.986 5.822.567 12.262-3.783 16.612l-13.087 13.087c-28.026 28.026-28.905 73.66-1.155 101.96 28.024 28.579 74.086 28.749 102.325.51l67.2-67.19c28.191-28.191 28.073-73.757.0-101.83-3.701-3.694-7.429-6.564-10.341-8.569a16.037 16.037.0 01-6.947-12.606c-.396-10.567 3.348-21.456 11.698-29.806l21.054-21.055c5.521-5.521 14.182-6.199 20.584-1.731a152.482 152.482.0 0120.522 17.197zM467.547 44.449c-59.261-59.262-155.69-59.27-214.96.0l-67.2 67.2c-.12.12-.25.25-.36.37-58.566 58.892-59.387 154.781.36 214.59a152.454 152.454.0 0020.521 17.196c6.402 4.468 15.064 3.789 20.584-1.731l21.054-21.055c8.35-8.35 12.094-19.239 11.698-29.806a16.037 16.037.0 00-6.947-12.606c-2.912-2.005-6.64-4.875-10.341-8.569-28.073-28.073-28.191-73.639.0-101.83l67.2-67.19c28.239-28.239 74.3-28.069 102.325.51 27.75 28.3 26.872 73.934-1.155 101.96l-13.087 13.087c-4.35 4.35-5.769 10.79-3.783 16.612 5.864 17.194 9.042 34.999 9.69 52.721.509 13.906 17.454 20.446 27.294 10.606l37.106-37.106c59.271-59.259 59.271-155.699.001-214.959z"/></svg></a><a href=#contents:jinja2模板二 class=headings>#jinja2模板(二)</a></h2><p>1,结合if的使用</p><ul><li>通用结构</li></ul><div class=highlight><div class=chroma><div class=table-container><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span><span class=lnt>7
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-yaml data-lang=yaml><span class=line><span class=cl>{<span class=l>% if 条件一 %}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nn>...</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span>{<span class=l>% elif 条件N %}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nn>...</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span>{<span class=l>% else %}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nn>...</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span>{<span class=l>% endif %}</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div></div><ul><li>三元运算</li></ul><div class=highlight><div class=chroma><div class=table-container><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span><span class=lnt>7
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl><span class=c1># cat test.j2</span>
</span></span><span class=line><span class=cl>jinja2 <span class=nb>test</span>
</span></span><span class=line><span class=cl><span class=o>{{</span> <span class=s1>&#39;a&#39;</span> <span class=k>if</span> 2&gt;1 <span class=k>else</span> <span class=s1>&#39;b&#39;</span> <span class=o>}}</span>
</span></span><span class=line><span class=cl><span class=c1># 输出内容如下:</span>
</span></span><span class=line><span class=cl><span class=c1># cat /opt/test</span>
</span></span><span class=line><span class=cl>jinja2 <span class=nb>test</span>
</span></span><span class=line><span class=cl>a
</span></span></code></pre></td></tr></table></div></div></div><p>2,使用set</p><ul><li>如下示例:</li></ul><div class=highlight><div class=chroma><div class=table-container><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl><span class=c1># cat test.j2</span>
</span></span><span class=line><span class=cl>jinja2 <span class=nb>test</span>
</span></span><span class=line><span class=cl><span class=o>{</span>% <span class=nb>set</span> <span class=nv>teststr</span><span class=o>=</span><span class=s1>&#39;abc&#39;</span> %<span class=o>}</span>
</span></span><span class=line><span class=cl><span class=o>{{</span> teststr <span class=o>}}</span>
</span></span><span class=line><span class=cl><span class=c1># 在jinja2中,使用set关键字定义变量,执行如下ad-hoc命令渲染模板</span>
</span></span><span class=line><span class=cl>ansible node2 -m template -a <span class=s2>&#34;src=test.j2 dest=/opt/test&#34;</span>
</span></span><span class=line><span class=cl><span class=c1># 输出内容如下:</span>
</span></span><span class=line><span class=cl><span class=c1># cat /opt/test</span>
</span></span><span class=line><span class=cl>jinja2 <span class=nb>test</span>
</span></span><span class=line><span class=cl>abc
</span></span></code></pre></td></tr></table></div></div></div><p>3,结合for的使用</p><ul><li>通用结构</li></ul><div class=highlight><div class=chroma><div class=table-container><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span><span class=lnt>32
</span><span class=lnt>33
</span><span class=lnt>34
</span><span class=lnt>35
</span><span class=lnt>36
</span><span class=lnt>37
</span><span class=lnt>38
</span><span class=lnt>39
</span><span class=lnt>40
</span><span class=lnt>41
</span><span class=lnt>42
</span><span class=lnt>43
</span><span class=lnt>44
</span><span class=lnt>45
</span><span class=lnt>46
</span><span class=lnt>47
</span><span class=lnt>48
</span><span class=lnt>49
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl><span class=o>{</span>% <span class=k>for</span> 迭代变量 in 可迭代对象 %<span class=o>}</span>
</span></span><span class=line><span class=cl><span class=o>{{</span> 迭代变量 <span class=o>}}</span>
</span></span><span class=line><span class=cl><span class=o>{</span>% endfor %<span class=o>}</span>
</span></span><span class=line><span class=cl><span class=c1># 注: jinja2的控制语句大多都会遵循这个规则,即&#34;XXX&#34;控制语句需要使用&#34;endXXX&#34;作为结尾</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>## 默认换行方式:</span>
</span></span><span class=line><span class=cl><span class=c1># cat test.j2</span>
</span></span><span class=line><span class=cl>jinja2 <span class=nb>test</span>
</span></span><span class=line><span class=cl><span class=o>{</span>% <span class=k>for</span> i in <span class=o>[</span>3,1,7,8,2<span class=o>]</span> %<span class=o>}</span>
</span></span><span class=line><span class=cl><span class=o>{{</span> i <span class=o>}}</span>
</span></span><span class=line><span class=cl><span class=o>{</span>% endfor %<span class=o>}</span>
</span></span><span class=line><span class=cl><span class=c1># ansible node2 -m template -a &#34;src=test.j2 dest=/opt/test&#34;</span>
</span></span><span class=line><span class=cl><span class=c1># cat /opt/test</span>
</span></span><span class=line><span class=cl>jinja2 <span class=nb>test</span>
</span></span><span class=line><span class=cl><span class=m>3</span>
</span></span><span class=line><span class=cl><span class=m>1</span>
</span></span><span class=line><span class=cl><span class=m>7</span>
</span></span><span class=line><span class=cl><span class=m>8</span>
</span></span><span class=line><span class=cl><span class=m>2</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>## 不换行方式:</span>
</span></span><span class=line><span class=cl><span class=c1># cat test.j2</span>
</span></span><span class=line><span class=cl>jinja2 <span class=nb>test</span>
</span></span><span class=line><span class=cl><span class=o>{</span>% <span class=k>for</span> i in <span class=o>[</span>3,1,7,8,2<span class=o>]</span> -%<span class=o>}</span>
</span></span><span class=line><span class=cl><span class=o>{{</span> i <span class=o>}}</span>
</span></span><span class=line><span class=cl><span class=o>{</span>%- endfor %<span class=o>}</span>
</span></span><span class=line><span class=cl><span class=c1># 在for的结束控制符&#34;%}&#34;之前添加了减号&#34;-&#34;</span>
</span></span><span class=line><span class=cl><span class=c1># 在endfor的开始控制符&#34;{%&#34;之后添加到了减号&#34;-&#34;</span>
</span></span><span class=line><span class=cl><span class=c1># cat test</span>
</span></span><span class=line><span class=cl>jinja2 <span class=nb>test</span>
</span></span><span class=line><span class=cl><span class=m>31782</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>## 不换行,但有间隔方式</span>
</span></span><span class=line><span class=cl>jinja2 <span class=nb>test</span>
</span></span><span class=line><span class=cl><span class=o>{</span>% <span class=k>for</span> i in <span class=o>[</span>3,1,7,8,2<span class=o>]</span> -%<span class=o>}</span>
</span></span><span class=line><span class=cl><span class=o>{{</span> i <span class=o>}}{{</span> <span class=s1>&#39; &#39;</span> <span class=o>}}</span>
</span></span><span class=line><span class=cl><span class=o>{</span>%- endfor %<span class=o>}</span>
</span></span><span class=line><span class=cl><span class=c1># 在循环每一项时,在每一项后面加入了一个空格字符串</span>
</span></span><span class=line><span class=cl><span class=c1># cat test</span>
</span></span><span class=line><span class=cl>jinja2 <span class=nb>test</span>
</span></span><span class=line><span class=cl><span class=m>3</span> <span class=m>1</span> <span class=m>7</span> <span class=m>8</span> <span class=m>2</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>## 不换行,但有间隔方式二</span>
</span></span><span class=line><span class=cl><span class=c1># cat test.j2</span>
</span></span><span class=line><span class=cl>jinja2 <span class=nb>test</span>
</span></span><span class=line><span class=cl><span class=o>{</span>% <span class=k>for</span> i in <span class=o>[</span>3,1,7,8,2<span class=o>]</span> -%<span class=o>}</span>
</span></span><span class=line><span class=cl><span class=o>{{</span> i~<span class=s1>&#39; &#39;</span> <span class=o>}}</span>
</span></span><span class=line><span class=cl><span class=o>{</span>%- endfor %<span class=o>}</span>
</span></span><span class=line><span class=cl><span class=c1># 在jinja2中,波浪符&#34;~&#34;就是字符串连接符,它会把所有的操作数转换为字符串,并且连接它们</span>
</span></span></code></pre></td></tr></table></div></div></div><p>4,结合for使用,循环字典</p><ul><li>如下示例:</li></ul><div class=highlight><div class=chroma><div class=table-container><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl><span class=c1># cat test.j2</span>
</span></span><span class=line><span class=cl>jinja2 <span class=nb>test</span>
</span></span><span class=line><span class=cl><span class=o>{</span>% <span class=k>for</span> key,val in <span class=o>{</span><span class=s1>&#39;name&#39;</span>:<span class=s1>&#39;bob&#39;</span>,<span class=s1>&#39;age&#39;</span>:18<span class=o>}</span>.iteritems<span class=o>()</span> %<span class=o>}</span>
</span></span><span class=line><span class=cl><span class=o>{{</span> key ~ <span class=s1>&#39;:&#39;</span> ~ val <span class=o>}}</span>
</span></span><span class=line><span class=cl><span class=o>{</span>% endfor %<span class=o>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># cat test</span>
</span></span><span class=line><span class=cl>jinja2 <span class=nb>test</span>
</span></span><span class=line><span class=cl>age:18
</span></span><span class=line><span class=cl>name:bob
</span></span></code></pre></td></tr></table></div></div></div><p>5,在使用for循环时,有一些内置的特殊变量可以使用</p><ul><li>当前循环操作为整个循环的第几次操作,则可以借助"loop.index"特殊变量</li></ul><div class=highlight><div class=chroma><div class=table-container><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-jinja data-lang=jinja><span class=line><span class=cl><span class=x># cat test.j2
</span></span></span><span class=line><span class=cl><span class=x>jinja2 test
</span></span></span><span class=line><span class=cl><span class=x></span><span class=cp>{%</span> <span class=k>for</span> <span class=nv>i</span> <span class=k>in</span> <span class=o>[</span><span class=m>3</span><span class=o>,</span><span class=m>1</span><span class=o>,</span><span class=m>7</span><span class=o>,</span><span class=m>8</span><span class=o>,</span><span class=m>2</span><span class=o>]</span> <span class=cp>%}</span><span class=x>
</span></span></span><span class=line><span class=cl><span class=x></span><span class=cp>{{</span> <span class=nv>i</span> <span class=o>~</span> <span class=s1>&#39;----&#39;</span> <span class=o>~</span> <span class=nb>loop</span><span class=nv>.index</span> <span class=cp>}}</span><span class=x>
</span></span></span><span class=line><span class=cl><span class=x></span><span class=cp>{%</span> <span class=k>endfor</span> <span class=cp>%}</span><span class=x>
</span></span></span><span class=line><span class=cl><span class=x># cat test
</span></span></span><span class=line><span class=cl><span class=x>jinja2 test
</span></span></span><span class=line><span class=cl><span class=x>3----1
</span></span></span><span class=line><span class=cl><span class=x>1----2
</span></span></span><span class=line><span class=cl><span class=x>7----3
</span></span></span><span class=line><span class=cl><span class=x>8----4
</span></span></span><span class=line><span class=cl><span class=x>2----5
</span></span></span></code></pre></td></tr></table></div></div></div><ul><li>其他的一些循环变量</li></ul><div class=highlight><div class=chroma><div class=table-container><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl><span class=c1># loop.index   当前循环操作为整个循环的第几次循环,序号从1开始</span>
</span></span><span class=line><span class=cl><span class=c1># loop.index0   当前循环操作为整个循环的第几次循环,序号从0开始</span>
</span></span><span class=line><span class=cl><span class=c1># loop.revindex  当前循环操作距离整个循环结束还有几次,序号到1结束</span>
</span></span><span class=line><span class=cl><span class=c1># loop.revindex0 当前循环操作距离整个循环结束还有几次,序号到0结束</span>
</span></span><span class=line><span class=cl><span class=c1># loop.first    当操作可迭代对象中的第一个元素时,此变量的值为true</span>
</span></span><span class=line><span class=cl><span class=c1># loop.last    当操作可迭代对象中的最后一个元素时,此变量的值为true</span>
</span></span><span class=line><span class=cl><span class=c1># loop.length   可迭代对象的长度</span>
</span></span><span class=line><span class=cl><span class=c1># loop.depth   当使用递归的循环时,当前迭代所在的递归中的层级,层级序号从1开始</span>
</span></span><span class=line><span class=cl><span class=c1># loop.depth0   当使用递归的循环时,当前迭代所在的递归中的层级,层级序号从0开始</span>
</span></span><span class=line><span class=cl><span class=c1># loop.cycle()  这是一个辅助函数,通过这个函数我们可以在指定的一些值中进行轮询取值,具体参考之后的示例</span>
</span></span></code></pre></td></tr></table></div></div></div><ul><li>对一段内容循环的生成指定的次数,则可以借助range函数完成</li></ul><div class=highlight><div class=chroma><div class=table-container><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-jinja data-lang=jinja><span class=line><span class=cl><span class=cp>{%</span> <span class=k>for</span> <span class=nv>i</span> <span class=k>in</span> <span class=nv>range</span><span class=o>(</span><span class=m>3</span><span class=o>)</span> <span class=cp>%}</span><span class=x>
</span></span></span><span class=line><span class=cl><span class=x>something
</span></span></span><span class=line><span class=cl><span class=x>...
</span></span></span><span class=line><span class=cl><span class=x></span><span class=cp>{%</span> <span class=k>endfor</span> <span class=cp>%}</span><span class=x>
</span></span></span></code></pre></td></tr></table></div></div></div><p>6,for的一些其他操作</p><ul><li>当for循环中没有使用if内联表达式时,也可以使用else块</li></ul><div class=highlight><div class=chroma><div class=table-container><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-jinja data-lang=jinja><span class=line><span class=cl><span class=cp>{%</span> <span class=k>for</span> <span class=nv>u</span> <span class=k>in</span> <span class=nv>userlist</span> <span class=cp>%}</span><span class=x>
</span></span></span><span class=line><span class=cl><span class=x>  </span><span class=cp>{{</span> <span class=nv>u.name</span> <span class=cp>}}</span><span class=x>
</span></span></span><span class=line><span class=cl><span class=x></span><span class=cp>{%</span><span class=k>else</span><span class=cp>%}</span><span class=x>
</span></span></span><span class=line><span class=cl><span class=x>  no one
</span></span></span><span class=line><span class=cl><span class=x></span><span class=cp>{%</span> <span class=k>endfor</span> <span class=cp>%}</span><span class=x>
</span></span></span><span class=line><span class=cl><span class=x># 只有userlist列表为空时,才会渲染else块后的内容
</span></span></span></code></pre></td></tr></table></div></div></div><ul><li>for支持递归操作</li></ul><div class=highlight><div class=chroma><div class=table-container><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-jinja data-lang=jinja><span class=line><span class=cl><span class=cp>{%</span> <span class=k>set</span> <span class=nv>dictionary</span><span class=o>={</span> <span class=s1>&#39;name&#39;:&#39;bob&#39;</span><span class=o>,</span><span class=s1>&#39;son&#39;</span><span class=o>:{</span> <span class=s1>&#39;name&#39;:&#39;tom&#39;</span><span class=o>,</span><span class=s1>&#39;son&#39;</span><span class=o>:{</span> <span class=s1>&#39;name&#39;:&#39;jerry&#39;</span> <span class=o>}</span> <span class=o>}</span> <span class=o>}</span>  <span class=cp>%}</span><span class=x>
</span></span></span><span class=line><span class=cl><span class=x> 
</span></span></span><span class=line><span class=cl><span class=x></span><span class=cp>{%</span> <span class=k>for</span> <span class=nv>key</span><span class=o>,</span><span class=nv>value</span> <span class=k>in</span> <span class=nv>dictionary.iteritems</span><span class=o>()</span> <span class=k>recursive</span> <span class=cp>%}</span><span class=x>
</span></span></span><span class=line><span class=cl><span class=x>  </span><span class=cp>{%</span> <span class=k>if</span> <span class=nv>key</span> <span class=o>==</span> <span class=s1>&#39;name&#39;</span> <span class=cp>%}</span><span class=x>
</span></span></span><span class=line><span class=cl><span class=x>    </span><span class=cp>{%</span> <span class=k>set</span> <span class=nv>fathername</span><span class=o>=</span><span class=nv>value</span> <span class=cp>%}</span><span class=x>
</span></span></span><span class=line><span class=cl><span class=x>  </span><span class=cp>{%</span> <span class=k>endif</span> <span class=cp>%}</span><span class=x>
</span></span></span><span class=line><span class=cl><span class=x> 
</span></span></span><span class=line><span class=cl><span class=x>  </span><span class=cp>{%</span> <span class=k>if</span> <span class=nv>key</span> <span class=o>==</span> <span class=s1>&#39;son&#39;</span> <span class=cp>%}</span><span class=x>
</span></span></span><span class=line><span class=cl><span class=x>    </span><span class=cp>{{</span> <span class=nv>fathername</span> <span class=o>~</span><span class=s2>&#34;&#39;s son is &#34;</span><span class=o>~</span> <span class=nv>value.name</span><span class=cp>}}</span><span class=x>
</span></span></span><span class=line><span class=cl><span class=x>    </span><span class=cp>{{</span> <span class=nb>loop</span><span class=o>(</span> <span class=nv>value.iteritems</span><span class=o>()</span> <span class=o>)</span> <span class=cp>}}</span><span class=x>
</span></span></span><span class=line><span class=cl><span class=x>  </span><span class=cp>{%</span> <span class=k>endif</span> <span class=cp>%}</span><span class=x>
</span></span></span><span class=line><span class=cl><span class=x></span><span class=cp>{%</span> <span class=k>endfor</span> <span class=cp>%}</span><span class=x>
</span></span></span><span class=line><span class=cl><span class=x># 使用了iteritems函数,在for循环的末尾,添加了recursive 修饰符,当for循环中有recursive时,表示这个循环是一个递归的循环,当需要在for循环中进行递归时,只要在需要进行递归的地方调用loop函数即可,上例中的&#34;loop( value.iteritems() )&#34;即为调用递归的部分,由于value也是一个字典,所以需要使用iteritems函数进行处理
</span></span></span><span class=line><span class=cl><span class=x>bob&#39;s son is tom
</span></span></span><span class=line><span class=cl><span class=x>tom&#39;s son is jerry
</span></span></span></code></pre></td></tr></table></div></div></div><h2 id=jinja2模板三><a href=#jinja2模板三 class=anchor-link><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512" class="icon anchor-icon"><path d="M326.612 185.391c59.747 59.809 58.927 155.698.36 214.59-.11.12-.24.25-.36.37l-67.2 67.2c-59.27 59.27-155.699 59.262-214.96.0-59.27-59.26-59.27-155.7.0-214.96l37.106-37.106c9.84-9.84 26.786-3.3 27.294 10.606.648 17.722 3.826 35.527 9.69 52.721 1.986 5.822.567 12.262-3.783 16.612l-13.087 13.087c-28.026 28.026-28.905 73.66-1.155 101.96 28.024 28.579 74.086 28.749 102.325.51l67.2-67.19c28.191-28.191 28.073-73.757.0-101.83-3.701-3.694-7.429-6.564-10.341-8.569a16.037 16.037.0 01-6.947-12.606c-.396-10.567 3.348-21.456 11.698-29.806l21.054-21.055c5.521-5.521 14.182-6.199 20.584-1.731a152.482 152.482.0 0120.522 17.197zM467.547 44.449c-59.261-59.262-155.69-59.27-214.96.0l-67.2 67.2c-.12.12-.25.25-.36.37-58.566 58.892-59.387 154.781.36 214.59a152.454 152.454.0 0020.521 17.196c6.402 4.468 15.064 3.789 20.584-1.731l21.054-21.055c8.35-8.35 12.094-19.239 11.698-29.806a16.037 16.037.0 00-6.947-12.606c-2.912-2.005-6.64-4.875-10.341-8.569-28.073-28.073-28.191-73.639.0-101.83l67.2-67.19c28.239-28.239 74.3-28.069 102.325.51 27.75 28.3 26.872 73.934-1.155 101.96l-13.087 13.087c-4.35 4.35-5.769 10.79-3.783 16.612 5.864 17.194 9.042 34.999 9.69 52.721.509 13.906 17.454 20.446 27.294 10.606l37.106-37.106c59.271-59.259 59.271-155.699.001-214.959z"/></svg></a><a href=#contents:jinja2模板三 class=headings>#jinja2模板(三)</a></h2><p>1,jinja2模板文件中需要使用特殊字符</p><ul><li>最简单的方法就是直接在"双花括号"中使用引号将这类符号引起,当做纯粹的字符串进行处理</li></ul><div class=highlight><div class=chroma><div class=table-container><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-jinja data-lang=jinja><span class=line><span class=cl><span class=x># cat test.j2
</span></span></span><span class=line><span class=cl><span class=x></span><span class=cp>{{</span>  <span class=s1>&#39;{{&#39;</span> <span class=cp>}}</span><span class=x>
</span></span></span><span class=line><span class=cl><span class=x></span><span class=cp>{{</span>  <span class=s1>&#39;}}&#39;</span> <span class=cp>}}</span><span class=x>
</span></span></span><span class=line><span class=cl><span class=x></span><span class=cp>{{</span> <span class=s1>&#39;{{ test string }}&#39;</span> <span class=cp>}}</span><span class=x>
</span></span></span><span class=line><span class=cl><span class=x></span><span class=cp>{{</span> <span class=s1>&#39;{% test string %}&#39;</span> <span class=cp>}}</span><span class=x>
</span></span></span><span class=line><span class=cl><span class=x></span><span class=cp>{{</span> <span class=s1>&#39;{# test string #}&#39;</span> <span class=cp>}}</span><span class=x>
</span></span></span><span class=line><span class=cl><span class=x># cat test
</span></span></span><span class=line><span class=cl><span class=x></span><span class=cp>{{</span>
</span></span><span class=line><span class=cl><span class=cp>}}</span><span class=x>
</span></span></span><span class=line><span class=cl><span class=x></span><span class=cp>{{</span> <span class=nv>test</span> <span class=nv>string</span> <span class=cp>}}</span><span class=x>
</span></span></span><span class=line><span class=cl><span class=x></span><span class=cp>{%</span> <span class=k>test</span> <span class=nv>string</span> <span class=cp>%}</span><span class=x>
</span></span></span><span class=line><span class=cl><span class=x></span><span class=c>{# test string #}</span><span class=x>
</span></span></span></code></pre></td></tr></table></div></div></div><ul><li>如果有较大的段落时,可以借助raw块,来实现需求</li></ul><div class=highlight><div class=chroma><div class=table-container><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-jinja data-lang=jinja><span class=line><span class=cl><span class=x># cat test.j2
</span></span></span><span class=line><span class=cl><span class=x></span><span class=cp>{%</span> <span class=k>raw</span> <span class=cp>%}</span>
</span></span><span class=line><span class=cl>  {{ test }}
</span></span><span class=line><span class=cl>  {% test %}
</span></span><span class=line><span class=cl>  {# test #}
</span></span><span class=line><span class=cl>  {% if %}
</span></span><span class=line><span class=cl>  {% for %}
</span></span><span class=line><span class=cl><span class=cp>{%</span> <span class=k>endraw</span> <span class=cp>%}</span><span class=x>
</span></span></span><span class=line><span class=cl><span class=x># &#34;</span><span class=cp>{%</span> <span class=k>raw</span> <span class=cp>%}</span>&#34;与&#34;<span class=cp>{%</span> <span class=k>endraw</span> <span class=cp>%}</span><span class=x>&#34;之间的所有&#34;</span><span class=cp>{{</span>  <span class=cp>}}</span><span class=x>&#34;、&#34;{%  %}&#34;或者&#34;</span><span class=c>{#  #}</span><span class=x>&#34;都不会被jinja2解析,上例模板被渲染后,raw块中的符号都会保持原样
</span></span></span><span class=line><span class=cl><span class=x># cat test
</span></span></span><span class=line><span class=cl><span class=x> 
</span></span></span><span class=line><span class=cl><span class=x>  </span><span class=cp>{{</span> <span class=nv>test</span> <span class=cp>}}</span><span class=x>
</span></span></span><span class=line><span class=cl><span class=x>  </span><span class=cp>{%</span> <span class=k>test</span> <span class=cp>%}</span><span class=x>
</span></span></span><span class=line><span class=cl><span class=x>  </span><span class=c>{# test #}</span><span class=x>
</span></span></span><span class=line><span class=cl><span class=x>  </span><span class=cp>{%</span> <span class=k>if</span> <span class=cp>%}</span><span class=x>
</span></span></span><span class=line><span class=cl><span class=x>  </span><span class=cp>{%</span> <span class=k>for</span> <span class=cp>%}</span><span class=x>
</span></span></span></code></pre></td></tr></table></div></div></div><p>2,在调用模板引擎时,手动的指定一些符号,这些符号可以替换默认的区块</p><ul><li>如下示例:</li></ul><div class=highlight><div class=chroma><div class=table-container><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-jinja data-lang=jinja><span class=line><span class=cl><span class=x># cat test.j2
</span></span></span><span class=line><span class=cl><span class=x></span><span class=cp>{%</span> <span class=k>set</span> <span class=nv>test</span><span class=o>=</span><span class=s1>&#39;abc&#39;</span> <span class=cp>%}</span><span class=x>
</span></span></span><span class=line><span class=cl><span class=x> 
</span></span></span><span class=line><span class=cl><span class=x>(( test ))
</span></span></span><span class=line><span class=cl><span class=x> 
</span></span></span><span class=line><span class=cl><span class=x></span><span class=cp>{{</span> <span class=nv>test</span> <span class=cp>}}</span><span class=x>
</span></span></span><span class=line><span class=cl><span class=x></span><span class=cp>{{</span> <span class=nv>test1</span> <span class=cp>}}</span><span class=x>
</span></span></span><span class=line><span class=cl><span class=x></span><span class=cp>{{</span> <span class=s1>&#39;test&#39;</span> <span class=cp>}}</span><span class=x>
</span></span></span><span class=line><span class=cl><span class=x></span><span class=cp>{{</span> <span class=s1>&#39;test1&#39;</span> <span class=cp>}}</span><span class=x>
</span></span></span><span class=line><span class=cl><span class=x># 使用variable_start_string参数指定一个符号,这个符号用于替换&#34;</span><span class=cp>{{</span>  <span class=cp>}}</span><span class=x>&#34;中的&#34;</span><span class=cp>{{</span><span class=err>“</span><span class=o>,</span><span class=err>同时</span><span class=o>,</span><span class=err>可以使用</span><span class=nv>variable_end_string参数指定一个符号</span><span class=o>,</span><span class=err>这个符号用于替换</span><span class=s2>&#34;{{  }}&#34;</span><span class=err>中的</span><span class=s2>&#34;}}&#34;</span>
</span></span><span class=line><span class=cl><span class=err>#</span> <span class=nv>ansible</span> <span class=nv>node2</span> <span class=o>-</span><span class=nv>m</span> <span class=nv>template</span> <span class=o>-</span><span class=nv>a</span> <span class=s2>&#34;src=test.j2 dest=/opt/test variable_start_string=&#39;((&#39; variable_end_string=&#39;))&#39;&#34;</span>
</span></span><span class=line><span class=cl><span class=err>#</span> <span class=nv>cat</span> <span class=nv>test</span>
</span></span><span class=line><span class=cl> 
</span></span><span class=line><span class=cl><span class=nv>abc</span>
</span></span><span class=line><span class=cl> 
</span></span><span class=line><span class=cl><span class=o>{{</span> <span class=nv>test</span> <span class=cp>}}</span><span class=x>
</span></span></span><span class=line><span class=cl><span class=x></span><span class=cp>{{</span> <span class=nv>test1</span> <span class=cp>}}</span><span class=x>
</span></span></span><span class=line><span class=cl><span class=x></span><span class=cp>{{</span> <span class=s1>&#39;test&#39;</span> <span class=cp>}}</span><span class=x>
</span></span></span><span class=line><span class=cl><span class=x></span><span class=cp>{{</span> <span class=s1>&#39;test1&#39;</span> <span class=cp>}}</span><span class=x>
</span></span></span><span class=line><span class=cl><span class=x>
</span></span></span><span class=line><span class=cl><span class=x># 可以使用block_start_string参数指定一个符号, 这个符号用于替换&#34;{%  %}&#34;中的&#34;{% &#34;,可以使用block_end_string参数指定一个符号,这个符号用于替换&#34;{%  %}&#34;中的&#34;%}&#34;
</span></span></span></code></pre></td></tr></table></div></div></div><p>3,jinja2中也有类似函数的东西,名字叫做宏</p><ul><li>如下示例:</li></ul><div class=highlight><div class=chroma><div class=table-container><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-jinja data-lang=jinja><span class=line><span class=cl><span class=x># 最简单的宏
</span></span></span><span class=line><span class=cl><span class=x># cat test.j2
</span></span></span><span class=line><span class=cl><span class=x></span><span class=cp>{%</span> <span class=k>macro</span> <span class=nv>testfunc</span><span class=o>()</span> <span class=cp>%}</span><span class=x>
</span></span></span><span class=line><span class=cl><span class=x>  test string
</span></span></span><span class=line><span class=cl><span class=x>  </span><span class=cp>{%</span> <span class=k>endmacro</span> <span class=cp>%}</span><span class=x>
</span></span></span><span class=line><span class=cl><span class=x>   
</span></span></span><span class=line><span class=cl><span class=x>   </span><span class=cp>{{</span> <span class=nv>testfunc</span><span class=o>()</span> <span class=cp>}}</span><span class=x>
</span></span></span><span class=line><span class=cl><span class=x># 指定参数的宏,包含默认值
</span></span></span><span class=line><span class=cl><span class=x></span><span class=cp>{%</span> <span class=k>macro</span> <span class=nv>testfunc</span><span class=o>(</span><span class=nv>tv1</span><span class=o>=</span><span class=m>111</span><span class=o>)</span> <span class=cp>%}</span><span class=x>
</span></span></span><span class=line><span class=cl><span class=x>  test string
</span></span></span><span class=line><span class=cl><span class=x>    </span><span class=cp>{{</span><span class=nv>tv1</span><span class=cp>}}</span><span class=x>
</span></span></span><span class=line><span class=cl><span class=x>    </span><span class=cp>{%</span> <span class=k>endmacro</span> <span class=cp>%}</span><span class=x>
</span></span></span><span class=line><span class=cl><span class=x>     
</span></span></span><span class=line><span class=cl><span class=x>     </span><span class=cp>{{</span> <span class=nv>testfunc</span><span class=o>(</span> <span class=o>)</span> <span class=cp>}}</span><span class=x>
</span></span></span><span class=line><span class=cl><span class=x>     </span><span class=cp>{{</span> <span class=nv>testfunc</span><span class=o>(</span><span class=m>666</span><span class=o>)</span> <span class=cp>}}</span><span class=x>
</span></span></span></code></pre></td></tr></table></div></div></div><h2 id=ansible中的role><a href=#ansible中的role class=anchor-link><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512" class="icon anchor-icon"><path d="M326.612 185.391c59.747 59.809 58.927 155.698.36 214.59-.11.12-.24.25-.36.37l-67.2 67.2c-59.27 59.27-155.699 59.262-214.96.0-59.27-59.26-59.27-155.7.0-214.96l37.106-37.106c9.84-9.84 26.786-3.3 27.294 10.606.648 17.722 3.826 35.527 9.69 52.721 1.986 5.822.567 12.262-3.783 16.612l-13.087 13.087c-28.026 28.026-28.905 73.66-1.155 101.96 28.024 28.579 74.086 28.749 102.325.51l67.2-67.19c28.191-28.191 28.073-73.757.0-101.83-3.701-3.694-7.429-6.564-10.341-8.569a16.037 16.037.0 01-6.947-12.606c-.396-10.567 3.348-21.456 11.698-29.806l21.054-21.055c5.521-5.521 14.182-6.199 20.584-1.731a152.482 152.482.0 0120.522 17.197zM467.547 44.449c-59.261-59.262-155.69-59.27-214.96.0l-67.2 67.2c-.12.12-.25.25-.36.37-58.566 58.892-59.387 154.781.36 214.59a152.454 152.454.0 0020.521 17.196c6.402 4.468 15.064 3.789 20.584-1.731l21.054-21.055c8.35-8.35 12.094-19.239 11.698-29.806a16.037 16.037.0 00-6.947-12.606c-2.912-2.005-6.64-4.875-10.341-8.569-28.073-28.073-28.191-73.639.0-101.83l67.2-67.19c28.239-28.239 74.3-28.069 102.325.51 27.75 28.3 26.872 73.934-1.155 101.96l-13.087 13.087c-4.35 4.35-5.769 10.79-3.783 16.612 5.864 17.194 9.042 34.999 9.69 52.721.509 13.906 17.454 20.446 27.294 10.606l37.106-37.106c59.271-59.259 59.271-155.699.001-214.959z"/></svg></a><a href=#contents:ansible中的role class=headings>#ansible中的role</a></h2><p>1,ansible官方定义的规范</p><ul><li>role的标准目录结构</li></ul><div class=highlight><div class=chroma><div class=table-container><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>$ tree role
</span></span><span class=line><span class=cl>role
</span></span><span class=line><span class=cl>├── defaults
</span></span><span class=line><span class=cl>│   └── main.yml
</span></span><span class=line><span class=cl>├── files
</span></span><span class=line><span class=cl>├── handlers
</span></span><span class=line><span class=cl>│   └── main.yml
</span></span><span class=line><span class=cl>├── meta
</span></span><span class=line><span class=cl>│   └── main.yml
</span></span><span class=line><span class=cl>├── tasks
</span></span><span class=line><span class=cl>│   └── main.yml
</span></span><span class=line><span class=cl>├── templates
</span></span><span class=line><span class=cl>└── vars
</span></span><span class=line><span class=cl>    └── main.yml
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># tasks目录:角色需要执行的主任务文件放置在此目录中,默认的主任务文件名为main.yml,当调用角色时,默认会执行main.yml文件中的任务,也可以将其他需要执行的任务文件通过include的方式包含在tasks/main.yml文件中.</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># handlers目录:当角色需要调用handlers时,默认会在此目录中的main.yml文件中查找对应的handler</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># defaults目录:角色会使用到的变量可以写入到此目录中的main.yml文件中,通常,defaults/main.yml文件中的变量都用于设置默认值,以便在你没有设置对应变量值时,变量有默认的值可以使用,定义在defaults/main.yml文件中的变量的优先级是最低的.</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># vars目录:角色会使用到的变量可以写入到此目录中的main.yml文件中,看到这里你肯定会有疑问,vars/main.yml文件和defaults/main.yml文件的区别在哪里呢？区别就是,defaults/main.yml文件中的变量的优先级是最低的,而vars/main.yml文件中的变量的优先级非常高,如果你只是想提供一个默认的配置,那么你可以把对应的变量定义在defaults/main.yml中,如果你想要确保别人在调用角色时,使用的值就是你指定的值,则可以将变量定义在vars/main.yml中,因为定义在vars/main.yml文件中的变量的优先级非常高,所以其值比较难以覆盖.</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># meta目录:如果你想要赋予这个角色一些元数据,则可以将元数据写入到meta/main.yml文件中,这些元数据用于描述角色的相关属性,比如 作者信息、角色主要作用等等,你也可以在meta/main.yml文件中定义这个角色依赖于哪些其他角色,或者改变角色的默认调用设定,在之后会有一些实际的示例,此处不用纠结.</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># templates目录: 角色相关的模板文件可以放置在此目录中,当使用角色相关的模板时,如果没有指定路径,会默认从此目录中查找对应名称的模板文件.</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># files目录:角色可能会用到的一些其他文件可以放置在此目录中,比如,当你定义nginx角色时,需要配置https,那么相关的证书文件即可放置在此目录中.</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 当然,上述目录并不全是必须的,也就是说,如果你的角色并没有相关的模板文件,那么角色目录中并不用包含templates目录,同理,其他目录也一样,一般情况下,都至少会有一个tasks目录.</span>
</span></span></code></pre></td></tr></table></div></div></div><p>2,调用role的方式</p><ul><li>如下示例:</li></ul><div class=highlight><div class=chroma><div class=table-container><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl><span class=c1># ls</span>
</span></span><span class=line><span class=cl>testrole  test.yml
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># cat test.yml</span>
</span></span><span class=line><span class=cl>- hosts: node2
</span></span><span class=line><span class=cl>  roles:
</span></span><span class=line><span class=cl>    - testrole
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># ansible-playbook test.yml</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>## 调用testrole角色时,test.yml会从同级目录中查找与testrole角色同名的目录</span>
</span></span><span class=line><span class=cl><span class=c1>## 还有其他位置也可以被调用:</span>
</span></span><span class=line><span class=cl><span class=c1>## 1,当前系统用户的家目录中的.ansible/roles目录,即 ~/.ansible/roles目录中</span>
</span></span><span class=line><span class=cl><span class=c1>## 2,同级目录中的roles目录中</span>
</span></span><span class=line><span class=cl><span class=c1>## 3,修改ansible的配置文件,编辑/etc/ansible/ansible.cfg配置文件,设置roles_path选项</span>
</span></span><span class=line><span class=cl><span class=nv>roles_path</span>    <span class=o>=</span> /etc/ansible/roles:/opt:/testdir
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>## 或者在playbook中,直接接上role的绝对路径</span>
</span></span></code></pre></td></tr></table></div></div></div><p>3,一些role使用的问题</p><ul><li>在默认情况下,角色中的变量是全局可访问的,可以将变量的访问域变成角色所私有的,如果想要将变量变成角色私有的,则需要设置/etc/ansible/ansible.cfg文件,将private_role_vars的值设置为yes,默认情况下,"private_role_vars = yes"是被注释掉的,将前面的注释符去掉皆可</li><li>默认情况下,无法多次调用同一个角色,也就是说,如下playbook只会调用一次testrole角色:</li></ul><div class=highlight><div class=chroma><div class=table-container><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl><span class=c1># cat test.yml</span>
</span></span><span class=line><span class=cl>- hosts: node2
</span></span><span class=line><span class=cl>  roles:
</span></span><span class=line><span class=cl>    - role: testrole
</span></span><span class=line><span class=cl>      - role: testrole
</span></span><span class=line><span class=cl><span class=c1># 如果想要多次调用同一个角色,有两种方法,如下:</span>
</span></span><span class=line><span class=cl><span class=c1># 方法一:设置角色的allow_duplicates属性 ,让其支持重复的调用.</span>
</span></span><span class=line><span class=cl><span class=c1># 方法二:调用角色时,传入的参数值不同.</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 方法一需要为角色设置allow_duplicates属性,而此属性需要设置在meta/main.yml文件中,所以我们需要在testrole中创建meta/main.yml文件,写入如下内容:</span>
</span></span><span class=line><span class=cl><span class=c1># cat testrole/meta/main.yml</span>
</span></span><span class=line><span class=cl>allow_duplicates: <span class=nb>true</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 方法二</span>
</span></span><span class=line><span class=cl><span class=c1># cat test.yml</span>
</span></span><span class=line><span class=cl><span class=c1># cat test.yml</span>
</span></span><span class=line><span class=cl>- hosts: node2
</span></span><span class=line><span class=cl>  roles:
</span></span><span class=line><span class=cl>  - role: testrole
</span></span><span class=line><span class=cl>    vars:
</span></span><span class=line><span class=cl>      testvar: <span class=s2>&#34;zsythink&#34;</span>
</span></span><span class=line><span class=cl>  - role: testrole
</span></span><span class=line><span class=cl>    vars:
</span></span><span class=line><span class=cl>      testvar: <span class=s2>&#34;zsythink.net&#34;</span>
</span></span></code></pre></td></tr></table></div></div></div><p>4,除了使用"-e"传入的变量的优先级,其他变量（包括主机变量）的优先级均低于vars/main.yml中变量的优先级</p><p>5,调试handler方法</p><ul><li>如下示例:</li></ul><div class=highlight><div class=chroma><div class=table-container><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl><span class=c1># cat testrole/tasks/main.yml</span>
</span></span><span class=line><span class=cl>- debug:
</span></span><span class=line><span class=cl>    msg: <span class=s2>&#34;hello testrole!&#34;</span>
</span></span><span class=line><span class=cl>  changed_when: <span class=nb>true</span>
</span></span><span class=line><span class=cl>  notify: test_handler
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># cat testrole/handlers/main.yml</span>
</span></span><span class=line><span class=cl>- name: test_handler
</span></span><span class=line><span class=cl>  debug:
</span></span><span class=line><span class=cl>    msg: <span class=s2>&#34;this is a test handler&#34;</span>
</span></span></code></pre></td></tr></table></div></div></div><h2 id=常用技巧一><a href=#常用技巧一 class=anchor-link><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512" class="icon anchor-icon"><path d="M326.612 185.391c59.747 59.809 58.927 155.698.36 214.59-.11.12-.24.25-.36.37l-67.2 67.2c-59.27 59.27-155.699 59.262-214.96.0-59.27-59.26-59.27-155.7.0-214.96l37.106-37.106c9.84-9.84 26.786-3.3 27.294 10.606.648 17.722 3.826 35.527 9.69 52.721 1.986 5.822.567 12.262-3.783 16.612l-13.087 13.087c-28.026 28.026-28.905 73.66-1.155 101.96 28.024 28.579 74.086 28.749 102.325.51l67.2-67.19c28.191-28.191 28.073-73.757.0-101.83-3.701-3.694-7.429-6.564-10.341-8.569a16.037 16.037.0 01-6.947-12.606c-.396-10.567 3.348-21.456 11.698-29.806l21.054-21.055c5.521-5.521 14.182-6.199 20.584-1.731a152.482 152.482.0 0120.522 17.197zM467.547 44.449c-59.261-59.262-155.69-59.27-214.96.0l-67.2 67.2c-.12.12-.25.25-.36.37-58.566 58.892-59.387 154.781.36 214.59a152.454 152.454.0 0020.521 17.196c6.402 4.468 15.064 3.789 20.584-1.731l21.054-21.055c8.35-8.35 12.094-19.239 11.698-29.806a16.037 16.037.0 00-6.947-12.606c-2.912-2.005-6.64-4.875-10.341-8.569-28.073-28.073-28.191-73.639.0-101.83l67.2-67.19c28.239-28.239 74.3-28.069 102.325.51 27.75 28.3 26.872 73.934-1.155 101.96l-13.087 13.087c-4.35 4.35-5.769 10.79-3.783 16.612 5.864 17.194 9.042 34.999 9.69 52.721.509 13.906 17.454 20.446 27.294 10.606l37.106-37.106c59.271-59.259 59.271-155.699.001-214.959z"/></svg></a><a href=#contents:常用技巧一 class=headings>#常用技巧(一)</a></h2><p>1,技巧一,在ansible中使用python字符串的一些特性</p><ul><li>ansible基于python实现,当我们在ansible中处理字符串时,能够借助一些python的字符串特性,比如,在python中可以使用中括号(方括号)截取字符串中的一部分,在ansible中也可以利用这一特性</li></ul><div class=highlight><div class=chroma><div class=table-container><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl><span class=c1># cat test.yml</span>
</span></span><span class=line><span class=cl>- hosts: me
</span></span><span class=line><span class=cl>  gather_facts: no
</span></span><span class=line><span class=cl>  vars:
</span></span><span class=line><span class=cl>    a: <span class=s2>&#34;vaA12345&#34;</span>
</span></span><span class=line><span class=cl>  tasks:
</span></span><span class=line><span class=cl>  - debug:
</span></span><span class=line><span class=cl>      msg: <span class=s2>&#34;{{a[2]}}&#34;</span>
</span></span><span class=line><span class=cl><span class=c1># 使用a[2:5]获取到a字符串的第3到第5个字符（不包含第6个字符）</span>
</span></span><span class=line><span class=cl><span class=c1># 使用a[:5]获取到a字符串的第6个字符之前的所有字符（不包含第6个字符）</span>
</span></span><span class=line><span class=cl><span class=c1># 使用a[5:]获取到a字符串的第6个字符之后的所有字符（包含第6个字符）</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>## 之前成员运算符&#34;in&#34;和&#34;not in&#34;,也是python的字符串运算符</span>
</span></span><span class=line><span class=cl>- hosts: me
</span></span><span class=line><span class=cl>  gather_facts: no
</span></span><span class=line><span class=cl>  vars:
</span></span><span class=line><span class=cl>    a: <span class=s2>&#34;vaA12345&#34;</span>
</span></span><span class=line><span class=cl>  tasks:
</span></span><span class=line><span class=cl>  - debug:
</span></span><span class=line><span class=cl>      msg: <span class=s2>&#34;true&#34;</span>
</span></span><span class=line><span class=cl>    when: <span class=s2>&#34;&#39;va&#39; in a&#34;</span>
</span></span></code></pre></td></tr></table></div></div></div><ul><li>运算符处理字符</li></ul><div class=highlight><div class=chroma><div class=table-container><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-yaml data-lang=yaml><span class=line><span class=cl><span class=c># 使用加号&#34;+&#34;连接两个字符串</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span>- <span class=nt>hosts</span><span class=p>:</span><span class=w> </span><span class=l>me</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>gather_facts</span><span class=p>:</span><span class=w> </span><span class=kc>no</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>vars</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>a</span><span class=p>:</span><span class=w> </span><span class=s2>&#34;vaA12345&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>b</span><span class=p>:</span><span class=w> </span><span class=s2>&#34;vbB67890&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>tasks</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span>- <span class=nt>debug</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>msg</span><span class=p>:</span><span class=w> </span><span class=s2>&#34;{{a+b}}&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=c># 使用乘号&#34;*&#34;连续的重复输出字符串</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span>- <span class=nt>hosts</span><span class=p>:</span><span class=w> </span><span class=l>me</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>gather_facts</span><span class=p>:</span><span class=w> </span><span class=kc>no</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>vars</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>a</span><span class=p>:</span><span class=w> </span><span class=s2>&#34;vaA12345&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>tasks</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span>- <span class=nt>debug</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>msg</span><span class=p>:</span><span class=w> </span><span class=s2>&#34;{{a*3}}&#34;</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div></div><ul><li>使用find查找字符串中字符位置</li></ul><div class=highlight><div class=chroma><div class=table-container><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-yaml data-lang=yaml><span class=line><span class=cl>- <span class=nt>hosts</span><span class=p>:</span><span class=w> </span><span class=l>me</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>gather_facts</span><span class=p>:</span><span class=w> </span><span class=kc>no</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>vars</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>a</span><span class=p>:</span><span class=w> </span><span class=s2>&#34;vaA12345&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>tasks</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span>- <span class=nt>debug</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>msg</span><span class=p>:</span><span class=w> </span><span class=s2>&#34;{{a.find(&#39;A1&#39;)}}&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=c># 输出如下:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=l>TASK [debug] xxxxxxxxxxxxxxxxxxxxx</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>ok</span><span class=p>:</span><span class=w> </span><span class=p>[</span><span class=l>me] =&gt; {</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>&#34;msg&#34;: </span><span class=s2>&#34;2&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span>}<span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=c># 用作条件判断</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span>- <span class=nt>hosts</span><span class=p>:</span><span class=w> </span><span class=l>me</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>gather_facts</span><span class=p>:</span><span class=w> </span><span class=kc>no</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>vars</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>a</span><span class=p>:</span><span class=w> </span><span class=s2>&#34;vaA12345&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>tasks</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span>- <span class=nt>debug</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>msg</span><span class=p>:</span><span class=w> </span><span class=s2>&#34;not found&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>when</span><span class=p>:</span><span class=w> </span><span class=l>a.find(&#39;A2&#39;) == -1</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div></div><p>2,指定任务在某个节点上运行</p><ul><li>通过"delegate_to"关键字,可以指定某个任务在特定的主机上执行,这个特定的主机可以是目标主机中的某一个,也可以不是目标主机中的任何一个</li></ul><div class=highlight><div class=chroma><div class=table-container><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-yaml data-lang=yaml><span class=line><span class=cl>- <span class=nt>hosts</span><span class=p>:</span><span class=w> </span><span class=l>node2,me</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>gather_facts</span><span class=p>:</span><span class=w> </span><span class=kc>no</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>tasks</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span>- <span class=nt>file</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>path</span><span class=p>:</span><span class=w> </span><span class=s2>&#34;/tmp/ttt&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>state</span><span class=p>:</span><span class=w> </span><span class=l>touch</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w> 
</span></span></span><span class=line><span class=cl><span class=w>  </span>- <span class=nt>file</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>path</span><span class=p>:</span><span class=w> </span><span class=s2>&#34;/tmp/delegate&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>state</span><span class=p>:</span><span class=w> </span><span class=l>touch</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>delegate_to</span><span class=p>:</span><span class=w> </span><span class=l>node3</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w> 
</span></span></span><span class=line><span class=cl><span class=w>  </span>- <span class=nt>file</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>path</span><span class=p>:</span><span class=w> </span><span class=s2>&#34;/tmp/ttt1&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>state</span><span class=p>:</span><span class=w> </span><span class=l>touch</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div></div><p>3,让某个人物在ansible主机上执行,不在目标主机上执行</p><ul><li>有两种方式,如下示例:</li></ul><div class=highlight><div class=chroma><div class=table-container><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-yaml data-lang=yaml><span class=line><span class=cl><span class=c>## delegate_to</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span>- <span class=nt>hosts</span><span class=p>:</span><span class=w> </span><span class=l>node2,node3</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>gather_facts</span><span class=p>:</span><span class=w> </span><span class=kc>no</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>tasks</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span>- <span class=nt>file</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>path</span><span class=p>:</span><span class=w> </span><span class=s2>&#34;/tmp/inAnsible&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>state</span><span class=p>:</span><span class=w> </span><span class=l>touch</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>delegate_to</span><span class=p>:</span><span class=w> </span><span class=l>local</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w> 
</span></span></span><span class=line><span class=cl><span class=w>  </span>- <span class=nt>file</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>path</span><span class=p>:</span><span class=w> </span><span class=s2>&#34;/tmp/test&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>state</span><span class=p>:</span><span class=w> </span><span class=l>touch</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=c>## connection: local</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span>- <span class=nt>hosts</span><span class=p>:</span><span class=w> </span><span class=l>node2,node3</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>gather_facts</span><span class=p>:</span><span class=w> </span><span class=kc>no</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>tasks</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span>- <span class=nt>file</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>path</span><span class=p>:</span><span class=w> </span><span class=s2>&#34;/tmp/inAnsible&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>state</span><span class=p>:</span><span class=w> </span><span class=l>touch</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>connection</span><span class=p>:</span><span class=w> </span><span class=l>local</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w> 
</span></span></span><span class=line><span class=cl><span class=w>  </span>- <span class=nt>file</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>path</span><span class=p>:</span><span class=w> </span><span class=s2>&#34;/tmp/test&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>state</span><span class=p>:</span><span class=w> </span><span class=l>touch</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div></div><p>4,只跑一次的任务</p><ul><li>从网站上下载包,但目标主机共有5台</li></ul><div class=highlight><div class=chroma><div class=table-container><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-yaml data-lang=yaml><span class=line><span class=cl>- <span class=nt>hosts</span><span class=p>:</span><span class=w> </span><span class=l>A,B,C,D,E</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>gather_facts</span><span class=p>:</span><span class=w> </span><span class=kc>no</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>tasks</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span>- <span class=nt>get_url</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>url</span><span class=p>:</span><span class=w> </span><span class=s2>&#34;http://nexus.zsythink.net/repository/testraw/testfile/test.tar&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>dest</span><span class=p>:</span><span class=w> </span><span class=l>/tmp/</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=c># 结合本机执行一起使用</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>connection</span><span class=p>:</span><span class=w> </span><span class=l>local</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>run_once</span><span class=p>:</span><span class=w> </span><span class=kc>true</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w> 
</span></span></span><span class=line><span class=cl><span class=w>  </span>- <span class=nt>copy</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>src</span><span class=p>:</span><span class=w> </span><span class=s2>&#34;/tmp/test.tar&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>dest</span><span class=p>:</span><span class=w> </span><span class=s2>&#34;/tmp&#34;</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div></div><h2 id=常用技巧二><a href=#常用技巧二 class=anchor-link><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512" class="icon anchor-icon"><path d="M326.612 185.391c59.747 59.809 58.927 155.698.36 214.59-.11.12-.24.25-.36.37l-67.2 67.2c-59.27 59.27-155.699 59.262-214.96.0-59.27-59.26-59.27-155.7.0-214.96l37.106-37.106c9.84-9.84 26.786-3.3 27.294 10.606.648 17.722 3.826 35.527 9.69 52.721 1.986 5.822.567 12.262-3.783 16.612l-13.087 13.087c-28.026 28.026-28.905 73.66-1.155 101.96 28.024 28.579 74.086 28.749 102.325.51l67.2-67.19c28.191-28.191 28.073-73.757.0-101.83-3.701-3.694-7.429-6.564-10.341-8.569a16.037 16.037.0 01-6.947-12.606c-.396-10.567 3.348-21.456 11.698-29.806l21.054-21.055c5.521-5.521 14.182-6.199 20.584-1.731a152.482 152.482.0 0120.522 17.197zM467.547 44.449c-59.261-59.262-155.69-59.27-214.96.0l-67.2 67.2c-.12.12-.25.25-.36.37-58.566 58.892-59.387 154.781.36 214.59a152.454 152.454.0 0020.521 17.196c6.402 4.468 15.064 3.789 20.584-1.731l21.054-21.055c8.35-8.35 12.094-19.239 11.698-29.806a16.037 16.037.0 00-6.947-12.606c-2.912-2.005-6.64-4.875-10.341-8.569-28.073-28.073-28.191-73.639.0-101.83l67.2-67.19c28.239-28.239 74.3-28.069 102.325.51 27.75 28.3 26.872 73.934-1.155 101.96l-13.087 13.087c-4.35 4.35-5.769 10.79-3.783 16.612 5.864 17.194 9.042 34.999 9.69 52.721.509 13.906 17.454 20.446 27.294 10.606l37.106-37.106c59.271-59.259 59.271-155.699.001-214.959z"/></svg></a><a href=#contents:常用技巧二 class=headings>#常用技巧(二)</a></h2><p>1,向列表中追加项</p><ul><li>如下内容:</li></ul><div class=highlight><div class=chroma><div class=table-container><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span><span class=lnt>32
</span><span class=lnt>33
</span><span class=lnt>34
</span><span class=lnt>35
</span><span class=lnt>36
</span><span class=lnt>37
</span><span class=lnt>38
</span><span class=lnt>39
</span><span class=lnt>40
</span><span class=lnt>41
</span><span class=lnt>42
</span><span class=lnt>43
</span><span class=lnt>44
</span><span class=lnt>45
</span><span class=lnt>46
</span><span class=lnt>47
</span><span class=lnt>48
</span><span class=lnt>49
</span><span class=lnt>50
</span><span class=lnt>51
</span><span class=lnt>52
</span><span class=lnt>53
</span><span class=lnt>54
</span><span class=lnt>55
</span><span class=lnt>56
</span><span class=lnt>57
</span><span class=lnt>58
</span><span class=lnt>59
</span><span class=lnt>60
</span><span class=lnt>61
</span><span class=lnt>62
</span><span class=lnt>63
</span><span class=lnt>64
</span><span class=lnt>65
</span><span class=lnt>66
</span><span class=lnt>67
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-yaml data-lang=yaml><span class=line><span class=cl>- <span class=nt>hosts</span><span class=p>:</span><span class=w> </span><span class=l>me</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>gather_facts</span><span class=p>:</span><span class=w> </span><span class=kc>no</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>vars</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>   </span><span class=nt>l1</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>     </span>- <span class=m>1</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>     </span>- <span class=m>2</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>   </span><span class=nt>l2</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>     </span>- <span class=l>a</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>     </span>- <span class=l>b</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>     </span>- <span class=m>2</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>tasks</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span>- <span class=nt>set_fact</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>l3</span><span class=p>:</span><span class=w> </span><span class=s2>&#34;{{ l1 + l2 }}&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span>- <span class=nt>debug</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>var</span><span class=p>:</span><span class=w> </span><span class=l>l3</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=c># 直接列表相加</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span>- <span class=nt>hosts</span><span class=p>:</span><span class=w> </span><span class=l>me</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>gather_facts</span><span class=p>:</span><span class=w> </span><span class=kc>no</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>vars</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>   </span><span class=nt>tlist</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>     </span>- <span class=m>1</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>     </span>- <span class=m>2</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>tasks</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span>- <span class=nt>set_fact</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>tlist</span><span class=p>:</span><span class=w> </span><span class=s2>&#34;{{ tlist + [&#39;a&#39;] }}&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span>- <span class=nt>debug</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>var</span><span class=p>:</span><span class=w> </span><span class=l>tlist</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=c># jinja2的语法,完成上述追加元素的过程</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span>- <span class=nt>hosts</span><span class=p>:</span><span class=w> </span><span class=l>me</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>gather_facts</span><span class=p>:</span><span class=w> </span><span class=kc>no</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>vars</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>   </span><span class=nt>tlist</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>     </span>- <span class=m>1</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>     </span>- <span class=m>2</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>tasks</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span>- <span class=nt>set_fact</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>tlist</span><span class=p>:</span><span class=w> </span><span class=s2>&#34;{% set tlist = tlist + [&#39;a&#39;] %}{{tlist}}&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span>- <span class=nt>debug</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>var</span><span class=p>:</span><span class=w> </span><span class=l>tlist</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=c># 使用extend()追加</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span>- <span class=nt>hosts</span><span class=p>:</span><span class=w> </span><span class=l>me</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>gather_facts</span><span class=p>:</span><span class=w> </span><span class=kc>no</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>vars</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>   </span><span class=nt>tlist</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>     </span>- <span class=m>1</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>     </span>- <span class=m>2</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>tasks</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span>- <span class=nt>set_fact</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>tlist</span><span class=p>:</span><span class=w> </span><span class=s2>&#34;{% set tlist = tlist + [&#39;a&#39;] %}{{tlist}}&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span>- <span class=nt>debug</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>var</span><span class=p>:</span><span class=w> </span><span class=l>tlist</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=c># append追加</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span>- <span class=nt>hosts</span><span class=p>:</span><span class=w> </span><span class=l>me</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>gather_facts</span><span class=p>:</span><span class=w> </span><span class=kc>no</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>vars</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>   </span><span class=nt>tlist</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>     </span>- <span class=m>1</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>     </span>- <span class=m>2</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>tasks</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span>- <span class=nt>set_fact</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>tlist</span><span class=p>:</span><span class=w> </span><span class=s2>&#34;{{ tlist.append(&#39;a&#39;) }}{{tlist}}&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span>- <span class=nt>debug</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>var</span><span class=p>:</span><span class=w> </span><span class=l>tlist</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div></div><p>2, 在列表中插入项</p><ul><li>如下示例:</li></ul><div class=highlight><div class=chroma><div class=table-container><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-yaml data-lang=yaml><span class=line><span class=cl><span class=c># 使用insert()</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span>- <span class=nt>hosts</span><span class=p>:</span><span class=w> </span><span class=l>me</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>gather_facts</span><span class=p>:</span><span class=w> </span><span class=kc>no</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>vars</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>   </span><span class=nt>tlist</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>     </span>- <span class=m>11</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>     </span>- <span class=m>2</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>     </span>- <span class=m>11</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>tasks</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span>- <span class=nt>set_fact</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>tlist</span><span class=p>:</span><span class=w> </span><span class=s2>&#34;{{ tlist.insert(1,&#39;a&#39;) }}{{tlist}}&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span>- <span class=nt>debug</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>var</span><span class=p>:</span><span class=w> </span><span class=l>tlist</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div></div><p>3, 在列表中删除项</p><ul><li>如下示例:</li></ul><div class=highlight><div class=chroma><div class=table-container><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span><span class=lnt>32
</span><span class=lnt>33
</span><span class=lnt>34
</span><span class=lnt>35
</span><span class=lnt>36
</span><span class=lnt>37
</span><span class=lnt>38
</span><span class=lnt>39
</span><span class=lnt>40
</span><span class=lnt>41
</span><span class=lnt>42
</span><span class=lnt>43
</span><span class=lnt>44
</span><span class=lnt>45
</span><span class=lnt>46
</span><span class=lnt>47
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-yaml data-lang=yaml><span class=line><span class=cl><span class=c># 使用pop</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span>- <span class=nt>hosts</span><span class=p>:</span><span class=w> </span><span class=l>me</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>gather_facts</span><span class=p>:</span><span class=w> </span><span class=kc>no</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>vars</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>   </span><span class=nt>tlist</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>     </span>- <span class=m>11</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>     </span>- <span class=m>2</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>     </span>- <span class=s1>&#39;a&#39;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>     </span>- <span class=s1>&#39;b&#39;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>     </span>- <span class=m>3</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>tasks</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span>- <span class=nt>debug</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>msg</span><span class=p>:</span><span class=w> </span><span class=s2>&#34;{{tlist.pop(2)}}&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=c># 使用remove()</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span>- <span class=nt>hosts</span><span class=p>:</span><span class=w> </span><span class=l>me</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>gather_facts</span><span class=p>:</span><span class=w> </span><span class=kc>no</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>vars</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>   </span><span class=nt>tlist</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>     </span>- <span class=m>11</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>     </span>- <span class=s1>&#39;b&#39;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>     </span>- <span class=s1>&#39;a&#39;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>     </span>- <span class=s1>&#39;b&#39;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>     </span>- <span class=m>3</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>tasks</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span>- <span class=nt>set_fact</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>tlist</span><span class=p>:</span><span class=w> </span><span class=s2>&#34;{{ tlist.remove(&#39;b&#39;) }}{{tlist}}&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span>- <span class=nt>debug</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>var</span><span class=p>:</span><span class=w> </span><span class=l>tlist</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=c># for循环匹配删除</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span>- <span class=nt>hosts</span><span class=p>:</span><span class=w> </span><span class=l>me</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>gather_facts</span><span class=p>:</span><span class=w> </span><span class=kc>no</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>vars</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>tlist</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span>- <span class=m>11</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span>- <span class=s1>&#39;b&#39;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span>- <span class=s1>&#39;a&#39;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span>- <span class=s1>&#39;b&#39;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span>- <span class=m>11</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span>- <span class=s1>&#39;a11&#39;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span>- <span class=s1>&#39;1a&#39;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span>- <span class=s1>&#39;11&#39;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>tasks</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span>- <span class=nt>set_fact</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>tlist</span><span class=p>:</span><span class=w> </span><span class=s2>&#34;{%for i in tlist%}{% if 11 in tlist%}{{tlist.remove(11)}}{%endif%}{%endfor%}{{tlist}}&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span>- <span class=nt>debug</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>var</span><span class=p>:</span><span class=w> </span><span class=l>tlist</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div></div></div><ul class=post-copyright><li class="copyright-item author"><span class=copyright-item-text>作者</span>：<a href=https://ruisum.top class="p-author h-card" target=_blank rel=noopener>newiur</a></li><li class="copyright-item link"><span class=copyright-item-text>链接</span>：<a href=/tech/ops/ansible%E5%AD%A6%E4%B9%A0/ target=_blank rel=noopener>https://ruisum.top/tech/ops/ansible学习/</a></li><li class="copyright-item license"><span class=copyright-item-text>许可</span>：<a href=https://creativecommons.org/licenses/by-nc-sa/4.0/deed.zh target=_blank rel=noopener>CC BY-NC-SA 4.0</a></li></ul></article><div class=updated-badge-container><span title="Updated @ 2022-03-31 23:38:04 CST" style=cursor:help><svg xmlns="http://www.w3.org/2000/svg" width="130" height="20" class="updated-badge"><linearGradient id="b" x2="0" y2="100%"><stop offset="0" stop-color="#bbb" stop-opacity=".1"/><stop offset="1" stop-opacity=".1"/></linearGradient><clipPath id="a"><rect width="130" height="20" rx="3" fill="#fff"/></clipPath><g clip-path="url(#a)"><path class="updated-badge-left" d="M0 0h55v20H0z"/><path class="updated-badge-right" d="M55 0h75v20H55z"/><path fill="url(#b)" d="M0 0h130v20H0z"/></g><g fill="#fff" text-anchor="middle" font-size="110"><text x="285" y="150" fill="#010101" fill-opacity=".3" textLength="450" transform="scale(.1)">updated</text><text x="285" y="140" textLength="450" transform="scale(.1)">updated</text><text x="915" y="150" fill="#010101" fill-opacity=".3" textLength="650" transform="scale(.1)">2022-03-31</text><text x="915" y="140" textLength="650" transform="scale(.1)">2022-03-31</text></g></svg></span></div><div class=post-tags><a href=/tags/ansible/ rel=tag class=post-tags-link><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512" class="icon tag-icon"><path d="M0 252.118V48C0 21.49 21.49.0 48 0h204.118a48 48 0 0133.941 14.059l211.882 211.882c18.745 18.745 18.745 49.137.0 67.882L293.823 497.941c-18.745 18.745-49.137 18.745-67.882.0L14.059 286.059A48 48 0 010 252.118zM112 64c-26.51.0-48 21.49-48 48s21.49 48 48 48 48-21.49 48-48-21.49-48-48-48z"/></svg>ansible</a>
<a href=/tags/ops/ rel=tag class=post-tags-link><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512" class="icon tag-icon"><path d="M0 252.118V48C0 21.49 21.49.0 48 0h204.118a48 48 0 0133.941 14.059l211.882 211.882c18.745 18.745 18.745 49.137.0 67.882L293.823 497.941c-18.745 18.745-49.137 18.745-67.882.0L14.059 286.059A48 48 0 010 252.118zM112 64c-26.51.0-48 21.49-48 48s21.49 48 48 48 48-21.49 48-48-21.49-48-48-48z"/></svg>ops</a></div><ul class=post-nav><li class=post-nav-prev><a href=/tech/cloud/docker%E5%AD%A6%E4%B9%A0/ rel=prev>&lt; docker学习</a></li><li class=post-nav-next><a href=/tech/basics/bash%E5%AD%A6%E4%B9%A0/ rel=next>learning bash via abs ></a></li></ul><div class=load-comments><div id=load-comments>加载评论</div></div><div id=vcomments></div></div></main><div id=back-to-top class=back-to-top><a href=#><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512" class="icon arrow-up"><path d="M34.9 289.5l-22.2-22.2c-9.4-9.4-9.4-24.6.0-33.9L207 39c9.4-9.4 24.6-9.4 33.9.0l194.3 194.3c9.4 9.4 9.4 24.6.0 33.9L413 289.4c-9.5 9.5-25 9.3-34.3-.4L264 168.6V456c0 13.3-10.7 24-24 24h-32c-13.3.0-24-10.7-24-24V168.6L69.2 289.1c-9.3 9.8-24.8 10-34.3.4z"/></svg></a></div><footer id=footer class=footer><div class=footer-inner><div class=site-info>©&nbsp;2022–2022&nbsp;<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512" class="icon footer-icon"><path d="M462.3 62.6C407.5 15.9 326 24.3 275.7 76.2L256 96.5l-19.7-20.3C186.1 24.3 104.5 15.9 49.7 62.6c-62.8 53.6-66.1 149.8-9.9 207.9l193.5 199.8c12.5 12.9 32.8 12.9 45.3.0l193.5-199.8c56.3-58.1 53-154.3-9.8-207.9z"/></svg>&nbsp;newiur</div><div class=busuanzi-site-uv-and-pv><span id=busuanzi_container_site_uv>本站访客数&nbsp;<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512" class="icon busuanzi-site-uv"><path d="M224 256c70.7.0 128-57.3 128-128S294.7.0 224 0 96 57.3 96 128s57.3 128 128 128zm89.6 32h-16.7c-22.2 10.2-46.9 16-72.9 16s-50.6-5.8-72.9-16h-16.7C60.2 288 0 348.2.0 422.4V464c0 26.5 21.5 48 48 48h352c26.5.0 48-21.5 48-48v-41.6c0-74.2-60.2-134.4-134.4-134.4z"/></svg>&nbsp;<span id=busuanzi_value_site_uv></span></span>&nbsp;|&nbsp;<span id=busuanzi_container_site_pv>本站访问量&nbsp;<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 576 512" class="icon busuanzi-site-pv"><path d="M288 144a110.94 110.94.0 00-31.24 5 55.4 55.4.0 017.24 27 56 56 0 01-56 56 55.4 55.4.0 01-27-7.24A111.71 111.71.0 10288 144zm284.52 97.4C518.29 135.59 410.93 64 288 64S57.68 135.64 3.48 241.41a32.35 32.35.0 000 29.19C57.71 376.41 165.07 448 288 448s230.32-71.64 284.52-177.41a32.35 32.35.0 000-29.19zM288 4e2c-98.65.0-189.09-55-237.93-144C98.91 167 189.34 112 288 112s189.09 55 237.93 144C477.1 345 386.66 4e2 288 4e2z"/></svg>&nbsp;<span id=busuanzi_value_site_pv></span></span></div><script src=https://sdk.jinrishici.com/v2/browser/jinrishici.js></script>
<text class=poem_sentence></text>
<text class=poem_info></text>
<script type=text/javascript>jinrishici.load(function(e){var t=document.querySelector(".poem_sentence"),n=document.querySelector(".poem_info");t.innerHTML=e.data.content,n.innerHTML="—  "+e.data.origin.title})</script></div></footer></div><script>function loadComments(){if(typeof Valine=="undefined"){var e=t=>{var e=document.createElement("script");e.defer=!0,e.crossOrigin="anonymous",Object.keys(t).forEach(n=>{e[n]=t[n]}),document.body.appendChild(e)};e({src:"https://cdn.jsdelivr.net/npm/valine@1.4.14/dist/Valine.min.js",onload:()=>{newValine()}})}else newValine()}function newValine(){new Valine({el:"#vcomments",appId:"vcDuMPUhVRWqDQ1hhpoM0FkX-gzGzoHsz",appKey:"BuTIa6PLYnI1Po1eBldfdcT1",placeholder:"Just go go",path:location.pathname,avatar:"mm",meta:["nick","mail","link"],pageSize:10,lang:"zh-cn",visitor:!1,highlight:!0,avatarForce:!1,recordIP:!0,serverURLs:'',emojiCDN:'',emojiMaps:{},enableQQ:!1,requiredFields:[]})}</script><script src=https://cdn.jsdelivr.net/npm/medium-zoom@latest/dist/medium-zoom.min.js></script>
<script>let imgNodes=document.querySelectorAll("div.post-body img");imgNodes=Array.from(imgNodes).filter(e=>e.parentNode.tagName!=="A"),mediumZoom(imgNodes,{background:"hsla(var(--color-bg-h), var(--color-bg-s), var(--color-bg-l), 0.95)"})</script><script src=https://cdn.jsdelivr.net/npm/instant.page@5.1.0/instantpage.min.js type=module defer></script>
<script async src=https://busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js></script></body></html>