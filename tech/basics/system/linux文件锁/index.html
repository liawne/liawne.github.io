<!doctype html><html lang=zh-cn><head prefix="og: http://ogp.me/ns# article: http://ogp.me/ns/article#"><meta charset=utf-8><meta name=generator content="Hugo 0.99.1"><meta name=theme-color content="#fff"><meta name=color-scheme content="light dark"><meta name=viewport content="width=device-width,initial-scale=1"><meta name=format-detection content="telephone=no, date=no, address=no, email=no"><meta http-equiv=cache-control content="no-transform"><meta http-equiv=cache-control content="no-siteapp"><title>linux 文件锁 | newiur</title><link rel=stylesheet href=/css/meme.min.css><script src=/js/meme.min.js></script>
<link rel=preconnect href=https://fonts.gstatic.com crossorigin><link rel=stylesheet href="https://fonts.googleapis.com/css2?family=Source+Code+Pro:wght@0,400;0,500;0,700;1,400;1,700&family=Noto+Serif+SC:wght@400;500;700&family=Source+Code+Pro:ital,wght@0,400;0,700;1,400;1,700&display=swap" media=print onload='this.media="all"'><noscript><link rel=stylesheet href="https://fonts.googleapis.com/css2?family=Source+Code+Pro:wght@0,400;0,500;0,700;1,400;1,700&family=Noto+Serif+SC:wght@400;500;700&family=Source+Code+Pro:ital,wght@0,400;0,700;1,400;1,700&display=swap"></noscript><meta name=author content="newiur"><meta name=description content="linux系统中的锁机制，以及flock命令和flock系统调用的说明"><link rel="shortcut icon" href=/favicon.ico type=image/x-icon><link rel=mask-icon href=/icons/safari-pinned-tab.svg color=#2a6df4><link rel=apple-touch-icon sizes=180x180 href=/icons/apple-touch-icon.png><meta name=apple-mobile-web-app-capable content="yes"><meta name=apple-mobile-web-app-title content="newiur"><meta name=apple-mobile-web-app-status-bar-style content="black"><meta name=mobile-web-app-capable content="yes"><meta name=application-name content="newiur"><meta name=msapplication-starturl content="../../../../"><meta name=msapplication-TileColor content="#fff"><meta name=msapplication-TileImage content="../../../../icons/mstile-150x150.png"><link rel=manifest href=/manifest.json><link rel=canonical href=https://ruisum.top/tech/basics/system/linux%E6%96%87%E4%BB%B6%E9%94%81/><script type=application/ld+json>{"@context":"https://schema.org","@type":"BlogPosting","datePublished":"2022-06-15T22:53:59+08:00","dateModified":"2022-06-15T22:53:59+08:00","url":"https://ruisum.top/tech/basics/system/linux%E6%96%87%E4%BB%B6%E9%94%81/","headline":"linux 文件锁","description":"linux系统中的锁机制，以及flock命令和flock系统调用的说明","inLanguage":"zh-CN","articleSection":"tech","wordCount":4798,"image":["https://ruisum.oss-cn-shenzhen.aliyuncs.com/img/2022/06/20220619-1538.gif","https://ruisum.oss-cn-shenzhen.aliyuncs.com/img/2022/06/20220619-1547.gif"],"author":{"@type":"Person","description":"just go go","email":"rwen913@gmail.com","image":"https://ruisum.top/icons/apple-touch-icon.png","url":"https://ruisum.top","name":"newiur"},"license":"[CC BY-NC-SA 4.0](https://creativecommons.org/licenses/by-nc-sa/4.0/deed.zh)","publisher":{"@type":"Organization","name":"newiur","logo":{"@type":"ImageObject","url":"https://ruisum.top/icons/apple-touch-icon.png"},"url":"https://ruisum.top/"},"mainEntityOfPage":{"@type":"WebSite","@id":"https://ruisum.top/"}}</script><meta name=twitter:card content="summary_large_image"><meta property="og:title" content="linux 文件锁"><meta property="og:description" content="linux系统中的锁机制，以及flock命令和flock系统调用的说明"><meta property="og:url" content="https://ruisum.top/tech/basics/system/linux%E6%96%87%E4%BB%B6%E9%94%81/"><meta property="og:site_name" content="newiur"><meta property="og:locale" content="zh"><meta property="og:image" content="https://ruisum.oss-cn-shenzhen.aliyuncs.com/img/2022/06/20220619-1538.gif"><meta property="og:type" content="article"><meta property="article:published_time" content="2022-06-15T22:53:59+08:00"><meta property="article:modified_time" content="2022-06-15T22:53:59+08:00"><meta property="article:section" content="tech"><link rel=stylesheet href="https://fonts.googleapis.com/css2?family=ZCOOL+XiaoWei&text=newiur%27sBlognewiur&display=swap" media=print onload='this.media="all"'><noscript><link rel=stylesheet href="https://fonts.googleapis.com/css2?family=ZCOOL+XiaoWei&text=newiur%27sBlognewiur&display=swap"></noscript></head><body><div class=container><header class=header><div class=header-wrapper><div class="header-inner single"><div class=site-brand><a href=/ class=brand>newiur</a></div><nav class=nav><ul class=menu id=menu><li class=menu-item><a href=/tags/><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 640 512" class="icon tags"><path d="M497.941 225.941 286.059 14.059A48 48 0 00252.118.0H48C21.49.0.0 21.49.0 48v204.118a48 48 0 0014.059 33.941l211.882 211.882c18.744 18.745 49.136 18.746 67.882.0l204.118-204.118c18.745-18.745 18.745-49.137.0-67.882zM112 160c-26.51.0-48-21.49-48-48s21.49-48 48-48 48 21.49 48 48-21.49 48-48 48zm513.941 133.823L421.823 497.941c-18.745 18.745-49.137 18.745-67.882.0l-.36-.36L527.64 323.522c16.999-16.999 26.36-39.6 26.36-63.64s-9.362-46.641-26.36-63.64L331.397.0h48.721a48 48 0 0133.941 14.059l211.882 211.882c18.745 18.745 18.745 49.137.0 67.882z"/></svg><span class=menu-item-name>标签</span></a></li><li class=menu-item><a href=/tech/><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512" class="icon tech"><path d="M512 256c0 141.2-114.7 256-256 256C114.8 512 0 397.3.0 256S114.7.0 256 0s256 114.7 256 256zm-32 0c0-123.2-100.3-224-224-224C132.5 32 32 132.5 32 256s100.5 224 224 224 224-100.5 224-224zM160.9 124.6l86.9 37.1-37.1 86.9-86.9-37.1 37.1-86.9zm110 169.1 46.6 94h-14.6l-50-1e2-48.9 1e2h-14l51.1-106.9-22.3-9.4 6-14 68.6 29.1-6 14.3-16.5-7.1zm-11.8-116.3 68.6 29.4-29.4 68.3L230 246l29.1-68.6zm80.3 42.9 54.6 23.1-23.4 54.3-54.3-23.1 23.1-54.3z"/></svg><span class=menu-item-name>技术</span></a></li><li class=menu-item><a href=/life/><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512" class="icon life"><path d="M301.1 212c4.4 4.4 4.4 11.9.0 16.3l-9.7 9.7c-4.4 4.7-11.9 4.7-16.6.0l-10.5-10.5c-4.4-4.7-4.4-11.9.0-16.6l9.7-9.7c4.4-4.4 11.9-4.4 16.6.0l10.5 10.8zm-30.2-19.7c3-3 3-7.8.0-10.5-2.8-3-7.5-3-10.5.0-2.8 2.8-2.8 7.5.0 10.5 3.1 2.8 7.8 2.8 10.5.0zm-26 5.3c-3 2.8-3 7.5.0 10.2 2.8 3 7.5 3 10.5.0 2.8-2.8 2.8-7.5.0-10.2-3-3-7.7-3-10.5.0zm72.5-13.3c-19.9-14.4-33.8-43.2-11.9-68.1 21.6-24.9 40.7-17.2 59.8.8 11.9 11.3 29.3 24.9 17.2 48.2-12.5 23.5-45.1 33.2-65.1 19.1zm47.7-44.5c-8.9-10-23.3 6.9-15.5 16.1 7.4 9 32.1 2.4 15.5-16.1zM504 256c0 137-111 248-248 248S8 393 8 256 119 8 256 8s248 111 248 248zm-66.2 42.6c2.5-16.1-20.2-16.6-25.2-25.7-13.6-24.1-27.7-36.8-54.5-30.4 11.6-8 23.5-6.1 23.5-6.1.3-6.4.0-13-9.4-24.9 3.9-12.5.3-22.4.3-22.4 15.5-8.6 26.8-24.4 29.1-43.2 3.6-31-18.8-59.2-49.8-62.8-22.1-2.5-43.7 7.7-54.3 25.7-23.2 40.1 1.4 70.9 22.4 81.4-14.4-1.4-34.3-11.9-40.1-34.3-6.6-25.7 2.8-49.8 8.9-61.4.0.0-4.4-5.8-8-8.9.0.0-13.8.0-24.6 5.3 11.9-15.2 25.2-14.4 25.2-14.4.0-6.4-.6-14.9-3.6-21.6-5.4-11-23.8-12.9-31.7 2.8.1-.2.3-.4.4-.5-5 11.9-1.1 55.9 16.9 87.2-2.5 1.4-9.1 6.1-13 10-21.6 9.7-56.2 60.3-56.2 60.3-28.2 10.8-77.2 50.9-70.6 79.7.3 3 1.4 5.5 3 7.5-2.8 2.2-5.5 5-8.3 8.3-11.9 13.8-5.3 35.2 17.7 24.4 15.8-7.2 29.6-20.2 36.3-30.4.0.0-5.5-5-16.3-4.4 27.7-6.6 34.3-9.4 46.2-9.1 8 3.9 8-34.3 8-34.3.0-14.7-2.2-31-11.1-41.5 12.5 12.2 29.1 32.7 28 60.6-.8 18.3-15.2 23-15.2 23-9.1 16.6-43.2 65.9-30.4 106 0 0-9.7-14.9-10.2-22.1-17.4 19.4-46.5 52.3-24.6 64.5 26.6 14.7 108.8-88.6 126.2-142.3 34.6-20.8 55.4-47.3 63.9-65 22 43.5 95.3 94.5 101.1 59z"/></svg><span class=menu-item-name>随笔</span></a></li><li class=menu-item><a href=/about/><span class=menu-item-name>关于</span></a></li><li class=menu-item><a id=theme-switcher href=#><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512" class="icon theme-icon-light"><path d="M193.2 104.5 242 7a18 18 0 0128 0l48.8 97.5L422.2 70A18 18 0 01442 89.8l-34.5 103.4L505 242a18 18 0 010 28l-97.5 48.8L442 422.2A18 18 0 01422.2 442l-103.4-34.5L270 505a18 18 0 01-28 0l-48.8-97.5L89.8 442A18 18 0 0170 422.2l34.5-103.4-97.5-48.8a18 18 0 010-28l97.5-48.8L70 89.8A18 18 0 0189.8 70zM256 128a128 128 0 10.01.0M256 160a96 96 0 10.01.0"/></svg><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512" class="icon theme-icon-dark"><path d="M27 412A256 256 0 10181 5a11.5 11.5.0 00-5 20A201.5 201.5.0 0142 399a11.5 11.5.0 00-15 13"/></svg></a></li></ul></nav></div></div><input type=checkbox id=nav-toggle aria-hidden=true>
<label for=nav-toggle class=nav-toggle></label>
<label for=nav-toggle class=nav-curtain></label></header><main class="main single" id=main><div class=main-inner><article class="content post h-entry" data-align=justify data-type=tech data-toc-num=true><h1 class="post-title p-name">linux 文件锁</h1><div class="post-description p-summary">linux系统中的锁机制，以及flock命令和flock系统调用的说明</div><div class=post-meta><time datetime=2022-06-15T22:53:59+08:00 class="post-meta-item modified dt-updated"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512" class="icon post-meta-icon"><path d="M4e2 64h-48V12c0-6.627-5.373-12-12-12h-40c-6.627.0-12 5.373-12 12v52H160V12c0-6.627-5.373-12-12-12h-40c-6.627.0-12 5.373-12 12v52H48C21.49 64 0 85.49.0 112v352c0 26.51 21.49 48 48 48h352c26.51.0 48-21.49 48-48V112c0-26.51-21.49-48-48-48zm-6 4e2H54a6 6 0 01-6-6V160h352v298a6 6 0 01-6 6zm-52.849-200.65L198.842 404.519c-4.705 4.667-12.303 4.637-16.971-.068l-75.091-75.699c-4.667-4.705-4.637-12.303.068-16.971l22.719-22.536c4.705-4.667 12.303-4.637 16.97.069l44.104 44.461 111.072-110.181c4.705-4.667 12.303-4.637 16.971.068l22.536 22.718c4.667 4.705 4.636 12.303-.069 16.97z"/></svg>&nbsp;2022.6.15</time>
<span class="post-meta-item category"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512" class="icon post-meta-icon"><path d="M464 128H272l-54.63-54.63c-6-6-14.14-9.37-22.63-9.37H48C21.49 64 0 85.49.0 112v288c0 26.51 21.49 48 48 48h416c26.51.0 48-21.49 48-48V176c0-26.51-21.49-48-48-48zm0 272H48V112h140.12l54.63 54.63c6 6 14.14 9.37 22.63 9.37H464v224z"/></svg>&nbsp;<a href=/tech/ class="category-link p-category">技术</a>/<a href=/tech/basics/ class="category-link p-category">基础</a>/<a href=/tech/basics/system/ class="category-link p-category">操作系统</a></span>
<span class="post-meta-item wordcount"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512" class="icon post-meta-icon"><path d="M497.9 142.1l-46.1 46.1c-4.7 4.7-12.3 4.7-17 0l-111-111c-4.7-4.7-4.7-12.3.0-17l46.1-46.1c18.7-18.7 49.1-18.7 67.9.0l60.1 60.1c18.8 18.7 18.8 49.1.0 67.9zM284.2 99.8 21.6 362.4.4 483.9c-2.9 16.4 11.4 30.6 27.8 27.8l121.5-21.3 262.6-262.6c4.7-4.7 4.7-12.3.0-17l-111-111c-4.8-4.7-12.4-4.7-17.1.0zM124.1 339.9c-5.5-5.5-5.5-14.3.0-19.8l154-154c5.5-5.5 14.3-5.5 19.8.0s5.5 14.3.0 19.8l-154 154c-5.5 5.5-14.3 5.5-19.8.0zM88 424h48v36.3l-64.5 11.3-31.1-31.1L51.7 376H88v48z"/></svg>&nbsp;4798</span>
<span class="post-meta-item reading-time"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512" class="icon post-meta-icon"><path d="M256 8C119 8 8 119 8 256s111 248 248 248 248-111 248-248S393 8 256 8zm0 448c-110.5.0-2e2-89.5-2e2-2e2S145.5 56 256 56s2e2 89.5 2e2 2e2-89.5 2e2-2e2 2e2zm61.8-104.4-84.9-61.7c-3.1-2.3-4.9-5.9-4.9-9.7V116c0-6.6 5.4-12 12-12h32c6.6.0 12 5.4 12 12v141.7l66.8 48.6c5.4 3.9 6.5 11.4 2.6 16.8L334.6 349c-3.9 5.3-11.4 6.5-16.8 2.6z"/></svg>&nbsp;10&nbsp;分钟</span>
<span class="post-meta-item busuanzi-page-pv" id=busuanzi_container_page_pv><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 576 512" class="icon post-meta-icon"><path d="M288 144a110.94 110.94.0 00-31.24 5 55.4 55.4.0 017.24 27 56 56 0 01-56 56 55.4 55.4.0 01-27-7.24A111.71 111.71.0 10288 144zm284.52 97.4C518.29 135.59 410.93 64 288 64S57.68 135.64 3.48 241.41a32.35 32.35.0 000 29.19C57.71 376.41 165.07 448 288 448s230.32-71.64 284.52-177.41a32.35 32.35.0 000-29.19zM288 4e2c-98.65.0-189.09-55-237.93-144C98.91 167 189.34 112 288 112s189.09 55 237.93 144C477.1 345 386.66 4e2 288 4e2z"/></svg>&nbsp;<span id=busuanzi_value_page_pv></span></span></div><nav class=contents><h2 id=contents class=contents-title>目录</h2><ol class=toc><li><a id=contents:-说明 href=#-说明># 说明</a><ol><li><a id=contents:-背景 href=#-背景># 背景</a></li><li><a id=contents:-中间更新问题interceding-update href=#-中间更新问题interceding-update># 中间更新问题（interceding update）</a></li></ol></li><li><a id=contents:linux-中的文件锁 href=#linux-中的文件锁>linux 中的文件锁</a><ol><li><a id=contents:-协同锁 href=#-协同锁># 协同锁</a></li><li><a id=contents:-强制锁 href=#-强制锁># 强制锁</a></li><li><a id=contents:-检查系统中的所有锁 href=#-检查系统中的所有锁># 检查系统中的所有锁</a></li></ol></li><li><a id=contents:-协同锁使用示例 href=#-协同锁使用示例># 协同锁使用示例</a><ol><li><a id=contents:-获取协同锁 href=#-获取协同锁># 获取协同锁</a></li><li><a id=contents:-非协作进程示例 href=#-非协作进程示例># 非协作进程示例</a></li><li><a id=contents:-协作进程示例 href=#-协作进程示例># 协作进程示例</a></li></ol></li><li><a id=contents:-flock-命令的使用 href=#-flock-命令的使用># flock 命令的使用</a><ol><li><a id=contents:-flock-的语法 href=#-flock-的语法># flock 的语法</a></li><li><a id=contents:-常见使用方式 href=#-常见使用方式># 常见使用方式</a></li><li><a id=contents:-flock-和-fd-的结合使用 href=#-flock-和-fd-的结合使用># flock 和 fd 的结合使用</a></li></ol></li><li><a id=contents:-flock-系统调用 href=#-flock-系统调用># flock() 系统调用</a><ol><li><a id=contents:-实现 href=#-实现># 实现</a></li><li><a id=contents:-描述 href=#-描述># 描述</a></li><li><a id=contents:-返回值和错误 href=#-返回值和错误># 返回值和错误</a></li><li><a id=contents:-其他 href=#-其他># 其他</a></li></ol></li><li><a id=contents:-其他-1 href=#-其他-1># 其他</a><ol><li><a id=contents:-参考内容 href=#-参考内容># 参考内容</a></li></ol></li></ol></nav><div class="post-body e-content"><h2 id=-说明><a href=#-说明 class=anchor-link><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512" class="icon anchor-icon"><path d="M326.612 185.391c59.747 59.809 58.927 155.698.36 214.59-.11.12-.24.25-.36.37l-67.2 67.2c-59.27 59.27-155.699 59.262-214.96.0-59.27-59.26-59.27-155.7.0-214.96l37.106-37.106c9.84-9.84 26.786-3.3 27.294 10.606.648 17.722 3.826 35.527 9.69 52.721 1.986 5.822.567 12.262-3.783 16.612l-13.087 13.087c-28.026 28.026-28.905 73.66-1.155 101.96 28.024 28.579 74.086 28.749 102.325.51l67.2-67.19c28.191-28.191 28.073-73.757.0-101.83-3.701-3.694-7.429-6.564-10.341-8.569a16.037 16.037.0 01-6.947-12.606c-.396-10.567 3.348-21.456 11.698-29.806l21.054-21.055c5.521-5.521 14.182-6.199 20.584-1.731a152.482 152.482.0 0120.522 17.197zM467.547 44.449c-59.261-59.262-155.69-59.27-214.96.0l-67.2 67.2c-.12.12-.25.25-.36.37-58.566 58.892-59.387 154.781.36 214.59a152.454 152.454.0 0020.521 17.196c6.402 4.468 15.064 3.789 20.584-1.731l21.054-21.055c8.35-8.35 12.094-19.239 11.698-29.806a16.037 16.037.0 00-6.947-12.606c-2.912-2.005-6.64-4.875-10.341-8.569-28.073-28.073-28.191-73.639.0-101.83l67.2-67.19c28.239-28.239 74.3-28.069 102.325.51 27.75 28.3 26.872 73.934-1.155 101.96l-13.087 13.087c-4.35 4.35-5.769 10.79-3.783 16.612 5.864 17.194 9.042 34.999 9.69 52.721.509 13.906 17.454 20.446 27.294 10.606l37.106-37.106c59.271-59.259 59.271-155.699.001-214.959z"/></svg></a><a href=#contents:-说明 class=headings># 说明</a></h2><h3 id=-背景><a href=#-背景 class=anchor-link><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512" class="icon anchor-icon"><path d="M326.612 185.391c59.747 59.809 58.927 155.698.36 214.59-.11.12-.24.25-.36.37l-67.2 67.2c-59.27 59.27-155.699 59.262-214.96.0-59.27-59.26-59.27-155.7.0-214.96l37.106-37.106c9.84-9.84 26.786-3.3 27.294 10.606.648 17.722 3.826 35.527 9.69 52.721 1.986 5.822.567 12.262-3.783 16.612l-13.087 13.087c-28.026 28.026-28.905 73.66-1.155 101.96 28.024 28.579 74.086 28.749 102.325.51l67.2-67.19c28.191-28.191 28.073-73.757.0-101.83-3.701-3.694-7.429-6.564-10.341-8.569a16.037 16.037.0 01-6.947-12.606c-.396-10.567 3.348-21.456 11.698-29.806l21.054-21.055c5.521-5.521 14.182-6.199 20.584-1.731a152.482 152.482.0 0120.522 17.197zM467.547 44.449c-59.261-59.262-155.69-59.27-214.96.0l-67.2 67.2c-.12.12-.25.25-.36.37-58.566 58.892-59.387 154.781.36 214.59a152.454 152.454.0 0020.521 17.196c6.402 4.468 15.064 3.789 20.584-1.731l21.054-21.055c8.35-8.35 12.094-19.239 11.698-29.806a16.037 16.037.0 00-6.947-12.606c-2.912-2.005-6.64-4.875-10.341-8.569-28.073-28.073-28.191-73.639.0-101.83l67.2-67.19c28.239-28.239 74.3-28.069 102.325.51 27.75 28.3 26.872 73.934-1.155 101.96l-13.087 13.087c-4.35 4.35-5.769 10.79-3.783 16.612 5.864 17.194 9.042 34.999 9.69 52.721.509 13.906 17.454 20.446 27.294 10.606l37.106-37.106c59.271-59.259 59.271-155.699.001-214.959z"/></svg></a><a href=#contents:-背景 class=headings># 背景</a></h3><p>在多进程共享的应用程序中，通过<code>锁</code>来对同一个计算资源进行协同管理是非常常见的做法，无论在单机或多机的系统、数据库、文件系统中，都需要依赖<code>锁</code>机制来避免并发访问导致的不确定结果。<br>文件锁是一种互斥机制，可确保多个进程以安全的方式读取/写入同一个文件。之所以要对这些多进程业务进行控制，是因为这些进程的调度是不可预期的，这种时序上的不可预期会对同一个文件资源产生竞争性访问，从而带来预期外的结果。</p><h3 id=-中间更新问题interceding-update><a href=#-中间更新问题interceding-update class=anchor-link><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512" class="icon anchor-icon"><path d="M326.612 185.391c59.747 59.809 58.927 155.698.36 214.59-.11.12-.24.25-.36.37l-67.2 67.2c-59.27 59.27-155.699 59.262-214.96.0-59.27-59.26-59.27-155.7.0-214.96l37.106-37.106c9.84-9.84 26.786-3.3 27.294 10.606.648 17.722 3.826 35.527 9.69 52.721 1.986 5.822.567 12.262-3.783 16.612l-13.087 13.087c-28.026 28.026-28.905 73.66-1.155 101.96 28.024 28.579 74.086 28.749 102.325.51l67.2-67.19c28.191-28.191 28.073-73.757.0-101.83-3.701-3.694-7.429-6.564-10.341-8.569a16.037 16.037.0 01-6.947-12.606c-.396-10.567 3.348-21.456 11.698-29.806l21.054-21.055c5.521-5.521 14.182-6.199 20.584-1.731a152.482 152.482.0 0120.522 17.197zM467.547 44.449c-59.261-59.262-155.69-59.27-214.96.0l-67.2 67.2c-.12.12-.25.25-.36.37-58.566 58.892-59.387 154.781.36 214.59a152.454 152.454.0 0020.521 17.196c6.402 4.468 15.064 3.789 20.584-1.731l21.054-21.055c8.35-8.35 12.094-19.239 11.698-29.806a16.037 16.037.0 00-6.947-12.606c-2.912-2.005-6.64-4.875-10.341-8.569-28.073-28.073-28.191-73.639.0-101.83l67.2-67.19c28.239-28.239 74.3-28.069 102.325.51 27.75 28.3 26.872 73.934-1.155 101.96l-13.087 13.087c-4.35 4.35-5.769 10.79-3.783 16.612 5.864 17.194 9.042 34.999 9.69 52.721.509 13.906 17.454 20.446 27.294 10.606l37.106-37.106c59.271-59.259 59.271-155.699.001-214.959z"/></svg></a><a href=#contents:-中间更新问题interceding-update class=headings># 中间更新问题（interceding update）</a></h3><p>中间更新是并发系统中典型的竞争条件问题。
举例说明：</p><div class=highlight><div class=chroma><div class=table-container><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-text data-lang=text><span class=line><span class=cl>假设有一个 account.dat 文件，用于存储帐户余额，其初始值为200。并发系统有两个进程来更新这个文件上的余额值：
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>进程 A : 读取当前值，减去 20，然后将结果保存回文件中。
</span></span><span class=line><span class=cl>进程 B : 读取当前值，加 80，然后将结果写回到文件中。
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>显然，在顺序执行完这两个进程后，我们期望文件具有以下值：200-20 + 80 = 260。
</span></span><span class=line><span class=cl>但是，如果进程的执行不是按预期的顺序执行，在以下这种情况下，可能会出现不一样的结果：
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>进程 A : 读取文件的当前值 200 ，并准备进行进一步的计算。
</span></span><span class=line><span class=cl>进程 B : 读取相同的文件并获得当前余额 200 。
</span></span><span class=line><span class=cl>进程 A : 计算 200-20 并将结果 180 保存回文件。
</span></span><span class=line><span class=cl>进程 B : 不知道余额已更新。因此，它仍将使用过时的值 200 计算 200 + 80，并将结果 280 写入文件。
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>结果，account.dat 文件中保存的余额就是 280 而不是预期值 260。
</span></span></code></pre></td></tr></table></div></div></div><h2 id=linux-中的文件锁><a href=#linux-中的文件锁 class=anchor-link><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512" class="icon anchor-icon"><path d="M326.612 185.391c59.747 59.809 58.927 155.698.36 214.59-.11.12-.24.25-.36.37l-67.2 67.2c-59.27 59.27-155.699 59.262-214.96.0-59.27-59.26-59.27-155.7.0-214.96l37.106-37.106c9.84-9.84 26.786-3.3 27.294 10.606.648 17.722 3.826 35.527 9.69 52.721 1.986 5.822.567 12.262-3.783 16.612l-13.087 13.087c-28.026 28.026-28.905 73.66-1.155 101.96 28.024 28.579 74.086 28.749 102.325.51l67.2-67.19c28.191-28.191 28.073-73.757.0-101.83-3.701-3.694-7.429-6.564-10.341-8.569a16.037 16.037.0 01-6.947-12.606c-.396-10.567 3.348-21.456 11.698-29.806l21.054-21.055c5.521-5.521 14.182-6.199 20.584-1.731a152.482 152.482.0 0120.522 17.197zM467.547 44.449c-59.261-59.262-155.69-59.27-214.96.0l-67.2 67.2c-.12.12-.25.25-.36.37-58.566 58.892-59.387 154.781.36 214.59a152.454 152.454.0 0020.521 17.196c6.402 4.468 15.064 3.789 20.584-1.731l21.054-21.055c8.35-8.35 12.094-19.239 11.698-29.806a16.037 16.037.0 00-6.947-12.606c-2.912-2.005-6.64-4.875-10.341-8.569-28.073-28.073-28.191-73.639.0-101.83l67.2-67.19c28.239-28.239 74.3-28.069 102.325.51 27.75 28.3 26.872 73.934-1.155 101.96l-13.087 13.087c-4.35 4.35-5.769 10.79-3.783 16.612 5.864 17.194 9.042 34.999 9.69 52.721.509 13.906 17.454 20.446 27.294 10.606l37.106-37.106c59.271-59.259 59.271-155.699.001-214.959z"/></svg></a><a href=#contents:linux-中的文件锁 class=headings>linux 中的文件锁</a></h2><p>文件锁定是一种限制在多个进程之间访问文件的机制。它只允许一个进程在特定时间访问文件，从而避免<code>中间更新（interceding update）</code>问题。<br><code>linux</code> 支持两种文件锁：</p><ul><li><code>协同锁（Advisory Locking）</code></li><li><code>强制锁（mandatory locks）</code></li></ul><h3 id=-协同锁><a href=#-协同锁 class=anchor-link><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512" class="icon anchor-icon"><path d="M326.612 185.391c59.747 59.809 58.927 155.698.36 214.59-.11.12-.24.25-.36.37l-67.2 67.2c-59.27 59.27-155.699 59.262-214.96.0-59.27-59.26-59.27-155.7.0-214.96l37.106-37.106c9.84-9.84 26.786-3.3 27.294 10.606.648 17.722 3.826 35.527 9.69 52.721 1.986 5.822.567 12.262-3.783 16.612l-13.087 13.087c-28.026 28.026-28.905 73.66-1.155 101.96 28.024 28.579 74.086 28.749 102.325.51l67.2-67.19c28.191-28.191 28.073-73.757.0-101.83-3.701-3.694-7.429-6.564-10.341-8.569a16.037 16.037.0 01-6.947-12.606c-.396-10.567 3.348-21.456 11.698-29.806l21.054-21.055c5.521-5.521 14.182-6.199 20.584-1.731a152.482 152.482.0 0120.522 17.197zM467.547 44.449c-59.261-59.262-155.69-59.27-214.96.0l-67.2 67.2c-.12.12-.25.25-.36.37-58.566 58.892-59.387 154.781.36 214.59a152.454 152.454.0 0020.521 17.196c6.402 4.468 15.064 3.789 20.584-1.731l21.054-21.055c8.35-8.35 12.094-19.239 11.698-29.806a16.037 16.037.0 00-6.947-12.606c-2.912-2.005-6.64-4.875-10.341-8.569-28.073-28.073-28.191-73.639.0-101.83l67.2-67.19c28.239-28.239 74.3-28.069 102.325.51 27.75 28.3 26.872 73.934-1.155 101.96l-13.087 13.087c-4.35 4.35-5.769 10.79-3.783 16.612 5.864 17.194 9.042 34.999 9.69 52.721.509 13.906 17.454 20.446 27.294 10.606l37.106-37.106c59.271-59.259 59.271-155.699.001-214.959z"/></svg></a><a href=#contents:-协同锁 class=headings># 协同锁</a></h3><p>协同锁不是强制锁定方案。只有当参与的进程通过显式获取锁进行合作时，它才会起作用;否则，如果进程根本不知道锁，协同锁将被忽略。</p><p>仍以之前的示例说明：</p><div class=highlight><div class=chroma><div class=table-container><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-text data-lang=text><span class=line><span class=cl>假设文件 account.dat 仍然包含初始值 200。
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>备注：必须了解的是，协同锁不是由操作系统或文件系统设置的。因此即使进程 A 锁定了文件，进程 B 仍然可以通过系统调用自由地读取、写入甚至删除文件。如果进程 B 执行文件操作而不尝试获取锁，我们说进程 B 不与进程 A 合作。
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>协同锁是如何为协作进程工作的：
</span></span><span class=line><span class=cl>- 进程 A ：获取 account.dat 文件的排他锁，然后打开并读取该文件以获取当前值：200。
</span></span><span class=line><span class=cl>- 进程 B ：在读取文件之前尝试获取 account.dat 文件的锁（与进程 A 合作）。由于进程 A 已锁定文件，进程 B 必须等待进程 A 释放锁定。
</span></span><span class=line><span class=cl>- 进程 A ：计算 200-20 并将 180 写回文件。
</span></span><span class=line><span class=cl>- 进程 A ：释放锁。
</span></span><span class=line><span class=cl>- 进程 B ：现在获取锁并读取文件，并获得更新后的值：180。
</span></span><span class=line><span class=cl>- 进程 B ：启动其逻辑并将结果 260 (180+80) 写回文件。
</span></span><span class=line><span class=cl>- 进程 B ：释放锁，以便其他协作进程可以读取和写入文件。
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>后面可以看看使用 flock 命令实现。
</span></span></code></pre></td></tr></table></div></div></div><h3 id=-强制锁><a href=#-强制锁 class=anchor-link><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512" class="icon anchor-icon"><path d="M326.612 185.391c59.747 59.809 58.927 155.698.36 214.59-.11.12-.24.25-.36.37l-67.2 67.2c-59.27 59.27-155.699 59.262-214.96.0-59.27-59.26-59.27-155.7.0-214.96l37.106-37.106c9.84-9.84 26.786-3.3 27.294 10.606.648 17.722 3.826 35.527 9.69 52.721 1.986 5.822.567 12.262-3.783 16.612l-13.087 13.087c-28.026 28.026-28.905 73.66-1.155 101.96 28.024 28.579 74.086 28.749 102.325.51l67.2-67.19c28.191-28.191 28.073-73.757.0-101.83-3.701-3.694-7.429-6.564-10.341-8.569a16.037 16.037.0 01-6.947-12.606c-.396-10.567 3.348-21.456 11.698-29.806l21.054-21.055c5.521-5.521 14.182-6.199 20.584-1.731a152.482 152.482.0 0120.522 17.197zM467.547 44.449c-59.261-59.262-155.69-59.27-214.96.0l-67.2 67.2c-.12.12-.25.25-.36.37-58.566 58.892-59.387 154.781.36 214.59a152.454 152.454.0 0020.521 17.196c6.402 4.468 15.064 3.789 20.584-1.731l21.054-21.055c8.35-8.35 12.094-19.239 11.698-29.806a16.037 16.037.0 00-6.947-12.606c-2.912-2.005-6.64-4.875-10.341-8.569-28.073-28.073-28.191-73.639.0-101.83l67.2-67.19c28.239-28.239 74.3-28.069 102.325.51 27.75 28.3 26.872 73.934-1.155 101.96l-13.087 13.087c-4.35 4.35-5.769 10.79-3.783 16.612 5.864 17.194 9.042 34.999 9.69 52.721.509 13.906 17.454 20.446 27.294 10.606l37.106-37.106c59.271-59.259 59.271-155.699.001-214.959z"/></svg></a><a href=#contents:-强制锁 class=headings># 强制锁</a></h3><div class="notice warning"><div class=notice-title><svg xmlns="http://www.w3.org/2000/svg" class="icon notice-icon" viewBox="0 0 512 512"><path d="M256 8a248 248 0 100 496 248 248 0 000-496zm0 110a42 42 0 110 84 42 42 0 010-84zm56 254c0 7-5 12-12 12h-88c-7 0-12-5-12-12v-24c0-7 5-12 12-12h12v-64h-12c-7 0-12-5-12-12v-24c0-7 5-12 12-12h64c7 0 12 5 12 12v1e2h12c7 0 12 5 12 12v24z"/></svg></div><p>在了解强制文件锁定之前，需要了解的是：<a href=https://man7.org/linux/man-pages/man2/fcntl.2.html target=_blank rel=noopener>Linux 的强制锁实现是不可靠的</a><br><br>因强制锁存在 BUG,且自 linux 4.5 以来,该功能被认为很少使用，
强制锁已成为可选功能，由配置选项（CONFIG_MANDATORY_FILE_LOCKING）配置; 后续将逐步删除该功能。</p></div><p>与协同锁不同，强制锁不需要参与进程之间的任何合作。一旦在文件上激活强制锁定，操作系统就会阻止其他进程读取或写入文件。要在 <code>linux</code> 中启用强制文件锁定，必须满足两个要求：</p><ul><li>必须使用 <code>mand</code> 选项挂载文件系统<div class=highlight><div class=chroma><div class=table-container><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>$ mount -o mand FILESYSTEM MOUNT_POINT
</span></span></code></pre></td></tr></table></div></div></div></li><li>必须打开 <code>set-group-ID</code> 位并关闭我们将要锁定的文件的 <code>group-execute</code> 位<div class=highlight><div class=chroma><div class=table-container><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>$ chmod g+s,g-x FILE
</span></span></code></pre></td></tr></table></div></div></div></li></ul><h3 id=-检查系统中的所有锁><a href=#-检查系统中的所有锁 class=anchor-link><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512" class="icon anchor-icon"><path d="M326.612 185.391c59.747 59.809 58.927 155.698.36 214.59-.11.12-.24.25-.36.37l-67.2 67.2c-59.27 59.27-155.699 59.262-214.96.0-59.27-59.26-59.27-155.7.0-214.96l37.106-37.106c9.84-9.84 26.786-3.3 27.294 10.606.648 17.722 3.826 35.527 9.69 52.721 1.986 5.822.567 12.262-3.783 16.612l-13.087 13.087c-28.026 28.026-28.905 73.66-1.155 101.96 28.024 28.579 74.086 28.749 102.325.51l67.2-67.19c28.191-28.191 28.073-73.757.0-101.83-3.701-3.694-7.429-6.564-10.341-8.569a16.037 16.037.0 01-6.947-12.606c-.396-10.567 3.348-21.456 11.698-29.806l21.054-21.055c5.521-5.521 14.182-6.199 20.584-1.731a152.482 152.482.0 0120.522 17.197zM467.547 44.449c-59.261-59.262-155.69-59.27-214.96.0l-67.2 67.2c-.12.12-.25.25-.36.37-58.566 58.892-59.387 154.781.36 214.59a152.454 152.454.0 0020.521 17.196c6.402 4.468 15.064 3.789 20.584-1.731l21.054-21.055c8.35-8.35 12.094-19.239 11.698-29.806a16.037 16.037.0 00-6.947-12.606c-2.912-2.005-6.64-4.875-10.341-8.569-28.073-28.073-28.191-73.639.0-101.83l67.2-67.19c28.239-28.239 74.3-28.069 102.325.51 27.75 28.3 26.872 73.934-1.155 101.96l-13.087 13.087c-4.35 4.35-5.769 10.79-3.783 16.612 5.864 17.194 9.042 34.999 9.69 52.721.509 13.906 17.454 20.446 27.294 10.606l37.106-37.106c59.271-59.259 59.271-155.699.001-214.959z"/></svg></a><a href=#contents:-检查系统中的所有锁 class=headings># 检查系统中的所有锁</a></h3><p>检查正在运行的系统中当前获取的锁的两种方法：<br><strong>lslocks</strong><br><code>lslocks</code> 命令是由 <code>util-linux</code> 软件包提供的，可用于所有 <code>Linux</code> 发行版，它可以列出我们系统中当前持有的所有文件锁。</p><div class=highlight><div class=chroma><div class=table-container><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span><span class=lnt>7
</span><span class=lnt>8
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl><span class=o>[</span>root@c7u3test1 ~<span class=o>]</span><span class=c1># lslocks </span>
</span></span><span class=line><span class=cl>COMMAND           PID  TYPE SIZE MODE  M START END PATH
</span></span><span class=line><span class=cl>lvmetad           <span class=m>463</span> POSIX   4B WRITE <span class=m>0</span>     <span class=m>0</span>   <span class=m>0</span> /run/lvmetad.pid
</span></span><span class=line><span class=cl>crond             <span class=m>628</span> FLOCK   4B WRITE <span class=m>0</span>     <span class=m>0</span>   <span class=m>0</span> /run/crond.pid
</span></span><span class=line><span class=cl>atd               <span class=m>629</span> POSIX   4B WRITE <span class=m>0</span>     <span class=m>0</span>   <span class=m>0</span> /run/atd.pid
</span></span><span class=line><span class=cl>abrtd             <span class=m>606</span> POSIX   4B WRITE <span class=m>0</span>     <span class=m>0</span>   <span class=m>0</span> /run/abrt/abrtd.pid
</span></span><span class=line><span class=cl>master           <span class=m>1512</span> FLOCK  33B WRITE <span class=m>0</span>     <span class=m>0</span>   <span class=m>0</span> /var/spool/postfix/pid/master.pid
</span></span><span class=line><span class=cl>master           <span class=m>1512</span> FLOCK  33B WRITE <span class=m>0</span>     <span class=m>0</span>   <span class=m>0</span> /var/lib/postfix/master.lock
</span></span></code></pre></td></tr></table></div></div></div><p>在命令输出中，我们可以看到系统中所有当前被锁定的文件，以及每个锁的详细信息，比如锁的类型，哪个进程持有锁等。</p><p><strong>/proc/locks</strong><br><code>/proc/locks</code> 不是命令，它是 <code>procfs</code> 虚拟文件系统中的一个文件;该文件包含所有当前文件锁。<code>lslocks</code> 命令也依赖此文件来生成列表。</p><div class=highlight><div class=chroma><div class=table-container><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span><span class=lnt>7
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl><span class=o>[</span>root@c7u3test1 ~<span class=o>]</span><span class=c1># cat /proc/locks </span>
</span></span><span class=line><span class=cl>1: FLOCK  ADVISORY  WRITE <span class=m>1512</span> fd:00:34534423 <span class=m>0</span> EOF
</span></span><span class=line><span class=cl>2: FLOCK  ADVISORY  WRITE <span class=m>1512</span> fd:00:1284 <span class=m>0</span> EOF
</span></span><span class=line><span class=cl>3: POSIX  ADVISORY  WRITE <span class=m>606</span> 00:12:15127 <span class=m>0</span> EOF
</span></span><span class=line><span class=cl>4: POSIX  ADVISORY  WRITE <span class=m>629</span> 00:12:15111 <span class=m>0</span> EOF
</span></span><span class=line><span class=cl>5: FLOCK  ADVISORY  WRITE <span class=m>628</span> 00:12:15087 <span class=m>0</span> EOF
</span></span><span class=line><span class=cl>6: POSIX  ADVISORY  WRITE <span class=m>463</span> 00:12:12033 <span class=m>0</span> EOF
</span></span></code></pre></td></tr></table></div></div></div><p>选取第一行来了解锁信息在 <code>/proc/locks</code> 文件系统中是如何组织的：</p><div class=highlight><div class=chroma><div class=table-container><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-text data-lang=text><span class=line><span class=cl>1:  FLOCK  ADVISORY  WRITE 1512 fd:00:34534423  0  EOF
</span></span><span class=line><span class=cl>-1- --2--  ---3---   --4-- --5- -------6------ -7- -8-
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl># 1: 第一个字段是序列号
</span></span><span class=line><span class=cl># 2: 第二个字段表示使用的锁的类，例如 FLOCK（来自flock 系统调用）或POSIX（来自lockf、fcntl 系统调用）
</span></span><span class=line><span class=cl># 3: 第三个字段表示锁定类型，它可以有两个值：ADVISORY 或 MANDATORY
</span></span><span class=line><span class=cl># 4: 第四个字段显示锁是写锁还是读锁
</span></span><span class=line><span class=cl># 5: 第五个字段表示持有锁的进程的ID
</span></span><span class=line><span class=cl># 6: 第六个字段包含一个冒号分隔值字符串，以 major-device:minor-device:inode 的格式显示锁定文件的 id
</span></span><span class=line><span class=cl># 7和8: 第七和第八字段一起显示被锁定文件的锁定区域的开始和结束;在此示例行中，整个文件被锁定
</span></span></code></pre></td></tr></table></div></div></div><h2 id=-协同锁使用示例><a href=#-协同锁使用示例 class=anchor-link><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512" class="icon anchor-icon"><path d="M326.612 185.391c59.747 59.809 58.927 155.698.36 214.59-.11.12-.24.25-.36.37l-67.2 67.2c-59.27 59.27-155.699 59.262-214.96.0-59.27-59.26-59.27-155.7.0-214.96l37.106-37.106c9.84-9.84 26.786-3.3 27.294 10.606.648 17.722 3.826 35.527 9.69 52.721 1.986 5.822.567 12.262-3.783 16.612l-13.087 13.087c-28.026 28.026-28.905 73.66-1.155 101.96 28.024 28.579 74.086 28.749 102.325.51l67.2-67.19c28.191-28.191 28.073-73.757.0-101.83-3.701-3.694-7.429-6.564-10.341-8.569a16.037 16.037.0 01-6.947-12.606c-.396-10.567 3.348-21.456 11.698-29.806l21.054-21.055c5.521-5.521 14.182-6.199 20.584-1.731a152.482 152.482.0 0120.522 17.197zM467.547 44.449c-59.261-59.262-155.69-59.27-214.96.0l-67.2 67.2c-.12.12-.25.25-.36.37-58.566 58.892-59.387 154.781.36 214.59a152.454 152.454.0 0020.521 17.196c6.402 4.468 15.064 3.789 20.584-1.731l21.054-21.055c8.35-8.35 12.094-19.239 11.698-29.806a16.037 16.037.0 00-6.947-12.606c-2.912-2.005-6.64-4.875-10.341-8.569-28.073-28.073-28.191-73.639.0-101.83l67.2-67.19c28.239-28.239 74.3-28.069 102.325.51 27.75 28.3 26.872 73.934-1.155 101.96l-13.087 13.087c-4.35 4.35-5.769 10.79-3.783 16.612 5.864 17.194 9.042 34.999 9.69 52.721.509 13.906 17.454 20.446 27.294 10.606l37.106-37.106c59.271-59.259 59.271-155.699.001-214.959z"/></svg></a><a href=#contents:-协同锁使用示例 class=headings># 协同锁使用示例</a></h2><p><code>util-linux</code> <code>包也提供了flock</code> 命令; <code>flock</code> 命令允许我们在 <code>shell</code> 脚本或命令行中管理协同文件锁，使用方式为：</p><div class=highlight><div class=chroma><div class=table-container><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>$ flock FILE_TO_LOCK COMMAND
</span></span></code></pre></td></tr></table></div></div></div><h3 id=-获取协同锁><a href=#-获取协同锁 class=anchor-link><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512" class="icon anchor-icon"><path d="M326.612 185.391c59.747 59.809 58.927 155.698.36 214.59-.11.12-.24.25-.36.37l-67.2 67.2c-59.27 59.27-155.699 59.262-214.96.0-59.27-59.26-59.27-155.7.0-214.96l37.106-37.106c9.84-9.84 26.786-3.3 27.294 10.606.648 17.722 3.826 35.527 9.69 52.721 1.986 5.822.567 12.262-3.783 16.612l-13.087 13.087c-28.026 28.026-28.905 73.66-1.155 101.96 28.024 28.579 74.086 28.749 102.325.51l67.2-67.19c28.191-28.191 28.073-73.757.0-101.83-3.701-3.694-7.429-6.564-10.341-8.569a16.037 16.037.0 01-6.947-12.606c-.396-10.567 3.348-21.456 11.698-29.806l21.054-21.055c5.521-5.521 14.182-6.199 20.584-1.731a152.482 152.482.0 0120.522 17.197zM467.547 44.449c-59.261-59.262-155.69-59.27-214.96.0l-67.2 67.2c-.12.12-.25.25-.36.37-58.566 58.892-59.387 154.781.36 214.59a152.454 152.454.0 0020.521 17.196c6.402 4.468 15.064 3.789 20.584-1.731l21.054-21.055c8.35-8.35 12.094-19.239 11.698-29.806a16.037 16.037.0 00-6.947-12.606c-2.912-2.005-6.64-4.875-10.341-8.569-28.073-28.073-28.191-73.639.0-101.83l67.2-67.19c28.239-28.239 74.3-28.069 102.325.51 27.75 28.3 26.872 73.934-1.155 101.96l-13.087 13.087c-4.35 4.35-5.769 10.79-3.783 16.612 5.864 17.194 9.042 34.999 9.69 52.721.509 13.906 17.454 20.446 27.294 10.606l37.106-37.106c59.271-59.259 59.271-155.699.001-214.959z"/></svg></a><a href=#contents:-获取协同锁 class=headings># 获取协同锁</a></h3><p>以更新 <code>balance.dat</code> 文本文件为例说明，还需要两个进程 A 和 B 来更新文件中的余额。首先创建一个简单的 <code>shell</code> 脚本 <code>update_balance.sh</code> 来处理两个进程的余额更新逻辑，脚本如下：</p><div class=highlight><div class=chroma><div class=table-container><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl><span class=cp>#!/bin/bash
</span></span></span><span class=line><span class=cl><span class=cp></span><span class=nv>file</span><span class=o>=</span><span class=s2>&#34;balance.dat&#34;</span>
</span></span><span class=line><span class=cl><span class=nv>value</span><span class=o>=</span><span class=k>$(</span>cat <span class=nv>$file</span><span class=k>)</span>
</span></span><span class=line><span class=cl><span class=nb>echo</span> <span class=s2>&#34;Read current balance: </span><span class=nv>$value</span><span class=s2>&#34;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># sleep 10 seconds to simulate business calculation</span>
</span></span><span class=line><span class=cl><span class=nv>progress</span><span class=o>=</span><span class=m>10</span>
</span></span><span class=line><span class=cl><span class=k>while</span> <span class=o>[[</span> <span class=nv>$progress</span> -lt <span class=m>101</span> <span class=o>]]</span><span class=p>;</span> <span class=k>do</span>
</span></span><span class=line><span class=cl>	<span class=nb>echo</span> -n -e <span class=s2>&#34;\033[77DCalculating new balance.. </span><span class=nv>$progress</span><span class=s2>%&#34;</span>
</span></span><span class=line><span class=cl>	sleep <span class=m>1</span>
</span></span><span class=line><span class=cl>	<span class=nv>progress</span><span class=o>=</span><span class=k>$((</span><span class=m>10</span><span class=o>+</span>progress<span class=k>))</span>
</span></span><span class=line><span class=cl><span class=k>done</span>
</span></span><span class=line><span class=cl><span class=nb>echo</span> <span class=s2>&#34;&#34;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=nv>value</span><span class=o>=</span><span class=k>$((</span>value+<span class=nv>$1</span><span class=k>))</span>
</span></span><span class=line><span class=cl><span class=nb>echo</span> <span class=s2>&#34;Write new balance (</span><span class=nv>$value</span><span class=s2>) back to </span><span class=nv>$file</span><span class=s2>.&#34;</span> 
</span></span><span class=line><span class=cl><span class=nb>echo</span> <span class=nv>$value</span> &gt; <span class=s2>&#34;</span><span class=nv>$file</span><span class=s2>&#34;</span>
</span></span><span class=line><span class=cl><span class=nb>echo</span> <span class=s2>&#34;Done.&#34;</span>
</span></span></code></pre></td></tr></table></div></div></div><p>创建一个简单的 <code>shell</code> 脚本 <code>a.sh</code> 来模拟<code>进程A</code>：</p><div class=highlight><div class=chroma><div class=table-container><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl><span class=cp>#!/bin/bash
</span></span></span><span class=line><span class=cl><span class=cp></span><span class=c1>#-----------------------------------------</span>
</span></span><span class=line><span class=cl><span class=c1># process A: lock the file and subtract 20 </span>
</span></span><span class=line><span class=cl><span class=c1># from the current balance</span>
</span></span><span class=line><span class=cl><span class=c1>#-----------------------------------------</span>
</span></span><span class=line><span class=cl>flock --verbose account.dat ./update_balance.sh <span class=s1>&#39;-20&#39;</span>
</span></span></code></pre></td></tr></table></div></div></div><p>执行后结果：</p><div class=highlight><div class=chroma><div class=table-container><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span><span class=lnt>7
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>$ ./a.sh 
</span></span><span class=line><span class=cl>flock: getting lock took 0.000002 seconds
</span></span><span class=line><span class=cl>flock: executing ./update_balance.sh
</span></span><span class=line><span class=cl>Read current balance:100
</span></span><span class=line><span class=cl>Calculating new balance..100%
</span></span><span class=line><span class=cl>Write new balance <span class=o>(</span>80<span class=o>)</span> back to balance.dat.
</span></span><span class=line><span class=cl>Done.
</span></span></code></pre></td></tr></table></div></div></div><p>脚本执行过程中，可以通过 <code>lslocks</code> 命令查看锁文件：</p><div class=highlight><div class=chroma><div class=table-container><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>$ lslocks <span class=p>|</span> grep <span class=s1>&#39;balance&#39;</span>
</span></span><span class=line><span class=cl>flock      <span class=m>825712</span>  FLOCK   4B WRITE <span class=m>0</span>      <span class=m>0</span>      <span class=m>0</span> /tmp/test/balance.dat
</span></span></code></pre></td></tr></table></div></div></div><p>输出显示 <code>flock</code> 命令对整个文件 <code>/tmp/test/balance.dat</code> 持有一个 <code>WRITE</code> 锁。</p><h3 id=-非协作进程示例><a href=#-非协作进程示例 class=anchor-link><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512" class="icon anchor-icon"><path d="M326.612 185.391c59.747 59.809 58.927 155.698.36 214.59-.11.12-.24.25-.36.37l-67.2 67.2c-59.27 59.27-155.699 59.262-214.96.0-59.27-59.26-59.27-155.7.0-214.96l37.106-37.106c9.84-9.84 26.786-3.3 27.294 10.606.648 17.722 3.826 35.527 9.69 52.721 1.986 5.822.567 12.262-3.783 16.612l-13.087 13.087c-28.026 28.026-28.905 73.66-1.155 101.96 28.024 28.579 74.086 28.749 102.325.51l67.2-67.19c28.191-28.191 28.073-73.757.0-101.83-3.701-3.694-7.429-6.564-10.341-8.569a16.037 16.037.0 01-6.947-12.606c-.396-10.567 3.348-21.456 11.698-29.806l21.054-21.055c5.521-5.521 14.182-6.199 20.584-1.731a152.482 152.482.0 0120.522 17.197zM467.547 44.449c-59.261-59.262-155.69-59.27-214.96.0l-67.2 67.2c-.12.12-.25.25-.36.37-58.566 58.892-59.387 154.781.36 214.59a152.454 152.454.0 0020.521 17.196c6.402 4.468 15.064 3.789 20.584-1.731l21.054-21.055c8.35-8.35 12.094-19.239 11.698-29.806a16.037 16.037.0 00-6.947-12.606c-2.912-2.005-6.64-4.875-10.341-8.569-28.073-28.073-28.191-73.639.0-101.83l67.2-67.19c28.239-28.239 74.3-28.069 102.325.51 27.75 28.3 26.872 73.934-1.155 101.96l-13.087 13.087c-4.35 4.35-5.769 10.79-3.783 16.612 5.864 17.194 9.042 34.999 9.69 52.721.509 13.906 17.454 20.446 27.294 10.606l37.106-37.106c59.271-59.259 59.271-155.699.001-214.959z"/></svg></a><a href=#contents:-非协作进程示例 class=headings># 非协作进程示例</a></h3><p>协作锁只有在参与的进程协作时才起作用。将余额重置为 200，并测试如果进程 A 获取文件的协作锁但以非协作方式启动进程 B 会发生什么。<br>创建一个简单的 <code>shell</code> 脚本 <code>b_non-cooperative.sh</code>：</p><div class=highlight><div class=chroma><div class=table-container><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl><span class=cp>#!/bin/bash
</span></span></span><span class=line><span class=cl><span class=cp></span><span class=c1>#----------------------------------------</span>
</span></span><span class=line><span class=cl><span class=c1># process B: add 80 to the current balance in a</span>
</span></span><span class=line><span class=cl><span class=c1># non-cooperative way</span>
</span></span><span class=line><span class=cl><span class=c1>#----------------------------------------</span>
</span></span><span class=line><span class=cl>./update_balance.sh <span class=s1>&#39;80&#39;</span>
</span></span></code></pre></td></tr></table></div></div></div><p>进程 B 调用 <code>update_balance.sh</code> 没有尝试获取数据文件上的锁。
<img src=https://ruisum.oss-cn-shenzhen.aliyuncs.com/img/2022/06/20220619-1538.gif alt=test1>
如果进程 B 启动时没有与进程 A 协作，进程 A 获取的协作锁将被忽略;因此在 <code>balance.dat</code> 中数字为 280，而不是 260。</p><h3 id=-协作进程示例><a href=#-协作进程示例 class=anchor-link><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512" class="icon anchor-icon"><path d="M326.612 185.391c59.747 59.809 58.927 155.698.36 214.59-.11.12-.24.25-.36.37l-67.2 67.2c-59.27 59.27-155.699 59.262-214.96.0-59.27-59.26-59.27-155.7.0-214.96l37.106-37.106c9.84-9.84 26.786-3.3 27.294 10.606.648 17.722 3.826 35.527 9.69 52.721 1.986 5.822.567 12.262-3.783 16.612l-13.087 13.087c-28.026 28.026-28.905 73.66-1.155 101.96 28.024 28.579 74.086 28.749 102.325.51l67.2-67.19c28.191-28.191 28.073-73.757.0-101.83-3.701-3.694-7.429-6.564-10.341-8.569a16.037 16.037.0 01-6.947-12.606c-.396-10.567 3.348-21.456 11.698-29.806l21.054-21.055c5.521-5.521 14.182-6.199 20.584-1.731a152.482 152.482.0 0120.522 17.197zM467.547 44.449c-59.261-59.262-155.69-59.27-214.96.0l-67.2 67.2c-.12.12-.25.25-.36.37-58.566 58.892-59.387 154.781.36 214.59a152.454 152.454.0 0020.521 17.196c6.402 4.468 15.064 3.789 20.584-1.731l21.054-21.055c8.35-8.35 12.094-19.239 11.698-29.806a16.037 16.037.0 00-6.947-12.606c-2.912-2.005-6.64-4.875-10.341-8.569-28.073-28.073-28.191-73.639.0-101.83l67.2-67.19c28.239-28.239 74.3-28.069 102.325.51 27.75 28.3 26.872 73.934-1.155 101.96l-13.087 13.087c-4.35 4.35-5.769 10.79-3.783 16.612 5.864 17.194 9.042 34.999 9.69 52.721.509 13.906 17.454 20.446 27.294 10.606l37.106-37.106c59.271-59.259 59.271-155.699.001-214.959z"/></svg></a><a href=#contents:-协作进程示例 class=headings># 协作进程示例</a></h3><p>创建另一个协作进程 B，<code>b.sh</code>，看看协作锁是如何工作的：</p><div class=highlight><div class=chroma><div class=table-container><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl><span class=cp>#!/bin/bash
</span></span></span><span class=line><span class=cl><span class=cp></span><span class=c1>#----------------------------------------</span>
</span></span><span class=line><span class=cl><span class=c1># process B: add 80 to the current balance</span>
</span></span><span class=line><span class=cl><span class=c1># in a cooperative way</span>
</span></span><span class=line><span class=cl><span class=c1>#----------------------------------------</span>
</span></span><span class=line><span class=cl>flock --verbose balance.dat ./update_balance.sh <span class=s1>&#39;80&#39;</span>
</span></span></code></pre></td></tr></table></div></div></div><p><img src=https://ruisum.oss-cn-shenzhen.aliyuncs.com/img/2022/06/20220619-1547.gif alt=test2>
当进程 B 尝试获取 <code>balance.dat</code> 文件上的锁时，它等待进程 A 释放锁。因此，协同锁定起作用了，我们在数据文件中得到了预期的结果 260。</p><h2 id=-flock-命令的使用><a href=#-flock-命令的使用 class=anchor-link><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512" class="icon anchor-icon"><path d="M326.612 185.391c59.747 59.809 58.927 155.698.36 214.59-.11.12-.24.25-.36.37l-67.2 67.2c-59.27 59.27-155.699 59.262-214.96.0-59.27-59.26-59.27-155.7.0-214.96l37.106-37.106c9.84-9.84 26.786-3.3 27.294 10.606.648 17.722 3.826 35.527 9.69 52.721 1.986 5.822.567 12.262-3.783 16.612l-13.087 13.087c-28.026 28.026-28.905 73.66-1.155 101.96 28.024 28.579 74.086 28.749 102.325.51l67.2-67.19c28.191-28.191 28.073-73.757.0-101.83-3.701-3.694-7.429-6.564-10.341-8.569a16.037 16.037.0 01-6.947-12.606c-.396-10.567 3.348-21.456 11.698-29.806l21.054-21.055c5.521-5.521 14.182-6.199 20.584-1.731a152.482 152.482.0 0120.522 17.197zM467.547 44.449c-59.261-59.262-155.69-59.27-214.96.0l-67.2 67.2c-.12.12-.25.25-.36.37-58.566 58.892-59.387 154.781.36 214.59a152.454 152.454.0 0020.521 17.196c6.402 4.468 15.064 3.789 20.584-1.731l21.054-21.055c8.35-8.35 12.094-19.239 11.698-29.806a16.037 16.037.0 00-6.947-12.606c-2.912-2.005-6.64-4.875-10.341-8.569-28.073-28.073-28.191-73.639.0-101.83l67.2-67.19c28.239-28.239 74.3-28.069 102.325.51 27.75 28.3 26.872 73.934-1.155 101.96l-13.087 13.087c-4.35 4.35-5.769 10.79-3.783 16.612 5.864 17.194 9.042 34.999 9.69 52.721.509 13.906 17.454 20.446 27.294 10.606l37.106-37.106c59.271-59.259 59.271-155.699.001-214.959z"/></svg></a><a href=#contents:-flock-命令的使用 class=headings># flock 命令的使用</a></h2><h3 id=-flock-的语法><a href=#-flock-的语法 class=anchor-link><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512" class="icon anchor-icon"><path d="M326.612 185.391c59.747 59.809 58.927 155.698.36 214.59-.11.12-.24.25-.36.37l-67.2 67.2c-59.27 59.27-155.699 59.262-214.96.0-59.27-59.26-59.27-155.7.0-214.96l37.106-37.106c9.84-9.84 26.786-3.3 27.294 10.606.648 17.722 3.826 35.527 9.69 52.721 1.986 5.822.567 12.262-3.783 16.612l-13.087 13.087c-28.026 28.026-28.905 73.66-1.155 101.96 28.024 28.579 74.086 28.749 102.325.51l67.2-67.19c28.191-28.191 28.073-73.757.0-101.83-3.701-3.694-7.429-6.564-10.341-8.569a16.037 16.037.0 01-6.947-12.606c-.396-10.567 3.348-21.456 11.698-29.806l21.054-21.055c5.521-5.521 14.182-6.199 20.584-1.731a152.482 152.482.0 0120.522 17.197zM467.547 44.449c-59.261-59.262-155.69-59.27-214.96.0l-67.2 67.2c-.12.12-.25.25-.36.37-58.566 58.892-59.387 154.781.36 214.59a152.454 152.454.0 0020.521 17.196c6.402 4.468 15.064 3.789 20.584-1.731l21.054-21.055c8.35-8.35 12.094-19.239 11.698-29.806a16.037 16.037.0 00-6.947-12.606c-2.912-2.005-6.64-4.875-10.341-8.569-28.073-28.073-28.191-73.639.0-101.83l67.2-67.19c28.239-28.239 74.3-28.069 102.325.51 27.75 28.3 26.872 73.934-1.155 101.96l-13.087 13.087c-4.35 4.35-5.769 10.79-3.783 16.612 5.864 17.194 9.042 34.999 9.69 52.721.509 13.906 17.454 20.446 27.294 10.606l37.106-37.106c59.271-59.259 59.271-155.699.001-214.959z"/></svg></a><a href=#contents:-flock-的语法 class=headings># flock 的语法</a></h3><div class=highlight><div class=chroma><div class=table-container><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl><span class=c1>## 命令格式</span>
</span></span><span class=line><span class=cl>flock <span class=o>[</span>options<span class=o>]</span> file<span class=p>|</span>directory <span class=nb>command</span> <span class=o>[</span>arguments<span class=o>]</span>
</span></span><span class=line><span class=cl>flock <span class=o>[</span>options<span class=o>]</span> file<span class=p>|</span>directory -c <span class=nb>command</span>
</span></span><span class=line><span class=cl>flock <span class=o>[</span>options<span class=o>]</span> number
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>## 几个参数的说明</span>
</span></span><span class=line><span class=cl>-c，--command command：后接命令
</span></span><span class=line><span class=cl>-x，-e,--exclusive number： 获得排他锁，有时称为写锁。默认的锁
</span></span><span class=line><span class=cl>-n，--nb,--nonblock： 如果无法立即获得锁，则失败而不是等待。有关使用的退出代码，请参见 -E 选项
</span></span><span class=line><span class=cl>-E，--conflict-exit-code： 使用 -n 选项时使用的退出代码。默认值为 <span class=m>1</span>
</span></span><span class=line><span class=cl>-o，--close： 在执行命令之前关闭持有锁的文件描述符。如果命令生成不应持有锁的子进程会比较有用
</span></span><span class=line><span class=cl>-s，--shared：获得共享锁，有时称为读锁
</span></span><span class=line><span class=cl>-u，--unlock： 释放锁。这通常不是必需的，因为当文件关闭时锁会自动删除<span class=p>;</span>但在特殊情况下可能需要，例如如果封闭的命令组可能已经派生了一个不应该的后台进程保留了锁
</span></span><span class=line><span class=cl>-w，--wait，--timeout seconds：如果在几秒钟内无法获取锁，则失败
</span></span></code></pre></td></tr></table></div></div></div><p>上面的第一种和第二种形式类似于 <code>su</code> 或 <code>newgrp</code> 的命令格式。他们锁定一个指定的文件或目录，如果尚不存在，则会创建（需要有适当的权限）。默认情况下，如果锁不能立即获得，<code>flock</code> 会一直等待，直到锁可用为止。<br>第三种形式通过文件描述符号使用打开的文件，后面有示例说明。</p><h3 id=-常见使用方式><a href=#-常见使用方式 class=anchor-link><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512" class="icon anchor-icon"><path d="M326.612 185.391c59.747 59.809 58.927 155.698.36 214.59-.11.12-.24.25-.36.37l-67.2 67.2c-59.27 59.27-155.699 59.262-214.96.0-59.27-59.26-59.27-155.7.0-214.96l37.106-37.106c9.84-9.84 26.786-3.3 27.294 10.606.648 17.722 3.826 35.527 9.69 52.721 1.986 5.822.567 12.262-3.783 16.612l-13.087 13.087c-28.026 28.026-28.905 73.66-1.155 101.96 28.024 28.579 74.086 28.749 102.325.51l67.2-67.19c28.191-28.191 28.073-73.757.0-101.83-3.701-3.694-7.429-6.564-10.341-8.569a16.037 16.037.0 01-6.947-12.606c-.396-10.567 3.348-21.456 11.698-29.806l21.054-21.055c5.521-5.521 14.182-6.199 20.584-1.731a152.482 152.482.0 0120.522 17.197zM467.547 44.449c-59.261-59.262-155.69-59.27-214.96.0l-67.2 67.2c-.12.12-.25.25-.36.37-58.566 58.892-59.387 154.781.36 214.59a152.454 152.454.0 0020.521 17.196c6.402 4.468 15.064 3.789 20.584-1.731l21.054-21.055c8.35-8.35 12.094-19.239 11.698-29.806a16.037 16.037.0 00-6.947-12.606c-2.912-2.005-6.64-4.875-10.341-8.569-28.073-28.073-28.191-73.639.0-101.83l67.2-67.19c28.239-28.239 74.3-28.069 102.325.51 27.75 28.3 26.872 73.934-1.155 101.96l-13.087 13.087c-4.35 4.35-5.769 10.79-3.783 16.612 5.864 17.194 9.042 34.999 9.69 52.721.509 13.906 17.454 20.446 27.294 10.606l37.106-37.106c59.271-59.259 59.271-155.699.001-214.959z"/></svg></a><a href=#contents:-常见使用方式 class=headings># 常见使用方式</a></h3><div class=highlight><div class=chroma><div class=table-container><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl><span class=c1>## 执行 echo 命令前，获取排他锁</span>
</span></span><span class=line><span class=cl>$ flock -x local-lock-file <span class=nb>echo</span> <span class=s1>&#39;a b c&#39;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>## shell 脚本中使用很方便，当块中的代码执行完成时，文件描述符9和锁会自动释放</span>
</span></span><span class=line><span class=cl><span class=c1>## 此处还可以使用 subshell, 但subshell存在一定的性能损耗，以及一些其他类似变量传递等的问题</span>
</span></span><span class=line><span class=cl>$ <span class=o>{</span>
</span></span><span class=line><span class=cl> flock -n <span class=m>9</span> <span class=o>||</span> <span class=nb>exit</span> <span class=m>1</span>
</span></span><span class=line><span class=cl> <span class=c1># ... commands executed under lock ...</span>
</span></span><span class=line><span class=cl><span class=o>}</span> 9&gt;/var/lock/mylockfile
</span></span><span class=line><span class=cl>  
</span></span><span class=line><span class=cl><span class=c1>## 这是 shell 脚本的样板代码。将它放在要锁定的 shell 脚本的顶部，它会在第一次运行时自动锁定。</span>
</span></span><span class=line><span class=cl><span class=c1>## 如果 env var $FLOCKER 未设置为正在运行的 shell 脚本，则在重新执行自身之前执行 flock 并获取独占非阻塞锁（使用脚本本身作为锁文件）。 </span>
</span></span><span class=line><span class=cl><span class=c1>## 它还将 FLOCKER 环境变量设置为正确的值，因此它不会再次运行。</span>
</span></span><span class=line><span class=cl>$ <span class=o>[</span> <span class=s2>&#34;</span><span class=si>${</span><span class=nv>FLOCKER</span><span class=si>}</span><span class=s2>&#34;</span> !<span class=o>=</span> <span class=s2>&#34;</span><span class=nv>$0</span><span class=s2>&#34;</span> <span class=o>]</span> <span class=o>&amp;&amp;</span> <span class=nb>exec</span> env <span class=nv>FLOCKER</span><span class=o>=</span><span class=s2>&#34;</span><span class=nv>$0</span><span class=s2>&#34;</span> flock -en <span class=s2>&#34;</span><span class=nv>$0</span><span class=s2>&#34;</span> <span class=s2>&#34;</span><span class=nv>$0</span><span class=s2>&#34;</span> <span class=s2>&#34;</span><span class=nv>$@</span><span class=s2>&#34;</span> <span class=o>||</span> :
</span></span></code></pre></td></tr></table></div></div></div><h3 id=-flock-和-fd-的结合使用><a href=#-flock-和-fd-的结合使用 class=anchor-link><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512" class="icon anchor-icon"><path d="M326.612 185.391c59.747 59.809 58.927 155.698.36 214.59-.11.12-.24.25-.36.37l-67.2 67.2c-59.27 59.27-155.699 59.262-214.96.0-59.27-59.26-59.27-155.7.0-214.96l37.106-37.106c9.84-9.84 26.786-3.3 27.294 10.606.648 17.722 3.826 35.527 9.69 52.721 1.986 5.822.567 12.262-3.783 16.612l-13.087 13.087c-28.026 28.026-28.905 73.66-1.155 101.96 28.024 28.579 74.086 28.749 102.325.51l67.2-67.19c28.191-28.191 28.073-73.757.0-101.83-3.701-3.694-7.429-6.564-10.341-8.569a16.037 16.037.0 01-6.947-12.606c-.396-10.567 3.348-21.456 11.698-29.806l21.054-21.055c5.521-5.521 14.182-6.199 20.584-1.731a152.482 152.482.0 0120.522 17.197zM467.547 44.449c-59.261-59.262-155.69-59.27-214.96.0l-67.2 67.2c-.12.12-.25.25-.36.37-58.566 58.892-59.387 154.781.36 214.59a152.454 152.454.0 0020.521 17.196c6.402 4.468 15.064 3.789 20.584-1.731l21.054-21.055c8.35-8.35 12.094-19.239 11.698-29.806a16.037 16.037.0 00-6.947-12.606c-2.912-2.005-6.64-4.875-10.341-8.569-28.073-28.073-28.191-73.639.0-101.83l67.2-67.19c28.239-28.239 74.3-28.069 102.325.51 27.75 28.3 26.872 73.934-1.155 101.96l-13.087 13.087c-4.35 4.35-5.769 10.79-3.783 16.612 5.864 17.194 9.042 34.999 9.69 52.721.509 13.906 17.454 20.446 27.294 10.606l37.106-37.106c59.271-59.259 59.271-155.699.001-214.959z"/></svg></a><a href=#contents:-flock-和-fd-的结合使用 class=headings># flock 和 fd 的结合使用</a></h3><ul><li>为什么将 <code>flock</code> 与文件描述符结合使用<blockquote><p>与更传统的锁定机制相比，使用<code>flock() </code>或与之密切相关的<code>fcntl(LOCK_EX)</code> 机制的主要优势之一是，无需在重新启动或其他非正常关机情况下执行清理动作。因为锁是通过文件描述符附加的；当该文件描述符关闭时（无论是通过正常关闭、SIGKILL 还是断电），不再持有锁。</p></blockquote></li><li>使用举例1<div class=highlight><div class=chroma><div class=table-container><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl><span class=c1>## 特定版本之后的 bash，支持不用手动管理 fd 的分配</span>
</span></span><span class=line><span class=cl><span class=c1># this requires a very new bash -- 4.2 or so.</span>
</span></span><span class=line><span class=cl><span class=nb>exec</span> <span class=o>{</span>lock_fd<span class=o>}</span>&gt;filename  <span class=c1># open filename, store FD number in lock_fd</span>
</span></span><span class=line><span class=cl>flock -x <span class=s2>&#34;</span><span class=nv>$lock_fd</span><span class=s2>&#34;</span>      <span class=c1># pass that FD number to flock</span>
</span></span><span class=line><span class=cl><span class=nb>exec</span> <span class=nv>$lock_fd</span>&gt;<span class=p>&amp;</span>-         <span class=c1># later: release the lock</span>
</span></span></code></pre></td></tr></table></div></div></div></li><li>使用举例2<div class=highlight><div class=chroma><div class=table-container><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl><span class=c1>## 配置一个函数，用于获取锁</span>
</span></span><span class=line><span class=cl><span class=nb>declare</span> -A <span class=nv>lock_fds</span><span class=o>=()</span>                        <span class=c1># store FDs in an associative array</span>
</span></span><span class=line><span class=cl>getLock<span class=o>()</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>  <span class=nb>local</span> <span class=nv>file</span><span class=o>=</span><span class=k>$(</span>readlink -f <span class=s2>&#34;</span><span class=nv>$1</span><span class=s2>&#34;</span><span class=k>)</span>              <span class=c1># declare locals; canonicalize name</span>
</span></span><span class=line><span class=cl>  <span class=nb>local</span> <span class=nv>op</span><span class=o>=</span><span class=nv>$2</span>
</span></span><span class=line><span class=cl>  <span class=k>case</span> <span class=nv>$op</span> in
</span></span><span class=line><span class=cl>    LOCK_UN<span class=o>)</span>
</span></span><span class=line><span class=cl>      <span class=o>[[</span> <span class=si>${</span><span class=nv>lock_fds</span><span class=p>[</span><span class=nv>$file</span><span class=p>]</span><span class=si>}</span> <span class=o>]]</span> <span class=o>||</span> <span class=k>return</span>      <span class=c1># if not locked, do nothing</span>
</span></span><span class=line><span class=cl>      <span class=nb>exec</span> <span class=si>${</span><span class=nv>lock_fds</span><span class=p>[</span><span class=nv>$file</span><span class=p>]</span><span class=si>}</span>&gt;<span class=p>&amp;</span>-              <span class=c1># close the FD, releasing the lock</span>
</span></span><span class=line><span class=cl>      <span class=nb>unset</span> lock_fds<span class=o>[</span><span class=nv>$file</span><span class=o>]</span>                   <span class=c1># ...and clear the map entry.</span>
</span></span><span class=line><span class=cl>      <span class=p>;;</span>
</span></span><span class=line><span class=cl>    LOCK_EX<span class=o>)</span>
</span></span><span class=line><span class=cl>      <span class=o>[[</span> <span class=si>${</span><span class=nv>lock_fds</span><span class=p>[</span><span class=nv>$file</span><span class=p>]</span><span class=si>}</span> <span class=o>]]</span> <span class=o>&amp;&amp;</span> <span class=k>return</span>      <span class=c1># if already locked, do nothing</span>
</span></span><span class=line><span class=cl>      <span class=nb>local</span> new_lock_fd                       <span class=c1># don&#39;t leak this variable</span>
</span></span><span class=line><span class=cl>      <span class=nb>exec</span> <span class=o>{</span>new_lock_fd<span class=o>}</span>&gt;<span class=s2>&#34;</span><span class=nv>$file</span><span class=s2>&#34;</span>              <span class=c1># open the file...</span>
</span></span><span class=line><span class=cl>      flock -x <span class=s2>&#34;</span><span class=nv>$new_lock_fd</span><span class=s2>&#34;</span>                 <span class=c1># ...lock the fd...</span>
</span></span><span class=line><span class=cl>      lock_fds<span class=o>[</span><span class=nv>$file</span><span class=o>]=</span><span class=nv>$new_lock_fd</span>            <span class=c1># ...and store the locked FD.</span>
</span></span><span class=line><span class=cl>      <span class=p>;;</span>
</span></span><span class=line><span class=cl>  <span class=k>esac</span>
</span></span><span class=line><span class=cl><span class=o>}</span>
</span></span></code></pre></td></tr></table></div></div></div></li></ul><h2 id=-flock-系统调用><a href=#-flock-系统调用 class=anchor-link><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512" class="icon anchor-icon"><path d="M326.612 185.391c59.747 59.809 58.927 155.698.36 214.59-.11.12-.24.25-.36.37l-67.2 67.2c-59.27 59.27-155.699 59.262-214.96.0-59.27-59.26-59.27-155.7.0-214.96l37.106-37.106c9.84-9.84 26.786-3.3 27.294 10.606.648 17.722 3.826 35.527 9.69 52.721 1.986 5.822.567 12.262-3.783 16.612l-13.087 13.087c-28.026 28.026-28.905 73.66-1.155 101.96 28.024 28.579 74.086 28.749 102.325.51l67.2-67.19c28.191-28.191 28.073-73.757.0-101.83-3.701-3.694-7.429-6.564-10.341-8.569a16.037 16.037.0 01-6.947-12.606c-.396-10.567 3.348-21.456 11.698-29.806l21.054-21.055c5.521-5.521 14.182-6.199 20.584-1.731a152.482 152.482.0 0120.522 17.197zM467.547 44.449c-59.261-59.262-155.69-59.27-214.96.0l-67.2 67.2c-.12.12-.25.25-.36.37-58.566 58.892-59.387 154.781.36 214.59a152.454 152.454.0 0020.521 17.196c6.402 4.468 15.064 3.789 20.584-1.731l21.054-21.055c8.35-8.35 12.094-19.239 11.698-29.806a16.037 16.037.0 00-6.947-12.606c-2.912-2.005-6.64-4.875-10.341-8.569-28.073-28.073-28.191-73.639.0-101.83l67.2-67.19c28.239-28.239 74.3-28.069 102.325.51 27.75 28.3 26.872 73.934-1.155 101.96l-13.087 13.087c-4.35 4.35-5.769 10.79-3.783 16.612 5.864 17.194 9.042 34.999 9.69 52.721.509 13.906 17.454 20.446 27.294 10.606l37.106-37.106c59.271-59.259 59.271-155.699.001-214.959z"/></svg></a><a href=#contents:-flock-系统调用 class=headings># flock() 系统调用</a></h2><p><code>flock()</code> - 在打开的文件上应用或删除协同锁</p><h3 id=-实现><a href=#-实现 class=anchor-link><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512" class="icon anchor-icon"><path d="M326.612 185.391c59.747 59.809 58.927 155.698.36 214.59-.11.12-.24.25-.36.37l-67.2 67.2c-59.27 59.27-155.699 59.262-214.96.0-59.27-59.26-59.27-155.7.0-214.96l37.106-37.106c9.84-9.84 26.786-3.3 27.294 10.606.648 17.722 3.826 35.527 9.69 52.721 1.986 5.822.567 12.262-3.783 16.612l-13.087 13.087c-28.026 28.026-28.905 73.66-1.155 101.96 28.024 28.579 74.086 28.749 102.325.51l67.2-67.19c28.191-28.191 28.073-73.757.0-101.83-3.701-3.694-7.429-6.564-10.341-8.569a16.037 16.037.0 01-6.947-12.606c-.396-10.567 3.348-21.456 11.698-29.806l21.054-21.055c5.521-5.521 14.182-6.199 20.584-1.731a152.482 152.482.0 0120.522 17.197zM467.547 44.449c-59.261-59.262-155.69-59.27-214.96.0l-67.2 67.2c-.12.12-.25.25-.36.37-58.566 58.892-59.387 154.781.36 214.59a152.454 152.454.0 0020.521 17.196c6.402 4.468 15.064 3.789 20.584-1.731l21.054-21.055c8.35-8.35 12.094-19.239 11.698-29.806a16.037 16.037.0 00-6.947-12.606c-2.912-2.005-6.64-4.875-10.341-8.569-28.073-28.073-28.191-73.639.0-101.83l67.2-67.19c28.239-28.239 74.3-28.069 102.325.51 27.75 28.3 26.872 73.934-1.155 101.96l-13.087 13.087c-4.35 4.35-5.769 10.79-3.783 16.612 5.864 17.194 9.042 34.999 9.69 52.721.509 13.906 17.454 20.446 27.294 10.606l37.106-37.106c59.271-59.259 59.271-155.699.001-214.959z"/></svg></a><a href=#contents:-实现 class=headings># 实现</a></h3><div class=highlight><div class=chroma><div class=table-container><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-C data-lang=C><span class=line><span class=cl><span class=cp>#include</span> <span class=cpf>&lt;sys/file.h&gt; </span><span class=cp>
</span></span></span><span class=line><span class=cl><span class=cp></span>
</span></span><span class=line><span class=cl><span class=kt>int</span> <span class=nf>flock</span><span class=p>(</span><span class=kt>int</span> <span class=n>fd</span><span class=p>,</span> <span class=kt>int</span> <span class=n>operation</span><span class=p>);</span> 
</span></span></code></pre></td></tr></table></div></div></div><h3 id=-描述><a href=#-描述 class=anchor-link><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512" class="icon anchor-icon"><path d="M326.612 185.391c59.747 59.809 58.927 155.698.36 214.59-.11.12-.24.25-.36.37l-67.2 67.2c-59.27 59.27-155.699 59.262-214.96.0-59.27-59.26-59.27-155.7.0-214.96l37.106-37.106c9.84-9.84 26.786-3.3 27.294 10.606.648 17.722 3.826 35.527 9.69 52.721 1.986 5.822.567 12.262-3.783 16.612l-13.087 13.087c-28.026 28.026-28.905 73.66-1.155 101.96 28.024 28.579 74.086 28.749 102.325.51l67.2-67.19c28.191-28.191 28.073-73.757.0-101.83-3.701-3.694-7.429-6.564-10.341-8.569a16.037 16.037.0 01-6.947-12.606c-.396-10.567 3.348-21.456 11.698-29.806l21.054-21.055c5.521-5.521 14.182-6.199 20.584-1.731a152.482 152.482.0 0120.522 17.197zM467.547 44.449c-59.261-59.262-155.69-59.27-214.96.0l-67.2 67.2c-.12.12-.25.25-.36.37-58.566 58.892-59.387 154.781.36 214.59a152.454 152.454.0 0020.521 17.196c6.402 4.468 15.064 3.789 20.584-1.731l21.054-21.055c8.35-8.35 12.094-19.239 11.698-29.806a16.037 16.037.0 00-6.947-12.606c-2.912-2.005-6.64-4.875-10.341-8.569-28.073-28.073-28.191-73.639.0-101.83l67.2-67.19c28.239-28.239 74.3-28.069 102.325.51 27.75 28.3 26.872 73.934-1.155 101.96l-13.087 13.087c-4.35 4.35-5.769 10.79-3.783 16.612 5.864 17.194 9.042 34.999 9.69 52.721.509 13.906 17.454 20.446 27.294 10.606l37.106-37.106c59.271-59.259 59.271-155.699.001-214.959z"/></svg></a><a href=#contents:-描述 class=headings># 描述</a></h3><p>对 <code>fd</code> 指定的打开文件应用或删除协同锁，参数 <code>operation</code> 是以下之一：</p><div class=table-container><table><thead><tr><th style=text-align:left><strong>Tag</strong></th><th style=text-align:left><strong>Description</strong></th></tr></thead><tbody><tr><td style=text-align:left><code>LOCK_SH</code></td><td style=text-align:left><code>Place a shared lock. More than one process may hold a shared lock for a given file at a given time.</code></td></tr><tr><td style=text-align:left><code>LOCK_EX</code></td><td style=text-align:left><code>Place an exclusive lock. Only one process may hold an exclusive lock for a given file at a given time.</code></td></tr><tr><td style=text-align:left><code>LOCK_UN</code></td><td style=text-align:left><code>Remove an existing lock held by this process.</code></td></tr></tbody></table></div><ul><li>如果另一个进程持有不兼容的锁，则调用 <code>flock()</code> 可能会阻塞。要发出非阻塞请求，在上述任何操作中包含 <code>LOCK_NB（通过 ORing）</code>。</li><li>单个文件一般不会同时拥有共享锁和排他锁。</li><li>由 <code>flock()</code> 创建的锁与<code>打开的文件表条目相（open file table entry）</code>关联。这意味着重复的文件描述符（例如，由 <code>fork(2)</code> 或 <code>dup(2)</code> 创建）引用同一个锁，并且可以使用这些描述符中的任何一个来修改或释放该锁。此外，通过对这些重复描述符中的任何一个执行显式 <code>LOCK_UN</code> 操作或在所有此类描述符已关闭时释放锁。</li><li>如果一个进程使用 <code>open(2)</code> （或类似方法）为同一个文件获取多个描述符，这些描述符将由 <code>flock()</code> 独立处理。</li><li>一个进程只能在文件上持有一种类型的锁（共享或独占）。对已锁定文件的后续 <code>flock()</code> 调用会将现有锁定转换为新锁定模式。</li><li>由 <code>flock()</code> 创建的锁在 <code>execve(2)</code> 中被保留。</li><li>无论打开文件的模式如何，都可以在文件上放置共享锁或排他锁。</li></ul><h3 id=-返回值和错误><a href=#-返回值和错误 class=anchor-link><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512" class="icon anchor-icon"><path d="M326.612 185.391c59.747 59.809 58.927 155.698.36 214.59-.11.12-.24.25-.36.37l-67.2 67.2c-59.27 59.27-155.699 59.262-214.96.0-59.27-59.26-59.27-155.7.0-214.96l37.106-37.106c9.84-9.84 26.786-3.3 27.294 10.606.648 17.722 3.826 35.527 9.69 52.721 1.986 5.822.567 12.262-3.783 16.612l-13.087 13.087c-28.026 28.026-28.905 73.66-1.155 101.96 28.024 28.579 74.086 28.749 102.325.51l67.2-67.19c28.191-28.191 28.073-73.757.0-101.83-3.701-3.694-7.429-6.564-10.341-8.569a16.037 16.037.0 01-6.947-12.606c-.396-10.567 3.348-21.456 11.698-29.806l21.054-21.055c5.521-5.521 14.182-6.199 20.584-1.731a152.482 152.482.0 0120.522 17.197zM467.547 44.449c-59.261-59.262-155.69-59.27-214.96.0l-67.2 67.2c-.12.12-.25.25-.36.37-58.566 58.892-59.387 154.781.36 214.59a152.454 152.454.0 0020.521 17.196c6.402 4.468 15.064 3.789 20.584-1.731l21.054-21.055c8.35-8.35 12.094-19.239 11.698-29.806a16.037 16.037.0 00-6.947-12.606c-2.912-2.005-6.64-4.875-10.341-8.569-28.073-28.073-28.191-73.639.0-101.83l67.2-67.19c28.239-28.239 74.3-28.069 102.325.51 27.75 28.3 26.872 73.934-1.155 101.96l-13.087 13.087c-4.35 4.35-5.769 10.79-3.783 16.612 5.864 17.194 9.042 34.999 9.69 52.721.509 13.906 17.454 20.446 27.294 10.606l37.106-37.106c59.271-59.259 59.271-155.699.001-214.959z"/></svg></a><a href=#contents:-返回值和错误 class=headings># 返回值和错误</a></h3><p>成功时，返回零;出错时，返回 -1，并适当设置 errno。<br>错误内容如下：</p><div class=table-container><table><thead><tr><th style=text-align:left><strong>Error Code</strong></th><th style=text-align:left><strong>Description</strong></th></tr></thead><tbody><tr><td style=text-align:left><code>EBADF</code></td><td style=text-align:left><code>d is not a not an open file descriptor.</code></td></tr><tr><td style=text-align:left><code>EINTR</code></td><td style=text-align:left><code>While waiting to acquire a lock, the call was interrupted by delivery of a signal caught by a handler.</code></td></tr><tr><td style=text-align:left><code>EINVAL</code></td><td style=text-align:left><code>operation is invalid.</code></td></tr><tr><td style=text-align:left><code>ENOLCK</code></td><td style=text-align:left><code>The kernel ran out of memory for allocating lock records.</code></td></tr><tr><td style=text-align:left><code>EWOULDBLOCK</code></td><td style=text-align:left><code>The file is locked and the LOCK_NB flag was selected.</code></td></tr></tbody></table></div><h3 id=-其他><a href=#-其他 class=anchor-link><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512" class="icon anchor-icon"><path d="M326.612 185.391c59.747 59.809 58.927 155.698.36 214.59-.11.12-.24.25-.36.37l-67.2 67.2c-59.27 59.27-155.699 59.262-214.96.0-59.27-59.26-59.27-155.7.0-214.96l37.106-37.106c9.84-9.84 26.786-3.3 27.294 10.606.648 17.722 3.826 35.527 9.69 52.721 1.986 5.822.567 12.262-3.783 16.612l-13.087 13.087c-28.026 28.026-28.905 73.66-1.155 101.96 28.024 28.579 74.086 28.749 102.325.51l67.2-67.19c28.191-28.191 28.073-73.757.0-101.83-3.701-3.694-7.429-6.564-10.341-8.569a16.037 16.037.0 01-6.947-12.606c-.396-10.567 3.348-21.456 11.698-29.806l21.054-21.055c5.521-5.521 14.182-6.199 20.584-1.731a152.482 152.482.0 0120.522 17.197zM467.547 44.449c-59.261-59.262-155.69-59.27-214.96.0l-67.2 67.2c-.12.12-.25.25-.36.37-58.566 58.892-59.387 154.781.36 214.59a152.454 152.454.0 0020.521 17.196c6.402 4.468 15.064 3.789 20.584-1.731l21.054-21.055c8.35-8.35 12.094-19.239 11.698-29.806a16.037 16.037.0 00-6.947-12.606c-2.912-2.005-6.64-4.875-10.341-8.569-28.073-28.073-28.191-73.639.0-101.83l67.2-67.19c28.239-28.239 74.3-28.069 102.325.51 27.75 28.3 26.872 73.934-1.155 101.96l-13.087 13.087c-4.35 4.35-5.769 10.79-3.783 16.612 5.864 17.194 9.042 34.999 9.69 52.721.509 13.906 17.454 20.446 27.294 10.606l37.106-37.106c59.271-59.259 59.271-155.699.001-214.959z"/></svg></a><a href=#contents:-其他 class=headings># 其他</a></h3><ul><li><code>flock(2)</code> 不会通过 <code>NFS</code> 锁定文件。请改用 <code>fcntl(2)</code>：它可以在 <code>NFS</code> 上运行。</li><li>从内核 <code>2.0</code> 开始，<code>flock(2)</code> 本身作为系统调用实现，而不是在 <code>GNU C</code> 库中模拟为对 <code>fcntl(2)</code> 的调用。<code>flock(2)</code> 和 <code>fcntl(2)</code> 放置的锁类型之间没有交互，<code>flock(2)</code> 不会检测到死锁。</li><li><code>flock(2)</code> 仅设置协同锁；给文件适当的权限，进程可以忽略 <code>flock(2)</code> 的使用并对文件正常执行<code>I/O</code>操作。</li><li>对于 <code>forked进程</code> 和 <code>dup(2)</code>，<code>flock(2)</code> 和 <code>fcntl(2)</code> 锁具有不同的语义。在使用 <code>fcntl()</code> 实现 <code>flock()</code> 的系统上，<code>flock()</code> 的语义与本文<code>描述</code>部分不同。</li><li>转换锁（共享到独占，反之亦然）不能保证是原子的：先移除现有锁，然后建立新锁。在这两个步骤之间，可能会授予另一个进程的挂起锁请求，如果指定了 <code>LOCK_NB</code>，则转换要么阻塞，要么失败。</li></ul><h2 id=-其他-1><a href=#-其他-1 class=anchor-link><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512" class="icon anchor-icon"><path d="M326.612 185.391c59.747 59.809 58.927 155.698.36 214.59-.11.12-.24.25-.36.37l-67.2 67.2c-59.27 59.27-155.699 59.262-214.96.0-59.27-59.26-59.27-155.7.0-214.96l37.106-37.106c9.84-9.84 26.786-3.3 27.294 10.606.648 17.722 3.826 35.527 9.69 52.721 1.986 5.822.567 12.262-3.783 16.612l-13.087 13.087c-28.026 28.026-28.905 73.66-1.155 101.96 28.024 28.579 74.086 28.749 102.325.51l67.2-67.19c28.191-28.191 28.073-73.757.0-101.83-3.701-3.694-7.429-6.564-10.341-8.569a16.037 16.037.0 01-6.947-12.606c-.396-10.567 3.348-21.456 11.698-29.806l21.054-21.055c5.521-5.521 14.182-6.199 20.584-1.731a152.482 152.482.0 0120.522 17.197zM467.547 44.449c-59.261-59.262-155.69-59.27-214.96.0l-67.2 67.2c-.12.12-.25.25-.36.37-58.566 58.892-59.387 154.781.36 214.59a152.454 152.454.0 0020.521 17.196c6.402 4.468 15.064 3.789 20.584-1.731l21.054-21.055c8.35-8.35 12.094-19.239 11.698-29.806a16.037 16.037.0 00-6.947-12.606c-2.912-2.005-6.64-4.875-10.341-8.569-28.073-28.073-28.191-73.639.0-101.83l67.2-67.19c28.239-28.239 74.3-28.069 102.325.51 27.75 28.3 26.872 73.934-1.155 101.96l-13.087 13.087c-4.35 4.35-5.769 10.79-3.783 16.612 5.864 17.194 9.042 34.999 9.69 52.721.509 13.906 17.454 20.446 27.294 10.606l37.106-37.106c59.271-59.259 59.271-155.699.001-214.959z"/></svg></a><a href=#contents:-其他-1 class=headings># 其他</a></h2><h3 id=-参考内容><a href=#-参考内容 class=anchor-link><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512" class="icon anchor-icon"><path d="M326.612 185.391c59.747 59.809 58.927 155.698.36 214.59-.11.12-.24.25-.36.37l-67.2 67.2c-59.27 59.27-155.699 59.262-214.96.0-59.27-59.26-59.27-155.7.0-214.96l37.106-37.106c9.84-9.84 26.786-3.3 27.294 10.606.648 17.722 3.826 35.527 9.69 52.721 1.986 5.822.567 12.262-3.783 16.612l-13.087 13.087c-28.026 28.026-28.905 73.66-1.155 101.96 28.024 28.579 74.086 28.749 102.325.51l67.2-67.19c28.191-28.191 28.073-73.757.0-101.83-3.701-3.694-7.429-6.564-10.341-8.569a16.037 16.037.0 01-6.947-12.606c-.396-10.567 3.348-21.456 11.698-29.806l21.054-21.055c5.521-5.521 14.182-6.199 20.584-1.731a152.482 152.482.0 0120.522 17.197zM467.547 44.449c-59.261-59.262-155.69-59.27-214.96.0l-67.2 67.2c-.12.12-.25.25-.36.37-58.566 58.892-59.387 154.781.36 214.59a152.454 152.454.0 0020.521 17.196c6.402 4.468 15.064 3.789 20.584-1.731l21.054-21.055c8.35-8.35 12.094-19.239 11.698-29.806a16.037 16.037.0 00-6.947-12.606c-2.912-2.005-6.64-4.875-10.341-8.569-28.073-28.073-28.191-73.639.0-101.83l67.2-67.19c28.239-28.239 74.3-28.069 102.325.51 27.75 28.3 26.872 73.934-1.155 101.96l-13.087 13.087c-4.35 4.35-5.769 10.79-3.783 16.612 5.864 17.194 9.042 34.999 9.69 52.721.509 13.906 17.454 20.446 27.294 10.606l37.106-37.106c59.271-59.259 59.271-155.699.001-214.959z"/></svg></a><a href=#contents:-参考内容 class=headings># 参考内容</a></h3><p>本文内容参考自：</p><ul><li><a href="https://www.baeldung.com/linux/file-locking#:~:text=Introduction%20to%20flock%20Command,or%20on%20the%20command%20line." target=_blank rel=noopener>Introduction to File Locking in Linux</a></li><li><a href=https://manpages.ubuntu.com/manpages/xenial/man1/flock.1.html target=_blank rel=noopener>flock常见使用示例</a></li><li><a href=https://stackoverflow.com/questions/24388009/linux-flock-how-to-just-lock-a-file target=_blank rel=noopener>flock和文件描述符结合使用</a></li><li><a href=https://wiki.bash-hackers.org/howto/mutex target=_blank rel=noopener>Lock your script (against parallel execution)</a></li><li><a href=https://apenwarr.ca/log/20101213 target=_blank rel=noopener>Everything you never wanted to know about file locking</a></li><li><a href=https://en.wikipedia.org/wiki/File_locking target=_blank rel=noopener>wikipedia file locking</a></li><li><a href=http://www.tutorialspoint.com/unix_system_calls/flock.htm target=_blank rel=noopener>flock() - Unix, Linux System Call</a></li></ul></div></article><div class=updated-badge-container><span title="Updated @ 2022-06-15 22:53:59 CST" style=cursor:help><svg xmlns="http://www.w3.org/2000/svg" width="130" height="20" class="updated-badge"><linearGradient id="b" x2="0" y2="100%"><stop offset="0" stop-color="#bbb" stop-opacity=".1"/><stop offset="1" stop-opacity=".1"/></linearGradient><clipPath id="a"><rect width="130" height="20" rx="3" fill="#fff"/></clipPath><g clip-path="url(#a)"><path class="updated-badge-left" d="M0 0h55v20H0z"/><path class="updated-badge-right" d="M55 0h75v20H55z"/><path fill="url(#b)" d="M0 0h130v20H0z"/></g><g fill="#fff" text-anchor="middle" font-size="110"><text x="285" y="150" fill="#010101" fill-opacity=".3" textLength="450" transform="scale(.1)">updated</text><text x="285" y="140" textLength="450" transform="scale(.1)">updated</text><text x="915" y="150" fill="#010101" fill-opacity=".3" textLength="650" transform="scale(.1)">2022-06-15</text><text x="915" y="140" textLength="650" transform="scale(.1)">2022-06-15</text></g></svg></span></div><div class=post-tags><a href=/tags/linux/ rel=tag class=post-tags-link><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512" class="icon tag-icon"><path d="M0 252.118V48C0 21.49 21.49.0 48 0h204.118a48 48 0 0133.941 14.059l211.882 211.882c18.745 18.745 18.745 49.137.0 67.882L293.823 497.941c-18.745 18.745-49.137 18.745-67.882.0L14.059 286.059A48 48 0 010 252.118zM112 64c-26.51.0-48 21.49-48 48s21.49 48 48 48 48-21.49 48-48-21.49-48-48-48z"/></svg>linux</a>
<a href=/tags/lock/ rel=tag class=post-tags-link><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512" class="icon tag-icon"><path d="M0 252.118V48C0 21.49 21.49.0 48 0h204.118a48 48 0 0133.941 14.059l211.882 211.882c18.745 18.745 18.745 49.137.0 67.882L293.823 497.941c-18.745 18.745-49.137 18.745-67.882.0L14.059 286.059A48 48 0 010 252.118zM112 64c-26.51.0-48 21.49-48 48s21.49 48 48 48 48-21.49 48-48-21.49-48-48-48z"/></svg>lock</a>
<a href=/tags/flock/ rel=tag class=post-tags-link><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512" class="icon tag-icon"><path d="M0 252.118V48C0 21.49 21.49.0 48 0h204.118a48 48 0 0133.941 14.059l211.882 211.882c18.745 18.745 18.745 49.137.0 67.882L293.823 497.941c-18.745 18.745-49.137 18.745-67.882.0L14.059 286.059A48 48 0 010 252.118zM112 64c-26.51.0-48 21.49-48 48s21.49 48 48 48 48-21.49 48-48-21.49-48-48-48z"/></svg>flock</a></div><ul class=post-nav><li class=post-nav-next><a href=/tech/basics/bash/%E6%96%87%E4%BB%B6%E6%8F%8F%E8%BF%B0%E7%AC%A6%E6%9A%82%E5%AD%98%E5%86%85%E5%AE%B9/ rel=next>文件描述符暂存内容 ></a></li></ul><div class=load-comments><div id=load-comments>加载评论</div></div><div id=vcomments></div></div></main><div id=back-to-top class=back-to-top><a href=#><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512" class="icon arrow-up"><path d="M34.9 289.5l-22.2-22.2c-9.4-9.4-9.4-24.6.0-33.9L207 39c9.4-9.4 24.6-9.4 33.9.0l194.3 194.3c9.4 9.4 9.4 24.6.0 33.9L413 289.4c-9.5 9.5-25 9.3-34.3-.4L264 168.6V456c0 13.3-10.7 24-24 24h-32c-13.3.0-24-10.7-24-24V168.6L69.2 289.1c-9.3 9.8-24.8 10-34.3.4z"/></svg></a></div><footer id=footer class=footer><div class=footer-inner><div class=site-info>©&nbsp;2022–2022&nbsp;<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512" class="icon footer-icon"><path d="M462.3 62.6C407.5 15.9 326 24.3 275.7 76.2L256 96.5l-19.7-20.3C186.1 24.3 104.5 15.9 49.7 62.6c-62.8 53.6-66.1 149.8-9.9 207.9l193.5 199.8c12.5 12.9 32.8 12.9 45.3.0l193.5-199.8c56.3-58.1 53-154.3-9.8-207.9z"/></svg>&nbsp;newiur</div><div class=busuanzi-site-uv-and-pv><span id=busuanzi_container_site_uv>本站访客数&nbsp;<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512" class="icon busuanzi-site-uv"><path d="M224 256c70.7.0 128-57.3 128-128S294.7.0 224 0 96 57.3 96 128s57.3 128 128 128zm89.6 32h-16.7c-22.2 10.2-46.9 16-72.9 16s-50.6-5.8-72.9-16h-16.7C60.2 288 0 348.2.0 422.4V464c0 26.5 21.5 48 48 48h352c26.5.0 48-21.5 48-48v-41.6c0-74.2-60.2-134.4-134.4-134.4z"/></svg>&nbsp;<span id=busuanzi_value_site_uv></span></span>&nbsp;|&nbsp;<span id=busuanzi_container_site_pv>本站访问量&nbsp;<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 576 512" class="icon busuanzi-site-pv"><path d="M288 144a110.94 110.94.0 00-31.24 5 55.4 55.4.0 017.24 27 56 56 0 01-56 56 55.4 55.4.0 01-27-7.24A111.71 111.71.0 10288 144zm284.52 97.4C518.29 135.59 410.93 64 288 64S57.68 135.64 3.48 241.41a32.35 32.35.0 000 29.19C57.71 376.41 165.07 448 288 448s230.32-71.64 284.52-177.41a32.35 32.35.0 000-29.19zM288 4e2c-98.65.0-189.09-55-237.93-144C98.91 167 189.34 112 288 112s189.09 55 237.93 144C477.1 345 386.66 4e2 288 4e2z"/></svg>&nbsp;<span id=busuanzi_value_site_pv></span></span></div><script src=https://sdk.jinrishici.com/v2/browser/jinrishici.js></script>
<text class=poem_sentence></text>
<text class=poem_info></text>
<script type=text/javascript>jinrishici.load(function(e){var t=document.querySelector(".poem_sentence"),n=document.querySelector(".poem_info");t.innerHTML=e.data.content,n.innerHTML="—  "+e.data.origin.title})</script></div></footer></div><script>function loadComments(){if(!document.getElementById("vcomments"))return;if(typeof Valine=="undefined"){var e=t=>{var e=document.createElement("script");e.defer=!0,e.crossOrigin="anonymous",Object.keys(t).forEach(n=>{e[n]=t[n]}),document.body.appendChild(e)};e({src:"https://cdn.jsdelivr.net/npm/valine@1.4.14/dist/Valine.min.js",onload:()=>{newValine()}})}else newValine()}function newValine(){new Valine({el:"#vcomments",appId:"vcDuMPUhVRWqDQ1hhpoM0FkX-gzGzoHsz",appKey:"BuTIa6PLYnI1Po1eBldfdcT1",placeholder:"Just go go",path:location.pathname,avatar:"mm",meta:["nick","mail","link"],pageSize:10,lang:"zh-cn",visitor:!1,highlight:!0,avatarForce:!1,recordIP:!0,serverURLs:'',emojiCDN:'',emojiMaps:{},enableQQ:!1,requiredFields:[]})}</script><script src=https://cdn.jsdelivr.net/npm/medium-zoom@latest/dist/medium-zoom.min.js></script>
<script>let imgNodes=document.querySelectorAll("div.post-body img");imgNodes=Array.from(imgNodes).filter(e=>e.parentNode.tagName!=="A"),mediumZoom(imgNodes,{background:"hsla(var(--color-bg-h), var(--color-bg-s), var(--color-bg-l), 0.95)"})</script><script src=https://cdn.jsdelivr.net/npm/instant.page@5.1.0/instantpage.min.js type=module defer></script>
<script async src=https://busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js></script></body></html>