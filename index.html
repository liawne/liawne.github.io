<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width">
<meta name="theme-color" content="#222"><meta name="generator" content="Hexo 6.0.0">


  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png">
  <link rel="mask-icon" href="/images/logo.svg" color="#222">

<link rel="stylesheet" href="/css/main.css">



<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@5.15.4/css/all.min.css" integrity="sha256-mUZM63G8m73Mcidfrv5E+Y61y7a12O5mW4ezU3bxqW4=" crossorigin="anonymous">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/animate.css@3.1.1/animate.min.css" integrity="sha256-PR7ttpcvz8qrF57fur/yAx1qXMFJeJFiA6pSzWi0OIE=" crossorigin="anonymous">

<script class="next-config" data-name="main" type="application/json">{"hostname":"example.com","root":"/","images":"/images","scheme":"Muse","darkmode":false,"version":"8.10.0","exturl":false,"sidebar":{"position":"left","display":"post","padding":18,"offset":12},"copycode":false,"bookmark":{"enable":false,"color":"#222","save":"auto"},"mediumzoom":false,"lazyload":false,"pangu":false,"comments":{"style":"tabs","active":null,"storage":true,"lazyload":false,"nav":null},"stickytabs":false,"motion":{"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"fadeInDown","post_body":"fadeInDown","coll_header":"fadeInLeft","sidebar":"fadeInUp"}},"prism":false,"i18n":{"placeholder":"Searching...","empty":"We didn't find any results for the search: ${query}","hits_time":"${hits} results found in ${time} ms","hits":"${hits} results found"}}</script><script src="/js/config.js"></script>

    <meta property="og:type" content="website">
<meta property="og:title" content="Hexo">
<meta property="og:url" content="http://example.com/index.html">
<meta property="og:site_name" content="Hexo">
<meta property="og:locale" content="en_US">
<meta property="article:author" content="John Doe">
<meta name="twitter:card" content="summary">


<link rel="canonical" href="http://example.com/">



<script class="next-config" data-name="page" type="application/json">{"sidebar":"","isHome":true,"isPost":false,"lang":"en","comments":"","permalink":"","path":"index.html","title":""}</script>

<script class="next-config" data-name="calendar" type="application/json">""</script>
<title>Hexo</title>
  





  <noscript>
    <link rel="stylesheet" href="/css/noscript.css">
  </noscript>
</head>

<body itemscope itemtype="http://schema.org/WebPage" class="use-motion">
  <div class="headband"></div>

  <main class="main">
    <header class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-container">
  <div class="site-nav-toggle">
    <div class="toggle" aria-label="Toggle navigation bar" role="button">
    </div>
  </div>

  <div class="site-meta">

    <a href="/" class="brand" rel="start">
      <i class="logo-line"></i>
      <h1 class="site-title">Hexo</h1>
      <i class="logo-line"></i>
    </a>
  </div>

  <div class="site-nav-right">
    <div class="toggle popup-trigger">
    </div>
  </div>
</div>







</div>
        
  
  <div class="toggle sidebar-toggle" role="button">
    <span class="toggle-line"></span>
    <span class="toggle-line"></span>
    <span class="toggle-line"></span>
  </div>

  <aside class="sidebar">

    <div class="sidebar-inner sidebar-overview-active">
      <ul class="sidebar-nav">
        <li class="sidebar-nav-toc">
          Table of Contents
        </li>
        <li class="sidebar-nav-overview">
          Overview
        </li>
      </ul>

      <div class="sidebar-panel-container">
        <!--noindex-->
        <div class="post-toc-wrap sidebar-panel">
        </div>
        <!--/noindex-->

        <div class="site-overview-wrap sidebar-panel">
          <div class="site-author site-overview-item animated" itemprop="author" itemscope itemtype="http://schema.org/Person">
  <p class="site-author-name" itemprop="name">John Doe</p>
  <div class="site-description" itemprop="description"></div>
</div>
<div class="site-state-wrap site-overview-item animated">
  <nav class="site-state">
      <div class="site-state-item site-state-posts">
        <a href="/archives/">
          <span class="site-state-item-count">3</span>
          <span class="site-state-item-name">posts</span>
        </a>
      </div>
      <div class="site-state-item site-state-categories">
        <span class="site-state-item-count">1</span>
        <span class="site-state-item-name">categories</span>
      </div>
      <div class="site-state-item site-state-tags">
        <span class="site-state-item-count">3</span>
        <span class="site-state-item-name">tags</span>
      </div>
  </nav>
</div>



        </div>
      </div>
    </div>
  </aside>
  <div class="sidebar-dimmer"></div>


    </header>

    
  <div class="back-to-top" role="button" aria-label="Back to top">
    <i class="fa fa-arrow-up"></i>
    <span>0%</span>
  </div>

<noscript>
  <div class="noscript-warning">Theme NexT works best with JavaScript enabled</div>
</noscript>


    <div class="main-inner index posts-expand">

    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="http://example.com/2022/03/05/ansible%E5%AD%A6%E4%B9%A0/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="John Doe">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Hexo">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2022/03/05/ansible%E5%AD%A6%E4%B9%A0/" class="post-title-link" itemprop="url">ansible学习</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">Posted on</span>
      

      <time title="Created: 2022-03-05 12:07:21 / Modified: 13:02:44" itemprop="dateCreated datePublished" datetime="2022-03-05T12:07:21+08:00">2022-03-05</time>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <h1 id="learning-ansible"><a href="#learning-ansible" class="headerlink" title="learning ansible"></a>learning ansible</h1><h3 id="本文内容参考自朱双印ansible笔记"><a href="#本文内容参考自朱双印ansible笔记" class="headerlink" title="本文内容参考自朱双印ansible笔记"></a>本文内容参考自<a target="_blank" rel="noopener" href="https://www.zsythink.net/archives/2481">朱双印ansible笔记</a></h3><h3 id="2021-07-03-配置主机清单"><a href="#2021-07-03-配置主机清单" class="headerlink" title="2021-07-03 配置主机清单"></a>2021-07-03 配置主机清单</h3><h4 id="ini方式"><a href="#ini方式" class="headerlink" title="# ini方式"></a># ini方式</h4><figure class="highlight ini"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 1,如下示例:</span></span><br><span class="line"><span class="section">[ctl]</span></span><br><span class="line">10.168.0.2</span><br><span class="line">10.168.0.3</span><br><span class="line">10.168.0.4</span><br><span class="line"></span><br><span class="line"><span class="section">[nova:children]</span></span><br><span class="line">ctl</span><br><span class="line"></span><br><span class="line"><span class="section">[nova-compute:children]</span></span><br><span class="line">nova</span><br></pre></td></tr></table></figure>
<h4 id="yaml方式"><a href="#yaml方式" class="headerlink" title="#  yaml方式"></a>#  yaml方式</h4><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 1,如下示例:</span></span><br><span class="line"><span class="attr">all:</span></span><br><span class="line">  <span class="attr">children:</span></span><br><span class="line">    <span class="attr">k8s:</span></span><br><span class="line">      <span class="attr">hosts:</span></span><br><span class="line">        <span class="attr">master:</span></span><br><span class="line">          <span class="attr">ansible_host:</span> <span class="number">192.168</span><span class="number">.110</span><span class="number">.11</span></span><br><span class="line">          <span class="attr">ansible_port:</span> <span class="number">22</span></span><br><span class="line">          <span class="attr">ansible_user:</span> <span class="string">root</span></span><br><span class="line">          <span class="attr">ansible_pass:</span> <span class="string">&#x27;123.com&#x27;</span></span><br><span class="line">        <span class="attr">node2:</span></span><br><span class="line">          <span class="attr">ansible_host:</span> <span class="number">192.168</span><span class="number">.110</span><span class="number">.22</span></span><br><span class="line">          <span class="attr">ansible_port:</span> <span class="number">22</span></span><br><span class="line">          <span class="attr">ansible_user:</span> <span class="string">root</span></span><br><span class="line">          <span class="attr">ansible_pass:</span> <span class="string">&#x27;123.com&#x27;</span></span><br><span class="line">        <span class="attr">node3:</span></span><br><span class="line">          <span class="attr">ansible_host:</span> <span class="number">192.168</span><span class="number">.110</span><span class="number">.33</span></span><br><span class="line">          <span class="attr">ansible_port:</span> <span class="number">22</span></span><br><span class="line">          <span class="attr">ansible_user:</span> <span class="string">root</span></span><br><span class="line">          <span class="attr">ansible_pass:</span> <span class="string">&#x27;123.com&#x27;</span></span><br></pre></td></tr></table></figure>

<h3 id="2021-07-03-常用模块"><a href="#2021-07-03-常用模块" class="headerlink" title="2021-07-03 常用模块"></a>2021-07-03 常用模块</h3><h4 id="文件类操作"><a href="#文件类操作" class="headerlink" title="#  文件类操作"></a>#  文件类操作</h4><p>1,copy: 将ansible主机上的文件拷贝至远端主机</p>
<ul>
<li>同fetch类似,不过操作动作相反,fetch是从远端主机拿文件到ansible主机</li>
<li>可使用content直接代替src</li>
<li>可备份远端重名文件</li>
<li>可设定拷贝文件的权限</li>
</ul>
<p>2,file: 完成一些对文件的基本操作,包括创建,删除,修改文件和目录的权限等</p>
<ul>
<li>path是必须项,需要和state结合使用</li>
<li>state参数是核心,对不同类型的文件对应的动作不相同,path如果是文件(touch),是目录(directory); absent时不用管path是什么(目录或者文件)</li>
</ul>
<p>3,blockinfile: 在文件中插入一段文本,这段文本是被标记过的,方便我们后面对标记内容的操作(删除,修改等)</p>
<ul>
<li>对文件中块的操作,文件位置定位使用insertbefore,insertafter</li>
<li>使用block&#x2F;content制定块内容</li>
<li>使用该模块marker会在插入内容前后增加marker内容</li>
<li>可使用regex,匹配文件中内容进行操作</li>
<li>包含backup相关内容</li>
</ul>
<p>4,lineinfile: 确保某一行文本存在于文件中,或不存在与文本中,可使用regex进行替换</p>
<ul>
<li>line指定行内容</li>
<li>包含regex参数,使用regex来匹配相应的行,当替换文本时，如果有多行文本都能被匹配，则只有最后面被匹配到的那行文本才会被替换，当删除文本时，如果有多行文本都能被匹配，这么这些行都会被删除</li>
<li>backrefs参数：默认情况下，当根据正则替换文本时，即使regexp参数中的正则存在分组，在line参数中也不能对正则中的分组进行引用，除非将backrefs参数的值设置为yes</li>
<li>插入内容为insertbefore,insertafter, 包含backup相关内容</li>
</ul>
<p>5,find: 类似find命令,可在远端机器中找到相应文件</p>
<ul>
<li>使用方式ansible-doc -s find查看</li>
</ul>
<p>6,replace: replace模块可以根据我们指定的正则表达式替换文件中的字符串，文件中所有被正则匹配到的字符串都会被替换</p>
<ul>
<li>使用方式ansible-doc -s replace查看</li>
</ul>
<h4 id="命令类操作"><a href="#命令类操作" class="headerlink" title="#  命令类操作"></a>#  命令类操作</h4><p>1,command: 在远端主机上执行命令</p>
<ul>
<li>使用command模块在远程主机中执行命令时，不会经过远程主机的shell处理，在使用command模块时，如果需要执行的命令中含有重定向、管道符等操作时，这些符号也会失效，比如”&lt;“, “&gt;”, “|”, “;” 和 “&amp;” 这些符号，如果你需要这些功能，需要使用shell模块</li>
<li>具体使用方式,参考ansible-doc -s command</li>
</ul>
<p>2,shell: 在远端主机上执行命令,与command不同的是,shell模块在远端执行命令时,会经过远端主机的&#x2F;bin&#x2F;sh程序处理</p>
<ul>
<li>具体使用方式,参考ansible-doc -s shell</li>
</ul>
<p>3,scripts: 在远端主机上执行ansible主机上的脚本,脚本在ansible主机上,不需要拷贝到远端主机</p>
<ul>
<li>具体使用方式,参考ansible-doc -s scripts</li>
</ul>
<h4 id="系统类操作"><a href="#系统类操作" class="headerlink" title="#  系统类操作"></a>#  系统类操作</h4><p>1,cron: 管理远端主机上的定时任务,功能同crontab</p>
<ul>
<li>具体使用方式,参考ansible-doc -s cron</li>
</ul>
<p>2,service: 管理远端主机上的服务</p>
<ul>
<li>具体使用方式,参考ansible-doc -s service</li>
</ul>
<p>3,user: 管理远端主机上的用户,类似命令usermod</p>
<ul>
<li>还可以管理用户的ssh密钥</li>
<li>具体使用方式,参考ansible-doc -s user</li>
</ul>
<p>4,groupo: 管理远端主机上的组,类似命令groupmod</p>
<ul>
<li>具体使用方式,参考ansible-doc -s group</li>
</ul>
<h4 id="包管理类操作"><a href="#包管理类操作" class="headerlink" title="#  包管理类操作"></a>#  包管理类操作</h4><p>1,yum_repository: 管理远端主机上的yum仓库</p>
<ul>
<li>具体使用方式,参考ansible-doc -s yum_repository</li>
</ul>
<p>1,yum: 通过远端主机上的yum管理软件包</p>
<ul>
<li>具体使用方式,参考ansible-doc -s yum</li>
</ul>
<h3 id="2021-07-03-认识ansible-playbook"><a href="#2021-07-03-认识ansible-playbook" class="headerlink" title="2021-07-03 认识ansible-playbook"></a>2021-07-03 认识ansible-playbook</h3><p>1,ansible-playbook的使用,可以理解为ansible -m <module_name> -a ‘xxxx’的转换,将命令行使用模块操作的内容写成脚本内容,按照脚本内容完成相关操作<br>2,上述脚本在ansible-playbook中称作为’playbook’,即剧本</p>
<ul>
<li>每个playbook(剧本)又多个play(桥段)组成,每个剧本是由多个桥段组成的,每个桥段包含有人物,场景,故事</li>
<li>每个play在执行时,都会执行一个默认任务(‘Gathering Facts),任务会收集当前当前play对应的目标主机的相关信息(IP,hostname,硬件版本,系统版本等),收集完成后才会完成我们定义的相关任务<br>3,ansible有个重要特性:幂等性</li>
<li>在ansible调用模块或者ansible-playbook执行相应play时,输出内容会有颜色区分,黄色表示有修改,绿色表示么有修改;区别是远端的内容是否满足我们的预期</li>
<li>ansible是”以结果为导向的”，我们指定了一个”目标状态”，ansible会自动判断，”当前状态”是否与”目标状态”一致，如果一致，则不进行任何操作，如果不一致，那么就将”当前状态”变成”目标状态”，这就是”幂等性”，”幂等性”可以保证我们重复的执行同一项操作时，得到的结果是一样的</li>
</ul>
<h3 id="2021-07-03-使用handlers"><a href="#2021-07-03-使用handlers" class="headerlink" title="2021-07-03 使用handlers"></a>2021-07-03 使用handlers</h3><p>1,handlers的使用场景:</p>
<ul>
<li>有个任务需要修改nginx的配置文件,将listen端口由8080改为8088,使用handler可以在nginx配置文件有修改的环境上重启nginx,没有修改的不会出发重启nginx</li>
<li>handlers可以理解为另一种tasks,handlers是另一种’任务列表’,handlers中的任务会被tasks中的任务调用;</li>
<li>handlers被调用并不一定会执行,只有当tasks中的任务真正被执行后(真正的进行了实际操作,造成了实际变化),handlers中的任务才会真正执行</li>
<li>如果tasks中的任务并没有作出任何实际的操作,那么handlers中的任务即使被调用,也不会执行</li>
<li>handlers和tasks是平级的,所以缩进相同</li>
</ul>
<p>2,handlers的调用:</p>
<ul>
<li>handlers需要被关键字notify调用<br>如下示例:<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="bullet">-</span> <span class="attr">hosts:</span> <span class="string">all</span></span><br><span class="line">  <span class="attr">remote_user:</span> <span class="string">root</span></span><br><span class="line">  <span class="attr">tasks:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">change</span> <span class="string">nginx</span> <span class="string">configuration</span></span><br><span class="line">    <span class="attr">lineinfile:</span></span><br><span class="line">      <span class="string">path=/etc/nginx/conf.d/test.conf</span></span><br><span class="line">      <span class="string">regexp=&quot;listen(.*)</span> <span class="number">8080</span><span class="string">(.*)&quot;</span></span><br><span class="line">      <span class="string">line=&quot;listen\1</span> <span class="number">8088</span><span class="string">\2&quot;</span></span><br><span class="line">      <span class="string">backrefs=yes</span></span><br><span class="line">      <span class="string">backup=yes</span></span><br><span class="line">    <span class="attr">notify:</span></span><br><span class="line">      <span class="string">restart</span> <span class="string">nginx</span></span><br><span class="line"></span><br><span class="line">  <span class="attr">handlers:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">restart</span> <span class="string">nginx</span></span><br><span class="line">    <span class="attr">service:</span></span><br><span class="line">      <span class="string">name=nginx</span></span><br><span class="line">      <span class="string">state=restarted</span> </span><br></pre></td></tr></table></figure></li>
</ul>
<p>3,handlers中可以有多个任务,被tasks中不同的任务调用</p>
<ul>
<li>handler执行的顺序与handler在playbook中定义的顺序相同,与handler被notify的顺序无关(下述内容ht1先触发,ht2后触发),如下示例:<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="bullet">-</span> <span class="attr">hosts:</span> <span class="string">all</span></span><br><span class="line">  <span class="attr">remote_user:</span> <span class="string">root</span></span><br><span class="line">  <span class="attr">tasks:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">make</span> <span class="string">testfile1</span></span><br><span class="line">    <span class="attr">file:</span></span><br><span class="line">      <span class="string">path=/testdir/testfile1</span></span><br><span class="line">      <span class="string">state=directory</span></span><br><span class="line">    <span class="attr">notify:</span> <span class="string">ht2</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">make</span> <span class="string">testfile2</span></span><br><span class="line">    <span class="attr">file:</span></span><br><span class="line">      <span class="string">path=/testdir/testfile2</span></span><br><span class="line">      <span class="string">state=directory</span></span><br><span class="line">    <span class="attr">notify:</span> <span class="string">ht1</span></span><br><span class="line"></span><br><span class="line">  <span class="attr">handlers:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">ht1</span></span><br><span class="line">    <span class="attr">file:</span></span><br><span class="line">      <span class="string">path=/testdir/ht1</span></span><br><span class="line">      <span class="string">state=touch</span></span><br><span class="line">  </span><br><span class="line">  <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">ht2</span></span><br><span class="line">    <span class="attr">file:</span></span><br><span class="line">      <span class="string">path=/testdir/ht2</span></span><br><span class="line">      <span class="string">state=touch</span></span><br></pre></td></tr></table></figure></li>
<li>默认情况下,所有tasks执行完成后,才会执行各个handlers</li>
<li>当存在多个同名的handler时,只会执行一个handler</li>
</ul>
<p>4,若要在执行完某个task后立即执行其对应的handler,需要使用meta模块</p>
<ul>
<li>如下示例:<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="bullet">-</span> <span class="attr">hosts:</span> <span class="string">all</span></span><br><span class="line">  <span class="attr">remote_user:</span> <span class="string">root</span></span><br><span class="line">  <span class="attr">tasks:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">task1</span></span><br><span class="line">    <span class="attr">file:</span> </span><br><span class="line">      <span class="string">path=/testdir/testfile</span></span><br><span class="line">      <span class="string">state=touch</span></span><br><span class="line">    <span class="attr">notify:</span> <span class="string">handler1</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">task2</span></span><br><span class="line">    <span class="attr">file:</span></span><br><span class="line">      <span class="string">path=/testdir/testfile2</span></span><br><span class="line">      <span class="string">state=touch</span></span><br><span class="line">    <span class="attr">notify:</span> <span class="string">handler2</span></span><br><span class="line"></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">meta:</span> <span class="string">flush</span> <span class="string">handlers</span></span><br><span class="line"></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">task3</span></span><br><span class="line">    <span class="attr">file:</span></span><br><span class="line">      <span class="string">path=/testdir/testfile3</span></span><br><span class="line">      <span class="string">state=touch</span></span><br><span class="line">    <span class="attr">notify:</span> <span class="string">handler3</span></span><br><span class="line"></span><br><span class="line">  <span class="attr">handlers:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">handler1</span></span><br><span class="line">    <span class="attr">file:</span></span><br><span class="line">      <span class="string">path=/testdir/hd1</span></span><br><span class="line">      <span class="string">state=touch</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">handler2</span></span><br><span class="line">    <span class="attr">file:</span></span><br><span class="line">      <span class="string">path=/testdir/hd2</span></span><br><span class="line">      <span class="string">state=touch</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">handler3</span></span><br><span class="line">    <span class="attr">file:</span></span><br><span class="line">      <span class="string">path=/testdir/hd3</span></span><br><span class="line">      <span class="string">state=touch</span></span><br></pre></td></tr></table></figure></li>
<li>meta可以理解为tasks下一个特殊任务,使用的是meta模块</li>
<li>meta: flush_handlers指的是立即执行之前的task对应的handlers,上述例子中flush_handlers之前有两个task,在执行了这两个task之后立即执行他们对应的handler</li>
<li>使用meta配合task和handler,可以让任务调用更加灵活</li>
</ul>
<p>5,如果需要一次性notify多个handler,需要使用到listen</p>
<ul>
<li>可以把’listen’理解为’组名’,可以把多个handler分成’组’,当我们需要一次性notify多个handler时,只要将多个handler分成一组,使用相同的组名即可</li>
<li>如下示例:<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="bullet">-</span> <span class="attr">hosts:</span> <span class="string">all</span></span><br><span class="line">  <span class="attr">remote_user:</span> <span class="string">root</span></span><br><span class="line">  <span class="attr">tasks:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">task1</span></span><br><span class="line">    <span class="attr">file:</span> </span><br><span class="line">      <span class="string">path=/testdir/testfile</span></span><br><span class="line">      <span class="string">state=touch</span></span><br><span class="line">    <span class="attr">notify:</span> <span class="string">handler</span> <span class="string">group1</span></span><br><span class="line"></span><br><span class="line">  <span class="attr">handlers:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">handler1</span></span><br><span class="line">    <span class="attr">listen:</span> <span class="string">&#x27;handler group1&#x27;</span></span><br><span class="line">    <span class="attr">shell:</span> <span class="string">&#x27;echo handler1&#x27;</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">handler2</span></span><br><span class="line">    <span class="attr">listen:</span> <span class="string">&#x27;handler group1&#x27;</span></span><br><span class="line">    <span class="attr">shell:</span> <span class="string">&#x27;echo handler2&#x27;</span></span><br></pre></td></tr></table></figure></li>
</ul>
<h3 id="2021-07-03-使用tags"><a href="#2021-07-03-使用tags" class="headerlink" title="2021-07-03 使用tags"></a>2021-07-03 使用tags</h3><p>1,写了一个很长的playbook,在调试时只想跑其中很少的一部分,tag在这种场景下可以使用,指定执行哪些任务,不执行哪些任务</p>
<ul>
<li>如下示例:<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="bullet">-</span> <span class="attr">hosts:</span> <span class="string">all</span></span><br><span class="line">  <span class="attr">remote_user:</span> <span class="string">root</span></span><br><span class="line">  <span class="attr">tasks:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">test</span> <span class="number">1</span></span><br><span class="line">    <span class="attr">file:</span></span><br><span class="line">      <span class="string">path=/testdir/testfile</span></span><br><span class="line">      <span class="string">state=touch</span></span><br><span class="line">    <span class="attr">tags:</span> <span class="string">t1</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">test</span> <span class="number">2</span></span><br><span class="line">    <span class="attr">file:</span></span><br><span class="line">      <span class="string">path=/testdir/testfile2</span></span><br><span class="line">      <span class="string">state=touch</span></span><br><span class="line">    <span class="string">tags:t2</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">test</span> <span class="number">3</span></span><br><span class="line">    <span class="attr">file:</span></span><br><span class="line">      <span class="string">path=/testdir/testfile3</span></span><br><span class="line">      <span class="string">state=touch</span></span><br><span class="line">    <span class="attr">tags:</span> <span class="string">t3</span></span><br><span class="line"><span class="string">$</span> <span class="string">ansible-playbook</span> <span class="string">--tags=t2</span> <span class="string">test.yaml</span></span><br><span class="line"><span class="string">$</span> <span class="string">ansible-playbook</span> <span class="string">--skip-tags=t2</span> <span class="string">test.yaml</span></span><br></pre></td></tr></table></figure></li>
<li>–tags&#x3D;t2,只执行tag为t2部分的task,–skip-tags&#x3D;t2,跳过tag&#x3D;t2的tag</li>
<li>tag相关使用命令:<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 指定多个tag时,使用命令为</span></span><br><span class="line">$ ansible-playbook -t tag1,tag2,tag3 test.yaml</span><br><span class="line"><span class="comment"># 执行play前,查看当前有哪些tag</span></span><br><span class="line">$ ansible-playbook --list-tags test.yaml</span><br></pre></td></tr></table></figure></li>
<li>ansible预置了几个特殊tag:<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"># always: 如果任务的tags包含always,则该task一定会被执行,除非指定--skip-tags always(该情况也不合理,可能其他任务也包含always,这样其他task也不会执行)</span><br><span class="line"># never: 永远不执行,与always刚好相反</span><br><span class="line"></span><br><span class="line">## 下列只在调用标签时生效</span><br><span class="line"># tagged: ansible-playbook --tags tagged test.yaml --&gt; 只执行有标签的task,没有标签的task不会被执行</span><br><span class="line"># untagged: ansible-playbook --tags untagged test.yaml --&gt; 只执行没有tag的task,有tag的不会被执行</span><br><span class="line"># all: 默认使用,所有都会被执行</span><br></pre></td></tr></table></figure></li>
<li>可以为task指定多个tag,如下:<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># method one</span></span><br><span class="line"><span class="attr">tags:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">testing</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">t1</span></span><br><span class="line"><span class="comment"># method two</span></span><br><span class="line"><span class="attr">tags:</span> <span class="string">testing,</span> <span class="string">t1</span></span><br><span class="line"><span class="comment"># method three</span></span><br><span class="line"><span class="attr">tags:</span> [<span class="string">&#x27;testing&#x27;</span>, <span class="string">&#x27;t1&#x27;</span>]</span><br></pre></td></tr></table></figure>
2,play也可以指定tags,当一个play之指定了tags,这个play下的所有task都包含该tag,若该play下的task还有自己的tags,则该task的实际tags为’play tags’ + ‘task tags’<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="bullet">-</span> <span class="attr">hosts:</span> <span class="string">test70</span></span><br><span class="line">  <span class="attr">remote_user:</span> <span class="string">root</span></span><br><span class="line">  <span class="attr">tags:</span> <span class="string">httpd</span></span><br><span class="line">  <span class="attr">tasks:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">install</span> <span class="string">httpd</span> <span class="string">package</span></span><br><span class="line">    <span class="attr">tags:</span> [<span class="string">&#x27;package&#x27;</span>]</span><br><span class="line">    <span class="attr">yum:</span></span><br><span class="line">      <span class="string">name=httpd</span></span><br><span class="line">      <span class="string">state=latest</span></span><br><span class="line"> </span><br><span class="line">  <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">start</span> <span class="string">up</span> <span class="string">httpd</span> <span class="string">service</span></span><br><span class="line">    <span class="attr">tags:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">service</span></span><br><span class="line">    <span class="attr">service:</span></span><br><span class="line">      <span class="attr">name:</span> <span class="string">httpd</span></span><br><span class="line">      <span class="attr">state:</span> <span class="string">started</span></span><br></pre></td></tr></table></figure></li>
</ul>
<h3 id="2021-07-03-使用变量-一"><a href="#2021-07-03-使用变量-一" class="headerlink" title="2021-07-03 使用变量(一)"></a>2021-07-03 使用变量(一)</h3><p>1,怎么定义变量</p>
<ul>
<li>变量由数字,字母,下划线组成,要以字母开头</li>
<li>ansible的关键字不能作为变量名</li>
</ul>
<p>2,变量的定义及引用</p>
<ul>
<li>变量定义可以使用vars,和tasks同级,如下(普通定义方式):<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="bullet">-</span> <span class="attr">hosts:</span> <span class="string">all</span></span><br><span class="line">  <span class="attr">remote_user:</span> <span class="string">root</span></span><br><span class="line">  <span class="attr">vars:</span></span><br><span class="line">    <span class="attr">testvar1:</span> <span class="string">testfile</span></span><br><span class="line">    <span class="attr">testvar2:</span> <span class="string">testfile2</span></span><br><span class="line"><span class="comment"># 或者使用yaml写法</span></span><br><span class="line">  <span class="attr">vars:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">testvar1:</span> <span class="string">testfile</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">testvar2:</span> <span class="string">testfile2</span></span><br><span class="line">  <span class="attr">tasks:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">task1</span></span><br><span class="line">    <span class="attr">file:</span></span><br><span class="line">      <span class="attr">path:</span> <span class="string">/testdir/&#123;&#123;testvar1&#125;&#125;</span></span><br><span class="line">      <span class="attr">state:</span> <span class="string">touch</span></span><br></pre></td></tr></table></figure></li>
<li>使用属性的方式定义<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="bullet">-</span> <span class="attr">hosts:</span> <span class="string">all</span></span><br><span class="line">  <span class="attr">remote_user:</span> <span class="string">root</span></span><br><span class="line">  <span class="attr">vars:</span></span><br><span class="line">    <span class="attr">nginx:</span></span><br><span class="line">      <span class="attr">conf80:</span> <span class="string">/etc/nginx/conf.d/80.conf</span></span><br><span class="line">      <span class="attr">conf8080:</span> <span class="string">/etc/nginx/conf.d/8080.conf</span></span><br><span class="line">  <span class="attr">tasks:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">task1</span></span><br><span class="line">    <span class="attr">file:</span></span><br><span class="line">      <span class="attr">path:</span> <span class="string">&quot;<span class="template-variable">&#123;&#123;nginx.conf80&#125;&#125;</span>&quot;</span></span><br><span class="line">      <span class="comment"># 或者path: &quot;&#123;&#123;nginx[&#x27;conf80&#x27;]&#125;&#125;&quot;</span></span><br><span class="line">      <span class="attr">state:</span> <span class="string">touch</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">task2</span></span><br><span class="line">    <span class="attr">file:</span></span><br><span class="line">      <span class="attr">path:</span> <span class="string">&quot;<span class="template-variable">&#123;&#123;nginx.conf8080&#125;&#125;</span>&quot;</span></span><br><span class="line">      <span class="comment"># 或者path: &quot;&#123;&#123;nginx[&#x27;conf8080&#x27;]&#125;&#125;&quot;</span></span><br><span class="line">      <span class="attr">state:</span> <span class="string">touch</span></span><br><span class="line"><span class="comment"># 使用=给模块参数赋值时,可以不考虑变量是否加引号</span></span><br><span class="line"><span class="comment">#  - name: task2</span></span><br><span class="line"><span class="comment">#    file:</span></span><br><span class="line"><span class="comment">#      path=&#123;&#123;nginx.conf8080&#125;&#125;</span></span><br><span class="line"><span class="comment">#      # 或者path=&#123;&#123;nginx[&#x27;conf8080&#x27;]&#125;&#125;</span></span><br><span class="line"><span class="comment">#      state=touch</span></span><br></pre></td></tr></table></figure>
<blockquote>
<p>注意: 上面列举的两个例子有些差别,第一个例子中变量没有加引号,第二个有加引号,因为第一个变量不是’开头’位置,第二个是’开头’位置<br>但实际上也有例外,给模块参数赋值时,可以选择’:’,也可以选择’&#x3D;’,当使用’&#x3D;’时,可以不用考虑引号的问题</p>
</blockquote>
</li>
</ul>
<p>3,在文件中定义变量给playbook使用</p>
<ul>
<li>将变量在单独的文件中定义的好处是,可以做到变量文件分离,不给看到变量的值</li>
<li>在文件中定义变量时,不用使用vars关键字,直接定义变量即可,如下集中语法:<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># method one</span></span><br><span class="line"><span class="attr">testvar1:</span> <span class="string">testfile</span></span><br><span class="line"><span class="attr">testvar2:</span> <span class="string">testfile2</span></span><br><span class="line"><span class="comment"># method two</span></span><br><span class="line"><span class="bullet">-</span> <span class="attr">testvar1:</span> <span class="string">testfile</span></span><br><span class="line"><span class="bullet">-</span> <span class="attr">testvar2:</span> <span class="string">testfile2</span></span><br><span class="line"><span class="comment"># method three</span></span><br><span class="line"><span class="attr">nginx:</span></span><br><span class="line">  <span class="attr">conf80:</span> <span class="string">/etc/nginx/conf.d/80.conf</span></span><br><span class="line">  <span class="attr">conf8080:</span> <span class="string">/etc/nginx/conf.d/8080.conf</span></span><br></pre></td></tr></table></figure></li>
<li>在文件中定义完变量,在playbook中使用变量,需要使用vars_files,被导入的文件以’-‘开头(可以引入多个变量文件),以yaml中块序列的方式导入<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="bullet">-</span> <span class="attr">hosts:</span> <span class="string">all</span></span><br><span class="line">  <span class="attr">remote_user:</span> <span class="string">root</span></span><br><span class="line">  <span class="attr">vars_files:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">/testdir/ansible/nginx_vars.yml</span></span><br><span class="line">  <span class="attr">tasks:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">task1</span></span><br><span class="line">    <span class="attr">file:</span></span><br><span class="line">      <span class="attr">path:</span> <span class="string">&quot;<span class="template-variable">&#123;&#123;nginx.conf80&#125;&#125;</span>&quot;</span></span><br><span class="line">      <span class="attr">state:</span> <span class="string">touch</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">task2</span></span><br><span class="line">    <span class="attr">file:</span></span><br><span class="line">      <span class="attr">path:</span> <span class="string">&quot;<span class="template-variable">&#123;&#123;nginx[&#x27;conf8080&#x27;]&#125;&#125;</span>&quot;</span></span><br><span class="line">      <span class="attr">state:</span> <span class="string">touch</span></span><br></pre></td></tr></table></figure></li>
</ul>
<h3 id="2021-07-04-使用变量-二"><a href="#2021-07-04-使用变量-二" class="headerlink" title="2021-07-04 使用变量(二)"></a>2021-07-04 使用变量(二)</h3><p>1,在playbook执行前,有一个Gathering Facts的动作,调用的是setup模块; 这些信息会保存在对应的变量中，我们在playbook中可以使用这些变量,我们可以称这些信息为facts信息</p>
<ul>
<li>setupa模块的返回值是json格式的,方便返回时内容展示</li>
<li>setup模块可以获取远端主机很详尽的信息,若需要过滤相关信息,可以使用setup的filter参数(支持通配符)<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 显示内存相关信息</span></span><br><span class="line">ansible all -m setup -a <span class="string">&#x27;filter=ansible_memory_mb&#x27;</span></span><br><span class="line"><span class="comment"># 不确定信息相关信息,使用通配符来获取</span></span><br><span class="line">ansible all -m setup -a <span class="string">&#x27;filter=*mb*&#x27;</span></span><br></pre></td></tr></table></figure></li>
<li>setup模块获取的信息都保存在相应的变量中,我们可以通过引用变量获取到这些值</li>
</ul>
<p>2,setup模块支持获取自定义内容</p>
<ul>
<li>要求:自定义内容存在于目标主机的&#x2F;etc&#x2F;ansible&#x2F;facts.d&#x2F;下以.fact结尾的文件; 这些文件需要以json或者ini格式保存变量信息<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">$ <span class="built_in">cat</span> /etc/ansible/facts.d/test.fact</span><br><span class="line">[testmsg]</span><br><span class="line">msg1=<span class="string">&#x27;test message 1&#x27;</span></span><br><span class="line">msg2=<span class="string">&#x27;test message 2&#x27;</span></span><br></pre></td></tr></table></figure></li>
<li>这些自定义的变量称为’local facts’,可以在setup获取时通过filter&#x3D;ansible_local获取</li>
</ul>
<p>3,另一个模块debug,可用于playbook的调试使用,把调试信息打印到控制台上,方便我们查看和定位问题</p>
<ul>
<li>debug模块常用的两个参数分别是var和msg,var用于测试变量,msg用于打印输出是否符合预期<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"># 连接到主机,但是并没有做任何事情,debug引用的是testvar,测试testvar是否能用</span><br><span class="line">---yaml</span><br><span class="line">- hosts: all</span><br><span class="line">  remote_user: root</span><br><span class="line">  vars:</span><br><span class="line">    testvar: value of testvar</span><br><span class="line">  tasks:</span><br><span class="line">  - name: test debug</span><br><span class="line">    debug:</span><br><span class="line">      var: testvar</span><br></pre></td></tr></table></figure></li>
</ul>
<h3 id="2021-07-04-使用变量-三"><a href="#2021-07-04-使用变量-三" class="headerlink" title="2021-07-04 使用变量(三)"></a>2021-07-04 使用变量(三)</h3><p>1,变量注册</p>
<ul>
<li>ansible模块在执行之后都会有一些返回值,默认情况下,这些返回值不会显示而已;我们可以把这些返回值写入到某个变量中,我们可以通过引用相应的变量获取到这些返回值,将模块的返回值写入到变量中,这种方式称为’注册变量’; 如下为变量注册的的一个范例<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="bullet">-</span> <span class="attr">hosts:</span> <span class="string">all</span></span><br><span class="line">  <span class="attr">remote_user:</span> <span class="string">root</span></span><br><span class="line">  <span class="attr">tasks:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">test</span> <span class="string">register</span></span><br><span class="line">    <span class="attr">shell:</span> <span class="string">&quot;echo test &gt; /tmp/testfile&quot;</span></span><br><span class="line">    <span class="attr">register:</span> <span class="string">testvar</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">shell</span> <span class="string">module</span> <span class="string">return</span> <span class="string">values</span></span><br><span class="line">    <span class="attr">debug:</span></span><br><span class="line">      <span class="attr">var:</span> <span class="string">testvar</span></span><br><span class="line"><span class="comment"># 执行完成后,在控制台中看到名为”[shell module return values]”的任务中已经显示了第一个任务的返回值的信息，返回信息:</span></span><br><span class="line"><span class="string">TASK</span> [<span class="string">shell</span> <span class="string">module</span> <span class="string">return</span> <span class="string">values</span>] <span class="string">************************************</span></span><br><span class="line"><span class="attr">ok:</span> [<span class="string">master</span>] <span class="string">=&gt;</span> &#123;    </span><br><span class="line">    <span class="attr">&quot;testvar&quot;:</span> &#123;          </span><br><span class="line">        <span class="attr">&quot;changed&quot;:</span> <span class="literal">true</span>,</span><br><span class="line">        <span class="attr">&quot;cmd&quot;:</span> <span class="string">&quot;echo test &gt; /tmp/testfile&quot;</span>,</span><br><span class="line">        <span class="attr">&quot;delta&quot;:</span> <span class="string">&quot;0:00:00.010963&quot;</span>,</span><br><span class="line">        <span class="attr">&quot;end&quot;:</span> <span class="string">&quot;2021-03-30 09:26:47.432571&quot;</span>,                         </span><br><span class="line">        <span class="attr">&quot;failed&quot;:</span> <span class="literal">false</span>,                                            </span><br><span class="line">        <span class="attr">&quot;rc&quot;:</span> <span class="number">0</span>,                                                   </span><br><span class="line">        <span class="attr">&quot;start&quot;:</span> <span class="string">&quot;2021-03-30 09:26:47.421608&quot;</span>,                    </span><br><span class="line">        <span class="attr">&quot;stderr&quot;:</span> <span class="string">&quot;&quot;</span>,</span><br><span class="line">        <span class="attr">&quot;stderr_lines&quot;:</span> [],                                      </span><br><span class="line">        <span class="attr">&quot;stdout&quot;:</span> <span class="string">&quot;&quot;</span>,</span><br><span class="line">        <span class="attr">&quot;stdout_lines&quot;:</span> []</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment"># register的变量testvar其实是一个json格式的返回值,可以通过引用testvar的不同属性获取相应的值</span></span><br></pre></td></tr></table></figure></li>
</ul>
<p>2,变量的传入方式,ansible支持多种变量传入的方式,包括:交互式传入,命令行传入,文件传入</p>
<ul>
<li>交互式传入,需要使用到var_prompt关键字,属于vars的一种,当出现该关键字时,会让你在命令行下输入<ul>
<li>普通使用,以下输入内容不会在控制台显示(默认情况下private: yes)<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="bullet">-</span> <span class="attr">hosts:</span> <span class="string">all</span></span><br><span class="line">  <span class="attr">remote_user:</span> <span class="string">root</span></span><br><span class="line">  <span class="attr">vars_prompt:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">&#x27;your_name&#x27;</span></span><br><span class="line">      <span class="attr">prompt:</span> <span class="string">&quot;What is your name?&quot;</span></span><br><span class="line">      <span class="comment"># private: no</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">&#x27;your_age&#x27;</span></span><br><span class="line">      <span class="attr">prompt:</span> <span class="string">&quot;What is your age?&quot;</span></span><br><span class="line">      <span class="comment"># private: no</span></span><br><span class="line">  <span class="attr">tasks:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">output</span> <span class="string">vars</span></span><br><span class="line">    <span class="attr">debug:</span></span><br><span class="line">      <span class="attr">msg:</span> <span class="string">your</span> <span class="string">name</span> <span class="string">is</span> &#123;&#123;<span class="string">your_name</span>&#125;&#125;<span class="string">,</span> <span class="string">your</span> <span class="string">age</span> <span class="string">is</span> &#123;&#123;<span class="string">your_age</span>&#125;&#125;</span><br></pre></td></tr></table></figure></li>
<li>普通使用,可以做到提供选项供选择</li>
<li>特殊使用,例如增加用户,设定密码<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 需要使用到vars_prompt下encrypt,指定加密方式,而且该方式需要passlib库,么有的话需要安装</span></span><br><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="bullet">-</span> <span class="attr">hosts:</span> <span class="string">test70</span></span><br><span class="line">  <span class="attr">remote_user:</span> <span class="string">root</span></span><br><span class="line">  <span class="attr">vars_prompt:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">&quot;hash_string&quot;</span></span><br><span class="line">      <span class="attr">prompt:</span> <span class="string">&quot;Enter something&quot;</span></span><br><span class="line">      <span class="attr">private:</span> <span class="literal">no</span></span><br><span class="line">      <span class="attr">encrypt:</span> <span class="string">&quot;sha512_crypt&quot;</span></span><br><span class="line">  <span class="attr">tasks:</span></span><br><span class="line">   <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">Output</span> <span class="string">the</span> <span class="string">string</span> <span class="string">after</span> <span class="string">hash</span></span><br><span class="line">     <span class="attr">debug:</span></span><br><span class="line">      <span class="attr">msg:</span> <span class="string">&quot;<span class="template-variable">&#123;&#123;hash_string&#125;&#125;</span>&quot;</span></span><br></pre></td></tr></table></figure></li>
</ul>
</li>
<li>命令行传入,直接在ansible-playbook执行时增加-e ‘key&#x3D;value’即可,可有多个,变量赋值有多种方式,还可以是json格式</li>
<li>文件传入,类似命令行-e “@变量文件绝对路径”</li>
</ul>
<h3 id="2021-07-04-使用变量-四-register-set-fact"><a href="#2021-07-04-使用变量-四-register-set-fact" class="headerlink" title="2021-07-04 使用变量(四),register,set_fact"></a>2021-07-04 使用变量(四),register,set_fact</h3><p>1,配置主机清单时,可以配置主机或主机组变量,但只对配置的主机或主机组生效</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">## 主机配置,配置/etc/ansible/hosts如下</span></span><br><span class="line"><span class="comment"># method one</span></span><br><span class="line"><span class="string">node2</span> <span class="string">ansible_host=192.168.110.22</span> <span class="string">testhostvar=node2_host_var</span></span><br><span class="line"><span class="comment"># method two</span></span><br><span class="line"><span class="attr">all:</span></span><br><span class="line">  <span class="attr">hosts:</span></span><br><span class="line">    <span class="attr">node2:</span></span><br><span class="line">      <span class="attr">ansible_host:</span> <span class="number">192.168</span><span class="number">.110</span><span class="number">.22</span></span><br><span class="line">      <span class="attr">ansible_port:</span> <span class="number">22</span></span><br><span class="line">      <span class="attr">testhostvar:</span> <span class="string">node2_host_var</span></span><br><span class="line">      <span class="attr">testhostvar2:</span> <span class="string">node2_host_var2</span></span><br><span class="line">      <span class="attr">testhostvar3:</span> </span><br><span class="line">        <span class="attr">thv31:</span> <span class="number">3.1</span></span><br><span class="line">        <span class="attr">thv32:</span> <span class="number">3.2</span></span><br><span class="line"><span class="string">$</span> <span class="string">ansible</span> <span class="string">node2</span> <span class="string">-m</span> <span class="string">shell</span> <span class="string">-a</span> <span class="string">&#x27;echo <span class="template-variable">&#123;&#123;testhostvar&#125;&#125;</span></span></span><br><span class="line"><span class="string">$ ansible node2 -m shell -a &#x27;</span><span class="string">echo</span> &#123;&#123;<span class="string">testhostvar3.thv31</span>&#125;&#125;<span class="string">&#x27; or &#x27;</span>&#123;&#123;<span class="string">testhostvar3</span>[<span class="string">&#x27;thv32&#x27;</span>]&#125;&#125;<span class="string">&#x27;</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">## 主机组配置,配置/etc/ansible/hosts如下</span></span><br><span class="line"><span class="string"># method one</span></span><br><span class="line"><span class="string">[testB]</span></span><br><span class="line"><span class="string">node2 ansible_host=192.168.110.22</span></span><br><span class="line"><span class="string">node3 anisble_host=192.168.110.33</span></span><br><span class="line"><span class="string"> </span></span><br><span class="line"><span class="string">[testB:vars]</span></span><br><span class="line"><span class="string">test_group_var1=&#x27;</span><span class="string">group</span> <span class="string">var</span> <span class="string">test&#x27;</span></span><br><span class="line"><span class="string">test_group_var2=&#x27;group</span> <span class="string">var</span> <span class="string">test2&#x27;</span></span><br><span class="line"><span class="comment"># method two</span></span><br><span class="line"><span class="attr">all:</span></span><br><span class="line"> <span class="attr">children:</span></span><br><span class="line">   <span class="attr">testB:</span></span><br><span class="line">     <span class="attr">hosts:</span></span><br><span class="line">       <span class="attr">node2:</span></span><br><span class="line">         <span class="attr">ansible_host:</span> <span class="number">192.168</span><span class="number">.110</span><span class="number">.22</span></span><br><span class="line">         <span class="attr">ansible_port:</span> <span class="number">22</span></span><br><span class="line">       <span class="attr">node3:</span></span><br><span class="line">         <span class="attr">ansible_host:</span> <span class="number">192.168</span><span class="number">.110</span><span class="number">.33</span></span><br><span class="line">         <span class="attr">ansible_port:</span> <span class="number">22</span></span><br><span class="line">     <span class="attr">vars:</span></span><br><span class="line">       <span class="attr">test_group_var1:</span> <span class="string">&#x27;group var test1&#x27;</span></span><br><span class="line">       <span class="attr">test_group_var2:</span> <span class="string">&#x27;group var test2&#x27;</span></span><br><span class="line"><span class="string">$</span> <span class="string">ansible</span> <span class="string">testB</span> <span class="string">-m</span> <span class="string">shell</span> <span class="string">-a</span> <span class="string">&#x27;echo <span class="template-variable">&#123;&#123;test_group_var1&#125;&#125;</span>&#x27;</span></span><br></pre></td></tr></table></figure>

<p>2,通过set_fact定义变量,set_fact是一个模块,可以通过set_fact模块在task中定义变量</p>
<ul>
<li>普通使用,直接与task同级定义一个变量<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="bullet">-</span> <span class="attr">hosts:</span> <span class="string">node2</span></span><br><span class="line">  <span class="attr">remote_user:</span> <span class="string">root</span></span><br><span class="line">  <span class="attr">tasks:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">set_fact:</span></span><br><span class="line">      <span class="attr">testvar:</span> <span class="string">&quot;testtest&quot;</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">debug:</span></span><br><span class="line">      <span class="attr">msg:</span> <span class="string">&quot;<span class="template-variable">&#123;&#123;testvar&#125;&#125;</span>&quot;</span></span><br></pre></td></tr></table></figure></li>
<li>普通使用,将一个变量的值赋给另一个变量<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="bullet">-</span> <span class="attr">hosts:</span> <span class="string">node2</span></span><br><span class="line">  <span class="attr">remote_user:</span> <span class="string">root</span></span><br><span class="line">  <span class="attr">vars:</span></span><br><span class="line">    <span class="attr">testvar1:</span> <span class="string">test1_string</span></span><br><span class="line">  <span class="attr">tasks:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">shell:</span> <span class="string">&quot;echo test2_string&quot;</span></span><br><span class="line">    <span class="attr">register:</span> <span class="string">shellreturn</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">set_fact:</span></span><br><span class="line">      <span class="attr">testsf1:</span> <span class="string">&quot;<span class="template-variable">&#123;&#123;testvar1&#125;&#125;</span>&quot;</span></span><br><span class="line">      <span class="attr">testsf2:</span> <span class="string">&quot;<span class="template-variable">&#123;&#123;shellreturn.stdout&#125;&#125;</span>&quot;</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">debug:</span></span><br><span class="line">      <span class="attr">msg:</span> <span class="string">&quot;<span class="template-variable">&#123;&#123;testsf1&#125;&#125;</span> <span class="template-variable">&#123;&#123;testsf2&#125;&#125;</span>&quot;</span></span><br></pre></td></tr></table></figure></li>
<li>通过set_fact模块创建的变量还有一个特殊性，通过set_fact创建的变量就像主机上的facts信息一样，可以在之后的play中被引用<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="bullet">-</span> <span class="attr">hosts:</span> <span class="string">node2</span></span><br><span class="line">  <span class="attr">remote_user:</span> <span class="string">root</span></span><br><span class="line">  <span class="attr">vars:</span></span><br><span class="line">    <span class="attr">testvar1:</span> <span class="string">tv1</span></span><br><span class="line">  <span class="attr">tasks:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">set_fact:</span></span><br><span class="line">      <span class="attr">testvar2:</span> <span class="string">tv2</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">debug:</span></span><br><span class="line">      <span class="attr">msg:</span> <span class="string">&quot;<span class="template-variable">&#123;&#123;testvar1&#125;&#125;</span> ----- <span class="template-variable">&#123;&#123;testvar2&#125;&#125;</span>&quot;</span></span><br><span class="line"> </span><br><span class="line"><span class="bullet">-</span> <span class="attr">hosts:</span> <span class="string">node2</span></span><br><span class="line">  <span class="attr">remote_user:</span> <span class="string">root</span></span><br><span class="line">  <span class="attr">tasks:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">other</span> <span class="string">play</span> <span class="string">get</span> <span class="string">testvar2</span></span><br><span class="line">    <span class="attr">debug:</span></span><br><span class="line">      <span class="attr">msg:</span> <span class="string">&quot;<span class="template-variable">&#123;&#123;testvar2&#125;&#125;</span>&quot;</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">other</span> <span class="string">play</span> <span class="string">get</span> <span class="string">testvar1</span></span><br><span class="line">    <span class="attr">debug:</span></span><br><span class="line">      <span class="attr">msg:</span> <span class="string">&quot;<span class="template-variable">&#123;&#123;testvar1&#125;&#125;</span>&quot;</span></span><br><span class="line"><span class="comment"># 这两个变量在第一个play中都可以正常的输出.但是在第二个play中，testvar2可以被正常输出了，testvar1却不能被正常输出，会出现未定义testvar1的错误</span></span><br></pre></td></tr></table></figure></li>
<li>如果想要在tasks中给变量自定义信息，并且在之后的play操作同一个主机时能够使用到之前在tasks中定义的变量时，则可以使用set_facts定义对应的变量</li>
</ul>
<h3 id="2021-07-04-使用变量-五-内置变量-host-vars"><a href="#2021-07-04-使用变量-五-内置变量-host-vars" class="headerlink" title="2021-07-04 使用变量(五),内置变量,host_vars"></a>2021-07-04 使用变量(五),内置变量,host_vars</h3><p>1,ansible有一些内置变量可供使用,这些变量被ansible保留,我们定义变量时不能使用</p>
<ul>
<li>ansible_version<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ ansible node2 -m debug -a <span class="string">&#x27;msg=&#123;&#123;ansible_version&#125;&#125;&#x27;</span></span><br></pre></td></tr></table></figure></li>
</ul>
<p>2,hostvars可以在我们操作当前主机时获取到其他主机中的信息</p>
<ul>
<li>如下示例<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="comment"># 第一个什么也没做,只是获取node3的facts内容,这一步是需要的,只有收集过的facts才能被后面的play使用</span></span><br><span class="line"><span class="comment"># 如果没有收到对应主机的facts信息,即使使用hostvars内置变量,也无法获取到对应主机的facts内容</span></span><br><span class="line"><span class="bullet">-</span> <span class="attr">name:</span> <span class="string">&quot;play 1: gather facts of node3&quot;</span></span><br><span class="line">  <span class="attr">hosts:</span> <span class="string">node3</span></span><br><span class="line">  <span class="attr">remote_user:</span> <span class="string">root</span></span><br><span class="line">  <span class="comment"># 下面的gather_facts默认是yes</span></span><br><span class="line">  <span class="comment"># gater_facts: yes</span></span><br><span class="line"><span class="bullet">-</span> <span class="attr">name:</span> <span class="string">&quot;play 2: gathter facts of node3 when operating on node2&quot;</span></span><br><span class="line">  <span class="attr">hosts:</span> <span class="string">node2</span></span><br><span class="line">  <span class="attr">remote_user:</span> <span class="string">root</span></span><br><span class="line">  <span class="attr">tasks:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">debug:</span></span><br><span class="line">    <span class="attr">msg:</span> <span class="string">&quot;<span class="template-variable">&#123;&#123;hostvars[&#x27;node3&#x27;].ansible_enp0s3.ipv4&#125;&#125;</span>&quot;</span></span><br><span class="line">    <span class="comment"># 下面两种也可以</span></span><br><span class="line">    <span class="comment">#msg: &quot;&#123;&#123;hostvars.node3.ansible_enp0s3.ipv4&#125;&#125;&quot;</span></span><br><span class="line">    <span class="comment">#msg: &quot;&#123;&#123;hostvars[&#x27;node3&#x27;][&#x27;ansible_enp0s3&#x27;][&#x27;ipv4&#x27;]&#125;&#125;&quot;</span></span><br></pre></td></tr></table></figure></li>
<li>hostvars除了获取到其他主机的facts内容,还可以获取到其他类型的一些变量信息,如其他主机的注册变量,主机变量,组变量等;如下示例<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="comment"># 1,通过hostvars内置变量可以直接获取到其他主机中的注册变量</span></span><br><span class="line"><span class="comment"># 2,注册变量并不用像facts信息那样需要事先收集，即可直接通过hostvars跨主机被引用到</span></span><br><span class="line"><span class="comment"># 3,如果你在清单中为node3主机配置了主机变量，或者为node3主机所在的组配置了组变量，也是可以通过hostvars直接跨主机引用</span></span><br><span class="line"><span class="bullet">-</span> <span class="attr">hosts:</span> <span class="string">node3</span></span><br><span class="line">  <span class="attr">remote_user:</span> <span class="string">root</span></span><br><span class="line">  <span class="attr">gather_facts:</span> <span class="literal">no</span></span><br><span class="line">  <span class="attr">tasks:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">shell:</span> <span class="string">&quot;echo register_var_in_play1&quot;</span></span><br><span class="line">    <span class="attr">register:</span> <span class="string">shellreturn</span></span><br><span class="line"> </span><br><span class="line"><span class="bullet">-</span> <span class="attr">hosts:</span> <span class="string">node2</span></span><br><span class="line">  <span class="attr">remote_user:</span> <span class="string">root</span></span><br><span class="line">  <span class="attr">gather_facts:</span> <span class="literal">no</span></span><br><span class="line">  <span class="attr">tasks:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">debug:</span></span><br><span class="line">      <span class="attr">msg:</span> <span class="string">&quot;<span class="template-variable">&#123;&#123;hostvars.node3.shellreturn.stdout&#125;&#125;</span>&quot;</span></span><br></pre></td></tr></table></figure></li>
<li>通过vars关键字定义的变量使用上例中的hostvars方法是无法被跨主机引用<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 下列内容会报错,变量需要注册才行,直接使用vars定义的变量无法传递</span></span><br><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="bullet">-</span> <span class="attr">hosts:</span> <span class="string">node3</span></span><br><span class="line">  <span class="attr">remote_user:</span> <span class="string">root</span></span><br><span class="line">  <span class="attr">gather_facts:</span> <span class="literal">no</span></span><br><span class="line">  <span class="attr">vars:</span></span><br><span class="line">    <span class="attr">testvar:</span> <span class="string">testvar_in_3</span></span><br><span class="line">  <span class="attr">tasks:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">debug:</span></span><br><span class="line">      <span class="attr">msg:</span> <span class="string">&quot;<span class="template-variable">&#123;&#123;testvar&#125;&#125;</span>&quot;</span></span><br><span class="line"> </span><br><span class="line"><span class="bullet">-</span> <span class="attr">hosts:</span> <span class="string">node2</span></span><br><span class="line">  <span class="attr">remote_user:</span> <span class="string">root</span></span><br><span class="line">  <span class="attr">gather_facts:</span> <span class="literal">no</span></span><br><span class="line">  <span class="attr">tasks:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">debug:</span></span><br><span class="line">      <span class="attr">msg:</span> <span class="string">&quot;<span class="template-variable">&#123;&#123;hostvars.node3.testvar&#125;&#125;</span>&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 通过set_fact将vars定义的内容注册,则可以</span></span><br><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="bullet">-</span> <span class="attr">hosts:</span> <span class="string">node3</span></span><br><span class="line">  <span class="attr">remote_user:</span> <span class="string">root</span></span><br><span class="line">  <span class="attr">gather_facts:</span> <span class="literal">no</span></span><br><span class="line">  <span class="attr">tasks:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">set_fact:</span></span><br><span class="line">      <span class="attr">testvar:</span> <span class="string">testvar_in_3</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">debug:</span></span><br><span class="line">      <span class="attr">msg:</span> <span class="string">&quot;<span class="template-variable">&#123;&#123;testvar&#125;&#125;</span>&quot;</span></span><br><span class="line"> </span><br><span class="line"><span class="bullet">-</span> <span class="attr">hosts:</span> <span class="string">node2</span></span><br><span class="line">  <span class="attr">remote_user:</span> <span class="string">root</span></span><br><span class="line">  <span class="attr">gather_facts:</span> <span class="literal">no</span></span><br><span class="line">  <span class="attr">tasks:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">debug:</span></span><br><span class="line">      <span class="attr">msg:</span> <span class="string">&quot;<span class="template-variable">&#123;&#123;hostvars.node3.testvar&#125;&#125;</span>&quot;</span></span><br></pre></td></tr></table></figure></li>
<li>通过”set_fact”结合”hostvars”的方式，可以实现跨play获取其他主机中的变量信息</li>
</ul>
<p>3,内置变量inventory_hostname,获取到被操作的当前主机的主机名称</p>
<ul>
<li>主机名称并不是linux系统的主机名，而是对应主机在清单中配置的名称,清单中配置的名称即是</li>
</ul>
<p>4,内置变量inventory_hostname_short,获取到被操作的当前主机的主机名称,简版</p>
<ul>
<li>无论是IP还是别名，如果清单的主机名称中包含”.”，inventory_hostname_short都会取得主机名中第一个”.”之前的字符作为主机的简短名称</li>
</ul>
<p>5,内置变量play_hosts,获取到当前play所操作的所有主机的主机名列表</p>
<ul>
<li>如下示例<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="bullet">-</span> <span class="attr">hosts:</span> <span class="string">node2,node3</span></span><br><span class="line">  <span class="attr">remote_user:</span> <span class="string">root</span></span><br><span class="line">  <span class="attr">gather_facts:</span> <span class="literal">no</span></span><br><span class="line">  <span class="attr">tasks:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">debug:</span></span><br><span class="line">      <span class="attr">msg:</span> <span class="string">&quot;<span class="template-variable">&#123;&#123;play_hosts&#125;&#125;</span>&quot;</span></span><br><span class="line"><span class="comment"># 输出如下:</span></span><br><span class="line"><span class="string">TASK</span> [<span class="string">debug</span>] <span class="string">xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx</span></span><br><span class="line"><span class="attr">ok:</span> [<span class="string">node2</span>] <span class="string">=&gt;</span> &#123;</span><br><span class="line">    <span class="attr">&quot;msg&quot;:</span> [</span><br><span class="line">        <span class="string">&quot;node2&quot;</span>, </span><br><span class="line">        <span class="string">&quot;node3&quot;</span></span><br><span class="line">    ]</span><br><span class="line">&#125;</span><br><span class="line"><span class="attr">ok:</span> [<span class="string">node3</span>] <span class="string">=&gt;</span> &#123;</span><br><span class="line">    <span class="attr">&quot;msg&quot;:</span> [</span><br><span class="line">        <span class="string">&quot;node2&quot;</span>, </span><br><span class="line">        <span class="string">&quot;node3&quot;</span></span><br><span class="line">    ]</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li>
</ul>
<p>6,内置变量groups,可以获取到清单中”所有分组”的”分组信息”</p>
<ul>
<li>同inventory_hostname,但能获取到分组的信息<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">$ ansible all -m debug -a <span class="string">&#x27;msg=&#123;&#123;groups&#125;&#125;&#x27;</span></span><br><span class="line">$ ansible all -m debug -a <span class="string">&#x27;msg=&#123;&#123;groups.k8s&#125;&#125;&#x27;</span></span><br></pre></td></tr></table></figure></li>
</ul>
<p>7,内置变量group_names,获取到当前主机所在分组的组名</p>
<ul>
<li>如下示例:<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># ansible node2 -m debug -a &quot;msg=&#123;&#123;group_names&#125;&#125;&quot;</span></span><br><span class="line">node2 | SUCCESS =&gt; &#123;</span><br><span class="line">    <span class="string">&quot;changed&quot;</span>: <span class="literal">false</span>, </span><br><span class="line">    <span class="string">&quot;msg&quot;</span>: [</span><br><span class="line">        <span class="string">&quot;k8s&quot;</span></span><br><span class="line">    ]</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li>
</ul>
<p>8,内置变量inventory_dir,获取到ansible主机中清单文件的存放路径,默认是&#x2F;etc&#x2F;ansible,但也可以自定义</p>
<ul>
<li>如下示例:<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># ansible node2 -m debug -a &quot;msg=&#123;&#123;inventory_dir&#125;&#125;&quot;</span></span><br><span class="line">node2 | SUCCESS =&gt; &#123;</span><br><span class="line">    <span class="string">&quot;changed&quot;</span>: <span class="literal">false</span>, </span><br><span class="line">    <span class="string">&quot;msg&quot;</span>: <span class="string">&quot;/etc/ansible&quot;</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li>
</ul>
<p>9,除了直接在hosts文件中定义主机变量和组变量，还有另外一种方法也可以定义主机变量和组变量，我们可以在清单文件的同级目录中创建两个目录，这两个目录的名字分别为”group_vars”和”host_vars”，我们可以将组变量文件放在”group_vars”目录中，将主机变量文件放在”host_vars”目录中，这样ansible就能获取到对应组变量和主机变量</p>
<h3 id="2021-07-04-使用循环-一-with-items的使用"><a href="#2021-07-04-使用循环-一-with-items的使用" class="headerlink" title="2021-07-04 使用循环(一),with_items的使用"></a>2021-07-04 使用循环(一),with_items的使用</h3><p>1,使用with_items处理循环的内容</p>
<ul>
<li>普通示例:<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># &quot;with_items&quot;关键字会把返回的列表信息自动处理，将每一条信息单独放在一个名为&quot;item&quot;的变量中，只要获取到名为&quot;item&quot;变量的变量值，即可循环的获取到列表中的每一条信息</span></span><br><span class="line"><span class="comment"># 下列debug被循环3次,每次单独输出相应循环的debug输出内容</span></span><br><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="bullet">-</span> <span class="attr">hosts:</span> <span class="string">node2</span></span><br><span class="line">  <span class="attr">remote_user:</span> <span class="string">root</span></span><br><span class="line">  <span class="attr">gather_facts:</span> <span class="literal">no</span></span><br><span class="line">  <span class="attr">tasks:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">test</span> <span class="string">with_items</span></span><br><span class="line">    <span class="attr">debug:</span></span><br><span class="line">      <span class="attr">msg:</span> <span class="string">&quot;<span class="template-variable">&#123;&#123;item&#125;&#125;</span>&quot;</span></span><br><span class="line">    <span class="attr">with_items:</span> <span class="string">&quot;<span class="template-variable">&#123;&#123;groups.k8s&#125;&#125;</span>&quot;</span></span><br></pre></td></tr></table></figure></li>
</ul>
<p>2,with_items可以自定义</p>
<ul>
<li>列表<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># method one</span></span><br><span class="line"><span class="attr">with_items:</span></span><br><span class="line"><span class="bullet">-</span> <span class="number">1</span></span><br><span class="line"><span class="bullet">-</span> <span class="number">2</span></span><br><span class="line"><span class="bullet">-</span> <span class="number">3</span></span><br><span class="line"><span class="comment"># method two</span></span><br><span class="line"><span class="attr">with_items:</span> [<span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>]</span><br></pre></td></tr></table></figure></li>
<li>相对复杂的列表<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="bullet">-</span> <span class="attr">hosts:</span> <span class="string">node2</span></span><br><span class="line">  <span class="attr">remote_user:</span> <span class="string">root</span></span><br><span class="line">  <span class="attr">gather_facts:</span> <span class="literal">no</span></span><br><span class="line">  <span class="attr">tasks:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">debug:</span></span><br><span class="line">      <span class="attr">msg:</span> <span class="string">&quot;<span class="template-variable">&#123;&#123;item.test1&#125;&#125;</span>&quot;</span></span><br><span class="line">    <span class="attr">with_items:</span></span><br><span class="line">    <span class="bullet">-</span> &#123; <span class="attr">test1:</span> <span class="string">a</span>, <span class="attr">test2:</span> <span class="string">b</span>&#125;</span><br><span class="line">    <span class="bullet">-</span> &#123; <span class="attr">test1:</span> <span class="string">c</span>, <span class="attr">test2:</span> <span class="string">d</span>&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure></li>
</ul>
<p>3,result的使用</p>
<ul>
<li>当使用了循环以后，每次shell模块执行的返回值放入名为”results”的序列中，”results”也是一个返回值，当模块中使用循环时，模块每次执行的返回值都会追加存放到”results”这个返回值中,如下示例:<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 两次debug循环,输出的内容都保存在results序列中,属于results</span></span><br><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="bullet">-</span> <span class="attr">hosts:</span> <span class="string">node2</span></span><br><span class="line">  <span class="attr">gather_facts:</span> <span class="literal">no</span></span><br><span class="line">  <span class="attr">tasks:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">shell:</span> <span class="string">&quot;<span class="template-variable">&#123;&#123;item&#125;&#125;</span>&quot;</span></span><br><span class="line">    <span class="attr">with_items:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">&quot;ls /opt&quot;</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">&quot;ls /home&quot;</span></span><br><span class="line">    <span class="attr">register:</span> <span class="string">returnvalue</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">debug:</span></span><br><span class="line">      <span class="attr">var:</span> <span class="string">returnvalue</span></span><br><span class="line"><span class="comment"># 可以使用如下方式,避免所有结果在最后的results中去获取</span></span><br><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="bullet">-</span> <span class="attr">hosts:</span> <span class="string">node2</span></span><br><span class="line">  <span class="attr">gather_facts:</span> <span class="literal">no</span></span><br><span class="line">  <span class="attr">tasks:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">shell:</span> <span class="string">&quot;<span class="template-variable">&#123;&#123;item&#125;&#125;</span>&quot;</span></span><br><span class="line">    <span class="attr">with_items:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">&quot;ls /opt&quot;</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">&quot;ls /home&quot;</span></span><br><span class="line">    <span class="attr">register:</span> <span class="string">returnvalue</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">debug:</span></span><br><span class="line">      <span class="attr">msg:</span> <span class="string">&quot;<span class="template-variable">&#123;&#123;item.stdout&#125;&#125;</span>&#x27;</span></span><br><span class="line"><span class="string">    with_items: &quot;</span>&#123;&#123;<span class="string">returnvalue.results</span>&#125;&#125;<span class="string">&quot;</span></span><br><span class="line"><span class="string"># 先使用循环重复的调用了shell模块，然后将shell模块每次执行后的返回值注册到了变量”returnvalue”中，之后，在使用debug模块时，通过返回值”results”获取到了之前每次执行shell模块的返回值（shell每次执行后的返回值已经被放入到item变量中），最后又通过返回值”stdout”获取到了每次shell模块执行后的标准输出</span></span><br></pre></td></tr></table></figure>
<h3 id="2021-07-04-使用循环-二-对列表循环的操作"><a href="#2021-07-04-使用循环-二-对列表循环的操作" class="headerlink" title="2021-07-04 使用循环(二),对列表循环的操作"></a>2021-07-04 使用循环(二),对列表循环的操作</h3>1,对序列循环有几个关键字</li>
<li>with_items: 当循环的序列元素也是列表时,展开与预期的有差异,会将所有的列表展开</li>
<li>with_list: 其他动作与with_items相同,只有在嵌套列表循环时有差异,子列表将会作为元素使用</li>
<li>with_flattened: 与with_items相同</li>
<li>with_together: 列对齐,”对齐合并”功能<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="bullet">-</span> <span class="attr">hosts:</span> <span class="string">node2</span></span><br><span class="line">  <span class="attr">remote_user:</span> <span class="string">root</span></span><br><span class="line">  <span class="attr">gather_facts:</span> <span class="literal">no</span></span><br><span class="line">  <span class="attr">tasks:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">debug:</span></span><br><span class="line">      <span class="attr">msg:</span> <span class="string">&quot;<span class="template-variable">&#123;&#123; item &#125;&#125;</span>&quot;</span></span><br><span class="line">    <span class="attr">with_together:</span></span><br><span class="line">    <span class="bullet">-</span> [ <span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span> ]</span><br><span class="line">    <span class="bullet">-</span> [ <span class="string">a</span>, <span class="string">b</span>, <span class="string">c</span> ]</span><br><span class="line"><span class="comment"># 输出如下:</span></span><br><span class="line"><span class="string">TASK</span> [<span class="string">debug</span>] <span class="string">xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx</span></span><br><span class="line"><span class="attr">ok:</span> [<span class="string">node2</span>] <span class="string">=&gt;</span> <span class="string">(item=[1,</span> <span class="string">u&#x27;a&#x27;])</span> <span class="string">=&gt;</span> &#123;</span><br><span class="line">    <span class="attr">&quot;changed&quot;:</span> <span class="literal">false</span>,</span><br><span class="line">    <span class="attr">&quot;item&quot;:</span> [</span><br><span class="line">        <span class="number">1</span>,</span><br><span class="line">        <span class="string">&quot;a&quot;</span></span><br><span class="line">    ],</span><br><span class="line">    <span class="attr">&quot;msg&quot;:</span> [</span><br><span class="line">        <span class="number">1</span>,</span><br><span class="line">        <span class="string">&quot;a&quot;</span></span><br><span class="line">    ]</span><br><span class="line">&#125;</span><br><span class="line"><span class="attr">ok:</span> [<span class="string">node2</span>] <span class="string">=&gt;</span> <span class="string">(item=[2,</span> <span class="string">u&#x27;b&#x27;])</span> <span class="string">=&gt;</span> &#123;</span><br><span class="line">    <span class="attr">&quot;changed&quot;:</span> <span class="literal">false</span>,</span><br><span class="line">    <span class="attr">&quot;item&quot;:</span> [</span><br><span class="line">        <span class="number">2</span>,</span><br><span class="line">        <span class="string">&quot;b&quot;</span></span><br><span class="line">    ],</span><br><span class="line">    <span class="attr">&quot;msg&quot;:</span> [</span><br><span class="line">        <span class="number">2</span>,</span><br><span class="line">        <span class="string">&quot;b&quot;</span></span><br><span class="line">    ]</span><br><span class="line">&#125;</span><br><span class="line"><span class="attr">ok:</span> [<span class="string">node2</span>] <span class="string">=&gt;</span> <span class="string">(item=[3,</span> <span class="string">u&#x27;c&#x27;])</span> <span class="string">=&gt;</span> &#123;</span><br><span class="line">    <span class="attr">&quot;changed&quot;:</span> <span class="literal">false</span>,</span><br><span class="line">    <span class="attr">&quot;item&quot;:</span> [</span><br><span class="line">        <span class="number">3</span>,</span><br><span class="line">        <span class="string">&quot;c&quot;</span></span><br><span class="line">    ],</span><br><span class="line">    <span class="attr">&quot;msg&quot;:</span> [</span><br><span class="line">        <span class="number">3</span>,</span><br><span class="line">        <span class="string">&quot;c&quot;</span></span><br><span class="line">    ]</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="2021-07-04-使用循环-三-嵌套循环"><a href="#2021-07-04-使用循环-三-嵌套循环" class="headerlink" title="2021-07-04 使用循环(三),嵌套循环"></a>2021-07-04 使用循环(三),嵌套循环</h3>1,with_cartesian和with_nested</li>
<li>当我们需要两个列表嵌套循环时,可以使用with_cartesian或者with_nested,将每个小列表中的元素按照”笛卡尔的方式”组合后，循环的处理每个组合,如下示例<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 下面的例子会在node2下创建6个目录</span></span><br><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="bullet">-</span> <span class="attr">hosts:</span> <span class="string">node2</span></span><br><span class="line">  <span class="attr">remote_user:</span> <span class="string">root</span></span><br><span class="line">  <span class="attr">gather_facts:</span> <span class="literal">no</span></span><br><span class="line">  <span class="attr">tasks:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">file:</span></span><br><span class="line">      <span class="attr">state:</span> <span class="string">directory</span></span><br><span class="line">      <span class="attr">path:</span> <span class="string">&quot;/testdir/testdir/<span class="template-variable">&#123;&#123; item.0 &#125;&#125;</span>/<span class="template-variable">&#123;&#123; item.1 &#125;&#125;</span>&quot;</span></span><br><span class="line">    <span class="attr">with_cartesian:</span></span><br><span class="line">    <span class="bullet">-</span> [ <span class="string">a</span>, <span class="string">b</span>, <span class="string">c</span> ]</span><br><span class="line">    <span class="bullet">-</span> [ <span class="string">test1</span>, <span class="string">test2</span> ]</span><br></pre></td></tr></table></figure>
<h3 id="2021-07-04-使用循环-四-序列索引循环"><a href="#2021-07-04-使用循环-四-序列索引循环" class="headerlink" title="2021-07-04 使用循环(四),序列索引循环"></a>2021-07-04 使用循环(四),序列索引循环</h3>1,使用到with_indexed_items,在处理列表中的每一项时，按照顺序为每一项添加了编号,如下示例:<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="bullet">-</span> <span class="attr">hosts:</span> <span class="string">node2</span></span><br><span class="line">  <span class="attr">remote_user:</span> <span class="string">root</span></span><br><span class="line">  <span class="attr">gather_facts:</span> <span class="literal">no</span></span><br><span class="line">  <span class="attr">tasks:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">debug:</span></span><br><span class="line">      <span class="attr">msg:</span> <span class="string">&quot;<span class="template-variable">&#123;&#123; item &#125;&#125;</span>&quot;</span></span><br><span class="line">    <span class="attr">with_indexed_items:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">test1</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">test2</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">test3</span></span><br><span class="line"><span class="comment"># 输出如下:</span></span><br><span class="line"><span class="string">TASK</span> [<span class="string">debug</span>] <span class="string">xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx</span></span><br><span class="line"><span class="attr">ok:</span> [<span class="string">node2</span>] <span class="string">=&gt;</span> <span class="string">(item=(0,</span> <span class="string">u&#x27;test1&#x27;))</span> <span class="string">=&gt;</span> &#123;</span><br><span class="line">    <span class="attr">&quot;changed&quot;:</span> <span class="literal">false</span>,</span><br><span class="line">    <span class="attr">&quot;item&quot;:</span> [</span><br><span class="line">        <span class="number">0</span>,</span><br><span class="line">        <span class="string">&quot;test1&quot;</span></span><br><span class="line">    ],</span><br><span class="line">    <span class="attr">&quot;msg&quot;:</span> [</span><br><span class="line">        <span class="number">0</span>,</span><br><span class="line">        <span class="string">&quot;test1&quot;</span></span><br><span class="line">    ]</span><br><span class="line">&#125;</span><br><span class="line"><span class="attr">ok:</span> [<span class="string">node2</span>] <span class="string">=&gt;</span> <span class="string">(item=(1,</span> <span class="string">u&#x27;test2&#x27;))</span> <span class="string">=&gt;</span> &#123;</span><br><span class="line">    <span class="attr">&quot;changed&quot;:</span> <span class="literal">false</span>,</span><br><span class="line">    <span class="attr">&quot;item&quot;:</span> [</span><br><span class="line">        <span class="number">1</span>,</span><br><span class="line">        <span class="string">&quot;test2&quot;</span></span><br><span class="line">    ],</span><br><span class="line">    <span class="attr">&quot;msg&quot;:</span> [</span><br><span class="line">        <span class="number">1</span>,</span><br><span class="line">        <span class="string">&quot;test2&quot;</span></span><br><span class="line">    ]</span><br><span class="line">&#125;</span><br><span class="line"><span class="attr">ok:</span> [<span class="string">node2</span>] <span class="string">=&gt;</span> <span class="string">(item=(2,</span> <span class="string">u&#x27;test3&#x27;))</span> <span class="string">=&gt;</span> &#123;</span><br><span class="line">    <span class="attr">&quot;changed&quot;:</span> <span class="literal">false</span>,</span><br><span class="line">    <span class="attr">&quot;item&quot;:</span> [</span><br><span class="line">        <span class="number">2</span>,</span><br><span class="line">        <span class="string">&quot;test3&quot;</span></span><br><span class="line">    ],</span><br><span class="line">    <span class="attr">&quot;msg&quot;:</span> [</span><br><span class="line">        <span class="number">2</span>,</span><br><span class="line">        <span class="string">&quot;test3&quot;</span></span><br><span class="line">    ]</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li>
<li>”with_indexed_items”会将嵌套的两层列表”拉平”，”拉平”后按照顺序为每一项编号</li>
<li>当多加了一层嵌套以后，”with_indexed_items”并不能像”with_flattened”一样将嵌套的列表”完全拉平”，第二层列表中的项如果仍然是一个列表，”with_indexed_items”则不会拉平这个列表，而是将其当做一个整体进行编号</li>
</ul>
<h3 id="2021-07-05-使用循环-五-with-sequence-with-random-choice"><a href="#2021-07-05-使用循环-五-with-sequence-with-random-choice" class="headerlink" title="2021-07-05 使用循环(五),with_sequence,with_random_choice"></a>2021-07-05 使用循环(五),with_sequence,with_random_choice</h3><p>1,with_sequence</p>
<ul>
<li>使用with_sequence生成序列,with_sequence可以按照顺序生成数字序列,如下示例:<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># debug模块被循环调用了5次，msg的值从1一直输出到了5，值的大小每次增加1</span></span><br><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="bullet">-</span> <span class="attr">hosts:</span> <span class="string">node2</span></span><br><span class="line">  <span class="attr">remote_user:</span> <span class="string">root</span></span><br><span class="line">  <span class="attr">gather_facts:</span> <span class="literal">no</span></span><br><span class="line">  <span class="attr">tasks:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">debug:</span></span><br><span class="line">      <span class="attr">msg:</span> <span class="string">&quot;<span class="template-variable">&#123;&#123; item &#125;&#125;</span>&quot;</span></span><br><span class="line">    <span class="attr">with_sequence:</span> <span class="string">start=1</span> <span class="string">end=5</span> <span class="string">stride=1</span></span><br><span class="line">    <span class="comment"># 下列写法结果一致</span></span><br><span class="line">    <span class="comment"># with_sequence: count=5</span></span><br></pre></td></tr></table></figure>
<ul>
<li>使用with_sequence还可以格式化输出<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="bullet">-</span> <span class="attr">hosts:</span> <span class="string">node2</span></span><br><span class="line">  <span class="attr">remote_user:</span> <span class="string">root</span></span><br><span class="line">  <span class="attr">gather_facts:</span> <span class="literal">no</span></span><br><span class="line">  <span class="attr">tasks:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">debug:</span></span><br><span class="line">      <span class="attr">msg:</span> <span class="string">&quot;<span class="template-variable">&#123;&#123;item&#125;&#125;</span>&quot;</span></span><br><span class="line">    <span class="attr">with_sequence:</span> <span class="string">start=2</span> <span class="string">end=6</span> <span class="string">stride=2</span> <span class="string">format=&quot;number</span> <span class="string">is</span> <span class="string">%0.2f&quot;</span></span><br></pre></td></tr></table></figure></li>
</ul>
</li>
</ul>
<p>2,with_random_choice,使用with_random_choice可以从列表的多个值中随机返回一个值</p>
<ul>
<li>如下示例:<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="bullet">-</span> <span class="attr">hosts:</span> <span class="string">node2</span></span><br><span class="line">  <span class="attr">remote_user:</span> <span class="string">root</span></span><br><span class="line">  <span class="attr">gather_facts:</span> <span class="literal">no</span></span><br><span class="line">  <span class="attr">tasks:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">debug:</span></span><br><span class="line">      <span class="attr">msg:</span> <span class="string">&quot;<span class="template-variable">&#123;&#123;item&#125;&#125;</span>&quot;</span></span><br><span class="line">    <span class="attr">with_random_choice:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="number">1</span></span><br><span class="line">    <span class="bullet">-</span> <span class="number">2</span></span><br><span class="line">    <span class="bullet">-</span> <span class="number">3</span></span><br><span class="line">    <span class="bullet">-</span> <span class="number">4</span></span><br><span class="line">    <span class="bullet">-</span> <span class="number">5</span></span><br></pre></td></tr></table></figure>
<h3 id="2021-07-05-使用循环-六-with-dict-with-subelements-with-file"><a href="#2021-07-05-使用循环-六-with-dict-with-subelements-with-file" class="headerlink" title="2021-07-05 使用循环(六),with_dict,with_subelements,with_file"></a>2021-07-05 使用循环(六),with_dict,with_subelements,with_file</h3>1,with_dict,循环遍历字典元素,如下示例:<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="bullet">-</span> <span class="attr">hosts:</span> <span class="string">node2</span></span><br><span class="line">  <span class="attr">remote_user:</span> <span class="string">root</span></span><br><span class="line">  <span class="attr">gather_facts:</span> <span class="literal">no</span></span><br><span class="line">  <span class="attr">vars:</span></span><br><span class="line">    <span class="attr">users:</span></span><br><span class="line">      <span class="attr">alice:</span></span><br><span class="line">        <span class="attr">name:</span> <span class="string">Alice</span> <span class="string">Appleworth</span></span><br><span class="line">        <span class="attr">gender:</span> <span class="string">female</span></span><br><span class="line">        <span class="attr">telephone:</span> <span class="number">123</span><span class="number">-456</span><span class="number">-7890</span></span><br><span class="line">      <span class="attr">bob:</span></span><br><span class="line">        <span class="attr">name:</span> <span class="string">Bob</span> <span class="string">Bananarama</span></span><br><span class="line">        <span class="attr">gender:</span> <span class="string">male</span></span><br><span class="line">        <span class="attr">telephone:</span> <span class="number">987</span><span class="number">-654</span><span class="number">-3210</span></span><br><span class="line">  <span class="attr">tasks:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">debug:</span></span><br><span class="line">      <span class="attr">msg:</span> <span class="string">&quot;<span class="template-variable">&#123;&#123;item&#125;&#125;</span>&quot;</span></span><br><span class="line">    <span class="attr">with_dict:</span> <span class="string">&quot;<span class="template-variable">&#123;&#123;users&#125;&#125;</span>&quot;</span></span><br><span class="line"><span class="comment"># 输出如下:</span></span><br><span class="line"><span class="string">TASK</span> [<span class="string">debug</span>] <span class="string">xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx</span></span><br><span class="line"><span class="attr">ok:</span> [<span class="string">node2</span>] <span class="string">=&gt;</span> <span class="string">(item=&#123;&#x27;value&#x27;:</span> &#123;<span class="string">u&#x27;gender&#x27;:</span> <span class="string">u&#x27;male&#x27;</span>, <span class="string">u&#x27;name&#x27;:</span> <span class="string">u&#x27;Bob</span> <span class="string">Bananarama&#x27;</span>, <span class="string">u&#x27;telephone&#x27;:</span> <span class="string">u&#x27;987-654-3210&#x27;</span>&#125;<span class="string">,</span> <span class="attr">&#x27;key&#x27;:</span> <span class="string">u&#x27;bob&#x27;&#125;)</span> <span class="string">=&gt;</span> &#123;</span><br><span class="line">    <span class="attr">&quot;changed&quot;:</span> <span class="literal">false</span>,</span><br><span class="line">    <span class="attr">&quot;item&quot;:</span> &#123;</span><br><span class="line">        <span class="attr">&quot;key&quot;:</span> <span class="string">&quot;bob&quot;</span>,</span><br><span class="line">        <span class="attr">&quot;value&quot;:</span> &#123;</span><br><span class="line">            <span class="attr">&quot;gender&quot;:</span> <span class="string">&quot;male&quot;</span>,</span><br><span class="line">            <span class="attr">&quot;name&quot;:</span> <span class="string">&quot;Bob Bananarama&quot;</span>,</span><br><span class="line">            <span class="attr">&quot;telephone&quot;:</span> <span class="string">&quot;987-654-3210&quot;</span></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="attr">&quot;msg&quot;:</span> &#123;</span><br><span class="line">        <span class="attr">&quot;key&quot;:</span> <span class="string">&quot;bob&quot;</span>,</span><br><span class="line">        <span class="attr">&quot;value&quot;:</span> &#123;</span><br><span class="line">            <span class="attr">&quot;gender&quot;:</span> <span class="string">&quot;male&quot;</span>,</span><br><span class="line">            <span class="attr">&quot;name&quot;:</span> <span class="string">&quot;Bob Bananarama&quot;</span>,</span><br><span class="line">            <span class="attr">&quot;telephone&quot;:</span> <span class="string">&quot;987-654-3210&quot;</span></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="attr">ok:</span> [<span class="string">node2</span>] <span class="string">=&gt;</span> <span class="string">(item=&#123;&#x27;value&#x27;:</span> &#123;<span class="string">u&#x27;gender&#x27;:</span> <span class="string">u&#x27;female&#x27;</span>, <span class="string">u&#x27;name&#x27;:</span> <span class="string">u&#x27;Alice</span> <span class="string">Appleworth&#x27;</span>, <span class="string">u&#x27;telephone&#x27;:</span> <span class="string">u&#x27;123-456-7890&#x27;</span>&#125;<span class="string">,</span> <span class="attr">&#x27;key&#x27;:</span> <span class="string">u&#x27;alice&#x27;&#125;)</span> <span class="string">=&gt;</span> &#123;</span><br><span class="line">    <span class="attr">&quot;changed&quot;:</span> <span class="literal">false</span>,</span><br><span class="line">    <span class="attr">&quot;item&quot;:</span> &#123;</span><br><span class="line">        <span class="attr">&quot;key&quot;:</span> <span class="string">&quot;alice&quot;</span>,</span><br><span class="line">        <span class="attr">&quot;value&quot;:</span> &#123;</span><br><span class="line">            <span class="attr">&quot;gender&quot;:</span> <span class="string">&quot;female&quot;</span>,</span><br><span class="line">            <span class="attr">&quot;name&quot;:</span> <span class="string">&quot;Alice Appleworth&quot;</span>,</span><br><span class="line">            <span class="attr">&quot;telephone&quot;:</span> <span class="string">&quot;123-456-7890&quot;</span></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="attr">&quot;msg&quot;:</span> &#123;</span><br><span class="line">        <span class="attr">&quot;key&quot;:</span> <span class="string">&quot;alice&quot;</span>,</span><br><span class="line">        <span class="attr">&quot;value&quot;:</span> &#123;</span><br><span class="line">            <span class="attr">&quot;gender&quot;:</span> <span class="string">&quot;female&quot;</span>,</span><br><span class="line">            <span class="attr">&quot;name&quot;:</span> <span class="string">&quot;Alice Appleworth&quot;</span>,</span><br><span class="line">            <span class="attr">&quot;telephone&quot;:</span> <span class="string">&quot;123-456-7890&quot;</span></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li>
</ul>
<p>2,with_subelements:</p>
<ul>
<li>with_subelements会将hobby子元素列表中的每一项作为一个整体，将其他子元素作为一个整体，然后组合在一起<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 如下示例:</span></span><br><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="bullet">-</span> <span class="attr">hosts:</span> <span class="string">node2</span></span><br><span class="line">  <span class="attr">remote_user:</span> <span class="string">root</span></span><br><span class="line">  <span class="attr">gather_facts:</span> <span class="literal">no</span></span><br><span class="line">  <span class="attr">vars:</span></span><br><span class="line">    <span class="attr">users:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">bob</span></span><br><span class="line">      <span class="attr">gender:</span> <span class="string">male</span></span><br><span class="line">      <span class="attr">hobby:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="string">Skateboard</span></span><br><span class="line">        <span class="bullet">-</span> <span class="string">VideoGame</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">alice</span></span><br><span class="line">      <span class="attr">gender:</span> <span class="string">female</span></span><br><span class="line">      <span class="attr">hobby:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="string">Music</span></span><br><span class="line">  <span class="attr">tasks:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">debug:</span></span><br><span class="line">      <span class="attr">msg:</span> <span class="string">&quot;<span class="template-variable">&#123;&#123; item &#125;&#125;</span>&quot;</span></span><br><span class="line">    <span class="attr">with_subelements:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">&quot;<span class="template-variable">&#123;&#123;users&#125;&#125;</span>&quot;</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">hobby</span></span><br><span class="line"><span class="comment"># 输出如下:</span></span><br><span class="line"><span class="string">TASK</span> [<span class="string">debug</span>] <span class="string">xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx</span></span><br><span class="line"><span class="attr">ok:</span> [<span class="string">node2</span>] <span class="string">=&gt;</span> <span class="string">(item=(&#123;u&#x27;gender&#x27;:</span> <span class="string">u&#x27;male&#x27;,</span> <span class="string">u&#x27;name&#x27;:</span> <span class="string">u&#x27;bob&#x27;&#125;,</span> <span class="string">u&#x27;Skateboard&#x27;))</span> <span class="string">=&gt;</span> &#123;</span><br><span class="line">    <span class="attr">&quot;changed&quot;:</span> <span class="literal">false</span>,</span><br><span class="line">    <span class="attr">&quot;item&quot;:</span> [</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="attr">&quot;gender&quot;:</span> <span class="string">&quot;male&quot;</span>,</span><br><span class="line">            <span class="attr">&quot;name&quot;:</span> <span class="string">&quot;bob&quot;</span></span><br><span class="line">        &#125;,</span><br><span class="line">        <span class="string">&quot;Skateboard&quot;</span></span><br><span class="line">    ],</span><br><span class="line">    <span class="attr">&quot;msg&quot;:</span> [</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="attr">&quot;gender&quot;:</span> <span class="string">&quot;male&quot;</span>,</span><br><span class="line">            <span class="attr">&quot;name&quot;:</span> <span class="string">&quot;bob&quot;</span></span><br><span class="line">        &#125;,</span><br><span class="line">        <span class="string">&quot;Skateboard&quot;</span></span><br><span class="line">    ]</span><br><span class="line">&#125;</span><br><span class="line"><span class="attr">ok:</span> [<span class="string">node2</span>] <span class="string">=&gt;</span> <span class="string">(item=(&#123;u&#x27;gender&#x27;:</span> <span class="string">u&#x27;male&#x27;,</span> <span class="string">u&#x27;name&#x27;:</span> <span class="string">u&#x27;bob&#x27;&#125;,</span> <span class="string">u&#x27;VideoGame&#x27;))</span> <span class="string">=&gt;</span> &#123;</span><br><span class="line">    <span class="attr">&quot;changed&quot;:</span> <span class="literal">false</span>,</span><br><span class="line">    <span class="attr">&quot;item&quot;:</span> [</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="attr">&quot;gender&quot;:</span> <span class="string">&quot;male&quot;</span>,</span><br><span class="line">            <span class="attr">&quot;name&quot;:</span> <span class="string">&quot;bob&quot;</span></span><br><span class="line">        &#125;,</span><br><span class="line">        <span class="string">&quot;VideoGame&quot;</span></span><br><span class="line">    ],</span><br><span class="line">    <span class="attr">&quot;msg&quot;:</span> [</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="attr">&quot;gender&quot;:</span> <span class="string">&quot;male&quot;</span>,</span><br><span class="line">            <span class="attr">&quot;name&quot;:</span> <span class="string">&quot;bob&quot;</span></span><br><span class="line">        &#125;,</span><br><span class="line">        <span class="string">&quot;VideoGame&quot;</span></span><br><span class="line">    ]</span><br><span class="line">&#125;</span><br><span class="line"><span class="attr">ok:</span> [<span class="string">node2</span>] <span class="string">=&gt;</span> <span class="string">(item=(&#123;u&#x27;gender&#x27;:</span> <span class="string">u&#x27;female&#x27;,</span> <span class="string">u&#x27;name&#x27;:</span> <span class="string">u&#x27;alice&#x27;&#125;,</span> <span class="string">u&#x27;Music&#x27;))</span> <span class="string">=&gt;</span> &#123;</span><br><span class="line">    <span class="attr">&quot;changed&quot;:</span> <span class="literal">false</span>,</span><br><span class="line">    <span class="attr">&quot;item&quot;:</span> [</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="attr">&quot;gender&quot;:</span> <span class="string">&quot;female&quot;</span>,</span><br><span class="line">            <span class="attr">&quot;name&quot;:</span> <span class="string">&quot;alice&quot;</span></span><br><span class="line">        &#125;,</span><br><span class="line">        <span class="string">&quot;Music&quot;</span></span><br><span class="line">    ],</span><br><span class="line">    <span class="attr">&quot;msg&quot;:</span> [</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="attr">&quot;gender&quot;:</span> <span class="string">&quot;female&quot;</span>,</span><br><span class="line">            <span class="attr">&quot;name&quot;:</span> <span class="string">&quot;alice&quot;</span></span><br><span class="line">        &#125;,</span><br><span class="line">        <span class="string">&quot;Music&quot;</span></span><br><span class="line">    ]</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li>
<li>由于item由两个整体组成，所以，我们通过item.0获取到第一个小整体，即gender和name属性，然后通过item.1获取到第二个小整体，即hobby列表中的每一项<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="bullet">-</span> <span class="attr">hosts:</span> <span class="string">node2</span></span><br><span class="line">  <span class="attr">remote_user:</span> <span class="string">root</span></span><br><span class="line">  <span class="attr">gather_facts:</span> <span class="literal">no</span></span><br><span class="line">  <span class="attr">vars:</span></span><br><span class="line">    <span class="attr">users:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">bob</span></span><br><span class="line">      <span class="attr">gender:</span> <span class="string">male</span></span><br><span class="line">      <span class="attr">hobby:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="string">Skateboard</span></span><br><span class="line">        <span class="bullet">-</span> <span class="string">VideoGame</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">alice</span></span><br><span class="line">      <span class="attr">gender:</span> <span class="string">female</span></span><br><span class="line">      <span class="attr">hobby:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="string">Music</span></span><br><span class="line">  <span class="attr">tasks:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">debug:</span></span><br><span class="line">      <span class="attr">msg:</span> <span class="string">&quot;<span class="template-variable">&#123;&#123; item.0.name &#125;&#125;</span> &#x27;s hobby is <span class="template-variable">&#123;&#123; item.1 &#125;&#125;</span>&quot;</span></span><br><span class="line">    <span class="attr">with_subelements:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">&quot;<span class="template-variable">&#123;&#123;users&#125;&#125;</span>&quot;</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">hobby</span></span><br><span class="line"><span class="comment"># msg内容如下:</span></span><br><span class="line"><span class="attr">&quot;msg&quot;:</span> <span class="string">&quot;bob &#x27;s hobby is Skateboard&quot;</span></span><br><span class="line"><span class="attr">&quot;msg&quot;:</span> <span class="string">&quot;bob &#x27;s hobby is VideoGame&quot;</span></span><br><span class="line"><span class="attr">&quot;msg&quot;:</span> <span class="string">&quot;alice &#x27;s hobby is Music&quot;</span></span><br></pre></td></tr></table></figure>
<h3 id="2021-07-05-使用循环-七-with-file-with-fileglob"><a href="#2021-07-05-使用循环-七-with-file-with-fileglob" class="headerlink" title="2021-07-05 使用循环(七) with_file, with_fileglob"></a>2021-07-05 使用循环(七) with_file, with_fileglob</h3>1, ansible主机中有几个文件,若需要获取到这些文件的内容，可以使用with_file关键字，循环的获取到这些文件的内容</li>
<li>如下示例:<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 无论目标主机是谁，都可以通过with_file关键字获取到ansible主机中的文件内容</span></span><br><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="bullet">-</span> <span class="attr">hosts:</span> <span class="string">node2</span></span><br><span class="line">  <span class="attr">remote_user:</span> <span class="string">root</span></span><br><span class="line">  <span class="attr">gather_facts:</span> <span class="literal">no</span></span><br><span class="line">  <span class="attr">tasks:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">debug:</span></span><br><span class="line">      <span class="attr">msg:</span> <span class="string">&quot;<span class="template-variable">&#123;&#123; item &#125;&#125;</span>&quot;</span></span><br><span class="line">    <span class="attr">with_file:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">/testdir/testdir/a.log</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">/opt/testfile</span></span><br></pre></td></tr></table></figure></li>
</ul>
<p>2,可以通过with_fileglob关键字，在指定的目录中匹配符合模式的文件名，with_file与with_fileglob相同的地方，它们都是针对ansible主机的文件进行操作，而不是目标主机</p>
<ul>
<li>如下示例:<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="bullet">-</span> <span class="attr">hosts:</span> <span class="string">node2</span></span><br><span class="line">  <span class="attr">remote_user:</span> <span class="string">root</span></span><br><span class="line">  <span class="attr">gather_facts:</span> <span class="literal">no</span></span><br><span class="line">  <span class="attr">tasks:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">debug:</span></span><br><span class="line">      <span class="attr">msg:</span> <span class="string">&quot;<span class="template-variable">&#123;&#123; item &#125;&#125;</span>&quot;</span></span><br><span class="line">    <span class="attr">with_fileglob:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">/testdir/(此处为星号,删除防止下面格式错乱)</span></span><br><span class="line"><span class="comment"># 输出如下:</span></span><br><span class="line"><span class="string">TASK</span> [<span class="string">debug</span>] <span class="string">xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx</span></span><br><span class="line"><span class="attr">ok:</span> [<span class="string">node2</span>] <span class="string">=&gt;</span> <span class="string">(item=/testdir/testfile)</span> <span class="string">=&gt;</span> &#123;</span><br><span class="line">    <span class="attr">&quot;changed&quot;:</span> <span class="literal">false</span>,</span><br><span class="line">    <span class="attr">&quot;item&quot;:</span> <span class="string">&quot;/testdir/testfile&quot;</span>,</span><br><span class="line">    <span class="attr">&quot;msg&quot;:</span> <span class="string">&quot;/testdir/testfile&quot;</span></span><br><span class="line">&#125;</span><br><span class="line"><span class="attr">ok:</span> [<span class="string">node2</span>] <span class="string">=&gt;</span> <span class="string">(item=/testdir/test.sh)</span> <span class="string">=&gt;</span> &#123;</span><br><span class="line">    <span class="attr">&quot;changed&quot;:</span> <span class="literal">false</span>,</span><br><span class="line">    <span class="attr">&quot;item&quot;:</span> <span class="string">&quot;/testdir/test.sh&quot;</span>,</span><br><span class="line">    <span class="attr">&quot;msg&quot;:</span> <span class="string">&quot;/testdir/test.sh&quot;</span></span><br><span class="line">&#125;</span><br><span class="line"><span class="comment"># 需要注意的是，with_fileglob只会匹配指定目录中的文件，而不会匹配指定目录中的目录</span></span><br></pre></td></tr></table></figure></li>
</ul>
<h3 id="2021-07-06-条件判断-六-with-dict-with-subelements-with-file"><a href="#2021-07-06-条件判断-六-with-dict-with-subelements-with-file" class="headerlink" title="2021-07-06 条件判断(六),with_dict,with_subelements,with_file"></a>2021-07-06 条件判断(六),with_dict,with_subelements,with_file</h3><p>1,绝大多数语言中，都使用if作为条件判断的关键字，而在ansible中，条件判断的关键字是when</p>
<ul>
<li>如下示例:<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="bullet">-</span> <span class="attr">hosts:</span> <span class="string">node2</span></span><br><span class="line">  <span class="attr">remote_user:</span> <span class="string">root</span></span><br><span class="line">  <span class="attr">tasks:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">test</span> <span class="string">when</span></span><br><span class="line">    <span class="attr">debug:</span></span><br><span class="line">      <span class="attr">msg:</span> <span class="string">&quot;System is centos&quot;</span></span><br><span class="line">    <span class="comment"># 如果需要获取到facts中的key的值，都是通过引用变量的方式获取的，即&quot;&#123;&#123; key &#125;&#125;&quot;</span></span><br><span class="line">    <span class="comment"># 在when关键字中引用变量时，变量名不需要加&quot;&#123;&#123;  &#125;&#125;&quot;</span></span><br><span class="line">    <span class="attr">when:</span> <span class="string">ansible_distribution</span> <span class="string">==</span> <span class="string">&quot;CentOS&quot;</span></span><br></pre></td></tr></table></figure></li>
</ul>
<p>2,使用when关键字为任务指定条件，条件成立，则执行任务，条件不成立，则不执行任务</p>
<ul>
<li>如下示例:<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="bullet">-</span> <span class="attr">hosts:</span> <span class="string">node2</span></span><br><span class="line">  <span class="attr">remote_user:</span> <span class="string">root</span></span><br><span class="line">  <span class="attr">gather_facts:</span> <span class="literal">no</span></span><br><span class="line">  <span class="attr">tasks:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">debug:</span></span><br><span class="line">      <span class="attr">msg:</span> <span class="string">&quot;<span class="template-variable">&#123;&#123;item&#125;&#125;</span>&quot;</span></span><br><span class="line">    <span class="attr">with_items:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="number">1</span></span><br><span class="line">    <span class="bullet">-</span> <span class="number">2</span></span><br><span class="line">    <span class="bullet">-</span> <span class="number">3</span></span><br><span class="line">    <span class="attr">when:</span> <span class="string">item</span> <span class="string">&gt;</span> <span class="number">1</span></span><br></pre></td></tr></table></figure></li>
</ul>
<p>3,在ansible中，使用如下比较运算符.</p>
<ul>
<li>如下所示:<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">==  :比较两个对象是否相等，相等为真</span><br><span class="line">!=  :比较两个对象是否不等，不等为真</span><br><span class="line">&gt;   :比较两个值的大小，如果左边的值大于右边的值，则为真</span><br><span class="line">&lt;   :比较两个值的大小，如果左边的值小于右边的值，则为真</span><br><span class="line">&gt;=  :比较两个值的大小，如果左边的值大于右边的值或左右相等，则为真</span><br><span class="line">&lt;=  :比较两个值的大小，如果左边的值小于右边的值或左右相等，则为真</span><br><span class="line">上述总结的这些运算符其实都是jinja2的运算符，ansible使用jinja2模板引擎，在ansible中也可以直接使用jinja2的这些运算符</span><br><span class="line"></span><br><span class="line">上述为比较运算符，再来说说逻辑运算符，可用的逻辑运算符如下:</span><br><span class="line">and  :逻辑与，当左边与右边同时为真，则返回真</span><br><span class="line">or   :逻辑或，当左边与右边有任意一个为真，则返回真</span><br><span class="line">not  :取反，对一个操作体取反</span><br><span class="line">( )  :组合，将一组操作体包装在一起，形成一个较大的操作体</span><br></pre></td></tr></table></figure></li>
<li>如下示例:<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 示例1:</span></span><br><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="bullet">-</span> <span class="attr">hosts:</span> <span class="string">node2</span></span><br><span class="line">  <span class="attr">remote_user:</span> <span class="string">root</span></span><br><span class="line">  <span class="attr">tasks:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">debug:</span></span><br><span class="line">      <span class="attr">msg:</span> <span class="string">&quot;System release is centos7&quot;</span></span><br><span class="line">    <span class="attr">when:</span></span><br><span class="line">    <span class="comment"># 使用列表,列表中的每一项都是一个条件，列表中的所有条件同时成立时，对应的任务才会执行</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">ansible_distribution</span> <span class="string">==</span> <span class="string">&quot;CentOS&quot;</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">ansible_distribution_major_version</span> <span class="string">==</span> <span class="string">&quot;7&quot;</span></span><br><span class="line"><span class="comment"># 示例2:</span></span><br><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="bullet">-</span> <span class="attr">hosts:</span> <span class="string">node2</span></span><br><span class="line">  <span class="attr">remote_user:</span> <span class="string">root</span></span><br><span class="line">  <span class="attr">tasks:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">debug:</span></span><br><span class="line">      <span class="attr">msg:</span> <span class="string">&quot;System release is centos6 or centos7&quot;</span></span><br><span class="line">    <span class="comment"># 比较运算符和逻辑运算符结合使用作为条件判断</span></span><br><span class="line">    <span class="attr">when:</span> <span class="string">ansible_distribution</span> <span class="string">==</span> <span class="string">&quot;CentOS&quot;</span> <span class="string">and</span></span><br><span class="line">          <span class="string">(ansible_distribution_major_version</span> <span class="string">==</span> <span class="string">&quot;6&quot;</span> <span class="string">or</span> <span class="string">ansible_distribution_major_version</span> <span class="string">==</span> <span class="string">&quot;7&quot;</span><span class="string">)</span></span><br><span class="line"><span class="comment"># 示例3:</span></span><br><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="bullet">-</span> <span class="attr">hosts:</span> <span class="string">node2</span></span><br><span class="line">  <span class="attr">remote_user:</span> <span class="string">root</span></span><br><span class="line">  <span class="attr">tasks:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">debug:</span></span><br><span class="line">      <span class="attr">msg:</span> <span class="string">&quot;System release is not centos&quot;</span></span><br><span class="line">    <span class="comment"># 逻辑取反</span></span><br><span class="line">    <span class="attr">when:</span> <span class="string">not</span> <span class="string">ansible_distribution</span> <span class="string">==</span> <span class="string">&quot;CentOS&quot;</span></span><br><span class="line"><span class="comment"># 示例4:</span></span><br><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="bullet">-</span> <span class="attr">hosts:</span> <span class="string">node2</span></span><br><span class="line">  <span class="attr">remote_user:</span> <span class="string">root</span></span><br><span class="line">  <span class="attr">tasks:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">task1</span></span><br><span class="line">    <span class="attr">shell:</span> <span class="string">&quot;ls /testabc&quot;</span></span><br><span class="line">    <span class="attr">register:</span> <span class="string">returnmsg</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">task2</span></span><br><span class="line">    <span class="attr">debug:</span></span><br><span class="line">      <span class="attr">msg:</span> <span class="string">&quot;Command execution successful&quot;</span></span><br><span class="line">    <span class="comment"># 通过shell指令的返回值判断是否执行</span></span><br><span class="line">    <span class="attr">when:</span> <span class="string">returnmsg.rc</span> <span class="string">==</span> <span class="number">0</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">task3</span></span><br><span class="line">    <span class="attr">debug:</span></span><br><span class="line">      <span class="attr">msg:</span> <span class="string">&quot;Command execution failed&quot;</span></span><br><span class="line">    <span class="attr">when:</span> <span class="string">returnmsg.rc</span> <span class="type">!=</span> <span class="number">0</span></span><br></pre></td></tr></table></figure></li>
</ul>
<p>3,结合ignore_errors和when来限定playbook的执行</p>
<ul>
<li>如下示例:<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="bullet">-</span> <span class="attr">hosts:</span> <span class="string">node2</span></span><br><span class="line">  <span class="attr">remote_user:</span> <span class="string">root</span></span><br><span class="line">  <span class="attr">tasks:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">task1</span></span><br><span class="line">    <span class="attr">shell:</span> <span class="string">&quot;ls /testabc&quot;</span></span><br><span class="line">    <span class="attr">register:</span> <span class="string">returnmsg</span></span><br><span class="line">    <span class="comment"># 此处增加了ignore_errors,在不存在/testabc目录的节点就不会报错,playbook不会退出,task2,task3通过rc值来确定是否要执行</span></span><br><span class="line">    <span class="attr">ignore_errors:</span> <span class="literal">true</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">task2</span></span><br><span class="line">    <span class="attr">debug:</span></span><br><span class="line">      <span class="attr">msg:</span> <span class="string">&quot;Command execution successful&quot;</span></span><br><span class="line">    <span class="attr">when:</span> <span class="string">returnmsg.rc</span> <span class="string">==</span> <span class="number">0</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">task3</span></span><br><span class="line">    <span class="attr">debug:</span></span><br><span class="line">      <span class="attr">msg:</span> <span class="string">&quot;Command execution failed&quot;</span></span><br><span class="line">    <span class="attr">when:</span> <span class="string">returnmsg.rc</span> <span class="type">!=</span> <span class="number">0</span></span><br></pre></td></tr></table></figure></li>
</ul>
<h3 id="2021-07-09-条件判断与tests"><a href="#2021-07-09-条件判断与tests" class="headerlink" title="2021-07-09 条件判断与tests"></a>2021-07-09 条件判断与tests</h3><p>1,在ansible中也有类似bash中test的用法,不过是借助jinja2的tests，借助tests，可以进行一些判断操作，tests会将判断后的布尔值返回，如果条件成立，返回true，否则返回false，通常在条件判断时使用到tests</p>
<ul>
<li>如下示例:<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="bullet">-</span> <span class="attr">hosts:</span> <span class="string">me</span></span><br><span class="line">  <span class="attr">gather_facts:</span> <span class="literal">no</span></span><br><span class="line">  <span class="attr">remote_user:</span> <span class="string">root</span></span><br><span class="line">  <span class="attr">vars:</span></span><br><span class="line">    <span class="attr">testpath:</span> <span class="string">/testdir</span></span><br><span class="line">  <span class="attr">tasks:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">test</span> <span class="string">tests</span></span><br><span class="line">    <span class="attr">debug:</span></span><br><span class="line">      <span class="attr">msg:</span> <span class="string">&quot;test dir exist&quot;</span></span><br><span class="line">    <span class="comment"># &quot;is exists&quot;中的&quot;exists&quot;就是tests的一种，它与&quot;test -e&quot;命令的作用是相同的，通过&quot;exists&quot;可以判断ansible主机中的对应路径是否存在</span></span><br><span class="line">    <span class="comment"># &quot;is not exists&quot;表示对应路径不存在时返回真</span></span><br><span class="line">    <span class="comment"># 上述内容都是在ansible主机中判断的,和远端目标主机无关</span></span><br><span class="line">    <span class="attr">when:</span> <span class="string">testpath</span> <span class="string">is</span> <span class="string">exists</span></span><br></pre></td></tr></table></figure></li>
</ul>
<p>2,判断变量的一些tests</p>
<ul>
<li>defined: 判断变量是否已经定义，已经定义则返回真</li>
<li>undefined: 判断变量是否已经定义，未定义则返回真</li>
<li>none: 判断变量值是否为空，如果变量已经定义，但是变量值为空，则返回真</li>
<li>上述内容,如下示例:<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="bullet">-</span> <span class="attr">hosts:</span> <span class="string">me</span></span><br><span class="line">  <span class="attr">remote_user:</span> <span class="string">root</span></span><br><span class="line">  <span class="attr">gather_facts:</span> <span class="literal">no</span></span><br><span class="line">  <span class="attr">vars:</span></span><br><span class="line">    <span class="attr">testvar:</span> <span class="string">&quot;test&quot;</span></span><br><span class="line">    <span class="attr">testvar1:</span></span><br><span class="line">  <span class="attr">tasks:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">debug:</span></span><br><span class="line">      <span class="attr">msg:</span> <span class="string">&quot;Variable is defined&quot;</span></span><br><span class="line">    <span class="attr">when:</span> <span class="string">testvar</span> <span class="string">is</span> <span class="string">defined</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">debug:</span></span><br><span class="line">      <span class="attr">msg:</span> <span class="string">&quot;Variable is undefined&quot;</span></span><br><span class="line">    <span class="attr">when:</span> <span class="string">testvar2</span> <span class="string">is</span> <span class="string">undefined</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">debug:</span></span><br><span class="line">      <span class="attr">msg:</span> <span class="string">&quot;The variable is defined, but there is no value&quot;</span></span><br><span class="line">    <span class="attr">when:</span> <span class="string">testvar1</span> <span class="string">is</span> <span class="string">none</span></span><br></pre></td></tr></table></figure></li>
</ul>
<p>3,判断执行结果的一些tests</p>
<ul>
<li>success或者succeeded: 通过任务的返回信息判断任务的返回状态,任务执行成功则返回真</li>
<li>failure或者failed: 通过任务的返回信息判断任务的返回状态,任务执行失败则返回真</li>
<li>change后者changed: 通过任务的返回信息判断任务的返回状态,任务执行状态为changed则返回真</li>
<li>skip或者skipped: 通过任务的返回信息判断任务的返回状态,当任务没有满足执行条件,而被跳过执行时,则返回真</li>
<li>如下示例:<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="bullet">-</span> <span class="attr">hosts:</span> <span class="string">me</span></span><br><span class="line">  <span class="attr">remote_user:</span> <span class="string">liawne</span></span><br><span class="line">  <span class="attr">gather_facts:</span> <span class="literal">no</span></span><br><span class="line">  <span class="attr">vars:</span></span><br><span class="line">    <span class="attr">doshell:</span> <span class="string">&quot;yes&quot;</span></span><br><span class="line">  <span class="attr">tasks:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">execute</span></span><br><span class="line">    <span class="attr">shell:</span> <span class="string">cat</span> <span class="string">/testdir/test</span></span><br><span class="line">    <span class="attr">when:</span> <span class="string">doshell</span> <span class="string">==</span> <span class="string">&quot;yes&quot;</span></span><br><span class="line">    <span class="attr">register:</span> <span class="string">retmsg</span></span><br><span class="line">    <span class="attr">ignore_errors:</span> <span class="literal">true</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">debug:</span></span><br><span class="line">      <span class="attr">msg:</span> <span class="string">&quot;task success&quot;</span></span><br><span class="line">    <span class="attr">when:</span> <span class="string">retmsg</span> <span class="string">is</span> <span class="string">success</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">debug:</span></span><br><span class="line">      <span class="attr">msg:</span> <span class="string">&quot;task failed&quot;</span></span><br><span class="line">    <span class="attr">when:</span> <span class="string">retmsg</span> <span class="string">is</span> <span class="string">failed</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">debug:</span></span><br><span class="line">      <span class="attr">msg:</span> <span class="string">&quot;task skipped&quot;</span></span><br><span class="line">    <span class="attr">when:</span> <span class="string">retmsg</span> <span class="string">is</span> <span class="string">skip</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">debug:</span></span><br><span class="line">      <span class="attr">msg:</span> <span class="string">&quot;task changed&quot;</span></span><br><span class="line">    <span class="attr">when:</span> <span class="string">retmsg</span> <span class="string">is</span> <span class="string">changed</span></span><br></pre></td></tr></table></figure></li>
</ul>
<p>4,判断路径的一些tests</p>
<ul>
<li>注:如下tests的判断均针对于ansible主机中的路径,与目标主机无关</li>
<li>file : 判断路径是否是一个文件,如果路径是一个文件则返回真</li>
<li>directory :判断路径是否是一个目录,如果路径是一个目录则返回真</li>
<li>link :判断路径是否是一个软链接,如果路径是一个软链接则返回真</li>
<li>mount:判断路径是否是一个挂载点,如果路径是一个挂载点则返回真</li>
<li>exists:判断路径是否存在,如果路径存在则返回真</li>
<li>如下示例:<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="bullet">-</span> <span class="attr">hosts:</span> <span class="string">me</span></span><br><span class="line">  <span class="attr">remote_user:</span> <span class="string">liawne</span></span><br><span class="line">  <span class="attr">gather_facts:</span> <span class="literal">no</span></span><br><span class="line">  <span class="attr">vars:</span></span><br><span class="line">    <span class="attr">testpath1:</span> <span class="string">&quot;/testdir/test&quot;</span></span><br><span class="line">    <span class="attr">testpath2:</span> <span class="string">&quot;/testdir/&quot;</span></span><br><span class="line">    <span class="attr">testpath3:</span> <span class="string">&quot;/testdir/testsoftlink&quot;</span></span><br><span class="line">    <span class="attr">testpath4:</span> <span class="string">&quot;/testdir/testhardlink&quot;</span></span><br><span class="line">    <span class="attr">testpath5:</span> <span class="string">&quot;/boot&quot;</span></span><br><span class="line">  <span class="attr">tasks:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">debug:</span></span><br><span class="line">      <span class="attr">msg:</span> <span class="string">&quot;file&quot;</span></span><br><span class="line">    <span class="attr">when:</span> <span class="string">testpath1</span> <span class="string">is</span> <span class="string">file</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">debug:</span></span><br><span class="line">      <span class="attr">msg:</span> <span class="string">&quot;directory&quot;</span></span><br><span class="line">    <span class="attr">when:</span> <span class="string">testpath2</span> <span class="string">is</span> <span class="string">directory</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">debug:</span></span><br><span class="line">      <span class="attr">msg:</span> <span class="string">&quot;link&quot;</span></span><br><span class="line">    <span class="attr">when:</span> <span class="string">testpath3</span> <span class="string">is</span> <span class="string">link</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">debug:</span></span><br><span class="line">      <span class="attr">msg:</span> <span class="string">&quot;link&quot;</span></span><br><span class="line">    <span class="attr">when:</span> <span class="string">testpath4</span> <span class="string">is</span> <span class="string">link</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">debug:</span></span><br><span class="line">      <span class="attr">msg:</span> <span class="string">&quot;mount&quot;</span></span><br><span class="line">    <span class="attr">when:</span> <span class="string">testpath5</span> <span class="string">is</span> <span class="string">mount</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">debug:</span></span><br><span class="line">      <span class="attr">msg:</span> <span class="string">&quot;exists&quot;</span></span><br><span class="line">    <span class="attr">when:</span> <span class="string">testpath1</span> <span class="string">is</span> <span class="string">exists</span></span><br></pre></td></tr></table></figure></li>
</ul>
<p>5,判断字符串的一些tests</p>
<ul>
<li>lower:判断包含字母的字符串中的字母是否是纯小写,字符串中的字母全部为小写则返回真</li>
<li>upper:判断包含字母的字符串中的字母是否是纯大写,字符串中的字母全部为大写则返回真</li>
<li>如下示例:<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="bullet">-</span> <span class="attr">hosts:</span> <span class="string">me</span></span><br><span class="line">  <span class="attr">remote_user:</span> <span class="string">liawne</span></span><br><span class="line">  <span class="attr">gather_facts:</span> <span class="literal">no</span></span><br><span class="line">  <span class="attr">vars:</span></span><br><span class="line">    <span class="attr">str1:</span> <span class="string">&quot;abc&quot;</span></span><br><span class="line">    <span class="attr">str2:</span> <span class="string">&quot;ABC&quot;</span></span><br><span class="line">  <span class="attr">tasks:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">debug:</span></span><br><span class="line">      <span class="attr">msg:</span> <span class="string">&quot;This string is all lowercase&quot;</span></span><br><span class="line">    <span class="attr">when:</span> <span class="string">str1</span> <span class="string">is</span> <span class="string">lower</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">debug:</span></span><br><span class="line">      <span class="attr">msg:</span> <span class="string">&quot;This string is all uppercase&quot;</span></span><br><span class="line">    <span class="attr">when:</span> <span class="string">str2</span> <span class="string">is</span> <span class="string">upper</span></span><br></pre></td></tr></table></figure></li>
</ul>
<p>6,判断整除的一些tests</p>
<ul>
<li>even :判断数值是否是偶数,是偶数则返回真</li>
<li>odd :判断数值是否是奇数,是奇数则返回真</li>
<li>divisibleby(num) :判断是否可以整除指定的数值,如果除以指定的值以后余数为0，则返回真</li>
<li>如下示例:<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="bullet">-</span> <span class="attr">hosts:</span> <span class="string">me</span></span><br><span class="line">  <span class="attr">remote_user:</span> <span class="string">liawne</span></span><br><span class="line">  <span class="attr">gather_facts:</span> <span class="literal">no</span></span><br><span class="line">  <span class="attr">vars:</span></span><br><span class="line">    <span class="attr">num1:</span> <span class="number">4</span></span><br><span class="line">    <span class="attr">num2:</span> <span class="number">7</span></span><br><span class="line">    <span class="attr">num3:</span> <span class="number">64</span></span><br><span class="line">  <span class="attr">tasks:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">debug:</span></span><br><span class="line">      <span class="attr">msg:</span> <span class="string">&quot;An even number&quot;</span></span><br><span class="line">    <span class="attr">when:</span> <span class="string">num1</span> <span class="string">is</span> <span class="string">even</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">debug:</span></span><br><span class="line">      <span class="attr">msg:</span> <span class="string">&quot;An odd number&quot;</span></span><br><span class="line">    <span class="attr">when:</span> <span class="string">num2</span> <span class="string">is</span> <span class="string">odd</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">debug:</span></span><br><span class="line">      <span class="attr">msg:</span> <span class="string">&quot;Can be divided exactly by&quot;</span></span><br><span class="line">    <span class="attr">when:</span> <span class="string">num3</span> <span class="string">is</span> <span class="string">divisibleby(8)</span></span><br></pre></td></tr></table></figure></li>
</ul>
<p>7,其他一些tests</p>
<ul>
<li>version:可以用于对比两个版本号的大小,或者与指定的版本号进行对比，使用语法为 version(‘版本号’, ‘比较操作符’)<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="bullet">-</span> <span class="attr">hosts:</span> <span class="string">me</span></span><br><span class="line">  <span class="attr">remote_user:</span> <span class="string">liawne</span></span><br><span class="line">  <span class="attr">vars:</span></span><br><span class="line">    <span class="attr">ver:</span> <span class="number">7.4</span><span class="number">.1708</span></span><br><span class="line">    <span class="attr">ver1:</span> <span class="number">7.4</span><span class="number">.1707</span></span><br><span class="line">  <span class="attr">tasks:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">debug:</span></span><br><span class="line">      <span class="attr">msg:</span> <span class="string">&quot;This message can be displayed when the ver is greater than ver1&quot;</span></span><br><span class="line">    <span class="attr">when:</span> <span class="string">ver</span> <span class="string">is</span> <span class="string">version(ver1,&quot;&gt;&quot;)</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">debug:</span></span><br><span class="line">      <span class="attr">msg:</span> <span class="string">&quot;system version <span class="template-variable">&#123;&#123;ansible_distribution_version&#125;&#125;</span> greater than 7.3&quot;</span></span><br><span class="line">    <span class="attr">when:</span> <span class="string">ansible_distribution_version</span> <span class="string">is</span> <span class="string">version(&quot;7.3&quot;,&quot;gt&quot;)</span></span><br><span class="line">    <span class="comment"># ”&gt;”与”gt”都表示”大于”,当使用version时，支持多种风格的比较操作符，你可以根据自己的使用习惯进行选择，version支持的比较操作符如下</span></span><br><span class="line">    <span class="comment"># 大于:&gt;, gt</span></span><br><span class="line">    <span class="comment"># 大于等于:&gt;=, ge</span></span><br><span class="line">    <span class="comment"># 小于:&lt;, lt</span></span><br><span class="line">    <span class="comment"># 小于等于:&lt;=, le</span></span><br><span class="line">    <span class="comment"># 等于: ==, =, eq</span></span><br><span class="line">    <span class="comment"># 不等于:!=, &lt;&gt;, ne</span></span><br></pre></td></tr></table></figure></li>
<li>subset:判断一个list是不是另一个list的子集,是另一个list的子集时返回真</li>
<li>superset : 判断一个list是不是另一个list的父集,是另一个list的父集时返回真<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="bullet">-</span> <span class="attr">hosts:</span> <span class="string">me</span></span><br><span class="line">  <span class="attr">remote_user:</span> <span class="string">liawne</span></span><br><span class="line">  <span class="attr">gather_facts:</span> <span class="literal">no</span></span><br><span class="line">  <span class="attr">vars:</span></span><br><span class="line">    <span class="attr">a:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="number">2</span></span><br><span class="line">    <span class="bullet">-</span> <span class="number">5</span></span><br><span class="line">    <span class="attr">b:</span> [<span class="number">1</span>,<span class="number">2</span>,<span class="number">3</span>,<span class="number">4</span>,<span class="number">5</span>]</span><br><span class="line">  <span class="attr">tasks:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">debug:</span></span><br><span class="line">      <span class="attr">msg:</span> <span class="string">&quot;A is a subset of B&quot;</span></span><br><span class="line">    <span class="attr">when:</span> <span class="string">a</span> <span class="string">is</span> <span class="string">subset(b)</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">debug:</span></span><br><span class="line">      <span class="attr">msg:</span> <span class="string">&quot;B is the parent set of A&quot;</span></span><br><span class="line">    <span class="attr">when:</span> <span class="string">b</span> <span class="string">is</span> <span class="string">superset(a)</span></span><br><span class="line">  <span class="comment"># 注:2.5版本中上述两个tests从issubset和issuperset更名为subset和superset</span></span><br></pre></td></tr></table></figure></li>
<li>string:判断对象是否是一个字符串,是字符串则返回真<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="bullet">-</span> <span class="attr">hosts:</span> <span class="string">me</span></span><br><span class="line">  <span class="attr">remote_user:</span> <span class="string">liawne</span></span><br><span class="line">  <span class="attr">gather_facts:</span> <span class="literal">no</span></span><br><span class="line">  <span class="attr">vars:</span></span><br><span class="line">    <span class="attr">testvar1:</span> <span class="number">1</span></span><br><span class="line">    <span class="attr">testvar2:</span> <span class="string">&quot;1&quot;</span></span><br><span class="line">    <span class="attr">testvar3:</span> <span class="string">a</span></span><br><span class="line">  <span class="attr">tasks:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">debug:</span></span><br><span class="line">      <span class="attr">msg:</span> <span class="string">&quot;This variable is a string&quot;</span></span><br><span class="line">    <span class="attr">when:</span> <span class="string">testvar1</span> <span class="string">is</span> <span class="string">string</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">debug:</span></span><br><span class="line">      <span class="attr">msg:</span> <span class="string">&quot;This variable is a string&quot;</span></span><br><span class="line">    <span class="attr">when:</span> <span class="string">testvar2</span> <span class="string">is</span> <span class="string">string</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">debug:</span></span><br><span class="line">      <span class="attr">msg:</span> <span class="string">&quot;This variable is a string&quot;</span></span><br><span class="line">    <span class="attr">when:</span> <span class="string">testvar3</span> <span class="string">is</span> <span class="string">string</span></span><br><span class="line">  <span class="comment"># 上例playbook中只有testvar2和testvar3会被判断成字符串,testvar1不会</span></span><br></pre></td></tr></table></figure></li>
<li>number:判断对象是否是一个数字,是数字则返回真<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="bullet">-</span> <span class="attr">hosts:</span> <span class="string">me</span></span><br><span class="line">  <span class="attr">remote_user:</span> <span class="string">liawne</span></span><br><span class="line">  <span class="attr">gather_facts:</span> <span class="literal">no</span></span><br><span class="line">  <span class="attr">vars:</span></span><br><span class="line">    <span class="attr">testvar1:</span> <span class="number">1</span></span><br><span class="line">    <span class="attr">testvar2:</span> <span class="string">&quot;1&quot;</span></span><br><span class="line">    <span class="attr">testvar3:</span> <span class="number">00.20</span></span><br><span class="line">  <span class="attr">tasks:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">debug:</span></span><br><span class="line">      <span class="attr">msg:</span> <span class="string">&quot;This variable is number&quot;</span></span><br><span class="line">    <span class="attr">when:</span> <span class="string">testvar1</span> <span class="string">is</span> <span class="string">number</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">debug:</span></span><br><span class="line">      <span class="attr">msg:</span> <span class="string">&quot;This variable is a number&quot;</span></span><br><span class="line">    <span class="attr">when:</span> <span class="string">testvar2</span> <span class="string">is</span> <span class="string">number</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">debug:</span></span><br><span class="line">      <span class="attr">msg:</span> <span class="string">&quot;This variable is a number&quot;</span></span><br><span class="line">    <span class="attr">when:</span> <span class="string">testvar3</span> <span class="string">is</span> <span class="string">number</span></span><br><span class="line"> <span class="comment"># 上例playbook中只有testvar1和testvar3会被判断成数字,testvar2不会</span></span><br></pre></td></tr></table></figure>
<h3 id="2021-07-13-条件判断与block"><a href="#2021-07-13-条件判断与block" class="headerlink" title="2021-07-13 条件判断与block"></a>2021-07-13 条件判断与block</h3>1,在ansible中,可以使用”block”关键字将多个任务整合成一个”块”,这个”块”将被当做一个整体,我们可以对这个”块”添加判断条件,当条件成立时,则执行这个块中的所有任务</li>
<li>如下示例:<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="bullet">-</span> <span class="attr">hosts:</span> <span class="string">me</span></span><br><span class="line">  <span class="attr">remote_user:</span> <span class="string">root</span></span><br><span class="line">  <span class="attr">tasks:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">debug:</span></span><br><span class="line">      <span class="attr">msg:</span> <span class="string">&quot;task1 not in block&quot;</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">block:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">debug:</span></span><br><span class="line">          <span class="attr">msg:</span> <span class="string">&quot;task2 in block1&quot;</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">debug:</span></span><br><span class="line">          <span class="attr">msg:</span> <span class="string">&quot;task3 in block1&quot;</span></span><br><span class="line">    <span class="attr">when:</span> <span class="number">2</span> <span class="string">&gt;</span> <span class="number">1</span></span><br></pre></td></tr></table></figure></li>
</ul>
<p>2,block用在错误处理的场景下</p>
<ul>
<li>之前的方式如下:<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="bullet">-</span> <span class="attr">hosts:</span> <span class="string">me</span></span><br><span class="line">  <span class="attr">remote_user:</span> <span class="string">root</span></span><br><span class="line">  <span class="attr">tasks:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">shell:</span> <span class="string">&#x27;ls /ooo&#x27;</span></span><br><span class="line">    <span class="attr">register:</span> <span class="string">return_value</span></span><br><span class="line">    <span class="attr">ignore_errors:</span> <span class="literal">true</span></span><br><span class="line">  <span class="comment"># 通过注册变量,且忽略错误(ignore_errors)来做分支判断</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">debug:</span></span><br><span class="line">      <span class="attr">msg:</span> <span class="string">&quot;I cought an error&quot;</span></span><br><span class="line">    <span class="attr">when:</span> <span class="string">return_value</span> <span class="string">is</span> <span class="string">failed</span></span><br></pre></td></tr></table></figure></li>
<li>使用block+rescue的方式<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="bullet">-</span> <span class="attr">hosts:</span> <span class="string">me</span></span><br><span class="line">  <span class="attr">remote_user:</span> <span class="string">root</span></span><br><span class="line">  <span class="attr">tasks:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">block:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">shell:</span> <span class="string">&#x27;ls /ooo&#x27;</span></span><br><span class="line">    <span class="comment"># rescue直接承接上面的block,当block中的内容出现错误时,执行rescue中的内容</span></span><br><span class="line">    <span class="comment"># rescue关键字与block关键字对齐,rescue的字面意思为&quot;救援&quot;,表示当block中的任务执行失败时,会执行rescue中的任务进行补救</span></span><br><span class="line">    <span class="comment"># rescue中的内容由自己定义</span></span><br><span class="line">    <span class="attr">rescue:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">debug:</span></span><br><span class="line">          <span class="attr">msg:</span> <span class="string">&#x27;I caught an error&#x27;</span></span><br></pre></td></tr></table></figure></li>
<li>block的优势,如下示例:<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="bullet">-</span> <span class="attr">hosts:</span> <span class="string">me</span></span><br><span class="line">  <span class="attr">remote_user:</span> <span class="string">root</span></span><br><span class="line">  <span class="attr">tasks:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">block:</span></span><br><span class="line">  <span class="comment"># block可以接多个任务,任何一个任务出错,都会执行rescue中的任务,所以通常使用block和rescue结合,完成&quot;错误捕捉,报出异常&quot;的功能</span></span><br><span class="line">  <span class="comment"># 不仅block中可以有多个任务,rescue中也可以定义多个任务,当block中的任何一个任务出错时,会按照顺序执行rescue中的任务.</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">shell:</span> <span class="string">&#x27;ls /opt&#x27;</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">shell:</span> <span class="string">&#x27;ls /testdir&#x27;</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">shell:</span> <span class="string">&#x27;ls /c&#x27;</span></span><br><span class="line">    <span class="attr">rescue:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">debug:</span></span><br><span class="line">          <span class="attr">msg:</span> <span class="string">&#x27;I caught an error&#x27;</span></span><br></pre></td></tr></table></figure></li>
<li>block+rescue+always的使用示例:<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 还能再加入always关键字,加入always关键字以后,无论block中的任务执行成功还是失败,always中的任务都会被执行</span></span><br><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="bullet">-</span> <span class="attr">hosts:</span> <span class="string">me</span></span><br><span class="line">  <span class="attr">remote_user:</span> <span class="string">root</span></span><br><span class="line">  <span class="attr">tasks:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">block:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">debug:</span></span><br><span class="line">          <span class="attr">msg:</span> <span class="string">&#x27;I execute normally&#x27;</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">command:</span> <span class="string">/bin/false</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">debug:</span></span><br><span class="line">          <span class="attr">msg:</span> <span class="string">&#x27;I never execute, due to the above task failing&#x27;</span></span><br><span class="line">    <span class="attr">rescue:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">debug:</span></span><br><span class="line">          <span class="attr">msg:</span> <span class="string">&#x27;I caught an error&#x27;</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">command:</span> <span class="string">/bin/false</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">debug:</span></span><br><span class="line">          <span class="attr">msg:</span> <span class="string">&#x27;I also never execute&#x27;</span></span><br><span class="line">    <span class="attr">always:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">debug:</span></span><br><span class="line">          <span class="attr">msg:</span> <span class="string">&quot;This always executes&quot;</span></span><br><span class="line"><span class="comment"># 如上例所示,block中有多个任务,rescue中也有多个任务,上例中故意执行&quot;/bin/false&quot;命令,模拟任务出错的情况,当block中的&#x27;/bin/false&#x27;执行后,其后的debug任务将不会被执行,因为&#x27;/bin/false&#x27;模拟出错,出错后直接执行rescue中的任务,在执行rescue中的任务时,会先输出 ‘I caught an error&#x27;,然后又在rescue中使用&#x27;/bin/false&#x27;模拟出错的情况,出错后之后的debug任务不会被执行,直接执行always中的任务,always中的任务一定会被执行,无论block中的任务是否出错</span></span><br></pre></td></tr></table></figure>
<h3 id="2021-07-13-条件判断与错误处理"><a href="#2021-07-13-条件判断与错误处理" class="headerlink" title="2021-07-13 条件判断与错误处理"></a>2021-07-13 条件判断与错误处理</h3>1,使用fail模块来处理出错</li>
<li>如下示例:<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="bullet">-</span> <span class="attr">hosts:</span> <span class="string">me</span></span><br><span class="line">  <span class="attr">remote_user:</span> <span class="string">root</span></span><br><span class="line">  <span class="attr">tasks:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">shell:</span> <span class="string">&quot;echo &#x27;This is a string for testing--error&#x27;&quot;</span></span><br><span class="line">    <span class="attr">register:</span> <span class="string">return_value</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">fail:</span></span><br><span class="line">      <span class="attr">msg:</span> <span class="string">&quot;Conditions established,Interrupt running playbook&quot;</span></span><br><span class="line">    <span class="attr">when:</span> <span class="string">&quot;&#x27;error&#x27; in return_value.stdout&quot;</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">debug:</span></span><br><span class="line">      <span class="attr">msg:</span> <span class="string">&quot;I never execute,Because the playbook has stopped&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># a, 当使用&quot;in&quot;或者&quot;not in&quot;进行条件判断时,整个条件需要用引号引起,并且,需要判断的字符串也需要使用引号引起,所以,使用&#x27;in&#x27;或者&#x27;not in&#x27;进行条件判断时,如下两种语法是正确的:</span></span><br><span class="line"><span class="comment"># when: &#x27; &quot;successful&quot; not in return_value.stdout &#x27;</span></span><br><span class="line"><span class="comment"># when: &quot; &#x27;successful&#x27; not in return_value.stdout &quot;</span></span><br><span class="line"><span class="comment"># b,fail可以单独使用,不加msg和when,效果是直接报错</span></span><br></pre></td></tr></table></figure></li>
</ul>
<p>2,使用failed_when</p>
<ul>
<li>‘failed_when’的作用就是,当对应的条件成立时,将对应任务的执行状态设置为失败<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="bullet">-</span> <span class="attr">hosts:</span> <span class="string">me</span></span><br><span class="line">  <span class="attr">remote_user:</span> <span class="string">root</span></span><br><span class="line">  <span class="attr">tasks:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">debug:</span></span><br><span class="line">      <span class="attr">msg:</span> <span class="string">&quot;I execute normally&quot;</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">shell:</span> <span class="string">&quot;echo &#x27;This is a string for testing error&#x27;&quot;</span></span><br><span class="line">    <span class="attr">register:</span> <span class="string">return_value</span></span><br><span class="line">    <span class="attr">failed_when:</span> <span class="string">&#x27; &quot;error&quot; in return_value.stdout&#x27;</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">debug:</span></span><br><span class="line">      <span class="attr">msg:</span> <span class="string">&quot;I never execute,Because the playbook has stopped&quot;</span></span><br><span class="line"><span class="comment"># &#x27;failed_when&#x27;关键字与shell关键字对齐,表示其对应的条件是针对shell模块的,&#x27;failed_when&#x27;对应的条件是 ‘ “error&quot; in return_value.stdout&#x27;,表示&quot;error&quot;字符串如果存在于shell模块执行后的标准输出中,则条件成立,</span></span><br><span class="line"><span class="comment"># 当条件成立后,shell模块的执行状态将会被设置为失败,由于shell模块的执行状态被设置为失败,所以playbook会终止运行,于是,最后的debug模块并不会被执行</span></span><br><span class="line"><span class="comment"># &#x27;failed_when&#x27;虽然会将任务的执行状态设置为失败,但并不代表任务真的失败了,以上例来说,shell模块的确是完全正常的执行了,只不过在执行之后,&#x27; failed_when&#x27;对应的条件成立了,&#x27; failed_when&#x27;将shell模块的执行状态设置为失败而已</span></span><br></pre></td></tr></table></figure></li>
</ul>
<p>3,使用changed_when</p>
<ul>
<li>‘changed_when’关键字的作用是在条件成立时,将对应任务的执行状态设置为changed<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="bullet">-</span> <span class="attr">hosts:</span> <span class="string">me</span></span><br><span class="line">  <span class="attr">remote_user:</span> <span class="string">root</span></span><br><span class="line">  <span class="attr">tasks:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">debug:</span></span><br><span class="line">      <span class="attr">msg:</span> <span class="string">&quot;test message&quot;</span></span><br><span class="line">    <span class="attr">changed_when:</span> <span class="number">2</span> <span class="string">&gt;</span> <span class="number">1</span></span><br><span class="line"><span class="comment"># debug模块在正常执行的情况下只能是&quot;ok&quot;状态,上例中,我们使用&#x27;changed_when&#x27;关键字将debug模块的执行后的状态定义为了&quot;changed&quot;</span></span><br></pre></td></tr></table></figure></li>
<li>与handler结合使用<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 只有任务作出了实际的操作时（执行后状态为changed）,才会真正的执行对应的handlers</span></span><br><span class="line"><span class="comment"># 而在某些时候,如果想要通过任务执行后的返回值将任务的最终执行状态判定为changed,则可以使用&#x27;changed_when&#x27;关键字,以便条件成立时,可以执行对应的handlers,</span></span><br><span class="line"><span class="comment"># &#x27;changed_when&#x27;除了能够在条件成立时将任务的执行状态设置为&quot;changed&quot;,还能让对应的任务永远不能是changed状态,示例如下:</span></span><br><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="bullet">-</span> <span class="attr">hosts:</span> <span class="string">me</span></span><br><span class="line">  <span class="attr">remote_user:</span> <span class="string">root</span></span><br><span class="line">  <span class="attr">tasks:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">shell:</span> <span class="string">&quot;ls /opt&quot;</span></span><br><span class="line">    <span class="attr">changed_when:</span> <span class="literal">false</span></span><br><span class="line"><span class="comment"># 当将&#x27;changed_when&#x27;直接设置为false时,对应任务的状态将不会被设置为&#x27;changed&#x27;,如果任务原本的执行状态为&#x27;changed&#x27;,最终则会被设置为&#x27;ok&#x27;,所以,上例playbook执行后,shell模块的执行状态最终为&#x27;ok&#x27;</span></span><br></pre></td></tr></table></figure>
<h3 id="2021-07-13-过滤器"><a href="#2021-07-13-过滤器" class="headerlink" title="2021-07-13 过滤器"></a>2021-07-13 过滤器</h3>1,过滤器是一种能够帮助我们处理数据的工具,其实,ansible中的过滤器功能来自于jinja2模板引擎</li>
</ul>
<p>2,过滤器有些是jinja2内置的,有些是ansible特有的,如果这些过滤器都不能满足你的需求,jinja2也支持自定义过滤器</p>
<p>3,一些常见的过滤器</p>
<ul>
<li>字符串相关<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="bullet">-</span> <span class="attr">hosts:</span> <span class="string">me</span></span><br><span class="line">  <span class="attr">remote_user:</span> <span class="string">root</span></span><br><span class="line">  <span class="attr">vars:</span></span><br><span class="line">    <span class="attr">testvar:</span> <span class="string">&quot;abc123ABC 666&quot;</span></span><br><span class="line">    <span class="attr">testvar1:</span> <span class="string">&quot;  abc  &quot;</span></span><br><span class="line">    <span class="attr">testvar2:</span> <span class="string">&#x27;123456789&#x27;</span></span><br><span class="line">    <span class="attr">testvar3:</span> <span class="string">&quot;1a2b,@#$%^&amp;&quot;</span></span><br><span class="line">  <span class="attr">tasks:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">debug:</span></span><br><span class="line">      <span class="comment">#将字符串转换成纯大写</span></span><br><span class="line">      <span class="attr">msg:</span> <span class="string">&quot;<span class="template-variable">&#123;&#123; testvar | upper &#125;&#125;</span>&quot;</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">debug:</span></span><br><span class="line">      <span class="comment">#将字符串转换成纯小写</span></span><br><span class="line">      <span class="attr">msg:</span> <span class="string">&quot;<span class="template-variable">&#123;&#123; testvar | lower &#125;&#125;</span>&quot;</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">debug:</span></span><br><span class="line">      <span class="comment">#将字符串变成首字母大写,之后所有字母纯小写</span></span><br><span class="line">      <span class="attr">msg:</span> <span class="string">&quot;<span class="template-variable">&#123;&#123; testvar | capitalize &#125;&#125;</span>&quot;</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">debug:</span></span><br><span class="line">      <span class="comment">#将字符串反转</span></span><br><span class="line">      <span class="attr">msg:</span> <span class="string">&quot;<span class="template-variable">&#123;&#123; testvar | reverse &#125;&#125;</span>&quot;</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">debug:</span></span><br><span class="line">      <span class="comment">#返回字符串的第一个字符</span></span><br><span class="line">      <span class="attr">msg:</span> <span class="string">&quot;<span class="template-variable">&#123;&#123; testvar | first &#125;&#125;</span>&quot;</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">debug:</span></span><br><span class="line">      <span class="comment">#返回字符串的最后一个字符</span></span><br><span class="line">      <span class="attr">msg:</span> <span class="string">&quot;<span class="template-variable">&#123;&#123; testvar | last &#125;&#125;</span>&quot;</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">debug:</span></span><br><span class="line">      <span class="comment">#将字符串开头和结尾的空格去除</span></span><br><span class="line">      <span class="attr">msg:</span> <span class="string">&quot;<span class="template-variable">&#123;&#123; testvar1 | trim &#125;&#125;</span>&quot;</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">debug:</span></span><br><span class="line">      <span class="comment">#将字符串放在中间,并且设置字符串的长度为30,字符串两边用空格补齐30位长</span></span><br><span class="line">      <span class="attr">msg:</span> <span class="string">&quot;<span class="template-variable">&#123;&#123; testvar1 | center(width=30) &#125;&#125;</span>&quot;</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">debug:</span></span><br><span class="line">      <span class="comment">#返回字符串长度,length与count等效,可以写为count</span></span><br><span class="line">      <span class="attr">msg:</span> <span class="string">&quot;<span class="template-variable">&#123;&#123; testvar2 | length &#125;&#125;</span>&quot;</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">debug:</span></span><br><span class="line">      <span class="comment">#将字符串转换成列表,每个字符作为一个元素</span></span><br><span class="line">      <span class="attr">msg:</span> <span class="string">&quot;<span class="template-variable">&#123;&#123; testvar3 | list &#125;&#125;</span>&quot;</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">debug:</span></span><br><span class="line">      <span class="comment">#将字符串转换成列表,每个字符作为一个元素,并且随机打乱顺序</span></span><br><span class="line">      <span class="comment">#shuffle的字面意思为洗牌</span></span><br><span class="line">      <span class="attr">msg:</span> <span class="string">&quot;<span class="template-variable">&#123;&#123; testvar3 | shuffle &#125;&#125;</span>&quot;</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">debug:</span></span><br><span class="line">      <span class="comment">#将字符串转换成列表,每个字符作为一个元素,并且随机打乱顺序</span></span><br><span class="line">      <span class="comment">#在随机打乱顺序时,将ansible_date_time.epoch的值设置为随机种子</span></span><br><span class="line">      <span class="comment">#也可以使用其他值作为随机种子,ansible_date_time.epoch是facts信息</span></span><br><span class="line">      <span class="attr">msg:</span> <span class="string">&quot;<span class="template-variable">&#123;&#123; testvar3 | shuffle(seed=(ansible_date_time.epoch)) &#125;&#125;</span>&quot;</span></span><br></pre></td></tr></table></figure></li>
<li>数字相关<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="bullet">-</span> <span class="attr">hosts:</span> <span class="string">me</span></span><br><span class="line">  <span class="attr">remote_user:</span> <span class="string">root</span></span><br><span class="line">  <span class="attr">vars:</span></span><br><span class="line">    <span class="attr">testvar4:</span> <span class="number">-1</span></span><br><span class="line">  <span class="attr">tasks:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">debug:</span></span><br><span class="line">      <span class="comment">#将对应的值转换成int类型</span></span><br><span class="line">      <span class="comment">#ansible中,字符串和整形不能直接计算,比如&#123;&#123; 8+&#x27;8&#x27; &#125;&#125;会报错</span></span><br><span class="line">      <span class="comment">#所以,我们可以把一个值为数字的字符串转换成整形后再做计算</span></span><br><span class="line">      <span class="attr">msg:</span> <span class="string">&quot;<span class="template-variable">&#123;&#123; 8+(&#x27;8&#x27; | int) &#125;&#125;</span>&quot;</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">debug:</span></span><br><span class="line">      <span class="comment">#将对应的值转换成int类型,如果无法转换,默认返回0</span></span><br><span class="line">      <span class="comment">#使用int(default=6)或者int(6)时,如果无法转换则返回指定值6</span></span><br><span class="line">      <span class="attr">msg:</span> <span class="string">&quot;<span class="template-variable">&#123;&#123; &#x27;a&#x27; | int(default=6) &#125;&#125;</span>&quot;</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">debug:</span></span><br><span class="line">      <span class="comment">#将对应的值转换成浮点型,如果无法转换,默认返回&#x27;0.0&#x27;</span></span><br><span class="line">      <span class="attr">msg:</span> <span class="string">&quot;<span class="template-variable">&#123;&#123; &#x27;8&#x27; | float &#125;&#125;</span>&quot;</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">debug:</span></span><br><span class="line">      <span class="comment">#当对应的值无法被转换成浮点型时,则返回指定值&#x27;8.8‘</span></span><br><span class="line">      <span class="attr">msg:</span> <span class="string">&quot;<span class="template-variable">&#123;&#123; &#x27;a&#x27; | float(8.88) &#125;&#125;</span>&quot;</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">debug:</span></span><br><span class="line">      <span class="comment">#获取对应数值的绝对值</span></span><br><span class="line">      <span class="attr">msg:</span> <span class="string">&quot;<span class="template-variable">&#123;&#123; testvar4 | abs &#125;&#125;</span>&quot;</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">debug:</span></span><br><span class="line">      <span class="comment">#四舍五入</span></span><br><span class="line">      <span class="attr">msg:</span> <span class="string">&quot;<span class="template-variable">&#123;&#123; 12.5 | round &#125;&#125;</span>&quot;</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">debug:</span></span><br><span class="line">      <span class="comment">#取小数点后五位</span></span><br><span class="line">      <span class="attr">msg:</span> <span class="string">&quot;<span class="template-variable">&#123;&#123; 3.1415926 | round(5) &#125;&#125;</span>&quot;</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">debug:</span></span><br><span class="line">      <span class="comment">#从0到100中随机返回一个随机数</span></span><br><span class="line">      <span class="attr">msg:</span> <span class="string">&quot;<span class="template-variable">&#123;&#123; 100 | random &#125;&#125;</span>&quot;</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">debug:</span></span><br><span class="line">      <span class="comment">#从5到10中随机返回一个随机数</span></span><br><span class="line">      <span class="attr">msg:</span> <span class="string">&quot;<span class="template-variable">&#123;&#123; 10 | random(start=5) &#125;&#125;</span>&quot;</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">debug:</span></span><br><span class="line">      <span class="comment">#从5到15中随机返回一个随机数,步长为3</span></span><br><span class="line">      <span class="comment">#步长为3的意思是返回的随机数只有可能是5、8、11、14中的一个</span></span><br><span class="line">      <span class="attr">msg:</span> <span class="string">&quot;<span class="template-variable">&#123;&#123; 15 | random(start=5,step=3) &#125;&#125;</span>&quot;</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">debug:</span></span><br><span class="line">      <span class="comment">#从0到15中随机返回一个随机数,这个随机数是5的倍数</span></span><br><span class="line">      <span class="attr">msg:</span> <span class="string">&quot;<span class="template-variable">&#123;&#123; 15 | random(step=5) &#125;&#125;</span>&quot;</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">debug:</span></span><br><span class="line">      <span class="comment">#从0到15中随机返回一个随机数,并将ansible_date_time.epoch的值设置为随机种子</span></span><br><span class="line">      <span class="comment">#也可以使用其他值作为随机种子,ansible_date_time.epoch是facts信息</span></span><br><span class="line">      <span class="comment">#seed参数从ansible2.3版本开始可用</span></span><br><span class="line">      <span class="attr">msg:</span> <span class="string">&quot;<span class="template-variable">&#123;&#123; 15 | random(seed=(ansible_date_time.epoch)) &#125;&#125;</span>&quot;</span></span><br></pre></td></tr></table></figure></li>
<li>列表相关<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="bullet">-</span> <span class="attr">hosts:</span> <span class="string">me</span></span><br><span class="line">  <span class="attr">remote_user:</span> <span class="string">root</span></span><br><span class="line">  <span class="attr">vars:</span></span><br><span class="line">    <span class="attr">testvar7:</span> [<span class="number">22</span>,<span class="number">18</span>,<span class="number">5</span>,<span class="number">33</span>,<span class="number">27</span>,<span class="number">30</span>]</span><br><span class="line">    <span class="attr">testvar8:</span> [<span class="number">1</span>,[<span class="number">7</span>,<span class="number">2</span>,[<span class="number">15</span>,<span class="number">9</span>]],<span class="number">3</span>,<span class="number">5</span>]</span><br><span class="line">    <span class="attr">testvar9:</span> [<span class="number">1</span>,<span class="string">&#x27;b&#x27;</span>,<span class="number">5</span>]</span><br><span class="line">    <span class="attr">testvar10:</span> [<span class="number">1</span>,<span class="string">&#x27;A&#x27;</span>,<span class="string">&#x27;b&#x27;</span>,[<span class="string">&#x27;QQ&#x27;</span>,<span class="string">&#x27;wechat&#x27;</span>],<span class="string">&#x27;CdEf&#x27;</span>]</span><br><span class="line">    <span class="attr">testvar11:</span> [<span class="string">&#x27;abc&#x27;</span>,<span class="number">1</span>,<span class="number">3</span>,<span class="string">&#x27;a&#x27;</span>,<span class="number">3</span>,<span class="string">&#x27;1&#x27;</span>,<span class="string">&#x27;abc&#x27;</span>]</span><br><span class="line">    <span class="attr">testvar12:</span> [<span class="string">&#x27;abc&#x27;</span>,<span class="number">2</span>,<span class="string">&#x27;a&#x27;</span>,<span class="string">&#x27;b&#x27;</span>,<span class="string">&#x27;a&#x27;</span>]</span><br><span class="line">  <span class="attr">tasks:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">debug:</span></span><br><span class="line">      <span class="comment">#返回列表长度,length与count等效,可以写为count</span></span><br><span class="line">      <span class="attr">msg:</span> <span class="string">&quot;<span class="template-variable">&#123;&#123; testvar7 | length &#125;&#125;</span>&quot;</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">debug:</span></span><br><span class="line">      <span class="comment">#返回列表中的第一个值</span></span><br><span class="line">      <span class="attr">msg:</span> <span class="string">&quot;<span class="template-variable">&#123;&#123; testvar7 | first &#125;&#125;</span>&quot;</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">debug:</span></span><br><span class="line">      <span class="comment">#返回列表中的最后一个值</span></span><br><span class="line">      <span class="attr">msg:</span> <span class="string">&quot;<span class="template-variable">&#123;&#123; testvar7 | last &#125;&#125;</span>&quot;</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">debug:</span></span><br><span class="line">      <span class="comment">#返回列表中最小的值</span></span><br><span class="line">      <span class="attr">msg:</span> <span class="string">&quot;<span class="template-variable">&#123;&#123; testvar7 | min &#125;&#125;</span>&quot;</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">debug:</span></span><br><span class="line">      <span class="comment">#返回列表中最大的值</span></span><br><span class="line">      <span class="attr">msg:</span> <span class="string">&quot;<span class="template-variable">&#123;&#123; testvar7 | max &#125;&#125;</span>&quot;</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">debug:</span></span><br><span class="line">      <span class="comment">#将列表升序排序输出</span></span><br><span class="line">      <span class="attr">msg:</span> <span class="string">&quot;<span class="template-variable">&#123;&#123; testvar7 | sort &#125;&#125;</span>&quot;</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">debug:</span></span><br><span class="line">      <span class="comment">#将列表降序排序输出</span></span><br><span class="line">      <span class="attr">msg:</span> <span class="string">&quot;<span class="template-variable">&#123;&#123; testvar7 | sort(reverse=true) &#125;&#125;</span>&quot;</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">debug:</span></span><br><span class="line">      <span class="comment">#返回纯数字非嵌套列表中所有数字的和</span></span><br><span class="line">      <span class="attr">msg:</span> <span class="string">&quot;<span class="template-variable">&#123;&#123; testvar7 | sum &#125;&#125;</span>&quot;</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">debug:</span></span><br><span class="line">      <span class="comment">#如果列表中包含列表,那么使用flatten可以&#x27;拉平&#x27;嵌套的列表</span></span><br><span class="line">      <span class="comment">#2.5版本中可用,执行如下示例后查看效果</span></span><br><span class="line">      <span class="attr">msg:</span> <span class="string">&quot;<span class="template-variable">&#123;&#123; testvar8 | flatten &#125;&#125;</span>&quot;</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">debug:</span></span><br><span class="line">      <span class="comment">#如果列表中嵌套了列表,那么将第1层的嵌套列表‘拉平&#x27;</span></span><br><span class="line">      <span class="comment">#2.5版本中可用,执行如下示例后查看效果</span></span><br><span class="line">      <span class="attr">msg:</span> <span class="string">&quot;<span class="template-variable">&#123;&#123; testvar8 | flatten(levels=1) &#125;&#125;</span>&quot;</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">debug:</span></span><br><span class="line">      <span class="comment">#过滤器都是可以自由结合使用的,就好像linux命令中的管道符一样</span></span><br><span class="line">      <span class="comment">#如下,取出嵌套列表中的最大值</span></span><br><span class="line">      <span class="attr">msg:</span> <span class="string">&quot;<span class="template-variable">&#123;&#123; testvar8 | flatten | max &#125;&#125;</span>&quot;</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">debug:</span></span><br><span class="line">      <span class="comment">#将列表中的元素合并成一个字符串</span></span><br><span class="line">      <span class="attr">msg:</span> <span class="string">&quot;<span class="template-variable">&#123;&#123; testvar9 | join &#125;&#125;</span>&quot;</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">debug:</span></span><br><span class="line">      <span class="comment">#将列表中的元素合并成一个字符串,每个元素之间用指定的字符隔开</span></span><br><span class="line">      <span class="attr">msg:</span> <span class="string">&quot;<span class="template-variable">&#123;&#123; testvar9 | join(&#x27; , &#x27;) &#125;&#125;</span>&quot;</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">debug:</span></span><br><span class="line">      <span class="comment">#从列表中随机返回一个元素</span></span><br><span class="line">      <span class="comment">#对列表使用random过滤器时,不能使用start和step参数</span></span><br><span class="line">      <span class="attr">msg:</span> <span class="string">&quot;<span class="template-variable">&#123;&#123; testvar9 | random &#125;&#125;</span>&quot;</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">debug:</span></span><br><span class="line">      <span class="comment">#从列表中随机返回一个元素,并将ansible_date_time.epoch的值设置为随机种子</span></span><br><span class="line">      <span class="comment">#seed参数从ansible2.3版本开始可用</span></span><br><span class="line">      <span class="attr">msg:</span> <span class="string">&quot;<span class="template-variable">&#123;&#123; testvar9 | random(seed=(ansible_date_time.epoch)) &#125;&#125;</span>&quot;</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">debug:</span></span><br><span class="line">      <span class="comment">#随机打乱顺序列表中元素的顺序</span></span><br><span class="line">      <span class="comment">#shuffle的字面意思为洗牌</span></span><br><span class="line">      <span class="attr">msg:</span> <span class="string">&quot;<span class="template-variable">&#123;&#123; testvar9 | shuffle &#125;&#125;</span>&quot;</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">debug:</span></span><br><span class="line">      <span class="comment">#随机打乱顺序列表中元素的顺序</span></span><br><span class="line">      <span class="comment">#在随机打乱顺序时,将ansible_date_time.epoch的值设置为随机种子</span></span><br><span class="line">      <span class="comment">#seed参数从ansible2.3版本开始可用</span></span><br><span class="line">      <span class="attr">msg:</span> <span class="string">&quot;<span class="template-variable">&#123;&#123; testvar9 | shuffle(seed=(ansible_date_time.epoch)) &#125;&#125;</span>&quot;</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">debug:</span></span><br><span class="line">      <span class="comment">#将列表中的每个元素变成纯大写</span></span><br><span class="line">      <span class="attr">msg:</span> <span class="string">&quot;<span class="template-variable">&#123;&#123; testvar10 | upper &#125;&#125;</span>&quot;</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">debug:</span></span><br><span class="line">      <span class="comment">#将列表中的每个元素变成纯小写</span></span><br><span class="line">      <span class="attr">msg:</span> <span class="string">&quot;<span class="template-variable">&#123;&#123; testvar10 | lower &#125;&#125;</span>&quot;</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">debug:</span></span><br><span class="line">      <span class="comment">#去掉列表中重复的元素,重复的元素只留下一个</span></span><br><span class="line">      <span class="attr">msg:</span> <span class="string">&quot;<span class="template-variable">&#123;&#123; testvar11 | unique &#125;&#125;</span>&quot;</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">debug:</span></span><br><span class="line">      <span class="comment">#将两个列表合并,重复的元素只留下一个</span></span><br><span class="line">      <span class="comment">#也就是求两个列表的并集</span></span><br><span class="line">      <span class="attr">msg:</span> <span class="string">&quot;<span class="template-variable">&#123;&#123; testvar11 | union(testvar12) &#125;&#125;</span>&quot;</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">debug:</span></span><br><span class="line">      <span class="comment">#取出两个列表的交集,重复的元素只留下一个</span></span><br><span class="line">      <span class="attr">msg:</span> <span class="string">&quot;<span class="template-variable">&#123;&#123; testvar11 | intersect(testvar12) &#125;&#125;</span>&quot;</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">debug:</span></span><br><span class="line">      <span class="comment">#取出存在于testvar11列表中,但是不存在于testvar12列表中的元素</span></span><br><span class="line">      <span class="comment">#去重后重复的元素只留下一个</span></span><br><span class="line">      <span class="comment">#换句话说就是:两个列表的交集在列表1中的补集</span></span><br><span class="line">      <span class="attr">msg:</span> <span class="string">&quot;<span class="template-variable">&#123;&#123; testvar11 | difference(testvar12) &#125;&#125;</span>&quot;</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">debug:</span></span><br><span class="line">      <span class="comment">#取出两个列表中各自独有的元素,重复的元素只留下一个</span></span><br><span class="line">      <span class="comment">#即去除两个列表的交集,剩余的元素</span></span><br><span class="line">      <span class="attr">msg:</span> <span class="string">&quot;<span class="template-variable">&#123;&#123; testvar11 | symmetric_difference(testvar12) &#125;&#125;</span>&quot;</span></span><br></pre></td></tr></table></figure></li>
<li>变量未定义时相关操作的过滤器<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="bullet">-</span> <span class="attr">hosts:</span> <span class="string">me</span></span><br><span class="line">  <span class="attr">remote_user:</span> <span class="string">root</span></span><br><span class="line">  <span class="attr">gather_facts:</span> <span class="literal">no</span></span><br><span class="line">  <span class="attr">vars:</span></span><br><span class="line">    <span class="attr">testvar6:</span> <span class="string">&#x27;&#x27;</span></span><br><span class="line">  <span class="attr">tasks:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">debug:</span></span><br><span class="line">      <span class="comment">#如果变量没有定义,则临时返回一个指定的默认值</span></span><br><span class="line">      <span class="comment">#注:如果定义了变量,变量值为空字符串,则会输出空字符</span></span><br><span class="line">      <span class="comment">#default过滤器的别名是d</span></span><br><span class="line">      <span class="attr">msg:</span> <span class="string">&quot;<span class="template-variable">&#123;&#123; testvar5 | default(&#x27;zsythink&#x27;) &#125;&#125;</span>&quot;</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">debug:</span></span><br><span class="line">      <span class="comment">#如果变量的值是一个空字符串或者变量没有定义,则临时返回一个指定的默认值</span></span><br><span class="line">      <span class="attr">msg:</span> <span class="string">&quot;<span class="template-variable">&#123;&#123; testvar6 | default(&#x27;zsythink&#x27;,boolean=true) &#125;&#125;</span>&quot;</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">debug:</span></span><br><span class="line">      <span class="comment">#如果对应的变量未定义,则报出“Mandatory variable not defined.&quot;错误,而不是报出默认错误</span></span><br><span class="line">      <span class="attr">msg:</span> <span class="string">&quot;<span class="template-variable">&#123;&#123; testvar5 | mandatory &#125;&#125;</span>&quot;</span></span><br></pre></td></tr></table></figure></li>
</ul>
<p>4,上述使用到的default参数,default过滤器,还有一个很方便的用法,default过滤器不仅能在变量未定义时返回指定的值,还能够让模块的参数变得”可有可无”</p>
<ul>
<li>如下示例:<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># method one,循环了两次</span></span><br><span class="line"><span class="bullet">-</span> <span class="attr">hosts:</span> <span class="string">me</span></span><br><span class="line">  <span class="attr">remote_user:</span> <span class="string">root</span></span><br><span class="line">  <span class="attr">gather_facts:</span> <span class="literal">no</span></span><br><span class="line">  <span class="attr">vars:</span></span><br><span class="line">    <span class="attr">paths:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">path:</span> <span class="string">/tmp/test</span></span><br><span class="line">        <span class="attr">mode:</span> <span class="string">&#x27;0444&#x27;</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">path:</span> <span class="string">/tmp/foo</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">path:</span> <span class="string">/tmp/bar</span></span><br><span class="line">  <span class="attr">tasks:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">file:</span> <span class="string">dest=&#123;&#123;item.path&#125;&#125;</span> <span class="string">state=touch</span> <span class="string">mode=&#123;&#123;item.mode&#125;&#125;</span></span><br><span class="line">    <span class="attr">with_items:</span> <span class="string">&quot;<span class="template-variable">&#123;&#123; paths &#125;&#125;</span>&quot;</span></span><br><span class="line">    <span class="attr">when:</span> <span class="string">item.mode</span> <span class="string">is</span> <span class="string">defined</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">file:</span> <span class="string">dest=&#123;&#123;item.path&#125;&#125;</span> <span class="string">state=touch</span></span><br><span class="line">    <span class="attr">with_items:</span> <span class="string">&quot;<span class="template-variable">&#123;&#123; paths &#125;&#125;</span>&quot;</span></span><br><span class="line">    <span class="attr">when:</span> <span class="string">item.mode</span> <span class="string">is</span> <span class="string">undefined</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># method two</span></span><br><span class="line"><span class="bullet">-</span> <span class="attr">hosts:</span> <span class="string">me</span></span><br><span class="line">  <span class="attr">remote_user:</span> <span class="string">root</span></span><br><span class="line">  <span class="attr">gather_facts:</span> <span class="literal">no</span></span><br><span class="line">  <span class="attr">vars:</span></span><br><span class="line">    <span class="attr">paths:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">path:</span> <span class="string">/tmp/test</span></span><br><span class="line">        <span class="attr">mode:</span> <span class="string">&#x27;0444&#x27;</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">path:</span> <span class="string">/tmp/foo</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">path:</span> <span class="string">/tmp/bar</span></span><br><span class="line">  <span class="attr">tasks:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">file:</span> <span class="string">dest=&#123;&#123;item.path&#125;&#125;</span> <span class="string">state=touch</span> <span class="string">mode=&#123;&#123;item.mode</span> <span class="string">|</span> <span class="string">default(omit)&#125;&#125;</span></span><br><span class="line">    <span class="attr">with_items:</span> <span class="string">&quot;<span class="template-variable">&#123;&#123; paths &#125;&#125;</span>&quot;</span></span><br><span class="line"><span class="comment"># 没有对文件是否有mode属性进行判断,而是直接调用了file模块的mode参数,将mode参数的值设定为了&quot;&#123;&#123;item.mode | default(omit)&#125;&#125;&quot;,这是什么意思呢？它的意思是,如果item有mode属性,就把file模块的mode参数的值设置为item的mode属性的值,如果item没有mode属性,file模块就直接省略mode参数,&#x27;omit&#x27;的字面意思就是&quot;省略&quot;,换成大白话说就是:[有就用,没有就不用,可以有,也可以没有]</span></span><br></pre></td></tr></table></figure>
<h3 id="2021-07-14-变量-六-include-vars"><a href="#2021-07-14-变量-六-include-vars" class="headerlink" title="2021-07-14 变量(六)include_vars"></a>2021-07-14 变量(六)include_vars</h3>1,通过’vars_files’可以将文件中的变量引入playbook,以便在task中使用,但是vars_files加载时是静态的引入变量,即后续在vars_files中新增的变量,无法被引用</li>
<li>vars_files变量文件在ansible控制节点中,与目标主机无关</li>
<li>示例如下:<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="comment"># 为了更加方便的操作变量文件进行测试,此处将目标主机设置为me,主机me为ansible控制主机</span></span><br><span class="line"><span class="bullet">-</span> <span class="attr">hosts:</span> <span class="string">me</span></span><br><span class="line">  <span class="attr">remote_user:</span> <span class="string">root</span></span><br><span class="line">  <span class="attr">gather_facts:</span> <span class="literal">no</span></span><br><span class="line">  <span class="attr">vars_files:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">/testdir/ansible/testfile</span></span><br><span class="line">  <span class="comment"># /testdir/ansible/testfile内容为:</span></span><br><span class="line">  <span class="comment"># testvar1: aaa</span></span><br><span class="line">  <span class="comment"># testvar2: bbb</span></span><br><span class="line">  <span class="attr">tasks:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">debug:</span></span><br><span class="line">      <span class="attr">msg:</span> <span class="string">&quot;<span class="template-variable">&#123;&#123;testvar1&#125;&#125;</span>,<span class="template-variable">&#123;&#123;testvar2&#125;&#125;</span>&quot;</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">lineinfile:</span></span><br><span class="line">      <span class="attr">path:</span> <span class="string">&quot;/testdir/ansible/testfile&quot;</span></span><br><span class="line">      <span class="attr">line:</span> <span class="string">&quot;testvar3: ccc&quot;</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">debug:</span></span><br><span class="line">      <span class="attr">msg:</span> <span class="string">&quot;<span class="template-variable">&#123;&#123;testvar1&#125;&#125;</span>,<span class="template-variable">&#123;&#123;testvar2&#125;&#125;</span>,<span class="template-variable">&#123;&#123;testvar3&#125;&#125;</span>&quot;</span></span><br><span class="line"><span class="comment"># 上述执行出错,因为在playbook载入vars_files对应的变量文件时,文件中只有两个变量,在执行第三个任务执行,并没有重新载入对应的变量文件</span></span><br></pre></td></tr></table></figure></li>
</ul>
<p>2,include_vars可以在任务执行过程中,随时的引入变量文件,以便动态的获取到最新的变量文件内容</p>
<ul>
<li>接上例,调整内容如下:<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="comment"># 为了更加方便的操作变量文件进行测试,此处将目标主机设置为me,主机me为ansible控制主机</span></span><br><span class="line"><span class="bullet">-</span> <span class="attr">hosts:</span> <span class="string">me</span></span><br><span class="line">  <span class="attr">remote_user:</span> <span class="string">root</span></span><br><span class="line">  <span class="attr">gather_facts:</span> <span class="literal">no</span></span><br><span class="line">  <span class="attr">vars_files:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">/testdir/ansible/testfile</span></span><br><span class="line">  <span class="attr">tasks:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">debug:</span></span><br><span class="line">      <span class="attr">msg:</span> <span class="string">&quot;<span class="template-variable">&#123;&#123;testvar3&#125;&#125;</span>&quot;</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">lineinfile:</span></span><br><span class="line">      <span class="attr">path:</span> <span class="string">&quot;/testdir/ansible/testfile&quot;</span></span><br><span class="line">      <span class="attr">line:</span> <span class="string">&quot;testvar4: ddd&quot;</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">include_vars:</span> <span class="string">&quot;/testdir/ansible/testfile&quot;</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">debug:</span></span><br><span class="line">      <span class="attr">msg:</span> <span class="string">&quot;<span class="template-variable">&#123;&#123;testvar4&#125;&#125;</span>&quot;</span></span><br></pre></td></tr></table></figure></li>
<li>include_vars还有一种使用场景,有些时候,变量文件可能并没有位于ansible主机中,而是位于远程主机中,所以需要先把变量文件从远程主机中拉取到ansible主机中,当通过前面的task拉取到变量文件以后,也可以使用’include_vars’模块加载刚才拉取到的变量文件,以便后面的task可以使用变量文件中的变量.</li>
</ul>
<p>3,include_vars的一些常用参数</p>
<ul>
<li>file,如下示例:<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="bullet">-</span> <span class="attr">hosts:</span> <span class="string">node2</span></span><br><span class="line">  <span class="attr">remote_user:</span> <span class="string">root</span></span><br><span class="line">  <span class="attr">gather_facts:</span> <span class="literal">no</span></span><br><span class="line">  <span class="attr">tasks:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">include_vars:</span></span><br><span class="line">      <span class="attr">file:</span> <span class="string">/testdir/ansible/testfile</span></span><br><span class="line">  <span class="comment"># 等效于:</span></span><br><span class="line">  <span class="comment"># - include_vars: &quot;/testdir/ansible/testfile&quot;</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">debug:</span></span><br><span class="line">      <span class="attr">msg:</span> <span class="string">&quot;<span class="template-variable">&#123;&#123;testvar4&#125;&#125;</span>&quot;</span></span><br></pre></td></tr></table></figure></li>
<li>‘include_vars’可以把变量文件中的变量全部赋值给另外一个变量,如下示例:<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="bullet">-</span> <span class="attr">hosts:</span> <span class="string">node2</span></span><br><span class="line">  <span class="attr">remote_user:</span> <span class="string">root</span></span><br><span class="line">  <span class="attr">gather_facts:</span> <span class="literal">no</span></span><br><span class="line">  <span class="attr">tasks:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">include_vars:</span></span><br><span class="line">      <span class="attr">file:</span> <span class="string">/testdir/ansible/testfile</span></span><br><span class="line">      <span class="attr">name:</span> <span class="string">trans_var</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">debug:</span></span><br><span class="line">      <span class="attr">msg:</span> <span class="string">&quot;<span class="template-variable">&#123;&#123;trans_var&#125;&#125;</span>&quot;</span></span><br><span class="line"><span class="comment"># 输出如下:</span></span><br><span class="line"><span class="string">TASK</span> [<span class="string">debug</span>] <span class="string">xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx</span></span><br><span class="line"><span class="attr">ok:</span> [<span class="string">test70</span>] <span class="string">=&gt;</span> &#123;</span><br><span class="line">    <span class="attr">&quot;msg&quot;:</span> &#123;</span><br><span class="line">        <span class="attr">&quot;testvar1&quot;:</span> <span class="string">&quot;aaa&quot;</span>,</span><br><span class="line">        <span class="attr">&quot;testvar2&quot;:</span> <span class="string">&quot;bbb&quot;</span>,</span><br><span class="line">        <span class="attr">&quot;testvar3&quot;:</span> <span class="string">&quot;ccc&quot;</span>,</span><br><span class="line">        <span class="attr">&quot;testvar4&quot;:</span> <span class="string">&quot;ddd&quot;</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment"># &#x27;trans_var&#x27;变量的值就是变量文件中的所有变量,可以使用name参数指定一个变量,然后将文件中的所有变量都赋值给这个指定的变量</span></span><br><span class="line"><span class="comment"># 当使用name参数时,要获取到文件中的某一个变量的值,可以使用如下方法</span></span><br><span class="line">  <span class="attr">tasks:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">include_vars:</span></span><br><span class="line">      <span class="attr">file:</span> <span class="string">/testdir/ansible/testfile</span></span><br><span class="line">      <span class="attr">name:</span> <span class="string">trans_var</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">debug:</span></span><br><span class="line">      <span class="attr">msg:</span> <span class="string">&quot;<span class="template-variable">&#123;&#123;trans_var.testvar4&#125;&#125;</span>&quot;</span></span><br></pre></td></tr></table></figure></li>
<li>‘include_vars’不仅能够加载指定的变量文件,还能够一次性将指定目录下的所有变量文件中的变量加载,使用dir参数即可指定对应的目录<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="bullet">-</span> <span class="attr">hosts:</span> <span class="string">node2</span></span><br><span class="line">  <span class="attr">gather_facts:</span> <span class="literal">no</span></span><br><span class="line">  <span class="attr">remote_user:</span> <span class="string">root</span></span><br><span class="line">  <span class="attr">tasks:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">include_vars:</span></span><br><span class="line">      <span class="attr">dir:</span> <span class="string">/testdir/ansible/test/</span></span><br><span class="line">      <span class="attr">name:</span> <span class="string">trans_var</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">debug:</span></span><br><span class="line">      <span class="attr">msg:</span> <span class="string">&quot;<span class="template-variable">&#123;&#123;trans_var&#125;&#125;</span>&quot;</span></span><br><span class="line"><span class="comment"># 上例中,使用dir参数指定了&quot;/testdir/ansible/test/&quot;目录,此目录中的所有变量文件都会被加载,但是在使用dir参数时,需要注意如下三点</span></span><br><span class="line"><span class="comment"># 第一:指定目录中的所有文件的文件后缀必须是 ‘.yaml&#x27; 、&#x27;.yml&#x27; 、&#x27;.json&#x27;中的一种,默认只有这三种后缀是合法后缀,如果目录中存在非合法后缀的文件,执行playbook时则会报错.</span></span><br><span class="line"><span class="comment"># 第二:如果此目录中的子目录中包含变量文件,子目录中的变量文件也会被递归的加载,而且子目录中的文件也必须遵守上述第一条规则.</span></span><br><span class="line"><span class="comment"># 第三:dir参数与file参数不能同时使用.</span></span><br><span class="line"><span class="comment"># 第一点与第二点都是默认设置,可以通过其他选项修改</span></span><br><span class="line"><span class="comment"># 当使用dir参数时,指定目录中的所有文件必须以 ‘.yaml&#x27; 、&#x27;.yml&#x27; 、&#x27;.json&#x27; 作为文件的后缀,如果想要手动指定合法的文件后缀名,则可以使用extensions参数指定哪些后缀是合法的文件后缀,extensions参数的值需要是一个列表</span></span><br><span class="line">  <span class="attr">tasks:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">include_vars:</span></span><br><span class="line">      <span class="attr">dir:</span> <span class="string">/testdir/ansible/test/</span></span><br><span class="line">      <span class="attr">extensions:</span> [<span class="string">yaml</span>,<span class="string">yml</span>,<span class="string">json</span>,<span class="string">varfile</span>]</span><br><span class="line">      <span class="attr">name:</span> <span class="string">trans_var</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">debug:</span></span><br><span class="line">      <span class="attr">msg:</span> <span class="string">&quot;<span class="template-variable">&#123;&#123;trans_var&#125;&#125;</span>&quot;</span></span><br><span class="line"><span class="comment"># 上例中extensions参数的值为 “[yaml,yml,json,varfile]&quot;,这表示指定目录中的合法文件后缀名为yaml、yml、json和varfile.</span></span><br><span class="line"><span class="comment"># 当使用dir参数时,默认情况下会递归的加载指定目录及其子目录中的所有变量文件,如果想要控制递归的深度,则可以借助depth参数,示例如下</span></span><br><span class="line">  <span class="attr">tasks:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">include_vars:</span></span><br><span class="line">      <span class="attr">dir:</span> <span class="string">/testdir/ansible/test/</span></span><br><span class="line">      <span class="attr">depth:</span> <span class="number">1</span></span><br><span class="line">      <span class="attr">name:</span> <span class="string">trans_var</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">debug:</span></span><br><span class="line">      <span class="attr">msg:</span> <span class="string">&quot;<span class="template-variable">&#123;&#123;trans_var&#125;&#125;</span>&quot;</span></span><br><span class="line"><span class="comment"># 上例表示,加载&quot;/testdir/ansible/test/&quot;目录中的变量文件,但是其子目录中的变量文件将不会被加载,depth的值为1表示递归深度为1,默认值为0,表示递归到最底层的子目录.</span></span><br><span class="line"><span class="comment"># 在使用dir参数时,我们还可以借助正则表达式,匹配那些我们想要加载的变量文件,比如,我们只想加载指定目录中以&quot;var_&quot;开头的变量文件,则可以使用如下方法</span></span><br><span class="line">  <span class="attr">tasks:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">include_vars:</span></span><br><span class="line">      <span class="attr">dir:</span> <span class="string">/testdir/ansible/test/</span></span><br><span class="line">      <span class="attr">files_matching:</span> <span class="string">&quot;^var_.*&quot;</span></span><br><span class="line">      <span class="attr">name:</span> <span class="string">trans_var</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">debug:</span></span><br><span class="line">      <span class="attr">msg:</span> <span class="string">&quot;<span class="template-variable">&#123;&#123;trans_var&#125;&#125;</span>&quot;</span></span><br><span class="line"><span class="comment"># 如上例所示,使用&#x27;files_matching&#x27;参数可以指定正则表达式,当指定目录中的文件名称符合正则时,则可以被加载</span></span><br><span class="line"><span class="comment"># 还可以明确指定,哪些变量文件不能被加载,使用&#x27;ignore_files&#x27;参数可以明确指定需要忽略的变量文件名称,&#x27;ignore_files&#x27;参数的值是需要是一个列表</span></span><br><span class="line">  <span class="attr">tasks:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">include_vars:</span></span><br><span class="line">      <span class="attr">dir:</span> <span class="string">/testdir/ansible/test/</span></span><br><span class="line">      <span class="attr">ignore_files:</span> [<span class="string">&quot;^var_.*&quot;</span>,<span class="string">varintest.yaml</span>]</span><br><span class="line">      <span class="attr">name:</span> <span class="string">trans_var</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">debug:</span></span><br><span class="line">      <span class="attr">msg:</span> <span class="string">&quot;<span class="template-variable">&#123;&#123;trans_var&#125;&#125;</span>&quot;</span></span><br><span class="line"><span class="comment"># 加载 /testdir/ansible/test/目录中的变量文件,但是所有以&quot;var_&quot;开头的变量文件和varintest.yaml变量文件将不会被加载, ‘files_matching&#x27;参数和&#x27;ignore_files&#x27;参数能够同时使用,当它们同时出现时,会先找出正则匹配到的文件,然后从中排除那些需要忽略的文件</span></span><br></pre></td></tr></table></figure></li>
</ul>
<p>3, 在2.4版本以后的ansible中,当执行了include_vars模块以后,include_vars模块会将载入的变量文件列表写入到自己的返回值中,这个返回值的关键字为’ansible_included_var_files’,所以,如果我们想要知道本次任务引入了哪些变量文件,则可以使用如下方法</p>
<ul>
<li>如下示例:<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">tasks:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">include_vars:</span></span><br><span class="line">      <span class="attr">dir:</span> <span class="string">/testdir/ansible/test/</span></span><br><span class="line">    <span class="attr">register:</span> <span class="string">return_val</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">debug:</span></span><br><span class="line">      <span class="attr">msg:</span> <span class="string">&quot;<span class="template-variable">&#123;&#123;return_val.ansible_included_var_files&#125;&#125;</span>&quot;</span></span><br></pre></td></tr></table></figure>
<h3 id="2021-07-15-过滤器-二-json-query"><a href="#2021-07-15-过滤器-二-json-query" class="headerlink" title="2021-07-15 过滤器(二) json_query"></a>2021-07-15 过滤器(二) json_query</h3>1,ansible可以通过include_vars加载日志文件,debug格式化输出json&#x2F;yaml内容,方便查看</li>
<li>json是yaml的子集,yaml是json的超集,yaml格式的数据和json格式的数据是可以互相转换的</li>
<li>如下示例:<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="bullet">-</span> <span class="attr">hosts:</span> <span class="string">me</span></span><br><span class="line">  <span class="attr">remote_user:</span> <span class="string">liawne</span></span><br><span class="line">  <span class="attr">gather_facts:</span> <span class="literal">no</span></span><br><span class="line">  <span class="attr">tasks:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">include_vars:</span></span><br><span class="line">      <span class="attr">file:</span> <span class="string">&quot;/testdir/ansible/wsCdnLogList&quot;</span></span><br><span class="line">      <span class="attr">name:</span> <span class="string">testvar</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">debug:</span></span><br><span class="line">      <span class="attr">msg:</span> <span class="string">&quot;<span class="template-variable">&#123;&#123; testvar &#125;&#125;</span>&quot;</span></span><br><span class="line"><span class="comment"># 输出如下:</span></span><br><span class="line"><span class="string">TASK</span> [<span class="string">debug</span>] <span class="string">xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx</span></span><br><span class="line"><span class="attr">ok:</span> [<span class="string">node2</span>] <span class="string">=&gt;</span> &#123;</span><br><span class="line">    <span class="attr">&quot;msg&quot;:</span> &#123;</span><br><span class="line">        <span class="attr">&quot;logs&quot;:</span> [</span><br><span class="line">            &#123;</span><br><span class="line">                <span class="attr">&quot;domainName&quot;:</span> <span class="string">&quot;asia1.cdn.test.com&quot;</span>,</span><br><span class="line">                <span class="attr">&quot;files&quot;:</span> [</span><br><span class="line">                    &#123;</span><br><span class="line">                        <span class="attr">&quot;dateFrom&quot;:</span> <span class="string">&quot;2018-09-05-0000&quot;</span>,</span><br><span class="line">                        <span class="attr">&quot;dateTo&quot;:</span> <span class="string">&quot;2018-09-05-2359&quot;</span>,</span><br><span class="line">                        <span class="attr">&quot;fileMd5&quot;:</span> <span class="string">&quot;error&quot;</span>,</span><br><span class="line">                        <span class="attr">&quot;fileName&quot;:</span> <span class="string">&quot;2018-09-05-0000-2330_asia1.cdn.test.com.all.log.gz&quot;</span>,</span><br><span class="line">                        <span class="attr">&quot;fileSize&quot;:</span> <span class="number">254</span>,</span><br><span class="line">                        <span class="attr">&quot;logUrl&quot;:</span> <span class="string">&quot;http://log.testcd.com/log/zsy/asia1.cdn.test.com/2018-09-05-0000-2330_asia1.cdn.test.com.all.log.gz?wskey=XXXXX5a&quot;</span></span><br><span class="line">                    &#125;</span><br><span class="line">                ]</span><br><span class="line">            &#125;,</span><br><span class="line">            &#123;</span><br><span class="line">                <span class="attr">&quot;domainName&quot;:</span> <span class="string">&quot;image1.cdn.test.com&quot;</span>,</span><br><span class="line">                <span class="attr">&quot;files&quot;:</span> [</span><br><span class="line">                    &#123;</span><br><span class="line">                        <span class="attr">&quot;dateFrom&quot;:</span> <span class="string">&quot;2018-09-05-2200&quot;</span>,</span><br><span class="line">                        <span class="attr">&quot;dateTo&quot;:</span> <span class="string">&quot;2018-09-05-2259&quot;</span>,</span><br><span class="line">                        <span class="attr">&quot;fileMd5&quot;:</span> <span class="string">&quot;error&quot;</span>,</span><br><span class="line">                        <span class="attr">&quot;fileName&quot;:</span> <span class="string">&quot;2018-09-05-2200-2230_image1.cdn.test.com.cn.log.gz&quot;</span>,</span><br><span class="line">                        <span class="attr">&quot;fileSize&quot;:</span> <span class="number">10509</span>,</span><br><span class="line">                        <span class="attr">&quot;logUrl&quot;:</span> <span class="string">&quot;http://log.testcd.com/log/zsy/image1.cdn.test.com/2018-09-05-2200-2230_image1.cdn.test.com.cn.log.gz?wskey=XXXXX1c&quot;</span></span><br><span class="line">                    &#125;,</span><br><span class="line">                    &#123;</span><br><span class="line">                        <span class="attr">&quot;dateFrom&quot;:</span> <span class="string">&quot;2018-09-05-2300&quot;</span>,</span><br><span class="line">                        <span class="attr">&quot;dateTo&quot;:</span> <span class="string">&quot;2018-09-05-2359&quot;</span>,</span><br><span class="line">                        <span class="attr">&quot;fileMd5&quot;:</span> <span class="string">&quot;error&quot;</span>,</span><br><span class="line">                        <span class="attr">&quot;fileName&quot;:</span> <span class="string">&quot;2018-09-05-2300-2330_image1.cdn.test.com.cn.log.gz&quot;</span>,</span><br><span class="line">                        <span class="attr">&quot;fileSize&quot;:</span> <span class="number">5637</span>,</span><br><span class="line">                        <span class="attr">&quot;logUrl&quot;:</span> <span class="string">&quot;http://log.testcd.com/log/zsy/image1.cdn.test.com/2018-09-05-2300-2330_image1.cdn.test.com.cn.log.gz?wskey=XXXXXfe&quot;</span></span><br><span class="line">                    &#125;</span><br><span class="line">                ]</span><br><span class="line">            &#125;</span><br><span class="line">        ]</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment"># 变量文件的格式可以是yaml格式的,也可以是json格式的,上例就是将json格式的数据文件当做变量文件使用的</span></span><br><span class="line"><span class="comment"># 对于ansible来说,当我们把上例中的json数据文件当做变量文件引入时,就好像引入了一个我们定义好的yaml格式的变量文件一样,对于ansible来说是没有区别的</span></span><br></pre></td></tr></table></figure></li>
<li>当需要从上例中获取到logUrl时,可以使用如下方式获取:<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">tasks:</span></span><br><span class="line"><span class="bullet">-</span> <span class="attr">include_vars:</span></span><br><span class="line">    <span class="attr">file:</span> <span class="string">&quot;/testdir/ansible/wsCdnLogList&quot;</span></span><br><span class="line">    <span class="attr">name:</span> <span class="string">testvar</span></span><br><span class="line"><span class="bullet">-</span> <span class="attr">debug:</span></span><br><span class="line">    <span class="attr">msg:</span> <span class="string">&quot;<span class="template-variable">&#123;&#123; item.1.logUrl &#125;&#125;</span>&quot;</span></span><br><span class="line">  <span class="attr">with_subelements:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">&quot;<span class="template-variable">&#123;&#123;testvar.logs&#125;&#125;</span>&quot;</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">files</span></span><br></pre></td></tr></table></figure></li>
</ul>
<p>2,上述例子中除with_subelements外,还可以使用json_query来获取</p>
<ul>
<li>json_query的使用方式:<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 假设testvarfile中内容如下</span></span><br><span class="line">&#123;</span><br><span class="line">  <span class="attr">&quot;users&quot;:</span> [</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="attr">&quot;name&quot;:</span> <span class="string">&quot;tom&quot;</span>,</span><br><span class="line">      <span class="attr">&quot;age&quot;:</span> <span class="number">18</span></span><br><span class="line">    &#125;,</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="attr">&quot;name&quot;:</span> <span class="string">&quot;jerry&quot;</span>,</span><br><span class="line">      <span class="attr">&quot;age&quot;:</span> <span class="number">20</span></span><br><span class="line">    &#125;</span><br><span class="line">  ]</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment"># 如果要获取到所有user的name</span></span><br><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="bullet">-</span> <span class="attr">hosts:</span> <span class="string">me</span></span><br><span class="line">  <span class="attr">remote_user:</span> <span class="string">liawne</span></span><br><span class="line">  <span class="attr">gather_facts:</span> <span class="literal">no</span></span><br><span class="line">  <span class="attr">tasks:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">include_vars:</span></span><br><span class="line">      <span class="attr">file:</span> <span class="string">&quot;/testdir/ansible/testvarfile&quot;</span></span><br><span class="line">      <span class="attr">name:</span> <span class="string">testvar</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">debug:</span></span><br><span class="line">      <span class="attr">msg:</span> <span class="string">&quot;<span class="template-variable">&#123;&#123; testvar | json_query(&#x27;users[*].name&#x27;) &#125;&#125;</span>&quot;</span></span><br><span class="line"><span class="comment"># 这段数据当做变量赋值给了testvar变量,使用json_query过滤器对这个变量进行了处理,json_query(&#x27;users[*].name&#x27;)表示找到users列表中所有元素的name属性,输出如下:</span></span><br><span class="line"><span class="string">TASK</span> [<span class="string">debug</span>] <span class="string">xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx</span></span><br><span class="line"><span class="attr">ok:</span> [<span class="string">test70</span>] <span class="string">=&gt;</span> &#123;</span><br><span class="line">    <span class="attr">&quot;msg&quot;:</span> [</span><br><span class="line">        <span class="string">&quot;tom&quot;</span>,</span><br><span class="line">        <span class="string">&quot;jerry&quot;</span></span><br><span class="line">    ]</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li>
<li>更进一步<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 假设testvarfile中内容如下</span></span><br><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="attr">test:</span></span><br><span class="line">  <span class="attr">users:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">tom</span></span><br><span class="line">    <span class="attr">age:</span> <span class="number">18</span></span><br><span class="line">    <span class="attr">hobby:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">Skateboard</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">VideoGame</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">jerry</span></span><br><span class="line">    <span class="attr">age:</span> <span class="number">20</span></span><br><span class="line">    <span class="attr">hobby:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">Music</span></span><br><span class="line"><span class="comment"># 要获取到所有的爱好</span></span><br><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="bullet">-</span> <span class="attr">hosts:</span> <span class="string">me</span></span><br><span class="line">  <span class="attr">remote_user:</span> <span class="string">liawne</span></span><br><span class="line">  <span class="attr">gather_facts:</span> <span class="literal">no</span></span><br><span class="line">  <span class="attr">tasks:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">include_vars:</span></span><br><span class="line">      <span class="attr">file:</span> <span class="string">&quot;/testdir/ansible/testvarfile1&quot;</span></span><br><span class="line">      <span class="attr">name:</span> <span class="string">testvar</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">debug:</span></span><br><span class="line">      <span class="attr">msg:</span> <span class="string">&quot;<span class="template-variable">&#123;&#123; testvar | json_query(&#x27;test.users[*].hobby[*]&#x27;) &#125;&#125;</span>&quot;</span></span><br><span class="line"><span class="comment"># 当数据结构中存在列表时,我们可以使用”列表名[*]”获取到列表下面的所有项,输出结果如下:</span></span><br><span class="line"><span class="string">TASK</span> [<span class="string">debug</span>] <span class="string">xxxxxxxxxxxxxxxxxxxxxxxxxxxxx</span></span><br><span class="line"><span class="attr">ok:</span> [<span class="string">me</span>] <span class="string">=&gt;</span> &#123;</span><br><span class="line">    <span class="attr">&quot;msg&quot;:</span> [</span><br><span class="line">        [</span><br><span class="line">            <span class="string">&quot;Skateboard&quot;</span>,</span><br><span class="line">            <span class="string">&quot;VideoGame&quot;</span></span><br><span class="line">        ],</span><br><span class="line">        [</span><br><span class="line">            <span class="string">&quot;Music&quot;</span></span><br><span class="line">        ]</span><br><span class="line">    ]</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment"># 想要根据条件获取到某个用户的某些信息</span></span><br><span class="line"><span class="comment"># method one</span></span><br><span class="line">  <span class="attr">tasks:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">include_vars:</span></span><br><span class="line">      <span class="attr">file:</span> <span class="string">&quot;/testdir/ansible/testvarfile1&quot;</span></span><br><span class="line">      <span class="attr">name:</span> <span class="string">testvar</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">debug:</span></span><br><span class="line">      <span class="comment"># 此处使用了反引号,因为已经使用了&#x27;和&quot;,使用`用作区分</span></span><br><span class="line">      <span class="attr">msg:</span> <span class="string">&quot;<span class="template-variable">&#123;&#123; testvar | json_query(&#x27;test.users[?name==`tom`].hobby[*]&#x27;) &#125;&#125;</span>&quot;</span></span><br><span class="line"><span class="comment"># method two</span></span><br><span class="line">  <span class="attr">tasks:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">include_vars:</span></span><br><span class="line">      <span class="attr">file:</span> <span class="string">&quot;/testdir/ansible/testvarfile1&quot;</span></span><br><span class="line">      <span class="attr">name:</span> <span class="string">testvar</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">debug:</span></span><br><span class="line">      <span class="attr">msg:</span> <span class="string">&quot;<span class="template-variable">&#123;&#123; testvar | json_query(querystring) &#125;&#125;</span>&quot;</span></span><br><span class="line">    <span class="attr">vars:</span></span><br><span class="line">      <span class="attr">querystring:</span> <span class="string">&quot;test.users[?name==&#x27;tom&#x27;].age&quot;</span></span><br><span class="line"><span class="comment"># 在debug任务中使用vars关键字定义了一个只有当前debug任务能够使用的变量,从而避免了多层引号嵌套时所产生的冲突问题.</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 同时获取到用户的姓名、年龄两个属性的值,当需要同时获取多个属性值时,需要通过键值对的方式调用属性</span></span><br><span class="line">  <span class="attr">tasks:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">include_vars:</span></span><br><span class="line">      <span class="attr">file:</span> <span class="string">&quot;/testdir/ansible/testvarfile1&quot;</span></span><br><span class="line">      <span class="attr">name:</span> <span class="string">testvar</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">debug:</span></span><br><span class="line">      <span class="attr">msg:</span> <span class="string">&quot;<span class="template-variable">&#123;&#123; testvar | json_query(&#x27;test.users[*].&#123;uname:name,uage:age&#125;&#x27;) &#125;&#125;</span>&quot;</span></span><br><span class="line"><span class="comment"># 输出内容如下:</span></span><br><span class="line"><span class="string">TASK</span> [<span class="string">debug</span>] <span class="string">xxxxxxxxxxxxxxxxxxxxxxxxxxxxx</span></span><br><span class="line"><span class="attr">ok:</span> [<span class="string">me</span>] <span class="string">=&gt;</span> &#123;</span><br><span class="line">    <span class="attr">&quot;msg&quot;:</span> [</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="attr">&quot;uage&quot;:</span> <span class="number">18</span>,</span><br><span class="line">            <span class="attr">&quot;uname&quot;:</span> <span class="string">&quot;tom&quot;</span></span><br><span class="line">        &#125;,</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="attr">&quot;uage&quot;:</span> <span class="number">20</span>,</span><br><span class="line">            <span class="attr">&quot;uname&quot;:</span> <span class="string">&quot;jerry&quot;</span></span><br><span class="line">        &#125;</span><br><span class="line">    ]</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li>
<li>回到第一个示例,获取logUrl的方式如下:<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="bullet">-</span> <span class="attr">hosts:</span> <span class="string">me</span></span><br><span class="line">  <span class="attr">remote_user:</span> <span class="string">liawne</span></span><br><span class="line">  <span class="attr">gather_facts:</span> <span class="literal">no</span></span><br><span class="line">  <span class="attr">vars_files:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">/testdir/ansible/wsCdnLogList</span></span><br><span class="line">  <span class="attr">tasks:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">debug:</span></span><br><span class="line">      <span class="attr">msg:</span> <span class="string">&quot;<span class="template-variable">&#123;&#123;item&#125;&#125;</span>&quot;</span></span><br><span class="line">    <span class="attr">with_items:</span> <span class="string">&quot;<span class="template-variable">&#123;&#123; logs | json_query(&#x27;[*].files[*].logUrl&#x27;) &#125;&#125;</span>&quot;</span></span><br></pre></td></tr></table></figure>
<h3 id="2021-07-15-过滤器-三-其他过滤器"><a href="#2021-07-15-过滤器-三-其他过滤器" class="headerlink" title="2021-07-15 过滤器(三) 其他过滤器"></a>2021-07-15 过滤器(三) 其他过滤器</h3>1,其他一些常用的过滤器<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="bullet">-</span> <span class="attr">hosts:</span> <span class="string">me</span></span><br><span class="line">  <span class="attr">remote_user:</span> <span class="string">liawne</span></span><br><span class="line">  <span class="attr">gather_facts:</span> <span class="literal">no</span></span><br><span class="line">  <span class="attr">tasks:</span></span><br><span class="line">  <span class="comment">######################################################################</span></span><br><span class="line">  <span class="comment">#在调用shell模块时,如果引用某些变量时需要添加引号,则可以使用quote过滤器代替引号</span></span><br><span class="line">  <span class="comment">#示例如下,先看示例,后面会有注解</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">shell:</span> <span class="string">&quot;echo <span class="template-variable">&#123;&#123;teststr | quote&#125;&#125;</span> &gt; /testdir/testfile&quot;</span></span><br><span class="line">    <span class="attr">vars:</span></span><br><span class="line">      <span class="attr">teststr:</span> <span class="string">&quot;a\nb\nc&quot;</span></span><br><span class="line">  <span class="comment">#上例中shell模块的写法与如下写法完全等效</span></span><br><span class="line">  <span class="comment">#shell: &quot;echo &#x27;&#123;&#123;teststr&#125;&#125;&#x27; &gt; /testdir/testfile&quot;</span></span><br><span class="line">  <span class="comment">#没错,如你所见,quote过滤器能够代替引号</span></span><br><span class="line">  <span class="comment">#上例中,如果不对&#123;&#123;teststr&#125;&#125;添加引号,则会报错,因为teststr变量中包含&quot;\n&quot;转义符</span></span><br><span class="line">  <span class="comment">######################################################################</span></span><br><span class="line">  <span class="comment">#ternary过滤器可以实现三元运算的效果 示例如下</span></span><br><span class="line">  <span class="comment">#如下示例表示如果name变量的值是John,那么对应的值则为Mr,否则则为Ms</span></span><br><span class="line">  <span class="comment">#简便的实现类似if else对变量赋值的效果</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">debug:</span> </span><br><span class="line">      <span class="attr">msg:</span> <span class="string">&quot;<span class="template-variable">&#123;&#123; (name == &#x27;John&#x27;) | ternary(&#x27;Mr&#x27;,&#x27;Ms&#x27;) &#125;&#125;</span>&quot;</span></span><br><span class="line">    <span class="attr">vars:</span></span><br><span class="line">      <span class="attr">name:</span> <span class="string">&quot;John&quot;</span></span><br><span class="line">  <span class="comment">######################################################################</span></span><br><span class="line">  <span class="comment">#basename过滤器可以获取到一个路径字符串中的文件名</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">debug:</span></span><br><span class="line">      <span class="attr">msg:</span> <span class="string">&quot;<span class="template-variable">&#123;&#123;teststr | basename&#125;&#125;</span>&quot;</span></span><br><span class="line">    <span class="attr">vars:</span></span><br><span class="line">      <span class="attr">teststr:</span> <span class="string">&quot;/testdir/ansible/testfile&quot;</span></span><br><span class="line">  <span class="comment">######################################################################</span></span><br><span class="line">  <span class="comment">#获取到一个windows路径字符串中的文件名,2.0版本以后的ansible可用</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">debug:</span></span><br><span class="line">      <span class="attr">msg:</span> <span class="string">&quot;<span class="template-variable">&#123;&#123;teststr | win_basename&#125;&#125;</span>&quot;</span></span><br><span class="line">    <span class="attr">vars:</span></span><br><span class="line">      <span class="attr">teststr:</span> <span class="string">&#x27;D:\study\zsythink&#x27;</span></span><br><span class="line">  <span class="comment">######################################################################</span></span><br><span class="line">  <span class="comment">#dirname过滤器可以获取到一个路径字符串中的路径名</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">debug:</span></span><br><span class="line">      <span class="attr">msg:</span> <span class="string">&quot;<span class="template-variable">&#123;&#123;teststr | dirname&#125;&#125;</span>&quot;</span></span><br><span class="line">    <span class="attr">vars:</span></span><br><span class="line">      <span class="attr">teststr:</span> <span class="string">&quot;/testdir/ansible/testfile&quot;</span></span><br><span class="line">  <span class="comment">######################################################################</span></span><br><span class="line">  <span class="comment">#获取到一个windows路径字符串中的文件名,2.0版本以后的ansible可用</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">debug:</span></span><br><span class="line">      <span class="attr">msg:</span> <span class="string">&quot;<span class="template-variable">&#123;&#123;teststr | win_dirname&#125;&#125;</span>&quot;</span></span><br><span class="line">    <span class="attr">vars:</span></span><br><span class="line">      <span class="attr">teststr:</span> <span class="string">&#x27;D:\study\zsythink&#x27;</span></span><br><span class="line">  <span class="comment">######################################################################</span></span><br><span class="line">  <span class="comment">#将一个windows路径字符串中的盘符和路径分开,2.0版本以后的ansible可用</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">debug:</span></span><br><span class="line">      <span class="attr">msg:</span> <span class="string">&quot;<span class="template-variable">&#123;&#123;teststr | win_splitdrive&#125;&#125;</span>&quot;</span></span><br><span class="line">    <span class="attr">vars:</span></span><br><span class="line">      <span class="attr">teststr:</span> <span class="string">&#x27;D:\study\zsythink&#x27;</span></span><br><span class="line">  <span class="comment">#可以配合之前总结的过滤器一起使用,比如只获取到盘符,示例如下</span></span><br><span class="line">  <span class="comment">#msg: &quot;&#123;&#123;teststr | win_splitdrive | first&#125;&#125;&quot;</span></span><br><span class="line">  <span class="comment">#可以配合之前总结的过滤器一起使用,比如只获取到路径,示例如下</span></span><br><span class="line">  <span class="comment">#msg: &quot;&#123;&#123;teststr | win_splitdrive | last&#125;&#125;&quot;</span></span><br><span class="line">  <span class="comment">######################################################################</span></span><br><span class="line">  <span class="comment">#realpath过滤器可以获取软链接文件所指向的真正文件</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">debug:</span></span><br><span class="line">      <span class="attr">msg:</span> <span class="string">&quot;<span class="template-variable">&#123;&#123; path | realpath &#125;&#125;</span>&quot;</span></span><br><span class="line">    <span class="attr">vars:</span></span><br><span class="line">      <span class="attr">path:</span> <span class="string">&quot;/testdir/ansible/testsoft&quot;</span></span><br><span class="line">  <span class="comment">######################################################################</span></span><br><span class="line">  <span class="comment">#relpath过滤器可以获取到path对于“指定路径”来说的“相对路径”</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">debug:</span></span><br><span class="line">      <span class="attr">msg:</span> <span class="string">&quot;<span class="template-variable">&#123;&#123; path | relpath(&#x27;/testdir/testdir&#x27;) &#125;&#125;</span>&quot;</span></span><br><span class="line">    <span class="attr">vars:</span></span><br><span class="line">      <span class="attr">path:</span> <span class="string">&quot;/testdir/ansible&quot;</span></span><br><span class="line">  <span class="comment">######################################################################</span></span><br><span class="line">  <span class="comment">#splitext过滤器可以将带有文件名后缀的路径从“.后缀”部分分开</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">debug:</span></span><br><span class="line">      <span class="attr">msg:</span> <span class="string">&quot;<span class="template-variable">&#123;&#123; path | splitext &#125;&#125;</span>&quot;</span></span><br><span class="line">    <span class="attr">vars:</span></span><br><span class="line">      <span class="attr">path:</span> <span class="string">&quot;/etc/nginx/conf.d/test.conf&quot;</span></span><br><span class="line">  <span class="comment">#可以配置之前总结的过滤器,获取到文件后缀</span></span><br><span class="line">  <span class="comment">#msg: &quot;&#123;&#123; path | splitext | last&#125;&#125;&quot;</span></span><br><span class="line">  <span class="comment">#可以配置之前总结的过滤器,获取到文件前缀名</span></span><br><span class="line">  <span class="comment">#msg: &quot;&#123;&#123; path | splitext | first | basename&#125;&#125;&quot;</span></span><br><span class="line">  <span class="comment">######################################################################</span></span><br><span class="line">  <span class="comment">#to_uuid过滤器能够为对应的字符串生成uuid</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">debug:</span></span><br><span class="line">      <span class="attr">msg:</span> <span class="string">&quot;<span class="template-variable">&#123;&#123; teststr | to_uuid &#125;&#125;</span>&quot;</span></span><br><span class="line">    <span class="attr">vars:</span></span><br><span class="line">      <span class="attr">teststr:</span> <span class="string">&quot;This is a test statement&quot;</span> </span><br><span class="line">  <span class="comment">######################################################################</span></span><br><span class="line">  <span class="comment">#bool过滤器可以根据字符串的内容返回bool值true或者false</span></span><br><span class="line">  <span class="comment">#字符串的内容为yes、1、True、true则返回布尔值true,字符串内容为其他内容则返回false</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">debug:</span></span><br><span class="line">      <span class="attr">msg:</span> <span class="string">&quot;<span class="template-variable">&#123;&#123; teststr | bool &#125;&#125;</span>&quot;</span></span><br><span class="line">    <span class="attr">vars:</span></span><br><span class="line">      <span class="attr">teststr:</span> <span class="string">&quot;1&quot;</span></span><br><span class="line">  <span class="comment">#当和用户交互时,有可能需要用户从两个选项中选择一个,比如是否继续,</span></span><br><span class="line">  <span class="comment">#这时,将用户输入的字符串通过bool过滤器处理后得出布尔值,从而进行判断,比如如下用法</span></span><br><span class="line">  <span class="comment">#- de<span class="doctag">bug:</span></span></span><br><span class="line">  <span class="comment">#    msg: &quot;output when bool is true&quot;</span></span><br><span class="line">  <span class="comment">#  when: some_string_user_input | bool</span></span><br><span class="line">  <span class="comment">######################################################################</span></span><br><span class="line">  <span class="comment">#map过滤器可以从列表中获取到每个元素所共有的某个属性的值,并将这些值组成一个列表</span></span><br><span class="line">  <span class="comment">#当列表中嵌套了列表,不能越级获取属性的值,也就是说只能获取直接子元素的共有属性值.</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">vars:</span></span><br><span class="line">      <span class="attr">users:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">tom</span></span><br><span class="line">        <span class="attr">age:</span> <span class="number">18</span></span><br><span class="line">        <span class="attr">hobby:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="string">Skateboard</span></span><br><span class="line">        <span class="bullet">-</span> <span class="string">VideoGame</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">jerry</span></span><br><span class="line">        <span class="attr">age:</span> <span class="number">20</span></span><br><span class="line">        <span class="attr">hobby:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="string">Music</span></span><br><span class="line">    <span class="attr">debug:</span></span><br><span class="line">      <span class="attr">msg:</span> <span class="string">&quot;<span class="template-variable">&#123;&#123; users | map(attribute=&#x27;name&#x27;) | list &#125;&#125;</span>&quot;</span></span><br><span class="line">  <span class="comment">#也可以组成一个字符串,用指定的字符隔开,比如分号</span></span><br><span class="line">  <span class="comment">#msg: &quot;&#123;&#123; users | map(attribute=&#x27;name&#x27;) | join(&#x27;;&#x27;) &#125;&#125;&quot;</span></span><br><span class="line">  <span class="comment">######################################################################</span></span><br><span class="line">  <span class="comment">#与python中的用法相同,两个日期类型相减能够算出两个日期间的时间差</span></span><br><span class="line">  <span class="comment">#下例中,我们使用to_datatime过滤器将字符串类型转换成了日期了类型,并且算出了时间差</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">debug:</span></span><br><span class="line">      <span class="attr">msg:</span> <span class="string">&#x27;<span class="template-variable">&#123;&#123; (&quot;2016-08-14 20:00:12&quot;| to_datetime) - (&quot;2012-12-25 19:00:00&quot; | to_datetime) &#125;&#125;</span>&#x27;</span></span><br><span class="line">  <span class="comment">#默认情况下,to_datatime转换的字符串的格式必须是“%Y-%m-%d %H:%M:%S”</span></span><br><span class="line">  <span class="comment">#如果对应的字符串不是这种格式,则需要在to_datetime中指定与字符串相同的时间格式,才能正确的转换为时间类型</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">debug:</span></span><br><span class="line">      <span class="attr">msg:</span> <span class="string">&#x27;<span class="template-variable">&#123;&#123; (&quot;20160814&quot;| to_datetime(&quot;%Y%m%d&quot;)) - (&quot;2012-12-25 19:00:00&quot; | to_datetime) &#125;&#125;</span>&#x27;</span></span><br><span class="line">  <span class="comment">#如下方法可以获取到两个日期之间一共相差多少秒</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">debug:</span></span><br><span class="line">      <span class="attr">msg:</span> <span class="string">&#x27;<span class="template-variable">&#123;&#123; ( (&quot;20160814&quot;| to_datetime(&quot;%Y%m%d&quot;)) - (&quot;20121225&quot; | to_datetime(&quot;%Y%m%d&quot;)) ).total_seconds() &#125;&#125;</span>&#x27;</span></span><br><span class="line">  <span class="comment">#如下方法可以获取到两个日期“时间位”相差多少秒,注意:日期位不会纳入对比计算范围</span></span><br><span class="line">  <span class="comment">#也就是说,下例中的2016-08-14和2012-12-25不会纳入计算范围</span></span><br><span class="line">  <span class="comment">#只是计算20:00:12与08:30:00相差多少秒</span></span><br><span class="line">  <span class="comment">#如果想要算出连带日期的秒数差则使用total_seconds()</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">debug:</span></span><br><span class="line">      <span class="attr">msg:</span> <span class="string">&#x27;<span class="template-variable">&#123;&#123; ( (&quot;2016-08-14 20:00:12&quot;| to_datetime) - (&quot;2012-12-25 08:30:00&quot; | to_datetime) ).seconds &#125;&#125;</span>&#x27;</span></span><br><span class="line">  <span class="comment">#如下方法可以获取到两个日期“日期位”相差多少天,注意:时间位不会纳入对比计算范围</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">debug:</span></span><br><span class="line">      <span class="attr">msg:</span> <span class="string">&#x27;<span class="template-variable">&#123;&#123; ( (&quot;2016-08-14 20:00:12&quot;| to_datetime) - (&quot;2012-12-25 08:30:00&quot; | to_datetime) ).days &#125;&#125;</span>&#x27;</span></span><br><span class="line">  <span class="comment">######################################################################</span></span><br><span class="line">  <span class="comment">#使用base64编码方式对字符串进行编码</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">debug:</span></span><br><span class="line">      <span class="attr">msg:</span> <span class="string">&quot;<span class="template-variable">&#123;&#123; &#x27;hello&#x27; | b64encode &#125;&#125;</span>&quot;</span></span><br><span class="line">  <span class="comment">#使用base64编码方式对字符串进行解码</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">debug:</span></span><br><span class="line">      <span class="attr">msg:</span> <span class="string">&quot;<span class="template-variable">&#123;&#123; &#x27;aGVsbG8=&#x27; | b64decode &#125;&#125;</span>&quot;</span></span><br><span class="line">  <span class="comment">#######################################################################</span></span><br><span class="line">  <span class="comment">#使用sha1算法对字符串进行哈希</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">debug:</span></span><br><span class="line">      <span class="attr">msg:</span> <span class="string">&quot;<span class="template-variable">&#123;&#123; &#x27;123456&#x27; | hash(&#x27;sha1&#x27;) &#125;&#125;</span>&quot;</span></span><br><span class="line">  <span class="comment">#使用md5算法对字符串进行哈希</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">debug:</span></span><br><span class="line">      <span class="attr">msg:</span> <span class="string">&quot;<span class="template-variable">&#123;&#123; &#x27;123456&#x27; | hash(&#x27;md5&#x27;) &#125;&#125;</span>&quot;</span></span><br><span class="line">  <span class="comment">#获取到字符串的校验和,与md5哈希值一致</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">debug:</span></span><br><span class="line">      <span class="attr">msg:</span> <span class="string">&quot;<span class="template-variable">&#123;&#123; &#x27;123456&#x27; | checksum &#125;&#125;</span>&quot;</span></span><br><span class="line">  <span class="comment">#使用blowfish算法对字符串进行哈希,注:部分系统支持</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">debug:</span></span><br><span class="line">      <span class="attr">msg:</span> <span class="string">&quot;<span class="template-variable">&#123;&#123; &#x27;123456&#x27; | hash(&#x27;blowfish&#x27;) &#125;&#125;</span>&quot;</span></span><br><span class="line">  <span class="comment">#使用sha256算法对字符串进行哈希,哈希过程中会生成随机&quot;盐&quot;,以便无法直接对比出原值</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">debug:</span></span><br><span class="line">      <span class="attr">msg:</span> <span class="string">&quot;<span class="template-variable">&#123;&#123; &#x27;123456&#x27; | password_hash(&#x27;sha256&#x27;) &#125;&#125;</span>&quot;</span></span><br><span class="line">  <span class="comment">#使用sha256算法对字符串进行哈希,并使用指定的字符串作为&quot;盐&quot;</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">debug:</span></span><br><span class="line">      <span class="attr">msg:</span> <span class="string">&quot;<span class="template-variable">&#123;&#123; &#x27;123456&#x27; | password_hash(&#x27;sha256&#x27;,&#x27;mysalt&#x27;) &#125;&#125;</span>&quot;</span></span><br><span class="line">  <span class="comment">#使用sha512算法对字符串进行哈希,哈希过程中会生成随机&quot;盐&quot;,以便无法直接对比出原值</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">debug:</span></span><br><span class="line">      <span class="attr">msg:</span> <span class="string">&quot;<span class="template-variable">&#123;&#123; &#x27;123123&#x27; | password_hash(&#x27;sha512&#x27;) &#125;&#125;</span>&quot;</span></span><br><span class="line">  <span class="comment">#使用sha512算法对字符串进行哈希,并使用指定的字符串作为&quot;盐&quot;</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">debug:</span></span><br><span class="line">      <span class="attr">msg:</span> <span class="string">&quot;<span class="template-variable">&#123;&#123; &#x27;123123&#x27; | password_hash(&#x27;sha512&#x27;,&#x27;ebzL.U5cjaHe55KK&#x27;) &#125;&#125;</span>&quot;</span></span><br><span class="line">  <span class="comment">#如下方法可以幂等的为每个主机的密码生成对应哈希串</span></span><br><span class="line">  <span class="comment">#有了之前总结的过滤器用法作为基础,你一定已经看懂了</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">debug:</span></span><br><span class="line">      <span class="attr">msg:</span> <span class="string">&quot;<span class="template-variable">&#123;&#123; &#x27;123123&#x27; | password_hash(&#x27;sha512&#x27;, 65534|random(seed=inventory_hostname)|string) &#125;&#125;</span>&quot;</span></span><br></pre></td></tr></table></figure></li>
</ul>
<h3 id="2021-07-15-lookup插件"><a href="#2021-07-15-lookup插件" class="headerlink" title="2021-07-15 lookup插件"></a>2021-07-15 lookup插件</h3><p>1,ansible中有很多种类的插件,比如之前总结的”tests”,也是插件的一种,ansible官网总结了各个插件的作用,并且将这些插件按照功能进行了分类</p>
<ul>
<li><a target="_blank" rel="noopener" href="https://docs.ansible.com/ansible/latest/plugins/plugins.html">https://docs.ansible.com/ansible/latest/plugins/plugins.html</a></li>
</ul>
<p>2,前文总结的”循环”在本质上也是一种插件,这种插件叫做”lookup插件”,先回忆一些”循环”的使用方法,以便能够更好的描述”循环”和”lookup插件”之间的关系</p>
<ul>
<li>列表示例如下:<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="bullet">-</span> <span class="attr">hosts:</span> <span class="string">node2</span></span><br><span class="line">  <span class="attr">remote_user:</span> <span class="string">root</span></span><br><span class="line">  <span class="attr">gather_facts:</span> <span class="literal">no</span></span><br><span class="line">  <span class="attr">tasks:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">debug:</span></span><br><span class="line">      <span class="attr">msg:</span> <span class="string">&quot;index is <span class="template-variable">&#123;&#123;item.0&#125;&#125;</span> , value is <span class="template-variable">&#123;&#123;item.1&#125;&#125;</span>&quot;</span></span><br><span class="line">    <span class="attr">with_indexed_items:</span> [<span class="string">&#x27;a&#x27;</span>,<span class="string">&#x27;b&#x27;</span>,<span class="string">&#x27;c&#x27;</span>]</span><br><span class="line"><span class="comment"># 等价于</span></span><br><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="bullet">-</span> <span class="attr">hosts:</span> <span class="string">node2</span></span><br><span class="line">  <span class="attr">remote_user:</span> <span class="string">root</span></span><br><span class="line">  <span class="attr">gather_facts:</span> <span class="literal">no</span></span><br><span class="line">  <span class="attr">tasks:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">debug:</span></span><br><span class="line">      <span class="attr">msg:</span> <span class="string">&quot;index is <span class="template-variable">&#123;&#123;item.0&#125;&#125;</span> , value is <span class="template-variable">&#123;&#123;item.1&#125;&#125;</span>&quot;</span></span><br><span class="line">    <span class="attr">loop:</span> <span class="string">&quot;<span class="template-variable">&#123;&#123; lookup(&#x27;indexed_items&#x27;,[&#x27;a&#x27;,&#x27;b&#x27;,&#x27;c&#x27;]) &#125;&#125;</span>&quot;</span></span><br><span class="line"><span class="comment"># 第一个示例使用”with_indexed_items关键字”处理列表</span></span><br><span class="line"><span class="comment"># 第二个示例使用”loop关键字”配合”lookup插件”处理列表</span></span><br><span class="line"><span class="comment"># 上例中,”lookup(‘indexed_items&#x27;,[‘a&#x27;,&#x27;b&#x27;,&#x27;c&#x27;])” 这段代码就是在使用lookup插件,含义是,使用名为&#x27;indexed_items&#x27;的lookup插件处理[‘a&#x27;,&#x27;b&#x27;,&#x27;c&#x27;]这个列表,&#x27;indexed_items&#x27;就是一个lookup插件</span></span><br></pre></td></tr></table></figure></li>
<li>字典示例如下:<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="bullet">-</span> <span class="attr">hosts:</span> <span class="string">node2</span></span><br><span class="line">  <span class="attr">remote_user:</span> <span class="string">root</span></span><br><span class="line">  <span class="attr">gather_facts:</span> <span class="literal">no</span></span><br><span class="line">  <span class="attr">vars:</span></span><br><span class="line">    <span class="attr">users:</span></span><br><span class="line">      <span class="attr">alice:</span> <span class="string">female</span></span><br><span class="line">      <span class="attr">bob:</span> <span class="string">male</span></span><br><span class="line">  <span class="attr">tasks:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">debug:</span></span><br><span class="line">      <span class="attr">msg:</span> <span class="string">&quot;<span class="template-variable">&#123;&#123;item.key&#125;&#125;</span> is <span class="template-variable">&#123;&#123;item.value&#125;&#125;</span>&quot;</span></span><br><span class="line">    <span class="attr">with_dict:</span> <span class="string">&quot;<span class="template-variable">&#123;&#123; users &#125;&#125;</span>&quot;</span></span><br><span class="line"><span class="comment"># 等价于</span></span><br><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="bullet">-</span> <span class="attr">hosts:</span> <span class="string">node2</span></span><br><span class="line">  <span class="attr">remote_user:</span> <span class="string">root</span></span><br><span class="line">  <span class="attr">gather_facts:</span> <span class="literal">no</span></span><br><span class="line">  <span class="attr">vars:</span></span><br><span class="line">    <span class="attr">users:</span></span><br><span class="line">      <span class="attr">alice:</span> <span class="string">female</span></span><br><span class="line">      <span class="attr">bob:</span> <span class="string">male</span></span><br><span class="line">  <span class="attr">tasks:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">debug:</span></span><br><span class="line">      <span class="attr">msg:</span> <span class="string">&quot;<span class="template-variable">&#123;&#123;item.key&#125;&#125;</span> is <span class="template-variable">&#123;&#123;item.value&#125;&#125;</span>&quot;</span></span><br><span class="line">    <span class="attr">loop:</span> <span class="string">&quot;<span class="template-variable">&#123;&#123; lookup(&#x27;dict&#x27;,users) &#125;&#125;</span>&quot;</span></span><br><span class="line"><span class="comment"># 第一个示例使用”with_dict关键字”处理users字典变量</span></span><br><span class="line"><span class="comment"># 第二个示例使用”loop关键字”配合”lookup插件”处理users字典变量</span></span><br><span class="line"><span class="comment"># 上例中,”lookup(‘dict&#x27;,users)”表示使用名为&#x27;dict&#x27;的lookup插件处理users字典变量,&#x27;dict&#x27;也是一个lookup插件</span></span><br></pre></td></tr></table></figure></li>
</ul>
<p>3,lookup插件的用法</p>
<ul>
<li>lookup(‘插件名’,被处理数据或参数)</li>
<li>以”with_”开头的循环实际上就是”with_”和”lookup()”的组合,lookup插件可以作为循环的数据源</li>
</ul>
<p>4,查看插件的帮助命令</p>
<ul>
<li>查看有哪些lookup插件可以使用: ansible-doc -t lookup -l(”-t”选项用于指定插件类型,”-l”选项表示列出列表)</li>
<li>单独查看某个插件的使用方法,比如dict插件的使用方法: ansible-doc -t lookup dict</li>
<li>file插件可以获取到指定文件的文件内容（注:文件位于ansible主机中）,示例如下<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="bullet">-</span> <span class="attr">hosts:</span> <span class="string">node2</span></span><br><span class="line">  <span class="attr">remote_user:</span> <span class="string">root</span></span><br><span class="line">  <span class="attr">gather_facts:</span> <span class="literal">no</span></span><br><span class="line">  <span class="attr">tasks:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">debug:</span></span><br><span class="line">      <span class="attr">msg:</span> <span class="string">&quot;<span class="template-variable">&#123;&#123; lookup(&#x27;file&#x27;,&#x27;/testdir/testfile&#x27;) &#125;&#125;</span>&quot;</span></span><br><span class="line"><span class="comment"># 如果想要获取多个文件中的内容,则可以传入多个文件路径,示例如下</span></span><br><span class="line">      <span class="attr">msg:</span> <span class="string">&quot;<span class="template-variable">&#123;&#123; lookup(&#x27;file&#x27;,&#x27;/testdir/testfile&#x27;,&#x27;/testdir/testfile1&#x27;) &#125;&#125;</span>&quot;</span></span><br><span class="line"><span class="comment"># file插件获得多个文件中的内容时,会将多个文件中的内容放置在一个字符串中,并用”逗号”隔开每个文件中的内容</span></span><br><span class="line"><span class="comment"># 想要获得一个字符串列表,将每个文件的内容当做列表中的一个独立的字符串</span></span><br><span class="line">      <span class="attr">msg:</span> <span class="string">&quot;<span class="template-variable">&#123;&#123; lookup(&#x27;file&#x27;,&#x27;/testdir/testfile&#x27;,&#x27;/testdir/testfile1&#x27;,wantlist=true) &#125;&#125;</span>&quot;</span></span><br></pre></td></tr></table></figure></li>
</ul>
<p>5,其他lookup插件用法示例</p>
<ul>
<li>示例如下:<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="bullet">-</span> <span class="attr">hosts:</span> <span class="string">node2</span></span><br><span class="line">  <span class="attr">remote_user:</span> <span class="string">root</span></span><br><span class="line">  <span class="attr">gather_facts:</span> <span class="literal">no</span></span><br><span class="line">  <span class="attr">tasks:</span></span><br><span class="line">  <span class="comment">#file插件可以获取ansible主机中指定文件的内容</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">debug:</span></span><br><span class="line">      <span class="attr">msg:</span> <span class="string">&quot;<span class="template-variable">&#123;&#123; lookup(&#x27;file&#x27;,&#x27;/testdir/testfile&#x27;) &#125;&#125;</span>&quot;</span></span><br><span class="line">  <span class="comment">#env插件可以获取ansible主机中指定变量的值</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">debug:</span></span><br><span class="line">      <span class="attr">msg:</span> <span class="string">&quot;<span class="template-variable">&#123;&#123; lookup(&#x27;env&#x27;,&#x27;PATH&#x27;) &#125;&#125;</span>&quot;</span></span><br><span class="line">  <span class="comment">#first_found插件可以获取列表中第一个找到的文件</span></span><br><span class="line">  <span class="comment">#按照列表顺序在ansible主机中查找</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">debug:</span></span><br><span class="line">      <span class="attr">msg:</span> <span class="string">&quot;<span class="template-variable">&#123;&#123; lookup(&#x27;first_found&#x27;,looklist) &#125;&#125;</span>&quot;</span></span><br><span class="line">    <span class="attr">vars:</span></span><br><span class="line">      <span class="attr">looklist:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="string">/testdir</span></span><br><span class="line">        <span class="bullet">-</span> <span class="string">/tmp/staging</span></span><br><span class="line">  <span class="comment">#当使用with_first_found时,可以在列表的最后添加- skip: true</span></span><br><span class="line">  <span class="comment">#表示如果列表中的所有文件都没有找到,则跳过当前任务,不会报错</span></span><br><span class="line">  <span class="comment">#当不确定有文件能够被匹配到时,推荐这种方式</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">debug:</span></span><br><span class="line">      <span class="attr">msg:</span> <span class="string">&quot;<span class="template-variable">&#123;&#123;item&#125;&#125;</span>&quot;</span></span><br><span class="line">    <span class="attr">with_first_found:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">/testdir1</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">/tmp/staging</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">skip:</span> <span class="literal">true</span></span><br><span class="line">  <span class="comment">#ini插件可以在ansible主机中的ini文件中查找对应key的值</span></span><br><span class="line">  <span class="comment">#如下示例表示从test.ini文件中的testA段落中查找testa1对应的值</span></span><br><span class="line">  <span class="comment">#测试文件/testdir/test.ini的内容如下(不包含注释符#号)</span></span><br><span class="line">  <span class="comment">#[testA]</span></span><br><span class="line">  <span class="comment">#testa1=Andy</span></span><br><span class="line">  <span class="comment">#testa2=Armand</span></span><br><span class="line">  <span class="comment">#</span></span><br><span class="line">  <span class="comment">#[testB]</span></span><br><span class="line">  <span class="comment">#testb1=Ben</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">debug:</span></span><br><span class="line">      <span class="attr">msg:</span> <span class="string">&quot;<span class="template-variable">&#123;&#123; lookup(&#x27;ini&#x27;,&#x27;testa1 section=testA file=/testdir/test.ini&#x27;) &#125;&#125;</span>&quot;</span></span><br><span class="line">  <span class="comment">#当未找到对应key时,默认返回空字符串,如果想要指定返回值,可以使用default选项,如下</span></span><br><span class="line">  <span class="comment">#msg: &quot;&#123;&#123; lookup(&#x27;ini&#x27;,&#x27;test666 section=testA file=/testdir/test.ini default=notfound&#x27;) &#125;&#125;&quot;</span></span><br><span class="line">  <span class="comment">#可以使用正则表达式匹配对应的键名,需要设置re=true,表示开启正则支持,如下</span></span><br><span class="line">  <span class="comment">#msg: &quot;&#123;&#123; lookup(&#x27;ini&#x27;,&#x27;testa[12] section=testA file=/testdir/test.ini re=true&#x27;) &#125;&#125;&quot;</span></span><br><span class="line">  <span class="comment">#ini插件除了可以从ini类型的文件中查找对应key,也可以从properties类型的文件中查找key</span></span><br><span class="line">  <span class="comment">#默认在操作的文件类型为ini,可以使用type指定properties类型,如下例所示</span></span><br><span class="line">  <span class="comment">#如下示例中,application.properties文件内容如下(不包含注释符#号)</span></span><br><span class="line">  <span class="comment">#http.port=8080</span></span><br><span class="line">  <span class="comment">#redis.no=0</span></span><br><span class="line">  <span class="comment">#imageCode = 1,2,3</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">debug:</span></span><br><span class="line">      <span class="attr">msg:</span> <span class="string">&quot;<span class="template-variable">&#123;&#123; lookup(&#x27;ini&#x27;,&#x27;http.port type=properties file=/testdir/application.properties&#x27;) &#125;&#125;</span>&quot;</span></span><br><span class="line">  <span class="comment">#dig插件可以获取指定域名的IP地址</span></span><br><span class="line">  <span class="comment">#此插件依赖dnspython库,可使用pip安装pip install dnspython</span></span><br><span class="line">  <span class="comment">#如果域名使用了CDN,可能返回多个地址</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">debug:</span></span><br><span class="line">      <span class="attr">msg:</span> <span class="string">&quot;<span class="template-variable">&#123;&#123; lookup(&#x27;dig&#x27;,&#x27;www.baidu.com&#x27;,wantlist=true) &#125;&#125;</span>&quot;</span></span><br><span class="line">  <span class="comment">#password插件可以生成随机的密码并保存在指定文件中</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">debug:</span></span><br><span class="line">      <span class="attr">msg:</span> <span class="string">&quot;<span class="template-variable">&#123;&#123; lookup(&#x27;password&#x27;,&#x27;/tmp/testpasswdfile&#x27;) &#125;&#125;</span>&quot;</span></span><br><span class="line">  <span class="comment">#以上插件还有一些参数我们没有涉及到,而且也还有很多插件没有总结,等到用到对应的插件时,再行介绍吧</span></span><br><span class="line">  <span class="comment">#你也可以访问官网的lookup插件列表页面,查看各个插件的用法</span></span><br><span class="line">  <span class="comment">#https://docs.ansible.com/ansible/latest/plugins/lookup.html</span></span><br></pre></td></tr></table></figure>
<h3 id="2021-07-17-循环-八"><a href="#2021-07-17-循环-八" class="headerlink" title="2021-07-17 循环(八)"></a>2021-07-17 循环(八)</h3>1,在新版本的ansible中,官方推荐的循环的使用方式不同,在2.6推荐的方式为loop加lookup和loop加filter</li>
<li>loop的简单使用方式:<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="bullet">-</span> <span class="attr">hosts:</span> <span class="string">node2</span></span><br><span class="line">  <span class="attr">remote_user:</span> <span class="string">root</span></span><br><span class="line">  <span class="attr">gather_facts:</span> <span class="literal">no</span></span><br><span class="line">  <span class="attr">tasks:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">debug:</span></span><br><span class="line">      <span class="attr">msg:</span> <span class="string">&quot;<span class="template-variable">&#123;&#123; item &#125;&#125;</span>&quot;</span></span><br><span class="line">    <span class="attr">loop:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">teststr1</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">teststr2</span></span><br></pre></td></tr></table></figure></li>
<li>loop加lookup插件替换with_X<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="bullet">-</span> <span class="attr">hosts:</span> <span class="string">node2</span></span><br><span class="line">  <span class="attr">remote_user:</span> <span class="string">root</span></span><br><span class="line">  <span class="attr">gather_facts:</span> <span class="literal">no</span></span><br><span class="line">  <span class="attr">vars:</span></span><br><span class="line">    <span class="attr">users:</span></span><br><span class="line">      <span class="attr">alice:</span> <span class="string">female</span></span><br><span class="line">      <span class="attr">bob:</span> <span class="string">male</span></span><br><span class="line">  <span class="attr">tasks:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">debug:</span></span><br><span class="line">      <span class="attr">msg:</span> <span class="string">&quot;<span class="template-variable">&#123;&#123;item.key&#125;&#125;</span> is <span class="template-variable">&#123;&#123;item.value&#125;&#125;</span>&quot;</span></span><br><span class="line">    <span class="attr">loop:</span> <span class="string">&quot;<span class="template-variable">&#123;&#123; lookup(&#x27;dict&#x27;,users) &#125;&#125;</span>&quot;</span></span><br></pre></td></tr></table></figure></li>
</ul>
<p>2,在2.6版本开始,官方开始推荐使用”loop加filter”的方式来替代”loop加lookup”的方式</p>
<ul>
<li>示例如下:<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="bullet">-</span> <span class="attr">hosts:</span> <span class="string">node2</span></span><br><span class="line">  <span class="attr">remote_user:</span> <span class="string">root</span></span><br><span class="line">  <span class="attr">gather_facts:</span> <span class="literal">no</span></span><br><span class="line">  <span class="attr">vars:</span></span><br><span class="line">    <span class="attr">users:</span></span><br><span class="line">      <span class="attr">alice:</span> <span class="string">female</span></span><br><span class="line">      <span class="attr">bob:</span> <span class="string">male</span></span><br><span class="line">  <span class="attr">tasks:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">debug:</span></span><br><span class="line">      <span class="attr">msg:</span> <span class="string">&quot;<span class="template-variable">&#123;&#123;item.key&#125;&#125;</span> is <span class="template-variable">&#123;&#123;item.value&#125;&#125;</span>&quot;</span></span><br><span class="line">    <span class="attr">loop:</span> <span class="string">&quot;<span class="template-variable">&#123;&#123; users | dict2items &#125;&#125;</span>&quot;</span></span><br><span class="line"><span class="comment"># users是一个字典格式的变量,它的结构是这样的</span></span><br><span class="line"><span class="comment">#     users:</span></span><br><span class="line"><span class="comment">#       alice: female</span></span><br><span class="line"><span class="comment">#       bob: male</span></span><br><span class="line"><span class="comment"># 当users字典被dict2items转换处理以后,会变成如下模样</span></span><br><span class="line"><span class="comment">#     users:</span></span><br><span class="line"><span class="comment">#     - key: alice</span></span><br><span class="line"><span class="comment">#       value: female</span></span><br><span class="line"><span class="comment">#     - key: bob</span></span><br><span class="line"><span class="comment">#       value: male</span></span><br></pre></td></tr></table></figure></li>
</ul>
<p>3,无论是”with_X”、”loop加lookup”还是”loop加filter”,都是使用不同的方式,实现相同的功能而已</p>
<p>4,替换方式</p>
<ul>
<li>with_list<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="comment">#loop可以替代with_list,当处理嵌套的列表时,列表不会被拉平</span></span><br><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="bullet">-</span> <span class="attr">hosts:</span> <span class="string">node2</span></span><br><span class="line">  <span class="attr">remote_user:</span> <span class="string">root</span></span><br><span class="line">  <span class="attr">gather_facts:</span> <span class="literal">no</span></span><br><span class="line">  <span class="attr">vars:</span></span><br><span class="line">    <span class="attr">testlist:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">a</span></span><br><span class="line">    <span class="bullet">-</span> [<span class="string">b</span>,<span class="string">c</span>]</span><br><span class="line">    <span class="bullet">-</span> <span class="string">d</span></span><br><span class="line">  <span class="attr">tasks:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">debug:</span></span><br><span class="line">      <span class="attr">msg:</span> <span class="string">&quot;<span class="template-variable">&#123;&#123;item&#125;&#125;</span>&quot;</span></span><br><span class="line">    <span class="attr">loop:</span> <span class="string">&quot;<span class="template-variable">&#123;&#123;testlist&#125;&#125;</span>&quot;</span></span><br></pre></td></tr></table></figure></li>
<li>with_flattened<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#flatten过滤器可以替代with_flattened,当处理多层嵌套的列表时,列表中所有的嵌套层级都会被拉平</span></span><br><span class="line"><span class="comment">#示例如下,flatten过滤器的用法在前文中已经总结过,此处不再赘述</span></span><br><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="bullet">-</span> <span class="attr">hosts:</span> <span class="string">node2</span></span><br><span class="line">  <span class="attr">remote_user:</span> <span class="string">root</span></span><br><span class="line">  <span class="attr">gather_facts:</span> <span class="literal">no</span></span><br><span class="line">  <span class="attr">vars:</span></span><br><span class="line">    <span class="attr">testlist:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">a</span></span><br><span class="line">    <span class="bullet">-</span> [<span class="string">b</span>,<span class="string">c</span>]</span><br><span class="line">    <span class="bullet">-</span> <span class="string">d</span></span><br><span class="line">  <span class="attr">tasks:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">debug:</span></span><br><span class="line">      <span class="attr">msg:</span> <span class="string">&quot;<span class="template-variable">&#123;&#123;item&#125;&#125;</span>&quot;</span></span><br><span class="line">    <span class="attr">loop:</span> <span class="string">&quot;<span class="template-variable">&#123;&#123;testlist | flatten&#125;&#125;</span>&quot;</span></span><br></pre></td></tr></table></figure></li>
<li>with_items<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#flatten过滤器（加参数）可以替代with_items,当处理多层嵌套的列表时,只有列表中的第一层会被拉平</span></span><br><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="bullet">-</span> <span class="attr">hosts:</span> <span class="string">node2</span></span><br><span class="line">  <span class="attr">remote_user:</span> <span class="string">root</span></span><br><span class="line">  <span class="attr">gather_facts:</span> <span class="literal">no</span></span><br><span class="line">  <span class="attr">vars:</span></span><br><span class="line">    <span class="attr">testlist:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">a</span></span><br><span class="line">    <span class="bullet">-</span> [<span class="string">b</span>,<span class="string">c</span>]</span><br><span class="line">    <span class="bullet">-</span> <span class="string">d</span></span><br><span class="line">  <span class="attr">tasks:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">debug:</span></span><br><span class="line">      <span class="attr">msg:</span> <span class="string">&quot;<span class="template-variable">&#123;&#123;item&#125;&#125;</span>&quot;</span></span><br><span class="line">    <span class="attr">loop:</span> <span class="string">&quot;<span class="template-variable">&#123;&#123;testlist | flatten(levels=1)&#125;&#125;</span>&quot;</span></span><br></pre></td></tr></table></figure></li>
<li>with_indexed_items<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#flatten过滤器（加参数）,再配合loop_control关键字,可以替代with_indexed_items</span></span><br><span class="line"><span class="comment">#当处理多层嵌套的列表时,只有列表中的第一层会被拉平,flatten过滤器的bug暂且忽略</span></span><br><span class="line"><span class="comment">#示例如下,之后会对示例进行解释</span></span><br><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="bullet">-</span> <span class="attr">hosts:</span> <span class="string">node2</span></span><br><span class="line">  <span class="attr">remote_user:</span> <span class="string">root</span></span><br><span class="line">  <span class="attr">gather_facts:</span> <span class="literal">no</span></span><br><span class="line">  <span class="attr">vars:</span></span><br><span class="line">    <span class="attr">testlist:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">a</span></span><br><span class="line">    <span class="bullet">-</span> [<span class="string">b</span>,<span class="string">c</span>]</span><br><span class="line">    <span class="bullet">-</span> <span class="string">d</span></span><br><span class="line">  <span class="attr">tasks:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">debug:</span></span><br><span class="line">      <span class="attr">msg:</span> <span class="string">&quot;<span class="template-variable">&#123;&#123;index&#125;&#125;</span>--<span class="template-variable">&#123;&#123;item&#125;&#125;</span>&quot;</span></span><br><span class="line">    <span class="attr">loop:</span> <span class="string">&quot;<span class="template-variable">&#123;&#123;testlist | flatten(levels=1)&#125;&#125;</span>&quot;</span></span><br><span class="line">    <span class="attr">loop_control:</span></span><br><span class="line">      <span class="attr">index_var:</span> <span class="string">index</span></span><br><span class="line"><span class="comment"># &quot;loop_control&quot;关键字可以用于控制循环的行为,比如在循环时获取到元素的索引.</span></span><br><span class="line"><span class="comment"># &quot;index_var&quot;是&quot;loop_control&quot;的一个设置选项,&quot;index_var&quot;的作用是让我们指定一个变量,&quot;loop_control&quot;会将列表元素的索引值存放到这个指定的变量中,比如如下配置</span></span><br><span class="line">  <span class="attr">loop_control:</span></span><br><span class="line">    <span class="attr">index_var:</span> <span class="string">my_idx</span></span><br><span class="line"><span class="comment"># 上述设置表示,在遍历列表时,当前被遍历元素的索引会被放置到&quot;my_idx&quot;变量中,也就是说,当进行循环操作时,只要获取到&quot;my_idx&quot;变量的值,就能获取到当前元素的索引值</span></span><br><span class="line"><span class="comment"># loop_control还有其他的选项可以使用,当前暂时不列举</span></span><br></pre></td></tr></table></figure></li>
<li>with_together<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#zip_longest过滤器配合list过滤器,可以替代with_together</span></span><br><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="bullet">-</span> <span class="attr">hosts:</span> <span class="string">node2</span></span><br><span class="line">  <span class="attr">remote_user:</span> <span class="string">root</span></span><br><span class="line">  <span class="attr">gather_facts:</span> <span class="literal">no</span></span><br><span class="line">  <span class="attr">vars:</span></span><br><span class="line">    <span class="attr">testlist1:</span> [ <span class="string">a</span>, <span class="string">b</span> ]</span><br><span class="line">    <span class="attr">testlist2:</span> [ <span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span> ]</span><br><span class="line">    <span class="attr">testlist3:</span> [ <span class="string">A</span>, <span class="string">B</span>, <span class="string">C</span>, <span class="string">D</span> ]</span><br><span class="line">  <span class="attr">tasks:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">debug:</span></span><br><span class="line">      <span class="attr">msg:</span> <span class="string">&quot;<span class="template-variable">&#123;&#123; item.0 &#125;&#125;</span> - <span class="template-variable">&#123;&#123; item.1 &#125;&#125;</span> - <span class="template-variable">&#123;&#123;item.2&#125;&#125;</span>&quot;</span></span><br><span class="line">    <span class="attr">with_together:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">&quot;<span class="template-variable">&#123;&#123;testlist1&#125;&#125;</span>&quot;</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">&quot;<span class="template-variable">&#123;&#123;testlist2&#125;&#125;</span>&quot;</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">&quot;<span class="template-variable">&#123;&#123;testlist3&#125;&#125;</span>&quot;</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">debug:</span></span><br><span class="line">      <span class="attr">msg:</span> <span class="string">&quot;<span class="template-variable">&#123;&#123; item.0 &#125;&#125;</span> - <span class="template-variable">&#123;&#123; item.1 &#125;&#125;</span> - <span class="template-variable">&#123;&#123;item.2&#125;&#125;</span>&quot;</span></span><br><span class="line">    <span class="attr">loop:</span> <span class="string">&quot;<span class="template-variable">&#123;&#123; testlist1 | zip_longest(testlist2,testlist3) | list &#125;&#125;</span>&quot;</span></span><br></pre></td></tr></table></figure></li>
<li>with_nested&#x2F;with_cartesian<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#product过滤器配合list过滤器,可以替代with_nested和with_cartesian</span></span><br><span class="line"><span class="comment">#如果你忘了with_nested和with_cartesian的用法,可以回顾前文</span></span><br><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="bullet">-</span> <span class="attr">hosts:</span> <span class="string">node2</span></span><br><span class="line">  <span class="attr">remote_user:</span> <span class="string">root</span></span><br><span class="line">  <span class="attr">gather_facts:</span> <span class="literal">no</span></span><br><span class="line">  <span class="attr">vars:</span></span><br><span class="line">    <span class="attr">testlist1:</span> [ <span class="string">a</span>, <span class="string">b</span>, <span class="string">c</span> ]</span><br><span class="line">    <span class="attr">testlist2:</span> [ <span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>, <span class="number">4</span> ]</span><br><span class="line">  <span class="attr">tasks:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">debug:</span></span><br><span class="line">      <span class="attr">msg:</span> <span class="string">&quot;<span class="template-variable">&#123;&#123; item.0 &#125;&#125;</span>--<span class="template-variable">&#123;&#123; item.1 &#125;&#125;</span>&quot;</span></span><br><span class="line">    <span class="attr">loop:</span> <span class="string">&quot;<span class="template-variable">&#123;&#123; testlist1 | product(testlist2) | list &#125;&#125;</span>&quot;</span></span><br></pre></td></tr></table></figure></li>
<li>with_sequence<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#range过滤器配合list过滤器可以代替with_sequence</span></span><br><span class="line"><span class="comment">#你可以先回顾一下with_sequence的用法,然后再测试如下示例</span></span><br><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="bullet">-</span> <span class="attr">hosts:</span> <span class="string">node2</span></span><br><span class="line">  <span class="attr">remote_user:</span> <span class="string">root</span></span><br><span class="line">  <span class="attr">gather_facts:</span> <span class="literal">no</span></span><br><span class="line">  <span class="attr">tasks:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">debug:</span></span><br><span class="line">      <span class="attr">msg:</span> <span class="string">&quot;<span class="template-variable">&#123;&#123;item&#125;&#125;</span>&quot;</span></span><br><span class="line">    <span class="attr">loop:</span> <span class="string">&quot;<span class="template-variable">&#123;&#123; range(0, 6, 2) | list &#125;&#125;</span>&quot;</span></span><br><span class="line"><span class="comment"># 需要格式化功能时:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">debug:</span></span><br><span class="line">      <span class="attr">msg:</span> <span class="string">&quot;<span class="template-variable">&#123;&#123; &#x27;number is %0.2f&#x27; | format(item) &#125;&#125;</span>&quot;</span></span><br><span class="line">    <span class="attr">loop:</span> <span class="string">&quot;<span class="template-variable">&#123;&#123; range(2, 7, 2) | list &#125;&#125;</span>&quot;</span></span><br></pre></td></tr></table></figure></li>
<li>with_random_choice<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#使用random函数可以替代with_random_choice,由于random函数是随机取出列表中的一个值,并不涉及循环操作,所以并不用使用loop关键字.</span></span><br><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="bullet">-</span> <span class="attr">hosts:</span> <span class="string">node2</span></span><br><span class="line">  <span class="attr">remote_user:</span> <span class="string">root</span></span><br><span class="line">  <span class="attr">gather_facts:</span> <span class="literal">no</span></span><br><span class="line">  <span class="attr">vars:</span></span><br><span class="line">    <span class="attr">testlist:</span> [ <span class="string">a</span>, <span class="string">b</span>, <span class="string">c</span> ]</span><br><span class="line">  <span class="attr">tasks:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">debug:</span></span><br><span class="line">      <span class="attr">msg:</span> <span class="string">&quot;<span class="template-variable">&#123;&#123; testlist | random &#125;&#125;</span>&quot;</span></span><br></pre></td></tr></table></figure></li>
<li>with_dict<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#除了上文总结的dict2items过滤器,dictsort过滤器也可以替代with_dict</span></span><br><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="bullet">-</span> <span class="attr">hosts:</span> <span class="string">node2</span></span><br><span class="line">  <span class="attr">remote_user:</span> <span class="string">root</span></span><br><span class="line">  <span class="attr">gather_facts:</span> <span class="literal">no</span></span><br><span class="line">  <span class="attr">vars:</span></span><br><span class="line">    <span class="attr">users:</span></span><br><span class="line">      <span class="attr">d:</span> <span class="string">daisy</span></span><br><span class="line">      <span class="attr">c:</span> <span class="string">carol</span></span><br><span class="line">      <span class="attr">a:</span> <span class="string">alice</span></span><br><span class="line">      <span class="attr">b:</span> <span class="string">bob</span></span><br><span class="line">      <span class="attr">e:</span> <span class="string">ella</span></span><br><span class="line">  <span class="attr">tasks:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">debug:</span></span><br><span class="line">      <span class="attr">msg:</span> <span class="string">&quot;<span class="template-variable">&#123;&#123;item.key&#125;&#125;</span> -- <span class="template-variable">&#123;&#123;item.value&#125;&#125;</span>&quot;</span></span><br><span class="line">    <span class="attr">loop:</span> <span class="string">&quot;<span class="template-variable">&#123;&#123; users | dict2items &#125;&#125;</span>&quot;</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">debug:</span></span><br><span class="line">      <span class="attr">msg:</span> <span class="string">&quot;<span class="template-variable">&#123;&#123;item.0&#125;&#125;</span> -- <span class="template-variable">&#123;&#123;item.1&#125;&#125;</span>&quot;</span></span><br><span class="line">    <span class="attr">loop:</span> <span class="string">&quot;<span class="template-variable">&#123;&#123; users | dictsort &#125;&#125;</span>&quot;</span></span><br></pre></td></tr></table></figure></li>
<li>with_subelements<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#subelements过滤器可以替代with_subelements</span></span><br><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="bullet">-</span> <span class="attr">hosts:</span> <span class="string">node2</span></span><br><span class="line">  <span class="attr">remote_user:</span> <span class="string">root</span></span><br><span class="line">  <span class="attr">gather_facts:</span> <span class="literal">no</span></span><br><span class="line">  <span class="attr">vars:</span></span><br><span class="line">    <span class="attr">users:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">bob</span></span><br><span class="line">      <span class="attr">gender:</span> <span class="string">male</span></span><br><span class="line">      <span class="attr">hobby:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="string">Skateboard</span></span><br><span class="line">        <span class="bullet">-</span> <span class="string">VideoGame</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">alice</span></span><br><span class="line">      <span class="attr">gender:</span> <span class="string">female</span></span><br><span class="line">      <span class="attr">hobby:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="string">Music</span></span><br><span class="line">  <span class="attr">tasks:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">debug:</span></span><br><span class="line">      <span class="attr">msg:</span> <span class="string">&quot;<span class="template-variable">&#123;&#123;item.0.name&#125;&#125;</span>&#x27;s hobby is <span class="template-variable">&#123;&#123;item.1&#125;&#125;</span>&quot;</span></span><br><span class="line">    <span class="attr">with_subelements:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">&quot;<span class="template-variable">&#123;&#123;users&#125;&#125;</span>&quot;</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">hobby</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">debug:</span></span><br><span class="line">      <span class="attr">msg:</span> <span class="string">&quot;<span class="template-variable">&#123;&#123;item.0.name&#125;&#125;</span>&#x27;s hobby is <span class="template-variable">&#123;&#123;item.1&#125;&#125;</span>&quot;</span></span><br><span class="line">    <span class="attr">loop:</span> <span class="string">&quot;<span class="template-variable">&#123;&#123;users | subelements(&#x27;hobby&#x27;)&#125;&#125;</span>&quot;</span></span><br></pre></td></tr></table></figure></li>
</ul>
<p>5,loop_control的其他参数使用</p>
<ul>
<li>pause选项<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="bullet">-</span> <span class="attr">hosts:</span> <span class="string">node2</span></span><br><span class="line">  <span class="attr">remote_user:</span> <span class="string">root</span></span><br><span class="line">  <span class="attr">gather_facts:</span> <span class="literal">no</span></span><br><span class="line">  <span class="attr">tasks:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">debug:</span></span><br><span class="line">      <span class="attr">msg:</span> <span class="string">&quot;<span class="template-variable">&#123;&#123;item&#125;&#125;</span>&quot;</span></span><br><span class="line">    <span class="attr">loop:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="number">1</span></span><br><span class="line">    <span class="bullet">-</span> <span class="number">2</span></span><br><span class="line">    <span class="bullet">-</span> <span class="number">3</span></span><br><span class="line">    <span class="attr">loop_control:</span></span><br><span class="line">      <span class="attr">pause:</span> <span class="number">10</span></span><br><span class="line"><span class="comment"># 上例表示每次循环之间间隔10秒</span></span><br></pre></td></tr></table></figure></li>
<li>label<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="bullet">-</span> <span class="attr">hosts:</span> <span class="string">node2</span></span><br><span class="line">  <span class="attr">remote_user:</span> <span class="string">root</span></span><br><span class="line">  <span class="attr">gather_facts:</span> <span class="literal">no</span></span><br><span class="line">  <span class="attr">vars:</span></span><br><span class="line">    <span class="attr">users:</span></span><br><span class="line">      <span class="attr">alice:</span></span><br><span class="line">        <span class="attr">name:</span> <span class="string">Alice</span> <span class="string">Appleworth</span></span><br><span class="line">        <span class="attr">gender:</span> <span class="string">female</span></span><br><span class="line">        <span class="attr">telephone:</span> <span class="number">123</span><span class="number">-456</span><span class="number">-7890</span></span><br><span class="line">      <span class="attr">bob:</span></span><br><span class="line">        <span class="attr">name:</span> <span class="string">Bob</span> <span class="string">Bananarama</span></span><br><span class="line">        <span class="attr">gender:</span> <span class="string">male</span></span><br><span class="line">        <span class="attr">telephone:</span> <span class="number">987</span><span class="number">-654</span><span class="number">-3210</span></span><br><span class="line">  <span class="attr">tasks:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">debug:</span></span><br><span class="line">      <span class="attr">msg:</span> <span class="string">&quot;<span class="template-variable">&#123;&#123;item.key&#125;&#125;</span>&quot;</span></span><br><span class="line">    <span class="attr">loop:</span> <span class="string">&quot;<span class="template-variable">&#123;&#123;users | dict2items&#125;&#125;</span>&quot;</span></span><br><span class="line"><span class="comment"># 此处输出内容太多,对于需要查找的内容较难找到</span></span><br><span class="line"><span class="comment"># label选项的作用,它可以在循环输出信息时,简化输出item的信息</span></span><br><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="bullet">-</span> <span class="attr">hosts:</span> <span class="string">node2</span></span><br><span class="line">  <span class="attr">remote_user:</span> <span class="string">root</span></span><br><span class="line">  <span class="attr">gather_facts:</span> <span class="literal">no</span></span><br><span class="line">  <span class="attr">vars:</span></span><br><span class="line">    <span class="attr">users:</span></span><br><span class="line">      <span class="attr">alice:</span></span><br><span class="line">        <span class="attr">name:</span> <span class="string">Alice</span> <span class="string">Appleworth</span></span><br><span class="line">        <span class="attr">gender:</span> <span class="string">female</span></span><br><span class="line">        <span class="attr">telephone:</span> <span class="number">123</span><span class="number">-456</span><span class="number">-7890</span></span><br><span class="line">      <span class="attr">bob:</span></span><br><span class="line">        <span class="attr">name:</span> <span class="string">Bob</span> <span class="string">Bananarama</span></span><br><span class="line">        <span class="attr">gender:</span> <span class="string">male</span></span><br><span class="line">        <span class="attr">telephone:</span> <span class="number">987</span><span class="number">-654</span><span class="number">-3210</span></span><br><span class="line">  <span class="attr">tasks:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">debug:</span></span><br><span class="line">      <span class="attr">msg:</span> <span class="string">&quot;<span class="template-variable">&#123;&#123;item.key&#125;&#125;</span>&quot;</span></span><br><span class="line">    <span class="attr">loop:</span> <span class="string">&quot;<span class="template-variable">&#123;&#123;users | dict2items&#125;&#125;</span>&quot;</span></span><br><span class="line">    <span class="attr">loop_control:</span></span><br><span class="line">      <span class="attr">label:</span> <span class="string">&quot;<span class="template-variable">&#123;&#123;item.key&#125;&#125;</span>&quot;</span></span><br></pre></td></tr></table></figure>
<h3 id="2021-07-17-include"><a href="#2021-07-17-include" class="headerlink" title="2021-07-17 include"></a>2021-07-17 include</h3>1,ansible中有类似编程语言中类似函数调用的功能,就是include,通过include,可以在一个playbook中包含另一个文件</li>
<li>include模块可以指定一个文件,这个文件中的内容是一个任务列表（一个或多个任务）,使用include模块引用对应的文件时,文件中的任务会在被引用处执行,就像写在被引用处一样<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># cat lamp.yml</span></span><br><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="bullet">-</span> <span class="attr">hosts:</span> <span class="string">node2</span></span><br><span class="line">  <span class="attr">remote_user:</span> <span class="string">root</span></span><br><span class="line">  <span class="attr">gather_facts:</span> <span class="literal">no</span></span><br><span class="line">  <span class="attr">tasks:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">include:</span> <span class="string">install_MysqlAndPhp.yml</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">yum:</span></span><br><span class="line">      <span class="attr">name:</span> <span class="string">httpd</span></span><br><span class="line">      <span class="attr">state:</span> <span class="string">present</span></span><br><span class="line"> </span><br><span class="line"><span class="comment"># cat lnmp.yml</span></span><br><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="bullet">-</span> <span class="attr">hosts:</span> <span class="string">node2</span></span><br><span class="line">  <span class="attr">remote_user:</span> <span class="string">root</span></span><br><span class="line">  <span class="attr">gather_facts:</span> <span class="literal">no</span></span><br><span class="line">  <span class="attr">tasks:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">include:</span> <span class="string">install_MysqlAndPhp.yml</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">yum:</span></span><br><span class="line">      <span class="attr">name:</span> <span class="string">nginx</span></span><br><span class="line">      <span class="attr">state:</span> <span class="string">present</span></span><br><span class="line"><span class="comment"># cat install_MysqlAndPhp.yml</span></span><br><span class="line"><span class="bullet">-</span> <span class="attr">yum:</span></span><br><span class="line">    <span class="attr">name:</span> <span class="string">mysql</span></span><br><span class="line">    <span class="attr">state:</span> <span class="string">present</span></span><br><span class="line"><span class="bullet">-</span> <span class="attr">yum:</span></span><br><span class="line">    <span class="attr">name:</span> <span class="string">php-fpm</span></span><br><span class="line">    <span class="attr">state:</span> <span class="string">present</span></span><br></pre></td></tr></table></figure></li>
</ul>
<p>2,在handlers关键字中,也可以使用include,handlers也是一种任务,只是这种任务有相应的触发条件而已</p>
<ul>
<li>如下示例:<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># cat test_include.yml</span></span><br><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="bullet">-</span> <span class="attr">hosts:</span> <span class="string">node2</span></span><br><span class="line">  <span class="attr">remote_user:</span> <span class="string">root</span></span><br><span class="line">  <span class="attr">gather_facts:</span> <span class="literal">no</span></span><br><span class="line">  <span class="attr">tasks:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">file:</span></span><br><span class="line">     <span class="attr">path:</span> <span class="string">/opt/ttt</span></span><br><span class="line">     <span class="attr">state:</span> <span class="string">touch</span></span><br><span class="line">    <span class="attr">notify:</span> <span class="string">test</span> <span class="string">include</span> <span class="string">handlers</span></span><br><span class="line"> </span><br><span class="line">  <span class="attr">handlers:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">test</span> <span class="string">include</span> <span class="string">handlers</span></span><br><span class="line">    <span class="attr">include:</span> <span class="string">include_handler.yml</span></span><br><span class="line"> </span><br><span class="line"><span class="comment"># cat include_handler.yml</span></span><br><span class="line"><span class="bullet">-</span> <span class="attr">debug:</span></span><br><span class="line">    <span class="attr">msg:</span> <span class="string">&quot;task1 of handlers&quot;</span></span><br><span class="line"><span class="bullet">-</span> <span class="attr">debug:</span></span><br><span class="line">    <span class="attr">msg:</span> <span class="string">&quot;task2 of handlers&quot;</span></span><br><span class="line"><span class="bullet">-</span> <span class="attr">debug:</span></span><br><span class="line">    <span class="attr">msg:</span> <span class="string">&quot;task3 of handlers&quot;</span></span><br></pre></td></tr></table></figure></li>
</ul>
<p>3,”include”不仅能够引用任务列表,还能够引用playbook,比如,在一个playbook中引用另一个playbook</p>
<ul>
<li>示例如下:<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># cat lamp.yml</span></span><br><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="bullet">-</span> <span class="attr">hosts:</span> <span class="string">node2</span></span><br><span class="line">  <span class="attr">remote_user:</span> <span class="string">root</span></span><br><span class="line">  <span class="attr">gather_facts:</span> <span class="literal">no</span></span><br><span class="line">  <span class="attr">tasks:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">include:</span> <span class="string">install_MysqlAndPhp.yml</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">yum:</span></span><br><span class="line">      <span class="attr">name:</span> <span class="string">httpd</span></span><br><span class="line">      <span class="attr">state:</span> <span class="string">present</span></span><br><span class="line"> </span><br><span class="line"><span class="bullet">-</span> <span class="attr">include:</span> <span class="string">lnmp.yml</span></span><br><span class="line"><span class="comment"># 在lamp.yml的结尾引入了lnmp.yml,当我们在执行lamp.yml时,会先执行lamp相关的任务,然后再执行lnmp.yml中的任务.</span></span><br></pre></td></tr></table></figure></li>
</ul>
<p>4,include还可以接受一些参数</p>
<ul>
<li>如下所示<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># cat test_include1.yml</span></span><br><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="bullet">-</span> <span class="attr">hosts:</span> <span class="string">node2</span></span><br><span class="line">  <span class="attr">remote_user:</span> <span class="string">root</span></span><br><span class="line">  <span class="attr">gather_facts:</span> <span class="literal">no</span></span><br><span class="line">  <span class="attr">tasks:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">include:</span> <span class="string">in.yml</span></span><br><span class="line">     <span class="string">test_var1=hello</span></span><br><span class="line">     <span class="string">test_var2=test</span></span><br><span class="line"> </span><br><span class="line"><span class="comment"># cat in.yml</span></span><br><span class="line"><span class="bullet">-</span> <span class="attr">debug:</span></span><br><span class="line">    <span class="attr">msg:</span> <span class="string">&quot;<span class="template-variable">&#123;&#123; test_var1 &#125;&#125;</span>&quot;</span></span><br><span class="line"><span class="bullet">-</span> <span class="attr">debug:</span></span><br><span class="line">    <span class="attr">msg:</span> <span class="string">&quot;<span class="template-variable">&#123;&#123; test_var2 &#125;&#125;</span>&quot;</span></span><br></pre></td></tr></table></figure></li>
<li>还能够使用vars关键字,以key: value变量的方式传入参数变量<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">tasks:</span></span><br><span class="line"><span class="bullet">-</span> <span class="attr">include:</span> <span class="string">in.yml</span></span><br><span class="line">  <span class="attr">vars:</span></span><br><span class="line">   <span class="attr">test_var1:</span> <span class="string">hello</span></span><br><span class="line">   <span class="attr">test_var2:</span> <span class="string">test</span></span><br></pre></td></tr></table></figure></li>
<li>通过vars关键字也能够传入结构稍微复杂的变量数据,以便在包含的文件中使用,示例如下:<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># cat test_include1.yml</span></span><br><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="bullet">-</span> <span class="attr">hosts:</span> <span class="string">node2</span></span><br><span class="line">  <span class="attr">remote_user:</span> <span class="string">root</span></span><br><span class="line">  <span class="attr">gather_facts:</span> <span class="literal">no</span></span><br><span class="line">  <span class="attr">tasks:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">include:</span> <span class="string">in.yml</span></span><br><span class="line">    <span class="attr">vars:</span></span><br><span class="line">     <span class="attr">users:</span></span><br><span class="line">      <span class="attr">bob:</span></span><br><span class="line">        <span class="attr">gender:</span> <span class="string">male</span></span><br><span class="line">      <span class="attr">lucy:</span></span><br><span class="line">        <span class="attr">gender:</span> <span class="string">female</span></span><br><span class="line">         </span><br><span class="line"><span class="comment"># cat in.yml</span></span><br><span class="line"><span class="bullet">-</span> <span class="attr">debug:</span></span><br><span class="line">    <span class="attr">msg:</span> <span class="string">&quot;<span class="template-variable">&#123;&#123; item.key&#125;&#125;</span> is <span class="template-variable">&#123;&#123; item.value.gender &#125;&#125;</span>&quot;</span></span><br><span class="line">  <span class="attr">loop:</span> <span class="string">&quot;<span class="template-variable">&#123;&#123; users | dict2items &#125;&#125;</span>&quot;</span></span><br></pre></td></tr></table></figure></li>
</ul>
<p>5,可以针对某个include去打标签</p>
<ul>
<li>如下示例:<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># cat test_include1.yml</span></span><br><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="bullet">-</span> <span class="attr">hosts:</span> <span class="string">node2</span></span><br><span class="line">  <span class="attr">remote_user:</span> <span class="string">root</span></span><br><span class="line">  <span class="attr">gather_facts:</span> <span class="literal">no</span></span><br><span class="line">  <span class="attr">tasks:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">include:</span> <span class="string">in1.yml</span></span><br><span class="line">    <span class="attr">tags:</span> <span class="string">t1</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">include:</span> <span class="string">in2.yml</span></span><br><span class="line">    <span class="attr">tags:</span> <span class="string">t2</span></span><br><span class="line"> </span><br><span class="line"><span class="comment"># cat in1.yml</span></span><br><span class="line"><span class="bullet">-</span> <span class="attr">debug:</span></span><br><span class="line">    <span class="attr">msg:</span> <span class="string">&quot;task1 in in1.yml&quot;</span></span><br><span class="line"><span class="bullet">-</span> <span class="attr">debug:</span></span><br><span class="line">    <span class="attr">msg:</span> <span class="string">&quot;task2 in in1.yml&quot;</span></span><br><span class="line"> </span><br><span class="line"><span class="comment"># cat in2.yml</span></span><br><span class="line"><span class="bullet">-</span> <span class="attr">debug:</span></span><br><span class="line">    <span class="attr">msg:</span> <span class="string">&quot;task1 in in2.yml&quot;</span></span><br><span class="line"><span class="bullet">-</span> <span class="attr">debug:</span></span><br><span class="line">    <span class="attr">msg:</span> <span class="string">&quot;task2 in in2.yml&quot;</span></span><br></pre></td></tr></table></figure></li>
<li>可以对include添加条件判断,还可以对include进行循环操作<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># cat test_include1.yml</span></span><br><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="bullet">-</span> <span class="attr">hosts:</span> <span class="string">node2</span></span><br><span class="line">  <span class="attr">remote_user:</span> <span class="string">root</span></span><br><span class="line">  <span class="attr">gather_facts:</span> <span class="literal">no</span></span><br><span class="line">  <span class="attr">tasks:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">include:</span> <span class="string">in3.yml</span></span><br><span class="line">    <span class="attr">when:</span> <span class="number">2</span> <span class="string">&gt;</span> <span class="number">1</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">include:</span> <span class="string">in3.yml</span></span><br><span class="line">    <span class="attr">loop:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="number">1</span></span><br><span class="line">    <span class="bullet">-</span> <span class="number">2</span></span><br><span class="line">    <span class="bullet">-</span> <span class="number">3</span></span><br><span class="line"> </span><br><span class="line"><span class="comment"># cat in3.yml</span></span><br><span class="line"><span class="bullet">-</span> <span class="attr">debug:</span></span><br><span class="line">    <span class="attr">msg:</span> <span class="string">&quot;task1 in in3.yml&quot;</span></span><br><span class="line"><span class="bullet">-</span> <span class="attr">debug:</span></span><br><span class="line">    <span class="attr">msg:</span> <span class="string">&quot;task2 in in3.yml&quot;</span></span><br><span class="line"><span class="comment"># 循环的调用多个任务,可以使用上例中的方法,将需要循环调用的多个任务写入到一个yml文件中,然后使用include调用这个yml文件,再配合loop进行循环即可</span></span><br></pre></td></tr></table></figure></li>
</ul>
<p>6,loop_control中loop_var的使用</p>
<ul>
<li>如下示例:<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># cat A.yml</span></span><br><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="bullet">-</span> <span class="attr">hosts:</span> <span class="string">node2</span></span><br><span class="line">  <span class="attr">remote_user:</span> <span class="string">root</span></span><br><span class="line">  <span class="attr">gather_facts:</span> <span class="literal">no</span></span><br><span class="line">  <span class="attr">tasks:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">include:</span> <span class="string">B.yml</span></span><br><span class="line">    <span class="attr">loop:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="number">1</span></span><br><span class="line">    <span class="bullet">-</span> <span class="number">2</span></span><br><span class="line"> </span><br><span class="line"><span class="comment"># cat B.yml</span></span><br><span class="line"><span class="bullet">-</span> <span class="attr">debug:</span></span><br><span class="line">    <span class="attr">msg:</span> <span class="string">&quot;<span class="template-variable">&#123;&#123;item&#125;&#125;</span>--task in B.yml&quot;</span></span><br><span class="line">  <span class="attr">loop:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">a</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">b</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">c</span></span><br><span class="line"><span class="comment"># B.yml中循环调用了debug模块,而在A.yml中,又循环的调用了B.yml,当出现这种&quot;双层循环&quot;的情况时,B文件中的item信息只打印B中的列表内容</span></span><br></pre></td></tr></table></figure></li>
<li>若要获取上例中外层item的值,可以使用loop_control中loop_var选项<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># cat A.yml</span></span><br><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="bullet">-</span> <span class="attr">hosts:</span> <span class="string">node2</span></span><br><span class="line">  <span class="attr">remote_user:</span> <span class="string">root</span></span><br><span class="line">  <span class="attr">gather_facts:</span> <span class="literal">no</span></span><br><span class="line">  <span class="attr">tasks:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">include:</span> <span class="string">B.yml</span></span><br><span class="line">    <span class="attr">loop:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="number">1</span></span><br><span class="line">    <span class="bullet">-</span> <span class="number">2</span></span><br><span class="line">    <span class="attr">loop_control:</span></span><br><span class="line">      <span class="attr">loop_var:</span> <span class="string">outer_item</span></span><br><span class="line"> </span><br><span class="line"><span class="comment"># cat B.yml</span></span><br><span class="line"><span class="bullet">-</span> <span class="attr">debug:</span></span><br><span class="line">    <span class="attr">msg:</span> <span class="string">&quot;<span class="template-variable">&#123;&#123;outer_item&#125;&#125;</span>--<span class="template-variable">&#123;&#123;item&#125;&#125;</span>--task in B.yml&quot;</span></span><br><span class="line">  <span class="attr">loop:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">a</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">b</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">c</span></span><br><span class="line"><span class="comment"># 将loop_var选项的值设置为&quot;outer_item&quot;,这表示,我们将外层循环的item值存放在了&quot;outer_item&quot;变量中,在B文件中的debug任务中,同时输出了&quot;outer_item&quot;变量和&quot;item&quot;变量的值</span></span><br></pre></td></tr></table></figure>
<h3 id="2021-07-17-include-二"><a href="#2021-07-17-include-二" class="headerlink" title="2021-07-17 include(二)"></a>2021-07-17 include(二)</h3>1,”include”的某些原始用法在之后的版本中可能会被弃用,在之后的版本中,会使用一些新的关键字代替这些原始用法</li>
</ul>
<p>2,include_task模块</p>
<ul>
<li>include模块可以用来包含一个任务列表,include_tasks模块的作用也是用来包含一个任务列表,在之后的版本中,如果我们想要包含一个任务列表,那么就可以使用”include_tasks”关键字代替”include”关键字,示例如下:<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># cat intest.yml</span></span><br><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="bullet">-</span> <span class="attr">hosts:</span> <span class="string">node2</span></span><br><span class="line">  <span class="attr">remote_user:</span> <span class="string">root</span></span><br><span class="line">  <span class="attr">gather_facts:</span> <span class="literal">no</span></span><br><span class="line">  <span class="attr">tasks:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">debug:</span></span><br><span class="line">      <span class="attr">msg:</span> <span class="string">&quot;test task1&quot;</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">include_tasks:</span> <span class="string">in.yml</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">debug:</span></span><br><span class="line">      <span class="attr">msg:</span> <span class="string">&quot;test task2&quot;</span></span><br><span class="line"> </span><br><span class="line"><span class="comment"># cat in.yml</span></span><br><span class="line"><span class="bullet">-</span> <span class="attr">debug:</span></span><br><span class="line">    <span class="attr">msg:</span> <span class="string">&quot;task1 in in.yml&quot;</span></span><br><span class="line"><span class="bullet">-</span> <span class="attr">debug:</span></span><br><span class="line">    <span class="attr">msg:</span> <span class="string">&quot;task2 in in.yml&quot;</span></span><br><span class="line"><span class="comment"># 当我们使用&quot;include_tasks&quot;时,&quot;include_tasks&quot;本身会被当做一个&quot;task&quot;,这个&quot;task&quot;会把被include的文件的路径输出在控制台中</span></span><br><span class="line"><span class="comment"># &quot;include&quot;是透明的,&quot;include_tasks&quot;是可见的,&quot;include_tasks&quot;更像是一个任务,这个任务包含了其他的一些任务</span></span><br></pre></td></tr></table></figure></li>
</ul>
<p>3,在2.7版本之后,include_tasks模块加入了file和apply参数</p>
<ul>
<li>file参数<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">  <span class="bullet">-</span> <span class="attr">include_tasks:</span></span><br><span class="line">      <span class="attr">file:</span> <span class="string">in.yml</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">include_tasks:</span> <span class="string">in.yml</span></span><br><span class="line"><span class="comment"># 两种方式其实完全相同,只不过一个使用了&quot;file&quot;参数的方式,另一个使用了&quot;free_form&quot;的方式,虽然语法上不同,但是本质上没有区别</span></span><br></pre></td></tr></table></figure></li>
<li>apply参数<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># cat intest.yml</span></span><br><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="bullet">-</span> <span class="attr">hosts:</span> <span class="string">node2</span></span><br><span class="line">  <span class="attr">remote_user:</span> <span class="string">root</span></span><br><span class="line">  <span class="attr">gather_facts:</span> <span class="literal">no</span></span><br><span class="line">  <span class="attr">tasks:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">debug:</span></span><br><span class="line">      <span class="attr">msg:</span> <span class="string">&quot;test task1&quot;</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">include_tasks:</span></span><br><span class="line">      <span class="attr">file:</span> <span class="string">in.yml</span></span><br><span class="line">    <span class="attr">tags:</span> <span class="string">t1</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">debug:</span></span><br><span class="line">      <span class="attr">msg:</span> <span class="string">&quot;test task2&quot;</span></span><br><span class="line"><span class="comment"># &quot;include_tasks&quot;这个任务本身被调用了,而&quot;include_tasks&quot;对应文件中的任务却没有被调用</span></span><br><span class="line"><span class="comment"># &quot;include_tasks&quot;与&quot;include&quot;并不相同,标签只会对&quot;include_tasks&quot;任务本身生效,而不会对其中包含的任务生效</span></span><br><span class="line"><span class="comment"># 如果想要tags对&quot;include_tasks&quot;中包含的所有任务都生效,需要使用到&quot;include_tasks&quot;模块的apply参数</span></span><br><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="bullet">-</span> <span class="attr">hosts:</span> <span class="string">node2</span></span><br><span class="line">  <span class="attr">remote_user:</span> <span class="string">root</span></span><br><span class="line">  <span class="attr">gather_facts:</span> <span class="literal">no</span></span><br><span class="line">  <span class="attr">tasks:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">include_tasks:</span></span><br><span class="line">      <span class="attr">file:</span> <span class="string">in.yml</span></span><br><span class="line">      <span class="attr">apply:</span></span><br><span class="line">        <span class="attr">tags:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="string">t1</span></span><br><span class="line"><span class="comment"># 但如上写法并未按预期执行,连include_tasks都没有执行,需要完成预期内容,需要如下配置</span></span><br><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="bullet">-</span> <span class="attr">hosts:</span> <span class="string">node2</span></span><br><span class="line">  <span class="attr">remote_user:</span> <span class="string">root</span></span><br><span class="line">  <span class="attr">gather_facts:</span> <span class="literal">no</span></span><br><span class="line">  <span class="attr">tasks:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">include_tasks:</span></span><br><span class="line">      <span class="attr">file:</span> <span class="string">in.yml</span></span><br><span class="line">      <span class="attr">apply:</span></span><br><span class="line">        <span class="attr">tags:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="string">t1</span></span><br><span class="line">    <span class="attr">tags:</span> <span class="string">always</span></span><br><span class="line"><span class="comment"># 在使用&quot;include_tasks&quot;时,不仅使用apply参数指定了tags,同时还使用tags关键字,对&quot;include_tasks&quot;本身添加了always标签</span></span><br></pre></td></tr></table></figure></li>
</ul>
<p>4,import_tasks</p>
<ul>
<li>如果想要包含引用一个任务列表,也可以使用”import_tasks”关键字<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># cat intest1.yml</span></span><br><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="bullet">-</span> <span class="attr">hosts:</span> <span class="string">node2</span></span><br><span class="line">  <span class="attr">remote_user:</span> <span class="string">root</span></span><br><span class="line">  <span class="attr">gather_facts:</span> <span class="literal">no</span></span><br><span class="line">  <span class="attr">tasks:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">debug:</span></span><br><span class="line">      <span class="attr">msg:</span> <span class="string">&quot;test task&quot;</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">import_tasks:</span> <span class="string">in.yml</span></span><br><span class="line"> </span><br><span class="line"><span class="comment"># cat in.yml</span></span><br><span class="line"><span class="bullet">-</span> <span class="attr">debug:</span></span><br><span class="line">    <span class="attr">msg:</span> <span class="string">&quot;task1 in in.yml&quot;</span></span><br><span class="line"><span class="bullet">-</span> <span class="attr">debug:</span></span><br><span class="line">    <span class="attr">msg:</span> <span class="string">&quot;task2 in in.yml&quot;</span></span><br><span class="line"><span class="comment"># &quot;import_tasks&quot;模块并不会像&quot;include_tasks&quot;模块那样,在控制台中输出相关的任务信息,&quot;import_tasks&quot;是相对透明的</span></span><br></pre></td></tr></table></figure></li>
<li>“import_tasks”是静态的,”include_tasks”是动态的<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># &quot;静态&quot;的意思就是被include的文件在playbook被加载时就展开了（是预处理的）.</span></span><br><span class="line"><span class="comment"># &quot;动态&quot;的意思就是被include的文件在playbook运行时才会被展开（是实时处理的）.</span></span><br><span class="line"><span class="comment"># 由于&quot;include_tasks&quot;是动态的,所以,被include的文件的文件名可以使用任何变量替换.</span></span><br><span class="line"><span class="comment"># 由于&quot;import_tasks&quot;是静态的,所以,被include的文件的文件名不能使用动态的变量替换.</span></span><br><span class="line"><span class="comment"># cat intest3.yml</span></span><br><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="bullet">-</span> <span class="attr">hosts:</span> <span class="string">node2</span></span><br><span class="line">  <span class="attr">remote_user:</span> <span class="string">root</span></span><br><span class="line">  <span class="attr">gather_facts:</span> <span class="literal">no</span></span><br><span class="line">  <span class="attr">vars:</span></span><br><span class="line">    <span class="attr">file_name:</span> <span class="string">in.yml</span></span><br><span class="line">  <span class="attr">tasks:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">import_tasks:</span> <span class="string">&quot;<span class="template-variable">&#123;&#123;file_name&#125;&#125;</span>&quot;</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">include_tasks:</span> <span class="string">&quot;<span class="template-variable">&#123;&#123;file_name&#125;&#125;</span>&quot;</span></span><br><span class="line"><span class="comment"># 上述内容可以正常执行</span></span><br><span class="line"><span class="comment"># cat intest3.yml</span></span><br><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="bullet">-</span> <span class="attr">hosts:</span> <span class="string">node2</span></span><br><span class="line">  <span class="attr">remote_user:</span> <span class="string">root</span></span><br><span class="line">  <span class="attr">gather_facts:</span> <span class="literal">no</span></span><br><span class="line">  <span class="attr">tasks:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">set_fact:</span></span><br><span class="line">      <span class="attr">file_name:</span> <span class="string">in.yml</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">import_tasks:</span> <span class="string">&quot;<span class="template-variable">&#123;&#123;file_name&#125;&#125;</span>&quot;</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">include_tasks:</span> <span class="string">&quot;<span class="template-variable">&#123;&#123;file_name&#125;&#125;</span>&quot;</span></span><br><span class="line"><span class="comment"># 上述内容执行报错</span></span><br><span class="line"><span class="comment"># 当使用静态的import时,请确保文件名中使用到的变量被定义在vars中、vars_files中、或者extra-vars中,静态的import不支持其他方式传入的变量</span></span><br></pre></td></tr></table></figure></li>
<li>如果想要对包含的任务列表进行循环操作,则只能使用”include_tasks”关键字,不能使用”import_tasks”关键字,”import_tasks”并不支持循环操作,使用”loop”关键字或”with_items”关键字对include文件进行循环操作时,只能配合”include_tasks”才能正常运行</li>
<li>使用when做条件判断执行include_tasks和import_tasks时,区别很大<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 当对&quot;include_tasks&quot;使用when进行条件判断时,when对应的条件只会应用于&quot;include_tasks&quot;任务本身,当执行被包含的任务时,不会对这些被包含的任务重新进行条件判断.</span></span><br><span class="line"><span class="comment"># 当对&quot;import_tasks&quot;使用when进行条件判断时,when对应的条件会应用于被include的文件中的每一个任务,当执行被包含的任务时,会对每一个被包含的任务进行同样的条件判断.</span></span><br><span class="line"><span class="comment"># cat intest4.yml</span></span><br><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="bullet">-</span> <span class="attr">hosts:</span> <span class="string">node2</span></span><br><span class="line">  <span class="attr">remote_user:</span> <span class="string">root</span></span><br><span class="line">  <span class="attr">gather_facts:</span> <span class="literal">no</span></span><br><span class="line">  <span class="attr">tasks:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">&#x27;----------set testvar to 0&#x27;</span></span><br><span class="line">    <span class="attr">set_fact:</span></span><br><span class="line">      <span class="attr">testnum:</span> <span class="number">0</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">debug:</span></span><br><span class="line">      <span class="attr">msg:</span> <span class="string">&#x27;-----include_tasks-----enter the in1.yml-----&#x27;</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">include_tasks:</span> <span class="string">in1.yml</span></span><br><span class="line">    <span class="attr">when:</span> <span class="string">testnum</span> <span class="string">==</span> <span class="number">0</span></span><br><span class="line"> </span><br><span class="line">  <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">&#x27;----------set testvar to 0&#x27;</span></span><br><span class="line">    <span class="attr">set_fact:</span></span><br><span class="line">      <span class="attr">testnum:</span> <span class="number">0</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">debug:</span></span><br><span class="line">      <span class="attr">msg:</span> <span class="string">&#x27;-----import_tasks-----enter the in1.yml-----&#x27;</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">import_tasks:</span> <span class="string">in1.yml</span></span><br><span class="line">    <span class="attr">when:</span> <span class="string">testnum</span> <span class="string">==</span> <span class="number">0</span></span><br><span class="line"> </span><br><span class="line"><span class="comment"># cat in1.yml</span></span><br><span class="line"><span class="bullet">-</span> <span class="attr">set_fact:</span></span><br><span class="line">    <span class="attr">testnum:</span> <span class="number">1</span></span><br><span class="line"> </span><br><span class="line"><span class="bullet">-</span> <span class="attr">debug:</span></span><br><span class="line">    <span class="attr">msg:</span> <span class="string">&quot;task1 in in1.yml&quot;</span></span><br><span class="line"><span class="comment"># 输出内容如下:</span></span><br><span class="line"><span class="string">PLAY</span> [<span class="string">node2</span>] <span class="string">xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx</span></span><br><span class="line"> </span><br><span class="line"><span class="string">TASK</span> [<span class="string">----------set</span> <span class="string">testvar</span> <span class="string">to</span> <span class="number">0</span>] <span class="string">xxxxxxxxxxxxxxxxxxxxxxxxxxxxxx</span></span><br><span class="line"><span class="attr">ok:</span> [<span class="string">node2</span>]</span><br><span class="line"> </span><br><span class="line"><span class="string">TASK</span> [<span class="string">debug</span>] <span class="string">xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx</span></span><br><span class="line"><span class="attr">ok:</span> [<span class="string">node2</span>] <span class="string">=&gt;</span> &#123;</span><br><span class="line">    <span class="attr">&quot;msg&quot;:</span> <span class="string">&quot;-----include_tasks-----enter the in1.yml-----&quot;</span></span><br><span class="line">&#125;</span><br><span class="line"> </span><br><span class="line"><span class="string">TASK</span> [<span class="string">include_tasks</span>] <span class="string">xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx</span></span><br><span class="line"><span class="attr">included:</span> <span class="string">/testdir/ansible/in1.yml</span> <span class="string">for</span> <span class="string">node2</span></span><br><span class="line"> </span><br><span class="line"><span class="string">TASK</span> [<span class="string">set_fact</span>] <span class="string">xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx</span></span><br><span class="line"><span class="attr">ok:</span> [<span class="string">node2</span>]</span><br><span class="line"> </span><br><span class="line"><span class="string">TASK</span> [<span class="string">debug</span>] <span class="string">xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx</span></span><br><span class="line"><span class="attr">ok:</span> [<span class="string">node2</span>] <span class="string">=&gt;</span> &#123;</span><br><span class="line">    <span class="attr">&quot;msg&quot;:</span> <span class="string">&quot;task1 in in1.yml&quot;</span></span><br><span class="line">&#125;</span><br><span class="line"> </span><br><span class="line"><span class="string">TASK</span> [<span class="string">----------set</span> <span class="string">testvar</span> <span class="string">to</span> <span class="number">0</span>] <span class="string">xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx</span></span><br><span class="line"><span class="attr">ok:</span> [<span class="string">node2</span>]</span><br><span class="line"> </span><br><span class="line"><span class="string">TASK</span> [<span class="string">debug</span>] <span class="string">xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx</span></span><br><span class="line"><span class="attr">ok:</span> [<span class="string">node2</span>] <span class="string">=&gt;</span> &#123;</span><br><span class="line">    <span class="attr">&quot;msg&quot;:</span> <span class="string">&quot;-----import_tasks-----enter the in1.yml-----&quot;</span></span><br><span class="line">&#125;</span><br><span class="line"> </span><br><span class="line"><span class="string">TASK</span> [<span class="string">set_fact</span>] <span class="string">xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx</span></span><br><span class="line"><span class="attr">ok:</span> [<span class="string">node2</span>]</span><br><span class="line"> </span><br><span class="line"><span class="string">TASK</span> [<span class="string">debug</span>] <span class="string">xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx</span></span><br><span class="line"><span class="attr">skipping:</span> [<span class="string">node2</span>]</span><br><span class="line"> </span><br><span class="line"><span class="string">PLAY</span> <span class="string">RECAP</span> <span class="string">xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx</span></span><br><span class="line"><span class="attr">node2                     :</span> <span class="string">ok=8</span>    <span class="string">changed=0</span>    <span class="string">unreachable=0</span>    <span class="string">failed=0</span></span><br></pre></td></tr></table></figure></li>
<li>tags的使用,与”include_tasks”不同,当为”import_tasks”添加标签时,tags是针对被包含文件中的所有任务生效的,与”include”关键字的效果相同.</li>
<li>“include_tasks”与”import_tasks”都可以在handlers中使用,并没有什么不同<br>5,import_playbook<ul>
<li>使用”include”关键字除了能够引用任务列表,还能够引用整个playbook,在之后的版本中,如果想要引入整个playbook,则需要使用”import_playbook”模块代替”include”模块,因为在2.8版本以后,使用”include”关键字引用整个playbook的特性将会被弃用</li>
<li>示例如下:<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># cat intest6.yml</span></span><br><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="bullet">-</span> <span class="attr">hosts:</span> <span class="string">node2</span></span><br><span class="line">  <span class="attr">remote_user:</span> <span class="string">root</span></span><br><span class="line">  <span class="attr">gather_facts:</span> <span class="literal">no</span></span><br><span class="line">  <span class="attr">tasks:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">debug:</span></span><br><span class="line">      <span class="attr">msg:</span> <span class="string">&quot;test task in intest6.yml&quot;</span></span><br><span class="line"> </span><br><span class="line"><span class="bullet">-</span> <span class="attr">import_playbook:</span> <span class="string">intest7.yml</span></span><br><span class="line"> </span><br><span class="line"><span class="comment"># cat intest7.yml</span></span><br><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="bullet">-</span> <span class="attr">hosts:</span> <span class="string">node2</span></span><br><span class="line">  <span class="attr">remote_user:</span> <span class="string">root</span></span><br><span class="line">  <span class="attr">gather_facts:</span> <span class="literal">no</span></span><br><span class="line">  <span class="attr">tasks:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">debug:</span></span><br><span class="line">      <span class="attr">msg:</span> <span class="string">&quot;test task in intest7.yml&quot;</span></span><br></pre></td></tr></table></figure>
<h3 id="2021-07-17-jinja2模板-一"><a href="#2021-07-17-jinja2模板-一" class="headerlink" title="2021-07-17 jinja2模板(一)"></a>2021-07-17 jinja2模板(一)</h3>1,对远端机器进行操作时,很多场景下都需要根据主机信息进行配置,这个时候可以使用template模块来完成相应的目的</li>
<li>示例如下:<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># cat temptest.yml</span></span><br><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="bullet">-</span> <span class="attr">hosts:</span> <span class="string">node2</span></span><br><span class="line"> <span class="attr">remote_user:</span> <span class="string">root</span></span><br><span class="line"> <span class="attr">gather_facts:</span> <span class="literal">no</span></span><br><span class="line"> <span class="attr">tasks:</span></span><br><span class="line"> <span class="bullet">-</span> <span class="attr">yum:</span></span><br><span class="line">     <span class="attr">name:</span> <span class="string">redis</span></span><br><span class="line">     <span class="attr">state:</span> <span class="string">present</span></span><br><span class="line"> <span class="bullet">-</span> <span class="attr">template:</span></span><br><span class="line">     <span class="attr">src:</span> <span class="string">/testdir/ansible/redis.conf</span></span><br><span class="line">     <span class="attr">dest:</span> <span class="string">/etc/redis.conf</span></span><br><span class="line"><span class="comment"># cat /testdir/ansible/redis.conf,下列的ansible_host是host alias,需要注意</span></span><br><span class="line"><span class="string">......</span></span><br><span class="line"><span class="string">bind</span> &#123;&#123;<span class="string">ansible_host</span>&#125;&#125;</span><br><span class="line"><span class="string">......</span></span><br></pre></td></tr></table></figure></li>
<li>template还有其他的选项<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"># owner,group,mode(mode=0644,mode=u+x)</span><br><span class="line"># force参数: 当远程主机的目标路径中已经存在同名文件,并且与最终生成的文件内容不同时,是否强制覆盖,可选值有yes和no,默认值为yes,表示覆盖,如果设置为no,则不会执行覆盖拷贝操作,远程主机中的文件保持不变</span><br><span class="line"># backup参数: 当远程主机的目标路径中已经存在同名文件,并且与最终生成的文件内容不同时,是否对远程主机的文件进行备份,可选值有yes和no,当设置为yes时,会先备份远程主机中的文件,然后再将最终生成的文件拷贝到远程主机</span><br></pre></td></tr></table></figure></li>
</ul>
</li>
</ul>
<p>2,上述例子中使用的template模块渲染,使用的都是jinja2模板引擎</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">- \&#123;\&#123;      \&#125;\&#125;     :用来装载表达式,比如变量、运算表达式、比较表达式等.</span><br><span class="line">- \&#123;\%      \%\&#125;     :用来装载控制语句,比如 if 控制结构,for循环控制结构.</span><br><span class="line">- \&#123;\#      \#\&#125;     :用来装载注释,模板文件被渲染后,注释不会包含在最终生成的文件中.</span><br></pre></td></tr></table></figure>

<p>3,双花括号的使用</p>
<ul>
<li>变量的引用,如下示例:<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># ansible node2 -m template -e &quot;testvar1=teststr&quot; -a &quot;src=test.j2 dest=/opt/test&quot;</span></span><br><span class="line"><span class="comment"># cat test.j2</span></span><br><span class="line"><span class="built_in">test</span> jinja2 variable</span><br><span class="line"><span class="built_in">test</span> &#123;&#123; testvar1 &#125;&#125; <span class="built_in">test</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 输出内容如下:</span></span><br><span class="line"><span class="comment"># cat test</span></span><br><span class="line"><span class="built_in">test</span> jinja2 variable</span><br><span class="line"><span class="built_in">test</span> teststr tesT</span><br><span class="line"><span class="comment"># &quot;&#123;&#123;  &#125;&#125;&quot;中包含的就是一个变量,当模板被渲染后,变量的值被替换到了最终的配置文件中</span></span><br></pre></td></tr></table></figure></li>
<li>包含表达式,示例如下:<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">## 比较表达式:</span></span><br><span class="line"><span class="comment"># cat test.j2</span></span><br><span class="line">jinja2 <span class="built_in">test</span></span><br><span class="line">&#123;&#123; 1 == 1 &#125;&#125;</span><br><span class="line">&#123;&#123; 2 != 2 &#125;&#125;</span><br><span class="line">&#123;&#123; 2 &gt; 1 &#125;&#125;</span><br><span class="line">&#123;&#123; 2 &gt;= 1 &#125;&#125;</span><br><span class="line"> </span><br><span class="line">生成文件内容如下:</span><br><span class="line"><span class="comment"># cat test</span></span><br><span class="line">jinja2 <span class="built_in">test</span></span><br><span class="line">True</span><br><span class="line">False</span><br><span class="line">True</span><br><span class="line">True</span><br><span class="line"></span><br><span class="line"><span class="comment">## 逻辑运算:</span></span><br><span class="line"><span class="comment"># cat test.j2</span></span><br><span class="line">jinja2 <span class="built_in">test</span></span><br><span class="line">&#123;&#123; (2 &gt; 1) or (1 &gt; 2) &#125;&#125;</span><br><span class="line">&#123;&#123; (2 &gt; 1) and (1 &gt; 2) &#125;&#125;</span><br><span class="line"> </span><br><span class="line">&#123;&#123; not <span class="literal">true</span> &#125;&#125;</span><br><span class="line">&#123;&#123; not True &#125;&#125;</span><br><span class="line"> </span><br><span class="line"><span class="comment"># cat test</span></span><br><span class="line">jinja2 <span class="built_in">test</span></span><br><span class="line">True</span><br><span class="line">False</span><br><span class="line"> </span><br><span class="line">False</span><br><span class="line">False</span><br><span class="line"></span><br><span class="line"><span class="comment">## 算数运算:</span></span><br><span class="line"><span class="comment"># cat test.j2</span></span><br><span class="line">jinja2 <span class="built_in">test</span></span><br><span class="line">&#123;&#123; 3 + 2 &#125;&#125;</span><br><span class="line">&#123;&#123; 3 - 4 &#125;&#125;</span><br><span class="line">&#123;&#123; 3 * 5 &#125;&#125;</span><br><span class="line">&#123;&#123; 2 ** 3 &#125;&#125;</span><br><span class="line">&#123;&#123; 7 / 5 &#125;&#125;</span><br><span class="line">&#123;&#123; 7 // 5 &#125;&#125;</span><br><span class="line">&#123;&#123; 17 % 5 &#125;&#125;</span><br><span class="line"> </span><br><span class="line"><span class="comment"># cat test</span></span><br><span class="line">jinja2 <span class="built_in">test</span></span><br><span class="line">5</span><br><span class="line">-1</span><br><span class="line">15</span><br><span class="line">8</span><br><span class="line">1.4</span><br><span class="line">1</span><br><span class="line">2</span><br><span class="line"></span><br><span class="line"><span class="comment">## 成员运算:</span></span><br><span class="line"><span class="comment"># cat test.j2</span></span><br><span class="line">jinja2 <span class="built_in">test</span></span><br><span class="line">&#123;&#123; 1 <span class="keyword">in</span> [1,2,3,4] &#125;&#125;</span><br><span class="line">&#123;&#123; 1 not <span class="keyword">in</span> [1,2,3,4] &#125;&#125;</span><br><span class="line"> </span><br><span class="line"><span class="comment"># cat test</span></span><br><span class="line">jinja2 <span class="built_in">test</span></span><br><span class="line">True</span><br><span class="line">False</span><br><span class="line"></span><br><span class="line"><span class="comment">## 一些基础的数据类型,都可以包含在&quot;&#123;&#123;  &#125;&#125;&quot;中,jinja2本身就是基于python的模板引擎,所以,python的基础数据类型都可以包含在&quot;&#123;&#123;  &#125;&#125;&quot;中</span></span><br><span class="line"><span class="comment"># cat test.j2</span></span><br><span class="line">jinja2 <span class="built_in">test</span></span><br><span class="line"><span class="comment">### str</span></span><br><span class="line">&#123;&#123; <span class="string">&#x27;testString&#x27;</span> &#125;&#125;</span><br><span class="line">&#123;&#123; <span class="string">&quot;testString&quot;</span> &#125;&#125;</span><br><span class="line"><span class="comment">### num</span></span><br><span class="line">&#123;&#123; 15 &#125;&#125;</span><br><span class="line">&#123;&#123; 18.8 &#125;&#125;</span><br><span class="line"><span class="comment">### list</span></span><br><span class="line">&#123;&#123; [<span class="string">&#x27;Aa&#x27;</span>,<span class="string">&#x27;Bb&#x27;</span>,<span class="string">&#x27;Cc&#x27;</span>,<span class="string">&#x27;Dd&#x27;</span>] &#125;&#125;</span><br><span class="line">&#123;&#123; [<span class="string">&#x27;Aa&#x27;</span>,<span class="string">&#x27;Bb&#x27;</span>,<span class="string">&#x27;Cc&#x27;</span>,<span class="string">&#x27;Dd&#x27;</span>].1 &#125;&#125;</span><br><span class="line">&#123;&#123; [<span class="string">&#x27;Aa&#x27;</span>,<span class="string">&#x27;Bb&#x27;</span>,<span class="string">&#x27;Cc&#x27;</span>,<span class="string">&#x27;Dd&#x27;</span>][1] &#125;&#125;</span><br><span class="line"><span class="comment">### tuple</span></span><br><span class="line">&#123;&#123; (<span class="string">&#x27;Aa&#x27;</span>,<span class="string">&#x27;Bb&#x27;</span>,<span class="string">&#x27;Cc&#x27;</span>,<span class="string">&#x27;Dd&#x27;</span>) &#125;&#125;</span><br><span class="line">&#123;&#123; (<span class="string">&#x27;Aa&#x27;</span>,<span class="string">&#x27;Bb&#x27;</span>,<span class="string">&#x27;Cc&#x27;</span>,<span class="string">&#x27;Dd&#x27;</span>).0 &#125;&#125;</span><br><span class="line">&#123;&#123; (<span class="string">&#x27;Aa&#x27;</span>,<span class="string">&#x27;Bb&#x27;</span>,<span class="string">&#x27;Cc&#x27;</span>,<span class="string">&#x27;Dd&#x27;</span>)[0] &#125;&#125;</span><br><span class="line"><span class="comment">### dic</span></span><br><span class="line">&#123;&#123; &#123;<span class="string">&#x27;name&#x27;</span>:<span class="string">&#x27;bob&#x27;</span>,<span class="string">&#x27;age&#x27;</span>:18&#125; &#125;&#125;</span><br><span class="line">&#123;&#123; &#123;<span class="string">&#x27;name&#x27;</span>:<span class="string">&#x27;bob&#x27;</span>,<span class="string">&#x27;age&#x27;</span>:18&#125;.name &#125;&#125;</span><br><span class="line">&#123;&#123; &#123;<span class="string">&#x27;name&#x27;</span>:<span class="string">&#x27;bob&#x27;</span>,<span class="string">&#x27;age&#x27;</span>:18&#125;[<span class="string">&#x27;name&#x27;</span>] &#125;&#125;</span><br><span class="line"><span class="comment">### Boolean</span></span><br><span class="line">&#123;&#123; True &#125;&#125;</span><br><span class="line">&#123;&#123; <span class="literal">true</span> &#125;&#125;</span><br><span class="line">&#123;&#123; False &#125;&#125;</span><br><span class="line">&#123;&#123; <span class="literal">false</span> &#125;&#125;</span><br><span class="line"> </span><br><span class="line"> </span><br><span class="line">生成文件内容如下:</span><br><span class="line"><span class="comment"># cat test</span></span><br><span class="line">jinja2 <span class="built_in">test</span></span><br><span class="line"><span class="comment">### str</span></span><br><span class="line">testString</span><br><span class="line">testString</span><br><span class="line"><span class="comment">### num</span></span><br><span class="line">15</span><br><span class="line">18.8</span><br><span class="line"><span class="comment">### list</span></span><br><span class="line">[<span class="string">&#x27;Aa&#x27;</span>, <span class="string">&#x27;Bb&#x27;</span>, <span class="string">&#x27;Cc&#x27;</span>, <span class="string">&#x27;Dd&#x27;</span>]</span><br><span class="line">Bb</span><br><span class="line">Bb</span><br><span class="line"><span class="comment">### tuple</span></span><br><span class="line">(<span class="string">&#x27;Aa&#x27;</span>, <span class="string">&#x27;Bb&#x27;</span>, <span class="string">&#x27;Cc&#x27;</span>, <span class="string">&#x27;Dd&#x27;</span>)</span><br><span class="line">Aa</span><br><span class="line">Aa</span><br><span class="line"><span class="comment">### dic</span></span><br><span class="line">&#123;<span class="string">&#x27;age&#x27;</span>: 18, <span class="string">&#x27;name&#x27;</span>: <span class="string">&#x27;bob&#x27;</span>&#125;</span><br><span class="line">bob</span><br><span class="line">bob</span><br><span class="line"><span class="comment">### Boolean</span></span><br><span class="line">True</span><br><span class="line">True</span><br><span class="line">False</span><br><span class="line">False</span><br></pre></td></tr></table></figure></li>
<li>过滤器也可以在双花括号中使用<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># cat test.j2</span></span><br><span class="line">jinja2 <span class="built_in">test</span></span><br><span class="line">&#123;&#123; <span class="string">&#x27;abc&#x27;</span> | upper &#125;&#125;</span><br><span class="line"> </span><br><span class="line"> </span><br><span class="line">生成文件内容</span><br><span class="line"><span class="comment"># cat test</span></span><br><span class="line">jinja2 <span class="built_in">test</span></span><br><span class="line">ABC</span><br></pre></td></tr></table></figure></li>
<li>jinja2的tests自然也能够在”双花括号”中使用<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># cat test.j2</span></span><br><span class="line">jinja2 <span class="built_in">test</span></span><br><span class="line">&#123;&#123; testvar1 is defined &#125;&#125;</span><br><span class="line">&#123;&#123; testvar1 is undefined &#125;&#125;</span><br><span class="line">&#123;&#123; <span class="string">&#x27;/opt&#x27;</span> is exists &#125;&#125;</span><br><span class="line">&#123;&#123; <span class="string">&#x27;/opt&#x27;</span> is file &#125;&#125;</span><br><span class="line">&#123;&#123; <span class="string">&#x27;/opt&#x27;</span> is directory &#125;&#125;</span><br><span class="line"> </span><br><span class="line"><span class="comment"># ansible node2 -m template -e &quot;testvar1=1 testvar2=2&quot; -a &quot;src=test.j2 dest=/opt/test&quot;</span></span><br><span class="line"> </span><br><span class="line">生成文件内容</span><br><span class="line"><span class="comment"># cat test</span></span><br><span class="line">jinja2 <span class="built_in">test</span></span><br><span class="line">True</span><br><span class="line">False</span><br><span class="line">True</span><br><span class="line">False</span><br><span class="line">True</span><br></pre></td></tr></table></figure></li>
<li>lookup插件在双花括号中的使用<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># cat /testdir/ansible/test.j2</span></span><br><span class="line">jinja2 <span class="built_in">test</span></span><br><span class="line"> </span><br><span class="line">&#123;&#123; lookup(<span class="string">&#x27;file&#x27;</span>,<span class="string">&#x27;/testdir/testfile&#x27;</span>) &#125;&#125;</span><br><span class="line"> </span><br><span class="line">&#123;&#123; lookup(<span class="string">&#x27;env&#x27;</span>,<span class="string">&#x27;PATH&#x27;</span>) &#125;&#125;</span><br><span class="line"> </span><br><span class="line"><span class="built_in">test</span> jinja2</span><br><span class="line"> </span><br><span class="line"> </span><br><span class="line"><span class="comment"># ansible主机中的testfile内容如下</span></span><br><span class="line"><span class="comment"># cat /testdir/testfile</span></span><br><span class="line">testfile <span class="keyword">in</span> ansible</span><br><span class="line">These are <span class="keyword">for</span> testing purposes only</span><br><span class="line"> </span><br><span class="line"><span class="comment"># 生成文件内容如下</span></span><br><span class="line"><span class="comment"># cat test</span></span><br><span class="line">jinja2 <span class="built_in">test</span></span><br><span class="line"> </span><br><span class="line">testfile <span class="keyword">in</span> ansible</span><br><span class="line">These are <span class="keyword">for</span> testing purposes only</span><br><span class="line"> </span><br><span class="line">/usr/local/sbin:/usr/local/bin:/usr/sbin:/usr/bin:/root/bin</span><br><span class="line"> </span><br><span class="line"><span class="built_in">test</span> jinja2</span><br></pre></td></tr></table></figure></li>
</ul>
<p>3,的使用</p>
<ul>
<li>同编程语言中注释方式的使用<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># cat test.j2</span></span><br><span class="line">jinja2 <span class="built_in">test</span></span><br><span class="line">&#123;<span class="comment">#这是一行注释信息#&#125;</span></span><br><span class="line">jinja2 <span class="built_in">test</span></span><br><span class="line">&#123;<span class="comment">#</span></span><br><span class="line">这是多行注释信息,</span><br><span class="line">模板被渲染以后,</span><br><span class="line">最终的文件中不会包含这些信息</span><br><span class="line"><span class="comment">#&#125;</span></span><br><span class="line">jinja2 <span class="built_in">test</span></span><br><span class="line"> </span><br><span class="line"> </span><br><span class="line">生成文件内容如下:</span><br><span class="line"><span class="comment"># cat test</span></span><br><span class="line">jinja2 <span class="built_in">test</span></span><br><span class="line">jinja2 <span class="built_in">test</span></span><br><span class="line">jinja2 <span class="built_in">test</span></span><br></pre></td></tr></table></figure></li>
</ul>
<h3 id="2021-07-17-jinja2模板-二"><a href="#2021-07-17-jinja2模板-二" class="headerlink" title="2021-07-17 jinja2模板(二)"></a>2021-07-17 jinja2模板(二)</h3><p>1,结合if的使用</p>
<ul>
<li>通用结构<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">&#123;<span class="string">%</span> <span class="string">if</span> <span class="string">条件一</span> <span class="string">%</span>&#125;</span><br><span class="line"><span class="string">...</span></span><br><span class="line">&#123;<span class="string">%</span> <span class="string">elif</span> <span class="string">条件N</span> <span class="string">%</span>&#125;</span><br><span class="line"><span class="string">...</span></span><br><span class="line">&#123;<span class="string">%</span> <span class="string">else</span> <span class="string">%</span>&#125;</span><br><span class="line"><span class="string">...</span></span><br><span class="line">&#123;<span class="string">%</span> <span class="string">endif</span> <span class="string">%</span>&#125;</span><br></pre></td></tr></table></figure></li>
<li>三元运算<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># cat test.j2</span></span><br><span class="line">jinja2 <span class="built_in">test</span></span><br><span class="line">&#123;&#123; <span class="string">&#x27;a&#x27;</span> <span class="keyword">if</span> 2&gt;1 <span class="keyword">else</span> <span class="string">&#x27;b&#x27;</span> &#125;&#125;</span><br><span class="line"><span class="comment"># 输出内容如下:</span></span><br><span class="line"><span class="comment"># cat /opt/test</span></span><br><span class="line">jinja2 <span class="built_in">test</span></span><br><span class="line">a</span><br></pre></td></tr></table></figure></li>
</ul>
<p>2,使用set</p>
<ul>
<li>如下示例:<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># cat test.j2</span></span><br><span class="line">jinja2 <span class="built_in">test</span></span><br><span class="line">&#123;% <span class="built_in">set</span> teststr=<span class="string">&#x27;abc&#x27;</span> %&#125;</span><br><span class="line">&#123;&#123; teststr &#125;&#125;</span><br><span class="line"><span class="comment"># 在jinja2中,使用set关键字定义变量,执行如下ad-hoc命令渲染模板</span></span><br><span class="line">ansible node2 -m template -a <span class="string">&quot;src=test.j2 dest=/opt/test&quot;</span></span><br><span class="line"><span class="comment"># 输出内容如下:</span></span><br><span class="line"><span class="comment"># cat /opt/test</span></span><br><span class="line">jinja2 <span class="built_in">test</span></span><br><span class="line">abc</span><br></pre></td></tr></table></figure></li>
</ul>
<p>3,结合for的使用</p>
<ul>
<li>通用结构<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br></pre></td><td class="code"><pre><span class="line">&#123;% <span class="keyword">for</span> 迭代变量 <span class="keyword">in</span> 可迭代对象 %&#125;</span><br><span class="line">&#123;&#123; 迭代变量 &#125;&#125;</span><br><span class="line">&#123;% endfor %&#125;</span><br><span class="line"><span class="comment"># 注: jinja2的控制语句大多都会遵循这个规则,即&quot;XXX&quot;控制语句需要使用&quot;endXXX&quot;作为结尾</span></span><br><span class="line"></span><br><span class="line"><span class="comment">## 默认换行方式:</span></span><br><span class="line"><span class="comment"># cat test.j2</span></span><br><span class="line">jinja2 <span class="built_in">test</span></span><br><span class="line">&#123;% <span class="keyword">for</span> i <span class="keyword">in</span> [3,1,7,8,2] %&#125;</span><br><span class="line">&#123;&#123; i &#125;&#125;</span><br><span class="line">&#123;% endfor %&#125;</span><br><span class="line"><span class="comment"># ansible node2 -m template -a &quot;src=test.j2 dest=/opt/test&quot;</span></span><br><span class="line"><span class="comment"># cat /opt/test</span></span><br><span class="line">jinja2 <span class="built_in">test</span></span><br><span class="line">3</span><br><span class="line">1</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">2</span><br><span class="line"></span><br><span class="line"><span class="comment">## 不换行方式:</span></span><br><span class="line"><span class="comment"># cat test.j2</span></span><br><span class="line">jinja2 <span class="built_in">test</span></span><br><span class="line">&#123;% <span class="keyword">for</span> i <span class="keyword">in</span> [3,1,7,8,2] -%&#125;</span><br><span class="line">&#123;&#123; i &#125;&#125;</span><br><span class="line">&#123;%- endfor %&#125;</span><br><span class="line"><span class="comment"># 在for的结束控制符&quot;%&#125;&quot;之前添加了减号&quot;-&quot;</span></span><br><span class="line"><span class="comment"># 在endfor的开始控制符&quot;&#123;%&quot;之后添加到了减号&quot;-&quot;</span></span><br><span class="line"><span class="comment"># cat test</span></span><br><span class="line">jinja2 <span class="built_in">test</span></span><br><span class="line">31782</span><br><span class="line"></span><br><span class="line"><span class="comment">## 不换行,但有间隔方式</span></span><br><span class="line">jinja2 <span class="built_in">test</span></span><br><span class="line">&#123;% <span class="keyword">for</span> i <span class="keyword">in</span> [3,1,7,8,2] -%&#125;</span><br><span class="line">&#123;&#123; i &#125;&#125;&#123;&#123; <span class="string">&#x27; &#x27;</span> &#125;&#125;</span><br><span class="line">&#123;%- endfor %&#125;</span><br><span class="line"><span class="comment"># 在循环每一项时,在每一项后面加入了一个空格字符串</span></span><br><span class="line"><span class="comment"># cat test</span></span><br><span class="line">jinja2 <span class="built_in">test</span></span><br><span class="line">3 1 7 8 2</span><br><span class="line"></span><br><span class="line"><span class="comment">## 不换行,但有间隔方式二</span></span><br><span class="line"><span class="comment"># cat test.j2</span></span><br><span class="line">jinja2 <span class="built_in">test</span></span><br><span class="line">&#123;% <span class="keyword">for</span> i <span class="keyword">in</span> [3,1,7,8,2] -%&#125;</span><br><span class="line">&#123;&#123; i~<span class="string">&#x27; &#x27;</span> &#125;&#125;</span><br><span class="line">&#123;%- endfor %&#125;</span><br><span class="line"><span class="comment"># 在jinja2中,波浪符&quot;~&quot;就是字符串连接符,它会把所有的操作数转换为字符串,并且连接它们</span></span><br></pre></td></tr></table></figure></li>
</ul>
<p>4,结合for使用,循环字典</p>
<ul>
<li>如下示例:<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># cat test.j2</span></span><br><span class="line">jinja2 <span class="built_in">test</span></span><br><span class="line">&#123;% <span class="keyword">for</span> key,val <span class="keyword">in</span> &#123;<span class="string">&#x27;name&#x27;</span>:<span class="string">&#x27;bob&#x27;</span>,<span class="string">&#x27;age&#x27;</span>:18&#125;.iteritems() %&#125;</span><br><span class="line">&#123;&#123; key ~ <span class="string">&#x27;:&#x27;</span> ~ val &#125;&#125;</span><br><span class="line">&#123;% endfor %&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment"># cat test</span></span><br><span class="line">jinja2 <span class="built_in">test</span></span><br><span class="line">age:18</span><br><span class="line">name:bob</span><br></pre></td></tr></table></figure></li>
</ul>
<p>5,在使用for循环时,有一些内置的特殊变量可以使用</p>
<ul>
<li>当前循环操作为整个循环的第几次操作,则可以借助”loop.index”特殊变量<figure class="highlight jinja"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="language-xml"># cat test.j2</span></span><br><span class="line"><span class="language-xml">jinja2 test</span></span><br><span class="line"><span class="language-xml"></span><span class="template-tag">&#123;% <span class="name"><span class="name">for</span></span> i <span class="keyword">in</span> [3,1,7,8,2] %&#125;</span><span class="language-xml"></span></span><br><span class="line"><span class="language-xml"></span><span class="template-variable">&#123;&#123; i ~ &#x27;----&#x27; ~ loop.index &#125;&#125;</span><span class="language-xml"></span></span><br><span class="line"><span class="language-xml"></span><span class="template-tag">&#123;% <span class="name"><span class="name">endfor</span></span> %&#125;</span><span class="language-xml"></span></span><br><span class="line"><span class="language-xml"># cat test</span></span><br><span class="line"><span class="language-xml">jinja2 test</span></span><br><span class="line"><span class="language-xml">3----1</span></span><br><span class="line"><span class="language-xml">1----2</span></span><br><span class="line"><span class="language-xml">7----3</span></span><br><span class="line"><span class="language-xml">8----4</span></span><br><span class="line"><span class="language-xml">2----5</span></span><br></pre></td></tr></table></figure></li>
<li>其他的一些循环变量<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># loop.index   当前循环操作为整个循环的第几次循环,序号从1开始</span></span><br><span class="line"><span class="comment"># loop.index0   当前循环操作为整个循环的第几次循环,序号从0开始</span></span><br><span class="line"><span class="comment"># loop.revindex  当前循环操作距离整个循环结束还有几次,序号到1结束</span></span><br><span class="line"><span class="comment"># loop.revindex0 当前循环操作距离整个循环结束还有几次,序号到0结束</span></span><br><span class="line"><span class="comment"># loop.first    当操作可迭代对象中的第一个元素时,此变量的值为true</span></span><br><span class="line"><span class="comment"># loop.last    当操作可迭代对象中的最后一个元素时,此变量的值为true</span></span><br><span class="line"><span class="comment"># loop.length   可迭代对象的长度</span></span><br><span class="line"><span class="comment"># loop.depth   当使用递归的循环时,当前迭代所在的递归中的层级,层级序号从1开始</span></span><br><span class="line"><span class="comment"># loop.depth0   当使用递归的循环时,当前迭代所在的递归中的层级,层级序号从0开始</span></span><br><span class="line"><span class="comment"># loop.cycle()  这是一个辅助函数,通过这个函数我们可以在指定的一些值中进行轮询取值,具体参考之后的示例</span></span><br></pre></td></tr></table></figure></li>
<li>对一段内容循环的生成指定的次数,则可以借助range函数完成<figure class="highlight jinja"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="template-tag">&#123;% <span class="name"><span class="name">for</span></span> i <span class="keyword">in</span> range(3) %&#125;</span><span class="language-xml"></span></span><br><span class="line"><span class="language-xml">something</span></span><br><span class="line"><span class="language-xml">...</span></span><br><span class="line"><span class="language-xml"></span><span class="template-tag">&#123;% <span class="name"><span class="name">endfor</span></span> %&#125;</span></span><br></pre></td></tr></table></figure></li>
</ul>
<p>6,for的一些其他操作</p>
<ul>
<li>当for循环中没有使用if内联表达式时,也可以使用else块<figure class="highlight jinja"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="template-tag">&#123;% <span class="name"><span class="name">for</span></span> u <span class="keyword">in</span> userlist %&#125;</span><span class="language-xml"></span></span><br><span class="line"><span class="language-xml">  </span><span class="template-variable">&#123;&#123; u.name &#125;&#125;</span><span class="language-xml"></span></span><br><span class="line"><span class="language-xml"></span><span class="template-tag">&#123;%<span class="name"><span class="name">else</span></span>%&#125;</span><span class="language-xml"></span></span><br><span class="line"><span class="language-xml">  no one</span></span><br><span class="line"><span class="language-xml"></span><span class="template-tag">&#123;% <span class="name"><span class="name">endfor</span></span> %&#125;</span><span class="language-xml"></span></span><br><span class="line"><span class="language-xml"># 只有userlist列表为空时,才会渲染else块后的内容</span></span><br></pre></td></tr></table></figure></li>
<li>for支持递归操作<figure class="highlight jinja"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="template-tag">&#123;% <span class="name">set</span> dictionary=&#123; &#x27;name&#x27;:&#x27;bob&#x27;,&#x27;son&#x27;:&#123; &#x27;name&#x27;:&#x27;tom&#x27;,&#x27;son&#x27;:&#123; &#x27;name&#x27;:&#x27;jerry&#x27; &#125; &#125; &#125;  %&#125;</span><span class="language-xml"></span></span><br><span class="line"><span class="language-xml"> </span></span><br><span class="line"><span class="language-xml"></span><span class="template-tag">&#123;% <span class="name"><span class="name">for</span></span> key,value <span class="keyword">in</span> dictionary.iteritems() recursive %&#125;</span><span class="language-xml"></span></span><br><span class="line"><span class="language-xml">  </span><span class="template-tag">&#123;% <span class="name"><span class="name">if</span></span> key == &#x27;name&#x27; %&#125;</span><span class="language-xml"></span></span><br><span class="line"><span class="language-xml">    </span><span class="template-tag">&#123;% <span class="name">set</span> fathername=value %&#125;</span><span class="language-xml"></span></span><br><span class="line"><span class="language-xml">  </span><span class="template-tag">&#123;% <span class="name"><span class="name">endif</span></span> %&#125;</span><span class="language-xml"></span></span><br><span class="line"><span class="language-xml"> </span></span><br><span class="line"><span class="language-xml">  </span><span class="template-tag">&#123;% <span class="name"><span class="name">if</span></span> key == &#x27;son&#x27; %&#125;</span><span class="language-xml"></span></span><br><span class="line"><span class="language-xml">    </span><span class="template-variable">&#123;&#123; fathername ~&quot;&#x27;s son is &quot;~ value.name&#125;&#125;</span><span class="language-xml"></span></span><br><span class="line"><span class="language-xml">    </span><span class="template-variable">&#123;&#123; loop( value.iteritems() ) &#125;&#125;</span><span class="language-xml"></span></span><br><span class="line"><span class="language-xml">  </span><span class="template-tag">&#123;% <span class="name"><span class="name">endif</span></span> %&#125;</span><span class="language-xml"></span></span><br><span class="line"><span class="language-xml"></span><span class="template-tag">&#123;% <span class="name"><span class="name">endfor</span></span> %&#125;</span><span class="language-xml"></span></span><br><span class="line"><span class="language-xml"># 使用了iteritems函数,在for循环的末尾,添加了recursive 修饰符,当for循环中有recursive时,表示这个循环是一个递归的循环,当需要在for循环中进行递归时,只要在需要进行递归的地方调用loop函数即可,上例中的&quot;loop( value.iteritems() )&quot;即为调用递归的部分,由于value也是一个字典,所以需要使用iteritems函数进行处理</span></span><br><span class="line"><span class="language-xml">bob&#x27;s son is tom</span></span><br><span class="line"><span class="language-xml">tom&#x27;s son is jerry</span></span><br></pre></td></tr></table></figure>
<h3 id="2021-07-17-jinja2模板-三"><a href="#2021-07-17-jinja2模板-三" class="headerlink" title="2021-07-17 jinja2模板(三)"></a>2021-07-17 jinja2模板(三)</h3>1,jinja2模板文件中需要使用特殊字符</li>
<li>最简单的方法就是直接在”双花括号”中使用引号将这类符号引起,当做纯粹的字符串进行处理<figure class="highlight jinja"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="language-xml"># cat test.j2</span></span><br><span class="line"><span class="language-xml"></span><span class="template-variable">&#123;&#123;  &#x27;&#123;&#123;&#x27; &#125;&#125;</span><span class="language-xml"></span></span><br><span class="line"><span class="language-xml"></span><span class="template-variable">&#123;&#123;  &#x27;&#125;&#125;</span><span class="language-xml">&#x27; &#125;&#125;</span></span><br><span class="line"><span class="language-xml"></span><span class="template-variable">&#123;&#123; &#x27;&#123;&#123; test string &#125;&#125;</span><span class="language-xml">&#x27; &#125;&#125;</span></span><br><span class="line"><span class="language-xml"></span><span class="template-variable">&#123;&#123; &#x27;&#123;% test string %&#125;&#x27; &#125;&#125;</span><span class="language-xml"></span></span><br><span class="line"><span class="language-xml"></span><span class="template-variable">&#123;&#123; &#x27;&#123;# test string #&#125;&#x27; &#125;&#125;</span><span class="language-xml"></span></span><br><span class="line"><span class="language-xml"># cat test</span></span><br><span class="line"><span class="language-xml"></span><span class="template-variable">&#123;&#123;</span></span><br><span class="line"><span class="template-variable">&#125;&#125;</span><span class="language-xml"></span></span><br><span class="line"><span class="language-xml"></span><span class="template-variable">&#123;&#123; test string &#125;&#125;</span><span class="language-xml"></span></span><br><span class="line"><span class="language-xml"></span><span class="template-tag">&#123;% <span class="name">test</span> string %&#125;</span><span class="language-xml"></span></span><br><span class="line"><span class="language-xml"></span><span class="comment">&#123;# test string #&#125;</span></span><br></pre></td></tr></table></figure></li>
<li>如果有较大的段落时,可以借助raw块,来实现需求<figure class="highlight jinja"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="language-xml"># cat test.j2</span></span><br><span class="line"><span class="language-xml"></span><span class="template-tag">&#123;% <span class="name">raw</span> %&#125;</span><span class="language-xml"></span></span><br><span class="line"><span class="language-xml">  </span><span class="template-variable">&#123;&#123; test &#125;&#125;</span><span class="language-xml"></span></span><br><span class="line"><span class="language-xml">  </span><span class="template-tag">&#123;% <span class="name">test</span> %&#125;</span><span class="language-xml"></span></span><br><span class="line"><span class="language-xml">  </span><span class="comment">&#123;# test #&#125;</span><span class="language-xml"></span></span><br><span class="line"><span class="language-xml">  </span><span class="template-tag">&#123;% <span class="name"><span class="name">if</span></span> %&#125;</span><span class="language-xml"></span></span><br><span class="line"><span class="language-xml">  </span><span class="template-tag">&#123;% <span class="name"><span class="name">for</span></span> %&#125;</span><span class="language-xml"></span></span><br><span class="line"><span class="language-xml"></span><span class="template-tag">&#123;% <span class="name">endraw</span> %&#125;</span><span class="language-xml"></span></span><br><span class="line"><span class="language-xml"># &quot;</span><span class="template-tag">&#123;% <span class="name">raw</span> %&#125;</span><span class="language-xml">&quot;与&quot;</span><span class="template-tag">&#123;% <span class="name">endraw</span> %&#125;</span><span class="language-xml">&quot;之间的所有&quot;</span><span class="template-variable">&#123;&#123;  &#125;&#125;</span><span class="language-xml">&quot;、&quot;</span><span class="template-tag">&#123;%  %&#125;</span><span class="language-xml">&quot;或者&quot;</span><span class="comment">&#123;#  #&#125;</span><span class="language-xml">&quot;都不会被jinja2解析,上例模板被渲染后,raw块中的符号都会保持原样</span></span><br><span class="line"><span class="language-xml"># cat test</span></span><br><span class="line"><span class="language-xml"> </span></span><br><span class="line"><span class="language-xml">  </span><span class="template-variable">&#123;&#123; test &#125;&#125;</span><span class="language-xml"></span></span><br><span class="line"><span class="language-xml">  </span><span class="template-tag">&#123;% <span class="name">test</span> %&#125;</span><span class="language-xml"></span></span><br><span class="line"><span class="language-xml">  </span><span class="comment">&#123;# test #&#125;</span><span class="language-xml"></span></span><br><span class="line"><span class="language-xml">  </span><span class="template-tag">&#123;% <span class="name"><span class="name">if</span></span> %&#125;</span><span class="language-xml"></span></span><br><span class="line"><span class="language-xml">  </span><span class="template-tag">&#123;% <span class="name"><span class="name">for</span></span> %&#125;</span></span><br></pre></td></tr></table></figure></li>
</ul>
<p>2,在调用模板引擎时,手动的指定一些符号,这些符号可以替换默认的区块</p>
<ul>
<li>如下示例:<figure class="highlight jinja"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="language-xml"># cat test.j2</span></span><br><span class="line"><span class="language-xml"></span><span class="template-tag">&#123;% <span class="name">set</span> test=&#x27;abc&#x27; %&#125;</span><span class="language-xml"></span></span><br><span class="line"><span class="language-xml"> </span></span><br><span class="line"><span class="language-xml">(( test ))</span></span><br><span class="line"><span class="language-xml"> </span></span><br><span class="line"><span class="language-xml"></span><span class="template-variable">&#123;&#123; test &#125;&#125;</span><span class="language-xml"></span></span><br><span class="line"><span class="language-xml"></span><span class="template-variable">&#123;&#123; test1 &#125;&#125;</span><span class="language-xml"></span></span><br><span class="line"><span class="language-xml"></span><span class="template-variable">&#123;&#123; &#x27;test&#x27; &#125;&#125;</span><span class="language-xml"></span></span><br><span class="line"><span class="language-xml"></span><span class="template-variable">&#123;&#123; &#x27;test1&#x27; &#125;&#125;</span><span class="language-xml"></span></span><br><span class="line"><span class="language-xml"># 使用variable_start_string参数指定一个符号,这个符号用于替换&quot;</span><span class="template-variable">&#123;&#123;  &#125;&#125;</span><span class="language-xml">&quot;中的&quot;</span><span class="template-variable">&#123;&#123;“,同时,可以使用variable_end_string参数指定一个符号,这个符号用于替换&quot;&#123;&#123;  &#125;&#125;</span><span class="language-xml">&quot;中的&quot;&#125;&#125;&quot;</span></span><br><span class="line"><span class="language-xml"># ansible node2 -m template -a &quot;src=test.j2 dest=/opt/test variable_start_string=&#x27;((&#x27; variable_end_string=&#x27;))&#x27;&quot;</span></span><br><span class="line"><span class="language-xml"># cat test</span></span><br><span class="line"><span class="language-xml"> </span></span><br><span class="line"><span class="language-xml">abc</span></span><br><span class="line"><span class="language-xml"> </span></span><br><span class="line"><span class="language-xml"></span><span class="template-variable">&#123;&#123; test &#125;&#125;</span><span class="language-xml"></span></span><br><span class="line"><span class="language-xml"></span><span class="template-variable">&#123;&#123; test1 &#125;&#125;</span><span class="language-xml"></span></span><br><span class="line"><span class="language-xml"></span><span class="template-variable">&#123;&#123; &#x27;test&#x27; &#125;&#125;</span><span class="language-xml"></span></span><br><span class="line"><span class="language-xml"></span><span class="template-variable">&#123;&#123; &#x27;test1&#x27; &#125;&#125;</span><span class="language-xml"></span></span><br><span class="line"><span class="language-xml"></span></span><br><span class="line"><span class="language-xml"># 可以使用block_start_string参数指定一个符号, 这个符号用于替换&quot;</span><span class="template-tag">&#123;%  %&#125;</span><span class="language-xml">&quot;中的&quot;</span><span class="template-tag">&#123;% &quot;,可以使用<span class="name">block_end_string</span>参数指定一个符号,这个符号用于替换&quot;&#123;%  %&#125;</span><span class="language-xml">&quot;中的&quot;%&#125;&quot;</span></span><br></pre></td></tr></table></figure></li>
</ul>
<p>3,jinja2中也有类似函数的东西,名字叫做宏</p>
<ul>
<li>如下示例:<figure class="highlight jinja"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="language-xml"># 最简单的宏</span></span><br><span class="line"><span class="language-xml"># cat test.j2</span></span><br><span class="line"><span class="language-xml"></span><span class="template-tag">&#123;% <span class="name">macro</span> testfunc() %&#125;</span><span class="language-xml"></span></span><br><span class="line"><span class="language-xml">  test string</span></span><br><span class="line"><span class="language-xml">  </span><span class="template-tag">&#123;% <span class="name">endmacro</span> %&#125;</span><span class="language-xml"></span></span><br><span class="line"><span class="language-xml">   </span></span><br><span class="line"><span class="language-xml">   </span><span class="template-variable">&#123;&#123; testfunc() &#125;&#125;</span><span class="language-xml"></span></span><br><span class="line"><span class="language-xml"># 指定参数的宏,包含默认值</span></span><br><span class="line"><span class="language-xml"></span><span class="template-tag">&#123;% <span class="name">macro</span> testfunc(tv1=111) %&#125;</span><span class="language-xml"></span></span><br><span class="line"><span class="language-xml">  test string</span></span><br><span class="line"><span class="language-xml">    </span><span class="template-variable">&#123;&#123;tv1&#125;&#125;</span><span class="language-xml"></span></span><br><span class="line"><span class="language-xml">    </span><span class="template-tag">&#123;% <span class="name">endmacro</span> %&#125;</span><span class="language-xml"></span></span><br><span class="line"><span class="language-xml">     </span></span><br><span class="line"><span class="language-xml">     </span><span class="template-variable">&#123;&#123; testfunc( ) &#125;&#125;</span><span class="language-xml"></span></span><br><span class="line"><span class="language-xml">     </span><span class="template-variable">&#123;&#123; testfunc(666) &#125;&#125;</span></span><br></pre></td></tr></table></figure>
<h3 id="2021-07-17-ansible中的role"><a href="#2021-07-17-ansible中的role" class="headerlink" title="2021-07-17 ansible中的role"></a>2021-07-17 ansible中的role</h3>1,ansible官方定义的规范</li>
<li>role的标准目录结构<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line">$ tree role</span><br><span class="line">role</span><br><span class="line">├── defaults</span><br><span class="line">│   └── main.yml</span><br><span class="line">├── files</span><br><span class="line">├── handlers</span><br><span class="line">│   └── main.yml</span><br><span class="line">├── meta</span><br><span class="line">│   └── main.yml</span><br><span class="line">├── tasks</span><br><span class="line">│   └── main.yml</span><br><span class="line">├── templates</span><br><span class="line">└── vars</span><br><span class="line">    └── main.yml</span><br><span class="line"></span><br><span class="line"><span class="comment"># tasks目录:角色需要执行的主任务文件放置在此目录中,默认的主任务文件名为main.yml,当调用角色时,默认会执行main.yml文件中的任务,也可以将其他需要执行的任务文件通过include的方式包含在tasks/main.yml文件中.</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># handlers目录:当角色需要调用handlers时,默认会在此目录中的main.yml文件中查找对应的handler</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># defaults目录:角色会使用到的变量可以写入到此目录中的main.yml文件中,通常,defaults/main.yml文件中的变量都用于设置默认值,以便在你没有设置对应变量值时,变量有默认的值可以使用,定义在defaults/main.yml文件中的变量的优先级是最低的.</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># vars目录:角色会使用到的变量可以写入到此目录中的main.yml文件中,看到这里你肯定会有疑问,vars/main.yml文件和defaults/main.yml文件的区别在哪里呢？区别就是,defaults/main.yml文件中的变量的优先级是最低的,而vars/main.yml文件中的变量的优先级非常高,如果你只是想提供一个默认的配置,那么你可以把对应的变量定义在defaults/main.yml中,如果你想要确保别人在调用角色时,使用的值就是你指定的值,则可以将变量定义在vars/main.yml中,因为定义在vars/main.yml文件中的变量的优先级非常高,所以其值比较难以覆盖.</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># meta目录:如果你想要赋予这个角色一些元数据,则可以将元数据写入到meta/main.yml文件中,这些元数据用于描述角色的相关属性,比如 作者信息、角色主要作用等等,你也可以在meta/main.yml文件中定义这个角色依赖于哪些其他角色,或者改变角色的默认调用设定,在之后会有一些实际的示例,此处不用纠结.</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># templates目录: 角色相关的模板文件可以放置在此目录中,当使用角色相关的模板时,如果没有指定路径,会默认从此目录中查找对应名称的模板文件.</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># files目录:角色可能会用到的一些其他文件可以放置在此目录中,比如,当你定义nginx角色时,需要配置https,那么相关的证书文件即可放置在此目录中.</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 当然,上述目录并不全是必须的,也就是说,如果你的角色并没有相关的模板文件,那么角色目录中并不用包含templates目录,同理,其他目录也一样,一般情况下,都至少会有一个tasks目录.</span></span><br></pre></td></tr></table></figure></li>
</ul>
<p>2,调用role的方式</p>
<ul>
<li>如下示例:<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># ls</span></span><br><span class="line">testrole  test.yml</span><br><span class="line"></span><br><span class="line"><span class="comment"># cat test.yml</span></span><br><span class="line">- hosts: node2</span><br><span class="line">  roles:</span><br><span class="line">    - testrole</span><br><span class="line"></span><br><span class="line"><span class="comment"># ansible-playbook test.yml</span></span><br><span class="line"></span><br><span class="line"><span class="comment">## 调用testrole角色时,test.yml会从同级目录中查找与testrole角色同名的目录</span></span><br><span class="line"><span class="comment">## 还有其他位置也可以被调用:</span></span><br><span class="line"><span class="comment">## 1,当前系统用户的家目录中的.ansible/roles目录,即 ~/.ansible/roles目录中</span></span><br><span class="line"><span class="comment">## 2,同级目录中的roles目录中</span></span><br><span class="line"><span class="comment">## 3,修改ansible的配置文件,编辑/etc/ansible/ansible.cfg配置文件,设置roles_path选项</span></span><br><span class="line">roles_path    = /etc/ansible/roles:/opt:/testdir</span><br><span class="line"></span><br><span class="line"><span class="comment">## 或者在playbook中,直接接上role的绝对路径</span></span><br></pre></td></tr></table></figure></li>
</ul>
<p>3,一些role使用的问题</p>
<ul>
<li>在默认情况下,角色中的变量是全局可访问的,可以将变量的访问域变成角色所私有的,如果想要将变量变成角色私有的,则需要设置&#x2F;etc&#x2F;ansible&#x2F;ansible.cfg文件,将private_role_vars的值设置为yes,默认情况下,”private_role_vars &#x3D; yes”是被注释掉的,将前面的注释符去掉皆可</li>
<li>默认情况下,无法多次调用同一个角色,也就是说,如下playbook只会调用一次testrole角色:<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># cat test.yml</span></span><br><span class="line">- hosts: node2</span><br><span class="line">  roles:</span><br><span class="line">    - role: testrole</span><br><span class="line">      - role: testrole</span><br><span class="line"><span class="comment"># 如果想要多次调用同一个角色,有两种方法,如下:</span></span><br><span class="line"><span class="comment"># 方法一:设置角色的allow_duplicates属性 ,让其支持重复的调用.</span></span><br><span class="line"><span class="comment"># 方法二:调用角色时,传入的参数值不同.</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 方法一需要为角色设置allow_duplicates属性,而此属性需要设置在meta/main.yml文件中,所以我们需要在testrole中创建meta/main.yml文件,写入如下内容:</span></span><br><span class="line"><span class="comment"># cat testrole/meta/main.yml</span></span><br><span class="line">allow_duplicates: <span class="literal">true</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 方法二</span></span><br><span class="line"><span class="comment"># cat test.yml</span></span><br><span class="line"><span class="comment"># cat test.yml</span></span><br><span class="line">- hosts: node2</span><br><span class="line">  roles:</span><br><span class="line">  - role: testrole</span><br><span class="line">    vars:</span><br><span class="line">      testvar: <span class="string">&quot;zsythink&quot;</span></span><br><span class="line">  - role: testrole</span><br><span class="line">    vars:</span><br><span class="line">      testvar: <span class="string">&quot;zsythink.net&quot;</span></span><br></pre></td></tr></table></figure></li>
</ul>
<p>4,除了使用”-e”传入的变量的优先级,其他变量（包括主机变量）的优先级均低于vars&#x2F;main.yml中变量的优先级</p>
<p>5,调试handler方法</p>
<ul>
<li>如下示例:<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># cat testrole/tasks/main.yml</span></span><br><span class="line">- debug:</span><br><span class="line">    msg: <span class="string">&quot;hello testrole!&quot;</span></span><br><span class="line">  changed_when: <span class="literal">true</span></span><br><span class="line">  notify: test_handler</span><br><span class="line"></span><br><span class="line"><span class="comment"># cat testrole/handlers/main.yml</span></span><br><span class="line">- name: test_handler</span><br><span class="line">  debug:</span><br><span class="line">    msg: <span class="string">&quot;this is a test handler&quot;</span></span><br></pre></td></tr></table></figure>
<h3 id="2021-07-17-常用技巧-一"><a href="#2021-07-17-常用技巧-一" class="headerlink" title="2021-07-17 常用技巧(一)"></a>2021-07-17 常用技巧(一)</h3>1,技巧一,在ansible中使用python字符串的一些特性</li>
<li>ansible基于python实现,当我们在ansible中处理字符串时,能够借助一些python的字符串特性,比如,在python中可以使用中括号(方括号)截取字符串中的一部分,在ansible中也可以利用这一特性<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># cat test.yml</span></span><br><span class="line">- hosts: me</span><br><span class="line">  gather_facts: no</span><br><span class="line">  vars:</span><br><span class="line">    a: <span class="string">&quot;vaA12345&quot;</span></span><br><span class="line">  tasks:</span><br><span class="line">  - debug:</span><br><span class="line">      msg: <span class="string">&quot;&#123;&#123;a[2]&#125;&#125;&quot;</span></span><br><span class="line"><span class="comment"># 使用a[2:5]获取到a字符串的第3到第5个字符（不包含第6个字符）</span></span><br><span class="line"><span class="comment"># 使用a[:5]获取到a字符串的第6个字符之前的所有字符（不包含第6个字符）</span></span><br><span class="line"><span class="comment"># 使用a[5:]获取到a字符串的第6个字符之后的所有字符（包含第6个字符）</span></span><br><span class="line"></span><br><span class="line"><span class="comment">## 之前成员运算符&quot;in&quot;和&quot;not in&quot;,也是python的字符串运算符</span></span><br><span class="line">- hosts: me</span><br><span class="line">  gather_facts: no</span><br><span class="line">  vars:</span><br><span class="line">    a: <span class="string">&quot;vaA12345&quot;</span></span><br><span class="line">  tasks:</span><br><span class="line">  - debug:</span><br><span class="line">      msg: <span class="string">&quot;true&quot;</span></span><br><span class="line">    when: <span class="string">&quot;&#x27;va&#x27; in a&quot;</span></span><br></pre></td></tr></table></figure></li>
<li>运算符处理字符<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 使用加号&quot;+&quot;连接两个字符串</span></span><br><span class="line"><span class="bullet">-</span> <span class="attr">hosts:</span> <span class="string">me</span></span><br><span class="line">  <span class="attr">gather_facts:</span> <span class="literal">no</span></span><br><span class="line">  <span class="attr">vars:</span></span><br><span class="line">    <span class="attr">a:</span> <span class="string">&quot;vaA12345&quot;</span></span><br><span class="line">    <span class="attr">b:</span> <span class="string">&quot;vbB67890&quot;</span></span><br><span class="line">  <span class="attr">tasks:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">debug:</span></span><br><span class="line">      <span class="attr">msg:</span> <span class="string">&quot;<span class="template-variable">&#123;&#123;a+b&#125;&#125;</span>&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 使用乘号&quot;*&quot;连续的重复输出字符串</span></span><br><span class="line"><span class="bullet">-</span> <span class="attr">hosts:</span> <span class="string">me</span></span><br><span class="line">  <span class="attr">gather_facts:</span> <span class="literal">no</span></span><br><span class="line">  <span class="attr">vars:</span></span><br><span class="line">    <span class="attr">a:</span> <span class="string">&quot;vaA12345&quot;</span></span><br><span class="line">  <span class="attr">tasks:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">debug:</span></span><br><span class="line">      <span class="attr">msg:</span> <span class="string">&quot;<span class="template-variable">&#123;&#123;a*3&#125;&#125;</span>&quot;</span></span><br></pre></td></tr></table></figure></li>
<li>使用find查找字符串中字符位置<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="bullet">-</span> <span class="attr">hosts:</span> <span class="string">me</span></span><br><span class="line">  <span class="attr">gather_facts:</span> <span class="literal">no</span></span><br><span class="line">  <span class="attr">vars:</span></span><br><span class="line">    <span class="attr">a:</span> <span class="string">&quot;vaA12345&quot;</span></span><br><span class="line">  <span class="attr">tasks:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">debug:</span></span><br><span class="line">      <span class="attr">msg:</span> <span class="string">&quot;<span class="template-variable">&#123;&#123;a.find(&#x27;A1&#x27;)&#125;&#125;</span>&quot;</span></span><br><span class="line"><span class="comment"># 输出如下:</span></span><br><span class="line"><span class="string">TASK</span> [<span class="string">debug</span>] <span class="string">xxxxxxxxxxxxxxxxxxxxx</span></span><br><span class="line"><span class="attr">ok:</span> [<span class="string">me</span>] <span class="string">=&gt;</span> &#123;</span><br><span class="line">    <span class="attr">&quot;msg&quot;:</span> <span class="string">&quot;2&quot;</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment"># 用作条件判断</span></span><br><span class="line"><span class="bullet">-</span> <span class="attr">hosts:</span> <span class="string">me</span></span><br><span class="line">  <span class="attr">gather_facts:</span> <span class="literal">no</span></span><br><span class="line">  <span class="attr">vars:</span></span><br><span class="line">    <span class="attr">a:</span> <span class="string">&quot;vaA12345&quot;</span></span><br><span class="line">  <span class="attr">tasks:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">debug:</span></span><br><span class="line">      <span class="attr">msg:</span> <span class="string">&quot;not found&quot;</span></span><br><span class="line">    <span class="attr">when:</span> <span class="string">a.find(&#x27;A2&#x27;)</span> <span class="string">==</span> <span class="number">-1</span></span><br></pre></td></tr></table></figure></li>
</ul>
<p>2,指定任务在某个节点上运行</p>
<ul>
<li>通过”delegate_to”关键字,可以指定某个任务在特定的主机上执行,这个特定的主机可以是目标主机中的某一个,也可以不是目标主机中的任何一个<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="bullet">-</span> <span class="attr">hosts:</span> <span class="string">node2,me</span></span><br><span class="line">  <span class="attr">gather_facts:</span> <span class="literal">no</span></span><br><span class="line">  <span class="attr">tasks:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">file:</span></span><br><span class="line">      <span class="attr">path:</span> <span class="string">&quot;/tmp/ttt&quot;</span></span><br><span class="line">      <span class="attr">state:</span> <span class="string">touch</span></span><br><span class="line"> </span><br><span class="line">  <span class="bullet">-</span> <span class="attr">file:</span></span><br><span class="line">      <span class="attr">path:</span> <span class="string">&quot;/tmp/delegate&quot;</span></span><br><span class="line">      <span class="attr">state:</span> <span class="string">touch</span></span><br><span class="line">    <span class="attr">delegate_to:</span> <span class="string">node3</span></span><br><span class="line"> </span><br><span class="line">  <span class="bullet">-</span> <span class="attr">file:</span></span><br><span class="line">      <span class="attr">path:</span> <span class="string">&quot;/tmp/ttt1&quot;</span></span><br><span class="line">      <span class="attr">state:</span> <span class="string">touch</span></span><br></pre></td></tr></table></figure></li>
</ul>
<p>3,让某个人物在ansible主机上执行,不在目标主机上执行</p>
<ul>
<li>有两种方式,如下示例:<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">## delegate_to</span></span><br><span class="line"><span class="bullet">-</span> <span class="attr">hosts:</span> <span class="string">node2,node3</span></span><br><span class="line">  <span class="attr">gather_facts:</span> <span class="literal">no</span></span><br><span class="line">  <span class="attr">tasks:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">file:</span></span><br><span class="line">      <span class="attr">path:</span> <span class="string">&quot;/tmp/inAnsible&quot;</span></span><br><span class="line">      <span class="attr">state:</span> <span class="string">touch</span></span><br><span class="line">    <span class="attr">delegate_to:</span> <span class="string">local</span></span><br><span class="line"> </span><br><span class="line">  <span class="bullet">-</span> <span class="attr">file:</span></span><br><span class="line">      <span class="attr">path:</span> <span class="string">&quot;/tmp/test&quot;</span></span><br><span class="line">      <span class="attr">state:</span> <span class="string">touch</span></span><br><span class="line"></span><br><span class="line"><span class="comment">## connection: local</span></span><br><span class="line"><span class="bullet">-</span> <span class="attr">hosts:</span> <span class="string">node2,node3</span></span><br><span class="line">  <span class="attr">gather_facts:</span> <span class="literal">no</span></span><br><span class="line">  <span class="attr">tasks:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">file:</span></span><br><span class="line">      <span class="attr">path:</span> <span class="string">&quot;/tmp/inAnsible&quot;</span></span><br><span class="line">      <span class="attr">state:</span> <span class="string">touch</span></span><br><span class="line">    <span class="attr">connection:</span> <span class="string">local</span></span><br><span class="line"> </span><br><span class="line">  <span class="bullet">-</span> <span class="attr">file:</span></span><br><span class="line">      <span class="attr">path:</span> <span class="string">&quot;/tmp/test&quot;</span></span><br><span class="line">      <span class="attr">state:</span> <span class="string">touch</span></span><br></pre></td></tr></table></figure></li>
</ul>
<p>4,只跑一次的任务</p>
<ul>
<li>从网站上下载包,但目标主机共有5台<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="bullet">-</span> <span class="attr">hosts:</span> <span class="string">A,B,C,D,E</span></span><br><span class="line">  <span class="attr">gather_facts:</span> <span class="literal">no</span></span><br><span class="line">  <span class="attr">tasks:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">get_url:</span></span><br><span class="line">      <span class="attr">url:</span> <span class="string">&quot;http://nexus.zsythink.net/repository/testraw/testfile/test.tar&quot;</span></span><br><span class="line">      <span class="attr">dest:</span> <span class="string">/tmp/</span></span><br><span class="line">    <span class="comment"># 结合本机执行一起使用</span></span><br><span class="line">    <span class="attr">connection:</span> <span class="string">local</span></span><br><span class="line">    <span class="attr">run_once:</span> <span class="literal">true</span></span><br><span class="line"> </span><br><span class="line">  <span class="bullet">-</span> <span class="attr">copy:</span></span><br><span class="line">      <span class="attr">src:</span> <span class="string">&quot;/tmp/test.tar&quot;</span></span><br><span class="line">      <span class="attr">dest:</span> <span class="string">&quot;/tmp&quot;</span></span><br></pre></td></tr></table></figure>
<h3 id="2021-07-17-常用技巧-二"><a href="#2021-07-17-常用技巧-二" class="headerlink" title="2021-07-17 常用技巧(二)"></a>2021-07-17 常用技巧(二)</h3>1,向列表中追加项</li>
<li>如下内容:<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br></pre></td><td class="code"><pre><span class="line"><span class="bullet">-</span> <span class="attr">hosts:</span> <span class="string">me</span></span><br><span class="line">  <span class="attr">gather_facts:</span> <span class="literal">no</span></span><br><span class="line">  <span class="attr">vars:</span></span><br><span class="line">   <span class="attr">l1:</span></span><br><span class="line">     <span class="bullet">-</span> <span class="number">1</span></span><br><span class="line">     <span class="bullet">-</span> <span class="number">2</span></span><br><span class="line">   <span class="attr">l2:</span></span><br><span class="line">     <span class="bullet">-</span> <span class="string">a</span></span><br><span class="line">     <span class="bullet">-</span> <span class="string">b</span></span><br><span class="line">     <span class="bullet">-</span> <span class="number">2</span></span><br><span class="line">  <span class="attr">tasks:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">set_fact:</span></span><br><span class="line">      <span class="attr">l3:</span> <span class="string">&quot;<span class="template-variable">&#123;&#123; l1 + l2 &#125;&#125;</span>&quot;</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">debug:</span></span><br><span class="line">      <span class="attr">var:</span> <span class="string">l3</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 直接列表相加</span></span><br><span class="line"><span class="bullet">-</span> <span class="attr">hosts:</span> <span class="string">me</span></span><br><span class="line">  <span class="attr">gather_facts:</span> <span class="literal">no</span></span><br><span class="line">  <span class="attr">vars:</span></span><br><span class="line">   <span class="attr">tlist:</span></span><br><span class="line">     <span class="bullet">-</span> <span class="number">1</span></span><br><span class="line">     <span class="bullet">-</span> <span class="number">2</span></span><br><span class="line">  <span class="attr">tasks:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">set_fact:</span></span><br><span class="line">      <span class="attr">tlist:</span> <span class="string">&quot;<span class="template-variable">&#123;&#123; tlist + [&#x27;a&#x27;] &#125;&#125;</span>&quot;</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">debug:</span></span><br><span class="line">      <span class="attr">var:</span> <span class="string">tlist</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># jinja2的语法,完成上述追加元素的过程</span></span><br><span class="line"><span class="bullet">-</span> <span class="attr">hosts:</span> <span class="string">me</span></span><br><span class="line">  <span class="attr">gather_facts:</span> <span class="literal">no</span></span><br><span class="line">  <span class="attr">vars:</span></span><br><span class="line">   <span class="attr">tlist:</span></span><br><span class="line">     <span class="bullet">-</span> <span class="number">1</span></span><br><span class="line">     <span class="bullet">-</span> <span class="number">2</span></span><br><span class="line">  <span class="attr">tasks:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">set_fact:</span></span><br><span class="line">      <span class="attr">tlist:</span> <span class="string">&quot;&#123;% set tlist = tlist + [&#x27;a&#x27;] %&#125;<span class="template-variable">&#123;&#123;tlist&#125;&#125;</span>&quot;</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">debug:</span></span><br><span class="line">      <span class="attr">var:</span> <span class="string">tlist</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 使用extend()追加</span></span><br><span class="line"><span class="bullet">-</span> <span class="attr">hosts:</span> <span class="string">me</span></span><br><span class="line">  <span class="attr">gather_facts:</span> <span class="literal">no</span></span><br><span class="line">  <span class="attr">vars:</span></span><br><span class="line">   <span class="attr">tlist:</span></span><br><span class="line">     <span class="bullet">-</span> <span class="number">1</span></span><br><span class="line">     <span class="bullet">-</span> <span class="number">2</span></span><br><span class="line">  <span class="attr">tasks:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">set_fact:</span></span><br><span class="line">      <span class="attr">tlist:</span> <span class="string">&quot;&#123;% set tlist = tlist + [&#x27;a&#x27;] %&#125;<span class="template-variable">&#123;&#123;tlist&#125;&#125;</span>&quot;</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">debug:</span></span><br><span class="line">      <span class="attr">var:</span> <span class="string">tlist</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># append追加</span></span><br><span class="line"><span class="bullet">-</span> <span class="attr">hosts:</span> <span class="string">me</span></span><br><span class="line">  <span class="attr">gather_facts:</span> <span class="literal">no</span></span><br><span class="line">  <span class="attr">vars:</span></span><br><span class="line">   <span class="attr">tlist:</span></span><br><span class="line">     <span class="bullet">-</span> <span class="number">1</span></span><br><span class="line">     <span class="bullet">-</span> <span class="number">2</span></span><br><span class="line">  <span class="attr">tasks:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">set_fact:</span></span><br><span class="line">      <span class="attr">tlist:</span> <span class="string">&quot;<span class="template-variable">&#123;&#123; tlist.append(&#x27;a&#x27;) &#125;&#125;</span><span class="template-variable">&#123;&#123;tlist&#125;&#125;</span>&quot;</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">debug:</span></span><br><span class="line">      <span class="attr">var:</span> <span class="string">tlist</span></span><br></pre></td></tr></table></figure></li>
</ul>
<p>2, 在列表中插入项</p>
<ul>
<li>如下示例:<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 使用insert()</span></span><br><span class="line"><span class="bullet">-</span> <span class="attr">hosts:</span> <span class="string">me</span></span><br><span class="line">  <span class="attr">gather_facts:</span> <span class="literal">no</span></span><br><span class="line">  <span class="attr">vars:</span></span><br><span class="line">   <span class="attr">tlist:</span></span><br><span class="line">     <span class="bullet">-</span> <span class="number">11</span></span><br><span class="line">     <span class="bullet">-</span> <span class="number">2</span></span><br><span class="line">     <span class="bullet">-</span> <span class="number">11</span></span><br><span class="line">  <span class="attr">tasks:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">set_fact:</span></span><br><span class="line">      <span class="attr">tlist:</span> <span class="string">&quot;<span class="template-variable">&#123;&#123; tlist.insert(1,&#x27;a&#x27;) &#125;&#125;</span><span class="template-variable">&#123;&#123;tlist&#125;&#125;</span>&quot;</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">debug:</span></span><br><span class="line">      <span class="attr">var:</span> <span class="string">tlist</span></span><br></pre></td></tr></table></figure></li>
</ul>
<p>3, 在列表中删除项</p>
<ul>
<li>如下示例:<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 使用pop</span></span><br><span class="line"><span class="bullet">-</span> <span class="attr">hosts:</span> <span class="string">me</span></span><br><span class="line">  <span class="attr">gather_facts:</span> <span class="literal">no</span></span><br><span class="line">  <span class="attr">vars:</span></span><br><span class="line">   <span class="attr">tlist:</span></span><br><span class="line">     <span class="bullet">-</span> <span class="number">11</span></span><br><span class="line">     <span class="bullet">-</span> <span class="number">2</span></span><br><span class="line">     <span class="bullet">-</span> <span class="string">&#x27;a&#x27;</span></span><br><span class="line">     <span class="bullet">-</span> <span class="string">&#x27;b&#x27;</span></span><br><span class="line">     <span class="bullet">-</span> <span class="number">3</span></span><br><span class="line">  <span class="attr">tasks:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">debug:</span></span><br><span class="line">      <span class="attr">msg:</span> <span class="string">&quot;<span class="template-variable">&#123;&#123;tlist.pop(2)&#125;&#125;</span>&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 使用remove()</span></span><br><span class="line"><span class="bullet">-</span> <span class="attr">hosts:</span> <span class="string">me</span></span><br><span class="line">  <span class="attr">gather_facts:</span> <span class="literal">no</span></span><br><span class="line">  <span class="attr">vars:</span></span><br><span class="line">   <span class="attr">tlist:</span></span><br><span class="line">     <span class="bullet">-</span> <span class="number">11</span></span><br><span class="line">     <span class="bullet">-</span> <span class="string">&#x27;b&#x27;</span></span><br><span class="line">     <span class="bullet">-</span> <span class="string">&#x27;a&#x27;</span></span><br><span class="line">     <span class="bullet">-</span> <span class="string">&#x27;b&#x27;</span></span><br><span class="line">     <span class="bullet">-</span> <span class="number">3</span></span><br><span class="line">  <span class="attr">tasks:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">set_fact:</span></span><br><span class="line">      <span class="attr">tlist:</span> <span class="string">&quot;<span class="template-variable">&#123;&#123; tlist.remove(&#x27;b&#x27;) &#125;&#125;</span><span class="template-variable">&#123;&#123;tlist&#125;&#125;</span>&quot;</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">debug:</span></span><br><span class="line">      <span class="attr">var:</span> <span class="string">tlist</span></span><br><span class="line"><span class="comment"># for循环匹配删除</span></span><br><span class="line"><span class="bullet">-</span> <span class="attr">hosts:</span> <span class="string">me</span></span><br><span class="line">  <span class="attr">gather_facts:</span> <span class="literal">no</span></span><br><span class="line">  <span class="attr">vars:</span></span><br><span class="line">    <span class="attr">tlist:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="number">11</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">&#x27;b&#x27;</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">&#x27;a&#x27;</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">&#x27;b&#x27;</span></span><br><span class="line">    <span class="bullet">-</span> <span class="number">11</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">&#x27;a11&#x27;</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">&#x27;1a&#x27;</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">&#x27;11&#x27;</span></span><br><span class="line">  <span class="attr">tasks:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">set_fact:</span></span><br><span class="line">      <span class="attr">tlist:</span> <span class="string">&quot;&#123;%for i in tlist%&#125;&#123;% if 11 in tlist%&#125;<span class="template-variable">&#123;&#123;tlist.remove(11)&#125;&#125;</span>&#123;%endif%&#125;&#123;%endfor%&#125;<span class="template-variable">&#123;&#123;tlist&#125;&#125;</span>&quot;</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">debug:</span></span><br><span class="line">      <span class="attr">var:</span> <span class="string">tlist</span></span><br></pre></td></tr></table></figure></li>
</ul>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="http://example.com/2022/03/01/hexo%E5%A4%9A%E8%AE%BE%E5%A4%87%E7%AE%A1%E7%90%86/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="John Doe">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Hexo">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2022/03/01/hexo%E5%A4%9A%E8%AE%BE%E5%A4%87%E7%AE%A1%E7%90%86/" class="post-title-link" itemprop="url">hexo多设备管理</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">Posted on</span>
      

      <time title="Created: 2022-03-01 22:13:11 / Modified: 22:20:49" itemprop="dateCreated datePublished" datetime="2022-03-01T22:13:11+08:00">2022-03-01</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">In</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/%E9%9A%8F%E7%AC%94/" itemprop="url" rel="index"><span itemprop="name">随笔</span></a>
        </span>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <p><code>github+hexo+next搭建个人博客</code>已经完成,使用一段时间后,发现存在多处编辑提交的需求.<br>在网上查询相关方案后,决定采取广大网友建议的方式: 将平时需要修改的内容存储在hexo分支,hexo基于更改内容生成的文件提交到master分支<br>下列内容记录在raspberry上配置实现hexo编辑提交内容的过程</p>
<h3 id="1-安装基础包"><a href="#1-安装基础包" class="headerlink" title="1.安装基础包"></a>1.安装基础包</h3><p>在新机器上安装基础包，当前机器为raspberry，以该机器为例说明<br>raspberry安装系统是”Raspbian GNU&#x2F;Linux 10 (buster)”，基于debian的发行，用如下命令安装</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 安装nodejs、npm、git</span></span><br><span class="line">sudo apt install nodejs npm git</span><br></pre></td></tr></table></figure>

<h3 id="2-配置git及github"><a href="#2-配置git及github" class="headerlink" title="2.配置git及github"></a>2.配置git及github</h3><p>安装好基础包后，要配置github上<strong>个人资料&#x2F;settings&#x2F;SSH and GPG keys&#x2F;SSH keys</strong>,用于提交代码使用</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 在raspberry上,使用pi用户生成公私钥对</span></span><br><span class="line">PI $ ssh-keygen -t rsa -P <span class="string">&#x27;&#x27;</span></span><br><span class="line">Generating public/private rsa key pair.</span><br><span class="line">Enter file <span class="keyword">in</span> <span class="built_in">which</span> to save the key (/home/pi/.ssh/id_rsa): Your identification has been saved <span class="keyword">in</span> /home/pi/.ssh/id_rsa.</span><br><span class="line">Your public key has been saved <span class="keyword">in</span> /home/pi/.ssh/id_rsa.pub.</span><br><span class="line">The key fingerprint is:</span><br><span class="line">SHA256:5C2iM9maPY/n+2iDwmodQJOjxTq2ZJkwv0xBy4EG68E pi@raspberrypi</span><br><span class="line">The keys randomart image is:</span><br><span class="line">+---[RSA 2048]----+</span><br><span class="line">|o+o.             |</span><br><span class="line">|=+Oo             |</span><br><span class="line">|+E=+    .        |</span><br><span class="line">|=*=    o .       |</span><br><span class="line">|+=.o  . S .      |</span><br><span class="line">| .o .+ . .       |</span><br><span class="line">|   o=...         |</span><br><span class="line">|  . +*o.+.       |</span><br><span class="line">| ...o.o*=+.      |</span><br><span class="line">+----[SHA256]-----+</span><br><span class="line"></span><br><span class="line"><span class="comment"># pi用户家目录下.ssh文件夹下新生成了id_rsa/id_rsa.pub文件</span></span><br><span class="line">PI $ <span class="built_in">ls</span> ~/.ssh -lrt</span><br><span class="line">total 16</span><br><span class="line">-rw-r--r-- 1 pi pi  444 Feb 27 21:28 known_hosts</span><br><span class="line">-rw------- 1 pi pi 1366 Feb 28 13:06 authorized_keys</span><br><span class="line">-rw-r--r-- 1 pi pi  396 Mar  1 21:30 id_rsa.pub</span><br><span class="line">-rw------- 1 pi pi 1823 Mar  1 21:30 id_rsa</span><br><span class="line"></span><br><span class="line"><span class="comment"># 复制id_rsa.pub内容,在github上SSH keys界面上点击New SSH key,添加复制的公钥内容并命名</span></span><br><span class="line">PI $ <span class="built_in">cat</span> ~/.ssh/id_rsa.pub </span><br><span class="line">ssh-rsa AAAAB3NzaCxxxx.....</span><br></pre></td></tr></table></figure>

<p>配置本地git</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 配置user.name和user.email</span></span><br><span class="line">PI $ git config --global user.email <span class="string">&quot;you@example.com&quot;</span></span><br><span class="line">PI $ git config --global user.name <span class="string">&quot;Your Name&quot;</span></span><br></pre></td></tr></table></figure>


<h3 id="3-npm安装hexo相关包"><a href="#3-npm安装hexo相关包" class="headerlink" title="3.npm安装hexo相关包"></a>3.npm安装hexo相关包</h3><p>配置好github <strong>SSH keys</strong>后,下载<strong>yourname.github.io</strong>库到本地</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 进入相应的目录,下载hexo分支代码; 此处在家目录下新建了projects目录,进入projects目录进行操作</span></span><br><span class="line">PI $ <span class="built_in">mkdir</span> ~/projects &amp;&amp; <span class="built_in">cd</span> ~/projects</span><br><span class="line"></span><br><span class="line"><span class="comment"># $yourname填写自己实际的名称</span></span><br><span class="line">PI $ git <span class="built_in">clone</span> git@github.com:<span class="variable">$yourname</span>/<span class="variable">$yourname</span>.github.io.git</span><br></pre></td></tr></table></figure>

<p>下载完成后,进入<strong>yourname.github.io</strong>目录,安装npm相关包</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 安装hexo</span></span><br><span class="line">PI $ <span class="built_in">cd</span> <span class="variable">$yourname</span>.github.io &amp;&amp; npm install hexo</span><br><span class="line"></span><br><span class="line"><span class="comment"># 当前目录下已经包含package.json文件,直接安装相关包</span></span><br><span class="line">PI $ npm install</span><br><span class="line"></span><br><span class="line"><span class="comment"># hexo同步至github需要使用的包</span></span><br><span class="line">PI $ npm install hexo-deployer-git</span><br><span class="line"></span><br><span class="line"><span class="comment"># 安装完成后,需要将当前目录下node_modules/.bin加入到PATH中</span></span><br><span class="line">PI $ <span class="built_in">echo</span> <span class="string">&#x27;export PATH=$PATH:/home/pi/projects/$yourname.github.io/node_modules/.bin&#x27;</span> &gt;&gt; ~/.bashrc </span><br><span class="line">PI $ <span class="built_in">source</span> ~/.bashrc</span><br></pre></td></tr></table></figure>

<h3 id="4-测试发布新文章"><a href="#4-测试发布新文章" class="headerlink" title="4.测试发布新文章"></a>4.测试发布新文章</h3><p>上述内容配置完成后,在新机器上测试新文章发布</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 新增文章</span></span><br><span class="line">PI $ hexo n <span class="built_in">test</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 编辑source/_post/test.md内容,可以在typora等markdown写作软件上先完成内容后再粘贴</span></span><br><span class="line">PI $ vim <span class="built_in">source</span>/_post/test.md</span><br><span class="line"></span><br><span class="line"><span class="comment"># 生成内容</span></span><br><span class="line">PI $ hexo g</span><br><span class="line"></span><br><span class="line"><span class="comment"># 测试新文章内容,hexo s后访问localhost:4000查看文章效果</span></span><br><span class="line">PI $ hexo s</span><br><span class="line"></span><br><span class="line"><span class="comment"># 内容核对完成,发布到github yourname.github.io的master分支上</span></span><br><span class="line">PI $ hexo d</span><br></pre></td></tr></table></figure>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="http://example.com/2022/02/28/hello-world/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="John Doe">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Hexo">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2022/02/28/hello-world/" class="post-title-link" itemprop="url">Hello World</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">Posted on</span>

      <time title="Created: 2022-02-28 21:53:07" itemprop="dateCreated datePublished" datetime="2022-02-28T21:53:07+08:00">2022-02-28</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar-check"></i>
      </span>
      <span class="post-meta-item-text">Edited on</span>
      <time title="Modified: 2022-02-27 11:00:14" itemprop="dateModified" datetime="2022-02-27T11:00:14+08:00">2022-02-27</time>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <p>Welcome to <a target="_blank" rel="noopener" href="https://hexo.io/">Hexo</a>! This is your very first post. Check <a target="_blank" rel="noopener" href="https://hexo.io/docs/">documentation</a> for more info. If you get any problems when using Hexo, you can find the answer in <a target="_blank" rel="noopener" href="https://hexo.io/docs/troubleshooting.html">troubleshooting</a> or you can ask me on <a target="_blank" rel="noopener" href="https://github.com/hexojs/hexo/issues">GitHub</a>.</p>
<h2 id="Quick-Start"><a href="#Quick-Start" class="headerlink" title="Quick Start"></a>Quick Start</h2><h3 id="Create-a-new-post"><a href="#Create-a-new-post" class="headerlink" title="Create a new post"></a>Create a new post</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ hexo new <span class="string">&quot;My New Post&quot;</span></span><br></pre></td></tr></table></figure>

<p>More info: <a target="_blank" rel="noopener" href="https://hexo.io/docs/writing.html">Writing</a></p>
<h3 id="Run-server"><a href="#Run-server" class="headerlink" title="Run server"></a>Run server</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ hexo server</span><br></pre></td></tr></table></figure>

<p>More info: <a target="_blank" rel="noopener" href="https://hexo.io/docs/server.html">Server</a></p>
<h3 id="Generate-static-files"><a href="#Generate-static-files" class="headerlink" title="Generate static files"></a>Generate static files</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ hexo generate</span><br></pre></td></tr></table></figure>

<p>More info: <a target="_blank" rel="noopener" href="https://hexo.io/docs/generating.html">Generating</a></p>
<h3 id="Deploy-to-remote-sites"><a href="#Deploy-to-remote-sites" class="headerlink" title="Deploy to remote sites"></a>Deploy to remote sites</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ hexo deploy</span><br></pre></td></tr></table></figure>

<p>More info: <a target="_blank" rel="noopener" href="https://hexo.io/docs/one-command-deployment.html">Deployment</a></p>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>





</div>
  </main>

  <footer class="footer">
    <div class="footer-inner">


<div class="copyright">
  &copy; 
  <span itemprop="copyrightYear">2022</span>
  <span class="with-love">
    <i class="fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">John Doe</span>
</div>
  <div class="powered-by">Powered by <a href="https://hexo.io/" rel="noopener" target="_blank">Hexo</a> & <a href="https://theme-next.js.org/muse/" rel="noopener" target="_blank">NexT.Muse</a>
  </div>

    </div>
  </footer>

  
  <script src="https://cdn.jsdelivr.net/npm/animejs@3.2.1/lib/anime.min.js" integrity="sha256-XL2inqUJaslATFnHdJOi9GfQ60on8Wx1C2H8DYiN1xY=" crossorigin="anonymous"></script>
<script src="/js/comments.js"></script><script src="/js/utils.js"></script><script src="/js/motion.js"></script><script src="/js/schemes/muse.js"></script><script src="/js/next-boot.js"></script>

  





  





</body>
</html>
